<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0A0E16">
  <meta name="view-transition" content="same-origin">
  <title>Sky Planner | Kontrollsystem</title>
  <link rel="icon" type="image/svg+xml" href="/skyplanner-logo.svg">
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <!-- CRITICAL: Set dark background and SPA view transition styles -->
  <style>
    html,body{background:#0A0E16!important;overflow:hidden;height:100%;width:100%;}

    /* === SHARED MAP (always visible, below app UI panels) === */
    #sharedMapContainer {
      position: fixed;
      inset: 0;
      z-index: 10; /* Below appView panels but markers/popups get elevated */
    }
    #sharedMapContainer #map {
      width: 100%;
      height: 100%;
      background: #1a1a1a; /* Fallback while tiles load */
    }
    /* === LOGIN OVERLAY === */
    #loginOverlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #loginOverlay.hidden {
      pointer-events: none;
    }
    #loginOverlay.hidden .login-side {
      transform: translateX(-100%);
      opacity: 0;
    }
    #loginOverlay.hidden .login-map-overlay {
      opacity: 0;
    }
    #loginOverlay.hidden .login-brand-content {
      opacity: 0;
      transform: translateY(-30px);
    }

    /* Gradient overlay on right side (over the map) */
    .login-map-overlay {
      position: absolute;
      inset: 0;
      left: 480px; /* After login form */
      background: linear-gradient(to right, rgba(15, 15, 15, 0.95) 0%, rgba(15, 15, 15, 0.6) 30%, rgba(15, 15, 15, 0.3) 100%);
      transition: opacity 0.8s cubic-bezier(0.22, 1, 0.36, 1);
      pointer-events: none;
    }

    /* === APP VIEW (UI elements only, map is separate) === */
    #appView {
      position: fixed;
      inset: 0;
      z-index: 100;
      pointer-events: none;
    }
    /* Container must also be pointer-events: none to let map clicks through */
    #appView > .container {
      pointer-events: none;
    }
    /* Only sidebar and its contents are clickable */
    #appView .sidebar {
      pointer-events: auto;
      position: relative;
      z-index: 300; /* Above map markers (200) */
    }
    /* Filter panel positioned fixed to right side of viewport */
    #appView .filter-panel {
      pointer-events: auto;
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 300; /* Above map markers (200) */
    }
    /* Modals in portal must be clickable (outside appView stacking context) */
    #modalPortal .modal {
      pointer-events: auto;
    }
    #modalPortal .modal.hidden {
      pointer-events: none;
    }
    /* User bar must be clickable */
    #appView .user-bar {
      pointer-events: auto;
    }
    /* Route info panel must be clickable */
    #appView .route-info {
      pointer-events: auto;
    }
    /* Mobile route FAB must be clickable */
    /* === CALENDAR SPLIT VIEW (overlays everything except modals) === */
    #calendarSplitOverlay {
      position: fixed;
      inset: 0;
      z-index: 400; /* Above sidebar (300), below modals */
      display: flex;
      pointer-events: none; /* Let map clicks through — only panel/divider are auto */
    }
    #calendarSplitOverlay.hidden {
      display: none !important;
    }

    #appView .mobile-route-fab {
      pointer-events: auto;
    }
    #appView.hidden .sidebar {
      transform: translateX(-100%);
      opacity: 0;
    }
    #appView.hidden .filter-panel {
      transform: translateX(100%);
      opacity: 0;
    }

    .login-brand-content {
      position: absolute;
      left: 480px;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2;
      text-align: center;
      padding: 40px;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      pointer-events: none;
    }

    .login-brand-logo {
      width: 180px;
      height: auto;
      margin-bottom: 40px;
      filter: drop-shadow(0 10px 40px rgba(94, 129, 172, 0.3));
    }

    .login-brand-title {
      font-size: 38px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #fff;
      text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
    }

    .login-brand-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.7;
      margin-bottom: 48px;
      text-shadow: 0 1px 10px rgba(0, 0, 0, 0.5);
    }

    .login-features {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 400px;
      width: 100%;
    }

    .login-feature {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
    }

    .login-feature-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #5E81AC 0%, #4A6D8C 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .login-feature-text {
      text-align: left;
    }

    .login-feature-text h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
      color: white;
    }

    .login-feature-text p {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    .login-contact {
      margin-top: 40px;
      text-align: center;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .login-contact-address {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
    }

    .login-contact-links {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-contact-links a {
      font-size: 13px;
      color: #5E81AC;
      text-decoration: none;
      transition: color 0.2s;
    }

    .login-contact-links a:hover {
      color: #7A9BBF;
    }

    .login-contact-divider {
      color: rgba(255, 255, 255, 0.3);
    }

    .login-developer {
      margin-top: 24px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
    }

    .login-developer a {
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      transition: color 0.2s;
    }

    .login-developer a:hover {
      color: #5E81AC;
    }

    .login-side {
      width: 480px;
      min-width: 480px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      border-right: 1px solid #333;
      transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease-out;
    }

    .login-content {
      width: 100%;
      max-width: 340px;
    }

    .login-certifications {
      display: flex;
      gap: 20px;
      margin-bottom: 32px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }

    .login-cert-logo {
      height: 60px;
      width: auto;
      object-fit: contain;
      opacity: 0.9;
    }

    .login-form-logo {
      display: block;
      height: 48px;
      width: auto;
      margin: 0 auto 32px auto;
    }

    .login-header {
      margin-bottom: 40px;
    }

    .login-header h1 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 10px;
      color: white;
    }

    .login-header p {
      color: #a0a0a0;
      font-size: 17px;
      margin: 0;
    }

    .login-form-group {
      margin-bottom: 24px;
    }

    .login-form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #a0a0a0;
      margin-bottom: 8px;
    }

    .login-input-field {
      width: 100%;
      padding: 14px 16px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 10px;
      color: white;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .login-input-field::placeholder {
      color: #666;
    }

    .login-input-field:focus {
      outline: none;
      border-color: #5E81AC;
      box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.15);
    }

    .login-options-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .login-checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .login-checkbox-wrapper input {
      width: 18px;
      height: 18px;
      accent-color: #5E81AC;
      cursor: pointer;
    }

    .login-checkbox-wrapper span {
      font-size: 14px;
      color: #a0a0a0;
    }

    .login-forgot-link {
      font-size: 14px;
      color: #5E81AC;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .login-forgot-link:hover {
      color: #7A9BBF;
    }

    .login-btn {
      width: 100%;
      padding: 16px;
      background: #5E81AC;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-btn:hover {
      background: #4A6D8C;
      transform: translateY(-1px);
    }

    .login-btn:disabled {
      background: #333;
      cursor: not-allowed;
      transform: none;
    }

    .login-btn svg {
      width: 18px;
      height: 18px;
    }

    .login-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: loginSpin 0.8s linear infinite;
    }

    @keyframes loginSpin {
      to { transform: rotate(360deg); }
    }

    .login-error-message {
      background: rgba(255, 59, 59, 0.1);
      border: 1px solid rgba(255, 59, 59, 0.3);
      color: #DC2626;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 24px;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 10px;
    }

    .login-error-message.show {
      display: flex;
    }

    .login-error-message svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .login-back-link {
      margin-top: 24px;
      text-align: center;
    }

    .login-back-link a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #a0a0a0;
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s ease;
    }

    .login-back-link a:hover {
      color: #5E81AC;
    }

    .login-back-link svg {
      flex-shrink: 0;
    }

    .login-footer {
      margin-top: auto;
      padding-top: 40px;
      text-align: center;
      color: #666;
      font-size: 13px;
    }

    /* === RESPONSIVE LOGIN === */
    @media (max-width: 1024px) {
      .login-brand-content {
        display: none;
      }
      .login-map-overlay {
        display: none;
      }
      .login-side {
        width: 100%;
        min-width: unset;
        border-right: none;
      }
    }

    @media (max-width: 480px) {
      .login-side {
        padding: 40px 24px;
      }
      .login-header h1 {
        font-size: 24px;
      }
    }

    /* === MOBILE APP VIEW OVERRIDES === */
    @media (max-width: 768px) {
      /* Filter panel becomes part of sidebar on mobile, not fixed */
      #appView .filter-panel {
        position: static !important;
        top: auto !important;
        right: auto !important;
        bottom: auto !important;
        z-index: auto !important;
        transform: none !important;
      }

      /* Sidebar becomes bottom sheet */
      #appView .sidebar {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        top: auto !important;
        z-index: 1500 !important;
      }

      /* Modals must be above sidebar on mobile */
      #appView .modal,
      .modal-overlay {
        z-index: 2000 !important;
      }

      /* Hide animations that conflict with mobile */
      .sidebar.pre-animate,
      .filter-panel.pre-animate {
        transform: none !important;
        opacity: 1 !important;
      }

      .sidebar.animate-in,
      .filter-panel.animate-in {
        animation: none !important;
      }
    }

    /* Mobile landscape mode - limit sidebar height */
    @media (max-width: 768px) and (orientation: landscape) {
      #appView .sidebar {
        max-height: 60vh !important;
      }
    }

    /* === APP VIEW TRANSITION ANIMATIONS === */
    .sidebar.animate-in {
      animation: slideInLeft 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .filter-panel.animate-in {
      animation: slideInRight 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .sidebar.pre-animate {
      transform: translateX(-100%);
      opacity: 0;
    }

    .filter-panel.pre-animate {
      transform: translateX(100%);
      opacity: 0;
    }

    @keyframes slideInLeft {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
  <!-- Google Fonts - Plus Jakarta Sans (matches apps/web) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Mapbox GL JS v3 -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous" />
  <link rel="stylesheet" href="polarnatt.css" />
  <link rel="stylesheet" href="style.css?v=20260216-splitview4" />
</head>
<body>
  <a href="#contentPanel" class="skip-to-content">Hopp til hovedinnhold</a>
  <!-- ========== IMPERSONATION BANNER (super-admin only) ========== -->
  <div id="impersonationBanner" class="impersonation-banner" style="display: none;">
    <div class="impersonation-content">
      <i class="fas fa-user-secret"></i>
      <span>Du ser appen som: <strong id="impersonatingOrgName"></strong></span>
    </div>
    <button class="impersonation-exit" id="stopImpersonationBtn">
      <i class="fas fa-arrow-left"></i>
      Tilbake til Admin
    </button>
  </div>

  <!-- ========== SINGLE MAP (used for both login and app) ========== -->
  <div id="sharedMapContainer">
    <div id="map"></div>
  </div>

  <!-- ========== LOGIN OVERLAY ========== -->
  <div id="loginOverlay">
    <!-- Login Form Side (left) -->
    <div class="login-side">
      <div class="login-content">
        <img src="/skyplanner-logo.svg" alt="Sky Planner" class="login-form-logo">
        <div class="login-header">
          <h2>Velkommen tilbake</h2>
          <p>Logg inn for å fortsette til kontrollpanelet</p>
        </div>

        <div class="login-error-message" id="loginErrorMessage">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span id="loginErrorText"></span>
        </div>

        <form id="spaLoginForm">
          <div class="login-form-group">
            <label for="loginEmail">E-postadresse</label>
            <input type="email" id="loginEmail" class="login-input-field" placeholder="navn@bedrift.no" required autocomplete="email">
          </div>

          <div class="login-form-group">
            <label for="loginPassword">Passord</label>
            <input type="password" id="loginPassword" class="login-input-field" placeholder="Skriv inn passord" required autocomplete="current-password">
          </div>

          <div class="login-options-row">
            <label class="login-checkbox-wrapper">
              <input type="checkbox" id="loginRememberMe" checked>
              <span>Husk meg</span>
            </label>
            <a href="/nytt-passord.html" class="login-forgot-link">Glemt passord?</a>
          </div>

          <button type="submit" class="login-btn" id="spaLoginBtn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
            </svg>
            <span>Logg inn</span>
          </button>
        </form>

        <div class="login-footer">
          <p id="loginFooterCopyright"></p>
        </div>
      </div>
    </div>

    <!-- Gradient overlay over map (right side) -->
    <div class="login-map-overlay"></div>

    <!-- Brand content (centered on right side, over map) - Dynamically populated -->
    <div class="login-brand-content">
      <img src="/skyplanner-logo.svg" alt="Sky Planner" class="login-brand-logo" id="loginLogo">
      <p class="login-brand-title" id="loginBrandTitle">Sky Planner</p>
      <p class="login-brand-subtitle" id="loginBrandSubtitle">Kontroll. Oversikt. Alltid.</p>

      <div class="login-features" id="loginFeatures">
        <!-- Fylles dynamisk av renderLoginFeatures() -->
      </div>

      <!-- Contact info - hidden by default, shown if configured -->
      <div class="login-contact" id="loginContact" style="display: none;">
        <p class="login-contact-address" id="loginAddress"></p>
        <div class="login-contact-links" id="loginContactLinks"></div>
      </div>
      <div class="login-developer">
        Utviklet av <a href="https://efffekt.no" target="_blank" rel="noopener">Efffekt AS</a>
      </div>
    </div>
  </div><!-- End loginOverlay -->

  <!-- ========== APP UI (overlays on top of shared map) ========== -->
  <div id="appView" class="hidden">
    <div class="container">
    <aside class="sidebar" id="sidebar">
      <!-- Header - Dynamically populated from config -->
      <div class="sidebar-header">
        <div class="header-content">
          <img src="/skyplanner-logo.svg" alt="Sky Planner" class="header-logo" id="headerLogo">
          <div class="header-text">
            <h1 id="headerAppName">Sky Planner</h1>
            <p class="company-name" id="headerCompanyName"></p>
            <p class="year" id="headerYear"></p>
          </div>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Vis/skjul sidebar" title="Krympe/utvide sidebar">
          <i class="fas fa-chevron-left" aria-hidden="true"></i>
        </button>
      </div>

      <!-- Subscription countdown timer - prominent placement for trial users -->
      <div class="subscription-timer-banner" id="subscriptionTimer" style="display: none;">
        <div class="subscription-timer-content">
          <i class="fas fa-clock"></i>
          <span id="subscriptionTimerText"></span>
        </div>
        <a href="/dashboard/abonnement" class="subscription-timer-cta">Oppgrader</a>
      </div>

      <!-- User info / Logout -->
      <div class="user-bar" id="userBar" style="display: none;">
        <span id="ws-connection-indicator" class="ws-indicator ws-disconnected" title="Kobler til..."></span>
        <span class="user-name" id="userNameDisplay"></span>
        <div class="user-bar-actions">
          <button class="theme-toggle-btn" id="themeToggleBtn" aria-label="Bytt tema" title="Bytt tema">
            <i class="fas fa-sun theme-icon-light" aria-hidden="true"></i>
            <i class="fas fa-moon theme-icon-dark" aria-hidden="true"></i>
          </button>
          <button class="logout-btn" id="logoutBtnMain" aria-label="Logg ut" title="Logg ut">
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Vertical Tab Navigation -->
      <nav class="tab-navigation" role="tablist" aria-label="Hovednavigasjon">
        <button class="tab-item active" data-tab="dashboard" id="tab-btn-dashboard" role="tab" aria-selected="true" aria-controls="tab-dashboard">
          <i class="fas fa-th-large" aria-hidden="true"></i>
          <span>Dashboard</span>
        </button>
        <button class="tab-item" data-tab="customers" id="tab-btn-customers" role="tab" aria-selected="false" aria-controls="tab-customers">
          <i class="fas fa-users" aria-hidden="true"></i>
          <span>Kunder</span>
        </button>
        <button class="tab-item" data-tab="overdue" id="tab-btn-overdue" role="tab" aria-selected="false" aria-controls="tab-overdue">
          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
          <span>Forfalte</span>
          <span class="tab-badge" id="overdueBadge" style="display: none;">0</span>
        </button>
        <button class="tab-item" data-tab="warnings" id="tab-btn-warnings" role="tab" aria-selected="false" aria-controls="tab-warnings">
          <i class="fas fa-bell" aria-hidden="true"></i>
          <span>Kommende kontroller</span>
          <span class="tab-badge" id="upcomingBadge" style="display: none;">0</span>
        </button>
        <button class="tab-item" data-tab="todays-work" id="todaysWorkTab" role="tab" aria-selected="false" aria-controls="tab-todays-work" style="display: none;">
          <i class="fas fa-briefcase" aria-hidden="true"></i>
          <span>Dagens arbeid</span>
          <span class="tab-badge" id="todaysWorkBadge" style="display: none;">0/0</span>
        </button>
        <button class="tab-item" data-tab="calendar" id="tab-btn-calendar" role="tab" aria-selected="false" aria-controls="tab-calendar">
          <i class="fas fa-calendar" aria-hidden="true"></i>
          <span>Kalender</span>
        </button>
        <button class="tab-item" data-tab="weekly-plan" id="tab-btn-weekly-plan" role="tab" aria-selected="false" aria-controls="tab-weekly-plan">
          <i class="fas fa-clipboard-list" aria-hidden="true"></i>
          <span>Ukeplan</span>
        </button>
        <button class="tab-item" data-tab="planner" id="tab-btn-planner" role="tab" aria-selected="false" aria-controls="tab-planner">
          <i class="fas fa-route" aria-hidden="true"></i>
          <span>Ruteplanlegger</span>
        </button>
        <button class="tab-item" data-tab="statistikk" id="tab-btn-statistikk" role="tab" aria-selected="false" aria-controls="tab-statistikk">
          <i class="fas fa-chart-line" aria-hidden="true"></i>
          <span>Statistikk</span>
        </button>
        <button class="tab-item" data-tab="missingdata" id="tab-btn-missingdata" role="tab" aria-selected="false" aria-controls="tab-missingdata">
          <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
          <span>Mangler data</span>
          <span class="tab-badge missing-badge" id="missingDataBadge" style="display: none;">0</span>
        </button>
        <button class="tab-item" data-tab="chat" id="chatTab" role="tab" aria-selected="false" aria-controls="tab-chat">
          <i class="fas fa-comments" aria-hidden="true"></i>
          <span>Meldinger</span>
          <span class="tab-badge chat-badge" id="chatUnreadBadge" style="display: none;">0</span>
        </button>
        <button class="tab-item admin-only" data-tab="admin" id="adminTab" role="tab" aria-selected="false" aria-controls="tab-admin" style="display: none;">
          <i class="fas fa-shield-alt" aria-hidden="true"></i>
          <span>Admin</span>
        </button>
      </nav>

      <!-- Quick Stats i bunnen av sidebar -->
      <div class="sidebar-quick-stats" id="sidebarQuickStats">
        <div class="quick-stat-item">
          <span class="quick-stat-value" id="quickStatKunder">0</span>
          <span class="quick-stat-label">Kunder</span>
        </div>
        <div class="quick-stat-item quick-stat-warning">
          <span class="quick-stat-value" id="quickStatForfalte">0</span>
          <span class="quick-stat-label">Forfalte</span>
        </div>
        <div class="quick-stat-item quick-stat-upcoming">
          <span class="quick-stat-value" id="quickStatKommende">0</span>
          <span class="quick-stat-label">Kommende</span>
        </div>
        <div class="quick-stat-item quick-stat-ok">
          <span class="quick-stat-value" id="quickStatOk">0</span>
          <span class="quick-stat-label">OK</span>
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="patch-notes-link" id="patchNotesLink" title="Nyheter og oppdateringer">
          <i class="fas fa-bullhorn"></i>
          <span>Nyheter</span>
          <span class="patch-notes-badge" id="patchNotesBadge" style="display: none;"></span>
        </button>
        <a href="https://efffekt.no" target="_blank" rel="noopener">Efffekt AS</a>
      </div>
    </aside>

    <!-- Content Panel Overlay (for mobile) -->
    <div class="content-panel-overlay" id="contentPanelOverlay"></div>

    <!-- Content Panel - vises til høyre for menyen -->
    <div class="content-panel" id="contentPanel" style="display: flex; flex-direction: column; height: 100vh;">
      <div class="content-panel-header">
        <span class="panel-title" id="panelTitle">Dashboard</span>
        <button class="content-panel-close" id="contentPanelClose" aria-label="Lukk panel" title="Lukk panel">
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      </div>
      <!-- Tab Content Container -->
      <div class="tab-content" style="flex: 1; overflow-y: auto; min-height: 0;">
        <!-- Tab: Dashboard -->
        <div class="tab-pane active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-btn-dashboard">
          <div class="dashboard-container">
            <!-- Quick Stats Row -->
            <div class="dashboard-stats">
              <div class="stat-card stat-total">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                  <span class="stat-value" id="dashTotalKunder">0</span>
                  <span class="stat-label">Totalt kunder</span>
                </div>
              </div>
              <div class="stat-card stat-overdue">
                <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
                <div class="stat-content">
                  <span class="stat-value" id="dashForfalte">0</span>
                  <span class="stat-label">Forfalte</span>
                </div>
              </div>
              <div class="stat-card stat-upcoming">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-content">
                  <span class="stat-value" id="dashKommende">0</span>
                  <span class="stat-label">Innen 30 dager</span>
                </div>
              </div>
              <div class="stat-card stat-completed">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-content">
                  <span class="stat-value" id="dashFullfort">0</span>
                  <span class="stat-label">OK (90+ dager)</span>
                </div>
              </div>
            </div>

            <!-- Action Cards Row -->
            <div class="dashboard-actions">
              <div class="action-card" data-action="showOverdueTab" role="button" tabindex="0">
                <div class="action-icon overdue"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></div>
                <div class="action-content">
                  <h3>Forfalte kontroller</h3>
                  <p><span id="dashOverdueCount">0</span> kunder trenger kontroll</p>
                </div>
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
              </div>
              <div class="action-card" data-action="showRoutesTab" role="button" tabindex="0">
                <div class="action-icon route"><i class="fas fa-route" aria-hidden="true"></i></div>
                <div class="action-content">
                  <h3>Planlegg rute</h3>
                  <p>Optimaliser dagens servicetur</p>
                </div>
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
              </div>
              <div class="action-card" data-action="showCalendarTab" role="button" tabindex="0">
                <div class="action-icon calendar"><i class="fas fa-calendar-check" aria-hidden="true"></i></div>
                <div class="action-content">
                  <h3>Kalender</h3>
                  <p>Se avtaler og planlegg fremover</p>
                </div>
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
              </div>
            </div>

            <!-- Category Overview -->
            <div class="dashboard-categories">
              <h3><i class="fas fa-pie-chart" aria-hidden="true"></i> Kategori-fordeling</h3>
              <div class="category-overview" id="dashCategoryOverview">
                <!-- Filled dynamically -->
              </div>
            </div>

            <!-- Area Quick Links -->
            <div class="dashboard-areas">
              <h3><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Områder</h3>
              <div class="area-list" id="dashAreaList">
                <!-- Filled dynamically -->
              </div>
            </div>

          </div>
        </div>

        <!-- Tab: Customers -->
        <div class="tab-pane" id="tab-customers" role="tabpanel" aria-labelledby="tab-btn-customers">
          <div class="tab-header">
            <h2>Kunder</h2>
            <div class="tab-header-actions">
              <div class="export-dropdown-wrapper">
                <button id="exportCustomersBtn" class="btn btn-secondary btn-small">
                  <i class="fas fa-download"></i> Eksporter
                </button>
                <div id="exportDropdown" class="export-dropdown hidden">
                  <button class="export-option" data-format="xlsx">
                    <i class="fas fa-file-excel"></i> Excel (.xlsx)
                  </button>
                  <button class="export-option" data-format="csv">
                    <i class="fas fa-file-csv"></i> CSV
                  </button>
                  <button class="export-option" data-format="json">
                    <i class="fas fa-file-code"></i> JSON
                  </button>
                  <button class="export-option" data-format="vcf">
                    <i class="fas fa-address-card"></i> Kontakter (.vcf)
                  </button>
                </div>
              </div>
              <button id="importCustomersBtn" class="btn btn-secondary btn-small">
                <i class="fas fa-file-import"></i> Importer
              </button>
              <button id="addCustomerBtnTab" class="btn btn-primary btn-small">
                <i class="fas fa-plus"></i> Ny kunde
              </button>
            </div>
          </div>

          <div class="customer-admin">
            <!-- Search -->
            <div class="customer-search">
              <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="customerSearchInput" placeholder="Søk etter kunde..." aria-label="Søk etter kunde">
              </div>
            </div>

            <!-- Kategori tabs - populated dynamically by ServiceTypeRegistry -->
            <div class="kategori-tabs" id="kategoriTabs">
              <!-- Fallback content, will be replaced by renderKategoriTabs() -->
              <button class="kategori-tab active" data-kategori="alle">Alle</button>
            </div>

            <!-- Customer stats with toggle -->
            <div class="customer-stats">
              <span id="customerCountDisplay">0 kunder</span>
              <button id="toggleCustomerList" class="toggle-list-btn" title="Vis/skjul liste">
                <i class="fas fa-chevron-up"></i>
              </button>
            </div>

            <!-- Customer list -->
            <div id="customerAdminList" class="customer-admin-list">
              <!-- Kunder lastes her -->
            </div>
          </div>
        </div>

        <!-- Tab: Overdue -->
        <div class="tab-pane" id="tab-overdue" role="tabpanel" aria-labelledby="tab-btn-overdue">
          <div class="tab-header">
            <h2>Forfalte kontroller</h2>
            <span class="overdue-count-header" id="overdueCountHeader"></span>
          </div>
          <div class="overdue-filters">
            <div class="filter-group">
              <label for="overdueSortSelect">Sorter etter:</label>
              <select id="overdueSortSelect">
                <option value="proximity">Nærhet (ta flere samtidig)</option>
                <option value="days">Ferskeste først (minst dager)</option>
                <option value="days-desc">Eldste først (flest dager)</option>
                <option value="name">Navn A-Å</option>
                <option value="category">Kategori</option>
                <option value="area">Område (poststed)</option>
              </select>
            </div>
            <div class="overdue-actions">
              <button id="showOverdueOnMapBtn" class="btn btn-secondary btn-small">
                <i class="fas fa-map-marker-alt"></i> Vis på kart
              </button>
              <button id="createOverdueRouteBtn" class="btn btn-primary btn-small">
                <i class="fas fa-route"></i> Lag rute
              </button>
            </div>
          </div>
          <div class="proximity-settings" id="overdueProximitySettings">
            <div class="proximity-settings-row">
              <label for="overdueProximityRadius"><i class="fas fa-sliders-h"></i> Grupperingsradius:</label>
              <input type="range" id="overdueProximityRadius" min="3" max="50" step="1" value="15">
              <span class="proximity-radius-value" id="overdueProximityRadiusValue">15 km</span>
            </div>
          </div>
          <div class="overdue-container" id="overdueContainer">
            <!-- Forfalte kunder lastes her -->
          </div>
        </div>

        <!-- Tab: Warnings -->
        <div class="tab-pane" id="tab-warnings" role="tabpanel" aria-labelledby="tab-btn-warnings">
          <div class="tab-header">
            <h2>Kommende kontroller</h2>
          </div>

          <div class="warning-actions">
            <div class="filter-group">
              <label for="warningSortSelect">Sorter etter:</label>
              <select id="warningSortSelect">
                <option value="proximity">Nærhet (ta flere samtidig)</option>
                <option value="category">Kategori</option>
              </select>
            </div>
            <button id="selectWarningsBtn" class="btn btn-secondary btn-small">
              <i class="fas fa-check"></i>
              Velg alle
            </button>
          </div>
          <div class="proximity-settings" id="warningProximitySettings">
            <div class="proximity-settings-row">
              <label for="warningProximityRadius"><i class="fas fa-sliders-h"></i> Grupperingsradius:</label>
              <input type="range" id="warningProximityRadius" min="3" max="50" step="1" value="15">
              <span class="proximity-radius-value" id="warningProximityRadiusValue">15 km</span>
            </div>
          </div>

          <div id="warningsContainer" class="warnings-container">
            <!-- Varsler lastes her -->
          </div>
        </div>

        <!-- Tab: Today's Work -->
        <div class="tab-pane" id="tab-todays-work" role="tabpanel" aria-labelledby="todaysWorkTab">
          <div class="tab-header">
            <h2>Dagens arbeid</h2>
            <div class="todays-work-date-nav">
              <button class="btn btn-icon btn-small" id="twPrevDay" title="Forrige dag">
                <i class="fas fa-chevron-left"></i>
              </button>
              <span id="twDateLabel">I dag</span>
              <button class="btn btn-icon btn-small" id="twNextDay" title="Neste dag">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>

          <!-- Route summary card -->
          <div class="tw-route-card" id="twRouteCard" style="display: none;">
            <div class="tw-route-header">
              <h3 id="twRouteName"></h3>
              <span class="tw-route-status" id="twRouteStatus"></span>
            </div>
            <div class="tw-route-stats">
              <div class="tw-stat">
                <i class="fas fa-map-marker-alt"></i>
                <span><span id="twCompleted">0</span>/<span id="twTotal">0</span> besøkt</span>
              </div>
              <div class="tw-stat" id="twDistanceStat" style="display: none;">
                <i class="fas fa-route"></i>
                <span id="twDistance"></span>
              </div>
            </div>
            <div class="tw-progress-bar">
              <div class="tw-progress-fill" id="twProgressFill"></div>
            </div>
            <button class="btn btn-primary btn-block" id="twStartRouteBtn">
              <i class="fas fa-play"></i> Start rute
            </button>
          </div>

          <!-- Customer stops list -->
          <div class="tw-stops-list" id="twStopsList"></div>

          <!-- Empty state -->
          <div class="tw-empty" id="twEmpty" style="display: none;">
            <i class="fas fa-calendar-check"></i>
            <h3>Ingen rute tildelt</h3>
            <p>Du har ingen rute tildelt for denne datoen.</p>
          </div>
        </div>

        <!-- Tab: Calendar -->
        <div class="tab-pane" id="tab-calendar" role="tabpanel" aria-labelledby="tab-btn-calendar">
          <div class="tab-header">
            <h2>Kalender</h2>
          </div>

          <div id="calendarContainer" class="calendar-container">
            <!-- Kalender lastes her -->
          </div>
        </div>

        <!-- Tab: Weekly Plan / Ukeplan -->
        <div class="tab-pane" id="tab-weekly-plan" role="tabpanel" aria-labelledby="tab-btn-weekly-plan">
          <div id="weeklyPlanContainer"></div>
        </div>

        <!-- Tab: Planner / Ruteplanlegger -->
        <div class="tab-pane" id="tab-planner" role="tabpanel" aria-labelledby="tab-btn-planner">
          <div class="tab-header">
            <h2><i class="fas fa-route"></i> Ruteplanlegger</h2>
            <p class="tab-description">Finn effektive ruteklynger basert på geografisk nærhet og kontrollbehov</p>
          </div>

          <div id="plannerContainer" class="planner-container">
            <!-- Innstillinger panel -->
            <div class="planner-settings-panel">
              <h3><i class="fas fa-sliders-h"></i> Innstillinger</h3>

              <div class="setting-row">
                <label for="smartDaysAhead">Dager fremover</label>
                <input type="range" id="smartDaysAhead" min="7" max="180" value="60">
                <span class="setting-value" id="smartDaysAheadValue">60 dager</span>
              </div>

              <div class="setting-row">
                <label for="smartMaxCustomers">Maks kunder</label>
                <input type="range" id="smartMaxCustomers" min="3" max="30" value="15">
                <span class="setting-value" id="smartMaxCustomersValue">15 kunder</span>
              </div>

              <div class="setting-row">
                <label for="smartClusterRadius">Klyngeradius</label>
                <input type="range" id="smartClusterRadius" min="1" max="20" value="5">
                <span class="setting-value" id="smartClusterRadiusValue">5 km</span>
              </div>

              <button class="btn btn-primary" id="refreshSmartRecommendationsBtn">
                <i class="fas fa-sync-alt"></i> Oppdater anbefalinger
              </button>
            </div>

            <!-- Anbefalinger grid -->
            <div class="planner-recommendations">
              <h3><i class="fas fa-lightbulb"></i> Anbefalte ruteklynger</h3>
              <div id="smartRecommendations" class="recommendations-grid">
                <!-- Fylles dynamisk av SmartRouteEngine -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Statistikk -->
        <div class="tab-pane" id="tab-statistikk" role="tabpanel" aria-labelledby="tab-btn-statistikk">
          <div class="tab-header">
            <h2>Statistikk & Trender</h2>
          </div>

          <div class="statistikk-container">
            <!-- Overview Cards -->
            <div class="stats-overview" id="statsOverview">
              <div class="overview-card">
                <div class="overview-icon"><i class="fas fa-users"></i></div>
                <div class="overview-content">
                  <span class="overview-value" id="statTotalKunder">0</span>
                  <span class="overview-label">Totalt kunder</span>
                </div>
              </div>
              <div class="overview-card status-overdue">
                <div class="overview-icon"><i class="fas fa-exclamation-circle"></i></div>
                <div class="overview-content">
                  <span class="overview-value" id="statForfalte">0</span>
                  <span class="overview-label">Forfalte</span>
                </div>
              </div>
              <div class="overview-card status-soon">
                <div class="overview-icon"><i class="fas fa-clock"></i></div>
                <div class="overview-content">
                  <span class="overview-value" id="statSnart">0</span>
                  <span class="overview-label">Innen 30 dager</span>
                </div>
              </div>
              <div class="overview-card status-good">
                <div class="overview-icon"><i class="fas fa-check-circle"></i></div>
                <div class="overview-content">
                  <span class="overview-value" id="statOk">0</span>
                  <span class="overview-label">I orden</span>
                </div>
              </div>
            </div>

            <!-- Sesonganalyse -->
            <div class="stats-section">
              <h3><i class="fas fa-calendar-alt"></i> Sesonganalyse - Kontroller per måned</h3>
              <p class="stats-description">Viser når kontroller forfaller gjennom året</p>
              <div class="season-chart" id="seasonChart">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- Kategori-fordeling -->
            <div class="stats-section">
              <h3><i class="fas fa-pie-chart"></i> Kategori-fordeling</h3>
              <div class="category-stats" id="categoryStats">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- Område-fordeling -->
            <div class="stats-section">
              <h3><i class="fas fa-map-marker-alt"></i> Kunder per område</h3>
              <div class="area-stats" id="areaStats">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- El-type fordeling -->
            <div class="stats-section">
              <h3><i class="fas fa-bolt"></i> El-kontroll typer</h3>
              <div class="eltype-stats" id="eltypeStats">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- Brann-system fordeling -->
            <div class="stats-section">
              <h3><i class="fas fa-fire"></i> Brannvarsling-systemer</h3>
              <div class="brannsystem-stats" id="brannsystemStats">
                <!-- Genereres av JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Missing Data -->
        <div class="tab-pane" id="tab-missingdata" role="tabpanel" aria-labelledby="tab-btn-missingdata">
          <div class="tab-header">
            <h2>Mangler data</h2>
          </div>

          <div class="missing-data-container">
            <p class="missing-data-intro">Kunder som mangler viktig informasjon:</p>

            <!-- Mangler telefon -->
            <div class="missing-section">
              <div class="missing-header" data-toggle="missing-phone">
                <i class="fas fa-phone-slash"></i>
                <span>Mangler telefon</span>
                <span class="missing-count" id="missingPhoneCount">0</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
              </div>
              <div class="missing-list collapsed" id="missingPhoneList">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- Mangler e-post -->
            <div class="missing-section">
              <div class="missing-header" data-toggle="missing-email">
                <i class="fas fa-envelope-open"></i>
                <span>Mangler e-post</span>
                <span class="missing-count" id="missingEmailCount">0</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
              </div>
              <div class="missing-list collapsed" id="missingEmailList">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- Mangler koordinater -->
            <div class="missing-section">
              <div class="missing-header" data-toggle="missing-coords">
                <i class="fas fa-map-marker-alt"></i>
                <span>Mangler koordinater</span>
                <span class="missing-count" id="missingCoordsCount">0</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
              </div>
              <div class="missing-list collapsed" id="missingCoordsList">
                <!-- Genereres av JavaScript -->
              </div>
            </div>

            <!-- Mangler neste kontroll -->
            <div class="missing-section">
              <div class="missing-header" data-toggle="missing-control">
                <i class="fas fa-calendar-times"></i>
                <span>Mangler neste kontroll</span>
                <span class="missing-count" id="missingControlCount">0</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
              </div>
              <div class="missing-list collapsed" id="missingControlList">
                <!-- Genereres av JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Admin (kun synlig for admin) -->
        <div class="tab-pane" id="tab-admin" role="tabpanel" aria-labelledby="adminTab">
          <div class="tab-header">
            <h2><i class="fas fa-shield-alt"></i> Admin</h2>
          </div>

          <!-- Team Members Section -->
          <div class="admin-section" id="teamMembersSection">
            <div class="section-header-with-actions">
              <h3><i class="fas fa-users"></i> Teammedlemmer</h3>
              <div class="section-actions">
                <span class="quota-badge" id="teamQuotaBadge">0 / 5</span>
                <button class="btn btn-primary btn-small" id="addTeamMemberBtn">
                  <i class="fas fa-user-plus"></i> Legg til
                </button>
              </div>
            </div>
            <div class="team-members-container" id="teamMembersContainer">
              <div class="team-members-list" id="teamMembersList">
                <!-- Fylles med JavaScript -->
              </div>
              <div class="team-members-empty" id="teamMembersEmpty" style="display: none;">
                <i class="fas fa-user-slash"></i>
                <p>Ingen teammedlemmer ennå</p>
                <button class="btn btn-primary" id="addFirstMemberBtn">
                  <i class="fas fa-user-plus"></i> Legg til første medlem
                </button>
              </div>
            </div>
          </div>

          <!-- Login Stats -->
          <div class="admin-stats" id="loginStats">
            <div class="admin-stat-card">
              <div class="stat-icon"><i class="fas fa-sign-in-alt"></i></div>
              <div class="stat-content">
                <span class="stat-value" id="statTotalLogins">0</span>
                <span class="stat-label">Totalt innlogginger</span>
              </div>
            </div>
            <div class="admin-stat-card success">
              <div class="stat-icon"><i class="fas fa-check"></i></div>
              <div class="stat-content">
                <span class="stat-value" id="statSuccessLogins">0</span>
                <span class="stat-label">Vellykkede</span>
              </div>
            </div>
            <div class="admin-stat-card danger">
              <div class="stat-icon"><i class="fas fa-times"></i></div>
              <div class="stat-content">
                <span class="stat-value" id="statFailedLogins">0</span>
                <span class="stat-label">Mislykkede</span>
              </div>
            </div>
            <div class="admin-stat-card info">
              <div class="stat-icon"><i class="fas fa-clock"></i></div>
              <div class="stat-content">
                <span class="stat-value" id="statLast24h">0</span>
                <span class="stat-label">Siste 24 timer</span>
              </div>
            </div>
          </div>

          <!-- Login Log Table -->
          <div class="admin-section">
            <h3><i class="fas fa-history"></i> Innloggingslogg</h3>
            <div class="login-log-container" id="loginLogContainer">
              <table class="login-log-table">
                <thead>
                  <tr>
                    <th scope="col">Tidspunkt</th>
                    <th scope="col">Bruker</th>
                    <th scope="col">E-post</th>
                    <th scope="col">Status</th>
                    <th scope="col">IP</th>
                    <th scope="col">Enhet</th>
                  </tr>
                </thead>
                <tbody id="loginLogBody">
                  <!-- Fylles med JavaScript -->
                </tbody>
              </table>
            </div>
            <button id="loadMoreLogins" class="btn btn-secondary btn-small" style="margin-top: 10px;">
              <i class="fas fa-plus"></i> Last flere
            </button>
          </div>

          <!-- Organization Fields Management -->
          <div class="admin-section" id="fieldsManagementSection">
            <div class="section-header-with-actions">
              <h3><i class="fas fa-th-list"></i> Egendefinerte felt</h3>
              <div class="section-actions">
                <button class="btn btn-primary btn-small" id="addFieldBtn">
                  <i class="fas fa-plus"></i> Nytt felt
                </button>
              </div>
            </div>
            <p class="admin-section-description">Administrer egendefinerte felt som vises i kunderegistrering.</p>
            <div class="fields-list sortable-list" id="fieldsList">
              <!-- Populated dynamically -->
            </div>
            <div class="fields-empty" id="fieldsEmpty" style="display: none;">
              <i class="fas fa-th-list"></i>
              <p>Ingen egendefinerte felt</p>
              <button class="btn btn-primary" id="addFirstFieldBtn">
                <i class="fas fa-plus"></i> Opprett første felt
              </button>
            </div>
          </div>

          <!-- Organization Categories Management -->
          <div class="admin-section" id="categoriesManagementSection">
            <div class="section-header-with-actions">
              <h3><i class="fas fa-tags"></i> Tjenestekategorier</h3>
              <div class="section-actions">
                <button class="btn btn-primary btn-small" id="addCategoryBtn">
                  <i class="fas fa-plus"></i> Ny kategori
                </button>
              </div>
            </div>
            <p class="admin-section-description">Administrer kategorier for kundetjenester.</p>
            <div class="categories-list sortable-list" id="categoriesList">
              <!-- Populated dynamically -->
            </div>
            <div class="categories-empty" id="categoriesEmpty" style="display: none;">
              <i class="fas fa-tags"></i>
              <p>Ingen kategorier</p>
              <button class="btn btn-primary" id="addFirstCategoryBtn">
                <i class="fas fa-plus"></i> Opprett første kategori
              </button>
            </div>
          </div>

          <!-- Subcategories Management -->
          <div class="admin-section" id="subcategoriesManagementSection">
            <div class="section-header-with-actions">
              <h3><i class="fas fa-layer-group"></i> Underkategorier</h3>
            </div>
            <p class="admin-section-description">Opprett grupper og underkategorier for filtrering og organisering.</p>
            <div id="subcategoriesAdminContent">
              <!-- Fylles dynamisk av renderAdminSubcategories() -->
            </div>
            <div id="subcategoriesAdminEmpty" style="display: none;">
              <i class="fas fa-layer-group"></i>
              <p>Ingen underkategori-grupper enna. Opprett en gruppe for a komme i gang.</p>
            </div>
          </div>

          <!-- Super Admin Section (kun synlig for super-admins) -->
          <div class="admin-section super-admin-section" id="superAdminSection" style="display: none;">
            <div class="super-admin-banner">
              <i class="fas fa-crown"></i>
              <span>Super Admin - Tilgang til alle organisasjoner</span>
            </div>

            <!-- Global Statistics -->
            <div class="admin-subsection">
              <h3><i class="fas fa-chart-bar"></i> Global statistikk</h3>
              <div class="admin-stats" id="globalStats">
                <div class="admin-stat-card">
                  <div class="stat-icon"><i class="fas fa-building"></i></div>
                  <div class="stat-content">
                    <span class="stat-value" id="statTotalOrgs">0</span>
                    <span class="stat-label">Organisasjoner</span>
                  </div>
                </div>
                <div class="admin-stat-card">
                  <div class="stat-icon"><i class="fas fa-users"></i></div>
                  <div class="stat-content">
                    <span class="stat-value" id="statGlobalKunder">0</span>
                    <span class="stat-label">Kunder totalt</span>
                  </div>
                </div>
                <div class="admin-stat-card">
                  <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                  <div class="stat-content">
                    <span class="stat-value" id="statGlobalBrukere">0</span>
                    <span class="stat-label">Brukere totalt</span>
                  </div>
                </div>
                <div class="admin-stat-card success">
                  <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                  <div class="stat-content">
                    <span class="stat-value" id="statActiveOrgs">0</span>
                    <span class="stat-label">Aktive org.</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Organization List -->
            <div class="admin-subsection">
              <h3><i class="fas fa-building"></i> Alle organisasjoner</h3>
              <div class="org-search-container">
                <input type="text" id="orgSearchInput" placeholder="Søk organisasjoner..." class="search-input" aria-label="Søk organisasjoner">
              </div>
              <div class="org-list-container" id="orgListContainer">
                <table class="org-table">
                  <thead>
                    <tr>
                      <th scope="col">Navn</th>
                      <th scope="col">Plan</th>
                      <th scope="col">Status</th>
                      <th scope="col">Kunder</th>
                      <th scope="col">Brukere</th>
                      <th scope="col">Opprettet</th>
                      <th scope="col"><span class="visually-hidden">Handlinger</span></th>
                    </tr>
                  </thead>
                  <tbody id="orgListBody">
                    <!-- Fylles med JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Selected Organization Details -->
            <div class="admin-subsection" id="selectedOrgSection" style="display: none;">
              <div class="section-header-with-actions">
                <h3><i class="fas fa-building"></i> <span id="selectedOrgName">-</span></h3>
                <div class="section-actions">
                  <button class="btn btn-secondary btn-small" id="closeOrgDetailsBtn">
                    <i class="fas fa-times"></i> Lukk
                  </button>
                </div>
              </div>

              <!-- Organization Info -->
              <div class="org-info-grid" id="selectedOrgInfo">
                <div class="org-info-item">
                  <label>Slug:</label>
                  <span id="orgInfoSlug">-</span>
                </div>
                <div class="org-info-item">
                  <label>Plan:</label>
                  <span id="orgInfoPlan">-</span>
                </div>
                <div class="org-info-item">
                  <label>Abonnement:</label>
                  <span id="orgInfoSubscription">-</span>
                </div>
                <div class="org-info-item">
                  <label>Bransjemal:</label>
                  <span id="orgInfoIndustry">-</span>
                </div>
              </div>

              <!-- Organization Tabs -->
              <div class="org-detail-tabs">
                <button class="org-tab-btn active" data-tab="customers">
                  <i class="fas fa-users"></i> Kunder (<span id="orgCustomerCount">0</span>)
                </button>
                <button class="org-tab-btn" data-tab="users">
                  <i class="fas fa-user-tie"></i> Brukere (<span id="orgUserCount">0</span>)
                </button>
              </div>

              <!-- Customers Tab -->
              <div class="org-tab-content" id="orgCustomersTab">
                <div class="org-tab-actions">
                  <button class="btn btn-primary btn-small" id="addOrgCustomerBtn">
                    <i class="fas fa-plus"></i> Ny kunde
                  </button>
                </div>
                <div class="org-customers-list" id="orgCustomersList">
                  <table class="org-table">
                    <thead>
                      <tr>
                        <th scope="col">Navn</th>
                        <th scope="col">Adresse</th>
                        <th scope="col">Telefon</th>
                        <th scope="col">E-post</th>
                        <th scope="col"><span class="visually-hidden">Handlinger</span></th>
                      </tr>
                    </thead>
                    <tbody id="orgCustomersBody">
                      <!-- Fylles med JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Users Tab -->
              <div class="org-tab-content" id="orgUsersTab" style="display: none;">
                <div class="org-users-list" id="orgUsersList">
                  <table class="org-table">
                    <thead>
                      <tr>
                        <th scope="col">Navn</th>
                        <th scope="col">E-post</th>
                        <th scope="col">Sist innlogget</th>
                        <th scope="col">Opprettet</th>
                      </tr>
                    </thead>
                    <tbody id="orgUsersBody">
                      <!-- Fylles med JavaScript -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Chat / Meldinger -->
        <div class="tab-pane" id="tab-chat" role="tabpanel" aria-labelledby="chatTab">
          <div class="chat-container">
            <!-- Chat conversation list view -->
            <div class="chat-conversation-list" id="chatConversationList">
              <div class="tab-header chat-header">
                <h2><i class="fas fa-comments"></i> Meldinger</h2>
                <button class="btn btn-icon btn-small" id="chatNewDmBtn" title="Ny melding">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div class="chat-conversations" id="chatConversations">
                <!-- Fylles med JavaScript -->
              </div>
            </div>

            <!-- Chat message view (hidden by default) -->
            <div class="chat-message-view" id="chatMessageView" style="display: none;">
              <div class="chat-message-header">
                <button class="btn btn-icon btn-small" id="chatBackBtn">
                  <i class="fas fa-arrow-left"></i>
                </button>
                <span class="chat-message-title" id="chatMessageTitle">Teamchat</span>
              </div>
              <div class="chat-messages" id="chatMessages">
                <!-- Fylles med JavaScript -->
              </div>
              <div class="chat-typing-indicator" id="chatTypingIndicator" style="display: none;">
                <span id="chatTypingText"></span>
              </div>
              <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Skriv en melding..." maxlength="2000" autocomplete="off" aria-label="Skriv en melding">
                <button class="btn btn-primary btn-icon" id="chatSendBtn" title="Send">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>

            <!-- New DM view (hidden by default) -->
            <div class="chat-new-dm" id="chatNewDm" style="display: none;">
              <div class="chat-message-header">
                <button class="btn btn-icon btn-small" id="chatNewDmBackBtn">
                  <i class="fas fa-arrow-left"></i>
                </button>
                <span class="chat-message-title">Ny melding</span>
              </div>
              <div class="chat-team-list" id="chatTeamList">
                <!-- Fylles med JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Resize Handle -->
      <div class="content-panel-resize" id="contentPanelResize" title="Dra for å endre bredde"></div>
    </div>

    <main class="map-container">
      <!-- Map is now in #sharedMapContainer above, always visible -->

      <!-- Filter Panel (Right Side) - Collapsible -->
      <div id="filterPanel" class="filter-panel">
        <!-- Collapse Toggle Tab -->
        <button class="filter-panel-toggle" id="filterPanelToggle" title="Vis/skjul panel">
          <i class="fas fa-chevron-left"></i>
        </button>

        <div class="filter-panel-inner">
          <div class="filter-panel-header">
            <h3><i class="fas fa-filter"></i> Kunder</h3>
            <span class="customer-count" id="totalCustomerCount">0</span>
          </div>

          <div class="filter-panel-content">
            <!-- Search Field -->
            <div class="search-container">
              <i class="fas fa-search search-icon"></i>
              <input type="text" id="searchInput" placeholder="Søk..." class="search-input" aria-label="Søk på kartet">
            </div>
            <div id="filterResultCount" class="filter-result-count" style="display:none;"></div>

            <!-- Quick Actions -->
            <div class="quick-actions">
              <button id="addCustomerBtn" class="btn-icon" title="Ny kunde">
                <i class="fas fa-plus"></i>
              </button>
              <button id="planRouteBtn" class="btn-icon" title="Planlegg rute" disabled>
                <i class="fas fa-route"></i>
              </button>
              <button id="clearSelectionBtn" class="btn-icon" title="Tøm valg" disabled>
                <i class="fas fa-times"></i>
              </button>
            </div>

            <!-- Selection Info -->
            <div class="selected-info">
              <span id="selectedCount">0</span> valgt
            </div>

            <!-- Category Filter (Dynamic) -->
            <div class="category-filter">
              <div class="category-filter-title">
                Kategori
                <button class="category-manage-btn" id="manageCategoriesBtn" title="Administrer kategorier" onclick="openCategoryListModal()">
                  <i class="fas fa-cog"></i>
                </button>
              </div>
              <div class="category-filter-buttons" id="categoryFilterButtons">
                <!-- Populated dynamically by renderFilterPanelCategories() -->
              </div>
            </div>

            <!-- Dynamic Organization Field Filters -->
            <div id="dynamicFieldFilters">
              <!-- Populated dynamically by renderDynamicFieldFilters() -->
            </div>

            <!-- Subcategory Filter + Management -->
            <div class="category-filter" id="subcategoryFilter" style="display: none;">
              <div class="category-filter-title">
                <span>Underkategorier</span>
                <button class="subcat-admin-toggle" id="subcatAdminToggle" title="Administrer"><i class="fas fa-cog"></i></button>
              </div>
              <div id="subcategoryFilterContent">
                <!-- Populated dynamically by renderSubcategoryFilter() -->
              </div>
            </div>

            <!-- Color Legend -->
            <div class="color-legend">
              <div class="legend-title">Fargekoder</div>
              <div class="legend-items">
                <div class="legend-item">
                  <span class="legend-dot overdue"></span>
                  <span class="legend-text">Forfalt</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot soon"></span>
                  <span class="legend-text">Snart (0-30 dager)</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot ok"></span>
                  <span class="legend-text">OK (31-90 dager)</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot good"></span>
                  <span class="legend-text">God (90+ dager)</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot unknown"></span>
                  <span class="legend-text">Ikke registrert</span>
                </div>
              </div>
            </div>

            <!-- Customer List -->
            <div class="customer-list-wrapper">
              <div class="customer-list" id="customerList">
                <!-- Kunder lastes her -->
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Mobile floating action button for route planning -->
      <div id="mobileRouteBtn" class="mobile-route-fab hidden">
        <button id="mobileRouteFabBtn" class="fab-button">
          <i class="fas fa-route"></i>
          <span id="mobileRouteCount">0</span>
        </button>
      </div>
    </main>
  </div>


  <!-- Map Legend -->
  <div class="map-legend" id="mapLegend">
    <button class="legend-toggle" id="legendToggle" title="Vis/skjul forklaring">
      <i class="fas fa-info-circle"></i>
    </button>
    <div class="legend-content">
      <h4>Kategorier</h4>
      <div class="legend-items" id="legendItems">
        <!-- Fylles dynamisk -->
      </div>
      <div class="legend-status">
        <h5>Kontrollstatus</h5>
        <div class="legend-item"><span class="legend-color status-forfalt"></span> Forfalt</div>
        <div class="legend-item"><span class="legend-color status-snart"></span> Snart (30 dager)</div>
        <div class="legend-item"><span class="legend-color status-ok"></span> OK (31-90 dager)</div>
        <div class="legend-item"><span class="legend-color status-god"></span> God (90+ dager)</div>
      </div>
    </div>
  </div>

  </div><!-- End of appView -->

  <!-- ========== MODAL PORTAL (outside appView stacking context for correct z-index) ========== -->
  <div id="modalPortal">
  <!-- Modal for ny/rediger kunde -->
  <div id="customerModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Ny kunde</h2>
        <button class="modal-close" id="closeCustomerModal" aria-label="Lukk">&times;</button>
      </div>
      <form id="customerForm">
        <input type="hidden" id="customerId">

        <div class="form-group">
          <label for="navn">Navn *</label>
          <input type="text" id="navn" required>
        </div>

        <div class="form-group">
          <label for="adresse">Adresse *</label>
          <div class="address-autocomplete-wrapper">
            <input type="text" id="adresse" required autocomplete="off" placeholder="Begynn å skrive adresse...">
          </div>
          <button type="button" id="geocodeBtn" class="btn btn-small">Finn koordinater</button>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="postnummer">Postnummer</label>
            <div class="postnummer-wrapper">
              <input type="text" id="postnummer" maxlength="4" placeholder="0000" autocomplete="off">
              <span class="postnummer-status" id="postnummerStatus"></span>
            </div>
          </div>
          <div class="form-group">
            <label for="poststed">Poststed</label>
            <input type="text" id="poststed" placeholder="Fylles automatisk">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="org_nummer">Org.nr.</label>
            <input type="text" id="org_nummer" maxlength="9" pattern="\d{9}" placeholder="9 siffer" inputmode="numeric">
          </div>
          <div class="form-group">
            <label for="estimert_tid">Estimert tid (min)</label>
            <input type="number" id="estimert_tid" min="0" max="480" step="15" placeholder="60" inputmode="numeric">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="telefon">Telefon</label>
            <input type="tel" id="telefon">
          </div>
          <div class="form-group">
            <label for="epost">E-post</label>
            <input type="email" id="epost">
          </div>
        </div>

        <div class="form-group">
          <label>Kategori</label>
          <div id="kategoriCheckboxes" class="kategori-checkbox-group">
            <!-- Populeres dynamisk av ServiceTypeRegistry -->
          </div>
        </div>

        <!-- Underkategorier (rett etter kategori-valg) -->
        <div id="subcategorySection">
          <div class="control-section-header">
            <i class="fas fa-layer-group"></i> Underkategorier
          </div>
          <div id="subcategoryDropdowns">
            <!-- Fylles dynamisk: én dropdown per underkategori-gruppe -->
          </div>
        </div>

        <!-- Dynamic Service Sections Container -->
        <!-- Populated by ServiceTypeRegistry.renderServiceSections() -->
        <div id="dynamicServiceSections">
          <!-- Will be populated dynamically when ServiceTypeRegistry is loaded -->
        </div>

        <!-- Legacy El-Kontroll felt (for backward compatibility during migration) -->
        <div class="control-section legacy-section" id="elKontrollSection" style="display: none;">
          <div class="control-section-header">
            <i class="fas fa-bolt"></i> El-Kontroll
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="siste_el_kontroll">Siste kontroll</label>
              <input type="date" id="siste_el_kontroll">
            </div>
            <div class="form-group">
              <label for="neste_el_kontroll">Neste kontroll</label>
              <input type="date" id="neste_el_kontroll">
            </div>
            <div class="form-group">
              <label for="el_kontroll_intervall">Intervall</label>
              <select id="el_kontroll_intervall">
                <!-- Populeres dynamisk av ServiceTypeRegistry -->
              </select>
            </div>
          </div>
        </div>

        <!-- Legacy Brannvarsling felt (for backward compatibility during migration) -->
        <div class="control-section legacy-section" id="brannvarslingSection" style="display: none;">
          <div class="control-section-header">
            <i class="fas fa-fire"></i> Brannvarsling
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="siste_brann_kontroll">Siste kontroll</label>
              <input type="date" id="siste_brann_kontroll">
            </div>
            <div class="form-group">
              <label for="neste_brann_kontroll">Neste kontroll</label>
              <input type="date" id="neste_brann_kontroll">
            </div>
            <div class="form-group">
              <label for="brann_kontroll_intervall">Intervall</label>
              <select id="brann_kontroll_intervall">
                <!-- Populeres dynamisk av ServiceTypeRegistry -->
              </select>
            </div>
          </div>
        </div>

        <!-- MVP Oppfølging Section (synlig kun i MVP-modus, skjult by default) -->
        <div class="control-section" id="mvpKontrollSection" style="display: none;">
          <div class="control-section-header">
            <i class="fas fa-calendar-check"></i> Oppfølging
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="siste_kontroll">Siste kontakt</label>
              <input type="date" id="siste_kontroll">
            </div>
            <div class="form-group">
              <label for="neste_kontroll">Neste oppfølging</label>
              <input type="date" id="neste_kontroll">
            </div>
            <div class="form-group">
              <label for="kontroll_intervall">Intervall</label>
              <select id="kontroll_intervall">
                <option value="-7">1 uke</option>
                <option value="-14">2 uker</option>
                <option value="1">1 mnd</option>
                <option value="3">3 mnd</option>
                <option value="6">6 mnd</option>
                <option value="12" selected>1 år</option>
                <option value="24">2 år</option>
                <option value="36">3 år</option>
                <option value="60">5 år</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="notater">Notater</label>
          <textarea id="notater" rows="3"></textarea>
        </div>

        <!-- Dynamic Organization Fields (populated from organization_fields table) -->
        <div id="customFieldsSection" class="custom-fields-section hidden">
          <div class="custom-fields-header">
            <i class="fas fa-sliders-h"></i> Egendefinerte felt
          </div>
          <div id="customFieldsContainer">
            <!-- Populated dynamically by loadOrganizationFields() -->
          </div>
        </div>

        <!-- Email Settings -->
        <div class="form-group email-settings">
          <label for="emailAktiv">E-postvarsling</label>
          <div class="email-toggle">
            <input type="checkbox" id="emailAktiv" checked>
            <label for="emailAktiv">Aktiver e-postvarsler for denne kunden</label>
          </div>
          <div class="email-options" id="emailOptions">
            <div class="form-row">
              <div class="form-group">
                <label for="forsteVarsel">Første varsel (dager før)</label>
                <input type="number" id="forsteVarsel" value="30" min="1" max="90">
              </div>
              <div class="form-group">
                <label for="paaminnelseEtter">Påminnelse (dager etter første)</label>
                <input type="number" id="paaminnelseEtter" value="7" min="1" max="30">
              </div>
            </div>
          </div>
        </div>

        <div class="form-group coordinates-section">
          <div class="coord-header">
            <span class="label-text">Koordinater</span>
            <span class="geocode-quality-badge" id="geocodeQualityBadge"></span>
          </div>
          <div class="coord-inputs">
            <div class="coord-field">
              <label for="lat">Breddegrad</label>
              <input type="number" id="lat" step="0.000001" placeholder="69.123456">
            </div>
            <div class="coord-field">
              <label for="lng">Lengdegrad</label>
              <input type="number" id="lng" step="0.000001" placeholder="17.654321">
            </div>
          </div>
          <div class="coord-actions">
            <button type="button" id="pickFromMapBtn" class="btn btn-small btn-secondary">
              <i class="fas fa-map-marker-alt"></i> Velg på kart
            </button>
          </div>
          <div class="geocode-warning" id="geocodeWarning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Koordinatene er usikre. Vurder manuell justering.</span>
          </div>
        </div>


        <!-- Kontaktlogg -->
        <div class="kontaktlogg-section" id="kontaktloggSection" style="display: none;">
          <div class="control-section-header">
            <i class="fas fa-phone"></i> Kontaktlogg
          </div>
          <div class="kontaktlogg-add">
            <select id="kontaktType">
              <option value="Telefonsamtale">Telefonsamtale</option>
              <option value="SMS">SMS</option>
              <option value="E-post">E-post</option>
              <option value="Besøk">Besøk</option>
              <option value="Annet">Annet</option>
            </select>
            <input type="text" id="kontaktNotat" placeholder="Notat om kontakten..." aria-label="Notat om kontakten">
            <button type="button" id="addKontaktBtn" class="btn btn-small btn-primary">
              <i class="fas fa-plus"></i> Legg til
            </button>
          </div>
          <div class="kontaktlogg-list" id="kontaktloggList">
            <!-- Fylles med JavaScript -->
          </div>
        </div>

        <!-- Kontaktpersoner -->
        <div class="kontaktpersoner-section" id="kontaktpersonerSection" style="display: none;">
          <div class="control-section-header">
            <i class="fas fa-users"></i> Kontaktpersoner
          </div>
          <div class="kontaktpersoner-list" id="kontaktpersonerList">
            <!-- Fylles med JavaScript -->
          </div>
          <div class="kontaktpersoner-add">
            <input type="text" id="kontaktpersonNavn" placeholder="Navn *" aria-label="Kontaktperson navn">
            <select id="kontaktpersonRolle">
              <option value="">Rolle...</option>
              <option value="teknisk">Teknisk</option>
              <option value="faktura">Faktura</option>
              <option value="daglig">Daglig leder</option>
              <option value="annet">Annet</option>
            </select>
            <input type="tel" id="kontaktpersonTelefon" placeholder="Telefon" aria-label="Kontaktperson telefon">
            <input type="email" id="kontaktpersonEpost" placeholder="E-post" aria-label="Kontaktperson e-post">
            <div class="kontaktperson-add-actions">
              <label class="kontaktperson-primaer-label">
                <input type="checkbox" id="kontaktpersonPrimaer">
                <span>Primærkontakt</span>
              </label>
              <button type="button" id="addKontaktpersonBtn" class="btn btn-small btn-primary">
                <i class="fas fa-plus"></i> Legg til
              </button>
            </div>
          </div>
        </div>

        <!-- Integrasjonshandlinger -->
        <div id="integrationActionsSection" class="form-section hidden" style="border-top: 1px solid var(--border); padding-top: 12px; margin-top: 8px;">
          <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block;">
            <i class="fas fa-plug"></i> Integrasjoner
          </label>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button type="button" id="pushToTripletexBtn" class="btn btn-secondary btn-small hidden">
              <i class="fas fa-cloud-upload-alt"></i> <span id="tripletexBtnLabel">Opprett i Tripletex</span>
            </button>
            <button type="button" id="createEkkReportBtn" class="btn btn-secondary btn-small hidden">
              <i class="fas fa-file-medical-alt"></i> Opprett EKK-rapport
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" id="deleteCustomerBtn" class="btn btn-danger hidden">Slett</button>
          <button type="button" id="cancelBtn" class="btn btn-secondary">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- OpenRouteService API-nøkkel modal -->
  <div id="apiKeyModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="apiKeyModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="apiKeyModalTitle">OpenRouteService API-nøkkel</h2>
        <button class="modal-close" id="closeApiKeyModal" aria-label="Lukk">&times;</button>
      </div>
      <p>For ruteplanlegging trenger du en gratis API-nøkkel fra OpenRouteService.</p>
      <ol>
        <li>Gå til <a href="https://openrouteservice.org/dev/#/signup" target="_blank">openrouteservice.org</a></li>
        <li>Registrer deg (gratis)</li>
        <li>Kopier API-nøkkelen din</li>
      </ol>
      <div class="form-group">
        <label for="apiKey">API-nøkkel</label>
        <input type="text" id="apiKey" placeholder="Din API-nøkkel">
      </div>
      <div class="form-actions">
        <button id="saveApiKey" class="btn btn-primary">Lagre</button>
      </div>
    </div>
  </div>

  <!-- Avtale modal -->
  <div id="avtaleModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="avtaleModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="avtaleModalTitle">Ny avtale</h2>
        <button class="modal-close" id="closeAvtaleModal" aria-label="Lukk">&times;</button>
      </div>
      <form id="avtaleForm">
        <input type="hidden" id="avtaleId">
        <div class="form-group">
          <label for="avtaleKundeSearch">Kunde *</label>
          <div class="kunde-search-wrapper">
            <input type="text" id="avtaleKundeSearch" placeholder="Søk etter kunde..." autocomplete="off" aria-label="Søk etter kunde for avtale">
            <input type="hidden" id="avtaleKunde" required>
            <div class="kunde-search-results" id="avtaleKundeResults"></div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="avtaleDato">Dato *</label>
            <input type="date" id="avtaleDato" required>
          </div>
          <div class="form-group">
            <label for="avtaleKlokkeslett">Klokkeslett</label>
            <input type="time" id="avtaleKlokkeslett">
          </div>
        </div>
        <div class="form-group">
          <label for="avtaleType">Type</label>
          <select id="avtaleType">
            <!-- Populated dynamically by ServiceTypeRegistry -->
          </select>
        </div>
        <div class="form-group">
          <label for="avtaleBeskrivelse">Beskrivelse / notater</label>
          <textarea id="avtaleBeskrivelse" rows="2" placeholder="Valgfri beskrivelse..."></textarea>
        </div>
        <div class="form-group" id="avtaleGjentakelseGroup">
          <label for="avtaleGjentakelse">Gjentakelse</label>
          <select id="avtaleGjentakelse">
            <option value="">Ingen gjentakelse</option>
            <option value="daglig">Daglig</option>
            <option value="ukentlig">Ukentlig</option>
            <option value="annenhver_uke">Annenhver uke</option>
            <option value="manedlig">Månedlig</option>
            <option value="3_maneder">Hver 3. måned</option>
            <option value="6_maneder">Hver 6. måned</option>
            <option value="arlig">Årlig</option>
          </select>
        </div>
        <div class="form-group hidden" id="avtaleGjentakelseSluttGroup">
          <label for="avtaleGjentakelseSlutt">Gjentakelse slutter</label>
          <input type="date" id="avtaleGjentakelseSlutt">
          <small class="form-hint">Standard: 1 år fra startdato</small>
        </div>
        <div class="form-actions">
          <button type="button" id="deleteAvtaleBtn" class="btn btn-danger" style="display: none;">Slett</button>
          <button type="button" id="deleteAvtaleSeriesBtn" class="btn btn-danger" style="display: none;">Slett serie</button>
          <button type="button" id="cancelAvtale" class="btn btn-secondary">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre avtale</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Team Member Modal -->
  <div id="teamMemberModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="teamMemberModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="teamMemberModalTitle">Nytt teammedlem</h2>
        <button class="modal-close" id="closeTeamMemberModal" aria-label="Lukk">&times;</button>
      </div>
      <form id="teamMemberForm">
        <input type="hidden" id="teamMemberId">
        <div class="form-group">
          <label for="memberNavn">Navn *</label>
          <input type="text" id="memberNavn" required placeholder="Fullt navn">
        </div>
        <div class="form-group">
          <label for="memberEpost">E-post *</label>
          <input type="email" id="memberEpost" required placeholder="bruker@eksempel.no">
        </div>
        <div class="form-group" id="passwordGroup">
          <label for="memberPassord">Passord *</label>
          <input type="password" id="memberPassord" placeholder="Minst 8 tegn" minlength="8">
          <small class="form-hint">Minst 8 tegn. La stå tom for å beholde eksisterende passord ved redigering.</small>
        </div>
        <div class="form-group">
          <label for="memberTelefon">Telefon</label>
          <input type="tel" id="memberTelefon" placeholder="Valgfritt">
        </div>
        <div class="form-group">
          <label for="memberRolle">Rolle</label>
          <select id="memberRolle">
            <option value="medlem">Medlem</option>
            <option value="admin">Administrator</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" id="deleteTeamMemberBtn" class="btn btn-danger" style="display: none;">Slett</button>
          <button type="button" id="cancelTeamMember" class="btn btn-secondary">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Field Modal -->
  <div id="fieldModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="fieldModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="fieldModalTitle">Nytt felt</h2>
        <button class="modal-close" id="closeFieldModal" aria-label="Lukk">&times;</button>
      </div>
      <form id="fieldForm">
        <input type="hidden" id="fieldId">
        <div class="form-group">
          <label for="fieldDisplayName">Visningsnavn *</label>
          <input type="text" id="fieldDisplayName" required placeholder="F.eks. Antall enheter">
        </div>
        <div class="form-group">
          <label for="fieldName">Feltnavn (system) *</label>
          <input type="text" id="fieldName" required placeholder="antall_enheter" pattern="[a-z0-9_]+" title="Kun små bokstaver, tall og underscore">
          <small class="form-hint">Brukes internt. Kun små bokstaver og underscore.</small>
        </div>
        <div class="form-group">
          <label for="fieldType">Felttype</label>
          <select id="fieldType">
            <option value="text">Tekst</option>
            <option value="select">Rullegardin (velg fra liste)</option>
            <option value="number">Tall</option>
            <option value="date">Dato</option>
          </select>
        </div>

        <!-- Options section for select type -->
        <div class="form-group" id="fieldOptionsSection" style="display: none;">
          <label>Alternativer</label>
          <div id="fieldOptionsList" class="options-list">
            <!-- Populated dynamically -->
          </div>
          <button type="button" id="addFieldOptionBtn" class="btn btn-secondary btn-small">
            <i class="fas fa-plus"></i> Legg til alternativ
          </button>
        </div>

        <div class="form-row toggle-row">
          <div class="toggle-group">
            <label class="toggle">
              <input type="checkbox" id="fieldFilterable">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Vis som filter</span>
          </div>
          <div class="toggle-group">
            <label class="toggle">
              <input type="checkbox" id="fieldRequired">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Obligatorisk</span>
          </div>
          <div class="toggle-group">
            <label class="toggle">
              <input type="checkbox" id="fieldVisible" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Synlig</span>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" id="deleteFieldBtn" class="btn btn-danger" style="display: none;">Slett</button>
          <button type="button" id="cancelField" class="btn btn-secondary">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category List Modal -->
  <div id="categoryListModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="categoryListModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="categoryListModalTitle"><i class="fas fa-tags" aria-hidden="true"></i> Kategorier</h2>
        <button class="modal-close" aria-label="Lukk" onclick="document.getElementById('categoryListModal').classList.add('hidden')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="categoryListItems">
          <!-- Populated dynamically -->
        </div>
        <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="document.getElementById('categoryListModal').classList.add('hidden'); openCategoryModal();">
          <i class="fas fa-plus"></i> Ny kategori
        </button>
      </div>
    </div>
  </div>

  <!-- Category Modal -->
  <div id="categoryModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="categoryModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="categoryModalTitle">Ny kategori</h2>
        <button class="modal-close" id="closeCategoryModal" aria-label="Lukk" onclick="document.getElementById('categoryModal').classList.add('hidden')">&times;</button>
      </div>
      <form id="categoryForm" onsubmit="saveCategory(event)">
        <input type="hidden" id="categoryId">
        <input type="hidden" id="categorySlug">
        <input type="hidden" id="categoryIcon" value="fa-wrench">
        <div class="form-group">
          <label for="categoryName">Navn *</label>
          <input type="text" id="categoryName" required placeholder="F.eks. El-Kontroll, VVS, Ventilasjon..." maxlength="100">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="categoryColor">Farge</label>
            <div class="color-picker-row">
              <div class="color-preview" id="categoryColorPreview" style="background: #5E81AC;"></div>
              <input type="color" id="categoryColor" value="#5E81AC" oninput="updateCategoryColorPreview(this.value)">
            </div>
          </div>
          <div class="form-group">
            <label for="categoryInterval">Intervall</label>
            <select id="categoryInterval">
              <option value="6">6 måneder</option>
              <option value="12" selected>1 år (12 mnd)</option>
              <option value="24">2 år</option>
              <option value="36">3 år</option>
              <option value="48">4 år</option>
              <option value="60">5 år</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Ikon</label>
          <div class="icon-picker-grid" id="categoryIconPicker">
            <!-- Populated dynamically by renderCategoryIconPicker() -->
          </div>
        </div>
        <div class="form-group">
          <label for="categoryDescription">Beskrivelse (valgfritt)</label>
          <input type="text" id="categoryDescription" placeholder="Kort beskrivelse av tjenesten...">
        </div>
        <div class="form-group" id="categorySourceGroup" style="display: none;">
          <label>Kilde</label>
          <span class="source-badge" id="categorySourceBadge"></span>
        </div>
        <div class="form-actions">
          <button type="button" id="deleteCategoryBtn" class="btn btn-danger" style="display: none;" onclick="const id = document.getElementById('categoryId').value; if(id) confirmDeleteCategory(parseInt(id));">Slett</button>
          <button type="button" id="cancelCategory" class="btn btn-secondary" onclick="document.getElementById('categoryModal').classList.add('hidden')">Avbryt</button>
          <button type="submit" class="btn btn-primary">Lagre</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="importModalTitle">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="importModalTitle"><i class="fas fa-file-import" aria-hidden="true"></i> Importer kunder</h2>
        <button class="modal-close" id="closeImportModal" aria-label="Lukk">&times;</button>
      </div>
      <div class="modal-body" id="importModalContent">
        <!-- Import wizard content rendered here -->
      </div>
    </div>
  </div>
  </div>


  <!-- ========== SPLIT VIEW: Calendar + Map side-by-side ========== -->
  <div id="calendarSplitOverlay" class="calendar-split-overlay hidden">
    <div class="calendar-split-panel" id="calendarSplitPanel">
      <div class="calendar-split-header">
        <h3 id="calendarSplitTitle">Uke</h3>
        <div class="calendar-split-nav">
          <button class="btn btn-small btn-secondary" id="splitPrevWeek"><i class="fas fa-chevron-left"></i></button>
          <button class="btn btn-small btn-secondary" id="splitNextWeek"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div style="margin-left:auto;display:flex;gap:4px;">
          <button class="btn btn-small btn-primary" id="addAvtaleSplit"><i class="fas fa-plus"></i> Ny avtale</button>
          <button class="btn btn-small btn-secondary" id="closeSplitView" title="Lukk delt visning"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="calendar-split-content" id="calendarSplitContent">
        <!-- Populated by JS -->
      </div>
    </div>
    <div class="calendar-split-divider" id="calendarSplitDivider">
      <div class="split-divider-handle"></div>
    </div>
    <div class="calendar-split-map" id="calendarSplitMap">
      <!-- Map visible through this transparent area -->
    </div>
  </div>

  <!-- Mapbox GL JS v3 + Supercluster -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.4/mapbox-gl.js"></script>
  <script src="https://unpkg.com/supercluster@8.0.1/dist/supercluster.min.js"></script>
  <script src="offline-storage.js?v=1"></script>
  <script src="sync-manager.js?v=1"></script>
  <script src="app.js?v=20260222-autocomplete-v2"></script>
  <script>
    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>

  <!-- Address autocomplete portal (outside modal to avoid backdrop-filter containing block) -->
  <div class="address-suggestions" id="addressSuggestions"></div>
</body>
</html>
<!-- redeploy Sat Dec 27 17:54:50 CET 2025 -->
