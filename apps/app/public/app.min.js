let map,markers={},markerClusterGroup=null,selectedCustomers=new Set,customers=[],routeLayer=null,routeMarkers=[],savedRoutes=[],avtaler=[],omrader=[],currentFilter="alle",showOnlyWarnings=!1,selectedCategory="all",selectedDriftskategori=localStorage.getItem("selectedDriftskategori")||"all",currentCalendarMonth=(new Date).getMonth(),currentCalendarYear=(new Date).getFullYear(),bulkSelectedCustomers=new Set,bulkSelectMode=!1,filterAbortController=null,organizationFields=[],organizationCategories=[],dynamicFieldFilters={},teamMembersData=[],currentView="login",appInitialized=!1,currentTheme=localStorage.getItem("theme")||"dark",appConfig={},authToken=localStorage.getItem("authToken");const tabCleanupFunctions={calendar:null,overdue:null,warnings:null,planner:null,customers:null,statistikk:null,missingdata:null,admin:null};function runTabCleanup(e){e&&tabCleanupFunctions[e]&&(tabCleanupFunctions[e](),tabCleanupFunctions[e]=null)}const Logger={isDev:()=>"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.search.includes("debug=true"),log:function(...e){this.isDev()&&console.log("[DEBUG]",...e)},warn:function(...e){this.isDev()&&console.warn("[WARN]",...e)},error:console.error.bind(console,"[ERROR]")},ModalSystem={container:null,init(){this.container||(this.container=document.createElement("div"),this.container.id="modal-system-container",this.container.innerHTML='\n      <div class="modal-system-overlay" style="\n        display: none;\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 100000;\n        justify-content: center;\n        align-items: center;\n        padding: 20px;\n      ">\n        <div class="modal-system-dialog" style="\n          background: var(--color-bg-secondary, #1a1a1a);\n          border-radius: 16px;\n          max-width: 480px;\n          width: 100%;\n          padding: 32px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n          border: 1px solid var(--color-border, #333);\n        ">\n          <div class="modal-system-icon" style="\n            text-align: center;\n            margin-bottom: 20px;\n            font-size: 48px;\n          "></div>\n          <h2 class="modal-system-title" style="\n            font-size: 22px;\n            font-weight: 600;\n            color: var(--color-text-primary, #fff);\n            margin: 0 0 16px 0;\n            text-align: center;\n            line-height: 1.4;\n          "></h2>\n          <p class="modal-system-message" style="\n            font-size: 18px;\n            color: var(--color-text-secondary, #a0a0a0);\n            margin: 0 0 28px 0;\n            text-align: center;\n            line-height: 1.6;\n          "></p>\n          <div class="modal-system-buttons" style="\n            display: flex;\n            gap: 12px;\n            justify-content: center;\n            flex-wrap: wrap;\n          "></div>\n        </div>\n      </div>\n    ',document.body.appendChild(this.container))},show(e){this.init();const t=this.container.querySelector(".modal-system-overlay"),n=this.container.querySelector(".modal-system-icon"),a=this.container.querySelector(".modal-system-title"),s=this.container.querySelector(".modal-system-message"),o=this.container.querySelector(".modal-system-buttons"),r={success:'<span style="color: #4CAF50;">&#10004;</span>',error:'<span style="color: #DC2626;">&#10006;</span>',warning:'<span style="color: #FFC107;">&#9888;</span>',info:'<span style="color: #42A5F5;">&#8505;</span>',confirm:'<span style="color: #F97316;">&#63;</span>'};n.innerHTML=r[e.type]||r.info,a.textContent=e.title||"",a.style.display=e.title?"block":"none",s.textContent=e.message||"",o.innerHTML="";e.buttons&&e.buttons.forEach((e,t)=>{const n=document.createElement("button");n.textContent=e.text,n.style.cssText="\n      min-height: 52px;\n      padding: 14px 28px;\n      font-size: 18px;\n      font-weight: 600;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      transition: all 0.2s;\n      min-width: 120px;\n    ",e.primary?(n.style.background="var(--color-accent, #F97316)",n.style.color="#fff"):(n.style.background="var(--color-bg-tertiary, #252525)",n.style.color="var(--color-text-primary, #fff)",n.style.border="1px solid var(--color-border, #333)"),n.onclick=()=>{this.hide(),e.onClick&&e.onClick()},0===t&&setTimeout(()=>n.focus(),100),o.appendChild(n)}),t.style.display="flex",t.style.opacity="0",requestAnimationFrame(()=>{t.style.transition="opacity 0.2s",t.style.opacity="1"});const i=e=>{"Escape"===e.key&&(this.hide(),document.removeEventListener("keydown",i))};document.addEventListener("keydown",i)},hide(){const e=this.container?.querySelector(".modal-system-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},200))}};function showMessage(e,t="info",n=""){ModalSystem.show({type:t,title:n||{success:"Fullfort",error:"Feil",warning:"Advarsel",info:"Informasjon"}[t]||"",message:e,buttons:[{text:"OK",primary:!0}]})}function showConfirm(e,t="Bekreft"){return new Promise(n=>{ModalSystem.show({type:"confirm",title:t,message:e,buttons:[{text:"Nei",primary:!1,onClick:()=>n(!1)},{text:"Ja",primary:!0,onClick:()=>n(!0)}]})})}const svgIcons={"el-kontroll":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>\n  </svg>',brannvarsling:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/>\n  </svg>',"borettslag-sameie":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="4" y="2" width="16" height="20" rx="2"/>\n    <path d="M9 22v-4h6v4"/>\n    <path d="M8 6h.01M16 6h.01M8 10h.01M16 10h.01M8 14h.01M16 14h.01"/>\n  </svg>',renhold:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M12 3v5m0 8v5M5.5 8.5l3.5 3.5m6 0l3.5-3.5M3 12h5m8 0h5"/>\n    <circle cx="12" cy="12" r="2"/>\n  </svg>',vaktmester:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <circle cx="12" cy="12" r="3"/>\n    <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>\n  </svg>',"hvac-ventilasjon":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <circle cx="12" cy="12" r="3"/>\n    <path d="M12 9a9.5 9.5 0 005-7"/>\n    <path d="M15 12a9.5 9.5 0 007 5"/>\n    <path d="M12 15a9.5 9.5 0 00-5 7"/>\n    <path d="M9 12a9.5 9.5 0 00-7-5"/>\n  </svg>',"heis-lofteutstyr":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="5" y="2" width="14" height="20" rx="2"/>\n    <path d="M9 8l3-3 3 3"/>\n    <path d="M9 16l3 3 3-3"/>\n    <line x1="12" y1="5" x2="12" y2="19"/>\n  </svg>',"sikkerhet-vakt":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>\n    <path d="M9 12l2 2 4-4"/>\n  </svg>',skadedyrkontroll:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M8 2l1.88 1.88"/>\n    <path d="M14.12 3.88L16 2"/>\n    <path d="M9 7.13v-1a3.003 3.003 0 116 0v1"/>\n    <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 014-4h4a4 4 0 014 4v3c0 3.3-2.7 6-6 6"/>\n    <path d="M12 20v-9"/>\n    <path d="M6.53 9C4.6 8.8 3 7.1 3 5"/>\n    <path d="M6 13H2"/>\n    <path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>\n    <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/>\n    <path d="M22 13h-4"/>\n    <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>\n  </svg>',"vvs-rorlegger":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M14 6a4 4 0 01-4-4"/>\n    <path d="M6 6a4 4 0 014-4"/>\n    <path d="M6 6v6a6 6 0 0012 0V6"/>\n    <path d="M12 16v4"/>\n    <path d="M8 20h8"/>\n    <path d="M12 12a2 2 0 100-4 2 2 0 000 4z"/>\n  </svg>',takservice:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M3 12l9-9 9 9"/>\n    <path d="M5 10v10a1 1 0 001 1h12a1 1 0 001-1V10"/>\n    <path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/>\n  </svg>',hagearbeid:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M11 20A7 7 0 019.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10z"/>\n    <path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>\n  </svg>',"it-service":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="2" y="3" width="20" height="14" rx="2"/>\n    <line x1="8" y1="21" x2="16" y2="21"/>\n    <line x1="12" y1="17" x2="12" y2="21"/>\n    <path d="M8 9l-2 2 2 2"/>\n    <path d="M16 9l2 2-2 2"/>\n  </svg>',vinduspuss:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="3" y="3" width="18" height="18" rx="2"/>\n    <line x1="12" y1="3" x2="12" y2="21"/>\n    <line x1="3" y1="12" x2="21" y2="12"/>\n    <path d="M18 6l-3 3"/>\n    <path d="M16.5 4.5l1 1"/>\n  </svg>',avfallshandtering:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M7 19H4.815a1.83 1.83 0 01-1.57-.881 1.785 1.785 0 01-.004-1.784L7.196 9.5"/>\n    <path d="M11 19h8.203a1.83 1.83 0 001.556-.89 1.784 1.784 0 00-.004-1.775L16.8 9.5"/>\n    <path d="M9.5 6.5l1.474-2.381A1.829 1.829 0 0112.54 3a1.78 1.78 0 011.578.885L17 9.5"/>\n    <path d="M2.5 14.5L5 12l2.5 2.5"/>\n    <path d="M16.5 12L19 14.5 21.5 12"/>\n    <path d="M14 6l-2-3.5L10 6"/>\n  </svg>',"vedlikehold-bygg":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 010-3L12 9"/>\n    <path d="M17.64 15L22 10.64"/>\n    <path d="M20.91 11.7l-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 00-3.94-1.64H9l.92.82A6.18 6.18 0 0112 8.4v1.56l2 2h2.47l2.26 1.91"/>\n  </svg>',"serviceavtaler-generell":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M11 17a4 4 0 01-8 0v-3a3 3 0 013-3h2"/>\n    <path d="M13 17a4 4 0 008 0v-3a3 3 0 00-3-3h-2"/>\n    <path d="M11.5 11L9 8.5 11 7l5 4.5"/>\n    <path d="M17 8l-5.5 5.5"/>\n    <path d="M6 10l1 3"/>\n    <path d="M18 10l-1 3"/>\n  </svg>'},industryPalettes={"el-kontroll":{light:"#FBBF24",primary:"#F59E0B",dark:"#D97706"},brannvarsling:{light:"#EF4444",primary:"#DC2626",dark:"#B91C1C"},"borettslag-sameie":{light:"#60A5FA",primary:"#3B82F6",dark:"#2563EB"},renhold:{light:"#22D3EE",primary:"#06B6D4",dark:"#0891B2"},vaktmester:{light:"#FCD34D",primary:"#F59E0B",dark:"#D97706"},"hvac-ventilasjon":{light:"#38BDF8",primary:"#0EA5E9",dark:"#0284C7"},"heis-lofteutstyr":{light:"#818CF8",primary:"#6366F1",dark:"#4F46E5"},"sikkerhet-vakt":{light:"#3B82F6",primary:"#1E40AF",dark:"#1E3A8A"},skadedyrkontroll:{light:"#A3E635",primary:"#84CC16",dark:"#65A30D"},"vvs-rorlegger":{light:"#22D3EE",primary:"#0891B2",dark:"#0E7490"},takservice:{light:"#A8A29E",primary:"#78716C",dark:"#57534E"},hagearbeid:{light:"#4ADE80",primary:"#22C55E",dark:"#16A34A"},"it-service":{light:"#A78BFA",primary:"#8B5CF6",dark:"#7C3AED"},vinduspuss:{light:"#7DD3FC",primary:"#38BDF8",dark:"#0EA5E9"},avfallshandtering:{light:"#4ADE80",primary:"#16A34A",dark:"#15803D"},"vedlikehold-bygg":{light:"#B45309",primary:"#92400E",dark:"#78350F"},"serviceavtaler-generell":{light:"#C4B5FD",primary:"#A855F7",dark:"#9333EA"}};function initializeTheme(){document.documentElement.setAttribute("data-theme",currentTheme),updateMapTilesForTheme(currentTheme)}function toggleTheme(){currentTheme="dark"===currentTheme?"light":"dark",document.documentElement.setAttribute("data-theme",currentTheme),localStorage.setItem("theme",currentTheme),updateMapTilesForTheme(currentTheme)}function updateMapTilesForTheme(e){if(!map)return;map.eachLayer(t=>{if(t instanceof L.TileLayer){const n=t._url;n&&(n.includes("dark_all")||n.includes("light_all"))&&t.setUrl("dark"===e?"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png")}})}function sortByNavn(e){return e.sort((e,t)=>e.navn.localeCompare(t.navn,"nb"))}function compareNorwegian(e,t){return e.localeCompare(t,"nb")}function getNextControlDate(e){if(e.services&&Array.isArray(e.services)&&e.services.length>0){let t=null;for(const n of e.services){let e=null;n.neste_kontroll?e=new Date(n.neste_kontroll):n.siste_kontroll&&(e=new Date(n.siste_kontroll),e.setMonth(e.getMonth()+(n.intervall_months||12))),e&&(!t||e<t)&&(t=e)}if(t)return t}const t=e.kategori||"";if(t.includes("El-Kontroll")){if(e.neste_el_kontroll)return new Date(e.neste_el_kontroll);if(e.siste_el_kontroll){const t=new Date(e.siste_el_kontroll);return t.setMonth(t.getMonth()+(e.el_kontroll_intervall||36)),t}}if("Brannvarsling"===t){if(e.neste_brann_kontroll)return new Date(e.neste_brann_kontroll);if(e.siste_brann_kontroll){const t=new Date(e.siste_brann_kontroll);return t.setMonth(t.getMonth()+(e.brann_kontroll_intervall||12)),t}}if(e.neste_kontroll)return new Date(e.neste_kontroll);if(e.siste_kontroll){const t=new Date(e.siste_kontroll);return t.setMonth(t.getMonth()+(e.kontroll_intervall_mnd||12)),t}return null}function getCustomerServiceDates(e){const t=[];if(e.services&&Array.isArray(e.services))for(const n of e.services){let e=null;n.neste_kontroll?e=new Date(n.neste_kontroll):n.siste_kontroll&&(e=new Date(n.siste_kontroll),e.setMonth(e.getMonth()+(n.intervall_months||12))),e&&t.push({service_type_name:n.service_type_name,service_type_slug:n.service_type_slug,service_type_icon:n.service_type_icon,service_type_color:n.service_type_color,neste_kontroll:e,siste_kontroll:n.siste_kontroll?new Date(n.siste_kontroll):null,intervall_months:n.intervall_months})}return t}class ServiceTypeRegistry{constructor(){this.serviceTypes=new Map,this.intervals=[],this.industryTemplate=null,this.initialized=!1}loadFromConfig(e){this.serviceTypes.clear(),e.serviceTypes&&Array.isArray(e.serviceTypes)&&e.serviceTypes.forEach(e=>{this.serviceTypes.set(e.slug,{id:e.id,name:e.name,slug:e.slug,icon:e.icon||"fa-wrench",color:e.color||"#F97316",defaultInterval:e.defaultInterval||12,description:e.description||"",subtypes:e.subtypes||[],equipmentTypes:e.equipmentTypes||[]})}),this.intervals=e.intervals||[],this.industryTemplate=e.industryTemplate||null,this.initialized=!0,Logger.log(`ServiceTypeRegistry loaded: ${this.serviceTypes.size} service types`)}async loadFromIndustry(e){try{const t=await fetch(`/api/industries/${e}`),n=await t.json();if(n.success&&n.data){this.serviceTypes.clear();const t=n.data;return this.industryTemplate={id:t.id,name:t.name,slug:t.slug,icon:t.icon,color:t.color},t.serviceTypes&&Array.isArray(t.serviceTypes)&&t.serviceTypes.forEach(e=>{this.serviceTypes.set(e.slug,{id:e.id,name:e.name,slug:e.slug,icon:e.icon||"fa-wrench",color:e.color||"#F97316",defaultInterval:e.defaultInterval||12,description:e.description||"",subtypes:e.subtypes||[],equipmentTypes:e.equipment||[]})}),t.intervals&&Array.isArray(t.intervals)&&(this.intervals=t.intervals.map(e=>({months:e.months,label:e.label,isDefault:e.isDefault}))),this.initialized=!0,Logger.log(`ServiceTypeRegistry loaded from industry '${e}': ${this.serviceTypes.size} service types`),!0}return!1}catch(e){return console.error("Error loading industry service types:",e),!1}}getAll(){return Array.from(this.serviceTypes.values())}getBySlug(e){return this.serviceTypes.get(e)}getById(e){return this.getAll().find(t=>t.id===e)}getDefaultServiceType(){const e=this.getAll();return e.length>0?e[0]:{slug:"service",name:"Service",icon:"fa-wrench",color:"#F97316"}}getIcon(e){const t="string"==typeof e?this.getBySlug(e):e;return t?`<i class="fas ${t.icon}" style="color: ${t.color}"></i>`:'<i class="fas fa-wrench"></i>'}formatInterval(e){const t=this.intervals.find(t=>t.months===e);return t?.label?t.label:e<12?`${e} mnd`:12===e?"1 år":e%12==0?e/12+" år":`${e} mnd`}getIntervalOptions(){return this.intervals.length>0?this.intervals.map(e=>({value:e.months,label:e.label||this.formatInterval(e.months),isDefault:e.isDefault})):[{value:6,label:"6 mnd",isDefault:!1},{value:12,label:"1 år",isDefault:!1},{value:24,label:"2 år",isDefault:!1},{value:36,label:"3 år",isDefault:!0},{value:60,label:"5 år",isDefault:!1}]}renderCategoryTabs(e="all"){const t=this.getAll();let n=`<button class="kategori-tab ${"all"===e?"active":""}" data-kategori="alle">Alle</button>`;if(t.forEach(t=>{const a=e===t.slug||e===t.name;n+=`<button class="kategori-tab ${a?"active":""}" data-kategori="${t.name}">\n        ${this.getIcon(t)} ${t.name}\n      </button>`}),t.length>=2){const a=t.map(e=>e.name).join(" + ");n+=`<button class="kategori-tab ${e===a||"El-Kontroll + Brannvarsling"===e?"active":""}" data-kategori="${a}">\n        ${t.map(e=>this.getIcon(e)).join("")} Begge\n      </button>`}return n}renderCategoryOptions(e=""){const t=this.getAll();let n="";if(t.forEach(t=>{const a=e===t.name||e===t.slug?"selected":"";n+=`<option value="${escapeHtml(t.name)}" ${a}>${escapeHtml(t.name)}</option>`}),t.length>=2){const a=t.map(e=>e.name).join(" + "),s=e===a?"selected":"";n+=`<option value="${escapeHtml(a)}" ${s}>Begge (${escapeHtml(a)})</option>`}return n}renderSubtypeOptions(e,t=""){const n=this.getBySlug(e);if(!n||!n.subtypes||0===n.subtypes.length)return"";let a='<option value="">Ikke valgt</option>';return n.subtypes.forEach(e=>{const n=t===e.name||t===e.slug?"selected":"";a+=`<option value="${escapeHtml(e.name)}" ${n}>${escapeHtml(e.name)}</option>`}),a}renderEquipmentOptions(e,t=""){const n=this.getBySlug(e);if(!n||!n.equipmentTypes||0===n.equipmentTypes.length)return"";let a='<option value="">Ikke valgt</option>';return n.equipmentTypes.forEach(e=>{const n=t===e.name||t===e.slug?"selected":"";a+=`<option value="${escapeHtml(e.name)}" ${n}>${escapeHtml(e.name)}</option>`}),a}renderIntervalOptions(e=null){const t=this.getIntervalOptions();let n="";return t.forEach(t=>{const a=e===t.value||null===e&&t.isDefault?"selected":"";n+=`<option value="${escapeHtml(String(t.value))}" ${a}>${escapeHtml(t.label)}</option>`}),n}matchesCategory(e,t){if("all"===t||"alle"===t)return!0;const n=e.kategori||"",a=this.getBySlug(t);if(a)return n===a.name;if(t.includes("-")||t.includes("+")){const e=this.getAll().every(e=>n.includes(e.name));return e&&n.includes("+")}return n===t}isKnownCategory(e){if(!e)return!0;const t=this.getAll();for(const n of t)if(e===n.name)return!0;if(e.includes("+")){return e.split("+").map(e=>e.trim()).every(e=>t.some(t=>t.name===e))}for(const n of t)if(e.toLowerCase().includes(n.slug.toLowerCase())||e.toLowerCase().includes(n.name.toLowerCase()))return!0;return!1}getCategoryClass(e){const t=this.getAll(),n=this.getDefaultServiceType();if(!e)return n.slug;for(const n of t)if(e===n.name)return n.slug;if(e.includes("+")){return e.split("+").map(e=>e.trim()).every(e=>t.some(t=>t.name===e))?"combined":n.slug}for(const n of t)if(e.toLowerCase().includes(n.slug.toLowerCase())||e.toLowerCase().includes(n.name.toLowerCase()))return n.slug;return n.slug}getIconForCategory(e){const t=this.getAll(),n=this.getDefaultServiceType(),a=e=>svgIcons[e.slug]?`<span class="marker-svg-icon">${svgIcons[e.slug]}</span>`:`<i class="fas ${e.icon}"></i>`;if(!e)return a(n);if(e.includes("+")){return e.split("+").map(e=>e.trim()).every(e=>t.some(t=>t.name===e))&&t.length>0?t.map(e=>a(e)).join(""):a(n)}for(const n of t)if(e===n.name)return a(n);for(const n of t)if(e.toLowerCase().includes(n.slug.toLowerCase())||e.toLowerCase().includes(n.name.toLowerCase()))return a(n);return a(n)}renderDriftsOptions(e=""){const t=this.getBySlug("brannvarsling");if(!t||!t.subtypes||0===t.subtypes.length){let t='<option value="">Ingen / Ikke valgt</option>';return["Storfe","Sau","Storfe/Sau","Geit","Gris","Gartneri"].forEach(n=>{t+=`<option value="${n}" ${e===n?"selected":""}>${n}</option>`}),t}let n='<option value="">Ingen / Ikke valgt</option>';return t.subtypes.forEach(t=>{const a=t.name===e?"selected":"";n+=`<option value="${t.name}" ${a}>${t.name}</option>`}),n}renderServiceSections(e={}){const t=this.getAll();if(0===t.length)return"";const n=e.services||[];let a="";return t.forEach(e=>{const t=n.find(t=>t.service_type_slug===e.slug||t.service_type_id===e.id)||{},s=e.subtypes&&e.subtypes.length>0,o=e.equipmentTypes&&e.equipmentTypes.length>0;a+=`\n        <div class="control-section service-section" data-service-slug="${e.slug}" data-service-id="${e.id}">\n          <div class="control-section-header">\n            <i class="fas ${e.icon}" style="color: ${e.color}"></i> ${e.name}\n          </div>\n\n          ${s?`\n          <div class="form-group">\n            <label for="service_${e.slug}_subtype">Type</label>\n            <select id="service_${e.slug}_subtype" name="service_${e.slug}_subtype">\n              ${this.renderSubtypeOptions(e.slug,t.subtype_name||"")}\n            </select>\n          </div>\n          `:""}\n\n          ${o?`\n          <div class="form-group">\n            <label for="service_${e.slug}_equipment">System/Utstyr</label>\n            <select id="service_${e.slug}_equipment" name="service_${e.slug}_equipment">\n              ${this.renderEquipmentOptions(e.slug,t.equipment_name||"")}\n            </select>\n          </div>\n          `:""}\n\n          <div class="form-row">\n            <div class="form-group">\n              <label for="service_${e.slug}_siste">Siste kontroll</label>\n              <input type="date" id="service_${e.slug}_siste" name="service_${e.slug}_siste"\n                     value="${t.siste_kontroll||""}">\n            </div>\n            <div class="form-group">\n              <label for="service_${e.slug}_neste">Neste kontroll</label>\n              <input type="date" id="service_${e.slug}_neste" name="service_${e.slug}_neste"\n                     value="${t.neste_kontroll||""}">\n            </div>\n          </div>\n\n          <div class="form-group">\n            <label for="service_${e.slug}_intervall">Intervall</label>\n            <select id="service_${e.slug}_intervall" name="service_${e.slug}_intervall">\n              ${this.renderIntervalOptions(t.intervall_months||e.defaultInterval)}\n            </select>\n          </div>\n        </div>\n      `}),a}parseServiceFormData(){const e=this.getAll(),t=[];return e.forEach(e=>{if(!document.querySelector(`.service-section[data-service-slug="${e.slug}"]`))return;const n=document.getElementById(`service_${e.slug}_siste`),a=document.getElementById(`service_${e.slug}_neste`),s=document.getElementById(`service_${e.slug}_intervall`),o=document.getElementById(`service_${e.slug}_subtype`),r=document.getElementById(`service_${e.slug}_equipment`),i=n?.value||null,l=a?.value||null,d=s?.value?parseInt(s.value,10):e.defaultInterval,c=o?.value||null,u=r?.value||null;(i||l)&&t.push({service_type_id:e.id,service_type_slug:e.slug,siste_kontroll:i,neste_kontroll:l,intervall_months:d,subtype_name:c,equipment_name:u})}),t}getKategoriFromServices(e){if(!e||0===e.length)return"";const t=this.getAll(),n=[];return e.forEach(e=>{const a=t.find(t=>t.slug===e.service_type_slug||t.id===e.service_type_id);a&&!n.includes(a.name)&&n.push(a.name)}),n.join(" + ")}renderPopupControlInfo(e,t){const n=this.getAll(),a=e.kategori||"",s=e=>{if(!e)return null;return new Date(e).toLocaleDateString("no-NO",{day:"2-digit",month:"short",year:"numeric"})};if(a.includes("+")&&n.length>=2){let t='<div class="popup-controls">';return n.forEach(n=>{const a=(e.services||[]).find(e=>e.service_type_slug===n.slug||e.service_type_id===n.id);let o=a?.neste_kontroll,r=a?.siste_kontroll;o||"el-kontroll"!==n.slug?o||"brannvarsling"!==n.slug||(o=e.neste_brann_kontroll,r=e.siste_brann_kontroll):(o=e.neste_el_kontroll,r=e.siste_el_kontroll),t+=`\n          <p><strong><i class="fas ${n.icon}" style="color: ${n.color};"></i> ${n.name}:</strong></p>\n          <p style="margin-left: 20px;">Neste: ${o?escapeHtml(o):"Ikke satt"}</p>\n          ${r?`<p style="margin-left: 20px; font-size: 11px; color: #888;">Sist: ${s(r)}</p>`:""}\n        `}),t+="</div>",t}const o=n.find(e=>a===e.name||a.toLowerCase().includes(e.slug.toLowerCase()))||n[0];if(!o)return`\n        <div class="popup-control-info">\n          <p class="popup-status ${t.class}">\n            <strong>Neste kontroll:</strong>\n            <span class="control-days">${escapeHtml(t.label)}</span>\n          </p>\n        </div>`;const r=(e.services||[]).find(e=>e.service_type_slug===o.slug||e.service_type_id===o.id);let i=r?.siste_kontroll;return i||(i="el-kontroll"===o.slug?e.siste_el_kontroll:"brannvarsling"===o.slug?e.siste_brann_kontroll:e.siste_kontroll),`\n      <div class="popup-control-info">\n        <p class="popup-status ${t.class}">\n          <strong><i class="fas ${o.icon}" style="color: ${o.color};"></i> Neste kontroll:</strong>\n          <span class="control-days">${escapeHtml(t.label)}</span>\n        </p>\n        ${i?`<p style="font-size: 11px; color: #888; margin-top: 4px;">Sist: ${s(i)}</p>`:""}\n      </div>`}parseCustomData(e){if(!e)return{};if("object"==typeof e)return e;try{return JSON.parse(e)}catch{return{}}}getSubtypeLabel(e){return"el-kontroll"===e.slug?"El-type":"brannvarsling"===e.slug?"Driftstype":`${e.name} type`}getEquipmentLabel(e){return"brannvarsling"===e.slug?"Brannsystem":`${e.name} utstyr`}getCustomerSubtypeValue(e,t){const n=(e.services||[]).find(e=>e.service_type_id===t.id||e.service_type_slug===t.slug);if(n?.subtype_name)return n.subtype_name;if("el-kontroll"===t.slug&&e.el_type)return e.el_type;if("brannvarsling"===t.slug&&e.brann_driftstype)return e.brann_driftstype;return this.parseCustomData(e.custom_data)[`${t.slug}_subtype`]||null}getCustomerEquipmentValue(e,t){const n=(e.services||[]).find(e=>e.service_type_id===t.id||e.service_type_slug===t.slug);if(n?.equipment_name)return n.equipment_name;if("brannvarsling"===t.slug&&e.brann_system)return e.brann_system;return this.parseCustomData(e.custom_data)[`${t.slug}_equipment`]||null}renderPopupIndustryFields(e){const t=this.getAll(),n=e.kategori||"";let a="",s=t.filter(e=>n.includes(e.name)||n===e.name);if(0===s.length&&t.length>0){const e=t.find(e=>n.toLowerCase().includes(e.slug)||e.name.toLowerCase().includes(n.toLowerCase()));e&&s.push(e)}for(const t of s){if(t.subtypes&&t.subtypes.length>0){const n=this.getCustomerSubtypeValue(e,t);if(n){a+=`<p><strong>${escapeHtml(this.getSubtypeLabel(t))}:</strong> ${escapeHtml(n)}</p>`}}if(t.equipmentTypes&&t.equipmentTypes.length>0){const n=this.getCustomerEquipmentValue(e,t);if(n){a+=`<p><strong>${escapeHtml(this.getEquipmentLabel(t))}:</strong> ${escapeHtml(n)}</p>`}}}return a}}const serviceTypeRegistry=new ServiceTypeRegistry;function updateControlSectionHeaders(){const e=serviceTypeRegistry.getBySlug("el-kontroll"),t=serviceTypeRegistry.getBySlug("brannvarsling"),n=document.querySelector("#elKontrollSection .control-section-header");n&&e&&(n.innerHTML=`<i class="fas ${e.icon}" style="color: ${e.color}"></i> ${e.name}`);const a=document.querySelector("#brannvarslingSection .control-section-header");a&&t&&(a.innerHTML=`<i class="fas ${t.icon}" style="color: ${t.color}"></i> ${t.name}`)}function renderFilterPanelCategories(){const e=document.getElementById("categoryFilterButtons");if(!e)return;const t=serviceTypeRegistry.getAll();let n=`\n    <button class="category-btn ${"all"===selectedCategory?"active":""}" data-category="all">\n      <i class="fas fa-list"></i> Alle\n    </button>\n  `;if(t.forEach(e=>{const t=selectedCategory===e.name||selectedCategory===e.slug;n+=`\n      <button class="category-btn ${t?"active":""}" data-category="${e.name}">\n        <i class="fas ${e.icon}" style="color: ${e.color}"></i> ${e.name}\n      </button>\n    `}),t.length>=2){const e=t.map(e=>e.name).join(" + "),a=t.map(e=>`<i class="fas ${e.icon}" style="color: ${e.color}"></i>`).join("");n+=`\n      <button class="category-btn ${selectedCategory===e?"active":""}" data-category="${e}">\n        ${a} Begge\n      </button>\n    `}e.innerHTML=n,attachCategoryFilterHandlers()}function renderDriftskategoriFilter(){const e=document.getElementById("driftFilterButtons");if(!e)return;let t=[];if("all"===selectedCategory){const e=serviceTypeRegistry.getAll(),n=new Map;e.forEach(e=>{e.subtypes&&e.subtypes.length>0&&e.subtypes.forEach(e=>{n.has(e.name)||n.set(e.name,e)})}),t=Array.from(n.values())}else{const e=serviceTypeRegistry.getAll().find(e=>e.name===selectedCategory||e.slug===selectedCategory);t=e?.subtypes||[]}const n=e.parentElement;if(n&&(n.style.display=t.length>0?"block":"none"),0===t.length)return void(e.innerHTML="");let a=`\n    <button class="category-btn drift-btn ${"all"===selectedDriftskategori?"active":""}" data-drift="all">\n      <i class="fas fa-list"></i> Alle\n    </button>\n  `;t.forEach(e=>{const t=selectedDriftskategori===e.name;a+=`\n      <button class="category-btn drift-btn ${t?"active":""}" data-drift="${e.name}">${e.name}</button>\n    `}),e.innerHTML=a,attachDriftFilterHandlers()}function attachCategoryFilterHandlers(){const e=document.getElementById("categoryFilterButtons");e&&e.querySelectorAll(".category-btn").forEach(t=>{t.addEventListener("click",()=>{e.querySelectorAll(".category-btn").forEach(e=>e.classList.remove("active")),t.classList.add("active"),selectedCategory=t.dataset.category,selectedDriftskategori="all",localStorage.setItem("selectedDriftskategori","all"),renderDriftskategoriFilter(),applyFilters()})})}function attachDriftFilterHandlers(){const e=document.getElementById("driftFilterButtons");e&&e.querySelectorAll(".drift-btn").forEach(t=>{t.addEventListener("click",()=>{e.querySelectorAll(".drift-btn").forEach(e=>e.classList.remove("active")),t.classList.add("active"),selectedDriftskategori=t.dataset.drift,localStorage.setItem("selectedDriftskategori",selectedDriftskategori),applyFilters()})})}function renderDynamicFieldFilters(){const e=document.getElementById("dynamicFieldFilters");if(!e)return;const t=organizationFields.filter(e=>1===e.is_filterable||!0===e.is_filterable);if(0===t.length)return void(e.innerHTML="");const n=t.map(e=>{const t="true"===localStorage.getItem(`fieldFilterExpanded-${e.field_name}`);return`\n      <div class="category-filter dynamic-field-filter" data-field="${escapeHtml(e.field_name)}">\n        <div class="category-filter-title clickable-header" data-toggle="field-${escapeHtml(e.field_name)}">\n          <span>${escapeHtml(e.display_name)}</span>\n          <i class="fas fa-chevron-${t?"down":"right"} toggle-icon"></i>\n        </div>\n        <div class="dynamic-filter-content" id="fieldFilter-${escapeHtml(e.field_name)}" style="display: ${t?"block":"none"};">\n          ${renderFieldFilterInput(e)}\n        </div>\n      </div>\n    `}).join("");e.innerHTML=n,attachDynamicFilterHandlers()}function renderFieldFilterInput(e){const t=dynamicFieldFilters[e.field_name];switch(e.field_type){case"select":return renderSelectFilterButtons(e,t);case"text":default:return renderTextFilterInput(e,t);case"number":return renderNumberRangeFilter(e,t);case"date":return renderDateRangeFilter(e,t)}}function renderSelectFilterButtons(e,t){const n=e.options||[];let a=`<div class="category-filter-buttons">\n    <button class="category-btn dynamic-field-btn ${t&&"all"!==t?"":"active"}"\n            data-field="${escapeHtml(e.field_name)}" data-value="all">\n      <i class="fas fa-list"></i> Alle\n    </button>`;return n.forEach(n=>{const s=t===n.value;a+=`\n      <button class="category-btn dynamic-field-btn ${s?"active":""}"\n              data-field="${escapeHtml(e.field_name)}" data-value="${escapeHtml(n.value)}">\n        ${escapeHtml(n.display_name||n.value)}\n      </button>`}),a+="</div>",a}function renderTextFilterInput(e,t){return`\n    <div class="filter-input-wrapper">\n      <input type="text"\n             class="dynamic-filter-input"\n             data-field="${escapeHtml(e.field_name)}"\n             placeholder="Filtrer på ${escapeHtml(e.display_name)}..."\n             value="${escapeHtml(t||"")}">\n    </div>`}function renderNumberRangeFilter(e,t){const n=t?.min||"",a=t?.max||"";return`\n    <div class="filter-range-wrapper">\n      <input type="number" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="min" placeholder="Min" value="${n}">\n      <span class="range-separator">-</span>\n      <input type="number" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="max" placeholder="Maks" value="${a}">\n    </div>`}function renderDateRangeFilter(e,t){const n=t?.from||"",a=t?.to||"";return`\n    <div class="filter-range-wrapper">\n      <input type="date" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="from" value="${n}">\n      <span class="range-separator">til</span>\n      <input type="date" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="to" value="${a}">\n    </div>`}function attachDynamicFilterHandlers(){const e=document.getElementById("dynamicFieldFilters");if(!e)return;let t;e.querySelectorAll(".clickable-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.toggle.replace("field-",""),n=document.getElementById(`fieldFilter-${t}`),a=e.querySelector(".toggle-icon");"none"===n.style.display?(n.style.display="block",a.classList.replace("fa-chevron-right","fa-chevron-down"),localStorage.setItem(`fieldFilterExpanded-${t}`,"true")):(n.style.display="none",a.classList.replace("fa-chevron-down","fa-chevron-right"),localStorage.setItem(`fieldFilterExpanded-${t}`,"false"))})}),e.querySelectorAll(".dynamic-field-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.field,n=e.dataset.value;e.parentElement.querySelectorAll(".dynamic-field-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),"all"===n?delete dynamicFieldFilters[t]:dynamicFieldFilters[t]=n,applyFilters()})}),e.querySelectorAll(".dynamic-filter-input").forEach(e=>{e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{const t=e.dataset.field,n=e.value.trim();n?dynamicFieldFilters[t]=n:delete dynamicFieldFilters[t],applyFilters()},300)})}),e.querySelectorAll(".dynamic-filter-range").forEach(e=>{e.addEventListener("change",()=>{const t=e.dataset.field,n=e.dataset.range,a=e.value;dynamicFieldFilters[t]&&"object"==typeof dynamicFieldFilters[t]||(dynamicFieldFilters[t]={}),a?dynamicFieldFilters[t][n]=a:(delete dynamicFieldFilters[t][n],0===Object.keys(dynamicFieldFilters[t]).length&&delete dynamicFieldFilters[t]),applyFilters()})})}function updateDashboard(){if(!customers||0===customers.length)return;const e=new Date;e.setHours(0,0,0,0);let t=0,n=0,a=0;const s={};customers.forEach(o=>{const r=getNextControlDate(o);if(r){const s=Math.ceil((r-e)/864e5);s<0?t++:s<=30?n++:a++}const i=o.kategori||"Ukjent";s[i]=(s[i]||0)+1});const o=document.getElementById("dashTotalKunder"),r=document.getElementById("dashForfalte"),i=document.getElementById("dashKommende"),l=document.getElementById("dashFullfort"),d=document.getElementById("dashOverdueCount");o&&(o.textContent=customers.length),r&&(r.textContent=t),i&&(i.textContent=n),l&&(l.textContent=a),d&&(d.textContent=t);const c=document.getElementById("quickStatKunder"),u=document.getElementById("quickStatForfalte"),m=document.getElementById("quickStatKommende"),p=document.getElementById("quickStatOk");c&&(c.textContent=customers.length),u&&(u.textContent=t),m&&(m.textContent=n),p&&(p.textContent=a),renderDashboardCategories(s),renderDashboardAreas()}function renderDashboardCategories(e){const t=document.getElementById("dashCategoryOverview");if(!t)return;const n=serviceTypeRegistry.getAll();let a="";n.forEach(t=>{const n=e[t.name]||0;a+=`\n      <div class="category-stat">\n        <i class="fas ${t.icon}" style="color: ${t.color}"></i>\n        <span class="cat-name">${t.name}</span>\n        <span class="cat-count">${n}</span>\n      </div>\n    `});const s=n.map(e=>e.name).join(" + "),o=e[s]||0;if(o>0){const e=n.map(e=>`<i class="fas ${e.icon}" style="color: ${e.color}"></i>`).join("");a+=`\n      <div class="category-stat">\n        ${e}\n        <span class="cat-name">Begge</span>\n        <span class="cat-count">${o}</span>\n      </div>\n    `}t.innerHTML=a}function renderDashboardAreas(){const e=document.getElementById("dashAreaList");if(!e)return;const t={};customers.forEach(e=>{const n=e.poststed||"Ukjent";t[n]=(t[n]||0)+1});const n=Object.entries(t).sort((e,t)=>t[1]-e[1]).slice(0,10);let a="";n.forEach(([e,t])=>{a+=`\n      <div class="area-chip" data-area="${escapeHtml(e)}">\n        ${escapeHtml(e)}\n        <span class="area-count">${t}</span>\n      </div>\n    `}),e.innerHTML=a,e.querySelectorAll(".area-chip").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.area;switchToTab("customers");const n=document.getElementById("omradeFilter");n&&(n.value=t,applyFilters())})})}function switchToTab(e){const t=document.querySelector(`.tab-item[data-tab="${e}"]`);t&&t.click()}function getMapboxToken(){return appConfig.mapboxAccessToken?appConfig.mapboxAccessToken:(Logger.warn("Using fallback Mapbox token - configure MAPBOX_ACCESS_TOKEN in server environment"),"pk.eyJ1Ijoic2FuZGVyc29sdXRpb25zIiwiYSI6ImNta3JmdWt1eTB6MXgzZHNhaG5wcTV1amkifQ.dbxR-eIxqQRT3y0kw71-2g")}function getMapTileUrl(){return`https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token=${getMapboxToken()}`}function getMapAttribution(){return'&copy; <a href="https://mapbox.com/">Mapbox</a> &copy; <a href="https://openstreetmap.org/">OpenStreetMap</a>'}let currentTileLayer=null,mapMode="satellite";function toggleNightMode(){if(!map||!currentTileLayer)return;const e=document.getElementById("nightmodeBtn"),t=e?.querySelector("i"),n=document.getElementById("map");e&&(e.disabled=!0),n.style.transition="opacity 0.4s ease-out",n.style.opacity="0",setTimeout(()=>{"dark"===mapMode?(map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token=${getMapboxToken()}`,{maxZoom:19,tileSize:512,zoomOffset:-1,attribution:"&copy; Mapbox"}).addTo(map),mapMode="satellite",e?.classList.add("satellite-active"),t&&(t.className="fas fa-sun"),e?.setAttribute("title","Bytt til mørkt kart")):(map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/navigation-night-v1/tiles/{z}/{x}/{y}?access_token=${getMapboxToken()}`,{maxZoom:19,tileSize:512,zoomOffset:-1,attribution:"&copy; Mapbox"}).addTo(map),mapMode="dark",e?.classList.remove("satellite-active"),t&&(t.className="fas fa-moon"),e?.setAttribute("title","Bytt til satellittkart")),setTimeout(()=>{n.style.opacity="1",e&&(e.disabled=!1)},100)},400)}let officeMarker=null;function initSharedMap(){if(document.getElementById("map")&&!map){map=L.map("map",{zoomControl:!1,attributionControl:!1,dragging:!1,scrollWheelZoom:!1,doubleClickZoom:!1,touchZoom:!1,keyboard:!1}).setView([69.06888,17.65274],11);const e=getMapTileUrl();Logger.log("Map tile URL:",e,"| Hour:",(new Date).getHours()),currentTileLayer=L.tileLayer(e,{maxZoom:19,tileSize:512,zoomOffset:-1,attribution:getMapAttribution()}).addTo(map);const t=L.divIcon({className:"office-marker-glow",html:'\n        <div class="office-marker-container">\n          <div class="office-glow-ring"></div>\n          <div class="office-icon">\n            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>\n              <polyline points="9 22 9 12 15 12 15 22"/>\n            </svg>\n          </div>\n        </div>\n      ',iconSize:[60,60],iconAnchor:[30,30]});officeMarker=L.marker([69.06888,17.65274],{icon:t,interactive:!1}).addTo(map)}}function initLoginView(){const e=document.getElementById("spaLoginForm");e&&e.addEventListener("submit",handleSpaLogin)}async function handleSpaLogin(e){e.preventDefault();const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value,a=document.getElementById("loginRememberMe").checked,s=document.getElementById("spaLoginBtn"),o=document.getElementById("loginErrorMessage"),r=document.getElementById("loginErrorText");s.disabled=!0,s.innerHTML='<div class="login-spinner"></div><span>Logger inn...</span>',o.classList.remove("show");try{const i=await fetch("/api/klient/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({epost:t,passord:n,rememberMe:a})}),l=await i.json(),d=l.success&&l.data?l.data:l;if(i.ok&&(d.accessToken||d.token)){authToken=d.accessToken||d.token,localStorage.setItem("authToken",authToken),localStorage.setItem("userName",d.klient?.navn||d.bruker?.navn||"Bruker"),localStorage.setItem("userRole",d.klient?.rolle||d.bruker?.rolle||"bruker"),localStorage.setItem("userType",d.klient?.type||"klient"),d.refreshToken&&localStorage.setItem("refreshToken",d.refreshToken),d.accessTokenExpiresAt&&localStorage.setItem("accessTokenExpiresAt",d.accessTokenExpiresAt),d.refreshTokenExpiresAt&&localStorage.setItem("refreshTokenExpiresAt",d.refreshTokenExpiresAt),d.klient?.organizationId&&(localStorage.setItem("organizationId",d.klient.organizationId),localStorage.setItem("organizationSlug",d.klient.organizationSlug||""),localStorage.setItem("organizationName",d.klient.organizationName||"")),d.organization&&(appConfig.primaryColor=d.organization.primaryColor||appConfig.primaryColor,appConfig.secondaryColor=d.organization.secondaryColor||appConfig.secondaryColor,appConfig.logoUrl=d.organization.logoUrl||appConfig.logoUrl,appConfig.companyName=d.organization.navn||appConfig.companyName,appConfig.appName=d.organization.brandTitle||appConfig.appName,appConfig.companySubtitle=d.organization.brandSubtitle||appConfig.companySubtitle,applyBranding());const t="bruker"===d.klient?.type||"admin"===d.klient?.rolle,n=document.getElementById("adminTab");if(n&&(n.style.display=t?"flex":"none"),s.innerHTML='\n        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>\n        </svg>\n        <span>Velkommen!</span>\n      ',s.style.background="#4CAF50",console.log("[Login Debug] data.klient:",d.klient),console.log("[Login Debug] data.klient?.type:",d.klient?.type),console.log("[Login Debug] Is type === bruker?:","bruker"===d.klient?.type),"bruker"===d.klient?.type){console.log("[Login Debug] Condition matched! Calling verify...");try{const e=await fetch("/api/klient/verify",{headers:{Authorization:`Bearer ${authToken}`}}),t=await e.json();if(console.log("[Login Debug] Verify response:",t),console.log("[Login Debug] isSuperAdmin:",t.data?.user?.isSuperAdmin),t.data?.user?.isSuperAdmin)return console.log("[Login Debug] User IS super-admin! Redirecting to /admin..."),localStorage.setItem("isSuperAdmin","true"),void setTimeout(()=>{window.location.href="/admin"},500)}catch(e){console.warn("Could not verify super-admin status:",e)}}else console.log("[Login Debug] Condition NOT matched - data.klient?.type is not bruker");const a=d.organization&&!d.organization.onboardingCompleted;setTimeout(async()=>{a&&await showOnboardingWizard(),transitionToAppView()},300)}else{const e=d.error?.message||d.error||l.error?.message||"Feil e-post eller passord";r.textContent=e,o.classList.add("show"),resetLoginButton()}}catch(e){console.error("Login error:",e),"TypeError"===e.name&&e.message.includes("Failed to fetch")?r.textContent="Kunne ikke koble til server - sjekk internettforbindelsen":"SyntaxError"===e.name||e.message.includes("JSON")?r.textContent="Ugyldig respons fra server":"AbortError"===e.name?r.textContent="Forespørselen ble avbrutt":r.textContent=e.message||"Ukjent feil ved innlogging",o.classList.add("show"),resetLoginButton()}}function resetLoginButton(){const e=document.getElementById("spaLoginBtn");e&&(e.disabled=!1,e.style.background="",e.innerHTML='\n      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>\n      </svg>\n      <span>Logg inn</span>\n    ')}function showUserBar(){const e=document.getElementById("userBar"),t=document.getElementById("userNameDisplay"),n=localStorage.getItem("userName")||localStorage.getItem("klientNavn")||"Bruker",a=localStorage.getItem("userRole")||"",s=localStorage.getItem("userType")||"";e&&(e.style.display="flex",t&&(t.textContent=n));const o="bruker"===s||"admin"===a,r=document.getElementById("adminTab");r&&(r.style.display=o?"flex":"none"),initSubscriptionTimer()}function hideUserBar(){const e=document.getElementById("userBar");e&&(e.style.display="none"),hideSubscriptionTimer()}async function updateOnboardingStep(e,t={}){try{const n=await fetch("/api/onboarding/step",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({step:e,data:t})});return await n.json()}catch(e){return console.error("Error updating onboarding step:",e),{success:!1}}}async function skipOnboarding(){try{const e=await fetch("/api/onboarding/skip",{method:"POST",headers:{Authorization:`Bearer ${authToken}`}});return await e.json()}catch(e){return console.error("Error skipping onboarding:",e),{success:!1}}}async function getOnboardingStatus(){try{const e=await fetch("/api/onboarding/status",{headers:{Authorization:`Bearer ${authToken}`}});return await e.json()}catch(e){return console.error("Error getting onboarding status:",e),{success:!1}}}const onboardingWizard={currentStep:0,steps:[{id:"company",title:"Firmainformasjon",icon:"fa-building"},{id:"map",title:"Kartinnstillinger",icon:"fa-map-marker-alt"},{id:"complete",title:"Ferdig",icon:"fa-check-circle"}],data:{industry:null,company:{},map:{}},overlay:null,resolve:null};async function showOnboardingWizard(){return new Promise(async e=>{onboardingWizard.resolve=e,onboardingWizard.currentStep=0,onboardingWizard.steps=[{id:"company",title:"Firmainformasjon",icon:"fa-building"},{id:"import",title:"Importer kunder",icon:"fa-file-excel"},{id:"map",title:"Kartinnstillinger",icon:"fa-map-marker-alt"},{id:"complete",title:"Ferdig",icon:"fa-check-circle"}];const t=document.createElement("div");t.id="onboardingWizardOverlay",t.className="onboarding-overlay",onboardingWizard.overlay=t,document.body.appendChild(t),await renderWizardStep(),requestAnimationFrame(()=>{t.classList.add("visible")})})}async function renderWizardStep(){const e=onboardingWizard.overlay,t=onboardingWizard.steps[onboardingWizard.currentStep];let n="";switch(t.id){case"company":n=renderCompanyStep();break;case"import":n=renderWizardImportStep();break;case"map":n=renderMapStep();break;case"complete":n=renderCompleteStep()}e.innerHTML=`\n    <div class="onboarding-container wizard-container">\n      ${renderWizardProgress()}\n      <div class="wizard-content" data-step="${t.id}">\n        ${n}\n      </div>\n    </div>\n  `,attachStepListeners(t.id)}function renderWizardProgress(){const e=onboardingWizard.steps,t=onboardingWizard.currentStep;return`\n    <div class="wizard-progress">\n      <div class="wizard-progress-bar">\n        <div class="wizard-progress-fill" style="width: ${t/(e.length-1)*100}%"></div>\n      </div>\n      <div class="wizard-steps">\n        ${e.map((e,n)=>`\n          <div class="wizard-step ${n<t?"completed":""} ${n===t?"active":""} ${n>t?"upcoming":""}">\n            <div class="wizard-step-icon">\n              ${n<t?'<i class="fas fa-check"></i>':`<span>${n+1}</span>`}\n            </div>\n            <div class="wizard-step-label">${e.title}</div>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}function renderCompanyStep(){const e=onboardingWizard.data.company;return`\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-building"></i> Firmainformasjon</h1>\n      <p>Oppgi firmaets adresse. Dette brukes som utgangspunkt for ruteplanlegging.</p>\n    </div>\n\n    <div class="wizard-form">\n      <div class="wizard-form-group">\n        <label for="companyAddress"><i class="fas fa-map-marker-alt"></i> Firmaadresse</label>\n        <div class="wizard-address-wrapper">\n          <input type="text" id="companyAddress" placeholder="Begynn å skrive adresse..." value="${escapeHtml(e.address||"")}" autocomplete="off">\n          <div class="wizard-address-suggestions" id="wizardAddressSuggestions"></div>\n        </div>\n      </div>\n\n      <div class="wizard-form-row">\n        <div class="wizard-form-group">\n          <label for="companyPostnummer"><i class="fas fa-hashtag"></i> Postnummer</label>\n          <div class="wizard-postnummer-wrapper">\n            <input type="text" id="companyPostnummer" placeholder="0000" maxlength="4" value="${escapeHtml(e.postnummer||"")}" autocomplete="off">\n            <span class="wizard-postnummer-status" id="wizardPostnummerStatus"></span>\n          </div>\n        </div>\n        <div class="wizard-form-group">\n          <label for="companyPoststed"><i class="fas fa-city"></i> Poststed</label>\n          <input type="text" id="companyPoststed" placeholder="Fylles automatisk" value="${escapeHtml(e.poststed||"")}">\n        </div>\n      </div>\n\n      <div class="wizard-form-group">\n        <label><i class="fas fa-route"></i> Rute-startpunkt</label>\n        <p class="wizard-form-hint">Klikk på kartet for å velge startpunkt for ruter, eller bruk firmaadresse.</p>\n        <div id="wizardRouteMap" class="wizard-mini-map"></div>\n        <div class="wizard-coordinates" id="routeCoordinates">\n          ${e.route_start_lat?`<span>Valgt: ${e.route_start_lat.toFixed(5)}, ${e.route_start_lng.toFixed(5)}</span>`:'<span class="not-set">Ikke valgt - klikk på kartet</span>'}\n        </div>\n        <button class="wizard-btn wizard-btn-secondary" onclick="useAddressAsRouteStart()">\n          <i class="fas fa-home"></i> Bruk firmaadresse\n        </button>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-skip" onclick="handleSkipOnboarding()">\n        <i class="fas fa-forward"></i> Hopp over oppsett\n      </button>\n      <button class="wizard-btn wizard-btn-primary" onclick="nextWizardStep()">\n        Neste <i class="fas fa-arrow-right"></i>\n      </button>\n    </div>\n  `}function renderMapStep(){const e=onboardingWizard.data.map;return`\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-map-marker-alt"></i> Kartinnstillinger</h1>\n      <p>Velg standard kartvisning. Dra og zoom kartet til ønsket område.</p>\n    </div>\n\n    <div class="wizard-form">\n      <div class="wizard-form-group">\n        <label><i class="fas fa-map"></i> Standard kartsentrum</label>\n        <p class="wizard-form-hint">Panorer og zoom kartet til det området du vanligvis jobber i.</p>\n        <div id="wizardMainMap" class="wizard-map"></div>\n      </div>\n\n      <div class="wizard-form-group">\n        <label for="defaultZoom"><i class="fas fa-search-plus"></i> Standard zoom-nivå</label>\n        <div class="wizard-slider-container">\n          <input type="range" id="defaultZoom" min="5" max="18" value="${e.zoom||10}">\n          <span class="wizard-slider-value" id="zoomValue">${e.zoom||10}</span>\n        </div>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-primary" onclick="nextWizardStep()">\n        Fullfør oppsett <i class="fas fa-check"></i>\n      </button>\n    </div>\n  `}function renderCompleteStep(){return`\n    <div class="wizard-step-header wizard-complete">\n      <div class="wizard-complete-icon">\n        <i class="fas fa-check-circle"></i>\n      </div>\n      <h1>Oppsettet er fullført!</h1>\n      <p>Flott! Systemet er nå tilpasset for ${escapeHtml(appConfig?.industry?.name||onboardingWizard.data.industry?.name||"din virksomhet")}.</p>\n    </div>\n\n    <div class="wizard-complete-summary">\n      <h3>Hva skjer nå?</h3>\n      <ul class="wizard-tips-list">\n        <li><i class="fas fa-users"></i> Legg til dine første kunder</li>\n        <li><i class="fas fa-route"></i> Planlegg effektive ruter</li>\n        <li><i class="fas fa-calendar-alt"></i> Bruk kalenderen for å holde oversikt</li>\n        <li><i class="fas fa-cog"></i> Tilpass ytterligere i innstillinger</li>\n      </ul>\n    </div>\n\n    <div class="wizard-footer wizard-footer-center">\n      <button class="wizard-btn wizard-btn-primary wizard-btn-large" onclick="completeOnboardingWizard()">\n        <i class="fas fa-rocket"></i> Start å bruke Sky Planner\n      </button>\n    </div>\n  `}const wizardImportState={currentImportStep:1,sessionId:null,previewData:null,columnMapping:{},categoryMapping:{},customFieldMapping:{},validCategories:[],importResults:null,isLoading:!1,loadingPhase:null,loadingProgress:0,importedSoFar:0,totalToImport:0,aiQuestions:[],questionAnswers:{},requiredMappings:{navn:null,adresse:null},error:null};function resetWizardImportState(){wizardImportState.currentImportStep=1,wizardImportState.sessionId=null,wizardImportState.previewData=null,wizardImportState.columnMapping={},wizardImportState.categoryMapping={},wizardImportState.customFieldMapping={},wizardImportState.validCategories=[],wizardImportState.importResults=null,wizardImportState.isLoading=!1,wizardImportState.loadingPhase=null,wizardImportState.loadingProgress=0,wizardImportState.importedSoFar=0,wizardImportState.totalToImport=0,wizardImportState.aiQuestions=[],wizardImportState.questionAnswers={},wizardImportState.requiredMappings={navn:null,adresse:null},wizardImportState.error=null}function convertBackendToFrontendMapping(e,t){const n={};for(const[a,s]of Object.entries(e)){const e=t.indexOf(a);-1!==e&&(n[s]=e)}return n}function convertFrontendToBackendMapping(e,t){const n={};for(const[a,s]of Object.entries(e))void 0!==s&&""!==s&&t[s]&&(n[t[s]]=a);return n}function getSampleValueForColumn(e,t,n){if(!e||void 0===t||""===t||!n)return"-";const a=n[t];if(!a)return"-";const s=e[a];return null==s||""===s?"-":String(s)}function renderWizardImportStep(){const e=wizardImportState.currentImportStep;return`\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-file-excel"></i> Importer kunder</h1>\n      <p>Last opp en Excel- eller CSV-fil med dine eksisterende kunder.</p>\n    </div>\n\n    \x3c!-- Import sub-steps indicator --\x3e\n    <div class="wizard-import-steps">\n      <div class="import-step-indicator ${e>=1?"active":""}" data-step="1">\n        <span class="step-number">1</span>\n        <span class="step-label">Last opp</span>\n      </div>\n      <div class="import-step-connector ${e>=2?"active":""}"></div>\n      <div class="import-step-indicator ${e>=2?"active":""}" data-step="2">\n        <span class="step-number">2</span>\n        <span class="step-label">Mapping</span>\n      </div>\n      <div class="import-step-connector ${e>=3?"active":""}"></div>\n      <div class="import-step-indicator ${e>=3?"active":""}" data-step="3">\n        <span class="step-number">3</span>\n        <span class="step-label">Forhåndsvis</span>\n      </div>\n      <div class="import-step-connector ${e>=4?"active":""}"></div>\n      <div class="import-step-indicator ${e>=4?"active":""}" data-step="4">\n        <span class="step-number">4</span>\n        <span class="step-label">Resultat</span>\n      </div>\n    </div>\n\n    \x3c!-- Dynamic content based on sub-step --\x3e\n    <div class="wizard-import-content" id="wizardImportContent">\n      ${renderWizardImportSubStep(e)}\n    </div>\n  `}function renderWizardLoadingState(){const e=wizardImportState.loadingPhase,t=wizardImportState.loadingProgress,n={uploading:{icon:"fa-cloud-upload-alt",message:"Laster opp fil...",isAI:!1},parsing:{icon:"fa-file-excel",message:"Leser kolonner og rader...",isAI:!1},"ai-mapping":{icon:"fa-robot",message:"AI analyserer kolonner...",isAI:!0},validating:{icon:"fa-check-circle",message:"Validerer data...",isAI:!1},importing:{icon:"fa-database",message:"Importerer kunder...",isAI:!1,showProgress:!0}}[e]||{icon:"fa-spinner",message:"Behandler...",isAI:!1};return`\n    <div class="wizard-import-loading ${n.isAI?"ai-active":""}">\n      <div class="wizard-loading-icon ${n.isAI?"ai-pulse":"spinning"}">\n        <i class="fas ${n.icon}"></i>\n      </div>\n      <p class="wizard-loading-message">${n.message}</p>\n      ${n.isAI?'\n        <div class="wizard-ai-thinking">\n          <span class="ai-dot"></span>\n          <span class="ai-dot"></span>\n          <span class="ai-dot"></span>\n        </div>\n        <p class="wizard-ai-hint">AI forstår kolonnenavn som "Hvem ringer vi?" → kontaktperson</p>\n      ':""}\n      ${n.showProgress?`\n        <div class="wizard-progress-container">\n          <div class="wizard-progress-bar">\n            <div class="wizard-progress-fill" style="width: ${t}%"></div>\n          </div>\n          <p class="wizard-progress-text">${wizardImportState.importedSoFar} av ${wizardImportState.totalToImport} kunder</p>\n        </div>\n      `:""}\n    </div>\n  `}function renderWizardImportSubStep(e){if(wizardImportState.isLoading)return renderWizardLoadingState();if(wizardImportState.error)return`\n      <div class="wizard-import-error">\n        <i class="fas fa-exclamation-triangle"></i>\n        <p>${escapeHtml(wizardImportState.error)}</p>\n        <button class="wizard-btn wizard-btn-secondary" onclick="wizardImportRetry()">\n          <i class="fas fa-redo"></i> Prøv igjen\n        </button>\n      </div>\n    `;switch(e){case 1:default:return renderWizardImportUpload();case 2:return renderWizardImportMapping();case 3:return renderWizardImportPreview();case 4:return renderWizardImportResults()}}function renderWizardImportUpload(){return`\n    <div class="wizard-import-upload">\n      \x3c!-- AI Feature Banner --\x3e\n      <div class="wizard-ai-feature-banner">\n        <div class="ai-feature-icon">\n          <i class="fas fa-robot"></i>\n        </div>\n        <div class="ai-feature-content">\n          <h4><i class="fas fa-magic"></i> AI-assistert import</h4>\n          <p>Vår AI forstår <strong>${escapeHtml(appConfig?.industry?.name||"din bransje")}</strong> og mapper automatisk kolonner til riktige felt - selv med kreative kolonnenavn!</p>\n        </div>\n      </div>\n\n      <div class="wizard-import-dropzone" id="wizardImportDropzone">\n        <i class="fas fa-cloud-upload-alt"></i>\n        <p><strong>Dra og slipp fil her</strong></p>\n        <p>eller klikk for å velge</p>\n        <span class="import-formats">Støttede formater: .xlsx, .xls, .csv (maks 10MB)</span>\n        <input type="file" id="wizardImportFileInput" accept=".xlsx,.xls,.csv" hidden>\n      </div>\n\n      <div class="wizard-import-tips">\n        <h4><i class="fas fa-lightbulb"></i> Tips for import</h4>\n        <ul>\n          <li>Filen bør ha én rad per kunde</li>\n          <li>Første rad bør inneholde kolonneoverskrifter</li>\n          <li>Påkrevde felt: Navn og adresse</li>\n          <li>AI gjenkjenner bransje-spesifikke felt automatisk</li>\n        </ul>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-skip" onclick="skipWizardImport()">\n        Hopp over <i class="fas fa-forward"></i>\n      </button>\n    </div>\n  `}function renderAIQuestions(){const e=wizardImportState.aiQuestions||[];return 0===e.length?"":`\n    <div class="wizard-ai-questions">\n      <div class="wizard-ai-questions-header">\n        <i class="fas fa-question-circle"></i>\n        <span>AI trenger din hjelp med ${e.length} ${1===e.length?"kolonne":"kolonner"}</span>\n        <button class="wizard-btn-link" onclick="skipAIQuestions()">Bruk AI-anbefalinger</button>\n      </div>\n      <div class="wizard-ai-questions-list">\n        ${e.map((e,t)=>`\n          <div class="wizard-ai-question-card" data-question-index="${t}">\n            <div class="question-header">\n              <span class="question-column">"${escapeHtml(e.header)}"</span>\n              <span class="question-confidence">${Math.round(100*(e.confidence||0))}% sikker</span>\n            </div>\n            <p class="question-text">Hva inneholder denne kolonnen?</p>\n            <div class="question-options">\n              <label class="question-option ${wizardImportState.questionAnswers[e.header]===e.targetField?"selected":""}">\n                <input type="radio" name="q_${t}" value="${e.targetField||""}"\n                  ${wizardImportState.questionAnswers[e.header]===e.targetField||!wizardImportState.questionAnswers[e.header]&&e.targetField?"checked":""}\n                  onchange="handleAIQuestionAnswer('${escapeHtml(e.header)}', '${e.targetField||""}')">\n                <span>${escapeHtml(e.targetField||"Egendefinert felt")} <span class="recommended">(Anbefalt av AI)</span></span>\n              </label>\n              <label class="question-option ${"_custom"===wizardImportState.questionAnswers[e.header]?"selected":""}">\n                <input type="radio" name="q_${t}" value="_custom"\n                  ${"_custom"===wizardImportState.questionAnswers[e.header]?"checked":""}\n                  onchange="handleAIQuestionAnswer('${escapeHtml(e.header)}', '_custom')">\n                <span>Behold som egendefinert felt</span>\n              </label>\n              <label class="question-option ${"_skip"===wizardImportState.questionAnswers[e.header]?"selected":""}">\n                <input type="radio" name="q_${t}" value="_skip"\n                  ${"_skip"===wizardImportState.questionAnswers[e.header]?"checked":""}\n                  onchange="handleAIQuestionAnswer('${escapeHtml(e.header)}', '_skip')">\n                <span>Ignorer denne kolonnen</span>\n              </label>\n            </div>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}function handleAIQuestionAnswer(e,t){wizardImportState.questionAnswers[e]=t,updateWizardImportContent()}function skipAIQuestions(){wizardImportState.aiQuestions=[],updateWizardImportContent()}function updateRequiredMapping(e,t){wizardImportState.requiredMappings[e]=t,updateWizardImportContent()}function areRequiredFieldsMapped(){const{navn:e,adresse:t}=wizardImportState.requiredMappings;return!(!e||!t)&&e!==t}function isSameColumnSelected(){const{navn:e,adresse:t}=wizardImportState.requiredMappings;return e&&t&&e===t}function renderRequiredFieldSelectors(e){const t=e.allColumns||[],n=e.requiredFields||{},a=wizardImportState.requiredMappings;if(0===t.length)return"";const s=n.navn?.confidence||0,o=n.adresse?.confidence||0;return`\n    <div class="wizard-required-fields">\n      <div class="wizard-required-header">\n        <i class="fas fa-exclamation-circle"></i>\n        <span>Bekreft kolonner for kundenavn og adresse</span>\n      </div>\n      <p class="wizard-required-desc">Velg hvilke kolonner som inneholder kundenavn og adresse. Dette er påkrevd for import.</p>\n\n      <div class="wizard-required-grid">\n        <div class="wizard-required-row">\n          <label>\n            <i class="fas fa-user"></i>\n            Kundenavn *\n          </label>\n          <select id="navnColumnSelect" onchange="updateRequiredMapping('navn', this.value)" class="wizard-required-select">\n            <option value="">-- Velg kolonne --</option>\n            ${t.map(e=>`\n              <option value="${escapeHtml(e)}" ${a.navn===e?"selected":""}>\n                ${escapeHtml(e)}\n                ${n.navn?.suggestedColumn===e?" (Anbefalt)":""}\n              </option>\n            `).join("")}\n          </select>\n          ${s>0&&s<.8?`\n            <span class="confidence-warning" title="AI er ${Math.round(100*s)}% sikker">\n              <i class="fas fa-question-circle"></i>\n            </span>\n          `:""}\n        </div>\n\n        <div class="wizard-required-row">\n          <label>\n            <i class="fas fa-map-marker-alt"></i>\n            Adresse *\n          </label>\n          <select id="adresseColumnSelect" onchange="updateRequiredMapping('adresse', this.value)" class="wizard-required-select">\n            <option value="">-- Velg kolonne --</option>\n            ${t.map(e=>`\n              <option value="${escapeHtml(e)}" ${a.adresse===e?"selected":""}>\n                ${escapeHtml(e)}\n                ${n.adresse?.suggestedColumn===e?" (Anbefalt)":""}\n              </option>\n            `).join("")}\n          </select>\n          ${o>0&&o<.8?`\n            <span class="confidence-warning" title="AI er ${Math.round(100*o)}% sikker">\n              <i class="fas fa-question-circle"></i>\n            </span>\n          `:""}\n        </div>\n      </div>\n\n      ${isSameColumnSelected()?'\n        <div class="wizard-required-warning wizard-required-error">\n          <i class="fas fa-times-circle"></i>\n          <span>Kundenavn og adresse kan ikke bruke samme kolonne. Velg forskjellige kolonner.</span>\n        </div>\n      ':areRequiredFieldsMapped()?"":'\n        <div class="wizard-required-warning">\n          <i class="fas fa-exclamation-triangle"></i>\n          <span>Du må velge kolonner for kundenavn og adresse før import</span>\n        </div>\n      '}\n    </div>\n  `}function renderWizardImportMapping(){const e=wizardImportState.previewData;if(!e)return renderWizardImportUpload();const t=e.stats||{},n=e.recognizedColumns||[],a=e.newFields||[],s=e.preview||[],o=n.filter(e=>"ai"===e.source).length;n.filter(e=>"deterministic"===e.source).length;return`\n    <div class="wizard-auto-preview">\n      \x3c!-- Summary header --\x3e\n      <div class="wizard-auto-summary">\n        <div class="wizard-auto-success">\n          <i class="fas fa-check-circle"></i>\n          <span>Fant <strong>${e.totalRows||0}</strong> kunder i filen</span>\n        </div>\n\n        <div class="wizard-auto-stats">\n          <div class="wizard-auto-stat">\n            <i class="fas fa-columns"></i>\n            <span>${e.totalColumns||0} kolonner totalt</span>\n          </div>\n          <div class="wizard-auto-stat wizard-auto-stat-success">\n            <i class="fas fa-check"></i>\n            <span>${n.length} gjenkjent</span>\n          </div>\n          ${a.length>0?`\n            <div class="wizard-auto-stat wizard-auto-stat-new">\n              <i class="fas fa-plus"></i>\n              <span>${a.length} nye felt</span>\n            </div>\n          `:""}\n        </div>\n      </div>\n\n      \x3c!-- AI Status indicator --\x3e\n      ${e.aiEnabled?`\n        <div class="wizard-ai-status wizard-ai-enabled">\n          <i class="fas fa-robot"></i>\n          <span>\n            <strong>AI-assistert mapping aktivert</strong>\n            ${o>0?`- ${o} kolonner mappet av AI`:""}\n            ${e.aiModelUsed?`<span class="ai-model">(${e.aiModelUsed})</span>`:""}\n          </span>\n        </div>\n      `:'\n        <div class="wizard-ai-status wizard-ai-disabled">\n          <i class="fas fa-info-circle"></i>\n          <span>AI-mapping er ikke aktivert. Kun standard kolonnenavnmapping brukes.</span>\n        </div>\n      '}\n\n      \x3c!-- REQUIRED: Column selection for name and address --\x3e\n      ${renderRequiredFieldSelectors(e)}\n\n      \x3c!-- AI Questions for ambiguous mappings --\x3e\n      ${renderAIQuestions()}\n\n      \x3c!-- Recognized columns --\x3e\n      ${n.length>0?`\n        <div class="wizard-auto-section">\n          <h4><i class="fas fa-check-circle"></i> Gjenkjente kolonner</h4>\n          <div class="wizard-auto-columns">\n            ${n.map(e=>`\n              <div class="wizard-auto-column recognized ${"ai"===e.source?"ai-mapped":""}">\n                <span class="column-from">${escapeHtml(e.header)}</span>\n                <i class="fas fa-arrow-right"></i>\n                <span class="column-to">${escapeHtml(e.mappedTo)}</span>\n                ${"ai"===e.source?`\n                  <span class="mapping-source ai" title="Mappet av AI med ${Math.round(100*(e.confidence||0))}% sikkerhet">\n                    <i class="fas fa-robot"></i>\n                  </span>\n                `:""}\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- New fields that will be created --\x3e\n      ${a.length>0?`\n        <div class="wizard-auto-section">\n          <h4><i class="fas fa-plus-circle"></i> Nye felt som opprettes automatisk</h4>\n          <div class="wizard-auto-columns">\n            ${a.map(e=>`\n              <div class="wizard-auto-column new-field">\n                <span class="column-from">"${escapeHtml(e.header)}"</span>\n                <i class="fas fa-arrow-right"></i>\n                <span class="column-to">\n                  ${escapeHtml(e.displayName)}\n                  <span class="field-type">(${escapeHtml(e.typeDisplay)}${e.optionsCount>0?`, ${e.optionsCount} valg`:""})</span>\n                </span>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- Preview table --\x3e\n      ${s.length>0?`\n        <div class="wizard-auto-section">\n          <h4><i class="fas fa-table"></i> Forhåndsvisning</h4>\n          <div class="wizard-auto-table-wrapper">\n            <table class="wizard-auto-table">\n              <thead>\n                <tr>\n                  ${Object.keys(s[0]||{}).slice(0,6).map(e=>`\n                    <th>${escapeHtml(e)}</th>\n                  `).join("")}\n                  ${Object.keys(s[0]||{}).length>6?"<th>...</th>":""}\n                </tr>\n              </thead>\n              <tbody>\n                ${s.slice(0,3).map(e=>`\n                  <tr>\n                    ${Object.values(e).slice(0,6).map(e=>`\n                      <td>${escapeHtml(String(e||"-"))}</td>\n                    `).join("")}\n                    ${Object.keys(e).length>6?"<td>...</td>":""}\n                  </tr>\n                `).join("")}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- Validation info --\x3e\n      ${t.invalid>0?`\n        <div class="wizard-auto-warning">\n          <i class="fas fa-exclamation-triangle"></i>\n          <span>${t.invalid} rader mangler påkrevd data og vil bli hoppet over</span>\n        </div>\n      `:""}\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="wizardImportBack()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-primary wizard-btn-import"\n        onclick="wizardStartImport()"\n        ${areRequiredFieldsMapped()?"":'disabled title="Velg kolonner for kundenavn og adresse først"'}>\n        <i class="fas fa-download"></i> Importer ${e.totalRows||0} kunder\n      </button>\n    </div>\n  `}function renderUnmappedColumnsSection(e,t,n,a){const s=e.unmappedColumns||[];if(0===s.length)return"";const o=new Set(Object.values(n).filter(e=>void 0!==e&&""!==e)),r=s.filter(e=>{const n=t.indexOf(e.header);return!o.has(n)});return 0===r.length?"":(wizardImportState.customFieldMapping||(wizardImportState.customFieldMapping={}),`\n    <div class="wizard-unmapped-section">\n      <h4 class="wizard-section-title">\n        <i class="fas fa-plus-circle"></i>\n        Ekstra kolonner i filen (${r.length})\n      </h4>\n      <p class="wizard-section-desc">\n        Disse kolonnene finnes ikke i standardfeltene. Velg hva du vil gjøre med dem:\n      </p>\n\n      <div class="wizard-unmapped-grid">\n        ${r.map(e=>{const t=wizardImportState.customFieldMapping[e.header]||"ignore";return`\n            <div class="wizard-unmapped-row">\n              <div class="wizard-unmapped-info">\n                <span class="wizard-unmapped-header">${escapeHtml(e.header)}</span>\n                <span class="wizard-unmapped-sample">Eksempel: ${escapeHtml(e.sampleValue||"-")}</span>\n              </div>\n              <div class="wizard-unmapped-action">\n                <select onchange="handleUnmappedColumn('${escapeHtml(e.header)}', this.value)">\n                  <option value="ignore" ${"ignore"===t?"selected":""}>\n                    Ignorer\n                  </option>\n                  <option value="create" ${"create"===t?"selected":""}>\n                    Opprett felt "${escapeHtml(e.suggestedDisplayName||e.header)}"\n                  </option>\n                  ${a.map(e=>`\n                    <option value="map:${e.key}" ${t==="map:"+e.key?"selected":""}>\n                      Mapp til ${escapeHtml(e.label)}\n                    </option>\n                  `).join("")}\n                </select>\n              </div>\n            </div>\n          `}).join("")}\n      </div>\n    </div>\n  `)}function handleUnmappedColumn(e,t){if(wizardImportState.customFieldMapping||(wizardImportState.customFieldMapping={}),"ignore"===t)delete wizardImportState.customFieldMapping[e];else if("create"===t)wizardImportState.customFieldMapping[e]="create";else if(t.startsWith("map:")){const n=t.substring(4),a=(wizardImportState.previewData?.headers||[]).indexOf(e);-1!==a&&(wizardImportState.columnMapping[n]=a),delete wizardImportState.customFieldMapping[e]}updateWizardImportContent()}function renderWizardImportPreview(){const e=wizardImportState.previewData;if(!e||!e.preview)return renderWizardImportMapping();const t=e.preview,n=e.stats||{},a=e.categoryMatches||[],s=e.reimportPreview||{},o=e.features||{},r=wizardImportState.validCategories||[];let i="";a.length>0&&(i=`\n      <div class="wizard-category-mapping">\n        <h4><i class="fas fa-tags"></i> Kategori-mapping</h4>\n        <p>Følgende kategorier ble funnet i filen. Koble dem til eksisterende kategorier eller opprett nye.</p>\n        <div class="wizard-category-list">\n          ${a.map(e=>`\n            <div class="wizard-category-row">\n              <div class="wizard-category-original">\n                <span class="category-label">Fra fil:</span>\n                <span class="category-value">${escapeHtml(e.original)}</span>\n                <span class="category-count">(${e.count} kunder)</span>\n              </div>\n              <div class="wizard-category-arrow"><i class="fas fa-arrow-right"></i></div>\n              <div class="wizard-category-select">\n                <select data-original="${escapeHtml(e.original)}" onchange="updateWizardCategoryMapping('${escapeHtml(e.original)}', this.value)">\n                  ${e.suggested?`\n                    <option value="${escapeHtml(e.suggested.id)}" selected>\n                      ${escapeHtml(e.suggested.name)} (anbefalt)\n                    </option>\n                  `:'<option value="">-- Velg kategori --</option>'}\n                  ${r.filter(t=>!e.suggested||t.id!==e.suggested.id).map(e=>`\n                    <option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>\n                  `).join("")}\n                  <option value="__skip__">Hopp over (ingen kategori)</option>\n                  <option value="__new__">Opprett ny kategori</option>\n                </select>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `);const l=t.slice(0,10),d=["navn","adresse","postnummer","poststed","epost","telefon"];return`\n    <div class="wizard-import-preview">\n      \x3c!-- Stats summary --\x3e\n      <div class="wizard-preview-stats">\n        <div class="stat-item">\n          <i class="fas fa-file-alt"></i>\n          <span class="stat-value">${n.totalRows||0}</span>\n          <span class="stat-label">Totalt rader</span>\n        </div>\n        <div class="stat-item ${n.validRows>0?"success":""}">\n          <i class="fas fa-check-circle"></i>\n          <span class="stat-value">${n.validRows||0}</span>\n          <span class="stat-label">Gyldige</span>\n        </div>\n        <div class="stat-item ${n.warnings>0?"warning":""}">\n          <i class="fas fa-exclamation-triangle"></i>\n          <span class="stat-value">${n.warnings||0}</span>\n          <span class="stat-label">Advarsler</span>\n        </div>\n        <div class="stat-item ${n.errors>0?"error":""}">\n          <i class="fas fa-times-circle"></i>\n          <span class="stat-value">${n.errors||0}</span>\n          <span class="stat-label">Feil</span>\n        </div>\n        <div class="stat-item ${n.duplicates>0?"warning":""}">\n          <i class="fas fa-copy"></i>\n          <span class="stat-value">${n.duplicates||0}</span>\n          <span class="stat-label">Duplikater</span>\n        </div>\n      </div>\n\n      ${o.updateEnabled||o.deletionDetectionEnabled?`\n        \x3c!-- Re-import Preview Summary --\x3e\n        <div class="wizard-reimport-summary">\n          <h4><i class="fas fa-sync-alt"></i> Oppsummering av import</h4>\n          <div class="wizard-reimport-stats">\n            <div class="reimport-stat-item new">\n              <i class="fas fa-plus-circle"></i>\n              <span class="stat-value">${s.toCreate||0}</span>\n              <span class="stat-label">Nye kunder</span>\n            </div>\n            ${o.updateEnabled?`\n              <div class="reimport-stat-item update">\n                <i class="fas fa-edit"></i>\n                <span class="stat-value">${s.toUpdate||0}</span>\n                <span class="stat-label">Oppdateres</span>\n              </div>\n              <div class="reimport-stat-item unchanged">\n                <i class="fas fa-equals"></i>\n                <span class="stat-value">${s.unchanged||0}</span>\n                <span class="stat-label">Uendret</span>\n              </div>\n            `:""}\n          </div>\n          ${o.deletionDetectionEnabled&&s.notInImport&&s.notInImport.length>0?`\n            <div class="wizard-not-in-import-info">\n              <i class="fas fa-info-circle"></i>\n              <div>\n                <strong>${s.notInImport.length} eksisterende kunder finnes ikke i importfilen</strong>\n                <p>Disse kundene vil <strong>IKKE</strong> bli slettet. De vises kun for informasjon.</p>\n                <details>\n                  <summary>Vis kunder</summary>\n                  <ul class="not-in-import-list">\n                    ${s.notInImport.slice(0,10).map(e=>`\n                      <li>${escapeHtml(e.navn)} - ${escapeHtml(e.adresse)}</li>\n                    `).join("")}\n                    ${s.notInImport.length>10?`<li>...og ${s.notInImport.length-10} flere</li>`:""}\n                  </ul>\n                </details>\n              </div>\n            </div>\n          `:""}\n        </div>\n      `:""}\n\n      ${i}\n\n      \x3c!-- Preview table --\x3e\n      <div class="wizard-preview-table-wrapper">\n        <h4><i class="fas fa-table"></i> Forhåndsvisning (${Math.min(10,l.length)} av ${n.totalRows||0} rader)</h4>\n        <table class="wizard-preview-table">\n          <thead>\n            <tr>\n              <th>#</th>\n              ${d.map(e=>`<th>${escapeHtml(e)}</th>`).join("")}\n              <th>Status</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${l.map((e,t)=>`\n              <tr class="${e.hasError?"row-error":e.hasWarning?"row-warning":""}">\n                <td>${t+1}</td>\n                ${d.map(t=>`\n                  <td>${escapeHtml(e[t]||"-")}</td>\n                `).join("")}\n                <td>\n                  ${e.hasError?`<span class="status-error" title="${escapeHtml(e.errorMessage||"Feil")}"><i class="fas fa-times-circle"></i></span>`:e.hasWarning?`<span class="status-warning" title="${escapeHtml(e.warningMessage||"Advarsel")}"><i class="fas fa-exclamation-triangle"></i></span>`:'<span class="status-ok"><i class="fas fa-check-circle"></i></span>'}\n                </td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n\n      ${n.errors>0?`\n        <div class="wizard-preview-warning">\n          <i class="fas fa-info-circle"></i>\n          <p>${n.errors} rad(er) har feil og vil ikke bli importert. Du kan fortsette med de gyldige radene.</p>\n        </div>\n      `:""}\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="wizardImportBack()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-primary" onclick="wizardStartImport()" ${0===n.validRows?"disabled":""}>\n        <i class="fas fa-file-import"></i> Importer ${n.validRows||0} kunder\n      </button>\n    </div>\n  `}function renderWizardImportResults(){const e=wizardImportState.importResults;if(!e)return renderWizardImportPreview();const t=e.success&&e.importedCount>0;return`\n    <div class="wizard-import-results">\n      <div class="wizard-results-icon ${t?"success":"partial"}">\n        <i class="fas ${t?"fa-check-circle":"fa-exclamation-circle"}"></i>\n      </div>\n\n      <h2>${t?"Import fullført!":"Import delvis fullført"}</h2>\n\n      <div class="wizard-results-stats">\n        <div class="result-stat success">\n          <i class="fas fa-check"></i>\n          <span class="stat-value">${e.importedCount||0}</span>\n          <span class="stat-label">Kunder importert</span>\n        </div>\n        ${e.autoFixedCount>0?`\n          <div class="result-stat auto-fixed">\n            <i class="fas fa-magic"></i>\n            <span class="stat-value">${e.autoFixedCount}</span>\n            <span class="stat-label">Automatisk korrigert</span>\n          </div>\n        `:""}\n        ${e.newFieldsCreated>0?`\n          <div class="result-stat info">\n            <i class="fas fa-plus-circle"></i>\n            <span class="stat-value">${e.newFieldsCreated}</span>\n            <span class="stat-label">Nye felt opprettet</span>\n          </div>\n        `:""}\n        ${e.skippedCount>0?`\n          <div class="result-stat warning">\n            <i class="fas fa-forward"></i>\n            <span class="stat-value">${e.skippedCount}</span>\n            <span class="stat-label">Hoppet over</span>\n          </div>\n        `:""}\n        ${e.errorCount>0?`\n          <div class="result-stat error">\n            <i class="fas fa-times"></i>\n            <span class="stat-value">${e.errorCount}</span>\n            <span class="stat-label">Feilet</span>\n          </div>\n        `:""}\n      </div>\n\n      ${e.importedCount>0?`\n        <p class="wizard-results-message">\n          Kundene er nå tilgjengelige i systemet. Du kan se dem på kartet etter at oppsettet er fullført.\n          ${e.autoFixedCount>0?`<br><br><i class="fas fa-magic"></i> <strong>${e.autoFixedCount} kunder</strong> ble automatisk korrigert (manglende data ble utfylt).`:""}\n          ${e.newFieldsCreated>0?`<br><strong>${e.newFieldsCreated} nye felt</strong> ble automatisk opprettet basert på kolonnene i filen.`:""}\n        </p>\n      `:""}\n\n      ${e.errors&&e.errors.length>0?`\n        <div class="wizard-results-errors">\n          <h4><i class="fas fa-exclamation-triangle"></i> Feil under import</h4>\n          <ul>\n            ${e.errors.slice(0,5).map(e=>`\n              <li>${escapeHtml(e.row?`Rad ${e.row}: `:"")}${escapeHtml(e.message||"Ukjent feil")}</li>\n            `).join("")}\n            ${e.errors.length>5?`<li>...og ${e.errors.length-5} flere feil</li>`:""}\n          </ul>\n        </div>\n      `:""}\n    </div>\n\n    <div class="wizard-footer wizard-footer-center">\n      <button class="wizard-btn wizard-btn-primary" onclick="wizardImportComplete()">\n        Fortsett til neste steg <i class="fas fa-arrow-right"></i>\n      </button>\n    </div>\n  `}function updateWizardMapping(e,t){""===t?delete wizardImportState.columnMapping[e]:wizardImportState.columnMapping[e]=parseInt(t,10)}function updateWizardCategoryMapping(e,t){""===t||"__skip__"===t?delete wizardImportState.categoryMapping[e]:wizardImportState.categoryMapping[e]="__new__"===t?{createNew:!0,name:e}:t}function validateWizardMapping(){const e=wizardImportState.columnMapping,t=[];return void 0!==e.navn&&""!==e.navn||t.push("Kundenavn er påkrevd"),void 0!==e.adresse&&""!==e.adresse||t.push("Adresse er påkrevd"),t}function wizardImportBack(){wizardImportState.currentImportStep>1&&(wizardImportState.currentImportStep--,wizardImportState.error=null,updateWizardImportContent())}async function wizardImportNext(){const e=wizardImportState.currentImportStep;if(2===e){const e=validateWizardMapping();if(e.length>0)return void showMessage(e.join(". "),"error");await wizardFetchPreview()}else e<4&&(wizardImportState.currentImportStep++,updateWizardImportContent())}function skipWizardImport(){resetWizardImportState(),nextWizardStep()}function wizardImportComplete(){resetWizardImportState(),nextWizardStep()}function wizardImportRetry(){wizardImportState.error=null,wizardImportState.isLoading=!1,wizardImportState.currentImportStep>1&&(wizardImportState.currentImportStep=1),updateWizardImportContent()}function updateWizardImportContent(){const e=document.getElementById("wizardImportContent");e&&(e.innerHTML=renderWizardImportSubStep(wizardImportState.currentImportStep),attachWizardImportListeners());const t=document.querySelectorAll(".import-step-indicator"),n=document.querySelectorAll(".import-step-connector");t.forEach((e,t)=>{const n=t+1;e.classList.toggle("active",n<=wizardImportState.currentImportStep)}),n.forEach((e,t)=>{const n=t+2;e.classList.toggle("active",n<=wizardImportState.currentImportStep)})}function attachWizardImportListeners(){const e=document.getElementById("wizardImportDropzone"),t=document.getElementById("wizardImportFileInput");e&&t&&(e.addEventListener("click",()=>t.click()),e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.classList.add("dragover")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("dragover");const n=t.dataTransfer.files;n.length>0&&wizardHandleFileSelect(n[0])}),t.addEventListener("change",e=>{e.target.files.length>0&&wizardHandleFileSelect(e.target.files[0])}))}async function wizardHandleFileSelect(e){const t=e.name.toLowerCase().substring(e.name.lastIndexOf("."));if(["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv","application/csv"].includes(e.type)||[".xlsx",".xls",".csv"].includes(t))if(e.size>10485760)showMessage("Filen er for stor. Maks størrelse er 10MB","error");else{wizardImportState.isLoading=!0,wizardImportState.loadingPhase="uploading",updateWizardImportContent();try{const t=new FormData;t.append("file",e),setTimeout(()=>{wizardImportState.isLoading&&(wizardImportState.loadingPhase="parsing",updateWizardImportContent())},500),setTimeout(()=>{wizardImportState.isLoading&&(wizardImportState.loadingPhase="ai-mapping",updateWizardImportContent())},1200);const n=await fetch("/api/kunder/import-excel/preview",{method:"POST",headers:{Authorization:`Bearer ${authToken}`},body:t}),a=await n.json();if(!n.ok||!a.success)throw new Error(a.error||"Kunne ikke behandle filen");wizardImportState.sessionId=a.sessionId,wizardImportState.previewData=a.data,a.data.lowConfidenceMappings&&a.data.lowConfidenceMappings.length>0&&(wizardImportState.aiQuestions=a.data.lowConfidenceMappings.filter(e=>e.confidence>=.5&&e.confidence<.8).slice(0,3)),a.data.requiredFields?(wizardImportState.requiredMappings={navn:a.data.requiredFields.navn?.currentMapping||a.data.requiredFields.navn?.suggestedColumn||a.data.allColumns?.[0]||null,adresse:a.data.requiredFields.adresse?.currentMapping||a.data.requiredFields.adresse?.suggestedColumn||a.data.allColumns?.[1]||null},console.log("[DEBUG] Required mappings initialized:",wizardImportState.requiredMappings),console.log("[DEBUG] From requiredFields:",a.data.requiredFields)):console.log("[DEBUG] No requiredFields in response");const s=a.data.suggestedMapping||{},o=a.data.headers||a.data.allColumns||[];wizardImportState.columnMapping=convertBackendToFrontendMapping(s,o),wizardImportState.validCategories=a.data.validCategories||[],wizardImportState.isLoading=!1,wizardImportState.currentImportStep=2,a.data.categoryMatches&&a.data.categoryMatches.forEach(e=>{e.suggested&&(wizardImportState.categoryMapping[e.original]=e.suggested.id)}),updateWizardImportContent()}catch(e){console.error("Wizard import error:",e),wizardImportState.isLoading=!1,wizardImportState.error=e.message||"En feil oppstod under behandling av filen",updateWizardImportContent()}}else showMessage("Ugyldig filtype. Bruk .xlsx, .xls eller .csv","error")}async function wizardFetchPreview(){wizardImportState.isLoading=!0,updateWizardImportContent();try{const e=wizardImportState.previewData?.headers||[],t=convertFrontendToBackendMapping(wizardImportState.columnMapping,e),n=await fetch("/api/kunder/import-excel/preview",{method:"POST",headers:{Authorization:`Bearer ${authToken}`,"Content-Type":"application/json"},body:JSON.stringify({sessionId:wizardImportState.sessionId,columnMapping:t,categoryMapping:wizardImportState.categoryMapping})}),a=await n.json();if(!n.ok||!a.success)throw new Error(a.error||"Kunne ikke hente forhåndsvisning");wizardImportState.previewData=a.data,wizardImportState.isLoading=!1,wizardImportState.currentImportStep=3,a.data.categoryMatches&&a.data.categoryMatches.forEach(e=>{e.suggested&&!wizardImportState.categoryMapping[e.original]&&(wizardImportState.categoryMapping[e.original]=e.suggested.id)}),updateWizardImportContent()}catch(e){console.error("Wizard preview error:",e),wizardImportState.isLoading=!1,wizardImportState.error=e.message||"En feil oppstod under henting av forhåndsvisning",updateWizardImportContent()}}async function wizardStartImport(e=!1,t=!1){const{navn:n,adresse:a}=wizardImportState.requiredMappings;if(n&&""!==n&&"-- Velg kolonne --"!==n)if(a&&""!==a&&"-- Velg kolonne --"!==a)if(n!==a){console.log("Starting import with mappings:",{navn:n,adresse:a,confirmUpdate:e,confirmDeletions:t}),wizardImportState.isLoading=!0,wizardImportState.loadingPhase="importing",wizardImportState.loadingProgress=0,wizardImportState.importedSoFar=0,wizardImportState.totalToImport=wizardImportState.previewData?.totalRows||0,updateWizardImportContent();try{const n=await fetch("/api/kunder/import-excel/execute",{method:"POST",headers:{Authorization:`Bearer ${authToken}`,"Content-Type":"application/json"},body:JSON.stringify({sessionId:wizardImportState.sessionId,requiredMappings:wizardImportState.requiredMappings,confirmUpdate:e,confirmDeletions:t})}),a=await n.json();if(!n.ok){if("update"===a.requireConfirmation)return wizardImportState.isLoading=!1,updateWizardImportContent(),confirm(`${a.updateCount} eksisterende kunder vil bli oppdatert.\n\nVil du fortsette?`)?wizardStartImport(!0,t):void 0;if("deletions"===a.requireConfirmation)return wizardImportState.isLoading=!1,updateWizardImportContent(),confirm(`${a.notInImportCount} eksisterende kunder finnes ikke i importfilen.\n\nDisse vil IKKE bli slettet. Trykk OK for å fortsette.`)?wizardStartImport(e,!0):void 0;const n="string"==typeof a.error?a.error:a.error?.message||a.message||"Import feilet";throw new Error(n)}wizardImportState.importResults=a,wizardImportState.isLoading=!1,wizardImportState.currentImportStep=4,updateWizardImportContent(),a.importedCount>0&&refreshCustomerData()}catch(e){console.error("Wizard import execute error:",e),wizardImportState.isLoading=!1;let t="En feil oppstod under import";"string"==typeof e?t=e:e&&"string"==typeof e.message?t=e.message:e&&"string"==typeof e.error&&(t=e.error),wizardImportState.error=t,updateWizardImportContent()}}else showMessage("Kundenavn og adresse kan ikke bruke samme kolonne. Velg forskjellige kolonner.","error");else showMessage("Du må velge hvilken kolonne som inneholder adresse","error");else showMessage("Du må velge hvilken kolonne som inneholder kundenavn","error")}async function refreshCustomerData(){try{"function"==typeof loadCustomers&&await loadCustomers()}catch(e){console.error("Error refreshing customer data:",e)}}function attachStepListeners(e){switch(e){case"company":attachCompanyListeners();break;case"import":attachWizardImportListeners();break;case"map":attachMapListeners()}}window.handleUnmappedColumn=handleUnmappedColumn;let wizardRouteMap=null,wizardRouteMarker=null;function attachCompanyListeners(){setTimeout(()=>{if(document.getElementById("wizardRouteMap")&&!wizardRouteMap){const e=onboardingWizard.data.company,t=e.route_start_lat||59.9139,n=e.route_start_lng||10.7522;wizardRouteMap=L.map("wizardRouteMap").setView([t,n],10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(wizardRouteMap),e.route_start_lat&&(wizardRouteMarker=L.marker([t,n]).addTo(wizardRouteMap)),wizardRouteMap.on("click",e=>{wizardRouteMarker&&wizardRouteMap.removeLayer(wizardRouteMarker),wizardRouteMarker=L.marker(e.latlng).addTo(wizardRouteMap),onboardingWizard.data.company.route_start_lat=e.latlng.lat,onboardingWizard.data.company.route_start_lng=e.latlng.lng,document.getElementById("routeCoordinates").innerHTML=`<span>Valgt: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}</span>`})}},100);const e=document.getElementById("companyPoststed");e&&e.addEventListener("input",e=>{onboardingWizard.data.company.poststed=e.target.value}),setupWizardAddressAutocomplete(),setupWizardPostnummerLookup()}let wizardAddressSuggestions=[],wizardSelectedIndex=-1;function setupWizardAddressAutocomplete(){const e=document.getElementById("companyAddress"),t=document.getElementById("wizardAddressSuggestions");if(!e||!t)return;const n=debounce(async e=>{if(e.length<3)return t.classList.remove("visible"),void(wizardAddressSuggestions=[]);wizardAddressSuggestions=await searchAddresses(e),wizardSelectedIndex=-1,renderWizardAddressSuggestions(wizardAddressSuggestions)},300);e.addEventListener("input",e=>{onboardingWizard.data.company.address=e.target.value,n(e.target.value)}),e.addEventListener("keydown",e=>{wizardAddressSuggestions.length&&("ArrowDown"===e.key?(e.preventDefault(),wizardSelectedIndex=Math.min(wizardSelectedIndex+1,wizardAddressSuggestions.length-1),updateWizardSuggestionSelection()):"ArrowUp"===e.key?(e.preventDefault(),wizardSelectedIndex=Math.max(wizardSelectedIndex-1,0),updateWizardSuggestionSelection()):"Enter"===e.key&&wizardSelectedIndex>=0?(e.preventDefault(),selectWizardAddressSuggestion(wizardAddressSuggestions[wizardSelectedIndex])):"Escape"===e.key&&(t.classList.remove("visible"),wizardAddressSuggestions=[]))}),document.addEventListener("click",n=>{e.contains(n.target)||t.contains(n.target)||t.classList.remove("visible")})}function renderWizardAddressSuggestions(e){const t=document.getElementById("wizardAddressSuggestions");if(t){if(!e||0===e.length)return t.innerHTML="",void t.classList.remove("visible");t.innerHTML=e.map((e,t)=>`\n    <div class="wizard-address-suggestion" data-index="${t}">\n      <i class="fas fa-map-marker-alt"></i>\n      <div class="wizard-address-text">\n        <div class="wizard-address-main">${escapeHtml(e.adresse)}</div>\n        <div class="wizard-address-detail">${escapeHtml(e.postnummer)} ${escapeHtml(e.poststed)}${e.kommune?`, ${escapeHtml(e.kommune)}`:""}</div>\n      </div>\n    </div>\n  `).join(""),t.classList.add("visible"),t.querySelectorAll(".wizard-address-suggestion").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index);selectWizardAddressSuggestion(wizardAddressSuggestions[t])})})}}function updateWizardSuggestionSelection(){document.querySelectorAll(".wizard-address-suggestion").forEach((e,t)=>{e.classList.toggle("selected",t===wizardSelectedIndex)})}function selectWizardAddressSuggestion(e){const t=document.getElementById("companyAddress"),n=document.getElementById("companyPostnummer"),a=document.getElementById("companyPoststed"),s=document.getElementById("wizardAddressSuggestions");t&&(t.value=e.adresse),n&&(n.value=e.postnummer),a&&(a.value=e.poststed,a.classList.add("auto-filled")),onboardingWizard.data.company.address=e.adresse,onboardingWizard.data.company.postnummer=e.postnummer,onboardingWizard.data.company.poststed=e.poststed,onboardingWizard.data.company.route_start_lat=e.lat,onboardingWizard.data.company.route_start_lng=e.lng,wizardRouteMap&&(wizardRouteMarker&&wizardRouteMap.removeLayer(wizardRouteMarker),wizardRouteMarker=L.marker([e.lat,e.lng]).addTo(wizardRouteMap),wizardRouteMap.setView([e.lat,e.lng],14));const o=document.getElementById("routeCoordinates");o&&(o.innerHTML=`<span>Valgt: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}</span>`),updateWizardPostnummerStatus("valid"),s&&(s.classList.remove("visible"),wizardAddressSuggestions=[])}function setupWizardPostnummerLookup(){const e=document.getElementById("companyPostnummer"),t=document.getElementById("companyPoststed");e&&e.addEventListener("input",async e=>{const n=e.target.value;if(onboardingWizard.data.company.postnummer=n,4===n.length&&/^\d{4}$/.test(n)){updateWizardPostnummerStatus("loading");const e=await lookupPostnummer(n);e?(t&&(t.value=e,t.classList.add("auto-filled")),onboardingWizard.data.company.poststed=e,updateWizardPostnummerStatus("valid")):updateWizardPostnummerStatus("invalid")}else n.length<4&&updateWizardPostnummerStatus("")})}function updateWizardPostnummerStatus(e){const t=document.getElementById("wizardPostnummerStatus");if(t)switch(t.className="wizard-postnummer-status",e){case"valid":t.innerHTML='<i class="fas fa-check"></i>',t.classList.add("valid");break;case"invalid":t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("invalid");break;case"loading":t.innerHTML='<i class="fas fa-spinner fa-spin"></i>',t.classList.add("loading");break;default:t.innerHTML=""}}let wizardMainMap=null;function attachMapListeners(){setTimeout(()=>{if(document.getElementById("wizardMainMap")&&!wizardMainMap){const e=onboardingWizard.data.map,t=onboardingWizard.data.company,n=e.center_lat||t.route_start_lat||59.9139,a=e.center_lng||t.route_start_lng||10.7522,s=e.zoom||10;wizardMainMap=L.map("wizardMainMap").setView([n,a],s),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(wizardMainMap),wizardMainMap.on("moveend",()=>{const e=wizardMainMap.getCenter();onboardingWizard.data.map.center_lat=e.lat,onboardingWizard.data.map.center_lng=e.lng,onboardingWizard.data.map.zoom=wizardMainMap.getZoom(),document.getElementById("defaultZoom").value=wizardMainMap.getZoom(),document.getElementById("zoomValue").textContent=wizardMainMap.getZoom()})}},100);const e=document.getElementById("defaultZoom");e&&e.addEventListener("input",e=>{const t=parseInt(e.target.value);document.getElementById("zoomValue").textContent=t,onboardingWizard.data.map.zoom=t,wizardMainMap&&wizardMainMap.setZoom(t)})}async function useAddressAsRouteStart(){const e=onboardingWizard.data.company.address,t=onboardingWizard.data.company.postnummer,n=onboardingWizard.data.company.poststed;if(!e||!t||!n)return void showMessage("Fyll ut firmaadresse først","warning");const a=`${e}, ${t} ${n}, Norge`;try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}`),t=await e.json();if(t&&t.length>0){const e=parseFloat(t[0].lat),n=parseFloat(t[0].lon);onboardingWizard.data.company.route_start_lat=e,onboardingWizard.data.company.route_start_lng=n,wizardRouteMap&&(wizardRouteMarker&&wizardRouteMap.removeLayer(wizardRouteMarker),wizardRouteMarker=L.marker([e,n]).addTo(wizardRouteMap),wizardRouteMap.setView([e,n],14)),document.getElementById("routeCoordinates").innerHTML=`<span>Valgt: ${e.toFixed(5)}, ${n.toFixed(5)}</span>`}else showMessage("Kunne ikke finne adressen. Prøv å klikke på kartet manuelt.","warning")}catch(e){console.error("Geocoding error:",e),showMessage("Feil ved søk etter adresse","error")}}async function nextWizardStep(){try{console.log("nextWizardStep called, current step:",onboardingWizard.currentStep);const e=onboardingWizard.steps[onboardingWizard.currentStep].id;if(console.log("Current step ID:",e),"company"===e){const e=onboardingWizard.data.company;console.log("Saving company data:",e);const t=await updateOnboardingStep("company_info",{company_address:e.address,company_postnummer:e.postnummer,company_poststed:e.poststed,route_start_lat:e.route_start_lat,route_start_lng:e.route_start_lng});console.log("Company step save result:",t)}else if("map"===e){const e=onboardingWizard.data.map;console.log("Saving map data:",e);const t=await updateOnboardingStep("map_settings",{map_center_lat:e.center_lat,map_center_lng:e.center_lng,map_zoom:e.zoom});console.log("Map step save result:",t)}cleanupWizardMaps(),onboardingWizard.currentStep++,console.log("Moving to step:",onboardingWizard.currentStep),await renderWizardStep()}catch(e){console.error("Error in nextWizardStep:",e),showMessage("Det oppstod en feil. Prøv igjen.","error")}}async function prevWizardStep(){onboardingWizard.currentStep>0&&(cleanupWizardMaps(),onboardingWizard.currentStep--,await renderWizardStep())}function cleanupWizardMaps(){wizardRouteMap&&(wizardRouteMap.remove(),wizardRouteMap=null,wizardRouteMarker=null),wizardMainMap&&(wizardMainMap.remove(),wizardMainMap=null)}async function completeOnboardingWizard(){await updateOnboardingStep("completed",{}),cleanupWizardMaps();const e=onboardingWizard.overlay;e.classList.remove("visible"),setTimeout(()=>{e.remove(),onboardingWizard.overlay=null,showContextTips(),onboardingWizard.resolve&&onboardingWizard.resolve()},400)}async function handleSkipOnboarding(){if(await showConfirm("Er du sikker på at du vil hoppe over oppsettet? Du kan alltid endre innstillinger senere.","Hopp over oppsett")){await skipOnboarding(),cleanupWizardMaps();const e=onboardingWizard.overlay;e.classList.remove("visible"),setTimeout(()=>{e.remove(),onboardingWizard.overlay=null,onboardingWizard.resolve&&onboardingWizard.resolve()},400)}}window.nextWizardStep=nextWizardStep,window.prevWizardStep=prevWizardStep,window.handleSkipOnboarding=handleSkipOnboarding,window.useAddressAsRouteStart=useAddressAsRouteStart,window.completeOnboardingWizard=completeOnboardingWizard,window.skipWizardImport=skipWizardImport,window.wizardImportBack=wizardImportBack,window.wizardImportNext=wizardImportNext,window.wizardStartImport=wizardStartImport,window.wizardImportComplete=wizardImportComplete,window.wizardImportRetry=wizardImportRetry,window.updateWizardMapping=updateWizardMapping,window.updateWizardCategoryMapping=updateWizardCategoryMapping;const contextTips={tips:[{id:"map-intro",target:"#map",title:"Interaktivt kart",message:"Her ser du alle kundene dine på kartet. Klikk på en markør for å se detaljer.",position:"top",icon:"fa-map-marked-alt"},{id:"add-customer",target:".customer-add-btn, .add-client-btn, #addClientBtn",title:"Legg til kunder",message:"Klikk her for å legge til din første kunde.",position:"bottom",icon:"fa-user-plus"},{id:"route-planning",target:'.route-btn, #routeBtn, [data-action="route"]',title:"Ruteplanlegging",message:"Planlegg effektive ruter mellom kundene dine.",position:"bottom",icon:"fa-route"},{id:"calendar",target:'.calendar-btn, #calendarBtn, [data-view="calendar"]',title:"Kalender",message:"Hold oversikt over avtaler og oppgaver i kalenderen.",position:"bottom",icon:"fa-calendar-alt"}],shownTips:[],currentTipIndex:0,tipOverlay:null};function initContextTips(){const e=localStorage.getItem("shownContextTips");if(e)try{contextTips.shownTips=JSON.parse(e)}catch(e){contextTips.shownTips=[]}}function showContextTips(){initContextTips();const e=contextTips.tips.filter(e=>!contextTips.shownTips.includes(e.id));0!==e.length&&setTimeout(()=>{showTip(e[0])},1e3)}function showTip(e){const t=document.querySelector(e.target);if(!t)return markTipAsShown(e.id),void showNextTip();const n=document.createElement("div");n.className="context-tip-overlay",n.innerHTML=`\n    <div class="context-tip-backdrop" onclick="dismissCurrentTip()"></div>\n    <div class="context-tip" id="contextTip-${e.id}">\n      <div class="context-tip-arrow"></div>\n      <div class="context-tip-icon">\n        <i class="fas ${e.icon}"></i>\n      </div>\n      <div class="context-tip-content">\n        <h4>${escapeHtml(e.title)}</h4>\n        <p>${escapeHtml(e.message)}</p>\n      </div>\n      <div class="context-tip-actions">\n        <button class="context-tip-btn context-tip-btn-skip" onclick="skipAllTips()">\n          Hopp over alle\n        </button>\n        <button class="context-tip-btn context-tip-btn-next" onclick="dismissCurrentTip()">\n          Forstått <i class="fas fa-check"></i>\n        </button>\n      </div>\n      <div class="context-tip-progress">\n        ${contextTips.currentTipIndex+1} av ${contextTips.tips.length-contextTips.shownTips.length}\n      </div>\n    </div>\n  `,document.body.appendChild(n),contextTips.tipOverlay=n,positionTip(n.querySelector(".context-tip"),t,e.position),t.classList.add("context-tip-highlight"),requestAnimationFrame(()=>{n.classList.add("visible")})}function positionTip(e,t,n){const a=t.getBoundingClientRect(),s=e.getBoundingClientRect();let o,r;switch(n){case"top":o=a.top-s.height-12,r=a.left+a.width/2-s.width/2,e.classList.add("position-top");break;case"bottom":o=a.bottom+12,r=a.left+a.width/2-s.width/2,e.classList.add("position-bottom");break;case"left":o=a.top+a.height/2-s.height/2,r=a.left-s.width-12,e.classList.add("position-left");break;case"right":o=a.top+a.height/2-s.height/2,r=a.right+12,e.classList.add("position-right");break;default:o=a.bottom+12,r=a.left}r=Math.max(16,Math.min(r,window.innerWidth-s.width-16)),o=Math.max(16,Math.min(o,window.innerHeight-s.height-16)),e.style.position="fixed",e.style.top=`${o}px`,e.style.left=`${r}px`}function markTipAsShown(e){contextTips.shownTips.includes(e)||(contextTips.shownTips.push(e),localStorage.setItem("shownContextTips",JSON.stringify(contextTips.shownTips)))}function dismissCurrentTip(){const e=contextTips.tips.filter(e=>!contextTips.shownTips.includes(e.id));e.length>0&&markTipAsShown(e[0].id),document.querySelectorAll(".context-tip-highlight").forEach(e=>{e.classList.remove("context-tip-highlight")}),contextTips.tipOverlay&&(contextTips.tipOverlay.classList.remove("visible"),setTimeout(()=>{contextTips.tipOverlay.remove(),contextTips.tipOverlay=null,showNextTip()},300))}function showNextTip(){contextTips.currentTipIndex++;const e=contextTips.tips.filter(e=>!contextTips.shownTips.includes(e.id));e.length>0&&setTimeout(()=>showTip(e[0]),500)}function skipAllTips(){contextTips.tips.forEach(e=>{markTipAsShown(e.id)}),document.querySelectorAll(".context-tip-highlight").forEach(e=>{e.classList.remove("context-tip-highlight")}),contextTips.tipOverlay&&(contextTips.tipOverlay.classList.remove("visible"),setTimeout(()=>{contextTips.tipOverlay.remove(),contextTips.tipOverlay=null},300))}function resetContextTips(){contextTips.shownTips=[],contextTips.currentTipIndex=0,localStorage.removeItem("shownContextTips")}let userPreferences={defaultCategory:"all",visibleColumns:["telefon","epost","nesteKontroll","kategori","poststed"],warningDays:30,mapMode:"satellite",mapZoom:6,markerSize:"medium"};function loadUserPreferences(){const e=localStorage.getItem("userPreferences");if(e)try{userPreferences={...userPreferences,...JSON.parse(e)},Logger.log("User preferences loaded:",userPreferences)}catch(e){Logger.warn("Could not parse saved preferences")}}function saveUserPreferences(){localStorage.setItem("userPreferences",JSON.stringify(userPreferences)),Logger.log("User preferences saved:",userPreferences)}function openSettingsModal(){Logger.log("openSettingsModal() called");const e=document.getElementById("settingsModal");e?(e.classList.remove("hidden"),Logger.log("Settings modal opened"),loadSettingsData()):Logger.warn("Settings modal element not found")}function closeSettingsModal(){const e=document.getElementById("settingsModal");e&&e.classList.add("hidden")}async function loadSettingsData(){const e=document.getElementById("settingsDefaultCategory");if(e){const t=serviceTypeRegistry.getAll();let n='<option value="all">Alle kategorier</option>';t.forEach(e=>{const t=userPreferences.defaultCategory===e.slug?"selected":"";n+=`<option value="${e.slug}" ${t}>${e.name}</option>`}),e.innerHTML=n}const t=document.getElementById("settingsWarningDays");t&&(t.value=userPreferences.warningDays.toString());const n=document.getElementById("settingsMapMode");n&&(n.value=userPreferences.mapMode);const a=document.getElementById("settingsMapZoom"),s=document.getElementById("settingsMapZoomValue");a&&(a.value=userPreferences.mapZoom,s&&(s.textContent=userPreferences.mapZoom));const o=document.getElementById("settingsMarkerSize");o&&(o.value=userPreferences.markerSize);Object.entries({telefon:"colTelefon",epost:"colEpost",nesteKontroll:"colNesteKontroll",kategori:"colKategori",poststed:"colPoststed"}).forEach(([e,t])=>{const n=document.getElementById(t);n&&(n.checked=userPreferences.visibleColumns.includes(e))})}async function saveSettings(){const e=document.getElementById("saveSettingsBtn"),t=e?.textContent;e&&(e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Lagrer...',e.disabled=!0);try{const e=document.getElementById("settingsDefaultCategory");e&&(userPreferences.defaultCategory=e.value);const t=document.getElementById("settingsWarningDays");t&&(userPreferences.warningDays=parseInt(t.value,10));const n=document.getElementById("settingsMapMode");n&&(userPreferences.mapMode=n.value);const a=document.getElementById("settingsMapZoom");a&&(userPreferences.mapZoom=parseInt(a.value,10));const s=document.getElementById("settingsMarkerSize");s&&(userPreferences.markerSize=s.value),userPreferences.visibleColumns=[];const o={telefon:"colTelefon",epost:"colEpost",nesteKontroll:"colNesteKontroll",kategori:"colKategori",poststed:"colPoststed"};Object.entries(o).forEach(([e,t])=>{const n=document.getElementById(t);n?.checked&&userPreferences.visibleColumns.push(e)}),saveUserPreferences(),applyPreferences(),closeSettingsModal(),showToast("Innstillinger lagret","success")}catch(e){console.error("Error saving settings:",e),showMessage("Kunne ikke lagre innstillinger. Prøv igjen.","error")}finally{e&&(e.textContent=t,e.disabled=!1)}}function applyPreferences(){userPreferences.defaultCategory&&"all"!==userPreferences.defaultCategory&&(selectedCategory=userPreferences.defaultCategory),userPreferences.mapMode!==mapMode&&toggleNightMode();const e="small"===userPreferences.markerSize?"0.85":"large"===userPreferences.markerSize?"1.15":"1";document.documentElement.style.setProperty("--marker-scale",e),map&&userPreferences.mapZoom,updateMapLegend(),customers&&customers.length>0&&(renderCustomerAdmin(),renderMarkers(customers))}function applyIndustryChanges(){Logger.log("Applying industry changes..."),renderLoginFeatures();const e=document.getElementById("kategoriTabs");if(e&&(e.innerHTML=serviceTypeRegistry.renderCategoryTabs(selectedCategory),attachKategoriTabHandlers()),renderFilterPanelCategories(),renderDriftskategoriFilter(),updateServiceTypeDropdowns(),updateMapLegend(),applyIndustryColors(),customers&&customers.length>0){renderMarkers(customers),renderCustomerAdmin();const e=customers.filter(e=>e.kategori&&!serviceTypeRegistry.isKnownCategory(e.kategori)).length;e>0&&showUnknownCategoryNotification(e)}applyBranding(),Logger.log("Industry changes applied")}function showUnknownCategoryNotification(e){const t=document.getElementById("unknownCategoryNotification");t&&t.remove();const n=document.createElement("div");n.id="unknownCategoryNotification",n.className="unknown-category-notification",n.innerHTML=`\n    <div class="notification-content">\n      <i class="fas fa-exclamation-triangle"></i>\n      <span><strong>${e}</strong> kunde${e>1?"r":""} har kategorier fra tidligere bransje og m&aring; oppdateres.</span>\n      <button class="btn-close-notification" onclick="this.parentElement.parentElement.remove()">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `;const a=document.querySelector(".content")||document.querySelector("main")||document.body;a.insertBefore(n,a.firstChild),setTimeout(()=>{n.parentElement&&(n.classList.add("fade-out"),setTimeout(()=>n.remove(),300))},1e4)}function attachKategoriTabHandlers(){const e=document.querySelectorAll("#kategoriTabs .category-tab");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),selectedCategory=t.dataset.category||"all",applyFilters()})})}function updateServiceTypeDropdowns(){const e=document.getElementById("kategori");if(e){const t=e.value,n=serviceTypeRegistry.getAll();let a="";if(n.forEach(e=>{a+=`<option value="${e.name}">${e.name}</option>`}),n.length>=2){const e=n.map(e=>e.name).join(" + ");a+=`<option value="${e}">Begge (${e})</option>`}e.innerHTML=a,t&&(e.value=t)}}function applyIndustryColors(){const e=serviceTypeRegistry.getAll(),t=document.documentElement;if(e.forEach(e=>{t.style.setProperty(`--service-color-${e.slug}`,e.color)}),e.length>=2){const n=`linear-gradient(135deg, ${e[0].color} 50%, ${e[1].color} 50%)`;t.style.setProperty("--service-color-combined",n)}injectDynamicMarkerStyles()}function darkenColor(e,t){e=e.replace("#","");let n=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),s=parseInt(e.substring(4,6),16);return n=Math.max(0,Math.floor(n*(1-t/100))),a=Math.max(0,Math.floor(a*(1-t/100))),s=Math.max(0,Math.floor(s*(1-t/100))),`#${n.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}function injectDynamicMarkerStyles(){const e=document.getElementById("dynamic-marker-styles");e&&e.remove();const t=serviceTypeRegistry.getAll();if(0===t.length)return;const n=document.createElement("style");n.id="dynamic-marker-styles";let a="";if(t.forEach(e=>{const t=industryPalettes[e.slug]||{light:e.color,primary:e.color,dark:darkenColor(e.color,20)};a+=`\n      /* Premium marker style for ${e.name} */\n      .custom-marker-with-label .marker-icon.${e.slug} {\n        background: linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%);\n        box-shadow:\n          0 2px 8px rgba(0, 0, 0, 0.4),\n          0 0 0 1px rgba(0, 0, 0, 0.1),\n          inset 0 1px 0 rgba(255, 255, 255, 0.25);\n      }\n\n      .custom-marker-with-label .marker-icon.${e.slug}[data-status="forfalt"] {\n        background: linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%) !important;\n      }\n\n      .custom-marker-with-label .marker-icon.${e.slug}[data-status="snart"] {\n        background: linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%) !important;\n      }\n    `}),t.length>=2){const e=industryPalettes[t[0].slug]||{primary:t[0].color},n=industryPalettes[t[1].slug]||{primary:t[1].color},s=e.primary,o=n.primary;a+=`\n      /* Premium combined marker style */\n      .custom-marker-with-label .marker-icon.combined {\n        width: 48px;\n        height: 48px;\n        min-width: 48px;\n        min-height: 48px;\n        background: linear-gradient(135deg, ${s} 0%, ${s} 48%, ${o} 52%, ${o} 100%);\n        font-size: 15px;\n        box-shadow:\n          0 2px 8px rgba(0, 0, 0, 0.4),\n          0 0 0 1px rgba(0, 0, 0, 0.1),\n          inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      }\n\n      .custom-marker-with-label .marker-icon.combined[data-status="forfalt"] {\n        background: linear-gradient(135deg, ${s} 0%, ${s} 48%, ${o} 52%, ${o} 100%) !important;\n      }\n\n      .custom-marker-with-label .marker-icon.combined[data-status="snart"] {\n        background: linear-gradient(135deg, ${s} 0%, ${s} 48%, ${o} 52%, ${o} 100%) !important;\n      }\n    `}n.textContent=a,document.head.appendChild(n),Logger.log("Premium marker styles injected for",t.length,"service types")}function updateMapLegend(){const e=document.getElementById("legendItems");if(!e)return;const t=serviceTypeRegistry.getAll();if(0!==t.length){if(e.innerHTML=t.map(e=>{const t=industryPalettes[e.slug]||{light:e.color,primary:e.color,dark:e.color};return`\n      <div class="legend-item">\n        <span class="legend-color" style="background: ${`linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%)`}"></span>\n        <span>${e.name}</span>\n      </div>\n    `}).join(""),t.length>=2){const n=industryPalettes[t[0].slug]||{primary:t[0].color},a=industryPalettes[t[1].slug]||{primary:t[1].color},s=`linear-gradient(135deg, ${n.primary} 48%, ${a.primary} 52%)`,o=t.map(e=>escapeHtml(e.name)).join(" + ");e.innerHTML+=`\n      <div class="legend-item">\n        <span class="legend-color" style="background: ${s}"></span>\n        <span>${o}</span>\n      </div>\n    `}}else e.innerHTML='<div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #FBBF24, #D97706)"></span> Kunde</div>'}function toggleMapLegend(){const e=document.getElementById("mapLegend");e&&e.classList.toggle("expanded")}function showToast(e,t="info"){const n=document.querySelector(".toast-notification");n&&n.remove();const a=document.createElement("div");a.className=`toast-notification toast-${t}`,a.innerHTML=`\n    <i class="fas ${"success"===t?"fa-check-circle":"error"===t?"fa-exclamation-circle":"fa-info-circle"}"></i>\n    <span>${escapeHtml(e)}</span>\n  `,document.body.appendChild(a),requestAnimationFrame(()=>{a.classList.add("visible")}),setTimeout(()=>{a.classList.remove("visible"),setTimeout(()=>a.remove(),300)},3e3)}function initSettingsEventListeners(){document.addEventListener("click",e=>{if(e.target.closest("#settingsBtn"))return e.preventDefault(),e.stopPropagation(),void openSettingsModal();if(e.target.closest("#closeSettingsModal")||e.target.closest("#cancelSettingsBtn"))return void closeSettingsModal();if(e.target.closest("#saveSettingsBtn"))return void saveSettings();const t=document.getElementById("settingsModal");e.target!==t||closeSettingsModal()}),document.querySelectorAll(".settings-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.settingsTab;document.querySelectorAll(".settings-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".settings-pane").forEach(e=>e.classList.remove("active"));const n=document.getElementById("settings-"+t);n&&n.classList.add("active")})});const e=document.getElementById("settingsMapZoom"),t=document.getElementById("settingsMapZoomValue");e&&t&&e.addEventListener("input",()=>{t.textContent=e.value}),initExcelImport();const n=document.getElementById("legendToggle");n&&n.addEventListener("click",toggleMapLegend)}function initExcelImport(){const e={sessionId:null,previewData:null,columnMapping:{},categoryMapping:{},currentPage:0,rowsPerPage:50,validCategories:[]},t=document.getElementById("importDropzone"),n=document.getElementById("importFileInput"),a={step1:document.getElementById("importStep1"),step2:document.getElementById("importStep2"),step3:document.getElementById("importStep3"),step4:document.getElementById("importStep4")};function s(e){Object.values(a).forEach(e=>{e&&e.classList.add("hidden")});const t=a[`step${e}`];t&&t.classList.remove("hidden"),document.querySelectorAll(".step-item").forEach(t=>{const n=parseInt(t.dataset.step);t.classList.remove("active","completed"),n<e&&t.classList.add("completed"),n===e&&t.classList.add("active")})}async function o(n){const a=n.name.toLowerCase().slice(n.name.lastIndexOf("."));if([".xlsx",".xls",".csv"].includes(a)){t.innerHTML=`\n      <i class="fas fa-spinner fa-spin"></i>\n      <p>Analyserer fil...</p>\n      <span class="import-formats">${n.name}</span>\n    `;try{const t=new FormData;t.append("file",n);const a=await apiFetch("/api/kunder/import-excel/preview",{method:"POST",body:t}),o=await a.json();if(!a.ok)throw new Error(o.error||"Kunne ikke analysere filen");e.sessionId=o.sessionId,e.previewData=o,e.validCategories=o.validCategories||[],e.columnMapping={},o.columns.detected.forEach(t=>{t.suggestedMapping&&(e.columnMapping[t.excelHeader]=t.suggestedMapping)}),function(t){const n=document.getElementById("columnMappingContainer");if(!n)return;const a=[{value:"",label:"-- Ignorer --"},{value:"navn",label:"Navn *",required:!0},{value:"adresse",label:"Adresse *",required:!0},{value:"postnummer",label:"Postnummer"},{value:"poststed",label:"Poststed"},{value:"telefon",label:"Telefon"},{value:"epost",label:"E-post"},{value:"kategori",label:"Kategori"},{value:"el_type",label:"El-type"},{value:"brann_system",label:"Brannsystem"},{value:"brann_driftstype",label:"Driftstype"},{value:"notater",label:"Notater"},{value:"lat",label:"Breddegrad"},{value:"lng",label:"Lengdegrad"}];n.innerHTML=t.columns.detected.map(e=>`\n      <div class="mapping-row">\n        <div class="mapping-excel">\n          <strong>${u(e.excelHeader)}</strong>\n          <span class="sample-values">${e.sampleValues.map(e=>u(e)).join(", ")||"Ingen verdier"}</span>\n        </div>\n        <i class="fas fa-arrow-right mapping-arrow"></i>\n        <div class="mapping-db">\n          <select class="column-select" data-excel="${u(e.excelHeader)}">\n            ${a.map(t=>`\n              <option value="${t.value}" ${e.suggestedMapping===t.value?"selected":""}>\n                ${t.label}\n              </option>\n            `).join("")}\n          </select>\n          ${e.confidence<1&&e.suggestedMapping?`<span class="confidence-badge">${Math.round(100*e.confidence)}%</span>`:""}\n        </div>\n      </div>\n    `).join(""),n.querySelectorAll(".column-select").forEach(t=>{t.addEventListener("change",t=>{const n=t.target.dataset.excel;e.columnMapping[n]=t.target.value})})}(o),s(2)}catch(e){showNotification(e.message,"error"),r()}}else showNotification("Ugyldig filtype. Kun Excel (.xlsx, .xls) og CSV (.csv) er tillatt.","error")}function r(){t.innerHTML='\n      <i class="fas fa-cloud-upload-alt"></i>\n      <p>Dra og slipp fil her, eller klikk for å velge</p>\n      <span class="import-formats">Støttede formater: .xlsx, .xls, .csv (maks 10MB)</span>\n    ',n.value=""}function i(){e.sessionId=null,e.previewData=null,e.columnMapping={},e.categoryMapping={},e.currentPage=0,r(),s(1)}function l(t){const n=t.analysis;document.getElementById("newCount").textContent=n.toCreate||0,document.getElementById("updateCount").textContent=n.toUpdate||0,document.getElementById("warningCount").textContent=n.warningRows||0,document.getElementById("errorCount").textContent=n.errorRows||0;const a=(n.toCreate||0)+(n.toUpdate||0);document.getElementById("importCountLabel").textContent=a,function(t){const n=document.getElementById("categoryMappingSection"),a=document.getElementById("categoryMappingList");if(!t||0===t.unknown.length)return void n.classList.add("hidden");n.classList.remove("hidden"),a.innerHTML=t.unknown.map(t=>`\n      <div class="category-mapping-row">\n        <span class="original-value">"${u(t.value)}"</span>\n        <span class="occurrence-count">(${t.count} forekomster)</span>\n        <select class="category-select" data-original="${u(t.value)}">\n          <option value="">-- Velg kategori --</option>\n          ${e.validCategories.map(e=>`\n            <option value="${e}">${e}</option>\n          `).join("")}\n        </select>\n      </div>\n    `).join(""),a.querySelectorAll(".category-select").forEach(t=>{t.addEventListener("change",t=>{const n=t.target.dataset.original;e.categoryMapping[n]=t.target.value})})}(t.categoryAnalysis),function(t){const n=document.getElementById("dynamicSchemaSection"),a=document.getElementById("newCategoriesSection"),s=document.getElementById("newFieldsSection"),o=document.getElementById("newFieldValuesSection");if(!n||!t)return void(n&&n.classList.add("hidden"));const r=t.newCategories&&t.newCategories.length>0,i=t.newFields&&t.newFields.length>0,l=t.newFieldValues&&Object.keys(t.newFieldValues).length>0;if(!r&&!i&&!l)return void n.classList.add("hidden");if(n.classList.remove("hidden"),e.dynamicSchema={selectedCategories:{},selectedFields:{},selectedFieldValues:{}},r){a.classList.remove("hidden");const n=document.getElementById("newCategoriesList");n.innerHTML=t.newCategories.map((e,t)=>`\n        <div class="schema-item">\n          <input type="checkbox" class="schema-item-checkbox" id="newCat_${t}" data-category="${u(e.name)}" checked>\n          <div class="schema-item-color" style="background-color: ${e.color}"></div>\n          <div class="schema-item-icon">\n            <i class="fas ${e.icon}"></i>\n          </div>\n          <div class="schema-item-info">\n            <label for="newCat_${t}" class="schema-item-name">${u(e.name)}</label>\n            <div class="schema-item-meta">Intervall: ${e.default_interval_months||12} mnd</div>\n          </div>\n        </div>\n      `).join(""),n.querySelectorAll(".schema-item-checkbox").forEach(t=>{const n=t.dataset.category;e.dynamicSchema.selectedCategories[n]=t.checked,t.addEventListener("change",t=>{e.dynamicSchema.selectedCategories[n]=t.target.checked})})}else a.classList.add("hidden");if(i){s.classList.remove("hidden");const n=document.getElementById("newFieldsList");n.innerHTML=t.newFields.map((e,t)=>`\n        <div class="schema-item">\n          <input type="checkbox" class="schema-item-checkbox" id="newField_${t}" data-field="${u(e.field_name)}" checked>\n          <div class="schema-item-info">\n            <label for="newField_${t}" class="schema-item-name">${u(e.display_name)}</label>\n            <div class="schema-item-meta">\n              <span class="schema-field-type">${e.field_type}</span>\n              ${e.is_filterable?'<span class="schema-field-type" style="background: #10B981;">Filtrerbart</span>':""}\n            </div>\n            ${e.options&&e.options.length>0?`\n              <div class="schema-item-preview">\n                ${e.options.slice(0,5).map(e=>`\n                  <span class="schema-item-preview-tag">${u(e.value||e)}</span>\n                `).join("")}\n                ${e.options.length>5?`<span class="schema-item-preview-tag">+${e.options.length-5} mer</span>`:""}\n              </div>\n            `:""}\n          </div>\n        </div>\n      `).join(""),n.querySelectorAll(".schema-item-checkbox").forEach(t=>{const n=t.dataset.field;e.dynamicSchema.selectedFields[n]=t.checked,t.addEventListener("change",t=>{e.dynamicSchema.selectedFields[n]=t.target.checked})})}else s.classList.add("hidden");if(l){o.classList.remove("hidden");const n=document.getElementById("newFieldValuesList"),a=Object.entries(t.newFieldValues);n.innerHTML=a.map(([e,t],n)=>`\n        <div class="schema-item">\n          <input type="checkbox" class="schema-item-checkbox" id="newValues_${n}" data-field="${u(e)}" checked>\n          <div class="schema-item-info">\n            <label for="newValues_${n}" class="schema-item-name">${u(e)}</label>\n            <div class="schema-item-preview">\n              ${t.slice(0,5).map(e=>`\n                <span class="schema-item-preview-tag">${u(e)}</span>\n              `).join("")}\n              ${t.length>5?`<span class="schema-item-preview-tag">+${t.length-5} mer</span>`:""}\n            </div>\n          </div>\n        </div>\n      `).join(""),n.querySelectorAll(".schema-item-checkbox").forEach(t=>{const n=t.dataset.field;e.dynamicSchema.selectedFieldValues[n]=t.checked,t.addEventListener("change",t=>{e.dynamicSchema.selectedFieldValues[n]=t.target.checked})})}else o.classList.add("hidden")}(t.dynamicSchema),d(t.previewData)}function d(t){const n=document.getElementById("previewTableHead"),a=document.getElementById("previewTableBody");if(!t||0===t.length)return n.innerHTML="",void(a.innerHTML='<tr><td colspan="5">Ingen data</td></tr>');n.innerHTML="\n      <tr>\n        <th>Rad</th>\n        <th>Status</th>\n        <th>Navn</th>\n        <th>Adresse</th>\n        <th>Info</th>\n      </tr>\n    ";const s=e.currentPage*e.rowsPerPage,o=t.slice(s,s+e.rowsPerPage);a.innerHTML=o.map(e=>{const t={valid:"status-new",warning:"status-warning",error:"status-error",duplicate:"status-update"}[e.status]||"",n={valid:'<i class="fas fa-plus-circle"></i>',warning:'<i class="fas fa-exclamation-triangle"></i>',error:'<i class="fas fa-times-circle"></i>',duplicate:'<i class="fas fa-sync-alt"></i>'}[e.status]||"",a={valid:"Ny",warning:"Advarsel",error:"Feil",duplicate:"Oppdateres"}[e.status]||e.status;return`\n        <tr class="${t}">\n          <td>${e.rowNumber}</td>\n          <td><span class="status-badge ${t}">${n} ${a}</span></td>\n          <td>${u(e.normalizedData?.navn||"-")}</td>\n          <td>${u(e.normalizedData?.adresse||"-")}</td>\n          <td class="info-cell">\n            ${e.issues.length>0?`<span class="issues-tooltip" title="${e.issues.map(e=>u(e)).join("\n")}">\n                <i class="fas fa-info-circle"></i> ${e.issues.length} melding${e.issues.length>1?"er":""}\n              </span>`:"-"}\n          </td>\n        </tr>\n      `}).join(""),function(t){const n=Math.ceil(t/e.rowsPerPage),a=e.currentPage+1;document.getElementById("pageInfo").textContent=`Side ${a} av ${n}`,document.getElementById("prevPageBtn").disabled=0===e.currentPage,document.getElementById("nextPageBtn").disabled=a>=n}(t.length)}function c(e,t){const n=document.getElementById("resultIcon"),a=document.getElementById("importResultTitle");if(e){n.innerHTML='<i class="fas fa-check-circle"></i>',n.className="result-icon success",a.textContent="Import fullført!",document.getElementById("resultCreated").textContent=t.created||0,document.getElementById("resultUpdated").textContent=t.updated||0,document.getElementById("resultSkipped").textContent=t.skipped||0;const e=document.getElementById("resultErrors"),s=document.getElementById("errorList");t.errors&&t.errors.length>0?(e.classList.remove("hidden"),s.innerHTML=t.errors.slice(0,10).map(e=>`<li>Rad ${e.row}: ${u(e.navn||"")} - ${u(e.error)}</li>`).join(""),t.errors.length>10&&(s.innerHTML+=`<li>... og ${t.errors.length-10} flere</li>`)):e.classList.add("hidden");const o=document.getElementById("resultNote");t.geocodingNote?(o.textContent=t.geocodingNote,o.classList.remove("hidden")):o.classList.add("hidden")}else{n.innerHTML='<i class="fas fa-times-circle"></i>',n.className="result-icon error",a.textContent="Import feilet",document.getElementById("resultCreated").textContent="0",document.getElementById("resultUpdated").textContent="0",document.getElementById("resultSkipped").textContent="0";const e=document.getElementById("resultNote");e.textContent=t.error||"En ukjent feil oppstod.",e.classList.remove("hidden")}}function u(e){if(!e)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}t&&n&&(t.addEventListener("click",()=>n.click()),t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",()=>{t.classList.remove("dragover")}),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("dragover"),e.dataTransfer.files.length>0&&o(e.dataTransfer.files[0])}),n.addEventListener("change",()=>{n.files.length>0&&o(n.files[0])}),document.getElementById("prevPageBtn")?.addEventListener("click",()=>{e.currentPage>0&&(e.currentPage--,d(e.previewData.previewData))}),document.getElementById("nextPageBtn")?.addEventListener("click",()=>{const t=Math.ceil(e.previewData.previewData.length/e.rowsPerPage);e.currentPage<t-1&&(e.currentPage++,d(e.previewData.previewData))}),document.getElementById("backToStep1Btn")?.addEventListener("click",i),document.getElementById("proceedToStep3Btn")?.addEventListener("click",()=>{const t=Object.values(e.columnMapping).includes("navn"),n=Object.values(e.columnMapping).includes("adresse");t&&n?(l(e.previewData),s(3)):showNotification('Du må mappe minst "Navn" og "Adresse" kolonnene.',"error")}),document.getElementById("backToStep2Btn")?.addEventListener("click",()=>{s(2)}),document.getElementById("startImportBtn")?.addEventListener("click",async()=>{const t=document.getElementById("startImportBtn");t.disabled=!0,s(4),document.getElementById("importProgress").classList.remove("hidden"),document.getElementById("importResult").classList.add("hidden");const n=document.getElementById("importProgressFill"),a=document.getElementById("importProgressText");n.style.width="5%",a.textContent="Oppretter nye kategorier og felt...";try{if(e.dynamicSchema){const t=e.previewData?.dynamicSchema,s=t?.newCategories?.filter(t=>e.dynamicSchema.selectedCategories[t.name])||[];if(s.length>0){a.textContent=`Oppretter ${s.length} nye kategorier...`;try{await apiFetch("/api/fields/categories/bulk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({categories:s})})}catch(e){console.warn("Could not create categories:",e)}}n.style.width="10%";const o=t?.newFields?.filter(t=>e.dynamicSchema.selectedFields[t.field_name])||[];if(o.length>0){a.textContent=`Oppretter ${o.length} nye felt...`;try{await apiFetch("/api/fields/bulk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fields:o})})}catch(e){console.warn("Could not create fields:",e)}}n.style.width="15%"}n.style.width="20%",a.textContent="Starter kundeimport...";const t=await apiFetch("/api/kunder/import-excel/execute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e.sessionId,categoryMapping:e.categoryMapping,geocodeAfterImport:document.getElementById("geocodeAfterImport")?.checked||!1})});n.style.width="90%",a.textContent="Fullfører...";const s=await t.json();n.style.width="100%",setTimeout(()=>{document.getElementById("importProgress").classList.add("hidden"),document.getElementById("importResult").classList.remove("hidden"),c(t.ok&&s.success,s),t.ok&&s.success&&loadCustomers()},500)}catch(e){document.getElementById("importProgress").classList.add("hidden"),document.getElementById("importResult").classList.remove("hidden"),c(!1,{error:e.message})}t.disabled=!1}),document.getElementById("closeImportResultBtn")?.addEventListener("click",i))}function transitionToAppView(){const e=document.getElementById("loginOverlay"),t=document.getElementById("appView"),n=document.getElementById("sidebar"),a=document.getElementById("filterPanel"),s=document.querySelector(".login-side"),o=document.querySelector(".login-brand-content"),r=document.querySelector(".login-map-overlay");showUserBar(),setupTokenRefresh(),t.classList.remove("hidden"),n&&(n.style.transform="translateX(-100%)",n.style.opacity="0"),a&&(a.style.transform="translateX(100%)",a.style.opacity="0");const i=document.getElementById("contentPanel");"true"===localStorage.getItem("contentPanelOpen")&&i&&(i.style.transform="translateX(-100%)",i.style.opacity="0",i.classList.remove("closed"),i.classList.add("open")),currentView="app",appInitialized?loadCustomers():(initializeApp(),appInitialized=!0),s&&(s.style.transition="transform 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease-out",s.style.transform="translateX(-100%)",s.style.opacity="0"),setTimeout(()=>{o&&(o.style.transition="opacity 0.5s ease-out, transform 0.5s ease-out",o.style.opacity="0",o.style.transform="translateY(-30px)"),r&&(r.style.transition="opacity 0.6s ease-out",r.style.opacity="0")},200),setTimeout(()=>{map&&map.flyTo([67.5,15],6,{duration:1.8,easeLinearity:.1})},400),setTimeout(()=>{e.classList.add("hidden")},900),setTimeout(()=>{map&&(map.dragging.enable(),map.scrollWheelZoom.enable(),map.doubleClickZoom.enable(),map.touchZoom.enable(),map.keyboard.enable(),map._zoomControl||(map._zoomControl=L.control.zoom({position:"topright"}).addTo(map)))},1e3),setTimeout(()=>{n&&(n.style.transition="transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease-out",n.style.transform="translateX(0)",n.style.opacity="1");const e=document.querySelector(".tab-navigation");e&&(e.style.transition="opacity 0.4s ease-out",e.style.opacity="1",e.style.pointerEvents="auto");const t=document.getElementById("sidebarToggle");t&&(t.style.transition="opacity 0.4s ease-out",t.style.opacity="1",t.style.pointerEvents="auto")},1100),setTimeout(()=>{a&&(a.style.transition="transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease-out",a.style.transform="translateX(0)",a.style.opacity="1");const e=document.getElementById("contentPanel");"true"===localStorage.getItem("contentPanelOpen")&&e&&(e.style.transition="transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease-out",e.style.transform="translateX(0)",e.style.opacity="1")},1250),setTimeout(()=>{n&&(n.style.transition="",n.style.transform="",n.style.opacity=""),a&&(a.style.transition="",a.style.transform="",a.style.opacity="");const e=document.getElementById("contentPanel");e&&(e.style.transition="",e.style.transform="",e.style.opacity=""),s&&(s.style.transition="",s.style.transform="",s.style.opacity=""),o&&(o.style.transition="",o.style.opacity="",o.style.transform=""),r&&(r.style.transition="",r.style.opacity="")},2e3)}function showLoginView(){const e=document.getElementById("loginOverlay"),t=document.getElementById("appView"),n=document.getElementById("sidebar"),a=document.getElementById("filterPanel"),s=document.querySelector(".login-side"),o=document.querySelector(".login-brand-content"),r=document.querySelector(".login-map-overlay");hideUserBar();const i=document.getElementById("spaLoginForm");i&&i.reset(),resetLoginButton();const l=document.getElementById("loginErrorMessage");l&&l.classList.remove("show"),s&&(s.style.transition="none",s.style.transform="translateX(-30px)",s.style.opacity="0"),o&&(o.style.transition="none",o.style.transform="scale(0.9)",o.style.opacity="0"),r&&(r.style.transition="none",r.style.opacity="0");const d=window.innerWidth<=768;n&&(n.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-out",n.style.transform=d?"translateY(100%)":"translateX(-100%)",n.style.opacity="0",n.classList.remove("mobile-open")),a&&(a.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-out",a.style.transform=d?"translateY(100%)":"translateX(100%)",a.style.opacity="0");const c=document.getElementById("contentPanel");c&&!c.classList.contains("closed")&&(c.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-out",c.style.transform="translateX(-100%)",c.style.opacity="0");const u=document.querySelector(".bulk-action-bar");u&&u.classList.remove("visible");const m=document.getElementById("mobileRouteBtn");m&&m.classList.add("hidden");const p=document.querySelector(".tab-navigation");p&&(p.style.transition="opacity 0.3s ease-out",p.style.opacity="0",p.style.pointerEvents="none");const g=document.getElementById("sidebarToggle");if(g&&(g.style.transition="opacity 0.3s ease-out",g.style.opacity="0",g.style.pointerEvents="none"),markerClusterGroup){const e=document.querySelector(".leaflet-marker-pane");e&&(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0"),setTimeout(()=>{markerClusterGroup.clearLayers(),e&&(e.style.transition="",e.style.opacity="")},500)}routeLayer&&(map.removeLayer(routeLayer),routeLayer=null),setTimeout(()=>{e.classList.remove("hidden"),setTimeout(()=>{r&&(r.style.transition="opacity 0.8s ease-out",r.style.opacity="1"),s&&(s.style.transition="transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.5s ease-out",s.style.transform="translateX(0)",s.style.opacity="1"),setTimeout(()=>{o&&(o.style.transition="transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-out",o.style.transform="scale(1)",o.style.opacity="1")},150)},50)},300),map&&(map.dragging.disable(),map.scrollWheelZoom.disable(),map.doubleClickZoom.disable(),map.touchZoom.disable(),map.keyboard.disable(),map._zoomControl&&(map.removeControl(map._zoomControl),map._zoomControl=null),map.flyTo([69.06888,17.65274],11,{duration:1.8,easeLinearity:.15})),setTimeout(()=>{t.classList.add("hidden"),n&&(n.style.transition="",n.style.transform="",n.style.opacity=""),a&&(a.style.transition="",a.style.transform="",a.style.opacity="");const e=document.getElementById("contentPanel");e&&(e.style.transition="",e.style.transform="",e.style.opacity="",e.classList.add("closed"),e.classList.remove("open")),s&&(s.style.transition=""),o&&(o.style.transition=""),r&&(r.style.transition="")},1e3),currentView="login"}function handleLogout(){stopTokenRefresh();const e=localStorage.getItem("refreshToken");e&&fetch("/api/klient/logout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})}).catch(()=>{}),authToken=null,isSuperAdmin=!1,localStorage.removeItem("authToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("accessTokenExpiresAt"),localStorage.removeItem("refreshTokenExpiresAt"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),localStorage.removeItem("userType"),localStorage.removeItem("isSuperAdmin"),localStorage.removeItem("organizationId"),localStorage.removeItem("organizationSlug"),localStorage.removeItem("organizationName"),localStorage.removeItem("isImpersonating"),localStorage.removeItem("impersonatingOrgId"),localStorage.removeItem("impersonatingOrgName"),showLoginView()}async function stopImpersonation(){try{const e=await fetch("/api/super-admin/stop-impersonation",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`}}),t=await e.json();t.success?(localStorage.removeItem("isImpersonating"),localStorage.removeItem("impersonatingOrgId"),localStorage.removeItem("impersonatingOrgName"),t.data.token&&localStorage.setItem("authToken",t.data.token),window.location.href="/admin"):(console.error("Failed to stop impersonation:",t.error),alert("Kunne ikke avslutte impersonering"))}catch(e){console.error("Error stopping impersonation:",e),alert("Kunne ikke avslutte impersonering")}}async function checkExistingAuth(){try{const e={};authToken&&(e.Authorization=`Bearer ${authToken}`);const t=await fetch("/api/klient/verify",{headers:e,credentials:"include"});if(t.ok){const e=await t.json();if(e.success&&e.data&&e.data.valid){const{token:t,user:n,organization:a}=e.data;return t&&(authToken=t,localStorage.setItem("authToken",t)),n&&(localStorage.setItem("userName",n.navn||"Bruker"),localStorage.setItem("userType",n.type||"klient"),localStorage.setItem("userRole","bruker"===n.type?"admin":"klient"),n.isSuperAdmin?localStorage.setItem("isSuperAdmin","true"):localStorage.removeItem("isSuperAdmin")),a&&(localStorage.setItem("organizationId",a.id),localStorage.setItem("organizationSlug",a.slug),appConfig.companyName=a.navn,appConfig.logoUrl=a.logoUrl,appConfig.primaryColor=a.primaryColor,appConfig.brandTitle=a.brandTitle||a.navn,await reloadConfigWithAuth()),Logger.log("SSO session verified successfully"),!0}}}catch(e){Logger.warn("SSO verification failed:",e)}if(authToken)try{const e=await fetch("/api/klient/dashboard",{headers:{Authorization:`Bearer ${authToken}`}});if(e.ok){const t=await e.json();return t.klient&&(localStorage.setItem("userName",t.klient.navn||"Bruker"),localStorage.setItem("userRole",t.klient.rolle||"klient"),localStorage.setItem("userType",t.klient.type||"klient")),!0}}catch(e){}return authToken=null,localStorage.removeItem("authToken"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),localStorage.removeItem("userType"),!1}let isRefreshingToken=!1,refreshPromise=null;function isAccessTokenExpiringSoon(){const e=localStorage.getItem("accessTokenExpiresAt");if(!e)return!1;const t=parseInt(e,10);return Date.now()>t-12e4}async function refreshAccessToken(){if(isRefreshingToken&&refreshPromise)return refreshPromise;const e=localStorage.getItem("refreshToken");return!!e&&(isRefreshingToken=!0,refreshPromise=(async()=>{try{const t=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(t.ok){const e=await t.json();return authToken=e.accessToken||e.token,localStorage.setItem("authToken",authToken),e.refreshToken&&localStorage.setItem("refreshToken",e.refreshToken),e.accessTokenExpiresAt&&localStorage.setItem("accessTokenExpiresAt",e.accessTokenExpiresAt),e.refreshTokenExpiresAt&&localStorage.setItem("refreshTokenExpiresAt",e.refreshTokenExpiresAt),Logger.log("Access token refreshed successfully"),!0}return Logger.warn("Token refresh failed:",t.status),!1}catch(e){return console.error("Token refresh error:",e),!1}finally{isRefreshingToken=!1,refreshPromise=null}})(),refreshPromise)}let tokenRefreshInterval=null;function setupTokenRefresh(){tokenRefreshInterval&&clearInterval(tokenRefreshInterval),tokenRefreshInterval=setInterval(async()=>{const e=localStorage.getItem("accessTokenExpiresAt");if(!e)return;const t=parseInt(e,10),n=Date.now();if(t-n<3e5&&t>n){Logger.log("Proactive token refresh triggered");await refreshAccessToken()?(await reloadConfigWithAuth(),Logger.log("Config reloaded after token refresh")):Logger.warn("Proactive token refresh failed")}},6e4),Logger.log("Token refresh interval started")}function stopTokenRefresh(){tokenRefreshInterval&&(clearInterval(tokenRefreshInterval),tokenRefreshInterval=null,Logger.log("Token refresh interval stopped"))}async function apiFetch(e,t={}){if(authToken&&isAccessTokenExpiringSoon()){if(!await refreshAccessToken())throw handleLogout(),new Error("Sesjon utløpt")}const n={"Content-Type":"application/json",...t.headers};authToken&&(n.Authorization=`Bearer ${authToken}`);const a=await fetch(e,{...t,headers:n});if(401===a.status){const n=await a.json().catch(()=>({}));if(authToken&&!t._retried){if(await refreshAccessToken())return apiFetch(e,{...t,_retried:!0})}if(n.requireLogin||"Sesjonen har utløpt"===n.error)throw handleLogout(),new Error("Ikke innlogget")}if(403===a.status){const e=await a.clone().json().catch(()=>({}));if("SUBSCRIPTION_INACTIVE"===e.code)throw showSubscriptionError(e),new Error(e.error||"Abonnementet er ikke aktivt")}const s=a.headers.get("X-Subscription-Warning");return s&&showSubscriptionWarningBanner(s),a}function showSubscriptionWarningBanner(e){if(window._subscriptionWarningShown)return;window._subscriptionWarningShown=!0;const t=document.getElementById("subscriptionWarningBanner");t&&t.remove();const n=document.createElement("div");n.id="subscriptionWarningBanner",n.style.cssText="position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:14px;",n.innerHTML=`\n    <div style="display:flex;align-items:center;gap:10px;">\n      <i class="fas fa-exclamation-circle"></i>\n      <span>${escapeHtml(e)}</span>\n    </div>\n    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;cursor:pointer;font-size:18px;padding:0 5px;">&times;</button>\n  `,document.body.prepend(n)}let subscriptionTimerInterval=null;function decodeJWT(e){try{const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(n)}catch(e){return null}}function initSubscriptionTimer(){const e=localStorage.getItem("authToken");if(!e)return;const t=decodeJWT(e);if(!t)return;const{subscriptionStatus:n,trialEndsAt:a,currentPeriodEnd:s}=t;if("trialing"!==n&&"active"!==n)return;let o=null,r="";if("trialing"===n&&a)o=new Date(a),r="Prøveperiode";else if("active"===n&&s){const e=new Date(s);Math.floor((e-new Date)/864e5)<=7&&(o=e,r="Fornyes om")}o?(updateSubscriptionTimer(o,r),subscriptionTimerInterval&&clearInterval(subscriptionTimerInterval),subscriptionTimerInterval=setInterval(()=>{updateSubscriptionTimer(o,r)},6e4)):hideSubscriptionTimer()}function updateSubscriptionTimer(e,t){const n=document.getElementById("subscriptionTimer"),a=document.getElementById("subscriptionTimerText");if(!n||!a)return;const s=e-new Date;if(s<=0)return a.textContent="Utløpt",n.classList.add("warning"),void(n.style.display="flex");const o=Math.floor(s/864e5),r=Math.floor(s%864e5/36e5),i=Math.floor(s%36e5/6e4);let l="";l=o>0?`${o}d ${r}t`:r>0?`${r}t ${i}m`:`${i}m`,a.textContent=`${t}: ${l}`,o<3?n.classList.add("warning"):n.classList.remove("warning"),n.style.display="flex"}function hideSubscriptionTimer(){const e=document.getElementById("subscriptionTimer");e&&(e.style.display="none"),subscriptionTimerInterval&&(clearInterval(subscriptionTimerInterval),subscriptionTimerInterval=null)}function showSubscriptionError(e){const t=e.error||"Abonnementet er ikke aktivt",n=e.details||{},a=document.getElementById("subscriptionErrorModal");a&&a.remove();const s=document.createElement("div");s.id="subscriptionErrorModal",s.className="modal-overlay",s.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;";const o={trial_expired:"Prøveperioden din har utløpt",canceled:"Abonnementet er kansellert",past_due:"Betalingen har feilet",incomplete:"Abonnementet er ikke fullført",grace_period_exceeded:"Betalingsfristen er utløpt"}[n.reason]||"Abonnement kreves";s.innerHTML=`\n    <div style="background:var(--card-bg, #1a1a2e);border-radius:12px;padding:32px;max-width:450px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);">\n      <div style="width:64px;height:64px;margin:0 auto 20px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:50%;display:flex;align-items:center;justify-content:center;">\n        <i class="fas fa-exclamation-triangle" style="font-size:28px;color:white;"></i>\n      </div>\n      <h2 style="color:var(--text-primary, #fff);margin:0 0 12px;font-size:24px;">${escapeHtml(o)}</h2>\n      <p style="color:var(--text-secondary, #a0a0a0);margin:0 0 24px;font-size:15px;line-height:1.6;">${escapeHtml(t)}</p>\n      <p style="font-size:13px;color:var(--text-muted, #666);">\n        Kontakt administrator for å håndtere abonnementet, eller <a href="mailto:sander@efffekt.no" style="color:#3b82f6;">ta kontakt med support</a>.\n      </p>\n    </div>\n  `,document.body.appendChild(s),s.addEventListener("click",e=>{"A"!==e.target.tagName&&e.stopPropagation()})}let ws=null,wsReconnectTimer=null,wsReconnectAttempts=0;const MAX_RECONNECT_ATTEMPTS=10;function initWebSocket(){const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}`;try{ws=new WebSocket(e),ws.onopen=()=>{Logger.log("WebSocket connected - sanntidsoppdateringer aktiv"),wsReconnectAttempts=0},ws.onmessage=e=>{try{handleRealtimeUpdate(JSON.parse(e.data))}catch(e){console.error("Error parsing WebSocket message:",e)}},ws.onclose=()=>{Logger.log("WebSocket disconnected"),attemptReconnect()},ws.onerror=e=>{console.error("WebSocket error:",e)}}catch(e){console.error("Failed to create WebSocket:",e)}}function attemptReconnect(){if(wsReconnectAttempts>=10)return void Logger.log("Max reconnection attempts reached");wsReconnectAttempts++;const e=Math.min(1e3*Math.pow(2,wsReconnectAttempts),3e4);wsReconnectTimer=setTimeout(()=>{Logger.log(`Attempting WebSocket reconnection (${wsReconnectAttempts}/10)...`),initWebSocket()},e)}function handleRealtimeUpdate(e){const{type:t,data:n}=e;switch(t){case"connected":Logger.log("Server:",n||e.message);break;case"kunde_created":customers.push(n),applyFilters(),renderCustomerAdmin(),renderMissingData(),updateOverdueBadge(),showNotification(`Ny kunde opprettet: ${n.navn}`);break;case"kunde_updated":const t=customers.findIndex(e=>e.id===Number.parseInt(n.id));-1!==t&&(customers[t]={...customers[t],...n},applyFilters(),renderCustomerAdmin(),renderMissingData(),updateOverdueBadge());break;case"kunde_deleted":customers=customers.filter(e=>e.id!==n.id),selectedCustomers.delete(n.id),applyFilters(),renderCustomerAdmin(),renderMissingData(),updateOverdueBadge(),updateSelectionUI();break;case"time_update":updateDayCounters()}}function updateDayCounters(){const e=document.querySelector(".tab-item.active")?.dataset.tab;"customers"===e?renderCustomerAdmin():"overdue"===e?renderOverdue():"warnings"===e?renderWarnings():"planner"===e&&renderPlanner(),updateOverdueBadge(),renderMissingData(),applyFilters()}function scheduleNextMidnightUpdate(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1),t.setHours(0,0,1,0);const n=t.getTime()-e.getTime();setTimeout(()=>{Logger.log("Midnight update - refreshing day counters"),updateDayCounters(),scheduleNextMidnightUpdate()},n),Logger.log(`Next midnight update scheduled in ${Math.round(n/1e3/60)} minutes`)}function escapeHtml(e){if(null==e)return"";const t=String(e),n=document.createElement("div");return n.textContent=t,n.innerHTML}function updateCategoryTabs(){if(!serviceTypeRegistry.initialized)return;const e=document.getElementById("kategoriTabs");e&&(e.innerHTML=serviceTypeRegistry.renderCategoryTabs(customerAdminKategori),Logger.log("Category tabs updated from service registry"))}function updateBadge(e,t){const n=document.getElementById(e);n&&(t>0?(n.textContent=t,n.style.display="inline-flex"):n.style.display="none")}function getNearestControlDate(e){const t=[e.neste_el_kontroll,e.neste_brann_kontroll,e.neste_kontroll].filter(Boolean).map(e=>{const[t,n,a]=e.split("-").map(Number);return new Date(t,n-1,a)});return 0===t.length?null:new Date(Math.min(...t))}async function loadConfig(){try{const e=await fetch("/api/config");appConfig=await e.json(),serviceTypeRegistry.loadFromConfig(appConfig);const t=localStorage.getItem("industrySlug");if(t)try{await serviceTypeRegistry.loadFromIndustry(t),Logger.log("Loaded saved industry from localStorage:",t)}catch(e){Logger.warn("Could not load saved industry:",e)}updateControlSectionHeaders(),renderFilterPanelCategories(),renderDriftskategoriFilter(),Logger.log("Application configuration loaded:",appConfig),Logger.log("Route planning configured:",appConfig.orsApiKeyConfigured)}catch(e){Logger.warn("Could not load configuration from server:",e),appConfig={appName:"Sky Planner",companyName:"",companySubtitle:"Kontroll. Oversikt. Alltid.",logoUrl:"/skyplanner-logo.svg",contactAddress:"",contactPhone:"",contactEmail:"",appYear:"2026",mapCenterLat:65.5,mapCenterLng:12,mapZoom:5,mapClusterRadius:80,enableRoutePlanning:!0,showUpcomingWidget:!0,upcomingControlDays:30,defaultControlInterval:12,controlIntervals:[6,12,24,36],requireAuth:!0}}}function applyBranding(){const e=document.getElementById("loginLogo"),t=document.getElementById("loginBrandTitle"),n=document.getElementById("loginBrandSubtitle"),a=document.getElementById("loginContact"),s=document.getElementById("loginAddress"),o=document.getElementById("loginContactLinks"),r=document.getElementById("loginFooterCopyright"),i=document.getElementById("headerLogo"),l=document.getElementById("headerCompanyName"),d=document.getElementById("headerAppName"),c=document.getElementById("headerYear");appConfig.logoUrl&&(e&&(e.src=appConfig.logoUrl,e.style.display="block"),i&&(i.src=appConfig.logoUrl,i.style.display="block")),d&&(d.textContent=appConfig.companyName||appConfig.appName||"Sky Planner");const u=appConfig.industry?.name;u?l&&(l.textContent=u,l.style.display=""):l&&(l.style.display="none"),appConfig.companyName&&t&&(t.textContent=appConfig.companyName);const m=appConfig.appYear||(new Date).getFullYear();if(c&&(c.textContent=m),r){const e=appConfig.developerName||"Efffekt AS";r.innerHTML=`&copy; ${m} ${escapeHtml(e)}. All rights reserved.`}if(n&&appConfig.companySubtitle&&(n.textContent=appConfig.companySubtitle),a&&(appConfig.contactAddress||appConfig.contactPhone||appConfig.contactEmail)&&(a.style.display="block",s&&appConfig.contactAddress&&(s.textContent=appConfig.contactAddress),o)){let e=[];if(appConfig.contactPhone){const t=appConfig.contactPhone.replace(/[^\d\s\+\-\(\)]/g,""),n=t.replace(/\s/g,"");e.push(`<a href="tel:${escapeHtml(n)}">${escapeHtml(t)}</a>`)}appConfig.contactEmail&&e.push(`<a href="mailto:${escapeHtml(appConfig.contactEmail)}">${escapeHtml(appConfig.contactEmail)}</a>`),o.innerHTML=e.join('<span class="login-contact-divider">·</span>')}applyTenantColors(),appConfig.appName&&(document.title=appConfig.appName),updateCategoryTabs(),renderLoginFeatures(),Logger.log("Branding applied from config")}function renderLoginFeatures(){const e=document.getElementById("loginFeatures");if(!e)return;let t=[];try{t=serviceTypeRegistry.getAll()||[]}catch(e){}const n=[...t.length>0?t.slice(0,3).map(e=>{let t=e.icon||"fa-check-circle";return t.startsWith("fas ")||t.startsWith("far ")||t.startsWith("fab ")||(t="fas "+t),{icon:t,name:e.name,description:e.description||"Periodisk kontroll"}}):[{icon:"fas fa-bolt",name:"El-kontroll",description:"Periodisk kontroll for næring og bolig"},{icon:"fas fa-fire",name:"Brannvarsling",description:"Service og kontroll av anlegg"}],{icon:"fas fa-route",name:"Ruteplanlegging",description:"Effektive serviceruter"},{icon:"fas fa-bell",name:"Varsler",description:"Automatiske påminnelser"}];e.innerHTML=n.map(e=>`\n    <div class="login-feature">\n      <div class="login-feature-icon">\n        <i class="${e.icon}"></i>\n      </div>\n      <div class="login-feature-text">\n        <h4>${e.name}</h4>\n        <p>${e.description}</p>\n      </div>\n    </div>\n  `).join("")}function applyTenantColors(){const e=document.documentElement;appConfig.primaryColor&&(e.style.setProperty("--color-accent",appConfig.primaryColor),e.style.setProperty("--color-accent-hover",adjustColor(appConfig.primaryColor,-20)),e.style.setProperty("--color-accent-light",adjustColor(appConfig.primaryColor,40))),appConfig.secondaryColor&&e.style.setProperty("--color-sidebar-bg",appConfig.secondaryColor),Logger.log("Tenant colors applied:",{primary:appConfig.primaryColor,secondary:appConfig.secondaryColor})}function adjustColor(e,t){if(!e)return e;e=e.replace("#","");let n=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),s=parseInt(e.substring(4,6),16);return n=Math.min(255,Math.max(0,n+Math.round(n*t/100))),a=Math.min(255,Math.max(0,a+Math.round(a*t/100))),s=Math.min(255,Math.max(0,s+Math.round(s*t/100))),`#${n.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}async function reloadConfigWithAuth(){try{const e=localStorage.getItem("authToken");if(!e)return;const t=await fetch("/api/config",{headers:{Authorization:`Bearer ${e}`}});if(t.ok){const e=await t.json();appConfig=e.data||e;const n=appConfig.industry;if(n&&n.slug)localStorage.setItem("industrySlug",n.slug),localStorage.setItem("industryName",n.name||n.slug),await serviceTypeRegistry.loadFromIndustry(n.slug),Logger.log("Industry loaded from server:",n.slug);else{const e=localStorage.getItem("industrySlug");e?await serviceTypeRegistry.loadFromIndustry(e):serviceTypeRegistry.loadFromConfig(appConfig)}updateControlSectionHeaders(),renderFilterPanelCategories(),renderDriftskategoriFilter(),applyBranding(),Logger.log("Tenant-specific config loaded:",appConfig.organizationSlug)}}catch(e){Logger.warn("Could not reload tenant config:",e)}}let customerList,searchInput,addCustomerBtn,planRouteBtn,clearSelectionBtn,selectedCount,customerModal,customerForm,apiKeyModal,routeInfo;function initDOMElements(){customerList=document.getElementById("customerList"),searchInput=document.getElementById("searchInput"),addCustomerBtn=document.getElementById("addCustomerBtn"),planRouteBtn=document.getElementById("planRouteBtn"),clearSelectionBtn=document.getElementById("clearSelectionBtn"),selectedCount=document.getElementById("selectedCount"),customerModal=document.getElementById("customerModal"),customerForm=document.getElementById("customerForm"),apiKeyModal=document.getElementById("apiKeyModal"),routeInfo=document.getElementById("routeInfo")}function initMap(){if(Logger.log("initMap() starting, map exists:",!!map),!map)return void console.error("Map not initialized - call initSharedMap() first");addNorwayBorder(),L.control.scale({metric:!0,imperial:!1,position:"bottomleft"}).addTo(map);const e=appConfig.mapClusterRadius||120;markerClusterGroup=L.markerClusterGroup({maxClusterRadius:e,iconCreateFunction:createClusterIcon,disableClusteringAtZoom:13,spiderfyOnMaxZoom:!0,spiderfyOnEveryZoom:!1,spiderfyDistanceMultiplier:2.5,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,animate:!0,animateAddingMarkers:!1,singleMarkerMode:!1}),map.addLayer(markerClusterGroup),markerClusterGroup.on("spiderfied",e=>{e.markers.forEach(e=>{e._icon&&e._icon.classList.add("spiderfied-marker")})}),markerClusterGroup.on("unspiderfied",e=>{e.markers.forEach(e=>{e._icon&&e._icon.classList.remove("spiderfied-marker")})}),Logger.log("initMap() markerClusterGroup created and added to map"),markerClusterGroup.on("clusterclick",function(e){const t=e.layer.getAllChildMarkers(),n=[],a=[];t.forEach(e=>{for(const[t,s]of Object.entries(markers))if(s===e){n.push(Number.parseInt(t));const e=customers.find(e=>e.id===Number.parseInt(t));e&&a.push(e.navn);break}});const s=new Set;n.forEach(e=>{const t=customers.find(t=>t.id===e);t&&t.poststed&&s.add(t.poststed)});const o=`\n      <div class="cluster-popup">\n        <h3>${escapeHtml(Array.from(s).slice(0,2).join(" / ")||"Område")}</h3>\n        <p><strong>${n.length}</strong> kunder i dette området</p>\n        <div class="cluster-popup-actions">\n          <button class="btn btn-primary btn-small" data-action="addClusterToRoute" data-customer-ids="${n.join(",")}">\n            <i class="fas fa-route"></i> Legg til rute\n          </button>\n          <button class="btn btn-secondary btn-small" data-action="zoomToCluster" data-lat="${e.latlng.lat}" data-lng="${e.latlng.lng}">\n            <i class="fas fa-search-plus"></i> Zoom inn\n          </button>\n        </div>\n        <div class="cluster-customer-list">\n          ${a.slice(0,5).map(e=>`<span class="cluster-customer-name">${escapeHtml(e)}</span>`).join("")}\n          ${a.length>5?`<span class="cluster-more">+${a.length-5} flere...</span>`:""}\n        </div>\n      </div>\n    `;L.popup().setLatLng(e.latlng).setContent(o).openOn(map)}),map.on("zoomend",updateMarkerLabelsVisibility)}function updateMarkerLabelsVisibility(){const e=map.getZoom(),t=document.getElementById("map");e<10?t.classList.add("hide-marker-labels"):t.classList.remove("hide-marker-labels")}async function loadCustomers(){Logger.log("loadCustomers() called, markerClusterGroup:",!!markerClusterGroup);try{const e=await apiFetch("/api/kunder");if(!e.ok)throw new Error(`HTTP ${e.status}: Kunne ikke laste kunder`);const t=await e.json();customers=t.data||t,Logger.log("loadCustomers() fetched",customers.length,"customers"),applyFilters(),renderMarkers(customers),renderCustomerAdmin(),updateOverdueBadge(),renderMissingData(),updateDashboard()}catch(e){console.error("Feil ved lasting av kunder:",e)}}async function loadOmrader(){try{const e=await apiFetch("/api/omrader");if(!e.ok)throw new Error(`HTTP ${e.status}: Kunne ikke laste områder`);const t=await e.json();omrader=t.data||t,renderOmradeFilter()}catch(e){console.error("Feil ved lasting av områder:",e)}}async function loadRoutes(){try{const e=await apiFetch("/api/ruter");if(!e.ok)throw new Error(`HTTP ${e.status}: Kunne ikke laste ruter`);const t=await e.json();savedRoutes=t.data||t,renderSavedRoutes()}catch(e){console.error("Feil ved lasting av ruter:",e)}}function renderOmradeFilter(){const e=document.getElementById("omradeFilter");if(!e)return;e.innerHTML=`\n    <select id="omradeSelect">\n      <option value="alle">Alle områder</option>\n      <option value="varsler">Trenger kontroll</option>\n      ${omrader.map(e=>`<option value="${escapeHtml(e.poststed)}">${escapeHtml(e.poststed)} (${e.antall})</option>`).join("")}\n    </select>\n  `;const t=document.getElementById("omradeSelect"),n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.addEventListener("change",e=>{currentFilter=e.target.value,showOnlyWarnings="varsler"===currentFilter,applyFilters()})}async function applyFilters(){filterAbortController&&filterAbortController.abort(),filterAbortController=new AbortController;let e=[...customers];const t=searchInput?.value?.toLowerCase()||"";if("all"!==selectedCategory){const t=e.length;e=e.filter(e=>e.kategori&&e.kategori.includes(selectedCategory)),Logger.log(`applyFilters: "${selectedCategory}" - ${t} -> ${e.length} kunder`)}if("all"!==selectedDriftskategori&&(e=e.filter(e=>e.brann_driftstype===selectedDriftskategori)),Object.keys(dynamicFieldFilters).length>0&&(e=e.filter(e=>{let t=e.custom_data;if("string"==typeof t)try{t=JSON.parse(t)}catch{t={}}return t=t||{},Object.entries(dynamicFieldFilters).every(([e,n])=>{const a=t[e],s=organizationFields.find(t=>t.field_name===e);if(!s)return!0;switch(s.field_type){case"select":return a===n;case"text":default:return a&&String(a).toLowerCase().includes(String(n).toLowerCase());case"number":if(!a&&0!==a)return!1;const e=parseFloat(a);return!isNaN(e)&&(!(n.min&&e<parseFloat(n.min))&&!(n.max&&e>parseFloat(n.max)));case"date":if(!a)return!1;const t=new Date(a);return!isNaN(t.getTime())&&(!(n.from&&t<new Date(n.from))&&!(n.to&&t>new Date(n.to)))}})})),showOnlyWarnings)try{const t=await apiFetch("/api/kunder/kontroll-varsler?dager=30",{signal:filterAbortController.signal});if(!t.ok)throw new Error(`HTTP ${t.status}: Kunne ikke laste varsler`);const n=await t.json(),a=n.data||n,s=new Set(a.map(e=>e.id));e=e.filter(e=>s.has(e.id))}catch(e){if("AbortError"===e.name)return;console.error("Feil ved henting av varsler:",e)}else"alle"!==currentFilter&&(e=e.filter(e=>e.poststed===currentFilter));t&&(e=e.filter(e=>e.navn.toLowerCase().includes(t)||e.adresse.toLowerCase().includes(t)||e.poststed&&e.poststed.toLowerCase().includes(t)||e.postnummer&&e.postnummer.includes(t))),renderCustomerList(e),renderMarkers(e),updateCategoryFilterCounts()}function updateCategoryFilterCounts(){const e=customers.filter(e=>e.kategori&&e.kategori.includes("El-Kontroll")).length,t=customers.filter(e=>e.kategori&&e.kategori.includes("Brannvarsling")).length,n=customers.filter(e=>"El-Kontroll + Brannvarsling"===e.kategori).length,a=document.querySelector('[data-category="all"]'),s=document.querySelector('[data-category="El-Kontroll"]'),o=document.querySelector('[data-category="Brannvarsling"]'),r=document.querySelector('[data-category="El-Kontroll + Brannvarsling"]');a&&(a.innerHTML=`<i class="fas fa-list"></i> Alle (${customers.length})`),s&&(s.innerHTML=`<i class="fas fa-bolt"></i> El-Kontroll (${e})`),o&&(o.innerHTML=`<i class="fas fa-fire"></i> Brannvarsling (${t})`),r&&(r.innerHTML=`<i class="fas fa-bolt"></i><i class="fas fa-fire"></i> Begge (${n})`);const i=document.querySelector('[data-kategori="alle"]'),l=document.querySelector('[data-kategori="El-Kontroll"]'),d=document.querySelector('[data-kategori="Brannvarsling"]'),c=document.querySelector('[data-kategori="El-Kontroll + Brannvarsling"]');if(i&&(i.innerHTML=`Alle (${customers.length})`),l&&(l.innerHTML=`${serviceTypeRegistry.getIcon(serviceTypeRegistry.getBySlug("el-kontroll"))} El-Kontroll (${e})`),d&&(d.innerHTML=`${serviceTypeRegistry.getIcon(serviceTypeRegistry.getBySlug("brannvarsling"))} Brannvarsling (${t})`),c){const e=serviceTypeRegistry.getIcon(serviceTypeRegistry.getBySlug("el-kontroll")),t=serviceTypeRegistry.getIcon(serviceTypeRegistry.getBySlug("brannvarsling"));c.innerHTML=`${e}${t} Begge (${n})`}["Storfe","Sau","Geit","Gris","Gartneri","Storfe/Sau"].forEach(e=>{const t=document.querySelector(`[data-drift="${e}"]`);if(t){const n=customers.filter(t=>t.brann_driftstype===e).length;t.textContent=`${e} (${n})`}});const u=document.querySelector('[data-drift="all"]'),m=customers.filter(e=>e.brann_driftstype).length;u&&(u.innerHTML=`<i class="fas fa-list"></i> Alle (${m})`)}function addNorwayBorder(){L.polyline([[69.06,20.55],[68.95,20.1],[68.45,18.1],[68.15,17.9],[67.95,17.15],[67.5,16.4],[66.6,15.5],[66.15,14.6],[65.1,14.25],[64.15,13.95],[63.7,12.7],[62.65,12.3],[61.8,12.1],[61,12.15],[59.8,11.8],[59.1,11.45],[58.95,11.15]],{color:"#ef4444",weight:2,opacity:.7,dashArray:"8, 4"}).addTo(map),L.marker([68.5,19.5],{icon:L.divIcon({className:"country-label",html:"<span>SVERIGE</span>",iconSize:[100,20]})}).addTo(map),L.polygon([[71.5,20.5],[71.5,32],[58,32],[58,11],[59,11.5],[61,12.2],[63.5,12.5],[66,14.5],[68,17.5],[69,20],[71.5,20.5]],{color:"transparent",fillColor:"#000",fillOpacity:.25,interactive:!1}).addTo(map)}function createClusterIcon(e){const t=e.getAllChildMarkers(),n=new Set;let a=0;t.forEach(e=>{const t=e.getPopup().getContent(),s=t.match(/<p>(\d+)\s+([^<]+)<\/p>/);s&&n.add(s[2].trim()),(t.includes("status-overdue")||t.includes("status-soon"))&&a++});const s=t.length,o=a>0?`<div class="cluster-warning">${a}</div>`:"";let r;r=s>=100?"Region Nord":Array.from(n).slice(0,2).join(" / ");let i="cluster-small";return s>=50?i="cluster-xlarge":s>=20?i="cluster-large":s>=8&&(i="cluster-medium"),L.divIcon({html:`\n      <div class="cluster-icon ${i}">\n        <div class="cluster-count">${s}</div>\n        <div class="cluster-area">${r}</div>\n        ${o}\n      </div>\n    `,className:"custom-cluster",iconSize:[70,70],iconAnchor:[35,35]})}function getControlStatus(e){const t=getNextControlDate(e);if(!t)return{status:"ukjent",label:"Ikke registrert",class:"status-unknown",date:null,daysUntil:null};const n=new Date;n.setHours(0,0,0,0);const a=Math.ceil((t-n)/864e5),s=t.toLocaleDateString("no-NO",{day:"2-digit",month:"short",year:"numeric"});return a<0?{status:"forfalt",label:`${Math.abs(a)} dager over`,class:"status-overdue",date:s,daysUntil:a}:a<=30?{status:"snart",label:`${a} dager`,class:"status-soon",date:s,daysUntil:a}:a<=90?{status:"ok",label:`${a} dager`,class:"status-ok",date:s,daysUntil:a}:{status:"god",label:formatDate(t),class:"status-good",date:s,daysUntil:a}}function renderCustomerList(e){const t={};e.forEach(e=>{const n=e.poststed||"Ukjent område";t[n]||(t[n]=[]),t[n].push(e)});const n=Object.keys(t).sort((e,n)=>{const a=t[e][0],s=t[n][0],o=a?.postnummer||"9999",r=s?.postnummer||"9999";return o!==r?o.localeCompare(r):e.localeCompare(n)});n.forEach(e=>{sortByNavn(t[e])});let a="";n.forEach(e=>{const n=t[e],s=n[0]?.postnummer||"",o="true"===localStorage.getItem(`areaExpanded-${e}`),r=(e=>{let t=0,n=0;return e.forEach(e=>{const a=getControlStatus(e);"overdue"===a.class?t++:"warning"===a.class&&n++}),{urgent:t,warning:n}})(n);let i="";r.urgent>0&&(i+=`<span class="area-badge urgent">${r.urgent}</span>`),r.warning>0&&(i+=`<span class="area-badge warning">${r.warning}</span>`),a+=`\n      <div class="customer-section">\n        <button class="section-header" data-area="${escapeHtml(e)}" data-action="toggleSection">\n          <span class="section-toggle-icon">\n            <i class="fas fa-chevron-${o?"down":"right"}"></i>\n          </span>\n          <span class="section-title">\n            <span class="section-postnr">${s}</span>\n            <span class="section-name">${escapeHtml(e)}</span>\n          </span>\n          <span class="section-meta">\n            ${i}\n            <span class="section-count">${n.length}</span>\n          </span>\n        </button>\n        <div class="section-content ${o?"":"collapsed"}">\n          ${n.map(e=>{const t=getControlStatus(e),n=e.neste_kontroll?new Date(e.neste_kontroll).toLocaleDateString("no-NO",{day:"2-digit",month:"short",year:"numeric"}):"Ikke satt",a=e.neste_kontroll?Math.ceil((new Date(e.neste_kontroll)-new Date)/864e5):null;let s="";null!==a&&(s=a<0?`${Math.abs(a)}d over`:0===a?"I dag":`${a}d`);const o=e.epost&&""!==e.epost.trim();return`\n              <div class="customer-item ${selectedCustomers.has(e.id)?"selected":""} ${t.class}"\n                   data-id="${e.id}" data-action="selectCustomer" data-customer-id="${e.id}">\n                <div class="customer-status-indicator ${t.class}"></div>\n                <div class="customer-info">\n                  <h3>${escapeHtml(e.navn)}</h3>\n                  <p>${escapeHtml(e.adresse)}</p>\n                </div>\n                <div class="customer-actions">\n                  <button class="customer-email-btn ${o?"":"disabled"}"\n                          data-action="sendEmail"\n                          data-customer-id="${e.id}"\n                          title="${o?"Send e-post":"Ingen e-post registrert"}">\n                    <i class="fas fa-envelope"></i>\n                  </button>\n                </div>\n                <div class="customer-control-info">\n                  <span class="control-date ${t.class}">${escapeHtml(n)}</span>\n                  ${s?`<span class="control-days ${t.class}">${escapeHtml(s)}</span>`:""}\n                </div>\n              </div>\n            `}).join("")}\n        </div>\n      </div>\n    `}),customerList.innerHTML=a}let renderMarkersRetryCount=0;const MAX_RENDER_RETRIES=10;function renderMarkers(e){if("login"===currentView)return Logger.log("renderMarkers skipped - still on login view"),void(renderMarkersRetryCount=0);if(!markerClusterGroup)return renderMarkersRetryCount>=MAX_RENDER_RETRIES?(console.error("renderMarkers failed after max retries - markerClusterGroup never initialized"),void(renderMarkersRetryCount=0)):(renderMarkersRetryCount++,console.error(`renderMarkers called but markerClusterGroup is null - retry ${renderMarkersRetryCount}/${MAX_RENDER_RETRIES}`),void setTimeout(()=>renderMarkers(e),100));renderMarkersRetryCount=0,markerClusterGroup.clearLayers(),markers={};const t={};e.forEach(e=>{const n=e.kategori||"null";t[n]=(t[n]||0)+1}),Logger.log("renderMarkers:",e.length,"kunder",t);const n=[];e.forEach(e=>{if(e.lat&&e.lng){const t=selectedCustomers.has(e.id),a=getControlStatus(e),s=e.navn.length>25?e.navn.substring(0,23)+"...":e.navn,o=e.adresse?e.adresse.length>30?e.adresse.substring(0,28)+"...":e.adresse:"",r=e.poststed||e.postnummer||"",i="forfalt"===a.status||"snart"===a.status?'<span class="marker-warning-badge">!</span>':"",l=serviceTypeRegistry.getDefaultServiceType(),d=e.kategori||l.name,c=serviceTypeRegistry.getIconForCategory(d),u=serviceTypeRegistry.getCategoryClass(d),m=L.divIcon({className:`custom-marker-with-label ${t?"selected":""} ${a.class}`,html:`\n          <div class="marker-icon ${u}" data-status="${a.status}">\n            ${c}\n            ${i}\n          </div>\n          <div class="marker-label">\n            <span class="marker-name">${escapeHtml(s)}</span>\n            <span class="marker-address">${escapeHtml(o)}</span>\n            <span class="marker-location">${escapeHtml(r)}</span>\n          </div>\n        `,iconSize:[220,60],iconAnchor:[20,36]}),p=e.epost&&""!==e.epost.trim(),g=serviceTypeRegistry.renderPopupControlInfo(e,a),v=serviceTypeRegistry.renderPopupIndustryFields(e),f=renderPopupCustomFields(e),y=L.marker([e.lat,e.lng],{icon:m}).bindPopup(`\n          <h3>${escapeHtml(e.navn)}</h3>\n          <p><strong>Kategori:</strong> ${escapeHtml(e.kategori||"Annen")}</p>\n          ${v}\n          ${f}\n          <p>${escapeHtml(e.adresse)}</p>\n          <p>${escapeHtml(e.postnummer||"")} ${escapeHtml(e.poststed||"")}</p>\n          ${e.telefon?`<p>Tlf: ${escapeHtml(e.telefon)}</p>`:""}\n          ${e.epost?`<p>E-post: ${escapeHtml(e.epost)}</p>`:""}\n          ${g}\n          <div class="popup-actions">\n            <button class="btn btn-small btn-navigate" data-action="navigateToCustomer" data-lat="${e.lat}" data-lng="${e.lng}" data-name="${escapeHtml(e.navn)}">\n              <i class="fas fa-directions"></i> Naviger\n            </button>\n            <button class="btn btn-small btn-primary" data-action="toggleCustomerSelection" data-customer-id="${e.id}">\n              ${t?"Fjern fra rute":"Legg til rute"}\n            </button>\n            <button class="btn btn-small ${bulkSelectedCustomers.has(e.id)?"btn-success":"btn-complete"}"\n                    data-action="toggleBulkSelect"\n                    data-customer-id="${e.id}">\n              <i class="fas ${bulkSelectedCustomers.has(e.id)?"fa-check-circle":"fa-check"}"></i>\n              ${bulkSelectedCustomers.has(e.id)?"Valgt":"Marker ferdig"}\n            </button>\n            <button class="btn btn-small btn-secondary" data-action="editCustomer" data-customer-id="${e.id}">\n              Rediger\n            </button>\n            <button class="btn btn-small ${p?"btn-email":"btn-disabled"}"\n                    data-action="sendEmail"\n                    data-customer-id="${e.id}"\n                    ${p?"":"disabled"}>\n              <i class="fas fa-envelope"></i> E-post\n            </button>\n          </div>\n        `);y.on("click",()=>{y.openPopup()}),n.push({marker:y,customerId:e.id}),markers[e.id]=y}}),n.length>0&&(n.forEach(e=>{markerClusterGroup.addLayer(e.marker)}),Logger.log("renderMarkers: Added",n.length,"markers to cluster group"))}function focusOnCustomer(e){const t=customers.find(t=>t.id===e);if(!t)return;const n=document.querySelector('[data-tab="kart"]');n&&(document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),n.classList.add("active"),document.getElementById("kart")?.classList.add("active"),map.invalidateSize()),t.lat&&t.lng?(map.setView([t.lat,t.lng],14),markers[e]&&markers[e].openPopup()):showNotification(`${t.navn} mangler koordinater - bruk geokoding`)}function toggleCustomerSelection(e){selectedCustomers.has(e)?selectedCustomers.delete(e):selectedCustomers.add(e),updateSelectionUI()}function updateSelectionUI(){selectedCount.textContent=selectedCustomers.size,planRouteBtn.disabled=selectedCustomers.size<2,clearSelectionBtn.disabled=0===selectedCustomers.size;const e=document.getElementById("mobileRouteBtn"),t=document.getElementById("mobileRouteCount");e&&t&&(selectedCustomers.size>=2?(e.classList.remove("hidden"),t.textContent=selectedCustomers.size):e.classList.add("hidden")),document.querySelectorAll(".customer-item").forEach(e=>{const t=Number.parseInt(e.dataset.id);e.classList.toggle("selected",selectedCustomers.has(t))}),renderMarkers(customers)}function clearSelection(){selectedCustomers.clear(),updateSelectionUI(),clearRoute()}function updateBulkSelectionUI(){let e=document.getElementById("bulkActionBar");e||(e=document.createElement("div"),e.id="bulkActionBar",e.className="bulk-action-bar",document.body.appendChild(e));const t=Array.from(bulkSelectedCustomers).map(e=>customers.find(t=>t.id===e)).filter(e=>e).map(e=>e.navn);e.innerHTML=`\n    <div class="bulk-action-content">\n      <div class="bulk-info">\n        <span class="bulk-count"><i class="fas fa-check-circle"></i> ${bulkSelectedCustomers.size} valgt for avhuking</span>\n        ${t.length>0?`\n          <div class="bulk-names">\n            ${t.slice(0,5).map(e=>`<span class="bulk-name-tag">${escapeHtml(e)}</span>`).join("")}\n            ${t.length>5?`<span class="bulk-name-more">+${t.length-5} flere</span>`:""}\n          </div>\n        `:""}\n      </div>\n      <div class="bulk-actions">\n        <button class="btn btn-secondary btn-sm" onclick="clearBulkSelection()">\n          <i class="fas fa-times"></i> Avbryt\n        </button>\n        <button class="btn btn-success btn-sm" onclick="openBulkCompleteModal()">\n          <i class="fas fa-check"></i> Marker som ferdig\n        </button>\n      </div>\n    </div>\n  `,bulkSelectedCustomers.size>0?e.classList.add("visible"):e.classList.remove("visible")}function clearBulkSelection(){bulkSelectedCustomers.clear(),updateBulkSelectionUI(),renderAvhukingTab(),renderCustomerAdmin()}function renderAvhukingTab(){const e=document.getElementById("avhukingList"),t=document.getElementById("avhukingCountHeader"),n=document.getElementById("avhukingBadge"),a=document.getElementById("clearAvhukingBtn"),s=document.getElementById("completeAvhukingBtn");if(!e)return;const o=bulkSelectedCustomers.size;if(t&&(t.textContent=`${o} valgt`),n&&(n.textContent=o,n.style.display=o>0?"inline-flex":"none"),a&&(a.disabled=0===o),s&&(s.disabled=0===o),0===o)return void(e.innerHTML='\n      <div class="avhuking-empty">\n        <i class="fas fa-clipboard-list"></i>\n        <p>Ingen kunder valgt</p>\n        <span>Klikk på en kunde i kartet og velg "Marker ferdig"</span>\n      </div>\n    ');const r=Array.from(bulkSelectedCustomers).map(e=>customers.find(t=>t.id===e)).filter(e=>e);e.innerHTML=r.map(e=>{const t="El-Kontroll"===e.kategori?"el":"Brannvarsling"===e.kategori?"brann":"El-Kontroll + Brannvarsling"===e.kategori?"begge":"";return`\n      <div class="avhuking-item" data-id="${e.id}">\n        <div class="avhuking-item-info">\n          <span class="avhuking-item-name">${escapeHtml(e.navn)}</span>\n          <span class="avhuking-item-address">${escapeHtml(e.adresse||"")}, ${escapeHtml(e.poststed||"")}</span>\n          <span class="avhuking-item-kategori ${t}">${escapeHtml(e.kategori||"Ukjent")}</span>\n        </div>\n        <div class="avhuking-item-actions">\n          <button class="btn btn-small btn-secondary" data-action="focusAvhukingCustomer" data-customer-id="${e.id}" title="Vis på kart">\n            <i class="fas fa-map-marker-alt"></i>\n          </button>\n          <button class="btn btn-small btn-danger" data-action="removeFromAvhuking" data-customer-id="${e.id}" title="Fjern">\n            <i class="fas fa-times"></i>\n          </button>\n        </div>\n      </div>\n    `}).join("")}function removeFromAvhuking(e){bulkSelectedCustomers.delete(e),updateBulkSelectionUI(),renderAvhukingTab(),renderCustomerAdmin();const t=customers.find(t=>t.id===e);showNotification(`${t?.navn||"Kunde"} fjernet fra avhuking`)}function toggleBulkSelectFromMap(e){bulkSelectedCustomers.has(e)?bulkSelectedCustomers.delete(e):bulkSelectedCustomers.add(e),updateBulkSelectionUI();const t=customers.find(t=>t.id===e),n=bulkSelectedCustomers.has(e),a=document.querySelector(".leaflet-popup-content");if(a){const e=a.querySelector('[data-action="toggleBulkSelect"]');e&&(e.className="btn btn-small "+(n?"btn-success":"btn-complete"),e.innerHTML=`<i class="fas ${n?"fa-check-circle":"fa-check"}"></i> ${n?"Valgt":"Marker ferdig"}`)}renderAvhukingTab(),renderCustomerAdmin(),showNotification(n?`${t?.navn||"Kunde"} lagt til for avhuking (${bulkSelectedCustomers.size} valgt)`:`${t?.navn||"Kunde"} fjernet fra avhuking`)}function toggleSelectAllVisible(){const e=document.getElementById("customerAdminList").querySelectorAll(".bulk-checkbox"),t=Array.from(e).every(e=>e.checked);e.forEach(e=>{const n=Number.parseInt(e.dataset.id);t?bulkSelectedCustomers.delete(n):bulkSelectedCustomers.add(n)}),updateBulkSelectionUI(),renderCustomerAdmin()}function openBulkCompleteModal(){if(0===bulkSelectedCustomers.size)return void showNotification("Velg minst én kunde først");const e=Array.from(bulkSelectedCustomers).map(e=>customers.find(t=>t.id===e)).filter(e=>e).map(e=>e.navn),t=Array.from(bulkSelectedCustomers).map(e=>customers.find(t=>t.id===e)).filter(e=>e),n=t.some(e=>"El-Kontroll"===e.kategori||"El-Kontroll + Brannvarsling"===e.kategori),a=t.some(e=>"Brannvarsling"===e.kategori||"El-Kontroll + Brannvarsling"===e.kategori),s=document.createElement("div");s.className="modal-overlay",s.id="bulkCompleteModal",s.innerHTML=`\n    <div class="modal bulk-complete-modal">\n      <div class="modal-header">\n        <h3><i class="fas fa-check-circle"></i> Marker som ferdig</h3>\n        <button class="modal-close" id="bulkCloseBtn">&times;</button>\n      </div>\n      <div class="modal-body">\n        <p class="bulk-info">\n          <strong>${bulkSelectedCustomers.size}</strong> kunde${bulkSelectedCustomers.size>1?"r":""} valgt:\n        </p>\n        <div class="bulk-customer-list">\n          ${e.slice(0,10).map(e=>`<span class="bulk-customer-tag">${escapeHtml(e)}</span>`).join("")}\n          ${e.length>10?`<span class="bulk-customer-more">+${e.length-10} flere...</span>`:""}\n        </div>\n\n        <div class="form-group">\n          <label>Hvilken kontroll er utført?</label>\n          <div class="control-type-options">\n            <label class="control-option ${n?"":"disabled"}">\n              <input type="checkbox" id="bulkCompleteEl" ${n?"checked":"disabled"}>\n              <span class="control-option-label">\n                <i class="fas fa-bolt"></i> El-kontroll\n              </span>\n            </label>\n            <label class="control-option ${a?"":"disabled"}">\n              <input type="checkbox" id="bulkCompleteBrann" ${a?"checked":"disabled"}>\n              <span class="control-option-label">\n                <i class="fas fa-fire"></i> Brannvarsling\n              </span>\n            </label>\n          </div>\n        </div>\n\n        <div class="form-group">\n          <label for="bulkCompleteDate">Kontrolldato</label>\n          <input type="date" id="bulkCompleteDate" value="${(new Date).toISOString().split("T")[0]}">\n        </div>\n      </div>\n      <div class="modal-footer">\n        <button class="btn btn-secondary" id="bulkCancelBtn">Avbryt</button>\n        <button class="btn btn-success" id="bulkConfirmBtn">\n          <i class="fas fa-check"></i> Bekreft fullført\n        </button>\n      </div>\n    </div>\n  `,document.body.appendChild(s);const o=document.getElementById("bulkCloseBtn"),r=document.getElementById("bulkCancelBtn"),i=document.getElementById("bulkConfirmBtn");o&&o.addEventListener("click",closeBulkCompleteModal),r&&r.addEventListener("click",closeBulkCompleteModal),i&&i.addEventListener("click",executeBulkComplete),s.addEventListener("click",e=>{e.target===s&&closeBulkCompleteModal()}),setTimeout(()=>s.classList.add("visible"),10)}function closeBulkCompleteModal(){const e=document.getElementById("bulkCompleteModal");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),300))}async function executeBulkComplete(){const e=document.getElementById("bulkCompleteEl"),t=document.getElementById("bulkCompleteBrann"),n=document.getElementById("bulkCompleteDate"),a=!!e&&e.checked,s=!!t&&t.checked,o=n?n.value:null;if(Logger.log("executeBulkComplete called:",{elChecked:a,brannChecked:s,dateValue:o,size:bulkSelectedCustomers.size}),!a&&!s)return void showNotification("Velg minst én kontrolltype");if(!o)return void showNotification("Velg en dato");const r=Array.from(bulkSelectedCustomers);Logger.log("Sending bulk-complete for:",r);try{const e=await apiFetch("/api/kunder/bulk-complete",{method:"POST",body:JSON.stringify({customerIds:r,completeEl:a,completeBrann:s,completedDate:o})});Logger.log("Response status:",e.status,e.ok);const t=await e.json();Logger.log("Response data:",t),e.ok&&t.success?(showNotification(`${t.updated} kunde${t.updated>1?"r":""} oppdatert`),closeBulkCompleteModal(),clearBulkSelection(),await loadCustomers(),renderAvhukingTab()):showNotification(t.error||t.message||"Kunne ikke oppdatere kunder","error")}catch(e){console.error("Feil ved bulk-oppdatering:",e),showNotification("Feil ved oppdatering: "+e.message,"error")}}function filterCustomers(){applyFilters()}async function geocodeAddress(e,t,n){const a=`${e}, ${t||""} ${n||""}`.trim();try{const e=await fetch(`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(a)}&fuzzy=true&treffPerSide=1`),t=await e.json();if(t.adresser&&t.adresser.length>0){const e=t.adresser[0];return{lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon,formatted:`${e.adressetekst}, ${e.postnummer} ${e.poststed}`}}const n=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(a)}&format=json&countrycodes=no&limit=1`),s=await n.json();return s.length>0?{lat:Number.parseFloat(s[0].lat),lng:Number.parseFloat(s[0].lon),formatted:s[0].display_name}:null}catch(e){return console.error("Geocoding feil:",e),null}}function debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}async function searchAddresses(e){if(!e||e.length<3)return[];try{const t=`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(e)}&fuzzy=true&treffPerSide=5`,n=await fetch(t),a=await n.json();return a.adresser&&a.adresser.length>0?a.adresser.map(e=>({adresse:e.adressetekst,postnummer:e.postnummer,poststed:e.poststed,lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon,kommune:e.kommunenavn||""})):[]}catch(e){return console.error("Adressesøk feilet:",e),[]}}async function lookupPostnummer(e){if(!/^\d{4}$/.test(e))return null;try{const t=`https://api.bring.com/shippingguide/api/postalCode.json?clientUrl=elkontroll&country=NO&pnr=${e}`,n=await fetch(t),a=await n.json();return a.valid?a.result:null}catch(e){return console.error("Postnummer-oppslag feilet:",e),null}}function renderAddressSuggestions(e){const t=document.getElementById("addressSuggestions");if(t){if(!e||0===e.length)return t.innerHTML="",void t.classList.remove("visible");t.innerHTML=e.map((e,t)=>`\n    <div class="address-suggestion-item" data-index="${t}">\n      <i class="fas fa-map-marker-alt"></i>\n      <div class="address-suggestion-text">\n        <div class="address-suggestion-main">${escapeHtml(e.adresse)}</div>\n        <div class="address-suggestion-detail">${escapeHtml(e.postnummer)} ${escapeHtml(e.poststed)}${e.kommune?`, ${escapeHtml(e.kommune)}`:""}</div>\n      </div>\n    </div>\n  `).join(""),t.classList.add("visible")}}function selectAddressSuggestion(e){const t=document.getElementById("adresse"),n=document.getElementById("postnummer"),a=document.getElementById("poststed"),s=document.getElementById("lat"),o=document.getElementById("lng"),r=document.getElementById("addressSuggestions");t&&(t.value=e.adresse),n&&(n.value=e.postnummer),a&&(a.value=e.poststed,a.classList.add("auto-filled")),s&&(s.value=e.lat.toFixed(6)),o&&(o.value=e.lng.toFixed(6)),updateGeocodeQualityBadge("exact"),r&&r.classList.remove("visible"),updatePostnummerStatus("valid"),showNotification(`Adresse valgt: ${e.adresse}, ${e.postnummer} ${e.poststed}`)}function updatePostnummerStatus(e){const t=document.getElementById("postnummerStatus");if(t)switch(t.className="postnummer-status",e){case"valid":t.innerHTML='<i class="fas fa-check"></i>',t.classList.add("valid");break;case"invalid":t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("invalid");break;case"loading":t.innerHTML='<i class="fas fa-spinner fa-spin"></i>',t.classList.add("loading");break;default:t.innerHTML=""}}window.clearBulkSelection=clearBulkSelection,window.toggleSelectAllVisible=toggleSelectAllVisible,window.openBulkCompleteModal=openBulkCompleteModal,window.closeBulkCompleteModal=closeBulkCompleteModal,window.executeBulkComplete=executeBulkComplete;let addressSuggestions=[],selectedSuggestionIndex=-1;function setupAddressAutocomplete(){const e=document.getElementById("adresse"),t=document.getElementById("postnummer"),n=document.getElementById("poststed"),a=document.getElementById("addressSuggestions");if(!e||!a)return;const s=debounce(async e=>{e.length<3?a.classList.remove("visible"):(addressSuggestions=await searchAddresses(e),selectedSuggestionIndex=-1,renderAddressSuggestions(addressSuggestions))},300);e.addEventListener("input",e=>{s(e.target.value)}),e.addEventListener("keydown",e=>{if(!a.classList.contains("visible"))return;const t=a.querySelectorAll(".address-suggestion-item");switch(e.key){case"ArrowDown":e.preventDefault(),selectedSuggestionIndex=Math.min(selectedSuggestionIndex+1,t.length-1),updateSelectedSuggestion(t);break;case"ArrowUp":e.preventDefault(),selectedSuggestionIndex=Math.max(selectedSuggestionIndex-1,-1),updateSelectedSuggestion(t);break;case"Enter":selectedSuggestionIndex>=0&&addressSuggestions[selectedSuggestionIndex]&&(e.preventDefault(),selectAddressSuggestion(addressSuggestions[selectedSuggestionIndex]));break;case"Escape":a.classList.remove("visible"),selectedSuggestionIndex=-1}}),a.addEventListener("click",e=>{const t=e.target.closest(".address-suggestion-item");if(t){const e=parseInt(t.dataset.index,10);addressSuggestions[e]&&selectAddressSuggestion(addressSuggestions[e])}}),document.addEventListener("click",e=>{e.target.closest(".address-autocomplete-wrapper")||a.classList.remove("visible")}),t&&n&&t.addEventListener("input",async e=>{const t=e.target.value.replace(/\D/g,"").slice(0,4);if(e.target.value=t,n.classList.remove("auto-filled"),updatePostnummerStatus(""),4===t.length){updatePostnummerStatus("loading");const e=await lookupPostnummer(t);e?(n.value=e,n.classList.add("auto-filled"),updatePostnummerStatus("valid")):updatePostnummerStatus("invalid")}})}function updateSelectedSuggestion(e){e.forEach((e,t)=>{t===selectedSuggestionIndex?(e.classList.add("selected"),e.scrollIntoView({block:"nearest"})):e.classList.remove("selected")})}async function planRoute(){if(!appConfig.orsApiKeyConfigured)return void showMessage("Ruteplanlegging er ikke konfigurert. Kontakt administrator.","warning");const e=customers.filter(e=>selectedCustomers.has(e.id)&&e.lat&&e.lng);if(e.length<1)return void showMessage("Velg minst 1 kunde med gyldige koordinater","warning");planRouteBtn.classList.add("loading"),planRouteBtn.disabled=!0;const t=[appConfig.routeStartLng||17.65274,appConfig.routeStartLat||69.06888];try{const n=await fetch("/api/routes/optimize",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({jobs:e.map((e,t)=>({id:t+1,location:[e.lng,e.lat],service:1800})),vehicles:[{id:1,profile:"driving-car",start:t,end:t}]})});if(!n.ok)return void await planSimpleRoute(e);const a=await n.json();if(a.routes&&a.routes.length>0){const t=a.routes[0],n=t.steps.filter(e=>"job"===e.type).map(t=>e[t.job-1]);await drawRoute(n),showRouteInfo(n,t.duration,t.distance)}}catch(e){console.error("Ruteplanlegging feil:",e),await planSimpleRoute(customers.filter(e=>selectedCustomers.has(e.id)&&e.lat&&e.lng))}finally{planRouteBtn.classList.remove("loading"),planRouteBtn.disabled=!1}}async function planSimpleRoute(e){try{const t=[appConfig.routeStartLng||17.65274,appConfig.routeStartLat||69.06888],n=[appConfig.routeStartLat||69.06888,appConfig.routeStartLng||17.65274],a=[t,...e.map(e=>[e.lng,e.lat]),t],s=await fetch("/api/routes/directions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({coordinates:a})}),o=await s.json();if(!s.ok){if(o.error&&o.error.message){if(o.error.message.includes("Could not find routable point"))throw new Error("En eller flere kunder har koordinater som ikke er nær en vei. Velg andre kunder eller oppdater koordinatene.");throw new Error(o.error.message)}throw new Error("Kunne ikke beregne rute")}if(o.features&&o.features.length>0){const t=o.features[0];drawRouteFromGeoJSON(t);const a=L.divIcon({className:"route-marker route-start",html:'<i class="fas fa-home"></i>',iconSize:[30,30],iconAnchor:[15,15]}),s=L.marker(n,{icon:a}).addTo(map);s.bindPopup(`<strong>Start:</strong><br>${appConfig.routeStartAddress||"Brøstadveien 343"}`),routeMarkers.push(s),e.forEach((e,t)=>{const n=L.divIcon({className:"route-marker",html:`${t+1}`,iconSize:[30,30],iconAnchor:[15,15]}),a=L.marker([e.lat,e.lng],{icon:n}).addTo(map);routeMarkers.push(a)});const r=[n,...e.map(e=>[e.lat,e.lng])],i=L.latLngBounds(r);map.fitBounds(i,{padding:[50,50]}),showRouteInfo(e,t.properties.summary.duration,t.properties.summary.distance)}}catch(e){console.error("Enkel rute feil:",e),showMessage(e.message||"Kunne ikke beregne rute.","error")}}async function drawRoute(e){clearRoute();const t=[appConfig.routeStartLng||17.65274,appConfig.routeStartLat||69.06888],n=[appConfig.routeStartLat||69.06888,appConfig.routeStartLng||17.65274],a=[t,...e.map(e=>[e.lng,e.lat]),t];try{const e=await fetch("/api/routes/directions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify({coordinates:a})}),t=await e.json();t.features&&t.features.length>0&&drawRouteFromGeoJSON(t.features[0])}catch(e){console.error("Tegning av rute feil:",e)}const s=L.divIcon({className:"route-marker route-start",html:'<i class="fas fa-home"></i>',iconSize:[30,30],iconAnchor:[15,15]}),o=L.marker(n,{icon:s}).addTo(map);o.bindPopup(`<strong>Start:</strong><br>${appConfig.routeStartAddress||"Brøstadveien 343"}`),routeMarkers.push(o),e.forEach((e,t)=>{const n=L.divIcon({className:"route-marker",html:`${t+1}`,iconSize:[30,30],iconAnchor:[15,15]}),a=L.marker([e.lat,e.lng],{icon:n}).addTo(map);routeMarkers.push(a)});const r=[n,...e.map(e=>[e.lat,e.lng])],i=L.latLngBounds(r);map.fitBounds(i,{padding:[50,50]})}function drawRouteFromGeoJSON(e){clearRoute(),map.getPane("routePane")||(map.createPane("routePane"),map.getPane("routePane").style.zIndex=450),routeLayer=L.geoJSON(e,{pane:"routePane",style:{color:"#2563eb",weight:6,opacity:.9,lineCap:"round",lineJoin:"round"}}).addTo(map),routeLayer.bringToFront()}function clearRoute(){routeLayer&&(map.removeLayer(routeLayer),routeLayer=null),routeMarkers.forEach(e=>map.removeLayer(e)),routeMarkers=[]}let currentRouteData=null;function showRouteInfo(e,t,n){const a=document.getElementById("routeDetails");currentRouteData={customers:e,duration:t,distance:n};const s=e.map((e,t)=>`\n    <div class="route-stop">\n      <div class="stop-number">${t+1}</div>\n      <div class="stop-details">\n        <h4>${escapeHtml(e.navn)}</h4>\n        <p>${escapeHtml(e.adresse)}</p>\n        ${e.telefon?`<p>Tlf: ${escapeHtml(e.telefon)}</p>`:""}\n      </div>\n    </div>\n  `).join(""),o=Math.floor(t/3600),r=Math.floor(t%3600/60),i=(n/1e3).toFixed(1);a.innerHTML=`\n    ${s}\n    <div class="route-summary">\n      <p><strong>Total kjøretid:</strong> ${o>0?`${o}t `:""}${r} min</p>\n      <p><strong>Total distanse:</strong> ${i} km</p>\n      <p><strong>Antall stopp:</strong> ${e.length}</p>\n    </div>\n    <div class="route-actions">\n      <button id="saveRouteBtn" class="btn btn-primary">Lagre rute</button>\n      <button id="exportGoogleBtn" class="btn btn-secondary">Google Maps</button>\n      <button id="exportAppleBtn" class="btn btn-secondary">Apple Maps</button>\n    </div>\n  `,routeInfo.classList.remove("hidden"),document.getElementById("saveRouteBtn").addEventListener("click",showSaveRouteModal),document.getElementById("exportGoogleBtn").addEventListener("click",()=>exportToMaps("google")),document.getElementById("exportAppleBtn").addEventListener("click",()=>exportToMaps("apple"))}function navigateToCustomer(e,t,n){const a=/iPad|iPhone|iPod/.test(navigator.userAgent),s=appConfig.routeStartLat||69.06888,o=appConfig.routeStartLng||17.65274;if(a){const n=`https://maps.apple.com/?saddr=${s},${o}&daddr=${e},${t}&dirflg=d`;window.open(n,"_blank")}else{const n=`https://www.google.com/maps/dir/?api=1&origin=${s},${o}&destination=${e},${t}&travelmode=driving`;window.open(n,"_blank")}map.closePopup()}function exportToMaps(e){if(!currentRouteData||!currentRouteData.customers.length)return;const t=currentRouteData.customers,n=`${appConfig.routeStartLat||69.06888},${appConfig.routeStartLng||17.65274}`;if("google"===e){const e=t.map(e=>`${e.lat},${e.lng}`).join("|");let a=`https://www.google.com/maps/dir/?api=1&origin=${n}&destination=${n}`;e&&(a+=`&waypoints=${encodeURIComponent(e)}`),a+="&travelmode=driving",window.open(a,"_blank")}else if("apple"===e){const e=t.map(e=>`${e.lat},${e.lng}`);e.push(n);const a=`https://maps.apple.com/?saddr=${n}&daddr=${e.join("+to:")}&dirflg=d`;window.open(a,"_blank")}}function showSaveRouteModal(){const e=document.getElementById("saveRouteModal");document.getElementById("ruteNavn").value="",document.getElementById("ruteBeskrivelse").value="",document.getElementById("ruteDato").value="",e.classList.remove("hidden")}async function saveRoute(){if(!currentRouteData)return;const e=document.getElementById("ruteNavn").value.trim(),t=document.getElementById("ruteBeskrivelse").value.trim(),n=document.getElementById("ruteDato").value;if(e)try{(await apiFetch("/api/ruter",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:e,beskrivelse:t,planlagt_dato:n||null,total_distanse:currentRouteData.distance,total_tid:currentRouteData.duration,kunde_ids:currentRouteData.customers.map(e=>e.id)})})).ok&&(document.getElementById("saveRouteModal").classList.add("hidden"),await loadRoutes(),showMessage("Ruten er lagret!","success"))}catch(e){console.error("Feil ved lagring av rute:",e),showMessage("Kunne ikke lagre ruten. Prøv igjen.","error")}else showMessage("Skriv inn et navn for ruten","warning")}function renderSavedRoutes(){const e=document.getElementById("savedRoutesList");e&&(0!==savedRoutes.length?e.innerHTML=savedRoutes.map(e=>{const t=e.total_distanse?(e.total_distanse/1e3).toFixed(1):"-",n="fullført"===e.status?"status-completed":"status-planned";return`\n      <div class="saved-route-item" data-id="${e.id}">\n        <div class="route-header">\n          <h4>${escapeHtml(e.navn)}</h4>\n          <span class="route-status ${n}">${escapeHtml(e.status)}</span>\n        </div>\n        <p>${e.antall_kunder} kunder • ${t} km</p>\n        ${e.planlagt_dato?`<p class="route-date">Planlagt: ${formatDate(e.planlagt_dato)}</p>`:""}\n        <div class="route-item-actions">\n          <button class="btn btn-small btn-primary" data-action="loadSavedRoute" data-route-id="${e.id}">Last inn</button>\n          ${"fullført"!==e.status?`<button class="btn btn-small btn-success" data-action="completeRoute" data-route-id="${e.id}">Fullfør</button>`:""}\n          <button class="btn btn-small btn-danger" data-action="deleteRoute" data-route-id="${e.id}">Slett</button>\n        </div>\n      </div>\n    `}).join(""):e.innerHTML='<p class="no-routes">Ingen lagrede ruter</p>')}async function loadSavedRoute(e){try{const t=await apiFetch(`/api/ruter/${e}`);if(!t.ok)throw new Error(`HTTP ${t.status}: Kunne ikke laste rute`);const n=await t.json();selectedCustomers.clear(),n.kunder.forEach(e=>{selectedCustomers.add(e.id)}),updateSelectionUI(),await planRoute(),document.getElementById("routesPanel")?.classList.add("hidden")}catch(e){console.error("Feil ved lasting av rute:",e),showMessage("Kunne ikke laste ruten. Prøv igjen.","error")}}async function completeRoute(e){if(await showConfirm("Marker ruten som fullført? Dette vil oppdatere kontroll-datoene for alle kunder i ruten.","Fullfør rute"))try{(await apiFetch(`/api/ruter/${e}/complete`,{method:"POST",body:JSON.stringify({dato:(new Date).toISOString().split("T")[0]})})).ok&&(await loadRoutes(),await loadCustomers(),showMessage("Ruten er markert som fullført og kontroll-datoer er oppdatert!","success"))}catch(e){console.error("Feil ved fullføring av rute:",e),showMessage("Kunne ikke fullføre ruten. Prøv igjen.","error")}}async function deleteRoute(e){if(await showConfirm("Er du sikker på at du vil slette denne ruten?","Slette rute"))try{await apiFetch(`/api/ruter/${e}`,{method:"DELETE"}),await loadRoutes()}catch(e){console.error("Feil ved sletting av rute:",e),showMessage("Kunne ikke slette ruten. Prøv igjen.","error")}}function populateDynamicDropdowns(e=null){const t=document.getElementById("kategori");t&&(t.innerHTML=serviceTypeRegistry.renderCategoryOptions(e?.kategori||""));const n=document.getElementById("el_type");n&&(n.innerHTML=serviceTypeRegistry.renderSubtypeOptions("el-kontroll",e?.el_type||""));const a=document.getElementById("brann_system");a&&(a.innerHTML=serviceTypeRegistry.renderEquipmentOptions("brannvarsling",e?.brann_system||""));const s=document.getElementById("el_kontroll_intervall");s&&(s.innerHTML=serviceTypeRegistry.renderIntervalOptions(e?.el_kontroll_intervall||36));const o=document.getElementById("brann_kontroll_intervall");o&&(o.innerHTML=serviceTypeRegistry.renderIntervalOptions(e?.brann_kontroll_intervall||12));const r=document.getElementById("driftskategori");r&&(r.innerHTML=serviceTypeRegistry.renderDriftsOptions(e?.brann_driftstype||""))}function editCustomer(e){const t=customers.find(t=>t.id===e);t&&(populateDynamicDropdowns(t),document.getElementById("modalTitle").textContent="Rediger kunde",document.getElementById("customerId").value=t.id,document.getElementById("navn").value=t.navn||"",document.getElementById("adresse").value=t.adresse||"",document.getElementById("postnummer").value=t.postnummer||"",document.getElementById("poststed").value=t.poststed||"",document.getElementById("telefon").value=t.telefon||"",document.getElementById("epost").value=t.epost||"",document.getElementById("siste_kontroll").value=t.siste_kontroll||"",document.getElementById("neste_kontroll").value=t.neste_kontroll||"",document.getElementById("kontroll_intervall").value=t.kontroll_intervall_mnd||12,document.getElementById("notater").value=t.notater||"",document.getElementById("lat").value=t.lat||"",document.getElementById("lng").value=t.lng||"",updateGeocodeQualityBadge(t.geocode_quality||(t.lat?"exact":null)),document.getElementById("siste_el_kontroll").value=t.siste_el_kontroll||"",document.getElementById("neste_el_kontroll").value=t.neste_el_kontroll||"",document.getElementById("siste_brann_kontroll").value=t.siste_brann_kontroll||"",document.getElementById("neste_brann_kontroll").value=t.neste_brann_kontroll||"",updateControlSectionsVisibility(t.kategori),loadCustomerEmailSettings(t.id),populateCustomFields(t.custom_data),document.getElementById("kontaktloggSection").style.display="block",loadKontaktlogg(t.id),document.getElementById("deleteCustomerBtn").classList.remove("hidden"),customerModal.classList.remove("hidden"),highlightMissingFields(t))}function highlightMissingFields(e){document.querySelectorAll(".missing-field").forEach(e=>e.classList.remove("missing-field"));[{id:"telefon",value:e.telefon},{id:"epost",value:e.epost},{id:"neste_el_kontroll",value:e.neste_el_kontroll,condition:e.kategori?.includes("El-Kontroll")},{id:"neste_brann_kontroll",value:e.neste_brann_kontroll,condition:e.kategori?.includes("Brann")}].forEach(e=>{if(!1===e.condition)return;const t=document.getElementById(e.id);!t||e.value&&""!==e.value.trim()||t.classList.add("missing-field")})}async function loadOrganizationFields(){try{const e=await apiFetch("/api/fields");e.ok&&(organizationFields=await e.json(),renderCustomFieldsInForm(),renderDynamicFieldFilters(),Logger.log("Loaded organization fields:",organizationFields.length))}catch(e){Logger.warn("Could not load organization fields:",e),organizationFields=[]}}async function loadOrganizationCategories(){try{const e=await apiFetch("/api/fields/categories");e.ok&&(organizationCategories=await e.json(),Logger.log("Loaded organization categories:",organizationCategories.length))}catch(e){Logger.warn("Could not load organization categories:",e),organizationCategories=[]}}function renderPopupCustomFields(e){const t=organizationFields.filter(e=>e.is_visible&&0!==e.is_visible);if(0===t.length)return"";let n=e.custom_data;if("string"==typeof n)try{n=JSON.parse(n)}catch{n={}}n=n||{};let a="";for(const e of t){const t=n[e.field_name];if(null!=t&&""!==t){let n=t;if("date"===e.field_type)try{n=new Date(t).toLocaleDateString("no-NO")}catch{n=t}else if("select"===e.field_type&&e.options){const a=e.options.find(e=>e.value===t);n=a?.display_name||t}a+=`<p><strong>${escapeHtml(e.display_name)}:</strong> ${escapeHtml(String(n))}</p>`}}return a}function renderCustomFieldsInForm(){const e=document.getElementById("customFieldsSection"),t=document.getElementById("customFieldsContainer");if(!e||!t)return;const n=organizationFields.filter(e=>e.is_visible);0!==n.length?(e.classList.remove("hidden"),t.innerHTML=n.map(e=>{const t=`custom_${e.field_name}`,n=e.is_required?"required":"",a=e.is_required?" *":"";let s="";switch(e.field_type){case"select":s=`\n          <select id="${t}" ${n}>\n            <option value="">-- Velg --</option>\n            ${(e.options||[]).map(e=>`<option value="${escapeHtml(e.value)}">${escapeHtml(e.display_name||e.value)}</option>`).join("")}\n          </select>\n        `;break;case"date":s=`<input type="date" id="${t}" ${n}>`;break;case"number":s=`<input type="number" id="${t}" ${n}>`;break;default:s=`<input type="text" id="${t}" ${n}>`}return`\n      <div class="form-group">\n        <label for="${t}">${escapeHtml(e.display_name)}${a}</label>\n        ${s}\n      </div>\n    `}).join("")):e.classList.add("hidden")}function populateCustomFields(e){if(!e)return;let t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){t={}}for(const e of organizationFields){const n=document.getElementById(`custom_${e.field_name}`);n&&void 0!==t[e.field_name]&&(n.value=t[e.field_name])}}function clearCustomFields(){for(const e of organizationFields){const t=document.getElementById(`custom_${e.field_name}`);t&&(t.value="")}}function collectCustomFieldValues(){const e={};for(const t of organizationFields){const n=document.getElementById(`custom_${t.field_name}`);n&&n.value&&(e[t.field_name]=n.value)}return e}function getFieldTypeName(e){return{text:"Tekst",select:"Rullegardin",number:"Tall",date:"Dato"}[e]||e}function renderAdminFields(){const e=document.getElementById("fieldsList"),t=document.getElementById("fieldsEmpty");if(e){if(0===organizationFields.length)return e.style.display="none",void(t&&(t.style.display="block"));e.style.display="flex",t&&(t.style.display="none"),e.innerHTML=organizationFields.map((e,t)=>`\n    <div class="sortable-item" data-id="${e.id}" data-index="${t}" draggable="true">\n      <div class="drag-handle">\n        <i class="fas fa-grip-vertical"></i>\n      </div>\n      <div class="item-info">\n        <span class="item-name">${escapeHtml(e.display_name)}</span>\n        <span class="item-meta">\n          ${escapeHtml(e.field_name)} | ${getFieldTypeName(e.field_type)}\n          ${e.is_filterable?'<span class="badge">Filter</span>':""}\n          ${e.is_required?'<span class="badge warning">Obligatorisk</span>':""}\n          ${e.is_visible?"":'<span class="badge muted">Skjult</span>'}\n        </span>\n      </div>\n      <div class="item-actions">\n        <button class="btn-icon" onclick="openFieldModal(${e.id})" title="Rediger">\n          <i class="fas fa-edit"></i>\n        </button>\n        <button class="btn-icon danger" onclick="confirmDeleteField(${e.id})" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </div>\n    </div>\n  `).join(""),initSortable(e,"fields")}}function openFieldModal(e=null){const t=document.getElementById("fieldModal"),n=document.getElementById("fieldModalTitle"),a=document.getElementById("deleteFieldBtn"),s=document.getElementById("fieldName");if(document.getElementById("fieldForm").reset(),document.getElementById("fieldId").value="",document.getElementById("fieldVisible").checked=!0,document.getElementById("fieldOptionsSection").style.display="none",document.getElementById("fieldOptionsList").innerHTML="",e){const t=organizationFields.find(t=>t.id===e);if(!t)return;n.textContent="Rediger felt",document.getElementById("fieldId").value=t.id,document.getElementById("fieldDisplayName").value=t.display_name,s.value=t.field_name,s.disabled=!0,document.getElementById("fieldType").value=t.field_type,document.getElementById("fieldFilterable").checked=1===t.is_filterable||!0===t.is_filterable,document.getElementById("fieldRequired").checked=1===t.is_required||!0===t.is_required,document.getElementById("fieldVisible").checked=1===t.is_visible||!0===t.is_visible,"select"===t.field_type&&(document.getElementById("fieldOptionsSection").style.display="block",renderFieldOptions(t.options||[])),a.style.display="inline-block"}else n.textContent="Nytt felt",s.disabled=!1,a.style.display="none";t.classList.remove("hidden")}function renderFieldOptions(e){document.getElementById("fieldOptionsList").innerHTML=e.map((e,t)=>`\n    <div class="option-item" data-index="${t}" data-id="${e.id||""}">\n      <input type="text" class="option-value" value="${escapeHtml(e.value||"")}" placeholder="Verdi">\n      <input type="text" class="option-display" value="${escapeHtml(e.display_name||"")}" placeholder="Visningsnavn">\n      <button type="button" class="btn-icon danger" onclick="removeFieldOption(this)" title="Fjern">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `).join("")}function addFieldOption(){const e=document.getElementById("fieldOptionsList"),t=`\n    <div class="option-item" data-index="${e.children.length}" data-id="">\n      <input type="text" class="option-value" placeholder="Verdi">\n      <input type="text" class="option-display" placeholder="Visningsnavn">\n      <button type="button" class="btn-icon danger" onclick="removeFieldOption(this)" title="Fjern">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `;e.insertAdjacentHTML("beforeend",t)}function removeFieldOption(e){const t=e.closest(".option-item");t&&t.remove()}async function saveField(e){e.preventDefault();const t=document.getElementById("fieldId").value,n={field_name:document.getElementById("fieldName").value,display_name:document.getElementById("fieldDisplayName").value,field_type:document.getElementById("fieldType").value,is_filterable:document.getElementById("fieldFilterable").checked?1:0,is_required:document.getElementById("fieldRequired").checked?1:0,is_visible:document.getElementById("fieldVisible").checked?1:0};try{const e=t?`/api/fields/${t}`:"/api/fields",a=t?"PUT":"POST",s=await apiFetch(e,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok){const e=await s.json();throw new Error(e.error||"Kunne ikke lagre felt")}const o=await s.json();"select"===n.field_type&&await saveFieldOptions(o.id||t),await loadOrganizationFields(),renderAdminFields(),document.getElementById("fieldModal").classList.add("hidden"),showToast("Felt lagret","success")}catch(e){showToast(e.message,"error")}}async function saveFieldOptions(e){const t=document.querySelectorAll("#fieldOptionsList .option-item"),n=organizationFields.find(t=>t.id===parseInt(e)),a=n?.options||[],s=[];t.forEach((e,t)=>{const n=e.querySelector(".option-value").value.trim(),a=e.querySelector(".option-display").value.trim(),o=e.dataset.id;n&&s.push({id:o?parseInt(o):null,value:n,display_name:a||n,sort_order:t})});for(const t of a){if(!s.some(e=>e.id===t.id))try{await apiFetch(`/api/fields/${e}/options/${t.id}`,{method:"DELETE"})}catch(e){Logger.warn("Could not delete option:",e)}}for(const t of s)if(!t.id)try{await apiFetch(`/api/fields/${e}/options`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(e){Logger.warn("Could not add option:",e)}}async function confirmDeleteField(e){if(await showConfirm("Er du sikker på at du vil slette dette feltet? Data i kunderegistreringer vil bli beholdt, men ikke lenger vises.","Slette felt"))try{if(!(await apiFetch(`/api/fields/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette felt");await loadOrganizationFields(),renderAdminFields(),renderDynamicFieldFilters(),showToast("Felt slettet","success")}catch(e){showToast(e.message,"error")}}function renderAdminCategories(){const e=document.getElementById("categoriesList"),t=document.getElementById("categoriesEmpty");if(e){if(0===organizationCategories.length)return e.style.display="none",void(t&&(t.style.display="block"));e.style.display="flex",t&&(t.style.display="none"),e.innerHTML=organizationCategories.map((e,t)=>`\n    <div class="sortable-item" data-id="${e.id}" data-index="${t}" draggable="true">\n      <div class="drag-handle">\n        <i class="fas fa-grip-vertical"></i>\n      </div>\n      <div class="item-info">\n        <span class="item-name">\n          <i class="fas ${escapeHtml(e.icon||"fa-tag")}" style="color: ${escapeHtml(e.color||"#6B7280")}; margin-right: 8px;"></i>\n          ${escapeHtml(e.name)}\n        </span>\n        <span class="item-meta">\n          ${escapeHtml(e.slug)} | ${e.default_interval_months||12} mnd intervall\n        </span>\n      </div>\n      <div class="item-actions">\n        <button class="btn-icon" onclick="openCategoryModal(${e.id})" title="Rediger">\n          <i class="fas fa-edit"></i>\n        </button>\n        <button class="btn-icon danger" onclick="confirmDeleteCategory(${e.id})" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </div>\n    </div>\n  `).join(""),initSortable(e,"categories")}}function openCategoryModal(e=null){const t=document.getElementById("categoryModal"),n=document.getElementById("categoryModalTitle"),a=document.getElementById("deleteCategoryBtn");if(document.getElementById("categoryForm").reset(),document.getElementById("categoryId").value="",document.getElementById("categoryColor").value="#6B7280",document.getElementById("categoryInterval").value="12",e){const t=organizationCategories.find(t=>t.id===e);if(!t)return;n.textContent="Rediger kategori",document.getElementById("categoryId").value=t.id,document.getElementById("categoryName").value=t.name,document.getElementById("categorySlug").value=t.slug,document.getElementById("categoryIcon").value=t.icon||"fa-tag",document.getElementById("categoryColor").value=t.color||"#6B7280",document.getElementById("categoryInterval").value=t.default_interval_months||12,a.style.display="inline-block"}else n.textContent="Ny kategori",a.style.display="none";t.classList.remove("hidden")}async function saveCategory(e){e.preventDefault();const t=document.getElementById("categoryId").value,n={name:document.getElementById("categoryName").value,slug:document.getElementById("categorySlug").value,icon:document.getElementById("categoryIcon").value,color:document.getElementById("categoryColor").value,default_interval_months:parseInt(document.getElementById("categoryInterval").value)||12};try{const e=t?`/api/fields/categories/${t}`:"/api/fields/categories",a=t?"PUT":"POST",s=await apiFetch(e,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok){const e=await s.json();throw new Error(e.error||"Kunne ikke lagre kategori")}await loadOrganizationCategories(),renderAdminCategories(),document.getElementById("categoryModal").classList.add("hidden"),showToast("Kategori lagret","success")}catch(e){showToast(e.message,"error")}}async function confirmDeleteCategory(e){if(await showConfirm("Er du sikker på at du vil slette denne kategorien?","Slette kategori"))try{if(!(await apiFetch(`/api/fields/categories/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette kategori");await loadOrganizationCategories(),renderAdminCategories(),showToast("Kategori slettet","success")}catch(e){showToast(e.message,"error")}}function initSortable(e,t){if(!e)return;if("true"===e.dataset.sortableInitialized)return;e.dataset.sortableInitialized="true";let n=null;e.addEventListener("dragstart",e=>{const t=e.target.closest(".sortable-item");t&&(n=t,n.classList.add("dragging"),e.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{n&&(n.classList.remove("dragging"),updateSortOrder(e,t),n=null)}),e.addEventListener("dragover",t=>{if(t.preventDefault(),!n)return;const a=getDragAfterElement(e,t.clientY);null==a?e.appendChild(n):e.insertBefore(n,a)})}function getDragAfterElement(e,t){return[...e.querySelectorAll(".sortable-item:not(.dragging)")].reduce((e,n)=>{const a=n.getBoundingClientRect(),s=t-a.top-a.height/2;return s<0&&s>e.offset?{offset:s,element:n}:e},{offset:Number.NEGATIVE_INFINITY}).element}async function updateSortOrder(e,t){const n=e.querySelectorAll(".sortable-item"),a=[];n.forEach((e,t)=>{a.push({id:parseInt(e.dataset.id),sort_order:t})});try{for(const e of a){const n="fields"===t?`/api/fields/${e.id}`:`/api/fields/categories/${e.id}`;await apiFetch(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({sort_order:e.sort_order})})}"fields"===t?await loadOrganizationFields():await loadOrganizationCategories()}catch(e){Logger.error("Failed to update sort order:",e),showToast("Kunne ikke oppdatere rekkefølge","error")}}function addCustomer(){populateDynamicDropdowns(null),document.getElementById("modalTitle").textContent="Ny kunde",customerForm.reset(),document.getElementById("customerId").value="",document.getElementById("kontroll_intervall").value=12,document.getElementById("lat").value="",document.getElementById("lng").value="",updateGeocodeQualityBadge(null),clearCustomFields(),document.getElementById("siste_el_kontroll").value="",document.getElementById("neste_el_kontroll").value="",document.getElementById("el_kontroll_intervall").value=36,document.getElementById("siste_brann_kontroll").value="",document.getElementById("neste_brann_kontroll").value="",document.getElementById("brann_kontroll_intervall").value=12;const e=document.getElementById("kategori");updateControlSectionsVisibility(e?e.value:"El-Kontroll");const t=document.getElementById("emailAktiv"),n=document.getElementById("forsteVarsel"),a=document.getElementById("paaminnelseEtter"),s=document.getElementById("emailOptions");t&&(t.checked=!0),n&&(n.value=30),a&&(a.value=7),s&&s.classList.remove("hidden"),document.getElementById("kontaktloggSection").style.display="none",document.getElementById("kontaktloggList").innerHTML="",document.getElementById("deleteCustomerBtn").classList.add("hidden"),customerModal.classList.remove("hidden")}function updateControlSectionsVisibility(e){const t=document.getElementById("elKontrollSection"),n=document.getElementById("brannvarslingSection");if(!t||!n)return;const a=(e||"").toLowerCase();a.includes("el")&&a.includes("brann")?(t.style.display="block",n.style.display="block"):a.includes("brann")?(t.style.display="none",n.style.display="block"):(t.style.display="block",n.style.display="none")}async function geocodeAddressAuto(e,t,n){const a=`${e}, ${t} ${n}, Norway`;try{const e=`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(a)}&fuzzy=true&treffPerSide=1`,t=await fetch(e),n=await t.json();if(n.adresser&&n.adresser.length>0){const e=n.adresser[0];if(e.representasjonspunkt)return{lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon}}}catch(e){Logger.log("Kartverket geocode failed:",e)}try{const e=`${t} ${n}`,a=`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(e)}&fuzzy=true&treffPerSide=1`,s=await fetch(a),o=await s.json();if(o.adresser&&o.adresser.length>0){const e=o.adresser[0];if(e.representasjonspunkt)return{lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon}}}catch(e){Logger.log("Kartverket poststed geocode failed:",e)}try{const e=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,t=await fetch(e),n=await t.json();if(n&&n.length>0)return{lat:Number.parseFloat(n[0].lat),lng:Number.parseFloat(n[0].lon)}}catch(e){Logger.log("Nominatim geocode failed:",e)}return null}async function saveCustomer(e){e.preventDefault();const t=document.getElementById("customerId").value;let n=Number.parseFloat(document.getElementById("lat").value)||null,a=Number.parseFloat(document.getElementById("lng").value)||null;const s=document.getElementById("adresse").value,o=document.getElementById("postnummer").value,r=document.getElementById("poststed").value;if(!n||!a){showNotification("Geokoder adresse...");const e=await geocodeAddressAuto(s,o,r);e&&(n=e.lat,a=e.lng,document.getElementById("lat").value=n,document.getElementById("lng").value=a)}const i=document.getElementById("kategori").value||"El-Kontroll",l={navn:document.getElementById("navn").value,adresse:s,postnummer:o,poststed:r,telefon:document.getElementById("telefon").value,epost:document.getElementById("epost").value,lat:n,lng:a,siste_kontroll:document.getElementById("siste_kontroll").value||null,neste_kontroll:document.getElementById("neste_kontroll").value||null,kontroll_intervall_mnd:Number.parseInt(document.getElementById("kontroll_intervall").value)||12,kategori:i,notater:document.getElementById("notater").value,el_type:document.getElementById("el_type")?document.getElementById("el_type").value:null,siste_el_kontroll:document.getElementById("siste_el_kontroll").value||null,neste_el_kontroll:document.getElementById("neste_el_kontroll").value||null,el_kontroll_intervall:Number.parseInt(document.getElementById("el_kontroll_intervall").value)||36,brann_system:document.getElementById("brann_system")?document.getElementById("brann_system").value:null,siste_brann_kontroll:document.getElementById("siste_brann_kontroll").value||null,neste_brann_kontroll:document.getElementById("neste_brann_kontroll").value||null,brann_kontroll_intervall:Number.parseInt(document.getElementById("brann_kontroll_intervall").value)||12,brann_driftstype:document.getElementById("driftskategori").value||null,custom_data:JSON.stringify(collectCustomFieldValues())};try{const e=t?`/api/kunder/${t}`:"/api/kunder",n=t?"PUT":"POST";Logger.log("Saving customer:",{url:e,method:n,data:l});const a=await apiFetch(e,{method:n,body:JSON.stringify(l)}),s=await a.json();if(Logger.log("Server response:",a.status,s),!a.ok){return void showMessage("Kunne ikke lagre: "+(s.errors?s.errors.join(", "):s.error||"Ukjent feil"),"error")}const o=t||s.id;o&&await saveCustomerEmailSettings(o),customerModal.classList.add("hidden"),currentFilter="alle",showOnlyWarnings=!1;const r=document.getElementById("omradeSelect");r&&(r.value="alle"),await loadCustomers(),await loadOmrader(),showNotification("Kunde lagret!")}catch(e){console.error("Lagring feilet:",e),showMessage("Kunne ikke lagre kunden: "+e.message,"error")}}async function deleteCustomer(){const e=document.getElementById("customerId").value;if(!e)return;const t=document.getElementById("navn").value||"denne kunden";if(await showConfirm(`Er du sikker på at du vil slette "${t}"? Dette kan ikke angres.`,"Slette kunde"))try{await apiFetch(`/api/kunder/${e}`,{method:"DELETE"}),customerModal.classList.add("hidden"),selectedCustomers.delete(Number.parseInt(e)),await loadCustomers(),await loadOmrader(),updateSelectionUI()}catch(e){console.error("Sletting feilet:",e),showMessage("Kunne ikke slette kunden. Prøv igjen senere.","error")}}async function handleGeocode(){const e=document.getElementById("adresse").value,t=document.getElementById("postnummer").value,n=document.getElementById("poststed").value;if(!e)return void showMessage("Skriv inn en adresse først","warning");const a=document.getElementById("geocodeBtn");a.classList.add("loading"),a.disabled=!0;const s=await geocodeAddress(e,t,n);a.classList.remove("loading"),a.disabled=!1,s?(document.getElementById("lat").value=s.lat,document.getElementById("lng").value=s.lng,updateGeocodeQualityBadge("exact"),showNotification("Koordinater funnet!","success")):showMessage("Kunne ikke finne koordinater for adressen. Sjekk at adressen er riktig.","warning")}let isPickingCoordinates=!1,pickingIndicator=null;function enableCoordinatePicking(){if(isPickingCoordinates)return void disableCoordinatePicking();isPickingCoordinates=!0;document.getElementById("customerModal").classList.add("hidden");document.getElementById("sharedMapContainer").classList.add("map-picking-mode"),pickingIndicator=document.createElement("div"),pickingIndicator.className="picking-mode-indicator",pickingIndicator.innerHTML='<i class="fas fa-crosshairs"></i> Klikk på kartet for å velge posisjon',document.body.appendChild(pickingIndicator),map.once("click",handleMapPick),document.addEventListener("keydown",handlePickingEscape)}function handleMapPick(e){const t=e.latlng.lat,n=e.latlng.lng;document.getElementById("lat").value=t.toFixed(6),document.getElementById("lng").value=n.toFixed(6),updateGeocodeQualityBadge("manual"),showNotification(`Koordinater valgt: ${t.toFixed(4)}, ${n.toFixed(4)}`,"success"),disableCoordinatePicking();document.getElementById("customerModal").classList.remove("hidden")}function handlePickingEscape(e){if("Escape"===e.key&&isPickingCoordinates){disableCoordinatePicking();document.getElementById("customerModal").classList.remove("hidden"),showNotification("Avbrutt","info")}}function disableCoordinatePicking(){isPickingCoordinates=!1;document.getElementById("sharedMapContainer").classList.remove("map-picking-mode"),pickingIndicator&&(pickingIndicator.remove(),pickingIndicator=null),map.off("click",handleMapPick),document.removeEventListener("keydown",handlePickingEscape)}function updateGeocodeQualityBadge(e){const t=document.getElementById("geocodeQualityBadge"),n=document.getElementById("geocodeWarning");if(t)switch(t.className="geocode-quality-badge",e){case"exact":t.textContent="Eksakt",t.classList.add("quality-exact"),n&&(n.style.display="none");break;case"street":t.textContent="Gate-nivå",t.classList.add("quality-street"),n&&(n.style.display="none");break;case"area":t.textContent="Område-nivå",t.classList.add("quality-area"),n&&(n.style.display="flex");break;case"manual":t.textContent="Manuelt valgt",t.classList.add("quality-manual"),n&&(n.style.display="none");break;default:t.textContent="",n&&(n.style.display="none")}}function formatDate(e){if(!e)return"";return new Date(e).toLocaleDateString("nb-NO")}function formatDateShort(e){if(!e)return"";return new Date(e).toLocaleDateString("nb-NO",{day:"2-digit",month:"short"})}function saveApiKey(){const e=document.getElementById("apiKey").value.trim();e&&(localStorage.setItem("ors_api_key",e),apiKeyModal.classList.add("hidden"),planRoute())}let customerAdminKategori="alle",customerAdminSearch="";function renderCustomerAdmin(){const e=document.getElementById("customerAdminList"),t=document.getElementById("customerCountDisplay");if(!e)return;e.dataset.delegationSetup||(e.dataset.delegationSetup="true",e.addEventListener("click",e=>{if(e.target.classList.contains("bulk-checkbox")){e.stopPropagation();const t=Number.parseInt(e.target.dataset.id);return e.target.checked?bulkSelectedCustomers.add(t):bulkSelectedCustomers.delete(t),void updateBulkSelectionUI()}const t=e.target.closest(".customer-admin-item");if(!t)return;const n=Number.parseInt(t.dataset.id);e.target.classList.contains("bulk-checkbox")||editCustomer(n)}));let n=[...customers];if("alle"!==customerAdminKategori){const e=n.length;n=n.filter(e=>serviceTypeRegistry.matchesCategory(e,customerAdminKategori)),Logger.log(`Filter: "${customerAdminKategori}" - ${e} -> ${n.length} kunder`)}if(customerAdminSearch){const e=customerAdminSearch.toLowerCase();n=n.filter(t=>t.navn.toLowerCase().includes(e)||t.adresse&&t.adresse.toLowerCase().includes(e)||t.poststed&&t.poststed.toLowerCase().includes(e))}sortByNavn(n),t&&(t.textContent=`${n.length} av ${customers.length} kunder`),0!==n.length?(e.innerHTML=n.map(e=>{const t=e.lat&&e.lng;let n="";const a=new Date;if(a.setHours(0,0,0,0),("El-Kontroll"===e.kategori||"El-Kontroll + Brannvarsling"===e.kategori)&&e.neste_el_kontroll){const t=new Date(e.neste_el_kontroll),s=Math.ceil((t-a)/864e5);n+=`<span class="control-badge ${s<0?"overdue":s<=30?"warning":"ok"}">El: ${escapeHtml(formatDateShort(e.neste_el_kontroll))}</span>`}if(("Brannvarsling"===e.kategori||"El-Kontroll + Brannvarsling"===e.kategori)&&e.neste_brann_kontroll){const t=new Date(e.neste_brann_kontroll),s=Math.ceil((t-a)/864e5);n+=`<span class="control-badge ${s<0?"overdue":s<=30?"warning":"ok"}">Brann: ${escapeHtml(formatDateShort(e.neste_brann_kontroll))}</span>`}const s=bulkSelectedCustomers.has(e.id);return`\n      <div class="customer-admin-item ${t?"":"no-coords"} ${s?"bulk-selected":""}" data-id="${e.id}">\n        <input type="checkbox" class="bulk-checkbox" data-id="${e.id}" ${s?"checked":""} onclick="event.stopPropagation()">\n        <div class="customer-info">\n          <span class="customer-name">${escapeHtml(e.navn)}</span>\n          <span class="customer-location">${escapeHtml(e.poststed||"")}</span>\n          ${n}\n        </div>\n      </div>\n    `}).join(""),updateBulkSelectionUI()):e.innerHTML='<div style="padding: 20px; text-align: center; color: var(--color-text-muted);">Ingen kunder funnet</div>'}async function deleteCustomerAdmin(e){const t=customers.find(t=>t.id===e);if(!t)return;if(await showConfirm(`Er du sikker på at du vil slette "${t.navn}"? Dette kan ikke angres.`,"Slette kunde"))try{(await apiFetch(`/api/kunder/${e}`,{method:"DELETE"})).ok&&(await loadCustomers(),await loadOmrader(),showNotification("Kunde slettet"))}catch(e){console.error("Feil ved sletting:",e),showMessage("Kunne ikke slette kunden. Prøv igjen senere.","error")}}function renderOverdue(){const e=document.getElementById("overdueContainer"),t=document.getElementById("overdueCountHeader"),n=document.getElementById("overdueSortSelect"),a=n?.value||"days",s=new Date;s.setHours(0,0,0,0);let o=customers.filter(e=>{if(!e.neste_kontroll)return!1;return new Date(e.neste_kontroll)<s});o=o.map(e=>{const t=new Date(e.neste_kontroll),n=Math.ceil((s-t)/864e5);return{...e,daysOverdue:n}}),"days"===a?o.sort((e,t)=>e.daysOverdue-t.daysOverdue):"days-desc"===a?o.sort((e,t)=>t.daysOverdue-e.daysOverdue):"name"===a?sortByNavn(o):"category"===a?o.sort((e,t)=>{const n=e.kategori||"Annen",a=t.kategori||"Annen";return n!==a?compareNorwegian(n,a):e.daysOverdue-t.daysOverdue}):"area"===a&&o.sort((e,t)=>{const n=e.poststed||"Ukjent",a=t.poststed||"Ukjent";return n!==a?compareNorwegian(n,a):e.daysOverdue-t.daysOverdue}),updateBadge("overdueBadge",o.length),t&&(t.textContent=o.length>0?`(${o.length} stk)`:"");let r="";if(0===o.length)r='\n      <div class="overdue-empty">\n        <i class="fas fa-check-circle"></i>\n        <p>Ingen forfalte kontroller</p>\n        <span>Bra jobba!</span>\n      </div>\n    ';else{const e=o.filter(e=>e.daysOverdue>60),t=o.filter(e=>e.daysOverdue>30&&e.daysOverdue<=60),n=o.filter(e=>e.daysOverdue<=30),s=(e,t,n)=>0===t.length?"":`\n        <div class="overdue-section overdue-${n}">\n          <div class="overdue-section-header">\n            <span class="overdue-severity-dot ${n}"></span>\n            ${e} (${t.length})\n          </div>\n          ${t.map(e=>`\n            <div class="overdue-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n              <div class="overdue-customer-info">\n                <div class="overdue-customer-main">\n                  <h4>${escapeHtml(e.navn)}</h4>\n                  <span class="overdue-category">${escapeHtml(e.kategori||"Ukjent")}</span>\n                </div>\n                <p class="overdue-address">${escapeHtml(e.adresse)}, ${escapeHtml(e.poststed||"")}</p>\n                ${e.telefon?`<a href="tel:${e.telefon}" class="overdue-phone" onclick="event.stopPropagation();"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</a>`:""}\n              </div>\n              <div class="overdue-status">\n                <span class="overdue-days">${e.daysOverdue} dager</span>\n                <span class="overdue-date">${formatDate(e.neste_kontroll)}</span>\n                <button class="btn-remind" data-action="sendReminder" data-customer-id="${e.id}" title="Send påminnelse">\n                  <i class="fas fa-envelope"></i>\n                </button>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      `,i=e=>e.map(e=>`\n        <div class="overdue-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n          <div class="overdue-customer-info">\n            <div class="overdue-customer-main">\n              <h4>${escapeHtml(e.navn)}</h4>\n              <span class="overdue-days-inline ${e.daysOverdue>60?"critical":e.daysOverdue>30?"warning":"mild"}">${e.daysOverdue}d forfalt</span>\n            </div>\n            <p class="overdue-address">${escapeHtml(e.adresse)}, ${escapeHtml(e.poststed||"")}</p>\n            ${e.telefon?`<a href="tel:${e.telefon}" class="overdue-phone" onclick="event.stopPropagation();"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</a>`:""}\n          </div>\n          <div class="overdue-status">\n            <span class="overdue-date">${formatDate(e.neste_kontroll)}</span>\n            <button class="btn-remind" data-action="sendReminder" data-customer-id="${e.id}" title="Send påminnelse">\n              <i class="fas fa-envelope"></i>\n            </button>\n          </div>\n        </div>\n      `).join("");if("category"===a){const e={};o.forEach(t=>{const n=t.kategori||"Annen";e[n]||(e[n]=[]),e[n].push(t)}),Object.keys(e).sort((e,t)=>e.localeCompare(t,"no")).forEach(t=>{const n=e[t].map(e=>e.id).join(",");r+=`\n          <div class="overdue-section">\n            <div class="overdue-section-header">\n              <i class="fas fa-folder"></i>\n              ${escapeHtml(t)} (${e[t].length})\n              <button class="btn-group-route" data-action="createRouteFromGroup" data-customer-ids="${n}" title="Lag rute for denne gruppen">\n                <i class="fas fa-route"></i>\n              </button>\n            </div>\n            ${i(e[t])}\n          </div>\n        `})}else if("area"===a){const e={};o.forEach(t=>{const n=t.poststed||"Ukjent område";e[n]||(e[n]=[]),e[n].push(t)}),Object.keys(e).sort(compareNorwegian).forEach(t=>{const n=e[t].map(e=>e.id).join(",");r+=`\n          <div class="overdue-section overdue-area-section">\n            <div class="overdue-section-header">\n              <i class="fas fa-map-marker-alt"></i>\n              ${escapeHtml(t)} (${e[t].length})\n              <button class="btn-group-route" data-action="createRouteFromGroup" data-customer-ids="${n}" title="Lag rute for ${escapeHtml(t)}">\n                <i class="fas fa-route"></i>\n              </button>\n              <button class="btn-group-map" data-action="showGroupOnMap" data-customer-ids="${n}" title="Vis på kart">\n                <i class="fas fa-map"></i>\n              </button>\n            </div>\n            ${i(e[t])}\n          </div>\n        `})}else"days"===a?(r+=s("Nylig forfalt (1-30 dager)",n,"mild"),r+=s("Advarsel (31-60 dager)",t,"warning"),r+=s("Kritisk (over 60 dager)",e,"critical")):(r+=s("Kritisk (over 60 dager)",e,"critical"),r+=s("Advarsel (31-60 dager)",t,"warning"),r+=s("Nylig forfalt (1-30 dager)",n,"mild"))}e.innerHTML=r}function updateOverdueBadge(){const e=new Date;e.setHours(0,0,0,0);updateBadge("overdueBadge",customers.filter(t=>{const n=[t.neste_el_kontroll,t.neste_brann_kontroll,t.neste_kontroll].filter(Boolean);return 0!==n.length&&n.some(t=>new Date(t)<e)}).length),updateUpcomingBadge()}function updateUpcomingBadge(){const e=new Date;e.setHours(0,0,0,0);const t=new Date(e);t.setDate(t.getDate()+30);updateBadge("upcomingBadge",customers.filter(n=>{const a=getNextControlDate(n);return!!a&&(a>=e&&a<=t)}).length)}function renderWarnings(){const e=document.getElementById("warningsContainer"),t=new Date;t.setHours(0,0,0,0);const n=new Date(t);n.setDate(n.getDate()+30);const a=customers.filter(e=>{const a=getNextControlDate(e);return!!a&&(a>=t&&a<=n)}).map(e=>({...e,_nextDate:getNextControlDate(e)})),s={};a.forEach(e=>{const t=e.kategori||"Annen";s[t]||(s[t]=[]),s[t].push(e)}),Object.values(s).forEach(sortByNavn);let o="";if(0===a.length)o='<p style="padding: 20px; text-align: center; color: #666;">Ingen kommende kontroller</p>';else{const e=["El-Kontroll","Brannvarsling"];Object.keys(s).sort((t,n)=>{const a=e.indexOf(t),s=e.indexOf(n);return(-1===a?999:a)-(-1===s?999:s)}).forEach(e=>{o+=`<div class="warning-section">\n        <div class="warning-header">${escapeHtml(e)} (${s[e].length})</div>\n        ${s[e].map(e=>{const n=getControlStatus(e),a=Math.ceil((e._nextDate-t)/864e5),s=e._nextDate.toISOString().split("T")[0];return`\n            <div class="warning-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n              <div class="warning-customer">\n                <h4>${escapeHtml(e.navn)}</h4>\n                <p>${escapeHtml(e.adresse)} (${escapeHtml(e.postnummer)})</p>\n              </div>\n              <div class="warning-date">\n                <span class="control-status ${n.class}">${a} dager</span>\n                <p style="font-size: 10px; color: #666; margin: 2px 0 0 0;">${escapeHtml(s)}</p>\n              </div>\n            </div>\n          `}).join("")}\n      </div>`})}e.innerHTML=o}async function loadAvtaler(){try{const e=await apiFetch("/api/avtaler");if(e.ok){const t=await e.json();avtaler=t.data||t}}catch(e){console.error("Error loading avtaler:",e)}}async function renderCalendar(){const e=document.getElementById("calendarContainer");if(!e)return;0===avtaler.length&&await loadAvtaler();const t=new Date;t.setHours(0,0,0,0);const n=savedRoutes.filter(e=>{if(!e.planlagt_dato)return!1;const t=new Date(e.planlagt_dato);return t.getMonth()===currentCalendarMonth&&t.getFullYear()===currentCalendarYear}),a=avtaler.filter(e=>{const t=new Date(e.dato);return t.getMonth()===currentCalendarMonth&&t.getFullYear()===currentCalendarYear}),s=new Date(currentCalendarYear,currentCalendarMonth+1,0).getDate(),o=new Date(currentCalendarYear,currentCalendarMonth,1).getDay(),r=["Januar","Februar","Mars","April","Mai","Juni","Juli","August","September","Oktober","November","Desember"];let i=`\n    <div class="calendar-header">\n      <button class="calendar-nav" id="prevMonth"><i class="fas fa-chevron-left"></i></button>\n      <h3>${r[currentCalendarMonth]} ${currentCalendarYear}</h3>\n      <button class="calendar-nav" id="nextMonth"><i class="fas fa-chevron-right"></i></button>\n      <button class="btn btn-primary calendar-add-btn" id="addAvtaleBtn">\n        <i class="fas fa-plus"></i> Ny avtale\n      </button>\n    </div>\n    <div class="calendar-grid">\n      <div class="calendar-day-header">Man</div>\n      <div class="calendar-day-header">Tir</div>\n      <div class="calendar-day-header">Ons</div>\n      <div class="calendar-day-header">Tor</div>\n      <div class="calendar-day-header">Fre</div>\n      <div class="calendar-day-header">Lør</div>\n      <div class="calendar-day-header">Søn</div>\n  `;const l=0===o?6:o-1;for(let e=0;e<l;e++)i+='<div class="calendar-day empty"></div>';for(let e=1;e<=s;e++){const s=`${currentCalendarYear}-${String(currentCalendarMonth+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,o=n.filter(e=>e.planlagt_dato===s),r=a.filter(e=>e.dato===s),l=new Date(currentCalendarYear,currentCalendarMonth,e);i+=`\n      <div class="calendar-day ${l.getTime()===t.getTime()?"today":""} ${l<t?"past":""} ${o.length>0||r.length>0?"has-content":""}"\n           data-date="${s}" data-action="openDayDetail">\n        <span class="day-number">${e}</span>\n        <div class="calendar-events">\n          ${r.map(e=>`\n            <div class="calendar-avtale ${"fullført"===e.status?"completed":""}"\n                 data-avtale-id="${e.id}" data-action="editAvtale">\n              ${e.klokkeslett?`<span class="avtale-time">${e.klokkeslett.substring(0,5)}</span>`:""}\n              <span class="avtale-kunde">${escapeHtml(e.kunder?.navn||e.kunde_navn||"Ukjent")}</span>\n            </div>\n          `).join("")}\n          ${o.map(e=>`\n            <div class="calendar-route" data-route-id="${e.id}" data-action="loadSavedRoute">\n              <i class="fas fa-route"></i> ${escapeHtml(e.navn)}\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `}i+="</div>";const d=avtaler.filter(e=>new Date(e.dato)>=t&&"fullført"!==e.status).sort((e,t)=>{const n=new Date(e.dato)-new Date(t.dato);return 0!==n?n:(e.klokkeslett||"").localeCompare(t.klokkeslett||"")}).slice(0,8);d.length>0&&(i+=`\n      <div class="upcoming-section">\n        <h4><i class="fas fa-calendar-check"></i> Kommende avtaler</h4>\n        <div class="upcoming-list">\n          ${d.map(e=>`\n            <div class="upcoming-item" data-avtale-id="${e.id}" data-action="editAvtale">\n              <div class="upcoming-date">\n                <span class="upcoming-day">${new Date(e.dato).getDate()}</span>\n                <span class="upcoming-month">${r[new Date(e.dato).getMonth()].substring(0,3)}</span>\n              </div>\n              <div class="upcoming-info">\n                <strong>${escapeHtml(e.kunder?.navn||e.kunde_navn||"Ukjent")}</strong>\n                <span>${e.klokkeslett?e.klokkeslett.substring(0,5):""} ${e.type||""}</span>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `),e.innerHTML=i,runTabCleanup("calendar");const c=document.getElementById("prevMonth"),u=document.getElementById("nextMonth"),m=document.getElementById("addAvtaleBtn"),p=()=>{currentCalendarMonth--,currentCalendarMonth<0&&(currentCalendarMonth=11,currentCalendarYear--),renderCalendar()},g=()=>{currentCalendarMonth++,currentCalendarMonth>11&&(currentCalendarMonth=0,currentCalendarYear++),renderCalendar()},v=()=>openAvtaleModal();c?.addEventListener("click",p),u?.addEventListener("click",g),m?.addEventListener("click",v),tabCleanupFunctions.calendar=()=>{c?.removeEventListener("click",p),u?.removeEventListener("click",g),m?.removeEventListener("click",v)}}function openAvtaleModal(e=null,t=null){const n=document.getElementById("avtaleModal"),a=document.getElementById("avtaleForm"),s=document.getElementById("avtaleModalTitle"),o=document.getElementById("deleteAvtaleBtn"),r=document.getElementById("avtaleKundeSearch"),i=document.getElementById("avtaleKunde"),l=document.getElementById("avtaleKundeResults"),d=document.getElementById("avtaleType");if(d&&(d.innerHTML=serviceTypeRegistry.renderCategoryOptions("")),r.value="",i.value="",l.innerHTML="",l.classList.remove("active"),e){s.textContent="Rediger avtale",document.getElementById("avtaleId").value=e.id,i.value=e.kunde_id;const t=customers.find(t=>t.id===e.kunde_id);t&&(r.value=`${t.navn} (${t.poststed||"Ukjent"})`),document.getElementById("avtaleDato").value=e.dato,document.getElementById("avtaleKlokkeslett").value=e.klokkeslett||"",document.getElementById("avtaleType").value=e.type||"El-Kontroll",document.getElementById("avtaleBeskrivelse").value=e.beskrivelse||"",o.style.display="inline-block"}else s.textContent="Ny avtale",a.reset(),document.getElementById("avtaleId").value="",r.value="",i.value="",t&&(document.getElementById("avtaleDato").value=t),o.style.display="none";n.classList.remove("hidden"),setTimeout(()=>r.focus(),100)}function setupAvtaleKundeSearch(){const e=document.getElementById("avtaleKundeSearch"),t=document.getElementById("avtaleKunde"),n=document.getElementById("avtaleKundeResults");e&&(e.addEventListener("input",function(){const e=this.value.toLowerCase().trim();if(e.length<1)return n.innerHTML="",void n.classList.remove("active");const t=sortByNavn(customers.filter(t=>t.navn.toLowerCase().includes(e)||t.poststed&&t.poststed.toLowerCase().includes(e)||t.adresse&&t.adresse.toLowerCase().includes(e))).slice(0,10);if(0===t.length)return n.innerHTML='<div class="kunde-search-item no-results">Ingen kunder funnet</div>',void n.classList.add("active");n.innerHTML=t.map(e=>`\n      <div class="kunde-search-item" data-id="${e.id}" data-name="${escapeHtml(e.navn)} (${e.poststed||"Ukjent"})">\n        <span class="kunde-name">${escapeHtml(e.navn)}</span>\n        <span class="kunde-location">${e.poststed||"Ukjent"}</span>\n      </div>\n    `).join(""),n.classList.add("active")}),n.addEventListener("click",function(a){const s=a.target.closest(".kunde-search-item");s&&!s.classList.contains("no-results")&&(t.value=s.dataset.id,e.value=s.dataset.name,n.innerHTML="",n.classList.remove("active"))}),document.addEventListener("click",function(e){e.target.closest(".kunde-search-wrapper")||n.classList.remove("active")}),e.addEventListener("keydown",function(a){const s=n.querySelectorAll(".kunde-search-item:not(.no-results)"),o=n.querySelector(".kunde-search-item.active");if("ArrowDown"===a.key)a.preventDefault(),!o&&s.length>0?s[0].classList.add("active"):o&&o.nextElementSibling&&(o.classList.remove("active"),o.nextElementSibling.classList.add("active"));else if("ArrowUp"===a.key)a.preventDefault(),o&&o.previousElementSibling&&(o.classList.remove("active"),o.previousElementSibling.classList.add("active"));else if("Enter"===a.key){a.preventDefault();const r=o||s[0];r&&!r.classList.contains("no-results")&&(t.value=r.dataset.id,e.value=r.dataset.name,n.innerHTML="",n.classList.remove("active"))}}))}function closeAvtaleModal(){document.getElementById("avtaleModal").classList.add("hidden")}async function saveAvtale(e){e.preventDefault();const t=document.getElementById("avtaleId").value,n={kunde_id:Number.parseInt(document.getElementById("avtaleKunde").value),dato:document.getElementById("avtaleDato").value,klokkeslett:document.getElementById("avtaleKlokkeslett").value||null,type:document.getElementById("avtaleType").value,beskrivelse:document.getElementById("avtaleBeskrivelse").value||null,opprettet_av:localStorage.getItem("klientEpost")||"admin"};try{let e;if(e=t?await apiFetch(`/api/avtaler/${t}`,{method:"PUT",body:JSON.stringify(n)}):await apiFetch("/api/avtaler",{method:"POST",body:JSON.stringify(n)}),e.ok)await loadAvtaler(),renderCalendar(),closeAvtaleModal();else{showMessage("Kunne ikke lagre: "+((await e.json()).error||"Ukjent feil"),"error")}}catch(e){console.error("Error saving avtale:",e),showMessage("Kunne ikke lagre avtalen. Prøv igjen.","error")}}async function deleteAvtale(){const e=document.getElementById("avtaleId").value;if(!e)return;const t=document.getElementById("avtaleTittel")?.value||"denne avtalen";if(await showConfirm(`Er du sikker på at du vil slette "${t}"?`,"Slette avtale"))try{(await apiFetch(`/api/avtaler/${e}`,{method:"DELETE"})).ok&&(await loadAvtaler(),renderCalendar(),closeAvtaleModal())}catch(e){console.error("Error deleting avtale:",e),showMessage("Kunne ikke slette avtalen. Prøv igjen.","error")}}function renderPlanner(){const e=document.getElementById("plannerContainer");if(!e)return;const t=new Date;t.setHours(0,0,0,0);const n={};customers.forEach(e=>{if(!e.neste_kontroll)return;const a=new Date(e.neste_kontroll),s=a.getFullYear(),o=e.poststed||"Ukjent";n[s]||(n[s]={}),n[s][o]||(n[s][o]=[]),n[s][o].push({id:e.id,navn:e.navn,kategori:e.kategori,adresse:e.adresse,poststed:e.poststed,neste_kontroll:e.neste_kontroll,kontroll_intervall_mnd:e.kontroll_intervall_mnd,lat:e.lat,lng:e.lng,daysUntil:Math.ceil((a-t)/864e5)})});const a=Object.keys(n).sort((e,t)=>e-t);a.forEach(e=>{Object.keys(n[e]).sort(compareNorwegian).forEach(t=>{sortByNavn(n[e][t])})});let s='<div class="planner-content">';0===a.length?s+='<p style="padding: 20px; text-align: center; color: #999;">Ingen planlagte kontroller</p>':a.forEach(e=>{const t=n[e],a=Object.values(t).flat().length;s+=`\n        <div class="planner-year">\n          <div class="planner-year-header">${e} (${a} kontroller)</div>\n      `;Object.keys(t).sort((e,t)=>e.localeCompare(t,"no")).forEach(n=>{const a=t[n],o=a.filter(e=>"El-Kontroll"===e.kategori),r=a.filter(e=>"Brannvarsling"===e.kategori);s+=`\n          <div class="planner-area">\n            <div class="planner-area-header">\n              <span class="planner-area-name">${escapeHtml(n)} (${a.length})</span>\n              <button class="planner-area-btn" data-action="createRouteForArea" data-area="${escapeHtml(n)}" data-year="${e}">\n                <i class="fas fa-plus"></i> Rute\n              </button>\n            </div>\n\n            ${o.length>0?`\n              <div class="planner-category">\n                <div class="planner-category-title">El-Kontroll (${o.length})</div>\n                <div class="planner-items">\n                  ${o.map(e=>`\n                    <div class="planner-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n                      <div class="planner-item-date">${new Date(e.neste_kontroll).toLocaleDateString("no-NO")}</div>\n                      <div class="planner-item-info">\n                        <div class="planner-item-name">${escapeHtml(e.navn)}</div>\n                        <div class="planner-item-meta">${escapeHtml(e.adresse)}</div>\n                      </div>\n                      <div class="planner-item-interval">${e.kontroll_intervall_mnd/12}år</div>\n                    </div>\n                  `).join("")}\n                </div>\n              </div>\n            `:""}\n\n            ${r.length>0?`\n              <div class="planner-category">\n                <div class="planner-category-title">Brannvarsling (${r.length})</div>\n                <div class="planner-items">\n                  ${r.map(e=>`\n                    <div class="planner-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n                      <div class="planner-item-date">${new Date(e.neste_kontroll).toLocaleDateString("no-NO")}</div>\n                      <div class="planner-item-info">\n                        <div class="planner-item-name">${escapeHtml(e.navn)}</div>\n                        <div class="planner-item-meta">${escapeHtml(e.adresse)}</div>\n                      </div>\n                      <div class="planner-item-interval">${e.kontroll_intervall_mnd/12}år</div>\n                    </div>\n                  `).join("")}\n                </div>\n              </div>\n            `:""}\n          </div>\n        `}),s+="</div>"}),s+="</div>",e.innerHTML=s}function createRouteForArea(e,t){(new Date).setHours(0,0,0,0);const n=customers.filter(n=>{if(!n.neste_kontroll)return!1;return new Date(n.neste_kontroll).getFullYear()===Number.parseInt(t)&&n.poststed===e});if(0===n.length)return void showMessage(`Ingen kunder i ${e} for ${t}`,"info");selectedCustomers.clear(),n.forEach(e=>{e.lat&&e.lng&&selectedCustomers.add(e.id)}),updateSelectionUI();const a=`${e} - ${t}`;document.getElementById("ruteNavn").value=a,document.getElementById("ruteDato").value=`${t}-01-01`,document.getElementById("saveRouteModal").classList.remove("hidden");const s=n.filter(e=>e.lat&&e.lng);if(s.length>0){const e=L.latLngBounds(s.map(e=>[e.lat,e.lng]));map.fitBounds(e,{padding:[50,50]})}}async function selectCustomersNeedingControl(){try{const e=await apiFetch("/api/kunder/kontroll-varsler?dager=30"),t=await e.json(),n=t.data||t;if(selectedCustomers.clear(),n.forEach(e=>{e.lat&&e.lng&&selectedCustomers.add(e.id)}),updateSelectionUI(),selectedCustomers.size>0){const e=customers.filter(e=>selectedCustomers.has(e.id)&&e.lat&&e.lng);if(e.length>0){const t=L.latLngBounds(e.map(e=>[e.lat,e.lng]));map.fitBounds(t,{padding:[50,50]})}}}catch(e){console.error("Feil ved henting av varsler:",e)}}function checkLoginStatus(){const e=!1===appConfig.requireAuth||"false"===appConfig.requireAuth;if(Logger.log("checkLoginStatus: requireAuth =",appConfig.requireAuth,"-> authDisabled =",e),e){Logger.log("Auth disabled - bypassing login");const e=document.getElementById("userBar");return e&&(e.style.display="none"),!0}const t=localStorage.getItem("authToken")||localStorage.getItem("klientToken"),n=localStorage.getItem("userName")||localStorage.getItem("klientNavn"),a=localStorage.getItem("userRole")||localStorage.getItem("klientEpost"),s=document.getElementById("userBar"),o=document.getElementById("userNameDisplay");if(!t)return window.location.href="/login.html",!1;authToken=t,reloadConfigWithAuth(),s&&(s.style.display="flex",o&&(o.textContent=n||"Bruker"));const r=document.querySelector('.tab-item[data-tab="email"]');return r&&!(a&&"admin"===a)&&(r.style.display="none"),!0}function logoutUser(e=!1){stopTokenRefresh();const t=localStorage.getItem("authToken")||localStorage.getItem("klientToken"),n=localStorage.getItem("refreshToken");(t||n)&&fetch("/api/klient/logout",{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}},body:JSON.stringify({refreshToken:n,logoutAll:e})}).catch(()=>{}),localStorage.removeItem("authToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("accessTokenExpiresAt"),localStorage.removeItem("refreshTokenExpiresAt"),localStorage.removeItem("userName"),localStorage.removeItem("userRole"),localStorage.removeItem("userType"),localStorage.removeItem("klientToken"),localStorage.removeItem("klientNavn"),localStorage.removeItem("klientEpost"),localStorage.removeItem("organizationId"),localStorage.removeItem("organizationSlug"),localStorage.removeItem("organizationName"),authToken=null,window.location.href="/login.html"}function initializeApp(){Logger.log("initializeApp() starting..."),initDOMElements(),loadUserPreferences(),initMap(),Logger.log("initializeApp() after initMap, markerClusterGroup:",!!markerClusterGroup),loadCustomers(),loadOmrader(),loadRoutes(),loadOrganizationFields(),loadOrganizationCategories(),initWebSocket(),setupEventListeners(),initSettingsEventListeners(),applyPreferences(),updateMapLegend(),Logger.log("initializeApp() complete")}function setupEventListeners(){document.getElementById("logoutBtnMain")?.addEventListener("click",handleLogout),document.getElementById("nightmodeBtn")?.addEventListener("click",toggleNightMode),document.getElementById("themeToggleBtn")?.addEventListener("click",toggleTheme),document.getElementById("settingsBtn")?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),openSettingsModal()}),document.querySelectorAll(".dashboard-actions .action-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;"showOverdueTab"===t?switchToTab("overdue"):"showRoutesTab"===t?switchToTab("routes"):"showCalendarTab"===t&&switchToTab("calendar")})}),searchInput?.addEventListener("input",()=>filterCustomers()),addCustomerBtn?.addEventListener("click",addCustomer),planRouteBtn?.addEventListener("click",planRoute),clearSelectionBtn?.addEventListener("click",clearSelection),document.getElementById("mobileRouteFabBtn")?.addEventListener("click",planRoute),customerForm?.addEventListener("submit",saveCustomer),document.getElementById("cancelBtn")?.addEventListener("click",()=>{customerModal.classList.add("hidden")}),document.getElementById("deleteCustomerBtn")?.addEventListener("click",deleteCustomer),document.getElementById("geocodeBtn")?.addEventListener("click",handleGeocode),document.getElementById("pickFromMapBtn")?.addEventListener("click",enableCoordinatePicking),setupAddressAutocomplete(),document.getElementById("kategori")?.addEventListener("change",e=>{updateControlSectionsVisibility(e.target.value)}),document.getElementById("closeRouteInfo")?.addEventListener("click",()=>{routeInfo.classList.add("hidden"),clearRoute(),renderMarkers(customers)}),document.getElementById("saveApiKey")?.addEventListener("click",saveApiKey),document.getElementById("selectWarningsBtn")?.addEventListener("click",selectCustomersNeedingControl),document.getElementById("addCustomerBtnTab")?.addEventListener("click",addCustomer),document.getElementById("customerSearchInput")?.addEventListener("input",e=>{customerAdminSearch=e.target.value,renderCustomerAdmin()}),document.getElementById("kategoriTabs")?.addEventListener("click",async e=>{const t=e.target.closest(".kategori-tab");t&&(document.querySelectorAll(".kategori-tab").forEach(e=>e.classList.remove("active")),t.classList.add("active"),customerAdminKategori=t.dataset.kategori,selectedCategory="alle"===customerAdminKategori?"all":customerAdminKategori,renderCustomerAdmin(),await applyFilters())});const e=document.getElementById("toggleCustomerList"),t=document.getElementById("customerAdminList");e&&t&&(e.addEventListener("click",()=>{t.classList.toggle("collapsed"),e.classList.toggle("collapsed"),localStorage.setItem("customerListCollapsed",t.classList.contains("collapsed"))}),"true"===localStorage.getItem("customerListCollapsed")&&(t.classList.add("collapsed"),e.classList.add("collapsed")));const n=document.getElementById("sidebarToggle"),a=document.getElementById("sidebar");if(n&&a){n.addEventListener("click",()=>{if(window.innerWidth<=768)return;a.classList.toggle("collapsed");const e=a.classList.contains("collapsed");localStorage.setItem("sidebarCollapsed",e)});"true"===localStorage.getItem("sidebarCollapsed")&&window.innerWidth>768&&a.classList.add("collapsed")}const s=document.getElementById("customerListToggle"),o=document.getElementById("customerListContainer");if(s&&o){s.addEventListener("click",()=>{o.classList.toggle("hidden"),s.classList.toggle("collapsed"),localStorage.setItem("customerListHidden",o.classList.contains("hidden"))});"true"===localStorage.getItem("customerListHidden")&&(o.classList.add("hidden"),s.classList.add("collapsed"))}document.getElementById("saveRouteSubmit")?.addEventListener("click",saveRoute),document.getElementById("cancelSaveRoute")?.addEventListener("click",()=>{document.getElementById("saveRouteModal").classList.add("hidden")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(customerModal.classList.add("hidden"),apiKeyModal.classList.add("hidden"),document.getElementById("saveRouteModal")?.classList.add("hidden"))}),document.getElementById("closeCustomerModal")?.addEventListener("click",()=>{customerModal.classList.add("hidden")}),document.getElementById("closeApiKeyModal")?.addEventListener("click",()=>{apiKeyModal.classList.add("hidden")}),document.getElementById("closeSaveRouteModal")?.addEventListener("click",()=>{document.getElementById("saveRouteModal").classList.add("hidden")}),customerModal.addEventListener("click",e=>{e.target===customerModal&&customerModal.classList.add("hidden")}),apiKeyModal.addEventListener("click",e=>{e.target===apiKeyModal&&apiKeyModal.classList.add("hidden")}),document.getElementById("saveRouteModal")?.addEventListener("click",e=>{"saveRouteModal"===e.target.id&&document.getElementById("saveRouteModal").classList.add("hidden")}),document.getElementById("closeAvtaleModal")?.addEventListener("click",closeAvtaleModal),document.getElementById("cancelAvtale")?.addEventListener("click",closeAvtaleModal),document.getElementById("avtaleForm")?.addEventListener("submit",saveAvtale),document.getElementById("deleteAvtaleBtn")?.addEventListener("click",deleteAvtale),document.getElementById("avtaleModal")?.addEventListener("click",e=>{"avtaleModal"===e.target.id&&closeAvtaleModal()}),setupAvtaleKundeSearch(),document.getElementById("addKontaktBtn")?.addEventListener("click",addKontaktlogg),document.getElementById("kontaktNotat")?.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),addKontaktlogg())}),document.getElementById("kontaktloggList")?.addEventListener("click",e=>{const t=e.target.closest('[data-action="deleteKontakt"]');t&&deleteKontaktlogg(t.dataset.id)});const r=document.querySelectorAll(".tab-item"),i=document.querySelectorAll(".tab-pane"),l=document.getElementById("contentPanel"),d=document.getElementById("contentPanelOverlay"),c=document.getElementById("panelTitle"),u=document.getElementById("contentPanelClose"),m={dashboard:"Dashboard",customers:"Kunder",overdue:"Forfalte",warnings:"Kommende kontroller",avhuking:"Avhuking",routes:"Ruter",calendar:"Kalender",planner:"Planlegger",statistikk:"Statistikk",missingdata:"Mangler data",admin:"Admin"};function p(){l&&(l.classList.remove("closed"),l.classList.add("open"),localStorage.setItem("contentPanelOpen","true")),d&&window.innerWidth<=768&&d.classList.add("visible")}function g(){l&&(l.classList.add("closed"),l.classList.remove("open"),localStorage.setItem("contentPanelOpen","false")),d&&d.classList.remove("visible")}u&&u.addEventListener("click",g),d&&d.addEventListener("click",g),r.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("data-tab"),a=document.querySelector(".tab-item.active")?.dataset.tab;a&&runTabCleanup(a),r.forEach(e=>e.classList.remove("active")),i.forEach(e=>e.classList.remove("active")),e.classList.add("active");const s=document.getElementById(`tab-${n}`);if(s){s.classList.add("active");["missingdata","overdue","warnings","avhuking","statistikk","dashboard","routes","calendar","planner","customers"].includes(n)?l.classList.add("compact-mode"):l.classList.remove("compact-mode"),c&&(c.textContent=m[n]||n),p(),localStorage.setItem("activeTab",n);window.innerWidth<=768&&"function"==typeof closeMobileSidebar&&closeMobileSidebar(),"overdue"===n?renderOverdue():"warnings"===n?renderWarnings():"routes"===n?renderSavedRoutes():"calendar"===n?renderCalendar():"planner"===n?renderPlanner():"email"===n?loadEmailData():"statistikk"===n?renderStatistikk():"missingdata"===n?renderMissingData():"customers"===n?renderCustomerAdmin():"admin"===n&&loadAdminData()}})});const v=localStorage.getItem("activeTab"),f=localStorage.getItem("contentPanelOpen");if(window.innerWidth>768&&"false"!==f&&p(),v){const e=document.querySelector(`.tab-item[data-tab="${v}"]`);e&&setTimeout(()=>{e.click()},100)}else{const e=document.querySelector('.tab-item[data-tab="dashboard"]');e&&setTimeout(()=>e.click(),100)}document.getElementById("sendTestEmailBtn")?.addEventListener("click",sendTestEmail),document.getElementById("triggerEmailCheckBtn")?.addEventListener("click",triggerEmailCheck),document.getElementById("openTestEmailBtn")?.addEventListener("click",()=>{document.getElementById("emailTestPanel")?.classList.remove("hidden")}),document.getElementById("closeTestPanel")?.addEventListener("click",()=>{document.getElementById("emailTestPanel")?.classList.add("hidden")}),document.getElementById("toggleEmailConfig")?.addEventListener("click",()=>{document.getElementById("emailConfigCard")?.classList.toggle("collapsed")}),document.getElementById("overdueSortSelect")?.addEventListener("change",()=>{renderOverdue()}),document.getElementById("showOverdueOnMapBtn")?.addEventListener("click",showOverdueOnMap),document.getElementById("createOverdueRouteBtn")?.addEventListener("click",createOverdueRoute),document.getElementById("historyFilter")?.addEventListener("change",e=>{loadEmailHistory(e.target.value)}),document.getElementById("emailAktiv")?.addEventListener("change",e=>{const t=document.getElementById("emailOptions");t&&t.classList.toggle("hidden",!e.target.checked)});const y=document.getElementById("filterPanelToggle"),h=document.getElementById("filterPanel");if(y&&h){"true"===localStorage.getItem("filterPanelCollapsed")&&h.classList.add("collapsed"),y.addEventListener("click",()=>{h.classList.toggle("collapsed");const e=h.classList.contains("collapsed");localStorage.setItem("filterPanelCollapsed",e)})}document.querySelectorAll(".category-btn[data-category]").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".category-btn[data-category]").forEach(e=>e.classList.remove("active")),e.classList.add("active"),selectedCategory=e.dataset.category,applyFilters()})});const k=document.getElementById("driftFilterToggle"),b=document.getElementById("driftFilterButtons");k&&b&&k.addEventListener("click",()=>{const e="none"===b.style.display;b.style.display=e?"flex":"none";const t=k.querySelector(".toggle-icon");t&&(t.classList.toggle("fa-chevron-right",!e),t.classList.toggle("fa-chevron-down",e))}),document.querySelectorAll(".drift-btn[data-drift]").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".drift-btn[data-drift]").forEach(e=>e.classList.remove("active")),e.classList.add("active"),selectedDriftskategori=e.dataset.drift,localStorage.setItem("selectedDriftskategori",selectedDriftskategori),applyFilters()})});const w=localStorage.getItem("selectedDriftskategori");if(w){const e=document.querySelector(`.drift-btn[data-drift="${w}"]`);e&&(document.querySelectorAll(".drift-btn[data-drift]").forEach(e=>e.classList.remove("active")),e.classList.add("active"))}setTimeout(function(){const e=document.getElementById("totalCustomerCount");e&&(e.textContent=customers.length)},500),initWebSocket(),setInterval(()=>{updateDayCounters()},6e4),scheduleNextMidnightUpdate(),document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;switch(t.dataset.action){case"focusOnCustomer":focusOnCustomer(Number.parseInt(t.dataset.customerId));break;case"toggleCustomerSelection":toggleCustomerSelection(Number.parseInt(t.dataset.customerId));break;case"editCustomer":editCustomer(Number.parseInt(t.dataset.customerId));break;case"navigateToCustomer":navigateToCustomer(Number.parseFloat(t.dataset.lat),Number.parseFloat(t.dataset.lng),t.dataset.name);break;case"loadSavedRoute":loadSavedRoute(Number.parseInt(t.dataset.routeId));break;case"completeRoute":completeRoute(Number.parseInt(t.dataset.routeId));break;case"deleteRoute":deleteRoute(Number.parseInt(t.dataset.routeId));break;case"createRouteForArea":createRouteForArea(t.dataset.area,Number.parseInt(t.dataset.year));break;case"addClusterToRoute":addClusterToRoute(t.dataset.customerIds.split(",").map(e=>Number.parseInt(e)));break;case"zoomToCluster":zoomToCluster(Number.parseFloat(t.dataset.lat),Number.parseFloat(t.dataset.lng));break;case"sendReminder":case"sendEmail":e.stopPropagation(),sendManualReminder(Number.parseInt(t.dataset.customerId));break;case"createRouteFromGroup":e.stopPropagation();createRouteFromCustomerIds(t.dataset.customerIds.split(",").map(e=>Number.parseInt(e)));break;case"showGroupOnMap":e.stopPropagation();showCustomersOnMap(t.dataset.customerIds.split(",").map(e=>Number.parseInt(e)));break;case"editAvtale":e.stopPropagation();const n=Number.parseInt(t.dataset.avtaleId),a=avtaler.find(e=>e.id===n);a&&openAvtaleModal(a);break;case"toggleBulkSelect":e.stopPropagation();toggleBulkSelectFromMap(Number.parseInt(t.dataset.customerId));break;case"focusAvhukingCustomer":e.stopPropagation(),focusOnCustomer(Number.parseInt(t.dataset.customerId));break;case"removeFromAvhuking":e.stopPropagation(),removeFromAvhuking(Number.parseInt(t.dataset.customerId));break;case"openDayDetail":openAvtaleModal(null,t.dataset.date);break;case"toggleSection":e.preventDefault();const s=t.dataset.area,o=t.nextElementSibling,r=t.querySelector(".section-toggle-icon i");if(o&&r){o.classList.contains("collapsed")?(o.classList.remove("collapsed"),r.classList.remove("fa-chevron-right"),r.classList.add("fa-chevron-down"),localStorage.setItem(`areaExpanded-${s}`,"true")):(o.classList.add("collapsed"),r.classList.remove("fa-chevron-down"),r.classList.add("fa-chevron-right"),localStorage.setItem(`areaExpanded-${s}`,"false"))}break;case"selectCustomer":if(e.target.closest('[data-action="sendEmail"]'))return;const i=Number.parseInt(t.dataset.customerId);focusOnCustomer(i),toggleCustomerSelection(i);break;case"editTeamMember":e.stopPropagation();const l=Number.parseInt(t.dataset.memberId),d=teamMembersData.find(e=>e.id===l);d&&openTeamMemberModal(d);break;case"deleteTeamMember":e.stopPropagation();const c=Number.parseInt(t.dataset.memberId),u=teamMembersData.find(e=>e.id===c);u&&deleteTeamMember(u)}}),document.getElementById("clearAvhukingBtn")?.addEventListener("click",clearBulkSelection),document.getElementById("completeAvhukingBtn")?.addEventListener("click",openBulkCompleteModal)}function sendManualReminder(e){const t=customers.find(t=>t.id===e);if(!t)return;if(!t.epost)return void showMessage(`${t.navn} har ingen e-postadresse registrert.`,"warning");const n=t.kategori||"El-kontroll",a=appConfig.companyName||"Sky Planner",s=encodeURIComponent(`${n} - Avtale tid for kontroll`),o=encodeURIComponent(`Hei!\n\nVi ønsker å avtale tid for ${n.toLowerCase()} hos ${t.navn}.\n\nAdresse: ${t.adresse||""}, ${t.postnummer||""} ${t.poststed||""}\n\nVennligst gi beskjed om når det passer for deg.\n\nMed vennlig hilsen\n${a}`);window.location.href=`mailto:${t.epost}?subject=${s}&body=${o}`}function getOverdueCustomers(){const e=new Date;return e.setHours(0,0,0,0),customers.filter(t=>!!t.neste_kontroll&&new Date(t.neste_kontroll)<e)}function showOverdueOnMap(){const e=getOverdueCustomers();if(0===e.length)return void showMessage("Ingen forfalte kontroller å vise på kartet.","info");selectedCustomers.clear(),e.forEach(e=>selectedCustomers.add(e.id)),renderMarkers(customers);const t=L.latLngBounds(e.filter(e=>e.lat&&e.lng).map(e=>[e.lat,e.lng]));t.isValid()&&map.fitBounds(t,{padding:[50,50]});const n=document.createElement("div");n.className="map-notification",n.innerHTML=`<i class="fas fa-map-marker-alt"></i> Viser ${e.length} forfalte kunder på kartet`,document.querySelector(".map-container")?.appendChild(n),setTimeout(()=>n.remove(),3e3)}function showCustomersOnMap(e){const t=customers.filter(t=>e.includes(t.id));if(0===t.length)return;selectedCustomers.clear(),t.forEach(e=>selectedCustomers.add(e.id)),renderMarkers(customers);const n=L.latLngBounds(t.filter(e=>e.lat&&e.lng).map(e=>[e.lat,e.lng]));n.isValid()&&map.fitBounds(n,{padding:[50,50]})}async function createOverdueRoute(){const e=getOverdueCustomers();if(0!==e.length){if(e.length>25){if(!await showConfirm(`Du har ${e.length} forfalte kontroller. OpenRouteService har en grense på 25 stopp per rute. Vil du velge de 25 mest kritiske?`,"For mange kontroller"))return;const t=new Date;t.setHours(0,0,0,0),e.sort((e,n)=>{const a=Math.ceil((t-new Date(e.neste_kontroll))/864e5);return Math.ceil((t-new Date(n.neste_kontroll))/864e5)-a}),e.length=25}createRouteFromCustomerIds(e.map(e=>e.id))}else showMessage("Ingen forfalte kontroller å lage rute for.","info")}function createRouteFromCustomerIds(e){const t=customers.filter(t=>e.includes(t.id)&&t.lat&&t.lng);if(0===t.length)return void showMessage("Ingen kunder med gyldige koordinater.","warning");if(t.length>25)return void showMessage("Maks 25 stopp per rute. Velg færre kunder.","warning");selectedCustomers.clear(),t.forEach(e=>selectedCustomers.add(e.id)),renderMarkers(customers);const n=document.querySelector('[data-tab="routes"]');n&&n.click(),updateRouteSelection(),showMessage(`${t.length} kunder lagt til for ruteplanlegging. Klikk "Beregn rute" for å lage kjørerute.`,"success")}async function loadEmailData(){await Promise.all([loadEmailStats(),loadEmailUpcoming(),loadEmailStatus(),loadEmailHistory()])}async function loadEmailStats(){try{const e=await apiFetch("/api/email/stats");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();document.getElementById("statPending").textContent=t.pending||0,document.getElementById("statSent").textContent=t.sent||0,document.getElementById("statFailed").textContent=t.failed||0}catch(e){console.error("Feil ved lasting av e-post-statistikk:",e)}}async function loadEmailUpcoming(){try{const e=await apiFetch("/api/email/upcoming");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json(),n=document.getElementById("emailUpcomingContent"),a=document.getElementById("upcomingCount");if(!n)return;if(a&&(a.textContent=t.length),0===t.length)return void(n.innerHTML='<div class="upcoming-empty">Ingen kommende varsler de neste 30 dagene</div>');n.innerHTML=t.map(e=>{const t=e.days_until;let n="normal",a=`${t} dager`;t<=0?(n="urgent",a=0===t?"I dag":`${Math.abs(t)} dager siden`):t<=10?n="urgent":t<=30&&(n="soon");const s=e.epost&&""!==e.epost.trim();return`\n        <div class="upcoming-item" data-customer-id="${e.id}">\n          <div class="upcoming-info">\n            <span class="upcoming-name">${e.navn}</span>\n            <span class="upcoming-email">${e.epost||"Mangler e-post"}</span>\n          </div>\n          <div class="upcoming-actions">\n            <button class="upcoming-email-btn ${s?"":"disabled"}"\n                    data-action="sendEmail"\n                    data-customer-id="${e.id}"\n                    title="${s?"Send e-post":"Ingen e-post registrert"}">\n              <i class="fas fa-envelope"></i>\n            </button>\n            <span class="upcoming-days ${n}">${a}</span>\n          </div>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av kommende varsler:",e)}}async function loadEmailStatus(){try{const e=await apiFetch("/api/email/status");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json(),n=document.getElementById("emailStatusContent");if(!n)return;n.innerHTML=`\n      <div class="config-item">\n        <span class="config-label">E-postvarsling</span>\n        <span class="config-value ${t.enabled?"enabled":"disabled"}">\n          ${t.enabled?"Aktivert":"Deaktivert"}\n        </span>\n      </div>\n      <div class="config-item">\n        <span class="config-label">E-post server</span>\n        <span class="config-value ${t.emailConfigured?"enabled":"disabled"}">\n          ${t.emailConfigured?"Konfigurert":"Ikke konfigurert"}\n        </span>\n      </div>\n      <div class="config-item">\n        <span class="config-label">Første varsel</span>\n        <span class="config-value">${t.firstReminderDays} dager før</span>\n      </div>\n      <div class="config-item">\n        <span class="config-label">Påminnelse</span>\n        <span class="config-value">${t.reminderAfterDays} dager etter første</span>\n      </div>\n    `}catch(e){console.error("Feil ved lasting av e-post-status:",e)}}async function loadEmailHistory(e="all"){try{const t=await apiFetch("/api/email/historikk?limit=50");if(!t.ok)throw new Error(`HTTP ${t.status}`);let n=await t.json();"all"!==e&&(n=n.filter(t=>t.status===e));const a=document.getElementById("emailHistoryContent");if(!a)return;if(0===n.length)return void(a.innerHTML='<div class="email-history-empty">Ingen varsler å vise</div>');a.innerHTML=n.map(e=>{const t={sent:"Sendt",failed:"Feilet",pending:"Venter"}[e.status]||e.status;return`\n        <div class="email-history-item">\n          <div class="history-header">\n            <span class="history-customer">${escapeHtml(e.kunde_navn||"Test")}</span>\n            <span class="history-status ${escapeHtml(e.status)}">${escapeHtml(t)}</span>\n          </div>\n          <div class="history-subject">${escapeHtml(e.emne||"")}</div>\n          <div class="history-message">${escapeHtml(e.melding.substring(0,80))}${e.melding.length>80?"...":""}</div>\n          <div class="history-date">${new Date(e.opprettet).toLocaleString("nb-NO",{timeZone:"Europe/Oslo"})}</div>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av e-post-historikk:",e)}}async function sendTestEmail(){const e=document.getElementById("testEmailAddress")?.value,t=document.getElementById("testEmailMessage")?.value;if(!e)return void showMessage("Skriv inn en e-postadresse","warning");const n=document.getElementById("sendTestEmailBtn");n&&(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sender...');try{const n=await apiFetch("/api/email/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({epost:e,melding:t})}),a=await n.json();a.success?(showMessage("Test e-post sendt!","success"),loadEmailHistory()):showMessage("Feil ved sending: "+(a.error||"Ukjent feil"),"error")}catch(e){console.error("Feil ved sending av test e-post:",e),showMessage("Kunne ikke sende e-post. Prøv igjen.","error")}finally{n&&(n.disabled=!1,n.innerHTML='<i class="fas fa-paper-plane"></i> Send Test')}}async function triggerEmailCheck(){const e=document.getElementById("triggerEmailCheckBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sender...');try{const e=await apiFetch("/api/email/send-varsler",{method:"POST"}),t=await e.json();showMessage(`Varselsjekk fullført! Sendt: ${t.sent}, Hoppet over: ${t.skipped}, Feil: ${t.errors}`,"success","Varsler sendt"),loadEmailData()}catch(e){console.error("Feil ved varselsjekk:",e),showMessage("Kunne ikke kjøre varselsjekk","error")}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-paper-plane"></i><span>Send varsler nå</span>')}}async function loadCustomerEmailSettings(e){try{const t=await apiFetch(`/api/email/innstillinger/${e}`),n=await t.json(),a=document.getElementById("emailAktiv"),s=document.getElementById("forsteVarsel"),o=document.getElementById("paaminnelseEtter"),r=document.getElementById("emailOptions");a&&(a.checked=1===n.email_aktiv),s&&(s.value=n.forste_varsel_dager),o&&(o.value=n.paaminnelse_etter_dager),r&&r.classList.toggle("hidden",!a?.checked)}catch(e){console.error("Feil ved lasting av e-post-innstillinger:",e)}}async function saveCustomerEmailSettings(e){const t=document.getElementById("emailAktiv")?.checked,n=document.getElementById("forsteVarsel")?.value,a=document.getElementById("paaminnelseEtter")?.value;try{await apiFetch(`/api/email/innstillinger/${e}`,{method:"PUT",body:JSON.stringify({email_aktiv:t,forste_varsel_dager:Number.parseInt(n)||30,paaminnelse_etter_dager:Number.parseInt(a)||7})})}catch(e){console.error("Feil ved lagring av e-post-innstillinger:",e)}}window.deleteCustomerAdmin=deleteCustomerAdmin,document.addEventListener("DOMContentLoaded",async()=>{initializeTheme(),await loadConfig(),applyBranding(),initSharedMap(),initLoginView();if(await checkExistingAuth()){const e="true"===localStorage.getItem("isImpersonating");if("true"===localStorage.getItem("isSuperAdmin")&&!e)return void(window.location.href="/admin");if(e){const e=document.getElementById("impersonationBanner"),t=localStorage.getItem("impersonatingOrgName")||"Ukjent bedrift";e&&(document.getElementById("impersonatingOrgName").textContent=t,e.style.display="flex",document.body.classList.add("is-impersonating"))}const t=document.getElementById("loginOverlay"),n=document.getElementById("appView");t&&t.classList.add("hidden"),n&&n.classList.remove("hidden"),currentView="app",appInitialized=!0,map&&(map.dragging.enable(),map.scrollWheelZoom.enable(),map.doubleClickZoom.enable(),map.touchZoom.enable(),map.keyboard.enable(),L.control.zoom({position:"topright"}).addTo(map),map.setView([67.5,15],6,{animate:!1})),initDOMElements(),initMap(),loadCustomers(),loadOmrader(),loadRoutes(),loadOrganizationFields(),loadOrganizationCategories(),initWebSocket(),showUserBar(),setupEventListeners()}else{currentView="login";const e=document.querySelector(".tab-navigation");e&&(e.style.opacity="0",e.style.pointerEvents="none");const t=document.getElementById("sidebarToggle");t&&(t.style.opacity="0",t.style.pointerEvents="none")}});let currentKontaktloggKundeId=null;async function loadKontaktlogg(e){currentKontaktloggKundeId=e;const t=document.getElementById("kontaktloggList");try{const n=await apiFetch(`/api/kunder/${e}/kontaktlogg`);if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json();if(0===a.length)return void(t.innerHTML='<div class="kontaktlogg-empty">Ingen registrerte kontakter</div>');t.innerHTML=a.map(e=>{const t=new Date(e.dato).toLocaleDateString("nb-NO",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return`\n        <div class="kontaktlogg-item" data-id="${e.id}">\n          <div class="kontaktlogg-info">\n            <div class="kontaktlogg-header">\n              <span class="kontaktlogg-type">${escapeHtml(e.type)}</span>\n              <span class="kontaktlogg-date">${t}</span>\n            </div>\n            ${e.notat?`<div class="kontaktlogg-notat">${escapeHtml(e.notat)}</div>`:""}\n          </div>\n          <button type="button" class="kontaktlogg-delete" data-action="deleteKontakt" data-id="${e.id}" title="Slett">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av kontaktlogg:",e),t.innerHTML='<div class="kontaktlogg-empty">Feil ved lasting</div>'}}async function addKontaktlogg(){if(!currentKontaktloggKundeId)return;const e=document.getElementById("kontaktType"),t=document.getElementById("kontaktNotat"),n=e.value,a=t.value.trim();if(!a)return showMessage("Vennligst skriv et notat","warning"),void t.focus();try{await apiFetch(`/api/kunder/${currentKontaktloggKundeId}/kontaktlogg`,{method:"POST",body:JSON.stringify({type:n,notat:a,opprettet_av:localStorage.getItem("userName")||"Ukjent"})}),t.value="",await loadKontaktlogg(currentKontaktloggKundeId)}catch(e){console.error("Feil ved lagring av kontakt:",e),showMessage("Feil ved lagring av kontakt","error")}}async function deleteKontaktlogg(e){if(await showConfirm("Slette denne kontaktregistreringen?","Slette kontakt"))try{await apiFetch(`/api/kontaktlogg/${e}`,{method:"DELETE"}),await loadKontaktlogg(currentKontaktloggKundeId)}catch(e){console.error("Feil ved sletting av kontakt:",e)}}function renderMissingData(){const e=customers.filter(e=>!e.telefon||""===e.telefon.trim()),t=customers.filter(e=>!e.epost||""===e.epost.trim()),n=customers.filter(e=>null===e.lat||null===e.lng),a=customers.filter(e=>!e.neste_kontroll&&!e.neste_el_kontroll&&!e.neste_brann_kontroll);document.getElementById("missingPhoneCount").textContent=e.length,document.getElementById("missingEmailCount").textContent=t.length,document.getElementById("missingCoordsCount").textContent=n.length,document.getElementById("missingControlCount").textContent=a.length;updateBadge("missingDataBadge",e.length+t.length+n.length+a.length),renderMissingList("missingPhoneList",e,"telefon"),renderMissingList("missingEmailList",t,"e-post"),renderMissingList("missingCoordsList",n,"koordinater"),renderMissingList("missingControlList",a,"neste kontroll")}function renderMissingList(e,t,n){const a=document.getElementById(e);a&&(0!==t.length?a.innerHTML=t.map(e=>`\n    <div class="missing-item" data-action="editCustomer" data-customer-id="${e.id}">\n      <div class="missing-item-name">${escapeHtml(e.navn)}</div>\n      <div class="missing-item-address">${escapeHtml(e.adresse||"")}${e.poststed?", "+escapeHtml(e.poststed):""}</div>\n    </div>\n  `).join(""):a.innerHTML=`<div class="missing-empty">Ingen kunder mangler ${escapeHtml(n)}</div>`)}function renderStatistikk(){let e=0,t=0,n=0;customers.forEach(a=>{const s=getControlStatus(a);"forfalt"===s.status?e++:"snart"===s.status?t++:"ok"!==s.status&&"god"!==s.status||n++}),document.getElementById("statTotalKunder").textContent=customers.length,document.getElementById("statForfalte").textContent=e,document.getElementById("statSnart").textContent=t,document.getElementById("statOk").textContent=n,renderSeasonChart(),renderCategoryStats(),renderAreaStats(),renderEltypeStats(),renderBrannsystemStats()}document.addEventListener("click",function(e){const t=e.target.closest(".missing-header");if(t){const e=t.dataset.toggle,n="missing"+e.replace("missing-","").charAt(0).toUpperCase()+e.replace("missing-","").slice(1)+"List",a=document.getElementById(n);a&&(a.classList.toggle("collapsed"),t.querySelector(".toggle-icon").classList.toggle("rotated"))}});let loginLogOffset=0;const LOGIN_LOG_LIMIT=20;async function loadAdminData(){initTeamMembersUI(),initFieldsManagementUI(),await loadTeamMembers(),await loadLoginStats(),loginLogOffset=0,await loadLoginLog(!1),renderAdminFields(),renderAdminCategories(),await checkSuperAdminStatus(),document.getElementById("loadMoreLogins")?.addEventListener("click",()=>loadLoginLog(!0))}async function loadTeamMembers(){try{const e=await fetch("/api/team-members",{headers:{Authorization:`Bearer ${authToken}`}});if(!e.ok)return void console.error("Failed to load team members");const t=await e.json(),n=document.getElementById("teamMembersList"),a=document.getElementById("teamMembersEmpty"),s=document.getElementById("teamQuotaBadge");if(!n)return;if(s&&t.data?.limits){const{current_count:e,max_brukere:n}=t.data.limits;s.textContent=`${e} / ${n}`,s.classList.remove("near-limit","at-limit"),e>=n?s.classList.add("at-limit"):e>=n-1&&s.classList.add("near-limit")}n.innerHTML="";const o=t.data?.members||[];teamMembersData=o,o.length>0?(a&&(a.style.display="none"),n.style.display="flex",n.innerHTML=o.map(e=>{const t=getInitials(e.navn),n=e.sist_innlogget?formatRelativeTime(e.sist_innlogget):"Aldri innlogget";return`\n          <div class="team-member-item" data-action="editTeamMember" data-member-id="${e.id}">\n            <div class="team-member-status ${e.aktiv?"":"inactive"}"></div>\n            <div class="team-member-avatar">${t}</div>\n            <div class="team-member-info">\n              <div class="team-member-name">${escapeHtml(e.navn)}</div>\n              <div class="team-member-email">${escapeHtml(e.epost)}</div>\n              <div class="team-member-meta">\n                <span class="team-member-role">${escapeHtml(e.rolle||"medlem")}</span>\n                <span class="team-member-last-login">Sist: ${n}</span>\n              </div>\n            </div>\n            <div class="team-member-actions">\n              <button class="btn-icon" data-action="editTeamMember" data-member-id="${e.id}" title="Rediger"><i class="fas fa-pen"></i></button>\n              <button class="btn-icon delete" data-action="deleteTeamMember" data-member-id="${e.id}" title="Slett"><i class="fas fa-trash"></i></button>\n            </div>\n          </div>\n        `}).join("")):(n.style.display="none",a&&(a.style.display="block"))}catch(e){console.error("Error loading team members:",e)}}function openTeamMemberModal(e=null){const t=document.getElementById("teamMemberModal"),n=document.getElementById("teamMemberModalTitle"),a=document.getElementById("teamMemberForm"),s=document.getElementById("deleteTeamMemberBtn"),o=document.getElementById("memberPassord");t&&a&&(a.reset(),document.getElementById("teamMemberId").value="",e?(n.textContent="Rediger teammedlem",document.getElementById("teamMemberId").value=e.id,document.getElementById("memberNavn").value=e.navn||"",document.getElementById("memberEpost").value=e.epost||"",document.getElementById("memberTelefon").value=e.telefon||"",document.getElementById("memberRolle").value=e.rolle||"medlem",o.required=!1,o.placeholder="La stå tom for å beholde",s.style.display="inline-flex"):(n.textContent="Nytt teammedlem",o.required=!0,o.placeholder="Minst 8 tegn",s.style.display="none"),t.classList.remove("hidden"))}function closeTeamMemberModal(){const e=document.getElementById("teamMemberModal");e&&e.classList.add("hidden")}async function saveTeamMember(e){e.preventDefault();const t=document.getElementById("teamMemberId").value,n=!!t,a={navn:document.getElementById("memberNavn").value.trim(),epost:document.getElementById("memberEpost").value.trim(),telefon:document.getElementById("memberTelefon").value.trim()||null,rolle:document.getElementById("memberRolle").value},s=document.getElementById("memberPassord").value;if(s)a.passord=s;else if(!n)return void showToast("Passord er påkrevd","error");try{const e=n?`/api/team-members/${t}`:"/api/team-members",s=n?"PUT":"POST",o=await fetch(e,{method:s,headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify(a)}),r=await o.json();if(!o.ok)return void showToast(r.error?.message||"Kunne ikke lagre bruker","error");showToast(n?"Bruker oppdatert":"Bruker opprettet","success"),closeTeamMemberModal(),await loadTeamMembers()}catch(e){console.error("Error saving team member:",e),showToast("En feil oppstod","error")}}async function deleteTeamMember(e){if(await showConfirm(`Er du sikker på at du vil slette ${e.navn}?`,"Slette teammedlem"))try{const t=await fetch(`/api/team-members/${e.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${authToken}`}});if(!t.ok){const e=await t.json();return void showToast(e.error?.message||"Kunne ikke slette bruker","error")}showToast("Bruker slettet","success"),closeTeamMemberModal(),await loadTeamMembers()}catch(e){console.error("Error deleting team member:",e),showToast("En feil oppstod","error")}}function initTeamMembersUI(){document.getElementById("addTeamMemberBtn")?.addEventListener("click",()=>openTeamMemberModal()),document.getElementById("addFirstMemberBtn")?.addEventListener("click",()=>openTeamMemberModal()),document.getElementById("closeTeamMemberModal")?.addEventListener("click",closeTeamMemberModal),document.getElementById("cancelTeamMember")?.addEventListener("click",closeTeamMemberModal),document.getElementById("teamMemberForm")?.addEventListener("submit",saveTeamMember),document.getElementById("deleteTeamMemberBtn")?.addEventListener("click",()=>{const e=document.getElementById("teamMemberId").value;if(e){deleteTeamMember({id:e,navn:document.getElementById("memberNavn").value})}})}function initFieldsManagementUI(){document.getElementById("addFieldBtn")?.addEventListener("click",()=>openFieldModal()),document.getElementById("addFirstFieldBtn")?.addEventListener("click",()=>openFieldModal()),document.getElementById("closeFieldModal")?.addEventListener("click",()=>{document.getElementById("fieldModal").classList.add("hidden")}),document.getElementById("cancelField")?.addEventListener("click",()=>{document.getElementById("fieldModal").classList.add("hidden")}),document.getElementById("fieldForm")?.addEventListener("submit",saveField),document.getElementById("deleteFieldBtn")?.addEventListener("click",()=>{const e=document.getElementById("fieldId").value;e&&confirmDeleteField(parseInt(e))}),document.getElementById("fieldType")?.addEventListener("change",e=>{const t=document.getElementById("fieldOptionsSection");t&&(t.style.display="select"===e.target.value?"block":"none")}),document.getElementById("addFieldOptionBtn")?.addEventListener("click",addFieldOption),document.getElementById("fieldDisplayName")?.addEventListener("input",e=>{const t=document.getElementById("fieldName");t&&!t.disabled&&(t.value=e.target.value.toLowerCase().replace(/[æ]/g,"ae").replace(/[ø]/g,"o").replace(/[å]/g,"a").replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,""))}),document.getElementById("addCategoryBtn")?.addEventListener("click",()=>openCategoryModal()),document.getElementById("addFirstCategoryBtn")?.addEventListener("click",()=>openCategoryModal()),document.getElementById("closeCategoryModal")?.addEventListener("click",()=>{document.getElementById("categoryModal").classList.add("hidden")}),document.getElementById("cancelCategory")?.addEventListener("click",()=>{document.getElementById("categoryModal").classList.add("hidden")}),document.getElementById("categoryForm")?.addEventListener("submit",saveCategory),document.getElementById("deleteCategoryBtn")?.addEventListener("click",()=>{const e=document.getElementById("categoryId").value;e&&confirmDeleteCategory(parseInt(e))}),document.getElementById("categoryName")?.addEventListener("input",e=>{const t=document.getElementById("categorySlug");t&&(t.value=e.target.value.toLowerCase().replace(/[æ]/g,"ae").replace(/[ø]/g,"o").replace(/[å]/g,"a").replace(/[^a-z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""))})}function getInitials(e){if(!e)return"?";const t=e.trim().split(/\s+/);return 1===t.length?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function formatRelativeTime(e){if(!e)return"Ukjent";let t=e;t.endsWith("Z")||t.includes("+")||(t=t.replace(" ","T")+"Z");const n=new Date,a=new Date(t),s=n-a,o=Math.floor(s/6e4),r=Math.floor(s/36e5),i=Math.floor(s/864e5);return o<1?"Nå":o<60?`${o} min siden`:r<24?`${r} t siden`:i<7?`${i} d siden`:a.toLocaleDateString("nb-NO",{day:"2-digit",month:"2-digit",year:"numeric"})}async function loadLoginStats(){try{const e=await fetch("/api/login-logg/stats",{headers:{Authorization:`Bearer ${authToken}`}});if(!e.ok)return void console.error("Failed to load login stats");const t=await e.json();document.getElementById("statTotalLogins").textContent=t.total||0,document.getElementById("statSuccessLogins").textContent=t.vellykket||0,document.getElementById("statFailedLogins").textContent=t.feilet||0,document.getElementById("statLast24h").textContent=t.siste24t||0}catch(e){console.error("Error loading login stats:",e)}}async function loadLoginLog(e=!1){try{e||(loginLogOffset=0);const t=await fetch(`/api/login-logg?limit=20&offset=${loginLogOffset}`,{headers:{Authorization:`Bearer ${authToken}`}});if(!t.ok)return void console.error("Failed to load login log");const n=await t.json(),a=document.getElementById("loginLogBody");if(e||(a.innerHTML=""),n.logg&&n.logg.length>0){n.logg.forEach(e=>{const t=document.createElement("tr");let n=e.tidspunkt;!n||n.endsWith("Z")||n.includes("+")||(n=n.replace(" ","T")+"Z");const s=new Date(n).toLocaleString("nb-NO",{timeZone:"Europe/Oslo",day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),o="vellykket"===e.status?"success":"failed",r="vellykket"===e.status?"OK":"Feilet",i="vellykket"===e.status?"fa-check":"fa-times",l=e.user_agent||"";let d="Ukjent";l.includes("iPhone")?d="iPhone":l.includes("iPad")?d="iPad":l.includes("Android")?d="Android":l.includes("Windows")?d="Windows":l.includes("Mac")?d="Mac":l.includes("Linux")&&(d="Linux"),t.innerHTML=`\n          <td>${s}</td>\n          <td>${escapeHtml(e.bruker_navn||"-")}</td>\n          <td>${escapeHtml(e.epost)}</td>\n          <td><span class="status-badge ${o}"><i class="fas ${i}"></i> ${r}</span></td>\n          <td class="ip-address">${escapeHtml(e.ip_adresse||"-")}</td>\n          <td class="user-agent" title="${escapeHtml(l)}">${d}</td>\n        `,a.appendChild(t)}),loginLogOffset+=n.logg.length;const e=document.getElementById("loadMoreLogins");e&&(e.style.display=n.logg.length<20?"none":"block")}else e||(a.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--color-text-tertiary);">Ingen innlogginger registrert</td></tr>')}catch(e){console.error("Error loading login log:",e)}}function renderSeasonChart(){const e=new Array(12).fill(0);customers.forEach(t=>{if(t.neste_el_kontroll){const n=new Date(t.neste_el_kontroll);Number.isNaN(n.getTime())||e[n.getMonth()]++}if(t.neste_brann_kontroll){const n=new Date(t.neste_brann_kontroll);Number.isNaN(n.getTime())||e[n.getMonth()]++}});const t=Math.max(...e,1),n=document.getElementById("seasonChart");n&&(n.innerHTML=["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"].map((n,a)=>{const s=e[a];return`\n      <div class="season-bar">\n        <span class="season-bar-value">${s}</span>\n        <div class="season-bar-fill combined" style="height: ${s/t*100}%"></div>\n        <span class="season-bar-label">${n}</span>\n      </div>\n    `}).join(""))}function renderBarStats(e,t,n={}){const a=document.getElementById(e);if(!a)return;const s=Object.entries(t).sort((e,t)=>t[1]-e[1]);if(n.limit&&s.splice(n.limit),0===s.length)return void(a.innerHTML='<p style="color: var(--color-text-muted); font-size: 13px;">Ingen data</p>');const o=n.total||Object.values(t).reduce((e,t)=>e+t,0)||1,r=n.useMaxAsBase?s[0]?.[1]||1:o;a.innerHTML=s.map(([e,t])=>{const a=t/r*100,s=n.getBarClass?n.getBarClass(e):n.barClass||"default";return`\n      <div class="stat-bar-item">\n        <div class="stat-bar-header">\n          <span class="stat-bar-label">${e}</span>\n          <span class="stat-bar-value">${!1===n.showPercent?`${t}`:`${t} (${a.toFixed(0)}%)`}</span>\n        </div>\n        <div class="stat-bar-track">\n          <div class="stat-bar-fill ${s}" style="width: ${a}%"></div>\n        </div>\n      </div>\n    `}).join("")}function renderCategoryStats(){const e={};customers.forEach(t=>{const n=t.kategori||"Ukjent";e[n]=(e[n]||0)+1}),renderBarStats("categoryStats",e,{total:customers.length,getBarClass:e=>"El-Kontroll"===e?"el-kontroll":"Brannvarsling"===e?"brannvarsling":"combined"})}function renderAreaStats(){const e={};customers.forEach(t=>{const n=t.poststed||"Ukjent";e[n]=(e[n]||0)+1}),renderBarStats("areaStats",e,{limit:10,useMaxAsBase:!0,showPercent:!1,barClass:"area"})}function renderEltypeStats(){const e={};customers.forEach(t=>{t.el_type&&(e[t.el_type]=(e[t.el_type]||0)+1)}),renderBarStats("eltypeStats",e,{barClass:"eltype"})}function renderBrannsystemStats(){const e={};customers.forEach(t=>{t.brann_system&&(e[t.brann_system]=(e[t.brann_system]||0)+1)}),renderBarStats("brannsystemStats",e,{barClass:"brannsystem"})}function addClusterToRoute(e){e.forEach(e=>{selectedCustomers.has(e)||selectedCustomers.add(e)}),updateSelectionUI(),map.closePopup();showNotification(`${e.length} kunder lagt til ruten`)}function zoomToCluster(e,t){map.closePopup(),map.setView([e,t],map.getZoom()+2)}function showNotification(e,t="success"){const n=document.querySelector(".notification-toast");n&&n.remove();const a={success:"fa-check-circle",error:"fa-exclamation-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"},s=document.createElement("div");s.className=`notification-toast notification-${t}`,s.innerHTML=`<i class="fas ${a[t]||a.success}"></i> ${escapeHtml(e)}`,document.body.appendChild(s),setTimeout(()=>{s.classList.add("fade-out"),setTimeout(()=>s.remove(),300)},2500)}window.editCustomer=editCustomer,window.toggleCustomerSelection=toggleCustomerSelection,window.loadSavedRoute=loadSavedRoute,window.completeRoute=completeRoute,window.deleteRoute=deleteRoute,window.focusOnCustomer=focusOnCustomer,window.createRouteForArea=createRouteForArea,window.addClusterToRoute=addClusterToRoute,window.zoomToCluster=zoomToCluster;let isSuperAdmin=!1,superAdminOrganizations=[],selectedOrgId=null,selectedOrgData=null;async function checkSuperAdminStatus(){const e=sessionStorage.getItem("isSuperAdmin")||localStorage.getItem("isSuperAdmin");if(isSuperAdmin="true"===e,isSuperAdmin){const e=document.getElementById("superAdminSection");e&&(e.style.display="block",await loadSuperAdminData())}}async function loadSuperAdminData(){if(isSuperAdmin)try{await loadGlobalStatistics(),await loadOrganizations(),initSuperAdminUI()}catch(e){console.error("Error loading super admin data:",e)}}async function loadGlobalStatistics(){try{const e=await fetch("/api/super-admin/statistics",{headers:{Authorization:`Bearer ${authToken}`}});if(!e.ok)return void console.error("Failed to load global statistics");const t=await e.json();if(t.success&&t.data){const e=t.data;updateElement("statTotalOrgs",e.totalOrganizations||0),updateElement("statGlobalKunder",e.totalKunder||0),updateElement("statGlobalBrukere",e.totalBrukere||0),updateElement("statActiveOrgs",e.activeOrganizations||0)}}catch(e){console.error("Error loading global statistics:",e)}}function updateElement(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}async function loadOrganizations(){try{const e=await fetch("/api/super-admin/organizations",{headers:{Authorization:`Bearer ${authToken}`}});if(!e.ok)return void console.error("Failed to load organizations");const t=await e.json();t.success&&(superAdminOrganizations=t.data||[],renderOrganizationList())}catch(e){console.error("Error loading organizations:",e)}}function renderOrganizationList(e=""){const t=document.getElementById("orgListBody");if(!t)return;const n=e?superAdminOrganizations.filter(t=>t.navn.toLowerCase().includes(e.toLowerCase())||t.slug.toLowerCase().includes(e.toLowerCase())):superAdminOrganizations;0!==n.length?t.innerHTML=n.map(e=>{const t=getPlanBadge(e.plan_type),n=getSubscriptionStatusBadge(e.subscription_status),a=e.opprettet?new Date(e.opprettet).toLocaleDateString("nb-NO"):"-";return`\n      <tr data-org-id="${e.id}">\n        <td><strong>${escapeHtml(e.navn)}</strong><br><small style="color: var(--text-tertiary);">${escapeHtml(e.slug)}</small></td>\n        <td>${t}</td>\n        <td>${n}</td>\n        <td>${e.kunde_count||0}</td>\n        <td>${e.bruker_count||0}</td>\n        <td>${a}</td>\n        <td>\n          <button class="btn btn-small btn-secondary" onclick="selectOrganization(${e.id})">\n            <i class="fas fa-eye"></i>\n          </button>\n        </td>\n      </tr>\n    `}).join(""):t.innerHTML=`\n      <tr>\n        <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n          ${e?"Ingen organisasjoner funnet":"Ingen organisasjoner registrert"}\n        </td>\n      </tr>\n    `}function getPlanBadge(e){const t={free:'<span class="badge badge-secondary">Gratis</span>',standard:'<span class="badge badge-primary">Standard</span>',premium:'<span class="badge badge-success">Premium</span>',enterprise:'<span class="badge badge-warning">Enterprise</span>'};return t[e]||t.free}function getSubscriptionStatusBadge(e){return{active:'<span class="badge badge-success">Aktiv</span>',trialing:'<span class="badge badge-info">Prøveperiode</span>',past_due:'<span class="badge badge-warning">Forfalt</span>',canceled:'<span class="badge badge-danger">Kansellert</span>',incomplete:'<span class="badge badge-secondary">Ufullstendig</span>'}[e]||'<span class="badge badge-secondary">Ukjent</span>'}async function selectOrganization(e){selectedOrgId=e;try{const t=await fetch(`/api/super-admin/organizations/${e}`,{headers:{Authorization:`Bearer ${authToken}`}});if(!t.ok)return void showNotification("Kunne ikke laste organisasjonsdetaljer","error");const n=await t.json();if(n.success){selectedOrgData=n.data,renderSelectedOrganization();const t=document.getElementById("selectedOrgSection");t&&(t.style.display="block",t.scrollIntoView({behavior:"smooth"})),await loadOrgCustomers(e),await loadOrgUsers(e)}}catch(e){console.error("Error loading organization:",e),showNotification("Feil ved lasting av organisasjon","error")}}function renderSelectedOrganization(){selectedOrgData&&(updateElement("selectedOrgName",selectedOrgData.navn),updateElement("orgInfoSlug",selectedOrgData.slug),updateElement("orgInfoPlan",selectedOrgData.plan_type||"free"),updateElement("orgInfoSubscription",selectedOrgData.subscription_status||"ukjent"),updateElement("orgInfoIndustry",selectedOrgData.industry_template_id?`ID: ${selectedOrgData.industry_template_id}`:"Ingen"))}async function loadOrgCustomers(e){try{const t=await fetch(`/api/super-admin/organizations/${e}/kunder`,{headers:{Authorization:`Bearer ${authToken}`}});if(!t.ok)return void console.error("Failed to load org customers");const n=await t.json();n.success&&(renderOrgCustomers(n.data||[]),updateElement("orgCustomerCount",(n.data||[]).length))}catch(e){console.error("Error loading org customers:",e)}}function renderOrgCustomers(e){const t=document.getElementById("orgCustomersBody");t&&(0!==e.length?t.innerHTML=e.map(e=>`\n    <tr data-kunde-id="${e.id}">\n      <td><strong>${escapeHtml(e.navn)}</strong></td>\n      <td>${escapeHtml(e.adresse||"-")}</td>\n      <td>${escapeHtml(e.telefon||"-")}</td>\n      <td>${escapeHtml(e.epost||"-")}</td>\n      <td>\n        <button class="btn-icon" onclick="editOrgCustomer(${e.id})" title="Rediger">\n          <i class="fas fa-pen"></i>\n        </button>\n        <button class="btn-icon delete" onclick="deleteOrgCustomer(${e.id})" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </td>\n    </tr>\n  `).join(""):t.innerHTML='\n      <tr>\n        <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n          Ingen kunder registrert\n        </td>\n      </tr>\n    ')}async function loadOrgUsers(e){try{const t=await fetch(`/api/super-admin/organizations/${e}/brukere`,{headers:{Authorization:`Bearer ${authToken}`}});if(!t.ok)return void console.error("Failed to load org users");const n=await t.json();n.success&&(renderOrgUsers(n.data||[]),updateElement("orgUserCount",(n.data||[]).length))}catch(e){console.error("Error loading org users:",e)}}function renderOrgUsers(e){const t=document.getElementById("orgUsersBody");t&&(0!==e.length?t.innerHTML=e.map(e=>{const t=e.sist_innlogget?formatRelativeTime(e.sist_innlogget):"Aldri",n=e.opprettet?new Date(e.opprettet).toLocaleDateString("nb-NO"):"-";return`\n      <tr>\n        <td><strong>${escapeHtml(e.navn)}</strong></td>\n        <td>${escapeHtml(e.epost)}</td>\n        <td>${t}</td>\n        <td>${n}</td>\n      </tr>\n    `}).join(""):t.innerHTML='\n      <tr>\n        <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n          Ingen brukere registrert\n        </td>\n      </tr>\n    ')}function closeOrgDetails(){selectedOrgId=null,selectedOrgData=null;const e=document.getElementById("selectedOrgSection");e&&(e.style.display="none")}async function addOrgCustomer(){selectedOrgId&&openCustomerModal(null,selectedOrgId)}async function editOrgCustomer(e){if(selectedOrgId)try{const t=await fetch(`/api/super-admin/organizations/${selectedOrgId}/kunder`,{headers:{Authorization:`Bearer ${authToken}`}});if(!t.ok)return;const n=((await t.json()).data||[]).find(t=>t.id===e);n&&openCustomerModal(n,selectedOrgId)}catch(e){console.error("Error fetching customer:",e)}}async function deleteOrgCustomer(e){if(selectedOrgId&&confirm("Er du sikker på at du vil slette denne kunden?"))try{const t=await fetch(`/api/super-admin/organizations/${selectedOrgId}/kunder/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${authToken}`}});if(t.ok)showNotification("Kunde slettet"),await loadOrgCustomers(selectedOrgId),await loadGlobalStatistics();else{const e=await t.json();showNotification(e.error?.message||"Kunne ikke slette kunden","error")}}catch(e){console.error("Error deleting customer:",e),showNotification("Feil ved sletting av kunde","error")}}function openCustomerModal(e=null,t=null){const n=document.getElementById("superAdminCustomerModal");n&&n.remove();const a=document.createElement("div");a.id="superAdminCustomerModal",a.className="modal",a.innerHTML=`\n    <div class="modal-content" style="max-width: 500px;">\n      <div class="modal-header">\n        <h2>${e?"Rediger kunde":"Ny kunde"}</h2>\n        <button class="modal-close" onclick="closeSuperAdminCustomerModal()">&times;</button>\n      </div>\n      <form id="superAdminCustomerForm" onsubmit="saveSuperAdminCustomer(event)">\n        <input type="hidden" id="saKundeId" value="${e?.id||""}">\n        <input type="hidden" id="saKundeOrgId" value="${t||""}">\n\n        <div class="form-group">\n          <label for="saKundeNavn">Navn *</label>\n          <input type="text" id="saKundeNavn" value="${escapeHtml(e?.navn||"")}" required>\n        </div>\n\n        <div class="form-group">\n          <label for="saKundeAdresse">Adresse *</label>\n          <input type="text" id="saKundeAdresse" value="${escapeHtml(e?.adresse||"")}" required>\n        </div>\n\n        <div class="form-row">\n          <div class="form-group">\n            <label for="saKundePostnummer">Postnummer</label>\n            <input type="text" id="saKundePostnummer" value="${escapeHtml(e?.postnummer||"")}">\n          </div>\n          <div class="form-group">\n            <label for="saKundePoststed">Poststed</label>\n            <input type="text" id="saKundePoststed" value="${escapeHtml(e?.poststed||"")}">\n          </div>\n        </div>\n\n        <div class="form-row">\n          <div class="form-group">\n            <label for="saKundeTelefon">Telefon</label>\n            <input type="text" id="saKundeTelefon" value="${escapeHtml(e?.telefon||"")}">\n          </div>\n          <div class="form-group">\n            <label for="saKundeEpost">E-post</label>\n            <input type="email" id="saKundeEpost" value="${escapeHtml(e?.epost||"")}">\n          </div>\n        </div>\n\n        <div class="form-group">\n          <label for="saKundeKontaktperson">Kontaktperson</label>\n          <input type="text" id="saKundeKontaktperson" value="${escapeHtml(e?.kontaktperson||"")}">\n        </div>\n\n        <div class="form-group">\n          <label for="saKundeNotater">Notater</label>\n          <textarea id="saKundeNotater" rows="3">${escapeHtml(e?.notater||"")}</textarea>\n        </div>\n\n        <div class="modal-actions">\n          <button type="button" class="btn btn-secondary" onclick="closeSuperAdminCustomerModal()">Avbryt</button>\n          <button type="submit" class="btn btn-primary">${e?"Lagre":"Opprett"}</button>\n        </div>\n      </form>\n    </div>\n  `,document.body.appendChild(a)}function closeSuperAdminCustomerModal(){const e=document.getElementById("superAdminCustomerModal");e&&e.remove()}async function saveSuperAdminCustomer(e){e.preventDefault();const t=document.getElementById("saKundeId").value,n=document.getElementById("saKundeOrgId").value,a={navn:document.getElementById("saKundeNavn").value,adresse:document.getElementById("saKundeAdresse").value,postnummer:document.getElementById("saKundePostnummer").value,poststed:document.getElementById("saKundePoststed").value,telefon:document.getElementById("saKundeTelefon").value,epost:document.getElementById("saKundeEpost").value,kontaktperson:document.getElementById("saKundeKontaktperson").value,notater:document.getElementById("saKundeNotater").value};try{let e=`/api/super-admin/organizations/${n}/kunder`,s="POST";t&&(e+=`/${t}`,s="PUT");const o=await fetch(e,{method:s,headers:{Authorization:`Bearer ${authToken}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(o.ok)showNotification(t?"Kunde oppdatert":"Kunde opprettet"),closeSuperAdminCustomerModal(),await loadOrgCustomers(n),await loadGlobalStatistics();else{const e=await o.json();showNotification(e.error?.message||"Kunne ikke lagre kunden","error")}}catch(e){console.error("Error saving customer:",e),showNotification("Feil ved lagring av kunde","error")}}function initSuperAdminUI(){const e=document.getElementById("orgSearchInput");e&&e.addEventListener("input",debounce(e=>{renderOrganizationList(e.target.value)},300));const t=document.getElementById("closeOrgDetailsBtn");t&&t.addEventListener("click",closeOrgDetails);const n=document.getElementById("addOrgCustomerBtn");n&&n.addEventListener("click",addOrgCustomer);const a=document.querySelectorAll(".org-tab-btn");a.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;a.forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById("orgCustomersTab").style.display="customers"===t?"block":"none",document.getElementById("orgUsersTab").style.display="users"===t?"block":"none"})})}window.selectOrganization=selectOrganization,window.editOrgCustomer=editOrgCustomer,window.deleteOrgCustomer=deleteOrgCustomer,window.closeSuperAdminCustomerModal=closeSuperAdminCustomerModal,window.saveSuperAdminCustomer=saveSuperAdminCustomer;let isMobile=window.innerWidth<=768,touchStartY=0,sidebarOpen=!1;function initMobileUI(){isMobile=window.innerWidth<=768,isMobile&&setupMobileInteractions(),window.addEventListener("resize",debounce(()=>{const e=isMobile;isMobile=window.innerWidth<=768,isMobile&&!e?setupMobileInteractions():!isMobile&&e&&removeMobileInteractions()},250))}function setupMobileInteractions(){const e=document.querySelector(".sidebar"),t=document.querySelector(".sidebar-header"),n=document.querySelector(".filter-panel"),a=document.querySelector("#tab-customers");if(!e)return;e.classList.remove("collapsed"),n&&a&&!a.contains(n)&&(n.dataset.originalParent="map-container",a.appendChild(n),n.classList.remove("collapsed")),t&&(t.addEventListener("touchstart",handleTouchStart,{passive:!0}),t.addEventListener("touchmove",handleTouchMove,{passive:!1}),t.addEventListener("touchend",handleTouchEnd,{passive:!0}),t.addEventListener("click",e=>{e.target.closest("button")||toggleMobileSidebar()}));const s=document.querySelector(".map-container");s&&s.addEventListener("click",()=>{sidebarOpen&&closeMobileSidebar()}),addMobileMenuButton(),document.body.style.overflow="hidden"}function removeMobileInteractions(){const e=document.querySelector(".sidebar");e&&e.classList.remove("mobile-open");const t=document.querySelector(".filter-panel"),n=document.querySelector(".map-container");t&&n&&"map-container"===t.dataset.originalParent&&(n.appendChild(t),delete t.dataset.originalParent);const a=document.querySelector(".mobile-menu-toggle");a&&a.remove(),document.body.style.overflow=""}function addMobileMenuButton(){if(document.querySelector(".mobile-menu-toggle"))return;const e=document.createElement("button");e.className="mobile-menu-toggle",e.innerHTML='<i class="fas fa-bars"></i>',e.setAttribute("aria-label","Åpne meny"),e.addEventListener("click",()=>{toggleMobileSidebar(),e.classList.toggle("active",sidebarOpen),e.innerHTML=sidebarOpen?'<i class="fas fa-times"></i>':'<i class="fas fa-bars"></i>'}),document.body.appendChild(e)}function toggleMobileSidebar(){const e=document.querySelector(".sidebar");if(!e)return;sidebarOpen=!sidebarOpen,e.classList.toggle("mobile-open",sidebarOpen);const t=document.querySelector(".mobile-menu-toggle");t&&(t.classList.toggle("active",sidebarOpen),t.innerHTML=sidebarOpen?'<i class="fas fa-times"></i>':'<i class="fas fa-bars"></i>')}function closeMobileSidebar(){const e=document.querySelector(".sidebar");if(!e)return;sidebarOpen=!1,e.classList.remove("mobile-open");const t=document.querySelector(".mobile-menu-toggle");t&&(t.classList.remove("active"),t.innerHTML='<i class="fas fa-bars"></i>')}function openMobileSidebar(){const e=document.querySelector(".sidebar");if(!e)return;sidebarOpen=!0,e.classList.add("mobile-open");const t=document.querySelector(".mobile-menu-toggle");t&&(t.classList.add("active"),t.innerHTML='<i class="fas fa-times"></i>')}function handleTouchStart(e){touchStartY=e.touches[0].clientY}function handleTouchMove(e){if(!touchStartY)return;const t=e.touches[0].clientY,n=touchStartY-t;n>50&&!sidebarOpen?(e.preventDefault(),openMobileSidebar(),touchStartY=0):n<-50&&sidebarOpen&&(e.preventDefault(),closeMobileSidebar(),touchStartY=0)}function handleTouchEnd(){touchStartY=0}function setViewportHeight(){const e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`)}document.addEventListener("DOMContentLoaded",()=>{setTimeout(initMobileUI,100)}),setViewportHeight(),window.addEventListener("resize",setViewportHeight),window.toggleMobileSidebar=toggleMobileSidebar,window.closeMobileSidebar=closeMobileSidebar,window.openMobileSidebar=openMobileSidebar;