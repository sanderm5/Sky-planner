function escapeHtml(e){if(null==e)return"";const t=String(e),n=document.createElement("div");return n.textContent=t,n.innerHTML}const Logger={isDev:()=>"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.search.includes("debug=true"),log:function(...e){this.isDev()&&console.log("[DEBUG]",...e)},warn:function(...e){this.isDev()&&console.warn("[WARN]",...e)},error:console.error.bind(console,"[ERROR]")};function getCsrfToken(){const e=document.cookie.match(/(?:^|; )csrf_token=([^;]*)/);return e?decodeURIComponent(e[1]):null}const FocusTrap={_previouslyFocused:null,_getFocusable:e=>[...e.querySelectorAll('a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]):not([type="hidden"]), select:not([disabled]), [tabindex]:not([tabindex="-1"])')].filter(e=>null!==e.offsetParent),activate(e){this._previouslyFocused=document.activeElement;const t=this._getFocusable(e);t.length>0&&setTimeout(()=>t[0].focus(),50),e._trapHandler=t=>{if("Tab"!==t.key)return;const n=this._getFocusable(e);if(0===n.length)return;const a=n[0],s=n[n.length-1];t.shiftKey&&document.activeElement===a?(t.preventDefault(),s.focus()):t.shiftKey||document.activeElement!==s||(t.preventDefault(),a.focus())},e.addEventListener("keydown",e._trapHandler)},deactivate(e){e&&e._trapHandler&&(e.removeEventListener("keydown",e._trapHandler),delete e._trapHandler),this._previouslyFocused&&this._previouslyFocused.focus&&(this._previouslyFocused.focus(),this._previouslyFocused=null)}},ModalSystem={container:null,init(){this.container||(this.container=document.createElement("div"),this.container.id="modal-system-container",this.container.innerHTML='\n      <div class="modal-system-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-system-title" style="\n        display: none;\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 100000;\n        justify-content: center;\n        align-items: center;\n        padding: 20px;\n      ">\n        <div class="modal-system-dialog" style="\n          background: var(--color-bg-secondary, #1a1a1a);\n          border-radius: 16px;\n          max-width: 480px;\n          width: 100%;\n          padding: 32px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n          border: 1px solid var(--color-border, #333);\n        ">\n          <div class="modal-system-icon" style="\n            text-align: center;\n            margin-bottom: 20px;\n            font-size: 48px;\n          "></div>\n          <h2 class="modal-system-title" id="modal-system-title" style="\n            font-size: 22px;\n            font-weight: 600;\n            color: var(--color-text-primary, #fff);\n            margin: 0 0 16px 0;\n            text-align: center;\n            line-height: 1.4;\n          "></h2>\n          <p class="modal-system-message" style="\n            font-size: 18px;\n            color: var(--color-text-secondary, #a0a0a0);\n            margin: 0 0 28px 0;\n            text-align: center;\n            line-height: 1.6;\n          "></p>\n          <div class="modal-system-buttons" style="\n            display: flex;\n            gap: 12px;\n            justify-content: center;\n            flex-wrap: wrap;\n          "></div>\n        </div>\n      </div>\n    ',document.body.appendChild(this.container))},show(e){this.init();const t=this.container.querySelector(".modal-system-overlay"),n=this.container.querySelector(".modal-system-icon"),a=this.container.querySelector(".modal-system-title"),s=this.container.querySelector(".modal-system-message"),o=this.container.querySelector(".modal-system-buttons"),r={success:'<span style="color: #4CAF50;">&#10004;</span>',error:'<span style="color: #DC2626;">&#10006;</span>',warning:'<span style="color: #FFC107;">&#9888;</span>',info:'<span style="color: #42A5F5;">&#8505;</span>',confirm:'<span style="color: #5E81AC;">&#63;</span>'};n.innerHTML=r[e.type]||r.info,a.textContent=e.title||"",a.style.display=e.title?"block":"none",s.textContent=e.message||"",o.innerHTML="";e.buttons&&e.buttons.forEach((e,t)=>{const n=document.createElement("button");n.textContent=e.text,n.style.cssText="\n      min-height: 52px;\n      padding: 14px 28px;\n      font-size: 18px;\n      font-weight: 600;\n      border-radius: 10px;\n      border: none;\n      cursor: pointer;\n      transition: all 0.2s;\n      min-width: 120px;\n    ",e.primary?(n.style.background="var(--color-accent, #5E81AC)",n.style.color="#fff"):(n.style.background="var(--color-bg-tertiary, #252525)",n.style.color="var(--color-text-primary, #fff)",n.style.border="1px solid var(--color-border, #333)"),n.onclick=()=>{this.hide(),e.onClick&&e.onClick()},0===t&&setTimeout(()=>n.focus(),100),o.appendChild(n)}),t.style.display="flex",t.style.opacity="0",requestAnimationFrame(()=>{t.style.transition="opacity 0.2s",t.style.opacity="1"});const i=this.container.querySelector(".modal-system-dialog");i&&void 0!==FocusTrap&&FocusTrap.activate(i),this._escHandler=e=>{"Escape"===e.key&&this.hide()},document.addEventListener("keydown",this._escHandler)},hide(){const e=this.container?.querySelector(".modal-system-dialog");e&&void 0!==FocusTrap&&FocusTrap.deactivate(e),this._escHandler&&(document.removeEventListener("keydown",this._escHandler),this._escHandler=null);const t=this.container?.querySelector(".modal-system-overlay");t&&(t.style.opacity="0",setTimeout(()=>{t.style.display="none"},200))}};function showMessage(e,t="info",n=""){ModalSystem.show({type:t,title:n||{success:"Fullfort",error:"Feil",warning:"Advarsel",info:"Informasjon"}[t]||"",message:e,buttons:[{text:"OK",primary:!0}]})}function showConfirm(e,t="Bekreft"){return new Promise(n=>{ModalSystem.show({type:"confirm",title:t,message:e,buttons:[{text:"Nei",primary:!1,onClick:()=>n(!1)},{text:"Ja",primary:!0,onClick:()=>n(!0)}]})})}function showToast(e,t="info",n=3e3){const a=document.querySelector(".toast-notification");a&&a.remove();const s=document.createElement("div");return s.className=`toast-notification toast-${t}`,s.setAttribute("role","status"),s.setAttribute("aria-live","polite"),s.innerHTML=`\n    <i class="fas ${"success"===t?"fa-check-circle":"error"===t?"fa-exclamation-circle":"fa-info-circle"}" aria-hidden="true"></i>\n    <span>${escapeHtml(e)}</span>\n  `,document.body.appendChild(s),requestAnimationFrame(()=>{s.classList.add("visible")}),n>0&&setTimeout(()=>{s.classList.remove("visible"),setTimeout(()=>s.remove(),300)},n),s}const svgIcons={"el-kontroll":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>\n  </svg>',brannvarsling:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/>\n  </svg>',"borettslag-sameie":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="4" y="2" width="16" height="20" rx="2"/>\n    <path d="M9 22v-4h6v4"/>\n    <path d="M8 6h.01M16 6h.01M8 10h.01M16 10h.01M8 14h.01M16 14h.01"/>\n  </svg>',renhold:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M12 3v5m0 8v5M5.5 8.5l3.5 3.5m6 0l3.5-3.5M3 12h5m8 0h5"/>\n    <circle cx="12" cy="12" r="2"/>\n  </svg>',vaktmester:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <circle cx="12" cy="12" r="3"/>\n    <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>\n  </svg>',"hvac-ventilasjon":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <circle cx="12" cy="12" r="3"/>\n    <path d="M12 9a9.5 9.5 0 005-7"/>\n    <path d="M15 12a9.5 9.5 0 007 5"/>\n    <path d="M12 15a9.5 9.5 0 00-5 7"/>\n    <path d="M9 12a9.5 9.5 0 00-7-5"/>\n  </svg>',"heis-lofteutstyr":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="5" y="2" width="14" height="20" rx="2"/>\n    <path d="M9 8l3-3 3 3"/>\n    <path d="M9 16l3 3 3-3"/>\n    <line x1="12" y1="5" x2="12" y2="19"/>\n  </svg>',"sikkerhet-vakt":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>\n    <path d="M9 12l2 2 4-4"/>\n  </svg>',skadedyrkontroll:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M8 2l1.88 1.88"/>\n    <path d="M14.12 3.88L16 2"/>\n    <path d="M9 7.13v-1a3.003 3.003 0 116 0v1"/>\n    <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 014-4h4a4 4 0 014 4v3c0 3.3-2.7 6-6 6"/>\n    <path d="M12 20v-9"/>\n    <path d="M6.53 9C4.6 8.8 3 7.1 3 5"/>\n    <path d="M6 13H2"/>\n    <path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>\n    <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/>\n    <path d="M22 13h-4"/>\n    <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>\n  </svg>',"vvs-rorlegger":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M14 6a4 4 0 01-4-4"/>\n    <path d="M6 6a4 4 0 014-4"/>\n    <path d="M6 6v6a6 6 0 0012 0V6"/>\n    <path d="M12 16v4"/>\n    <path d="M8 20h8"/>\n    <path d="M12 12a2 2 0 100-4 2 2 0 000 4z"/>\n  </svg>',takservice:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M3 12l9-9 9 9"/>\n    <path d="M5 10v10a1 1 0 001 1h12a1 1 0 001-1V10"/>\n    <path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/>\n  </svg>',hagearbeid:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M11 20A7 7 0 019.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10z"/>\n    <path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>\n  </svg>',"it-service":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="2" y="3" width="20" height="14" rx="2"/>\n    <line x1="8" y1="21" x2="16" y2="21"/>\n    <line x1="12" y1="17" x2="12" y2="21"/>\n    <path d="M8 9l-2 2 2 2"/>\n    <path d="M16 9l2 2-2 2"/>\n  </svg>',vinduspuss:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <rect x="3" y="3" width="18" height="18" rx="2"/>\n    <line x1="12" y1="3" x2="12" y2="21"/>\n    <line x1="3" y1="12" x2="21" y2="12"/>\n    <path d="M18 6l-3 3"/>\n    <path d="M16.5 4.5l1 1"/>\n  </svg>',avfallshandtering:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M7 19H4.815a1.83 1.83 0 01-1.57-.881 1.785 1.785 0 01-.004-1.784L7.196 9.5"/>\n    <path d="M11 19h8.203a1.83 1.83 0 001.556-.89 1.784 1.784 0 00-.004-1.775L16.8 9.5"/>\n    <path d="M9.5 6.5l1.474-2.381A1.829 1.829 0 0112.54 3a1.78 1.78 0 011.578.885L17 9.5"/>\n    <path d="M2.5 14.5L5 12l2.5 2.5"/>\n    <path d="M16.5 12L19 14.5 21.5 12"/>\n    <path d="M14 6l-2-3.5L10 6"/>\n  </svg>',"vedlikehold-bygg":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 010-3L12 9"/>\n    <path d="M17.64 15L22 10.64"/>\n    <path d="M20.91 11.7l-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 00-3.94-1.64H9l.92.82A6.18 6.18 0 0112 8.4v1.56l2 2h2.47l2.26 1.91"/>\n  </svg>',"serviceavtaler-generell":'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M11 17a4 4 0 01-8 0v-3a3 3 0 013-3h2"/>\n    <path d="M13 17a4 4 0 008 0v-3a3 3 0 00-3-3h-2"/>\n    <path d="M11.5 11L9 8.5 11 7l5 4.5"/>\n    <path d="M17 8l-5.5 5.5"/>\n    <path d="M6 10l1 3"/>\n    <path d="M18 10l-1 3"/>\n  </svg>',service:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>\n  </svg>'},industryPalettes={"el-kontroll":{light:"#FBBF24",primary:"#F59E0B",dark:"#D97706"},brannvarsling:{light:"#EF4444",primary:"#DC2626",dark:"#B91C1C"},"borettslag-sameie":{light:"#60A5FA",primary:"#3B82F6",dark:"#2563EB"},renhold:{light:"#22D3EE",primary:"#06B6D4",dark:"#0891B2"},vaktmester:{light:"#FCD34D",primary:"#F59E0B",dark:"#D97706"},"hvac-ventilasjon":{light:"#38BDF8",primary:"#0EA5E9",dark:"#0284C7"},"heis-lofteutstyr":{light:"#818CF8",primary:"#6366F1",dark:"#4F46E5"},"sikkerhet-vakt":{light:"#3B82F6",primary:"#1E40AF",dark:"#1E3A8A"},skadedyrkontroll:{light:"#A3E635",primary:"#84CC16",dark:"#65A30D"},"vvs-rorlegger":{light:"#22D3EE",primary:"#0891B2",dark:"#0E7490"},takservice:{light:"#A8A29E",primary:"#78716C",dark:"#57534E"},hagearbeid:{light:"#4ADE80",primary:"#22C55E",dark:"#16A34A"},"it-service":{light:"#A78BFA",primary:"#8B5CF6",dark:"#7C3AED"},vinduspuss:{light:"#7DD3FC",primary:"#38BDF8",dark:"#0EA5E9"},avfallshandtering:{light:"#4ADE80",primary:"#16A34A",dark:"#15803D"},"vedlikehold-bygg":{light:"#B45309",primary:"#92400E",dark:"#78350F"},"serviceavtaler-generell":{light:"#C4B5FD",primary:"#A855F7",dark:"#9333EA"},service:{light:"#60A5FA",primary:"#3B82F6",dark:"#2563EB"}};function initializeTheme(){document.documentElement.setAttribute("data-theme",currentTheme),updateMapTilesForTheme(currentTheme)}function toggleTheme(){currentTheme="dark"===currentTheme?"light":"dark",document.documentElement.setAttribute("data-theme",currentTheme),localStorage.setItem("theme",currentTheme),updateMapTilesForTheme(currentTheme)}function updateMapTilesForTheme(e){if(!map)return;map.eachLayer(t=>{if(t instanceof L.TileLayer){const n=t._url;n&&(n.includes("dark_all")||n.includes("light_all"))&&t.setUrl("dark"===e?"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png")}})}function sortByNavn(e){return e.sort((e,t)=>e.navn.localeCompare(t.navn,"nb"))}function compareNorwegian(e,t){return e.localeCompare(t,"nb")}function hasFeature(e){return appConfig.enabledFeatures?.includes(e)??!1}function getFeatureConfig(e){return appConfig.featureConfigs?.[e]??{}}function isFullMode(){return appConfig.appMode?"full"===appConfig.appMode:"full"===localStorage.getItem("appMode")}function isMvpMode(){return!isFullMode()}function applyMvpModeUI(){const e=isMvpMode();[document.getElementById("elTypeFilter"),document.getElementById("driftskategoriFilter"),document.getElementById("brannsystemFilter"),document.querySelector(".color-legend"),document.getElementById("dynamicFieldFilters")].forEach(t=>{t&&(t.style.display=e?"none":"")});const t=document.querySelector(".filter-panel-header h3");t&&(t.innerHTML=e?'<i class="fas fa-users"></i> Kunder':'<i class="fas fa-filter"></i> Kunder'),Logger.log("Feature mode UI applied: "+(e?"MVP (simplified)":"Full (features enabled)")),appConfig.enabledFeatures?.length&&Logger.log("Enabled features:",appConfig.enabledFeatures.join(", "))}function canEdit(){const e=localStorage.getItem("userRole")||"leser";return"admin"===e||"redigerer"===e}function isAdmin(){return"admin"===(localStorage.getItem("userRole")||"leser")}function applyRoleUI(){const e=localStorage.getItem("userRole")||"leser";document.body.classList.remove("role-leser","role-redigerer","role-admin"),document.body.classList.add(`role-${e}`)}function handleLogout(){stopTokenRefresh();const e={"Content-Type":"application/json"},t=getCsrfToken();t&&(e["X-CSRF-Token"]=t),fetch("/api/klient/logout",{method:"POST",headers:e,credentials:"include"}).catch(e=>console.error("Logout request failed:",e)),authToken=null,isSuperAdmin=!1,appInitialized=!1,localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userRole"),localStorage.removeItem("userType"),localStorage.removeItem("isSuperAdmin"),localStorage.removeItem("organizationId"),localStorage.removeItem("organizationSlug"),localStorage.removeItem("organizationName"),localStorage.removeItem("appMode"),localStorage.removeItem("industrySlug"),localStorage.removeItem("industryName"),localStorage.removeItem("isImpersonating"),localStorage.removeItem("impersonatingOrgId"),localStorage.removeItem("impersonatingOrgName"),appConfig.appMode="mvp",showLoginView()}async function stopImpersonation(){try{const e={"Content-Type":"application/json"},t=getCsrfToken();t&&(e["X-CSRF-Token"]=t);const n=await fetch("/api/super-admin/stop-impersonation",{method:"POST",headers:e,credentials:"include"}),a=await n.json();a.success?(localStorage.removeItem("isImpersonating"),localStorage.removeItem("impersonatingOrgId"),localStorage.removeItem("impersonatingOrgName"),window.location.href="/admin"):(console.error("Failed to stop impersonation:",a.error),alert("Kunne ikke avslutte impersonering"))}catch(e){console.error("Error stopping impersonation:",e),alert("Kunne ikke avslutte impersonering")}}async function checkExistingAuth(){try{const e=await fetch("/api/klient/verify",{credentials:"include"});if(e.ok){const t=await e.json();if(t.success&&t.data&&t.data.valid){const{token:e,user:n,organization:a}=t.data;return e&&(authToken=e),n&&(localStorage.setItem("userName",n.navn||"Bruker"),localStorage.setItem("userEmail",n.epost||""),localStorage.setItem("userType",n.type||"klient"),localStorage.setItem("userRole",n.rolle||("bruker"===n.type?"admin":"leser")),n.isSuperAdmin?localStorage.setItem("isSuperAdmin","true"):localStorage.removeItem("isSuperAdmin")),a&&(localStorage.setItem("organizationId",a.id),localStorage.setItem("organizationSlug",a.slug),appConfig.companyName=a.navn,appConfig.logoUrl=a.logoUrl,appConfig.primaryColor=a.primaryColor,appConfig.brandTitle=a.brandTitle||a.navn,appConfig.appMode=a.appMode||"mvp",localStorage.setItem("appMode",appConfig.appMode),subscriptionInfo={status:a.subscriptionStatus,trialEndsAt:a.trialEndsAt,planType:a.planType},await reloadConfigWithAuth()),applyRoleUI(),Logger.log("SSO session verified successfully"),!0}}}catch(e){Logger.warn("SSO verification failed:",e)}if(authToken)try{const e=await fetch("/api/klient/dashboard",{credentials:"include"});if(e.ok){const t=await e.json();return t.klient&&(localStorage.setItem("userName",t.klient.navn||"Bruker"),localStorage.setItem("userRole",t.klient.rolle||"leser"),localStorage.setItem("userType",t.klient.type||"klient")),applyRoleUI(),!0}}catch(e){}return authToken=null,localStorage.removeItem("authToken"),localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userRole"),localStorage.removeItem("userType"),!1}let isRefreshingToken=!1,refreshPromise=null;function isAccessTokenExpiringSoon(){if(!accessTokenExpiresAt)return!1;const e="number"==typeof accessTokenExpiresAt?accessTokenExpiresAt:parseInt(accessTokenExpiresAt,10);return Date.now()>e-12e4}async function refreshAccessToken(){return isRefreshingToken&&refreshPromise||(isRefreshingToken=!0,refreshPromise=(async()=>{try{const e={"Content-Type":"application/json"},t=getCsrfToken();t&&(e["X-CSRF-Token"]=t);const n=await fetch("/api/klient/refresh",{method:"POST",headers:e,credentials:"include"});if(n.ok){const e=await n.json();return authToken=e.accessToken||e.token,Logger.log("Access token refreshed successfully"),!0}return Logger.warn("Token refresh failed:",n.status),!1}catch(e){return console.error("Token refresh error:",e),!1}finally{isRefreshingToken=!1,refreshPromise=null}})()),refreshPromise}let tokenRefreshInterval=null;function setupTokenRefresh(){tokenRefreshInterval&&clearInterval(tokenRefreshInterval),tokenRefreshInterval=setInterval(async()=>{if(!accessTokenExpiresAt)return;const e="number"==typeof accessTokenExpiresAt?accessTokenExpiresAt:parseInt(accessTokenExpiresAt,10),t=Date.now();if(e-t<3e5&&e>t){Logger.log("Proactive token refresh triggered");await refreshAccessToken()?(await reloadConfigWithAuth(),Logger.log("Config reloaded after token refresh")):Logger.warn("Proactive token refresh failed")}},6e4),Logger.log("Token refresh interval started")}function stopTokenRefresh(){tokenRefreshInterval&&(clearInterval(tokenRefreshInterval),tokenRefreshInterval=null,Logger.log("Token refresh interval stopped"))}async function apiFetch(e,t={}){if(authToken&&isAccessTokenExpiringSoon()){if(!await refreshAccessToken())throw handleLogout(),new Error("Sesjon utløpt")}const n={"Content-Type":"application/json",...t.headers},a=(t.method||"GET").toUpperCase();if(["POST","PUT","PATCH","DELETE"].includes(a)){const e=getCsrfToken();e&&(n["X-CSRF-Token"]=e)}const s=await fetch(e,{...t,headers:n,credentials:"include"});if(401===s.status){const n=await s.json().catch(()=>({}));if(authToken&&!t._retried){if(await refreshAccessToken())return apiFetch(e,{...t,_retried:!0})}if(n.requireLogin||"Sesjonen har utløpt"===n.error)throw handleLogout(),new Error("Ikke innlogget")}if(403===s.status){const e=await s.clone().json().catch(()=>({}));if("SUBSCRIPTION_INACTIVE"===e.code)throw showSubscriptionError(e),new Error(e.error||"Abonnementet er ikke aktivt")}const o=s.headers.get("X-Subscription-Warning");return o&&showSubscriptionWarningBanner(o),s}function showSubscriptionWarningBanner(e){if(window._subscriptionWarningShown)return;window._subscriptionWarningShown=!0;const t=document.getElementById("subscriptionWarningBanner");t&&t.remove();const n=document.createElement("div");n.id="subscriptionWarningBanner",n.style.cssText="position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:14px;",n.innerHTML=`\n    <div style="display:flex;align-items:center;gap:10px;">\n      <i class="fas fa-exclamation-circle"></i>\n      <span>${escapeHtml(e)}</span>\n    </div>\n    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;cursor:pointer;font-size:18px;padding:0 5px;">&times;</button>\n  `,document.body.prepend(n)}let subscriptionTimerInterval=null;function decodeJWT(e){try{const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(n)}catch(e){return null}}function initSubscriptionTimer(){if("enterprise"===subscriptionInfo?.planType)return void hideSubscriptionTimer();if(!subscriptionInfo)return;const{status:e,trialEndsAt:t}=subscriptionInfo;if("trialing"!==e)return void hideSubscriptionTimer();if(!t)return void hideSubscriptionTimer();const n=new Date(t),a="Prøveperiode";updateSubscriptionTimer(n,a),subscriptionTimerInterval&&clearInterval(subscriptionTimerInterval),subscriptionTimerInterval=setInterval(()=>{updateSubscriptionTimer(n,a)},6e4)}function updateSubscriptionTimer(e,t){const n=document.getElementById("subscriptionTimer"),a=document.getElementById("subscriptionTimerText");if(!n||!a)return;const s=e-new Date;if(s<=0)return a.textContent="Utløpt",n.classList.add("warning"),void(n.style.display="flex");const o=Math.floor(s/864e5),r=Math.floor(s%864e5/36e5),i=Math.floor(s%36e5/6e4);let l="";l=o>0?`${o}d ${r}t`:r>0?`${r}t ${i}m`:`${i}m`,a.textContent=`${t}: ${l}`,o<3?n.classList.add("warning"):n.classList.remove("warning"),n.style.display="flex"}function hideSubscriptionTimer(){const e=document.getElementById("subscriptionTimer");e&&(e.style.display="none"),subscriptionTimerInterval&&(clearInterval(subscriptionTimerInterval),subscriptionTimerInterval=null)}function showSubscriptionError(e){const t=e.error||"Abonnementet er ikke aktivt",n=e.details||{},a=document.getElementById("subscriptionErrorModal");a&&a.remove();const s=document.createElement("div");s.id="subscriptionErrorModal",s.className="modal-overlay",s.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;";const o={trial_expired:"Prøveperioden din har utløpt",canceled:"Abonnementet er kansellert",past_due:"Betalingen har feilet",incomplete:"Abonnementet er ikke fullført",grace_period_exceeded:"Betalingsfristen er utløpt"}[n.reason]||"Abonnement kreves";s.innerHTML=`\n    <div style="background:var(--card-bg, #1a1a2e);border-radius:12px;padding:32px;max-width:450px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);">\n      <div style="width:64px;height:64px;margin:0 auto 20px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:50%;display:flex;align-items:center;justify-content:center;">\n        <i class="fas fa-exclamation-triangle" style="font-size:28px;color:white;"></i>\n      </div>\n      <h2 style="color:var(--text-primary, #fff);margin:0 0 12px;font-size:24px;">${escapeHtml(o)}</h2>\n      <p style="color:var(--text-secondary, #a0a0a0);margin:0 0 24px;font-size:15px;line-height:1.6;">${escapeHtml(t)}</p>\n      <p style="font-size:13px;color:var(--text-muted, #666);">\n        Kontakt administrator for å håndtere abonnementet, eller <a href="mailto:sander@efffekt.no" style="color:#3b82f6;">ta kontakt med support</a>.\n      </p>\n    </div>\n  `,document.body.appendChild(s),s.addEventListener("click",e=>{"A"!==e.target.tagName&&e.stopPropagation()})}let ws=null,wsReconnectTimer=null,wsReconnectAttempts=0,wsInitialized=!1;const MAX_RECONNECT_ATTEMPTS=10,presenceClaims=new Map;let currentClaimedKundeId=null,myUserId=null,myInitials=null;function updateWsConnectionIndicator(e){const t=document.getElementById("ws-connection-indicator");t&&(t.className=e?"ws-indicator ws-connected":"ws-indicator ws-disconnected",t.title=e?"Sanntidsoppdateringer aktiv":"Frakoblet - prøver å koble til...")}function initWebSocket(){if(wsInitialized&&ws&&ws.readyState!==WebSocket.CLOSED)return;wsInitialized=!0;const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}`;try{ws=new WebSocket(e),ws.onopen=()=>{Logger.log("WebSocket connected - sanntidsoppdateringer aktiv"),wsReconnectAttempts=0,updateWsConnectionIndicator(!0)},ws.onmessage=e=>{try{handleRealtimeUpdate(JSON.parse(e.data))}catch(e){console.error("Error parsing WebSocket message:",e)}},ws.onclose=()=>{Logger.log("WebSocket disconnected"),updateWsConnectionIndicator(!1),attemptReconnect()},ws.onerror=e=>{console.error("WebSocket error:",e),updateWsConnectionIndicator(!1)}}catch(e){console.error("Failed to create WebSocket:",e),updateWsConnectionIndicator(!1)}}function attemptReconnect(){if(wsReconnectAttempts>=10)return void Logger.log("Max reconnection attempts reached");wsReconnectAttempts++;const e=Math.min(1e3*Math.pow(2,wsReconnectAttempts),3e4);wsReconnectTimer=setTimeout(()=>{Logger.log(`Attempting WebSocket reconnection (${wsReconnectAttempts}/10)...`),wsInitialized=!1,initWebSocket()},e)}function handleRealtimeUpdate(e){const{type:t,data:n}=e;switch(t){case"connected":if(Logger.log("Server:",n||e.message),n&&n.userId&&(myUserId=n.userId,myInitials=n.initials||""),n&&n.presence){presenceClaims.clear();for(const[e,t]of Object.entries(n.presence))presenceClaims.set(Number(e),t);updatePresenceBadges()}break;case"kunde_created":customers.push(n),applyFilters(),renderCustomerAdmin(),renderMissingData(),updateOverdueBadge(),showNotification(`Ny kunde opprettet: ${n.navn}`);break;case"kunde_updated":const a=customers.findIndex(e=>e.id===Number.parseInt(n.id));-1!==a&&(customers[a]={...customers[a],...n},applyFilters(),renderCustomerAdmin(),renderMissingData(),updateOverdueBadge());break;case"kunde_deleted":customers=customers.filter(e=>e.id!==n.id),selectedCustomers.delete(n.id),applyFilters(),renderCustomerAdmin(),renderMissingData(),updateOverdueBadge(),updateSelectionUI();break;case"kunder_bulk_updated":Logger.log(`Bulk update: ${n.count} kunder oppdatert av annen bruker`),loadCustomers();break;case"avtale_created":case"avtale_updated":case"avtale_deleted":case"avtale_series_deleted":case"avtaler_bulk_created":Logger.log(`Avtale ${t.replace("avtale_","").replace("avtaler_","")}`),"function"==typeof loadAvtaler&&loadAvtaler().then(()=>{"function"==typeof renderCalendar&&renderCalendar()});break;case"rute_created":case"rute_updated":case"rute_deleted":Logger.log(`Rute ${t.replace("rute_","")}`),"function"==typeof loadCustomers&&loadCustomers();break;case"customer_claimed":presenceClaims.set(n.kundeId,{userId:n.userId,userName:n.userName,initials:n.initials}),updatePresenceBadgeForKunde(n.kundeId),n.userId!==myUserId&&Logger.log(`${n.userName} jobber med kunde #${n.kundeId}`);break;case"customer_released":presenceClaims.delete(n.kundeId),updatePresenceBadgeForKunde(n.kundeId);break;case"user_offline":for(const[e,t]of presenceClaims)t.userId===n.userId&&(presenceClaims.delete(e),updatePresenceBadgeForKunde(e));Logger.log(`Bruker frakoblet: ${n.userName}`);break;case"time_update":updateDayCounters();break;case"chat_message":handleIncomingChatMessage(n);break;case"chat_typing":handleChatTyping(n);break;case"chat_typing_stop":handleChatTypingStop(n)}}function claimCustomer(e){if(!ws||ws.readyState!==WebSocket.OPEN)return;currentClaimedKundeId&&currentClaimedKundeId!==e&&releaseCustomer(currentClaimedKundeId),currentClaimedKundeId=e;const t=localStorage.getItem("userName")||"Bruker";ws.send(JSON.stringify({type:"claim_customer",kundeId:e,userName:t}))}function releaseCustomer(e){e&&(currentClaimedKundeId===e&&(currentClaimedKundeId=null),ws&&ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({type:"release_customer",kundeId:e})))}const PRESENCE_COLORS=["#2563eb","#dc2626","#16a34a","#9333ea","#ea580c","#0891b2","#c026d3","#ca8a04","#4f46e5","#0d9488"];function getPresenceColor(e){return PRESENCE_COLORS[e%PRESENCE_COLORS.length]}function updatePresenceBadgeForKunde(e){if(!markers||!markers[e])return;const t=markers[e].getElement();if(!t)return;const n=t.querySelector(".presence-badge");n&&n.remove();const a=presenceClaims.get(e);if(a&&a.userId!==myUserId){const e=document.createElement("div");e.className="presence-badge",e.style.backgroundColor=getPresenceColor(a.userId),e.textContent=a.initials,e.title=`${a.userName} jobber med denne kunden`,t.appendChild(e)}}function updatePresenceBadges(){if(markers)for(const e of Object.keys(markers))updatePresenceBadgeForKunde(Number(e))}class ServiceTypeRegistry{constructor(){this.serviceTypes=new Map,this.intervals=[],this.industryTemplate=null,this.initialized=!1}loadFromConfig(e){this.serviceTypes.clear(),e.serviceTypes&&Array.isArray(e.serviceTypes)&&e.serviceTypes.forEach(e=>{this.serviceTypes.set(e.slug,{id:e.id,name:e.name,slug:e.slug,icon:e.icon||"fa-wrench",color:e.color||"#5E81AC",defaultInterval:e.defaultInterval||12,description:e.description||"",subtypes:e.subtypes||[],equipmentTypes:e.equipmentTypes||[]})}),0===this.serviceTypes.size&&(this.serviceTypes.set("service",{id:0,name:"Service",slug:"service",icon:"fa-wrench",color:"#5E81AC",defaultInterval:12,description:"Generell tjeneste",subtypes:[],equipmentTypes:[]}),Logger.log("Using generic fallback service type (no types configured for this org)")),this.intervals=e.intervals||[],this.industryTemplate=e.industryTemplate||null,this.initialized=!0,Logger.log(`ServiceTypeRegistry loaded: ${this.serviceTypes.size} service types`)}async loadFromIndustry(e){try{const t=await fetch(`/api/industries/${e}`);if(!t.ok)return!1;const n=await t.json();if(n.success&&n.data){this.serviceTypes.clear();const t=n.data;return this.industryTemplate={id:t.id,name:t.name,slug:t.slug,icon:t.icon,color:t.color},t.serviceTypes&&Array.isArray(t.serviceTypes)&&t.serviceTypes.forEach(e=>{this.serviceTypes.set(e.slug,{id:e.id,name:e.name,slug:e.slug,icon:e.icon||"fa-wrench",color:e.color||"#5E81AC",defaultInterval:e.defaultInterval||12,description:e.description||"",subtypes:e.subtypes||[],equipmentTypes:e.equipment||[]})}),t.intervals&&Array.isArray(t.intervals)&&(this.intervals=t.intervals.map(e=>({months:e.months,label:e.label,isDefault:e.isDefault}))),this.initialized=!0,Logger.log(`ServiceTypeRegistry loaded from industry '${e}': ${this.serviceTypes.size} service types`),!0}return!1}catch(e){return console.error("Error loading industry service types:",e),!1}}getAll(){return Array.from(this.serviceTypes.values())}getBySlug(e){return this.serviceTypes.get(e)}getById(e){return this.getAll().find(t=>t.id===e)}getDefaultServiceType(){const e=this.getAll();return e.length>0?e[0]:{slug:"service",name:"Service",icon:"fa-wrench",color:"#5E81AC"}}getIcon(e){const t="string"==typeof e?this.getBySlug(e):e;return t?`<i class="fas ${t.icon}" style="color: ${t.color}"></i>`:'<i class="fas fa-wrench"></i>'}formatInterval(e){const t=this.intervals.find(t=>t.months===e);if(t?.label)return t.label;if(e<0){const t=Math.abs(e);return 7===t?"1 uke":t%7==0?t/7+" uker":`${t} dager`}return e<12?`${e} mnd`:12===e?"1 år":e%12==0?e/12+" år":`${e} mnd`}getIntervalOptions(){return this.intervals.length>0?this.intervals.map(e=>({value:e.months,label:e.label||this.formatInterval(e.months),isDefault:e.isDefault})):[{value:-7,label:"1 uke",isDefault:!1},{value:-14,label:"2 uker",isDefault:!1},{value:1,label:"1 mnd",isDefault:!1},{value:3,label:"3 mnd",isDefault:!1},{value:6,label:"6 mnd",isDefault:!1},{value:12,label:"1 år",isDefault:!0},{value:24,label:"2 år",isDefault:!1},{value:36,label:"3 år",isDefault:!1},{value:60,label:"5 år",isDefault:!1}]}renderCategoryTabs(e="all"){const t=this.getAll();let n=`<button class="kategori-tab ${"all"===e?"active":""}" data-kategori="alle">Alle</button>`;if(t.forEach(t=>{const a=e===t.slug||e===t.name;n+=`<button class="kategori-tab ${a?"active":""}" data-kategori="${t.name}">\n        ${this.getIcon(t)} ${t.name}\n      </button>`}),t.length>=2){const a=t.map(e=>e.name).join(" + "),s=t.length>2?"Alle":"Begge";n+=`<button class="kategori-tab ${e===a||"El-Kontroll + Brannvarsling"===e?"active":""}" data-kategori="${a}">\n        ${t.map(e=>this.getIcon(e)).join("")} ${s}\n      </button>`}return n}renderCategoryCheckboxes(e=""){const t=this.getAll(),n=e.split(" + ").map(e=>e.trim()).filter(Boolean);let a="";return t.forEach(e=>{const t=n.includes(e.name)||n.includes(e.slug)?"checked":"";a+=`\n        <label class="kategori-checkbox-label">\n          <input type="checkbox" name="kategori" value="${escapeHtml(e.name)}" ${t}>\n          <i class="fas ${e.icon||"fa-clipboard-check"}" style="color:${e.color||"#3B82F6"}"></i>\n          ${escapeHtml(e.name)}\n        </label>`}),a}getSelectedCategories(){const e=document.querySelectorAll('#kategoriCheckboxes input[name="kategori"]:checked');return Array.from(e).map(e=>e.value).join(" + ")}renderSubtypeOptions(e,t=""){const n=this.getBySlug(e);if(!n||!n.subtypes||0===n.subtypes.length)return"";let a='<option value="">Ikke valgt</option>';return n.subtypes.forEach(e=>{const n=t===e.name||t===e.slug?"selected":"";a+=`<option value="${escapeHtml(e.name)}" ${n}>${escapeHtml(e.name)}</option>`}),a}renderEquipmentOptions(e,t=""){const n=this.getBySlug(e);if(!n||!n.equipmentTypes||0===n.equipmentTypes.length)return"";let a='<option value="">Ikke valgt</option>';return n.equipmentTypes.forEach(e=>{const n=t===e.name||t===e.slug?"selected":"";a+=`<option value="${escapeHtml(e.name)}" ${n}>${escapeHtml(e.name)}</option>`}),a}renderIntervalOptions(e=null){const t=this.getIntervalOptions();let n="";return t.forEach(t=>{const a=e===t.value||null===e&&t.isDefault?"selected":"";n+=`<option value="${escapeHtml(String(t.value))}" ${a}>${escapeHtml(t.label)}</option>`}),n}matchesCategory(e,t){if("all"===t||"alle"===t)return!0;const n=e.kategori||"";if(!n)return!1;const a=n.split(" + ").map(e=>e.trim()),s=this.getBySlug(t);if(s)return a.includes(s.name);const o=t.split(" + ").map(e=>e.trim());return o.length>1?o.every(e=>a.includes(e)):a.includes(t)}isKnownCategory(e){if(!e)return!0;const t=this.getAll();for(const n of t)if(e===n.name)return!0;if(e.includes("+")){return e.split("+").map(e=>e.trim()).every(e=>t.some(t=>t.name===e))}for(const n of t)if(e.toLowerCase().includes(n.slug.toLowerCase())||e.toLowerCase().includes(n.name.toLowerCase()))return!0;return!1}getCategoryClass(e){const t=this.getAll(),n=this.getDefaultServiceType(),a=e=>e?e.toLowerCase().replace(/[\s-]+/g,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""):"",s=e=>{const n=a(e);for(const e of t)if(n===a(e.name)||n===a(e.slug))return e;for(const e of t)if(n.includes(a(e.slug))||a(e.slug).includes(n))return e;return null};if(!e)return n.slug;if(e.includes("+")){return e.split("+").map(e=>e.trim()).map(e=>s(e)).filter(Boolean).length>0?"combined":n.slug}const o=s(e);if(o)return o.slug;const r=a(e);for(const e of Object.keys(svgIcons))if(r.includes(a(e))||a(e).includes(r))return e;return n.slug}getIconForCategory(e){const t=this.getAll(),n=this.getDefaultServiceType(),a=e=>e?e.toLowerCase().replace(/[\s-]+/g,"").normalize("NFD").replace(/[\u0300-\u036f]/g,""):"",s=e=>`<i class="fas ${e.icon}"></i>`,o=e=>{const n=a(e);for(const e of t)if(n===a(e.name)||n===a(e.slug))return e;for(const e of t)if(n.includes(a(e.slug))||a(e.slug).includes(n))return e;return null};if(!e)return s(n);if(e.includes("+")){const t=e.split("+").map(e=>e.trim()).map(e=>o(e)).filter(Boolean);return t.length>0?t.map(e=>s(e)).join(""):s(n)}const r=o(e);if(r)return s(r);const i=a(e);for(const e of Object.keys(svgIcons))if(i.includes(a(e))||a(e).includes(i))return`<span class="marker-svg-icon">${svgIcons[e]}</span>`;return s(n)}renderServiceSections(e={},t=null){let n=this.getAll();if(0===n.length)return"";if(t&&t.length>0&&(n=n.filter(e=>t.includes(e.name))),0===n.length)return"";const a=e.services||[];let s="";return n.forEach(t=>{let n=a.find(e=>e.service_type_slug===t.slug||e.service_type_id===t.id)||{};n.siste_kontroll||n.neste_kontroll||("el-kontroll"===t.slug&&(e.siste_el_kontroll||e.neste_el_kontroll)?n={...n,siste_kontroll:e.siste_el_kontroll||"",neste_kontroll:e.neste_el_kontroll||"",intervall_months:e.el_kontroll_intervall||t.defaultInterval}:"brannvarsling"===t.slug&&(e.siste_brann_kontroll||e.neste_brann_kontroll)?n={...n,siste_kontroll:e.siste_brann_kontroll||"",neste_kontroll:e.neste_brann_kontroll||"",intervall_months:e.brann_kontroll_intervall||t.defaultInterval}:(e.siste_kontroll||e.neste_kontroll)&&(n={...n,siste_kontroll:e.siste_kontroll||"",neste_kontroll:e.neste_kontroll||"",intervall_months:e.kontroll_intervall_mnd||t.defaultInterval}));const o=t.subtypes&&t.subtypes.length>0,r=t.equipmentTypes&&t.equipmentTypes.length>0;s+=`\n        <div class="control-section service-section" data-service-slug="${t.slug}" data-service-id="${t.id}">\n          <div class="control-section-header">\n            <i class="fas ${t.icon}" style="color: ${t.color}"></i> ${t.name}\n          </div>\n\n          ${o?`\n          <div class="form-group">\n            <label for="service_${t.slug}_subtype">Type</label>\n            <select id="service_${t.slug}_subtype" name="service_${t.slug}_subtype">\n              ${this.renderSubtypeOptions(t.slug,n.subtype_name||"")}\n            </select>\n          </div>\n          `:""}\n\n          ${r?`\n          <div class="form-group">\n            <label for="service_${t.slug}_equipment">System/Utstyr</label>\n            <select id="service_${t.slug}_equipment" name="service_${t.slug}_equipment">\n              ${this.renderEquipmentOptions(t.slug,n.equipment_name||"")}\n            </select>\n          </div>\n          `:""}\n\n          <div class="form-row">\n            <div class="form-group">\n              <label for="service_${t.slug}_siste">Siste kontroll</label>\n              <input type="${"month_year"===appConfig.datoModus?"month":"date"}" id="service_${t.slug}_siste" name="service_${t.slug}_siste"\n                     value="${"month_year"===appConfig.datoModus&&n.siste_kontroll?n.siste_kontroll.substring(0,7):n.siste_kontroll||""}">\n            </div>\n            <div class="form-group">\n              <label for="service_${t.slug}_neste">Neste kontroll</label>\n              <input type="${"month_year"===appConfig.datoModus?"month":"date"}" id="service_${t.slug}_neste" name="service_${t.slug}_neste"\n                     value="${"month_year"===appConfig.datoModus&&n.neste_kontroll?n.neste_kontroll.substring(0,7):n.neste_kontroll||""}">\n            </div>\n          </div>\n\n          <div class="form-group">\n            <label for="service_${t.slug}_intervall">Intervall</label>\n            <select id="service_${t.slug}_intervall" name="service_${t.slug}_intervall">\n              ${this.renderIntervalOptions(n.intervall_months||t.defaultInterval)}\n            </select>\n          </div>\n        </div>\n      `}),s}parseServiceFormData(){const e=this.getAll(),t=[];return e.forEach(e=>{if(!document.querySelector(`.service-section[data-service-slug="${e.slug}"]`))return;const n=document.getElementById(`service_${e.slug}_siste`),a=document.getElementById(`service_${e.slug}_neste`),s=document.getElementById(`service_${e.slug}_intervall`),o=document.getElementById(`service_${e.slug}_subtype`),r=document.getElementById(`service_${e.slug}_equipment`),i=normalizeDateValue(n?.value)||null,l=normalizeDateValue(a?.value)||null,d=s?.value?parseInt(s.value,10):e.defaultInterval,c=o?.value||null,u=r?.value||null;(i||l)&&t.push({service_type_id:e.id,service_type_slug:e.slug,siste_kontroll:i,neste_kontroll:l,intervall_months:d,subtype_name:c,equipment_name:u})}),t}getKategoriFromServices(e){if(!e||0===e.length)return"";const t=this.getAll(),n=[];return e.forEach(e=>{const a=t.find(t=>t.slug===e.service_type_slug||t.id===e.service_type_id);a&&!n.includes(a.name)&&n.push(a.name)}),n.join(" + ")}renderPopupControlInfo(e,t){const n=this.getAll(),a=e.kategori||"",s=e=>{if(!e)return null;return formatDateInline(new Date(e))};if(isMvpMode()){if(n.length>=2){const o=a?a.split(" + ").map(e=>e.trim()):[],r=o.length>0?n.filter(e=>o.includes(e.name)):n,i=r.length>0?r:n;if(1===i.length){const n=i[0];let a=null,o=null;const r=(e.services||[]).find(e=>e.service_type_slug===n.slug||e.service_type_id===n.id);return r&&(a=r.neste_kontroll,o=r.siste_kontroll),"el-kontroll"===n.slug?(a||(a=e.neste_el_kontroll),o||(o=e.siste_el_kontroll)):"brannvarsling"===n.slug&&(a||(a=e.neste_brann_kontroll),o||(o=e.siste_brann_kontroll)),a||(a=e.neste_kontroll),o||(o=e.siste_kontroll||e.last_visit_date),`\n            <div class="popup-control-info">\n              <p class="popup-status ${t.class}">\n                <strong><i class="fas ${n.icon||"fa-clipboard-check"}" style="color:${n.color||"#3B82F6"};display:inline-block;width:14px;text-align:center;"></i> Neste kontroll:</strong>\n                <span class="control-days">${a?s(a):'<span style="color:#5E81AC;">Ikke satt</span>'}</span>\n              </p>\n              ${o?`<p style="font-size: 11px; color: var(--color-text-muted, #b3b3b3); margin-top: 4px;">Sist: ${s(o)}</p>`:""}\n            </div>`}let l='<div class="popup-control-info">';return i.forEach(t=>{let n=null,a=null,o=null;const r=(e.services||[]).find(e=>e.service_type_slug===t.slug||e.service_type_id===t.id);r&&(n=r.neste_kontroll,a=r.siste_kontroll),"el-kontroll"===t.slug?(n||(n=e.neste_el_kontroll),a||(a=e.siste_el_kontroll),o||(o=e.el_kontroll_intervall)):"brannvarsling"===t.slug&&(n||(n=e.neste_brann_kontroll),a||(a=e.siste_brann_kontroll),o||(o=e.brann_kontroll_intervall)),n||(n=e.neste_kontroll),a||(a=e.siste_kontroll||e.last_visit_date),o||(o=e.kontroll_intervall_mnd||t.defaultInterval),l+=`\n            <div style="margin-bottom:8px;">\n              <p style="margin:0;">\n                <strong><i class="fas ${t.icon||"fa-clipboard-check"}" style="color:${t.color||"#3B82F6"};"></i> ${escapeHtml(t.name)}:</strong>\n              </p>\n              <p style="margin:2px 0 0 20px;font-size:13px;">Neste: ${n?s(n):'<span style="color:#5E81AC;">Ikke satt</span>'}</p>\n              ${a?`<p style="margin:2px 0 0 20px;font-size:11px;color:var(--color-text-muted, #b3b3b3);">Sist: ${s(a)}</p>`:""}\n            </div>`}),l+="</div>",l}const o=e.siste_kontroll||e.siste_el_kontroll;return`\n        <div class="popup-control-info">\n          <p class="popup-status ${t.class}">\n            <strong><span class="marker-svg-icon" style="display:inline-block;width:14px;height:14px;vertical-align:middle;color:#3B82F6;">${svgIcons.service}</span> Neste kontroll:</strong>\n            <span class="control-days">${escapeHtml(t.label)}</span>\n          </p>\n          ${o?`<p style="font-size: 11px; color: var(--color-text-muted, #b3b3b3); margin-top: 4px;">Sist: ${s(o)}</p>`:""}\n        </div>`}if(a.includes("+")&&n.length>=2){const t=a.split(" + ").map(e=>e.trim()),o=n.filter(e=>t.includes(e.name)),r=o.length>0?o:n;let i='<div class="popup-controls">';return r.forEach(t=>{const n=(e.services||[]).find(e=>e.service_type_slug===t.slug||e.service_type_id===t.id);let a=n?.neste_kontroll,o=n?.siste_kontroll;a||"el-kontroll"!==t.slug?a||"brannvarsling"!==t.slug||(a=e.neste_brann_kontroll,o=e.siste_brann_kontroll):(a=e.neste_el_kontroll,o=e.siste_el_kontroll),i+=`\n          <p><strong><i class="fas ${t.icon}" style="color: ${t.color};"></i> ${t.name}:</strong></p>\n          <p style="margin-left: 20px;">Neste: ${a?escapeHtml(a):"Ikke satt"}</p>\n          ${o?`<p style="margin-left: 20px; font-size: 11px; color: var(--color-text-muted, #b3b3b3);">Sist: ${s(o)}</p>`:""}\n        `}),i+="</div>",i}const o=n.find(e=>a===e.name||a.toLowerCase().includes(e.slug.toLowerCase()))||n[0];if(!o)return`\n        <div class="popup-control-info">\n          <p class="popup-status ${t.class}">\n            <strong>Neste kontroll:</strong>\n            <span class="control-days">${escapeHtml(t.label)}</span>\n          </p>\n        </div>`;const r=(e.services||[]).find(e=>e.service_type_slug===o.slug||e.service_type_id===o.id);let i=r?.siste_kontroll;return i||(i="el-kontroll"===o.slug?e.siste_el_kontroll:"brannvarsling"===o.slug?e.siste_brann_kontroll:e.siste_kontroll),`\n      <div class="popup-control-info">\n        <p class="popup-status ${t.class}">\n          <strong><i class="fas ${o.icon}" style="color: ${o.color};"></i> Neste kontroll:</strong>\n          <span class="control-days">${escapeHtml(t.label)}</span>\n        </p>\n        ${i?`<p style="font-size: 11px; color: var(--color-text-muted, #b3b3b3); margin-top: 4px;">Sist: ${s(i)}</p>`:""}\n      </div>`}parseCustomData(e){if(!e)return{};if("object"==typeof e)return e;try{return JSON.parse(e)}catch{return{}}}getSubtypeLabel(e){return"el-kontroll"===e.slug?"El-type":"brannvarsling"===e.slug?"Driftstype":`${e.name} type`}getEquipmentLabel(e){return"brannvarsling"===e.slug?"Brannsystem":`${e.name} utstyr`}getCustomerSubtypeValue(e,t){const n=(e.services||[]).find(e=>e.service_type_id===t.id||e.service_type_slug===t.slug);if(n?.subtype_name)return n.subtype_name;return this.parseCustomData(e.custom_data)[`${t.slug}_subtype`]||null}getCustomerEquipmentValue(e,t){const n=(e.services||[]).find(e=>e.service_type_id===t.id||e.service_type_slug===t.slug);if(n?.equipment_name)return n.equipment_name;return this.parseCustomData(e.custom_data)[`${t.slug}_equipment`]||null}}const serviceTypeRegistry=new ServiceTypeRegistry;function updateControlSectionHeaders(){const e=serviceTypeRegistry.getBySlug("el-kontroll"),t=serviceTypeRegistry.getBySlug("brannvarsling"),n=document.querySelector("#elKontrollSection .control-section-header");n&&e&&(n.innerHTML=`<i class="fas ${escapeHtml(e.icon)}" style="color: ${escapeHtml(e.color)}"></i> ${escapeHtml(e.name)}`);const a=document.querySelector("#brannvarslingSection .control-section-header");a&&t&&(a.innerHTML=`<i class="fas ${escapeHtml(t.icon)}" style="color: ${escapeHtml(t.color)}"></i> ${escapeHtml(t.name)}`)}const SmartRouteEngine={params:{daysAhead:parseInt(localStorage.getItem("smartRoute_daysAhead"))||60,maxCustomersPerRoute:parseInt(localStorage.getItem("smartRoute_maxCustomers"))||15,maxDrivingTimeMinutes:parseInt(localStorage.getItem("smartRoute_maxDrivingTime"))||480,minClusterSize:3,clusterRadiusKm:parseFloat(localStorage.getItem("smartRoute_clusterRadius"))||5,serviceTimeMinutes:30},clusters:[],selectedClusterId:null,clusterLayer:null,showAllRecommendations:!1,saveParams(){localStorage.setItem("smartRoute_daysAhead",this.params.daysAhead),localStorage.setItem("smartRoute_maxCustomers",this.params.maxCustomersPerRoute),localStorage.setItem("smartRoute_maxDrivingTime",this.params.maxDrivingTimeMinutes),localStorage.setItem("smartRoute_clusterRadius",this.params.clusterRadiusKm)},haversineDistance(e,t,n,a){if(!(Number.isFinite(e)&&Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(a)))return 1/0;const s=(n-e)*Math.PI/180,o=(a-t)*Math.PI/180,r=Math.sin(s/2)**2+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(o/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))},getCentroid(e){if(0===e.length)return null;const t=e.reduce((e,t)=>e+t.lat,0),n=e.reduce((e,t)=>e+t.lng,0);return{lat:t/e.length,lng:n/e.length}},getBoundingBox(e){const t=e.map(e=>e.lat),n=e.map(e=>e.lng);return{minLat:Math.min(...t),maxLat:Math.max(...t),minLng:Math.min(...n),maxLng:Math.max(...n)}},getCustomersNeedingControl(){if(!customers||!Array.isArray(customers)||0===customers.length)return[];const e=new Date;e.setHours(0,0,0,0);const t=new Date(e);return t.setDate(t.getDate()+this.params.daysAhead),customers.filter(e=>{if(!e)return!1;if(!Number.isFinite(e.lat)||!Number.isFinite(e.lng))return!1;const n=getNextControlDate(e);return!(!(n&&n instanceof Date)||isNaN(n.getTime()))&&n<=t})},dbscanClustering(e,t,n){const a=e.length;if(0===a)return[];const s=new Array(a).fill(!1),o=new Array(a).fill(!1),r=new Array(a).fill(-1);let i=0;const l=t/111,d={};e.forEach((e,t)=>{const n=`${Math.floor(e.lng/l)},${Math.floor(e.lat/l)}`;d[n]||(d[n]=[]),d[n].push(t)});const c=n=>{const a=[],s=e[n],o=Math.floor(s.lng/l),r=Math.floor(s.lat/l);for(let i=-1;i<=1;i++)for(let l=-1;l<=1;l++){const c=d[`${o+i},${r+l}`];if(c)for(const o of c)if(o!==n){this.haversineDistance(s.lat,s.lng,e[o].lat,e[o].lng)<=t&&a.push(o)}}return a},u=(e,t,a)=>{r[e]=a;const o=[...t],i=new Set(t);for(;o.length>0;){const e=o.shift();if(!s[e]){s[e]=!0;const t=c(e);if(t.length>=n)for(const e of t)i.has(e)||-1!==r[e]||(o.push(e),i.add(e))}-1===r[e]&&(r[e]=a)}};for(let e=0;e<a;e++){if(s[e])continue;s[e]=!0;const t=c(e);t.length<n?o[e]=!0:(u(e,t,i),i++)}const m=[];for(let t=0;t<i;t++){const a=e.filter((e,n)=>r[n]===t);a.length>=n&&m.push(a)}return m},calculateClusterEfficiency(e){const t=e.length;if(t<2)return null;const n=new Date;n.setHours(0,0,0,0);const a=appConfig.routeStartLat||59.9139,s=appConfig.routeStartLng||10.7522,o=this.getCentroid(e),r=this.haversineDistance(a,s,o.lat,o.lng),i=e.reduce((e,t)=>e+this.haversineDistance(t.lat,t.lng,o.lat,o.lng),0)/t,l=this.getBoundingBox(e),d=111*(l.maxLat-l.minLat),c=111*(l.maxLng-l.minLng)*Math.cos(o.lat*Math.PI/180),u=t/Math.max(d*c,.1),m=e.filter(e=>{const t=getNextControlDate(e);return t&&t<n}).length,p=2*r/50*60,g=i*t*1.5/30*60,f=t*this.params.serviceTimeMinutes,v=Math.round(p+g+f),y=Math.round(2*r+i*t*1.5),h=u*t*10/(1+.05*r+.3*i),k=Math.min(100,Math.round(10*h)),b={};e.forEach(e=>{const t=e.poststed||"Ukjent";b[t]=(b[t]||0)+1});const w=Object.entries(b).sort((e,t)=>t[1]-e[1]),S=w.length>0?w[0][0]:"Ukjent",I=[...new Set(e.map(e=>e.kategori).filter(Boolean))];return{customers:e,customerCount:t,centroid:o,primaryArea:S,categories:I,overdueCount:m,upcomingCount:t-m,efficiencyScore:k,estimatedMinutes:v,estimatedKm:y,density:Math.round(10*u)/10,avgDistanceFromCentroid:Math.round(10*i)/10,distanceToStart:Math.round(r)}},generateRecommendations(){const e=this.getCustomersNeedingControl();if(Logger.log("SmartRouteEngine: Kunder som trenger kontroll:",e.length),e.length<this.params.minClusterSize)return Logger.log("SmartRouteEngine: For få kunder, prøver fallback til område-basert"),this.generateAreaBasedRecommendations(e);let t=this.dbscanClustering(e,this.params.clusterRadiusKm,this.params.minClusterSize);if(Logger.log("SmartRouteEngine: DBSCAN fant",t.length,"klynger"),0===t.length&&e.length>=3&&(Logger.log("SmartRouteEngine: Ingen DBSCAN-klynger, prøver større radius"),t=this.dbscanClustering(e,2*this.params.clusterRadiusKm,this.params.minClusterSize),0===t.length))return Logger.log("SmartRouteEngine: Bruker område-basert fallback"),this.generateAreaBasedRecommendations(e);const n=t.map((e,t)=>{const n=this.calculateClusterEfficiency(e);if(!n)return null;if(n.estimatedMinutes>this.params.maxDrivingTimeMinutes&&e.length>this.params.maxCustomersPerRoute)return null;if(e.length>this.params.maxCustomersPerRoute){const t=[...e].sort((e,t)=>this.haversineDistance(e.lat,e.lng,n.centroid.lat,n.centroid.lng)-this.haversineDistance(t.lat,t.lng,n.centroid.lat,n.centroid.lng)).slice(0,this.params.maxCustomersPerRoute);return this.calculateClusterEfficiency(t)}return{...n,id:t}}).filter(Boolean);return this.clusters=n.sort((e,t)=>t.efficiencyScore-e.efficiencyScore).map((e,t)=>({...e,id:t})),this.clusters},showClusterOnMap(e){const t=this.clusters.find(t=>t.id===e);if(!t)return;if(!map)return void showToast("Kartet er ikke lastet enda","warning");if(this.selectedClusterId===e)return this.clearClusterVisualization(),void this.updateClusterButtons();this.clearClusterVisualization(),this.selectedClusterId=e,this.updateClusterButtons(),this.clusterLayer=L.layerGroup().addTo(map);const n=t.customers.map(e=>[e.lat,e.lng]);if(n.length>=3){const e=this.convexHull(n);L.polygon(e,{color:"#ff6b00",weight:2,fillColor:"#ff6b00",fillOpacity:.15,dashArray:"5, 5"}).addTo(this.clusterLayer)}const a=new Date;a.setHours(0,0,0,0),t.customers.forEach((e,t)=>{const n=getNextControlDate(e),s=n&&n<a;L.circleMarker([e.lat,e.lng],{radius:10,color:s?"#e74c3c":"#f39c12",weight:2,fillColor:s?"#e74c3c":"#f39c12",fillOpacity:.8}).addTo(this.clusterLayer).bindPopup(`\n        <strong>${escapeHtml(e.navn)}</strong><br>\n        ${escapeHtml(e.adresse||"")}<br>\n        <small>${s?"Forfalt":"Kommende"}</small>\n      `)});L.marker([t.centroid.lat,t.centroid.lng],{icon:L.divIcon({className:"cluster-centroid-marker",html:'<div class="centroid-icon"><i class="fas fa-crosshairs"></i></div>',iconSize:[30,30],iconAnchor:[15,15]})}).addTo(this.clusterLayer);const s=L.latLngBounds(n);map.fitBounds(s,{padding:[50,50]}),this.updateClusterButtons()},clearClusterVisualization(){this.clusterLayer&&map&&(map.removeLayer(this.clusterLayer),this.clusterLayer=null),this.selectedClusterId=null},updateClusterButtons(){document.querySelectorAll(".recommendation-card.enhanced").forEach(e=>{const t=parseInt(e.dataset.clusterId),n=e.querySelector(".rec-actions .btn-secondary");n&&(t===this.selectedClusterId?(n.innerHTML='<i class="fas fa-eye-slash"></i> Skjul',e.classList.add("selected")):(n.innerHTML='<i class="fas fa-map"></i> Vis detaljer',e.classList.remove("selected")))})},convexHull(e){if(e.length<3)return e;const t=(e,t,n)=>(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0]);let n=0;for(let t=1;t<e.length;t++)(e[t][0]<e[n][0]||e[t][0]===e[n][0]&&e[t][1]<e[n][1])&&(n=t);const a=[];let s=n;do{a.push(e[s]);let n=0;for(let a=1;a<e.length;a++)(n===s||t(e[s],e[n],e[a])<0)&&(n=a);s=n}while(s!==n&&a.length<e.length);return a},createRouteFromCluster(e){const t=this.clusters.find(t=>t.id===e);if(!t)return;createRouteFromCustomerIds(t.customers.map(e=>e.id)),showToast(`${t.customerCount} kunder valgt fra ${t.primaryArea}. Beregner rute...`),planRoute()},generateAreaBasedRecommendations(e){(new Date).setHours(0,0,0,0);const t=e.length>0?e:this.getCustomersNeedingControl();if(0===t.length)return this.clusters=[],[];const n={};t.forEach(e=>{const t=e.poststed||"Ukjent";n[t]||(n[t]=[]),n[t].push(e)});const a=Object.entries(n).filter(([e,t])=>t.length>=2).map(([e,t],n)=>{const a=t.filter(e=>e.lat&&e.lng);if(a.length<2)return null;const s=this.calculateClusterEfficiency(a);return s?{...s,id:n,isAreaBased:!0}:null}).filter(Boolean).sort((e,t)=>t.efficiencyScore-e.efficiencyScore);return this.clusters=a.map((e,t)=>({...e,id:t})),Logger.log("SmartRouteEngine: Område-basert fallback fant",this.clusters.length,"klynger"),this.clusters}};function getSmartAreaRecommendations(e=60,t=3){const n=new Date;n.setHours(0,0,0,0);const a=new Date(n);a.setDate(a.getDate()+e);const s=customers.filter(e=>{const t=getNextControlDate(e);return!!t&&t<=a}),o={};s.forEach(e=>{const t=e.poststed||"Ukjent";o[t]||(o[t]=[]),o[t].push(e)});return Object.entries(o).filter(([e,n])=>n.length>=t).map(([e,t])=>({area:e,customers:t,count:t.length,overdue:t.filter(e=>getNextControlDate(e)<n).length,categories:[...new Set(t.map(e=>e.kategori).filter(Boolean))]})).sort((e,t)=>t.count-e.count)}function renderSmartRecommendations(){const e=document.getElementById("smartRecommendations");if(!e)return;const t=document.getElementById("smartDaysAhead"),n=document.getElementById("smartMaxCustomers"),a=document.getElementById("smartClusterRadius");t&&(SmartRouteEngine.params.daysAhead=parseInt(t.value)||60),n&&(SmartRouteEngine.params.maxCustomersPerRoute=parseInt(n.value)||15),a&&(SmartRouteEngine.params.clusterRadiusKm=parseFloat(a.value)||5),SmartRouteEngine.saveParams();const s=SmartRouteEngine.generateRecommendations();let o="";if(0===s.length){const t=customers.filter(e=>getNextControlDate(e)),n=customers.filter(e=>e.lat&&e.lng),a=SmartRouteEngine.getCustomersNeedingControl();let s="Ingen ruteklynger funnet.",r="";return 0===customers.length?s="Ingen kunder i systemet.":0===n.length?(s="Ingen kunder har koordinater.",r="Legg til adresser med koordinater for å få ruteanbefalinger."):0===t.length?(s="Ingen kunder har kontrolldatoer.",r="Legg til neste kontrolldato for å få ruteanbefalinger."):0===a.length?(s="Ingen kontroller forfaller innen "+SmartRouteEngine.params.daysAhead+" dager.",r='Prøv å øke "Dager fremover" i innstillingene.'):a.length<3&&(s="Kun "+a.length+" kunde(r) trenger kontroll.",r="Minimum 2 kunder trengs for å danne en rute."),o+=`\n      <div class="rec-empty">\n        <i class="fas fa-info-circle"></i>\n        <p>${s}</p>\n        ${r?`<p class="rec-empty-hint">${r}</p>`:""}\n        <p class="rec-empty-stats">\n          <small>${customers.length} kunder totalt | ${n.length} med koordinater | ${a.length} trenger kontroll</small>\n        </p>\n      </div>`,void(e.innerHTML=o)}const r=SmartRouteEngine.showAllRecommendations?s.length:6;s.slice(0,r).forEach(e=>{let t="low";e.efficiencyScore>=70?t="high":e.efficiencyScore>=40&&(t="medium");const n=Math.floor(e.estimatedMinutes/60),a=e.estimatedMinutes%60,s=n>0?`${n}t ${a}m`:`${a}m`;o+=`\n      <div class="recommendation-card enhanced ${SmartRouteEngine.selectedClusterId===e.id?"selected":""}" data-cluster-id="${e.id}">\n        <div class="rec-header">\n          <div class="rec-title">\n            <span class="rec-cluster-id">#${e.id+1}</span>\n            <h4><i class="fas fa-map-pin"></i> ${escapeHtml(e.primaryArea)}</h4>\n          </div>\n          <div class="rec-efficiency ${t}">\n            <span class="efficiency-score">${e.efficiencyScore}%</span>\n            <span class="efficiency-label">effektivitet</span>\n          </div>\n        </div>\n\n        <div class="rec-metrics">\n          <div class="metric">\n            <i class="fas fa-users"></i>\n            <span>${e.customerCount} kunder</span>\n          </div>\n          <div class="metric">\n            <i class="fas fa-road"></i>\n            <span>~${e.estimatedKm} km</span>\n          </div>\n          <div class="metric">\n            <i class="fas fa-clock"></i>\n            <span>~${s}</span>\n          </div>\n          ${e.overdueCount>0?`\n          <div class="metric urgency">\n            <i class="fas fa-exclamation-triangle"></i>\n            <span>${e.overdueCount} forfalte</span>\n          </div>\n          `:""}\n        </div>\n\n        <div class="rec-categories">\n          ${e.categories.map(e=>`<span class="category-tag">${escapeHtml(e)}</span>`).join("")||'<span class="category-tag">Diverse</span>'}\n        </div>\n\n        <div class="rec-actions">\n          <button class="btn btn-secondary btn-small" data-action="showClusterOnMap" data-cluster-id="${e.id}">\n            ${SmartRouteEngine.selectedClusterId===e.id?'<i class="fas fa-eye-slash"></i> Skjul':'<i class="fas fa-map"></i> Vis detaljer'}\n          </button>\n          <button class="btn btn-primary btn-small" data-action="createRouteFromCluster" data-cluster-id="${e.id}">\n            <i class="fas fa-route"></i> Opprett rute\n          </button>\n        </div>\n      </div>\n    `}),s.length>6&&(SmartRouteEngine.showAllRecommendations?o+='<button class="btn btn-link rec-toggle-all" data-action="toggleShowAllRecommendations">\n        <i class="fas fa-chevron-up"></i> Vis færre\n      </button>':o+=`<button class="btn btn-link rec-toggle-all" data-action="toggleShowAllRecommendations">\n        <i class="fas fa-chevron-down"></i> Vis alle ${s.length} anbefalinger\n      </button>`),e.innerHTML=o}function toggleShowAllRecommendations(){SmartRouteEngine.showAllRecommendations=!SmartRouteEngine.showAllRecommendations,renderSmartRecommendations()}function updateSmartRouteSettings(){const e=parseInt(document.getElementById("smartDaysAhead")?.value)||60,t=parseInt(document.getElementById("smartMaxCustomers")?.value)||15,n=parseInt(document.getElementById("smartMaxDrivingTime")?.value)||480,a=parseFloat(document.getElementById("smartClusterRadius")?.value)||5;SmartRouteEngine.params.daysAhead=e,SmartRouteEngine.params.maxCustomersPerRoute=t,SmartRouteEngine.params.maxDrivingTimeMinutes=n,SmartRouteEngine.params.clusterRadiusKm=a,SmartRouteEngine.saveParams(),SmartRouteEngine.clearClusterVisualization(),renderSmartRecommendations(),showToast("Innstillinger oppdatert")}let smartRouteListenersInitialized=!1;function initSmartRouteSettingsListeners(){const e=document.getElementById("smartDaysAhead"),t=document.getElementById("smartMaxCustomers"),n=document.getElementById("smartClusterRadius");if(e){e.value=SmartRouteEngine.params.daysAhead;const t=document.getElementById("smartDaysAheadValue");t&&(t.textContent=`${SmartRouteEngine.params.daysAhead} dager`)}if(t){t.value=SmartRouteEngine.params.maxCustomersPerRoute;const e=document.getElementById("smartMaxCustomersValue");e&&(e.textContent=`${SmartRouteEngine.params.maxCustomersPerRoute} kunder`)}if(n){n.value=SmartRouteEngine.params.clusterRadiusKm;const e=document.getElementById("smartClusterRadiusValue");e&&(e.textContent=`${SmartRouteEngine.params.clusterRadiusKm} km`)}if(smartRouteListenersInitialized)return;if(!e||!t||!n)return;smartRouteListenersInitialized=!0;const a=(e,t,n)=>{let a=e.parentElement.querySelector(".slider-tooltip");a||(a=document.createElement("div"),a.className="slider-tooltip",e.parentElement.style.position="relative",e.parentElement.appendChild(a));const s=parseFloat(e.min),o=parseFloat(e.max),r=(parseFloat(e.value)-s)/(o-s)*100;a.textContent=`${t}${n}`,a.style.left=`${r}%`,a.classList.add("visible")},s=e=>{const t=e.parentElement.querySelector(".slider-tooltip");t&&t.classList.remove("visible")};e&&(e.addEventListener("input",function(){const e=this.value,t=document.getElementById("smartDaysAheadValue");t&&(t.textContent=`${e} dager`),a(this,e," dager")}),e.addEventListener("mouseup",function(){s(this)}),e.addEventListener("mouseleave",function(){s(this)}),e.addEventListener("touchend",function(){s(this)})),t&&(t.addEventListener("input",function(){const e=this.value,t=document.getElementById("smartMaxCustomersValue");t&&(t.textContent=`${e} kunder`),a(this,e," kunder")}),t.addEventListener("mouseup",function(){s(this)}),t.addEventListener("mouseleave",function(){s(this)}),t.addEventListener("touchend",function(){s(this)})),n&&(n.addEventListener("input",function(){const e=this.value,t=document.getElementById("smartClusterRadiusValue");t&&(t.textContent=`${e} km`),a(this,e," km")}),n.addEventListener("mouseup",function(){s(this)}),n.addEventListener("mouseleave",function(){s(this)}),n.addEventListener("touchend",function(){s(this)}))}function showAreaOnMap(e){const t=customers.filter(t=>t.poststed===e);if(0===t.length)return;const n=t.filter(e=>e.lat&&e.lng).map(e=>[e.lat,e.lng]);if(0===n.length)return void showToast("Ingen kunder med koordinater i dette området","warning");const a=L.latLngBounds(n);map.fitBounds(a,{padding:[50,50]}),highlightCustomersOnMap(t.map(e=>e.id)),showToast(`Viser ${t.length} kunder i ${e}`)}function createRouteForArea(e,t){t&&0!==t.length?(createRouteFromCustomerIds(t),switchToTab("routes"),showToast(`Opprettet rute for ${e} med ${t.length} kunder`)):showToast("Ingen kunder å lage rute for","warning")}function highlightCustomersOnMap(e){clearMapHighlights(),window.highlightLayer=L.layerGroup().addTo(map),window.highlightedCustomerIds=e;const t=[];if(customers.forEach(n=>{e.includes(n.id)&&n.lat&&n.lng&&t.push([n.lat,n.lng])}),0!==t.length){if(t.forEach(e=>{L.circleMarker(e,{radius:8,color:"#ff6b00",weight:2,fillColor:"#ff6b00",fillOpacity:.8,className:"highlight-dot"}).addTo(window.highlightLayer)}),t.length>=3){const e=getConvexHull(t);L.polygon(e,{color:"#ff6b00",weight:3,fillColor:"#ff6b00",fillOpacity:.1,dashArray:"8, 8",className:"highlight-area"}).addTo(window.highlightLayer)}else if(2===t.length){L.polyline(t,{color:"#ff6b00",weight:4,dashArray:"8, 8",className:"highlight-area"}).addTo(window.highlightLayer)}else{L.circle(t[0],{radius:500,color:"#ff6b00",weight:2,fillColor:"#ff6b00",fillOpacity:.1,dashArray:"8, 8",className:"highlight-area"}).addTo(window.highlightLayer)}showToast(`${t.length} kunder i området markert`,"success")}else showToast("Ingen kunder med koordinater funnet","warning")}function getConvexHull(e){if(e.length<3)return e;let t=0;for(let n=1;n<e.length;n++)(e[n][0]<e[t][0]||e[n][0]===e[t][0]&&e[n][1]<e[t][1])&&(t=n);[e[0],e[t]]=[e[t],e[0]];const n=e[0],a=e.slice(1).sort((e,t)=>Math.atan2(e[0]-n[0],e[1]-n[1])-Math.atan2(t[0]-n[0],t[1]-n[1])),s=[n];for(const e of a){for(;s.length>1&&crossProduct(s[s.length-2],s[s.length-1],e)<=0;)s.pop();s.push(e)}return s}function crossProduct(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])}function clearMapHighlights(){window.highlightLayer&&(window.highlightLayer.clearLayers(),map.removeLayer(window.highlightLayer),window.highlightLayer=null),window.highlightedCustomerIds=[]}function switchToTab(e){const t=document.querySelector(`.tab-item[data-tab="${e}"]`);t&&t.click()}function syncMapToTab(e){if(isMobile&&map)switch(e){case"customers":{const e=customers.filter(e=>e.lat&&e.lng).map(e=>[e.lat,e.lng]);e.length>0&&map.fitBounds(L.latLngBounds(e),{padding:[30,30]});break}case"routes":if(routeLayer&&routeLayer.getBounds)try{map.fitBounds(routeLayer.getBounds(),{padding:[30,30]})}catch(e){}break;case"overdue":{const e=new Date,t=customers.filter(t=>t.neste_kontroll&&t.lat&&t.lng&&new Date(t.neste_kontroll)<e).map(e=>[e.lat,e.lng]);t.length>0&&map.fitBounds(L.latLngBounds(t),{padding:[30,30]});break}}}const chatState={conversations:[],activeConversation:null,activeConversationType:null,messages:{},unreadCounts:{},totalUnread:0,orgConversationId:null,typingUsers:{},view:"list"};let chatTypingTimer=null,chatIsTyping=!1,chatNotificationSound=null;function initChatSound(){try{const e=new(window.AudioContext||window.webkitAudioContext);chatNotificationSound=e}catch(e){}}function playChatNotificationSound(){try{if(chatNotificationSound||initChatSound(),!chatNotificationSound)return;const e=chatNotificationSound;"suspended"===e.state&&e.resume();const t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=800,t.type="sine",n.gain.setValueAtTime(.15,e.currentTime),n.gain.exponentialRampToValueAtTime(.001,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}catch(e){}}function chatHeaders(){const e={"Content-Type":"application/json"},t=getCsrfToken();return t&&(e["X-CSRF-Token"]=t),e}async function initChat(){try{const e=await fetch("/api/chat/init",{method:"POST",headers:chatHeaders()});if(!e.ok){console.error("Chat init failed:",e.status,e.statusText);try{console.error("Chat init body:",await e.text())}catch{}return}const t=await e.json();t.success&&t.data&&(chatState.orgConversationId=t.data.orgConversationId,chatState.totalUnread=t.data.totalUnread,updateChatBadge())}catch(e){console.error("Failed to init chat:",e)}}async function loadChatConversations(){try{const e=await fetch("/api/chat/conversations");if(!e.ok)return;const t=await e.json();if(t.success&&t.data){chatState.conversations=t.data,chatState.totalUnread=0,chatState.unreadCounts={};for(const e of t.data)e.unread_count>0&&(chatState.unreadCounts[e.id]=e.unread_count,chatState.totalUnread+=e.unread_count);updateChatBadge(),renderChatConversations()}}catch(e){console.error("Failed to load conversations:",e)}}async function loadChatMessages(e,t){try{let n=`/api/chat/conversations/${e}/messages?limit=50`;t&&(n+=`&before=${t}`);const a=await fetch(n);if(!a.ok)return;const s=await a.json();s.success&&s.data&&(chatState.messages[e]=t?[...s.data,...chatState.messages[e]||[]]:s.data,renderChatMessages(e))}catch(e){console.error("Failed to load messages:",e)}}async function sendChatMessage(e,t){if(t.trim())try{const n=await fetch(`/api/chat/conversations/${e}/messages`,{method:"POST",headers:chatHeaders(),body:JSON.stringify({content:t.trim()})});if(!n.ok)return;const a=await n.json();a.success&&a.data&&(chatState.messages[e]||(chatState.messages[e]=[]),chatState.messages[e].push(a.data),renderChatMessages(e),scrollChatToBottom(),loadChatConversations())}catch(e){console.error("Failed to send message:",e)}}async function markChatAsRead(e){const t=chatState.messages[e];if(!t||0===t.length)return;const n=t[t.length-1];try{await fetch(`/api/chat/conversations/${e}/read`,{method:"PUT",headers:chatHeaders(),body:JSON.stringify({messageId:n.id})});const t=chatState.unreadCounts[e]||0;chatState.totalUnread=Math.max(0,chatState.totalUnread-t),delete chatState.unreadCounts[e],updateChatBadge()}catch(e){console.error("Failed to mark as read:",e)}}async function startDmConversation(e){try{const t=await fetch("/api/chat/conversations/dm",{method:"POST",headers:chatHeaders(),body:JSON.stringify({targetUserId:e})});if(!t.ok)return null;const n=await t.json();if(n.success&&n.data)return n.data.id}catch(e){console.error("Failed to start DM:",e)}return null}function handleIncomingChatMessage(e){const t=e.conversation_id;chatState.messages[t]&&(chatState.messages[t].some(t=>t.id===e.id)||chatState.messages[t].push(e));chatState.activeConversation===t&&"messages"===chatState.view?(markChatAsRead(t),renderChatMessages(t),scrollChatToBottom()):(chatState.unreadCounts[t]=(chatState.unreadCounts[t]||0)+1,chatState.totalUnread++,updateChatBadge(),playChatNotificationSound()),renderChatConversations(),handleChatTypingStop({conversationId:t,userId:e.sender_id})}function handleChatTyping(e){const t=`${e.conversationId}-${e.userId}`;chatState.typingUsers[t]=e.userName,renderTypingIndicator(e.conversationId),setTimeout(()=>{delete chatState.typingUsers[t],renderTypingIndicator(e.conversationId)},5e3)}function handleChatTypingStop(e){const t=`${e.conversationId}-${e.userId}`;delete chatState.typingUsers[t],renderTypingIndicator(e.conversationId)}function sendChatTypingStart(e){chatIsTyping||(chatIsTyping=!0,ws&&ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({type:"chat_typing_start",conversationId:e})),clearTimeout(chatTypingTimer),chatTypingTimer=setTimeout(()=>{chatIsTyping=!1,ws&&ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({type:"chat_typing_stop",conversationId:e}))},3e3))}function updateChatBadge(){const e=document.getElementById("chatUnreadBadge");e&&(chatState.totalUnread>0?(e.textContent=chatState.totalUnread>99?"99+":chatState.totalUnread,e.style.display=""):e.style.display="none")}function formatChatTime(e){const t=new Date(e),n=new Date,a=t.toDateString()===n.toDateString(),s=new Date(n);s.setDate(s.getDate()-1);t.toDateString(),s.toDateString();const o=t.toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit"});return a?o:t.toLocaleDateString("no-NO",{day:"numeric",month:"short"})+" "+o}function formatChatDate(e){const t=new Date(e),n=new Date;if(t.toDateString()===n.toDateString())return"I dag";const a=new Date(n);return a.setDate(a.getDate()-1),t.toDateString()===a.toDateString()?"I går":t.toLocaleDateString("no-NO",{weekday:"long",day:"numeric",month:"long"})}function getChatInitials(e){if(!e)return"??";const t=e.split(/[\s.\-_]+/).filter(Boolean);return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():e.substring(0,2).toUpperCase()}function renderChatConversations(){const e=document.getElementById("chatConversations");e&&(0!==chatState.conversations.length?(e.innerHTML=chatState.conversations.map(e=>{const t=chatState.unreadCounts[e.id]||0,n="org"===e.type,a=n?"Teamchat":escapeHtml(e.participant_name||"Ukjent"),s=n?"fa-users":"fa-user",o=e.last_message?escapeHtml(e.last_message.content.substring(0,50)):"Ingen meldinger ennå",r=e.last_message?formatChatTime(e.last_message.created_at):"";return`\n      <div class="chat-conv-item ${t>0?"unread":""}" data-conv-id="${e.id}" data-conv-type="${e.type}">\n        <div class="chat-conv-icon"><i class="fas ${s}"></i></div>\n        <div class="chat-conv-info">\n          <div class="chat-conv-name">${a}</div>\n          <div class="chat-conv-preview">${o}</div>\n        </div>\n        <div class="chat-conv-meta">\n          <span class="chat-conv-time">${r}</span>\n          ${t>0?`<span class="chat-conv-unread">${t}</span>`:""}\n        </div>\n      </div>`}).join(""),e.querySelectorAll(".chat-conv-item").forEach(e=>{e.addEventListener("click",()=>{openChatConversation(parseInt(e.dataset.convId,10),e.dataset.convType)})})):e.innerHTML='\n      <div class="chat-empty-state">\n        <i class="fas fa-comments"></i>\n        <p>Ingen samtaler ennå</p>\n        <p>Start en ny samtale med en kollega</p>\n      </div>')}async function openChatConversation(e,t){chatState.activeConversation=e,chatState.activeConversationType=t,chatState.view="messages";const n=document.getElementById("chatMessageTitle");if("org"===t)n.textContent="Teamchat";else{const t=chatState.conversations.find(t=>t.id===e);n.textContent=t?.participant_name||"Direktemelding"}document.getElementById("chatConversationList").style.display="none",document.getElementById("chatNewDm").style.display="none",document.getElementById("chatMessageView").style.display="flex",await loadChatMessages(e),scrollChatToBottom(),markChatAsRead(e)}function renderChatMessages(e){const t=document.getElementById("chatMessages");if(!t||chatState.activeConversation!==e)return;const n=chatState.messages[e]||[];if(0===n.length)return void(t.innerHTML='\n      <div class="chat-empty-state">\n        <i class="fas fa-comment-dots"></i>\n        <p>Ingen meldinger ennå. Si hei!</p>\n      </div>');let a="",s="";n.length>=50&&(s+='<div class="chat-load-more"><button onclick="loadOlderChatMessages()">Last eldre meldinger</button></div>');for(const e of n){const t=new Date(e.created_at).toDateString();t!==a&&(a=t,s+=`<div class="chat-msg-date-separator">${formatChatDate(e.created_at)}</div>`);const n=e.sender_id===myUserId,o=new Date(e.created_at).toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit"});s+=`\n      <div class="chat-msg ${n?"self":"other"}">\n        <div class="chat-msg-sender">${escapeHtml(e.sender_name)}</div>\n        <div class="chat-msg-content">${escapeHtml(e.content)}</div>\n        <div class="chat-msg-time">${o}</div>\n      </div>`}t.innerHTML=s}function scrollChatToBottom(){const e=document.getElementById("chatMessages");e&&requestAnimationFrame(()=>{e.scrollTop=e.scrollHeight})}function loadOlderChatMessages(){if(!chatState.activeConversation)return;const e=chatState.messages[chatState.activeConversation]||[];if(0===e.length)return;const t=e[0].id;loadChatMessages(chatState.activeConversation,t)}function renderTypingIndicator(e){const t=document.getElementById("chatTypingIndicator"),n=document.getElementById("chatTypingText");if(!t||!n||chatState.activeConversation!==e)return;const a=`${e}-`,s=Object.entries(chatState.typingUsers).filter(([e])=>e.startsWith(a)).map(([,e])=>e);0===s.length?t.style.display="none":(t.style.display="",1===s.length?n.textContent=`${s[0]} skriver...`:n.textContent=`${s.join(" og ")} skriver...`)}async function showNewDmView(){chatState.view="newDm",document.getElementById("chatConversationList").style.display="none",document.getElementById("chatMessageView").style.display="none",document.getElementById("chatNewDm").style.display="flex";const e=document.getElementById("chatTeamList");e.innerHTML='\n    <div class="chat-empty-state">\n      <i class="fas fa-spinner fa-spin"></i>\n      <p>Laster teammedlemmer...</p>\n    </div>';try{const t=await fetch("/api/chat/team-members");if(!t.ok){console.error("Team members failed:",t.status,t.statusText);try{console.error("Team members body:",await t.text())}catch{}return void(e.innerHTML='\n        <div class="chat-empty-state">\n          <i class="fas fa-exclamation-triangle"></i>\n          <p>Kunne ikke laste teammedlemmer</p>\n          <p style="font-size:12px;opacity:0.7">Bruk Teamchat for å sende melding til alle</p>\n        </div>')}const n=await t.json();if(n.success&&n.data){if(0===n.data.length)return void(e.innerHTML='\n          <div class="chat-empty-state">\n            <i class="fas fa-user-slash"></i>\n            <p>Ingen andre teammedlemmer funnet</p>\n            <p style="font-size:12px;opacity:0.7">Gå tilbake og bruk Teamchat for å sende melding til alle</p>\n          </div>');e.innerHTML=n.data.map(e=>`\n        <div class="chat-team-item" data-user-id="${e.id}">\n          <div class="chat-team-avatar">${getChatInitials(e.navn)}</div>\n          <div class="chat-team-name">${escapeHtml(e.navn)}</div>\n        </div>\n      `).join(""),e.querySelectorAll(".chat-team-item").forEach(e=>{e.addEventListener("click",async()=>{const t=parseInt(e.dataset.userId,10),n=await startDmConversation(t);n&&(await loadChatConversations(),openChatConversation(n,"dm"))})})}}catch(t){console.error("Failed to load team members:",t),e.innerHTML='\n      <div class="chat-empty-state">\n        <i class="fas fa-exclamation-triangle"></i>\n        <p>Feil ved lasting av teammedlemmer</p>\n        <p style="font-size:12px;opacity:0.7">Gå tilbake og bruk Teamchat for å sende melding til alle</p>\n      </div>'}}function showChatConversationList(){chatState.view="list",chatState.activeConversation=null,chatState.activeConversationType=null,document.getElementById("chatMessageView").style.display="none",document.getElementById("chatNewDm").style.display="none",document.getElementById("chatConversationList").style.display="",loadChatConversations()}function initChatEventListeners(){document.getElementById("chatSendBtn")?.addEventListener("click",()=>{const e=document.getElementById("chatInput");e&&chatState.activeConversation&&(sendChatMessage(chatState.activeConversation,e.value),e.value="",chatIsTyping=!1)}),document.getElementById("chatInput")?.addEventListener("keydown",e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=e.target;t.value.trim()&&chatState.activeConversation&&(sendChatMessage(chatState.activeConversation,t.value),t.value="",chatIsTyping=!1)}}),document.getElementById("chatInput")?.addEventListener("input",()=>{chatState.activeConversation&&sendChatTypingStart(chatState.activeConversation)}),document.getElementById("chatBackBtn")?.addEventListener("click",showChatConversationList),document.getElementById("chatNewDmBtn")?.addEventListener("click",showNewDmView),document.getElementById("chatNewDmBackBtn")?.addEventListener("click",showChatConversationList)}function onChatTabOpened(){loadChatConversations(),resizeChatContainer()}function resizeChatContainer(){const e=document.querySelector(".tab-content"),t=document.getElementById("tab-chat");if(!e||!t)return;const n=e.clientHeight;t.style.height=n+"px",t.style.maxHeight=n+"px"}window.addEventListener("resize",()=>{const e=document.getElementById("tab-chat");e&&e.classList.contains("active")&&resizeChatContainer()}),window.loadOlderChatMessages=loadOlderChatMessages;let twCurrentDate=(new Date).toISOString().split("T")[0],twRouteData=null;function initTodaysWork(){if(hasFeature("todays_work")){const e=document.getElementById("todaysWorkTab");e&&(e.style.display="")}document.getElementById("twPrevDay")?.addEventListener("click",()=>{const e=new Date(twCurrentDate);e.setDate(e.getDate()-1),twCurrentDate=e.toISOString().split("T")[0],loadTodaysWork()}),document.getElementById("twNextDay")?.addEventListener("click",()=>{const e=new Date(twCurrentDate);e.setDate(e.getDate()+1),twCurrentDate=e.toISOString().split("T")[0],loadTodaysWork()}),document.getElementById("twStartRouteBtn")?.addEventListener("click",startTodaysRoute)}async function loadTodaysWork(){const e=document.getElementById("twDateLabel"),t=(new Date).toISOString().split("T")[0],n=new Date(Date.now()+864e5).toISOString().split("T")[0];if(twCurrentDate===t)e.textContent="I dag";else if(twCurrentDate===n)e.textContent="I morgen";else{const t=new Date(twCurrentDate);e.textContent=t.toLocaleDateString("nb-NO",{weekday:"short",day:"numeric",month:"short"})}try{const e=getCsrfToken(),t=await fetch(`/api/todays-work/my-route?date=${twCurrentDate}`,{headers:{"X-CSRF-Token":e}});if(!t.ok)return;const n=await t.json();if(n.success&&n.data){if(twRouteData=n.data,renderTodaysWork(),window.OfflineStorage){const e=localStorage.getItem("userId")||"0";OfflineStorage.saveTodaysRoute(twCurrentDate,e,n.data).catch(()=>{}),OfflineStorage.setLastSyncTime().catch(()=>{})}}else twRouteData=null,document.getElementById("twRouteCard").style.display="none",document.getElementById("twStopsList").innerHTML="",document.getElementById("twEmpty").style.display="flex",updateTodaysWorkBadge(0,0)}catch(e){if(console.error("Error loading todays work:",e),window.OfflineStorage&&!navigator.onLine){const e=localStorage.getItem("userId")||"0",t=await OfflineStorage.getTodaysRoute(twCurrentDate,e);if(t)return twRouteData=t,renderTodaysWork(),void showNotification("Viser lagret rute (frakoblet)","warning")}showNotification("Kunne ikke laste dagens rute","error")}}function renderTodaysWork(){const e=twRouteData;if(!e)return;document.getElementById("twEmpty").style.display="none",document.getElementById("twRouteCard").style.display="block",document.getElementById("twRouteName").textContent=escapeHtml(e.navn||"Rute");const t=!!e.execution_started_at,n=!!e.execution_ended_at,a=document.getElementById("twRouteStatus");n?(a.textContent="Fullført",a.className="tw-route-status tw-status-completed",document.getElementById("twStartRouteBtn").style.display="none"):t?(a.textContent="Pågår",a.className="tw-route-status tw-status-active",document.getElementById("twStartRouteBtn").style.display="none"):(a.textContent="Planlagt",a.className="tw-route-status tw-status-planned",document.getElementById("twStartRouteBtn").style.display="");const s=t&&e.completed_count||0,o=e.total_count||0;document.getElementById("twCompleted").textContent=s,document.getElementById("twTotal").textContent=o;const r=o>0?s/o*100:0;document.getElementById("twProgressFill").style.width=r+"%",e.total_distanse&&(document.getElementById("twDistanceStat").style.display="",document.getElementById("twDistance").textContent=(e.total_distanse/1e3).toFixed(1)+" km"),updateTodaysWorkBadge(s,o);const i=document.getElementById("twStopsList"),l=e.kunder||[],d=e.visits||[];if(0===l.length)return void(i.innerHTML='<p class="tw-no-stops">Ingen kunder på denne ruten.</p>');let c=-1;t&&!n&&(c=l.findIndex(e=>{const t=d.find(t=>t.kunde_id===e.id);return!t||!t.completed}));let u="";if(t&&!n&&c>=0){const e=l[c],t=[e.adresse,e.postnummer,e.poststed].filter(Boolean).join(", ");u+=`\n      <div class="tw-next-stop-card">\n        <div class="tw-next-stop-label">\n          <i class="fas fa-arrow-right"></i> Neste stopp (${c+1}/${l.length})\n        </div>\n        <h3 class="tw-next-stop-name">${escapeHtml(e.navn)}</h3>\n        <p class="tw-next-stop-address">${escapeHtml(t)}</p>\n        ${e.telefon?`<p class="tw-next-stop-phone"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</p>`:""}\n        <div class="tw-next-stop-actions">\n          <button class="btn btn-primary tw-next-nav-btn" onclick="twNavigateToCustomer(${e.id})">\n            <i class="fas fa-directions"></i> Naviger hit\n          </button>\n          ${e.telefon?`<a href="tel:${escapeHtml(e.telefon)}" class="btn btn-secondary tw-next-call-btn"><i class="fas fa-phone"></i> Ring</a>`:""}\n          <button class="btn btn-success tw-next-done-btn" onclick="twMarkVisited(${e.id})">\n            <i class="fas fa-check"></i> Fullført\n          </button>\n        </div>\n      </div>\n    `}const m=[],p=[];l.forEach((e,n)=>{const a=t?d.find(t=>t.kunde_id===e.id):null,s=a&&!0===a.completed,o=`\n      <div class="tw-stop-card ${s?"tw-stop-completed":""} ${n===c?"tw-stop-next":""}" data-kunde-id="${e.id}">\n        <div class="tw-stop-number">${n+1}</div>\n        <div class="tw-stop-info">\n          <h4>${escapeHtml(e.navn)}</h4>\n          ${s?"":`<p>${escapeHtml(e.adresse||"")}${e.poststed?", "+escapeHtml(e.poststed):""}</p>`}\n          ${!s&&e.telefon?`<p class="tw-stop-phone">${escapeHtml(e.telefon)}</p>`:""}\n        </div>\n        <div class="tw-stop-actions">\n          ${!s&&e.telefon?`<a href="tel:${escapeHtml(e.telefon)}" class="btn btn-icon btn-small tw-action-call" title="Ring"><i class="fas fa-phone"></i></a>`:""}\n          ${s?"":`<button class="btn btn-icon btn-small tw-action-nav" onclick="twNavigateToCustomer(${e.id})" title="Naviger"><i class="fas fa-directions"></i></button>`}\n          ${s?'<span class="tw-visited-check"><i class="fas fa-check-circle"></i></span>':`<button class="btn btn-icon btn-small tw-action-visit" onclick="twMarkVisited(${e.id})" title="Marker besøkt"><i class="fas fa-check"></i></button>`}\n        </div>\n      </div>\n    `;s?m.push(o):p.push(o)}),u+=p.join(""),m.length>0&&(u+=`\n      <div class="tw-visited-section">\n        <button class="tw-visited-toggle" onclick="this.parentElement.classList.toggle('expanded')">\n          <i class="fas fa-check-circle"></i>\n          <span>Besøkt (${m.length})</span>\n          <i class="fas fa-chevron-down tw-visited-chevron"></i>\n        </button>\n        <div class="tw-visited-list">\n          ${m.join("")}\n        </div>\n      </div>\n    `),i.innerHTML=u}function updateTodaysWorkBadge(e,t){const n=document.getElementById("todaysWorkBadge");n&&(t>0?(n.textContent=`${e}/${t}`,n.style.display=""):n.style.display="none")}async function startTodaysRoute(){if(twRouteData)try{const e=getCsrfToken(),t=await fetch(`/api/todays-work/start-route/${twRouteData.id}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e}});(await t.json()).success&&(showNotification("Rute startet!","success"),loadTodaysWork())}catch(e){showNotification("Kunne ikke starte ruten","error")}}async function twMarkVisited(e){if(twRouteData)try{const t=getCsrfToken(),n=await fetch(`/api/todays-work/visit/${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":t},body:JSON.stringify({rute_id:twRouteData.id,completed:!0})});(await n.json()).success&&(showNotification("Kunde markert som besøkt","success"),loadTodaysWork())}catch(t){if(!navigator.onLine&&window.SyncManager){if(twRouteData.visits){const t=twRouteData.visits.find(t=>t.kunde_id===e);t?(t.completed=!0,t.visited_at=(new Date).toISOString()):twRouteData.visits.push({kunde_id:e,completed:!0,visited_at:(new Date).toISOString()})}if(twRouteData.completed_count=(twRouteData.completed_count||0)+1,renderTodaysWork(),await SyncManager.queueOfflineAction({type:"VISIT_CUSTOMER",url:`/api/todays-work/visit/${e}`,method:"POST",body:{rute_id:twRouteData.id,completed:!0}}),window.OfflineStorage){const e=localStorage.getItem("userId")||"0";OfflineStorage.saveTodaysRoute(twCurrentDate,e,twRouteData).catch(()=>{})}showNotification("Besøk registrert (synkroniseres når du er online)","warning")}else showNotification("Kunne ikke registrere besøk","error")}}function twNavigateToCustomer(e){const t=twRouteData?.kunder?.find(t=>t.id===e);if(!t)return;const n=[t.adresse,t.postnummer,t.poststed].filter(Boolean).join(", ");if(t.latitude&&t.longitude){/iPad|iPhone|iPod/.test(navigator.userAgent)?window.open(`maps://maps.apple.com/?daddr=${t.latitude},${t.longitude}&dirflg=d`):window.open(`https://www.google.com/maps/dir/?api=1&destination=${t.latitude},${t.longitude}`)}else n&&window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(n)}`)}async function updateOnboardingStep(e,t={}){try{const n={"Content-Type":"application/json"},a=getCsrfToken();a&&(n["X-CSRF-Token"]=a);const s=await fetch("/api/onboarding/step",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({step:e,data:t})});return await s.json()}catch(e){return console.error("Error updating onboarding step:",e),{success:!1}}}async function skipOnboarding(){try{const e={},t=getCsrfToken();t&&(e["X-CSRF-Token"]=t);const n=await fetch("/api/onboarding/skip",{method:"POST",headers:e,credentials:"include"});return await n.json()}catch(e){return console.error("Error skipping onboarding:",e),{success:!1}}}async function getOnboardingStatus(){try{const e=await fetch("/api/onboarding/status",{credentials:"include"});return await e.json()}catch(e){return console.error("Error getting onboarding status:",e),{success:!1}}}window.twMarkVisited=twMarkVisited,window.twNavigateToCustomer=twNavigateToCustomer;const onboardingWizard={currentStep:0,steps:[{id:"company",title:"Firmainformasjon",icon:"fa-building"},{id:"map",title:"Kartinnstillinger",icon:"fa-map-marker-alt"},{id:"complete",title:"Ferdig",icon:"fa-check-circle"}],data:{industry:null,company:{},map:{}},overlay:null,resolve:null};async function showOnboardingWizard(){return new Promise(async e=>{onboardingWizard.resolve=e,onboardingWizard.currentStep=0,onboardingWizard.steps=[{id:"company",title:"Firmainformasjon",icon:"fa-building"},{id:"import",title:"Importer kunder",icon:"fa-file-excel"},{id:"map",title:"Kartinnstillinger",icon:"fa-map-marker-alt"},{id:"complete",title:"Ferdig",icon:"fa-check-circle"}];const t=document.createElement("div");t.id="onboardingWizardOverlay",t.className="onboarding-overlay",onboardingWizard.overlay=t,document.body.appendChild(t),await renderWizardStep(),requestAnimationFrame(()=>{t.classList.add("visible")})})}async function renderWizardStep(){const e=onboardingWizard.overlay,t=onboardingWizard.steps[onboardingWizard.currentStep];let n="";switch(t.id){case"company":n=renderCompanyStep();break;case"import":n=renderWizardImportStep();break;case"map":n=renderMapStep();break;case"complete":n=renderCompleteStep()}e.innerHTML=`\n    <div class="onboarding-container wizard-container">\n      ${renderWizardProgress()}\n      <div class="wizard-content" data-step="${t.id}">\n        ${n}\n      </div>\n    </div>\n  `,attachStepListeners(t.id)}function renderWizardProgress(){const e=onboardingWizard.steps,t=onboardingWizard.currentStep;return`\n    <div class="wizard-progress">\n      <div class="wizard-progress-bar">\n        <div class="wizard-progress-fill" style="width: ${t/(e.length-1)*100}%"></div>\n      </div>\n      <div class="wizard-steps">\n        ${e.map((e,n)=>`\n          <div class="wizard-step ${n<t?"completed":""} ${n===t?"active":""} ${n>t?"upcoming":""}">\n            <div class="wizard-step-icon">\n              ${n<t?'<i class="fas fa-check"></i>':`<span>${n+1}</span>`}\n            </div>\n            <div class="wizard-step-label">${e.title}</div>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}function renderCompanyStep(){const e=onboardingWizard.data.company;return`\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-building"></i> Firmainformasjon</h1>\n      <p>Oppgi firmaets adresse. Dette brukes som utgangspunkt for ruteplanlegging.</p>\n    </div>\n\n    <div class="wizard-form">\n      <div class="wizard-form-group">\n        <label for="companyAddress"><i class="fas fa-map-marker-alt"></i> Firmaadresse</label>\n        <div class="wizard-address-wrapper">\n          <input type="text" id="companyAddress" placeholder="Begynn å skrive adresse..." value="${escapeHtml(e.address||"")}" autocomplete="off">\n          <div class="wizard-address-suggestions" id="wizardAddressSuggestions"></div>\n        </div>\n      </div>\n\n      <div class="wizard-form-row">\n        <div class="wizard-form-group">\n          <label for="companyPostnummer"><i class="fas fa-hashtag"></i> Postnummer</label>\n          <div class="wizard-postnummer-wrapper">\n            <input type="text" id="companyPostnummer" placeholder="0000" maxlength="4" value="${escapeHtml(e.postnummer||"")}" autocomplete="off">\n            <span class="wizard-postnummer-status" id="wizardPostnummerStatus"></span>\n          </div>\n        </div>\n        <div class="wizard-form-group">\n          <label for="companyPoststed"><i class="fas fa-city"></i> Poststed</label>\n          <input type="text" id="companyPoststed" placeholder="Fylles automatisk" value="${escapeHtml(e.poststed||"")}">\n        </div>\n      </div>\n\n      <div class="wizard-form-group">\n        <label><i class="fas fa-route"></i> Rute-startpunkt</label>\n        <p class="wizard-form-hint">Klikk på kartet for å velge startpunkt for ruter, eller bruk firmaadresse.</p>\n        <div id="wizardRouteMap" class="wizard-mini-map"></div>\n        <div class="wizard-coordinates" id="routeCoordinates">\n          ${e.route_start_lat?`<span>Valgt: ${e.route_start_lat.toFixed(5)}, ${e.route_start_lng.toFixed(5)}</span>`:'<span class="not-set">Ikke valgt - klikk på kartet</span>'}\n        </div>\n        <button class="wizard-btn wizard-btn-secondary" onclick="useAddressAsRouteStart()">\n          <i class="fas fa-home"></i> Bruk firmaadresse\n        </button>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-skip" onclick="handleSkipOnboarding()">\n        <i class="fas fa-forward"></i> Hopp over oppsett\n      </button>\n      <button class="wizard-btn wizard-btn-primary" onclick="nextWizardStep()">\n        Neste <i class="fas fa-arrow-right"></i>\n      </button>\n    </div>\n  `}function renderMapStep(){const e=onboardingWizard.data.map;return`\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-map-marker-alt"></i> Kartinnstillinger</h1>\n      <p>Velg standard kartvisning. Dra og zoom kartet til ønsket område.</p>\n    </div>\n\n    <div class="wizard-form">\n      <div class="wizard-form-group">\n        <label><i class="fas fa-map"></i> Standard kartsentrum</label>\n        <p class="wizard-form-hint">Panorer og zoom kartet til det området du vanligvis jobber i.</p>\n        <div id="wizardMainMap" class="wizard-map"></div>\n      </div>\n\n      <div class="wizard-form-group">\n        <label for="defaultZoom"><i class="fas fa-search-plus"></i> Standard zoom-nivå</label>\n        <div class="wizard-slider-container">\n          <input type="range" id="defaultZoom" min="5" max="18" value="${e.zoom||10}">\n          <span class="wizard-slider-value" id="zoomValue">${e.zoom||10}</span>\n        </div>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-primary" onclick="nextWizardStep()">\n        Fullfør oppsett <i class="fas fa-check"></i>\n      </button>\n    </div>\n  `}function renderCompleteStep(){return`\n    <div class="wizard-step-header wizard-complete">\n      <div class="wizard-complete-icon">\n        <i class="fas fa-check-circle"></i>\n      </div>\n      <h1>Oppsettet er fullført!</h1>\n      <p>Flott! Systemet er nå tilpasset for ${escapeHtml(appConfig?.industry?.name||onboardingWizard.data.industry?.name||"din virksomhet")}.</p>\n    </div>\n\n    <div class="wizard-complete-summary">\n      <h3>Hva skjer nå?</h3>\n      <ul class="wizard-tips-list">\n        <li><i class="fas fa-users"></i> Legg til dine første kunder</li>\n        <li><i class="fas fa-route"></i> Planlegg effektive ruter</li>\n        <li><i class="fas fa-calendar-alt"></i> Bruk kalenderen for å holde oversikt</li>\n        <li><i class="fas fa-cog"></i> Tilpass ytterligere i innstillinger</li>\n      </ul>\n    </div>\n\n    <div class="wizard-footer wizard-footer-center">\n      <button class="wizard-btn wizard-btn-primary wizard-btn-large" onclick="completeOnboardingWizard()">\n        <i class="fas fa-rocket"></i> Start å bruke Sky Planner\n      </button>\n    </div>\n  `}const IMPORT_FIELD_TYPE_MAP={navn:"string",adresse:"string",postnummer:"postnummer",poststed:"string",telefon:"phone",epost:"email",kontaktperson:"string",notater:"string",kategori:"kategori",el_type:"string",brann_system:"string",brann_driftstype:"string",driftskategori:"string",siste_el_kontroll:"date",neste_el_kontroll:"date",siste_brann_kontroll:"date",neste_brann_kontroll:"date",siste_kontroll:"date",neste_kontroll:"date",kontroll_intervall_mnd:"integer",el_kontroll_intervall:"integer",brann_kontroll_intervall:"integer",ekstern_id:"string",org_nummer:"string"},wizardImportState={currentImportStep:1,sessionId:null,batchId:null,previewData:null,columnMapping:{},categoryMapping:{},customFieldMapping:{},validCategories:[],importResults:null,isLoading:!1,loadingPhase:null,loadingProgress:0,importedSoFar:0,totalToImport:0,aiQuestions:[],questionAnswers:{},requiredMappings:{navn:null,adresse:null},error:null,selectedRows:new Set,editedRows:{},editingCell:null,cleaningReport:null,cleanedPreview:null,originalPreview:null,enabledCleaningRules:{},useCleanedData:!0,cleaningTablePage:0,previewTablePage:0,previewShowBeforeAfter:!1,fieldToHeaderMapping:{},showMethodChoice:!0};let standaloneImportMode=!1;function resetWizardImportState(){wizardImportState.currentImportStep=1,wizardImportState.sessionId=null,wizardImportState.batchId=null,wizardImportState.previewData=null,wizardImportState.columnMapping={},wizardImportState.categoryMapping={},wizardImportState.customFieldMapping={},wizardImportState.validCategories=[],wizardImportState.importResults=null,wizardImportState.isLoading=!1,wizardImportState.loadingPhase=null,wizardImportState.loadingProgress=0,wizardImportState.importedSoFar=0,wizardImportState.totalToImport=0,wizardImportState.aiQuestions=[],wizardImportState.questionAnswers={},wizardImportState.requiredMappings={navn:null,adresse:null},wizardImportState.error=null,wizardImportState.selectedRows=new Set,wizardImportState.editedRows={},wizardImportState.editingCell=null,wizardImportState.cleaningReport=null,wizardImportState.cleanedPreview=null,wizardImportState.originalPreview=null,wizardImportState.enabledCleaningRules={},wizardImportState.useCleanedData=!0,wizardImportState.cleaningTablePage=0,wizardImportState.previewTablePage=0,wizardImportState.previewShowBeforeAfter=!1,wizardImportState.fieldToHeaderMapping={},wizardImportState.showMethodChoice=!0}function showImportModal(){standaloneImportMode=!0,resetWizardImportState();const e=document.getElementById("importModal"),t=document.getElementById("importModalContent");e&&t&&(t.innerHTML=renderStandaloneImportWizard(),e.classList.remove("hidden"),attachWizardImportListeners())}function closeImportModal(){const e=document.getElementById("importModal");e&&e.classList.add("hidden"),standaloneImportMode=!1,wizardImportState.importResults?.imported>0&&loadCustomers(),resetWizardImportState()}function renderStandaloneImportWizard(){const e=wizardImportState.currentImportStep;return`\n    \x3c!-- Import sub-steps indicator --\x3e\n    <div class="wizard-import-steps">\n      <div class="import-step-indicator ${e>=1?"active":""}" data-step="1">\n        <span class="step-number">1</span>\n        <span class="step-label">Last opp</span>\n      </div>\n      <div class="import-step-connector ${e>=2?"active":""}"></div>\n      <div class="import-step-indicator ${e>=2?"active":""}" data-step="2">\n        <span class="step-number">2</span>\n        <span class="step-label">Datarensing</span>\n      </div>\n      <div class="import-step-connector ${e>=3?"active":""}"></div>\n      <div class="import-step-indicator ${e>=3?"active":""}" data-step="3">\n        <span class="step-number">3</span>\n        <span class="step-label">Mapping</span>\n      </div>\n      <div class="import-step-connector ${e>=4?"active":""}"></div>\n      <div class="import-step-indicator ${e>=4?"active":""}" data-step="4">\n        <span class="step-number">4</span>\n        <span class="step-label">Forhåndsvis</span>\n      </div>\n      <div class="import-step-connector ${e>=5?"active":""}"></div>\n      <div class="import-step-indicator ${e>=5?"active":""}" data-step="5">\n        <span class="step-number">5</span>\n        <span class="step-label">Resultat</span>\n      </div>\n    </div>\n\n    \x3c!-- Dynamic content based on sub-step --\x3e\n    <div class="wizard-import-content" id="wizardImportContent">\n      ${renderWizardImportSubStep(e)}\n    </div>\n  `}function updateStandaloneImportContent(){if(!standaloneImportMode)return;const e=document.getElementById("importModalContent");e&&(e.innerHTML=renderStandaloneImportWizard(),attachWizardImportListeners())}function convertBackendToFrontendMapping(e,t){const n={};for(const[a,s]of Object.entries(e)){const e=t.indexOf(a);-1!==e&&(n[s]=e)}return n}function convertFrontendToBackendMapping(e,t){const n={};for(const[a,s]of Object.entries(e))void 0!==s&&""!==s&&t[s]&&(n[t[s]]=a);return n}function getSampleValueForColumn(e,t,n){if(!e||void 0===t||""===t||!n)return"-";const a=n[t];if(!a)return"-";const s=e[a];return null==s||""===s?"-":String(s)}function renderWizardImportMethodChoice(){return'\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-download"></i> Importer kunder</h1>\n      <p>Velg hvordan du vil hente inn dine eksisterende kunder.</p>\n    </div>\n\n    <div class="wizard-import-method-choice">\n      <div class="wizard-method-card" role="button" tabindex="0" onclick="selectImportMethodIntegration()">\n        <div class="wizard-method-icon">\n          <i class="fas fa-plug" aria-hidden="true"></i>\n        </div>\n        <h3>Regnskapssystem</h3>\n        <p>Koble til Tripletex, Fiken eller PowerOffice og synkroniser kunder automatisk.</p>\n        <span class="wizard-method-action">Koble til <i class="fas fa-external-link-alt" aria-hidden="true"></i></span>\n      </div>\n\n      <div class="wizard-method-card" role="button" tabindex="0" onclick="selectImportMethodFile()">\n        <div class="wizard-method-icon">\n          <i class="fas fa-file-excel" aria-hidden="true"></i>\n        </div>\n        <h3>Excel / CSV</h3>\n        <p>Last opp en fil med kundedata. AI-assistert mapping hjelper deg med kolonnene.</p>\n        <span class="wizard-method-action">Last opp fil <i class="fas fa-arrow-right" aria-hidden="true"></i></span>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-skip" onclick="skipWizardImport()">\n        Hopp over <i class="fas fa-forward"></i>\n      </button>\n    </div>\n  '}function selectImportMethodIntegration(){const e=appConfig.webUrl||"";window.open(e+"/dashboard/innstillinger/integrasjoner","_blank"),showToast("Koble til regnskapssystemet i fanen som ble apnet. Kom tilbake hit for a fortsette oppsettet.","info",8e3)}function selectImportMethodFile(){wizardImportState.showMethodChoice=!1;const e=document.querySelector('.wizard-content[data-step="import"]');e&&(e.innerHTML=renderWizardImportStep(),attachWizardImportListeners())}function renderWizardImportStep(){if(wizardImportState.showMethodChoice&&!standaloneImportMode)return renderWizardImportMethodChoice();const e=wizardImportState.currentImportStep;return`\n    <div class="wizard-step-header">\n      <h1><i class="fas fa-file-excel"></i> Importer kunder</h1>\n      <p>Last opp en Excel- eller CSV-fil med dine eksisterende kunder.</p>\n    </div>\n\n    \x3c!-- Import sub-steps indicator --\x3e\n    <div class="wizard-import-steps">\n      <div class="import-step-indicator ${e>=1?"active":""}" data-step="1">\n        <span class="step-number">1</span>\n        <span class="step-label">Last opp</span>\n      </div>\n      <div class="import-step-connector ${e>=2?"active":""}"></div>\n      <div class="import-step-indicator ${e>=2?"active":""}" data-step="2">\n        <span class="step-number">2</span>\n        <span class="step-label">Datarensing</span>\n      </div>\n      <div class="import-step-connector ${e>=3?"active":""}"></div>\n      <div class="import-step-indicator ${e>=3?"active":""}" data-step="3">\n        <span class="step-number">3</span>\n        <span class="step-label">Mapping</span>\n      </div>\n      <div class="import-step-connector ${e>=4?"active":""}"></div>\n      <div class="import-step-indicator ${e>=4?"active":""}" data-step="4">\n        <span class="step-number">4</span>\n        <span class="step-label">Forhåndsvis</span>\n      </div>\n      <div class="import-step-connector ${e>=5?"active":""}"></div>\n      <div class="import-step-indicator ${e>=5?"active":""}" data-step="5">\n        <span class="step-number">5</span>\n        <span class="step-label">Resultat</span>\n      </div>\n    </div>\n\n    \x3c!-- Dynamic content based on sub-step --\x3e\n    <div class="wizard-import-content" id="wizardImportContent">\n      ${renderWizardImportSubStep(e)}\n    </div>\n  `}function renderWizardLoadingState(){const e=wizardImportState.loadingPhase,t=wizardImportState.loadingProgress,n={uploading:{icon:"fa-cloud-upload-alt",message:"Laster opp fil...",isAI:!1},parsing:{icon:"fa-file-excel",message:"Leser kolonner og rader...",isAI:!1},"ai-mapping":{icon:"fa-robot",message:"AI analyserer kolonner...",isAI:!0},cleaning:{icon:"fa-broom",message:"Renser data...",isAI:!1},mapping:{icon:"fa-columns",message:"Kobler kolonner til felt...",isAI:!1},validating:{icon:"fa-check-circle",message:"Validerer data...",isAI:!1},importing:{icon:"fa-database",message:"Importerer kunder...",isAI:!1,showProgress:!0}}[e]||{icon:"fa-spinner",message:"Behandler...",isAI:!1};return`\n    <div class="wizard-import-loading ${n.isAI?"ai-active":""}">\n      <div class="wizard-loading-icon ${n.isAI?"ai-pulse":"spinning"}">\n        <i class="fas ${n.icon}"></i>\n      </div>\n      <p class="wizard-loading-message">${n.message}</p>\n      ${n.isAI?'\n        <div class="wizard-ai-thinking">\n          <span class="ai-dot"></span>\n          <span class="ai-dot"></span>\n          <span class="ai-dot"></span>\n        </div>\n        <p class="wizard-ai-hint">AI forstår kolonnenavn som "Hvem ringer vi?" → kontaktperson</p>\n      ':""}\n      ${n.showProgress?`\n        <div class="wizard-progress-container">\n          <div class="wizard-progress-bar">\n            <div class="wizard-progress-fill" style="width: ${t}%"></div>\n          </div>\n          <p class="wizard-progress-text">${wizardImportState.importedSoFar} av ${wizardImportState.totalToImport} kunder</p>\n        </div>\n      `:""}\n    </div>\n  `}function renderWizardImportSubStep(e){if(wizardImportState.isLoading)return renderWizardLoadingState();if(wizardImportState.error)return`\n      <div class="wizard-import-error">\n        <i class="fas fa-exclamation-triangle"></i>\n        <p>${escapeHtml(wizardImportState.error)}</p>\n        <button class="wizard-btn wizard-btn-secondary" onclick="wizardImportRetry()">\n          <i class="fas fa-redo"></i> Prøv igjen\n        </button>\n      </div>\n    `;switch(e){case 1:default:return renderWizardImportUpload();case 2:return renderWizardImportCleaning();case 3:return renderWizardImportMapping();case 4:return renderWizardImportPreview();case 5:return renderWizardImportResults()}}function renderWizardImportCleaning(){const e=wizardImportState.cleaningReport,t=e?e.totalCellsCleaned+e.totalRowsRemoved:0,n=wizardImportState.previewData,a=n?n.totalRows:0;if(!e||0===t)return`\n      <div class="wizard-cleaning-container">\n        <div class="wizard-cleaning-summary wizard-cleaning-clean">\n          <i class="fas fa-check-circle"></i>\n          <div>\n            <strong>Ingen problemer funnet</strong>\n            <p>Filen ser bra ut! ${a} rader klare for import.</p>\n          </div>\n        </div>\n        <div class="wizard-import-actions">\n          <button class="wizard-btn wizard-btn-secondary" onclick="wizardCleaningBack()">\n            <i class="fas fa-arrow-left"></i> Tilbake\n          </button>\n          <button class="wizard-btn wizard-btn-primary" onclick="wizardCleaningApprove()">\n            Gå videre <i class="fas fa-arrow-right"></i>\n          </button>\n        </div>\n      </div>\n    `;const s=wizardImportState.enabledCleaningRules,o=e.cellChanges.filter(e=>s[e.ruleId]),r=e.rowRemovals.filter(e=>s[e.ruleId]),i=o.length+r.length,l=o.slice(0,50),d=o.length>50;return`\n    <div class="wizard-cleaning-container">\n      \x3c!-- Summary banner --\x3e\n      <div class="wizard-cleaning-summary">\n        <i class="fas fa-broom"></i>\n        <div>\n          <strong>${i} ${1===i?"endring":"endringer"} funnet i ${a} rader</strong>\n          <p>${o.length} ${1===o.length?"celle":"celler"} renset, ${r.length} ${1===r.length?"rad":"rader"} foreslått fjernet.</p>\n        </div>\n      </div>\n\n      \x3c!-- Rule toggles --\x3e\n      <div class="wizard-cleaning-rules">\n        <h3>Renseregler</h3>\n        <div class="wizard-cleaning-rules-list">\n          ${e.rules.filter(e=>e.affectedCount>0).map(e=>`\n            <label class="wizard-cleaning-rule-toggle">\n              <input type="checkbox" ${s[e.ruleId]?"checked":""}\n                onchange="wizardToggleCleaningRule('${e.ruleId}', this.checked)">\n              <span class="wizard-cleaning-rule-info">\n                <span class="wizard-cleaning-rule-name">${escapeHtml(e.name)}</span>\n                <span class="wizard-cleaning-rule-desc">${escapeHtml(e.description)}</span>\n              </span>\n              <span class="wizard-cleaning-rule-count">${e.affectedCount} ${"rows"===e.category?1===e.affectedCount?"rad":"rader":1===e.affectedCount?"celle":"celler"}</span>\n            </label>\n          `).join("")}\n        </div>\n      </div>\n\n      ${l.length>0?`\n      \x3c!-- Diff table --\x3e\n      <div class="wizard-cleaning-diff-section">\n        <h3>Endringsoversikt</h3>\n        <div class="wizard-cleaning-diff-table-wrapper">\n          <table class="wizard-cleaning-diff-table">\n            <thead>\n              <tr>\n                <th>#</th>\n                <th>Kolonne</th>\n                <th>Rad</th>\n                <th>Opprinnelig</th>\n                <th>Renset</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${l.map((e,t)=>`\n                <tr>\n                  <td>${t+1}</td>\n                  <td>${escapeHtml(e.column)}</td>\n                  <td>${e.rowIndex+2}</td>\n                  <td class="cell-original">${formatCleaningValue(e.originalValue)}</td>\n                  <td class="cell-cleaned">${formatCleaningValue(e.cleanedValue)}</td>\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n        </div>\n        ${d?`\n          <p class="wizard-cleaning-more">Viser 50 av ${o.length} endringer</p>\n        `:""}\n      </div>\n      `:""}\n\n      ${renderCleaningFullTable()}\n\n      ${r.length>0?`\n      \x3c!-- Removed rows --\x3e\n      <details class="wizard-cleaning-removed">\n        <summary>${r.length} ${1===r.length?"rad":"rader"} fjernet</summary>\n        <div class="wizard-cleaning-removed-list">\n          ${r.map(e=>`\n            <div class="wizard-cleaning-removed-item">\n              <span class="removal-row">Rad ${e.rowIndex+2}</span>\n              <span class="removal-reason">${escapeHtml(e.reason)}</span>\n            </div>\n          `).join("")}\n        </div>\n      </details>\n      `:""}\n\n      \x3c!-- Actions --\x3e\n      <div class="wizard-import-actions">\n        <button class="wizard-btn wizard-btn-secondary" onclick="wizardCleaningBack()">\n          <i class="fas fa-arrow-left"></i> Tilbake\n        </button>\n        <button class="wizard-btn wizard-btn-ghost" onclick="wizardCleaningSkip()">\n          Hopp over rensing\n        </button>\n        <button class="wizard-btn wizard-btn-primary" onclick="wizardCleaningApprove()">\n          <i class="fas fa-check"></i> Godkjenn rensing <i class="fas fa-arrow-right"></i>\n        </button>\n      </div>\n    </div>\n  `}function formatCleaningValue(e){if(null==e)return'<span class="cleaning-null">(tom)</span>';const t=String(e);if(""===t)return'<span class="cleaning-null">(tom)</span>';return escapeHtml(t.replace(/ /g,"·").replace(/\t/g,"→"))}function wizardToggleCleaningRule(e,t){wizardImportState.enabledCleaningRules[e]=t,updateWizardImportContent()}function wizardCleaningTablePage(e){wizardImportState.cleaningTablePage=Math.max(0,e),updateWizardImportContent()}function renderCleaningFullTable(){const e=wizardImportState.originalPreview,t=wizardImportState.previewData?.headers||[],n=wizardImportState.cleaningReport,a=wizardImportState.enabledCleaningRules;if(!e||0===e.length||0===t.length)return"";const s=new Map;if(n)for(const e of n.cellChanges)a[e.ruleId]&&s.set(`${e.rowIndex}|${e.column}`,e);const o=new Set;if(n)for(const e of n.rowRemovals)a[e.ruleId]&&o.add(e.rowIndex);const r=wizardImportState.cleaningTablePage||0,i=Math.ceil(e.length/50),l=Math.min(r,i-1),d=50*l,c=e.slice(d,d+50),u=t.slice(0,8),m=t.length>8;return`\n    <div class="wizard-cleaning-fulltable-section">\n      <h3><i class="fas fa-table"></i> Fullstendig dataoversikt</h3>\n      <p class="wizard-section-desc">${e.length} rader totalt. Endrede celler er markert. Fjernede rader er gjennomstreket.</p>\n      <div class="wizard-cleaning-fulltable-wrapper">\n        <table class="wizard-cleaning-fulltable">\n          <thead>\n            <tr>\n              <th>#</th>\n              ${u.map(e=>`<th>${escapeHtml(e)}</th>`).join("")}\n              ${m?"<th>...</th>":""}\n            </tr>\n          </thead>\n          <tbody>\n            ${c.map((e,t)=>{const n=void 0!==e._rowIndex?e._rowIndex:d+t,a=o.has(n);return`\n                <tr class="${a?"row-removed":""}">\n                  <td>${n+2}</td>\n                  ${u.map(t=>{const o=s.get(`${n}|${t}`),r=String(a?e[t]??"":o?o.cleanedValue??"":e[t]??""),i=o&&!a?"cell-was-cleaned":"",l=o&&!a?`Opprinnelig: ${String(o.originalValue??"(tom)")}`:a?"Denne raden fjernes":"";return`<td class="${i}" ${l?`title="${escapeHtml(l)}"`:""}>${escapeHtml(r||"-")}</td>`}).join("")}\n                  ${m?"<td>...</td>":""}\n                </tr>\n              `}).join("")}\n          </tbody>\n        </table>\n      </div>\n      ${i>1?`\n        <div class="wizard-cleaning-pagination">\n          <button class="wizard-btn wizard-btn-small wizard-btn-secondary"\n            onclick="wizardCleaningTablePage(${l-1})" ${0===l?"disabled":""}>\n            <i class="fas fa-chevron-left"></i> Forrige\n          </button>\n          <span>Side ${l+1} av ${i}</span>\n          <button class="wizard-btn wizard-btn-small wizard-btn-secondary"\n            onclick="wizardCleaningTablePage(${l+1})" ${l>=i-1?"disabled":""}>\n            Neste <i class="fas fa-chevron-right"></i>\n          </button>\n        </div>\n      `:""}\n    </div>\n  `}function wizardCleaningBack(){wizardImportState.currentImportStep=1,updateWizardImportContent()}function wizardCleaningSkip(){wizardImportState.useCleanedData=!1,wizardImportState.currentImportStep=3,updateWizardImportContent()}function wizardCleaningApprove(){wizardImportState.useCleanedData=!0;const e=getEffectiveCleanedData();e&&(wizardImportState.previewData={...wizardImportState.previewData,preview:e,totalRows:e.length}),wizardImportState.currentImportStep=3,updateWizardImportContent()}function getEffectiveCleanedData(){const e=wizardImportState.cleaningReport,t=wizardImportState.originalPreview;if(!e||!t)return null;const n=wizardImportState.enabledCleaningRules;let a=t.map(e=>({...e}));const s=new Set;for(const t of e.rowRemovals)n[t.ruleId]&&s.add(t.rowIndex);a=a.filter((e,t)=>!s.has(void 0!==e._rowIndex?e._rowIndex:t));const o=new Map;for(const t of e.cellChanges){if(!n[t.ruleId])continue;if(s.has(t.rowIndex))continue;const e=`${t.rowIndex}|${t.column}`;o.set(e,t.cleanedValue)}for(const e of a){const t=void 0!==e._rowIndex?e._rowIndex:-1;for(const[n,a]of o){const[s,o]=n.split("|");Number(s)===t&&(e[o]=a)}}return a.map((e,t)=>({...e,_rowIndex:t}))}function renderWizardImportUpload(){return`\n    <div class="wizard-import-upload">\n      \x3c!-- AI Feature Banner --\x3e\n      <div class="wizard-ai-feature-banner">\n        <div class="ai-feature-icon">\n          <i class="fas fa-robot"></i>\n        </div>\n        <div class="ai-feature-content">\n          <h4><i class="fas fa-magic"></i> AI-assistert import</h4>\n          <p>Vår AI forstår <strong>${escapeHtml(appConfig?.industry?.name||"din bransje")}</strong> og mapper automatisk kolonner til riktige felt - selv med kreative kolonnenavn!</p>\n        </div>\n      </div>\n\n      <div class="wizard-import-dropzone" id="wizardImportDropzone" role="button" tabindex="0" aria-label="Last opp fil. Dra og slipp, eller trykk for å velge fil.">\n        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>\n        <p><strong>Dra og slipp fil her</strong></p>\n        <p>eller klikk for å velge</p>\n        <span class="import-formats">Støttede formater: .xlsx, .xls, .csv (maks 10MB)</span>\n        <input type="file" id="wizardImportFileInput" accept=".xlsx,.xls,.csv" hidden>\n      </div>\n\n      <div class="wizard-import-tips">\n        <h4><i class="fas fa-lightbulb"></i> Tips for import</h4>\n        <ul>\n          <li>Filen bør ha én rad per kunde</li>\n          <li>Første rad bør inneholde kolonneoverskrifter</li>\n          <li>Påkrevde felt: Navn og adresse</li>\n          <li>AI gjenkjenner bransje-spesifikke felt automatisk</li>\n        </ul>\n      </div>\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-skip" onclick="skipWizardImport()">\n        Hopp over <i class="fas fa-forward"></i>\n      </button>\n    </div>\n  `}function renderAIQuestions(){const e=wizardImportState.aiQuestions||[];return 0===e.length?"":`\n    <div class="wizard-ai-questions">\n      <div class="wizard-ai-questions-header">\n        <i class="fas fa-question-circle"></i>\n        <span>AI trenger din hjelp med ${e.length} ${1===e.length?"kolonne":"kolonner"}</span>\n        <button class="wizard-btn-link" onclick="skipAIQuestions()">Bruk AI-anbefalinger</button>\n      </div>\n      <div class="wizard-ai-questions-list">\n        ${e.map((e,t)=>`\n          <div class="wizard-ai-question-card" data-question-index="${t}">\n            <div class="question-header">\n              <span class="question-column">"${escapeHtml(e.header)}"</span>\n              <span class="question-confidence">${Math.round(100*(e.confidence||0))}% sikker</span>\n            </div>\n            <p class="question-text">Hva inneholder denne kolonnen?</p>\n            <div class="question-options">\n              <label class="question-option ${wizardImportState.questionAnswers[e.header]===e.targetField?"selected":""}">\n                <input type="radio" name="q_${t}" value="${e.targetField||""}"\n                  ${wizardImportState.questionAnswers[e.header]===e.targetField||!wizardImportState.questionAnswers[e.header]&&e.targetField?"checked":""}\n                  onchange="handleAIQuestionAnswer('${escapeHtml(e.header)}', '${e.targetField||""}')">\n                <span>${escapeHtml(e.targetField||"Egendefinert felt")} <span class="recommended">(Anbefalt av AI)</span></span>\n              </label>\n              <label class="question-option ${"_custom"===wizardImportState.questionAnswers[e.header]?"selected":""}">\n                <input type="radio" name="q_${t}" value="_custom"\n                  ${"_custom"===wizardImportState.questionAnswers[e.header]?"checked":""}\n                  onchange="handleAIQuestionAnswer('${escapeHtml(e.header)}', '_custom')">\n                <span>Behold som egendefinert felt</span>\n              </label>\n              <label class="question-option ${"_skip"===wizardImportState.questionAnswers[e.header]?"selected":""}">\n                <input type="radio" name="q_${t}" value="_skip"\n                  ${"_skip"===wizardImportState.questionAnswers[e.header]?"checked":""}\n                  onchange="handleAIQuestionAnswer('${escapeHtml(e.header)}', '_skip')">\n                <span>Ignorer denne kolonnen</span>\n              </label>\n            </div>\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}function handleAIQuestionAnswer(e,t){wizardImportState.questionAnswers[e]=t,updateWizardImportContent()}function skipAIQuestions(){wizardImportState.aiQuestions=[],updateWizardImportContent()}function updateRequiredMapping(e,t){wizardImportState.requiredMappings[e]=t,updateWizardImportContent()}function areRequiredFieldsMapped(){const{navn:e,adresse:t}=wizardImportState.requiredMappings;return!(!e||!t)&&e!==t}function isSameColumnSelected(){const{navn:e,adresse:t}=wizardImportState.requiredMappings;return e&&t&&e===t}function renderRequiredFieldSelectors(e){const t=e.allColumns||e.headers||[],n=wizardImportState.requiredMappings;if(0===t.length)return"";const a=n.navn&&n.adresse&&"-- Velg kolonne --"!==n.navn&&"-- Velg kolonne --"!==n.adresse;return`\n    <div class="wizard-required-fields ${a?"wizard-fields-ok":""}">\n      ${a?'\n        <div class="wizard-required-header wizard-header-success">\n          <i class="fas fa-check-circle"></i>\n          <span>Kolonner gjenkjent automatisk</span>\n        </div>\n        <p class="wizard-required-desc">Endre hvis noe er feil.</p>\n      ':'\n        <div class="wizard-required-header">\n          <i class="fas fa-columns"></i>\n          <span>Velg kolonner</span>\n        </div>\n        <p class="wizard-required-desc">Velg hvilken kolonne som er kundenavn og adresse.</p>\n      '}\n\n      <div class="wizard-required-grid">\n        <div class="wizard-required-row">\n          <label>\n            <i class="fas fa-user"></i>\n            Kundenavn\n          </label>\n          <select id="navnColumnSelect" onchange="updateRequiredMapping('navn', this.value)" class="wizard-required-select">\n            <option value="">-- Velg kolonne --</option>\n            ${t.map(e=>`\n              <option value="${escapeHtml(e)}" ${n.navn===e?"selected":""}>\n                ${escapeHtml(e)}\n              </option>\n            `).join("")}\n          </select>\n        </div>\n\n        <div class="wizard-required-row">\n          <label>\n            <i class="fas fa-map-marker-alt"></i>\n            Adresse\n          </label>\n          <select id="adresseColumnSelect" onchange="updateRequiredMapping('adresse', this.value)" class="wizard-required-select">\n            <option value="">-- Velg kolonne --</option>\n            ${t.map(e=>`\n              <option value="${escapeHtml(e)}" ${n.adresse===e?"selected":""}>\n                ${escapeHtml(e)}\n              </option>\n            `).join("")}\n          </select>\n        </div>\n      </div>\n\n      ${isSameColumnSelected()?'\n        <div class="wizard-required-warning wizard-required-error">\n          <i class="fas fa-times-circle"></i>\n          <span>Kundenavn og adresse kan ikke bruke samme kolonne.</span>\n        </div>\n      ':""}\n    </div>\n  `}function renderWizardImportMapping(){const e=wizardImportState.previewData;if(!e)return renderWizardImportUpload();const t=e.stats||{},n=e.recognizedColumns||[],a=e.newFields||[],s=e.preview||[],o=n.filter(e=>"ai"===e.source).length;n.filter(e=>"deterministic"===e.source).length;return`\n    <div class="wizard-auto-preview">\n      \x3c!-- Summary header --\x3e\n      <div class="wizard-auto-summary">\n        <div class="wizard-auto-success">\n          <i class="fas fa-check-circle"></i>\n          <span>Fant <strong>${e.totalRows||0}</strong> kunder i filen</span>\n        </div>\n\n        <div class="wizard-auto-stats">\n          <div class="wizard-auto-stat">\n            <i class="fas fa-columns"></i>\n            <span>${e.totalColumns||0} kolonner totalt</span>\n          </div>\n          <div class="wizard-auto-stat wizard-auto-stat-success">\n            <i class="fas fa-check"></i>\n            <span>${n.length} gjenkjent</span>\n          </div>\n          ${a.length>0?`\n            <div class="wizard-auto-stat wizard-auto-stat-new">\n              <i class="fas fa-plus"></i>\n              <span>${a.length} nye felt</span>\n            </div>\n          `:""}\n        </div>\n      </div>\n\n      \x3c!-- Mapping Status indicator --\x3e\n      <div class="wizard-ai-status wizard-ai-enabled">\n        <i class="fas fa-magic"></i>\n        <span>\n          <strong>Automatisk kolonnemap</strong>\n          ${o>0?`- ${o} kolonner gjenkjent`:"- Velg kolonner manuelt nedenfor"}\n        </span>\n      </div>\n\n      \x3c!-- REQUIRED: Column selection for name and address --\x3e\n      ${renderRequiredFieldSelectors(e)}\n\n      \x3c!-- AI Questions for ambiguous mappings --\x3e\n      ${renderAIQuestions()}\n\n      \x3c!-- Recognized columns --\x3e\n      ${n.length>0?`\n        <div class="wizard-auto-section">\n          <h4><i class="fas fa-check-circle"></i> Gjenkjente kolonner</h4>\n          <div class="wizard-auto-columns">\n            ${n.map(e=>`\n              <div class="wizard-auto-column recognized ${"ai"===e.source?"ai-mapped":""}">\n                <span class="column-from">${escapeHtml(e.header)}</span>\n                <i class="fas fa-arrow-right"></i>\n                <span class="column-to">${escapeHtml(e.mappedTo)}</span>\n                ${"ai"===e.source?`\n                  <span class="mapping-source ai" title="Mappet av AI med ${Math.round(100*(e.confidence||0))}% sikkerhet">\n                    <i class="fas fa-robot"></i>\n                  </span>\n                `:""}\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- New fields that will be created --\x3e\n      ${a.length>0?`\n        <div class="wizard-auto-section">\n          <h4><i class="fas fa-plus-circle"></i> Nye felt som opprettes automatisk</h4>\n          <div class="wizard-auto-columns">\n            ${a.map(e=>`\n              <div class="wizard-auto-column new-field">\n                <span class="column-from">"${escapeHtml(e.header)}"</span>\n                <i class="fas fa-arrow-right"></i>\n                <span class="column-to">\n                  ${escapeHtml(e.displayName)}\n                  <span class="field-type">(${escapeHtml(e.typeDisplay)}${e.optionsCount>0?`, ${e.optionsCount} valg`:""})</span>\n                </span>\n              </div>\n            `).join("")}\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- Preview table --\x3e\n      ${s.length>0?`\n        <div class="wizard-auto-section">\n          <h4><i class="fas fa-table"></i> Forhåndsvisning</h4>\n          <div class="wizard-auto-table-wrapper">\n            <table class="wizard-auto-table">\n              <thead>\n                <tr>\n                  ${Object.keys(s[0]||{}).slice(0,6).map(e=>`\n                    <th>${escapeHtml(e)}</th>\n                  `).join("")}\n                  ${Object.keys(s[0]||{}).length>6?"<th>...</th>":""}\n                </tr>\n              </thead>\n              <tbody>\n                ${s.slice(0,3).map(e=>`\n                  <tr>\n                    ${Object.values(e).slice(0,6).map(e=>`\n                      <td>${escapeHtml(String(e||"-"))}</td>\n                    `).join("")}\n                    ${Object.keys(e).length>6?"<td>...</td>":""}\n                  </tr>\n                `).join("")}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      `:""}\n\n      \x3c!-- Validation info --\x3e\n      ${t.invalid>0?`\n        <div class="wizard-auto-warning">\n          <i class="fas fa-exclamation-triangle"></i>\n          <span>${t.invalid} rader mangler påkrevd data og vil bli hoppet over</span>\n        </div>\n      `:""}\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="wizardImportBack()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <button class="wizard-btn wizard-btn-primary"\n        onclick="wizardImportNext()"\n        ${areRequiredFieldsMapped()?"":'disabled title="Velg kolonner for kundenavn og adresse først"'}>\n        Forhåndsvis <i class="fas fa-arrow-right"></i>\n      </button>\n    </div>\n  `}function renderUnmappedColumnsSection(e,t,n,a){const s=e.unmappedColumns||[];if(0===s.length)return"";const o=new Set(Object.values(n).filter(e=>void 0!==e&&""!==e)),r=s.filter(e=>{const n=t.indexOf(e.header);return!o.has(n)});return 0===r.length?"":(wizardImportState.customFieldMapping||(wizardImportState.customFieldMapping={}),`\n    <div class="wizard-unmapped-section">\n      <h4 class="wizard-section-title">\n        <i class="fas fa-plus-circle"></i>\n        Ekstra kolonner i filen (${r.length})\n      </h4>\n      <p class="wizard-section-desc">\n        Disse kolonnene finnes ikke i standardfeltene. Velg hva du vil gjøre med dem:\n      </p>\n\n      <div class="wizard-unmapped-grid">\n        ${r.map(e=>{const t=wizardImportState.customFieldMapping[e.header]||"ignore";return`\n            <div class="wizard-unmapped-row">\n              <div class="wizard-unmapped-info">\n                <span class="wizard-unmapped-header">${escapeHtml(e.header)}</span>\n                <span class="wizard-unmapped-sample">Eksempel: ${escapeHtml(e.sampleValue||"-")}</span>\n              </div>\n              <div class="wizard-unmapped-action">\n                <select onchange="handleUnmappedColumn('${escapeHtml(e.header)}', this.value)">\n                  <option value="ignore" ${"ignore"===t?"selected":""}>\n                    Ignorer\n                  </option>\n                  <option value="create" ${"create"===t?"selected":""}>\n                    Opprett felt "${escapeHtml(e.suggestedDisplayName||e.header)}"\n                  </option>\n                  ${a.map(e=>`\n                    <option value="map:${e.key}" ${t==="map:"+e.key?"selected":""}>\n                      Mapp til ${escapeHtml(e.label)}\n                    </option>\n                  `).join("")}\n                </select>\n              </div>\n            </div>\n          `}).join("")}\n      </div>\n    </div>\n  `)}function handleUnmappedColumn(e,t){if(wizardImportState.customFieldMapping||(wizardImportState.customFieldMapping={}),"ignore"===t)delete wizardImportState.customFieldMapping[e];else if("create"===t)wizardImportState.customFieldMapping[e]="create";else if(t.startsWith("map:")){const n=t.substring(4),a=(wizardImportState.previewData?.headers||[]).indexOf(e);-1!==a&&(wizardImportState.columnMapping[n]=a),delete wizardImportState.customFieldMapping[e]}updateWizardImportContent()}function renderWizardImportPreview(){const e=wizardImportState.previewData;if(!e||!e.preview)return renderWizardImportMapping();const t=e.preview,n=e.stats||{},a=e.categoryMatches||[],s=e.reimportPreview||{},o=e.features||{},r=wizardImportState.validCategories||[];let i="";a.length>0&&(i=`\n      <div class="wizard-category-mapping">\n        <h4><i class="fas fa-tags"></i> Kategori-mapping</h4>\n        <p>Følgende kategorier ble funnet i filen. Koble dem til eksisterende kategorier eller opprett nye.</p>\n        <div class="wizard-category-list">\n          ${a.map(e=>`\n            <div class="wizard-category-row">\n              <div class="wizard-category-original">\n                <span class="category-label">Fra fil:</span>\n                <span class="category-value">${escapeHtml(e.original)}</span>\n                <span class="category-count">(${e.count} kunder)</span>\n              </div>\n              <div class="wizard-category-arrow"><i class="fas fa-arrow-right"></i></div>\n              <div class="wizard-category-select">\n                <select data-original="${escapeHtml(e.original)}" onchange="updateWizardCategoryMapping('${escapeHtml(e.original)}', this.value)">\n                  ${e.suggested?`\n                    <option value="${escapeHtml(e.suggested.id)}" selected>\n                      ${escapeHtml(e.suggested.name)} (anbefalt)\n                    </option>\n                  `:'<option value="">-- Velg kategori --</option>'}\n                  ${r.filter(t=>!e.suggested||t.id!==e.suggested.id).map(e=>`\n                    <option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>\n                  `).join("")}\n                  <option value="__skip__">Hopp over (ingen kategori)</option>\n                  <option value="__new__">Opprett ny kategori</option>\n                </select>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `);const l=t[0]||{},d=Object.keys(l).filter(e=>!e.startsWith("_")&&"hasError"!==e&&"hasWarning"!==e&&"errorMessage"!==e&&"validationErrors"!==e&&"fieldErrors"!==e),c=["navn","adresse","postnummer","poststed","epost","telefon","kontaktperson","kategori","siste_kontroll","neste_kontroll"],u=[...c.filter(e=>d.includes(e)),...d.filter(e=>!c.includes(e))],m=wizardImportState.previewTablePage||0,p=Math.ceil(t.length/50),g=Math.min(m,Math.max(0,p-1)),f=t.slice(50*g,50*(g+1)),v=wizardImportState.previewShowBeforeAfter,y=wizardImportState.fieldToHeaderMapping||{};return`\n    <div class="wizard-import-preview">\n      \x3c!-- Stats summary --\x3e\n      <div class="wizard-preview-stats">\n        <div class="stat-item">\n          <i class="fas fa-file-alt"></i>\n          <span class="stat-value">${n.totalRows||0}</span>\n          <span class="stat-label">Totalt rader</span>\n        </div>\n        <div class="stat-item ${n.validRows>0?"success":""}">\n          <i class="fas fa-check-circle"></i>\n          <span class="stat-value">${n.validRows||0}</span>\n          <span class="stat-label">Gyldige</span>\n        </div>\n        <div class="stat-item ${n.warnings>0?"warning":""}">\n          <i class="fas fa-exclamation-triangle"></i>\n          <span class="stat-value">${n.warnings||0}</span>\n          <span class="stat-label">Advarsler</span>\n        </div>\n        <div class="stat-item ${n.errors>0?"error":""}">\n          <i class="fas fa-times-circle"></i>\n          <span class="stat-value">${n.errors||0}</span>\n          <span class="stat-label">Feil</span>\n        </div>\n        <div class="stat-item ${n.duplicates>0?"warning":""}">\n          <i class="fas fa-copy"></i>\n          <span class="stat-value">${n.duplicates||0}</span>\n          <span class="stat-label">Duplikater</span>\n        </div>\n      </div>\n\n      ${o.updateEnabled||o.deletionDetectionEnabled?`\n        \x3c!-- Re-import Preview Summary --\x3e\n        <div class="wizard-reimport-summary">\n          <h4><i class="fas fa-sync-alt"></i> Oppsummering av import</h4>\n          <div class="wizard-reimport-stats">\n            <div class="reimport-stat-item new">\n              <i class="fas fa-plus-circle"></i>\n              <span class="stat-value">${s.toCreate||0}</span>\n              <span class="stat-label">Nye kunder</span>\n            </div>\n            ${o.updateEnabled?`\n              <div class="reimport-stat-item update">\n                <i class="fas fa-edit"></i>\n                <span class="stat-value">${s.toUpdate||0}</span>\n                <span class="stat-label">Oppdateres</span>\n              </div>\n              <div class="reimport-stat-item unchanged">\n                <i class="fas fa-equals"></i>\n                <span class="stat-value">${s.unchanged||0}</span>\n                <span class="stat-label">Uendret</span>\n              </div>\n            `:""}\n          </div>\n          ${o.deletionDetectionEnabled&&s.notInImport&&s.notInImport.length>0?`\n            <div class="wizard-not-in-import-info">\n              <i class="fas fa-info-circle"></i>\n              <div>\n                <strong>${s.notInImport.length} eksisterende kunder finnes ikke i importfilen</strong>\n                <p>Disse kundene vil <strong>IKKE</strong> bli slettet. De vises kun for informasjon.</p>\n                <details>\n                  <summary>Vis kunder</summary>\n                  <ul class="not-in-import-list">\n                    ${s.notInImport.slice(0,10).map(e=>`\n                      <li>${escapeHtml(e.navn)} - ${escapeHtml(e.adresse)}</li>\n                    `).join("")}\n                    ${s.notInImport.length>10?`<li>...og ${s.notInImport.length-10} flere</li>`:""}\n                  </ul>\n                </details>\n              </div>\n            </div>\n          `:""}\n        </div>\n      `:""}\n\n      ${i}\n\n      \x3c!-- Preview table with selection --\x3e\n      <div class="wizard-preview-table-wrapper">\n        <div class="wizard-preview-header">\n          <h4><i class="fas fa-table"></i> Forhåndsvisning (${t.length} rader)</h4>\n          <div class="wizard-preview-controls">\n            <label class="wizard-toggle-label">\n              <input type="checkbox" ${v?"checked":""}\n                onchange="wizardToggleBeforeAfter(this.checked)">\n              <span>Vis transformasjoner</span>\n            </label>\n            <div class="wizard-selection-actions">\n              <button class="wizard-btn wizard-btn-small" onclick="wizardSelectAllRows()">\n                <i class="fas fa-check-square"></i> Velg alle\n              </button>\n              <button class="wizard-btn wizard-btn-small wizard-btn-secondary" onclick="wizardDeselectAllRows()">\n                <i class="fas fa-square"></i> Velg ingen\n              </button>\n              <span class="wizard-selection-count" id="wizardSelectionCount">\n                ${getSelectedRowCount()} av ${n.validRows||0} valgt\n              </span>\n            </div>\n          </div>\n        </div>\n        <p class="wizard-edit-hint"><i class="fas fa-info-circle"></i> Dobbeltklikk på en celle for å redigere</p>\n        <table class="wizard-preview-table wizard-preview-table-editable">\n          <thead>\n            <tr>\n              <th class="col-checkbox">\n                <input type="checkbox" id="wizardSelectAllCheckbox" onchange="wizardToggleAllRows(this.checked)" ${areAllRowsSelected(f)?"checked":""}>\n              </th>\n              <th class="col-rownum">#</th>\n              ${u.map(e=>`<th>${escapeHtml(e)}</th>`).join("")}\n              <th class="col-status">Status</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${f.map((e,t)=>{const n=50*g+t,a=wizardImportState.selectedRows.has(n),s=wizardImportState.editedRows[n]||{};return`\n              <tr class="${a?e.hasError?"row-error":e.hasWarning?"row-warning":"row-valid":"row-excluded"}" data-row-index="${n}">\n                <td class="col-checkbox">\n                  <input type="checkbox" ${a?"checked":""} onchange="wizardToggleRow(${n}, this.checked)">\n                </td>\n                <td class="col-rownum">${n+1}</td>\n                ${u.map(t=>{const a=e[t]||"",o=s[t],r=void 0!==o?o:a,i=void 0!==o&&o!==a,l=e.fieldErrors&&e.fieldErrors[t],d=y[t],c=e._rawValues?String(e._rawValues[d]||e._rawValues[t]||""):"",u=e._mappedValues?String(e._mappedValues[t]||""):"",m=v&&c&&u&&c!==u,p=m?`Fra fil: ${String(c)}`:l?escapeHtml(l):i?"Redigert (original: "+escapeHtml(a)+")":"Dobbeltklikk for å redigere";return`\n                  <td class="import-cell-editable ${i?"cell-edited":""} ${l?"cell-error":""} ${m?"cell-transformed":""}"\n                      data-row="${n}"\n                      data-field="${t}"\n                      data-original="${escapeHtml(a)}"\n                      ondblclick="wizardStartCellEdit(${n}, '${t}')"\n                      title="${escapeHtml(p)}">\n                    ${m?`<span class="cell-before">${escapeHtml(c)}</span> <i class="fas fa-arrow-right cell-arrow"></i> <span class="cell-after">${escapeHtml(u)}</span>`:escapeHtml(r||"-")}\n                  </td>\n                `}).join("")}\n                <td class="col-status">\n                  ${a?e.hasError?`<span class="status-error" title="${escapeHtml(e.errorMessage||"Feil")}"><i class="fas fa-times-circle"></i></span>`:e.hasWarning?`<span class="status-warning" title="${escapeHtml(e.warningMessage||"Advarsel")}"><i class="fas fa-exclamation-triangle"></i></span>`:'<span class="status-ok"><i class="fas fa-check-circle"></i></span>':'<span class="status-excluded" title="Ikke valgt for import"><i class="fas fa-minus-circle"></i></span>'}\n                </td>\n              </tr>\n            `}).join("")}\n          </tbody>\n        </table>\n      </div>\n\n      ${p>1?`\n        <div class="wizard-preview-pagination">\n          <button class="wizard-btn wizard-btn-small wizard-btn-secondary"\n            onclick="wizardPreviewTablePage(${g-1})" ${0===g?"disabled":""}>\n            <i class="fas fa-chevron-left"></i> Forrige\n          </button>\n          <span>Side ${g+1} av ${p}</span>\n          <button class="wizard-btn wizard-btn-small wizard-btn-secondary"\n            onclick="wizardPreviewTablePage(${g+1})" ${g>=p-1?"disabled":""}>\n            Neste <i class="fas fa-chevron-right"></i>\n          </button>\n        </div>\n      `:""}\n\n      ${n.errors>0?`\n        <div class="wizard-preview-warning">\n          <i class="fas fa-info-circle"></i>\n          <p>${n.errors} rad(er) har feil og vil ikke bli importert. Du kan redigere eller fjerne dem fra utvalget.</p>\n        </div>\n      `:""}\n\n      ${renderErrorGrouping(t)}\n\n      ${e.qualityReport?renderQualityReport(e.qualityReport):""}\n    </div>\n\n    <div class="wizard-footer">\n      <button class="wizard-btn wizard-btn-secondary" onclick="wizardImportBack()">\n        <i class="fas fa-arrow-left"></i> Tilbake\n      </button>\n      <div class="wizard-footer-right">\n        ${wizardImportState.batchId?'\n          <button class="wizard-btn wizard-btn-small wizard-btn-secondary" onclick="wizardDownloadErrorReport()" title="Last ned feilrapport som CSV">\n            <i class="fas fa-download"></i> Feilrapport\n          </button>\n        ':""}\n        <button class="wizard-btn wizard-btn-primary" onclick="wizardStartImport()" ${0===getSelectedValidRowCount()?"disabled":""}>\n          <i class="fas fa-file-import"></i> Importer ${getSelectedValidRowCount()} kunder\n        </button>\n      </div>\n    </div>\n  `}function renderWizardImportResults(){const e=wizardImportState.importResults;if(!e)return renderWizardImportPreview();const t=e.success&&e.importedCount>0;return`\n    <div class="wizard-import-results">\n      <div class="wizard-results-icon ${t?"success":"partial"}">\n        <i class="fas ${t?"fa-check-circle":"fa-exclamation-circle"}"></i>\n      </div>\n\n      <h2>${t?"Import fullført!":"Import delvis fullført"}</h2>\n\n      <div class="wizard-results-stats">\n        ${e.createdCount>0?`\n          <div class="result-stat success">\n            <i class="fas fa-plus"></i>\n            <span class="stat-value">${e.createdCount}</span>\n            <span class="stat-label">Nye kunder opprettet</span>\n          </div>\n        `:""}\n        ${e.updatedCount>0?`\n          <div class="result-stat info">\n            <i class="fas fa-sync-alt"></i>\n            <span class="stat-value">${e.updatedCount}</span>\n            <span class="stat-label">Eksisterende oppdatert</span>\n          </div>\n        `:""}\n        ${e.createdCount||e.updatedCount?"":`\n          <div class="result-stat success">\n            <i class="fas fa-check"></i>\n            <span class="stat-value">${e.importedCount||0}</span>\n            <span class="stat-label">Kunder importert</span>\n          </div>\n        `}\n        ${e.skippedCount>0?`\n          <div class="result-stat warning">\n            <i class="fas fa-forward"></i>\n            <span class="stat-value">${e.skippedCount}</span>\n            <span class="stat-label">Hoppet over</span>\n          </div>\n        `:""}\n        ${e.errorCount>0?`\n          <div class="result-stat error">\n            <i class="fas fa-times"></i>\n            <span class="stat-value">${e.errorCount}</span>\n            <span class="stat-label">Feilet</span>\n          </div>\n        `:""}\n      </div>\n\n      ${e.importedCount>0||e.createdCount>0||e.updatedCount>0?`\n        <p class="wizard-results-message">\n          Kundene er nå tilgjengelige i systemet. Du kan se dem på kartet etter at oppsettet er fullført.\n          ${e.durationMs?`<br><small>Importert på ${(e.durationMs/1e3).toFixed(1)} sekunder.</small>`:""}\n        </p>\n      `:""}\n\n      ${e.errors&&e.errors.length>0?`\n        <div class="wizard-results-errors">\n          <h4><i class="fas fa-exclamation-triangle"></i> Feil under import</h4>\n          <ul>\n            ${e.errors.slice(0,5).map(e=>`\n              <li>${escapeHtml(e.rowNumber||e.row?`Rad ${e.rowNumber||e.row}: `:"")}${escapeHtml(e.error||e.message||"Ukjent feil")}</li>\n            `).join("")}\n            ${e.errors.length>5?`<li>...og ${e.errors.length-5} flere feil</li>`:""}\n          </ul>\n        </div>\n      `:""}\n    </div>\n\n    <div class="wizard-footer wizard-footer-center">\n      ${e.batchId?'\n        <button class="wizard-btn wizard-btn-secondary" onclick="wizardRollbackImport()" title="Angre hele importen">\n          <i class="fas fa-undo"></i> Angre import\n        </button>\n      ':""}\n      ${e.errorCount>0?`\n        <button class="wizard-btn wizard-btn-secondary" onclick="wizardReimportFailed()" title="Prøv å importere feilede rader på nytt">\n          <i class="fas fa-redo"></i> Reimporter feilede (${e.errorCount})\n        </button>\n      `:""}\n      ${e.batchId?'\n        <button class="wizard-btn wizard-btn-small wizard-btn-secondary" onclick="wizardDownloadErrorReport()" title="Last ned feilrapport">\n          <i class="fas fa-download"></i> Feilrapport\n        </button>\n      ':""}\n      ${standaloneImportMode?'\n        <button class="wizard-btn wizard-btn-primary" onclick="closeImportModal()">\n          <i class="fas fa-check"></i> Ferdig\n        </button>\n      ':'\n        <button class="wizard-btn wizard-btn-primary" onclick="wizardImportComplete()">\n          Fortsett til neste steg <i class="fas fa-arrow-right"></i>\n        </button>\n      '}\n    </div>\n  `}function initializeRowSelection(){const e=wizardImportState.previewData;e&&e.preview&&(wizardImportState.selectedRows=new Set,e.preview.forEach((e,t)=>{e.hasError||wizardImportState.selectedRows.add(t)}))}function getSelectedRowCount(){return wizardImportState.selectedRows.size}function getSelectedValidRowCount(){const e=wizardImportState.previewData;if(!e||!e.preview)return 0;let t=0;return wizardImportState.selectedRows.forEach(n=>{e.preview[n]&&!e.preview[n].hasError&&t++}),t}function areAllRowsSelected(e,t=0){if(!e||0===e.length)return!1;for(let n=0;n<e.length;n++){const a=void 0!==e[n]._originalIndex?e[n]._originalIndex:t+n;if(!e[n].hasError&&!wizardImportState.selectedRows.has(a))return!1}return!0}function wizardToggleRow(e,t){t?wizardImportState.selectedRows.add(e):wizardImportState.selectedRows.delete(e),updateSelectionDisplay()}function wizardToggleAllRows(e){const t=wizardImportState.previewData;t&&t.preview&&(e?t.preview.forEach((e,t)=>{e.hasError||wizardImportState.selectedRows.add(t)}):wizardImportState.selectedRows.clear(),updateWizardImportContent())}function wizardSelectAllRows(){wizardToggleAllRows(!0)}function wizardDeselectAllRows(){wizardToggleAllRows(!1)}function updateSelectionDisplay(){const e=document.getElementById("wizardSelectionCount"),t=wizardImportState.previewData;e&&t&&t.stats&&(e.textContent=`${getSelectedRowCount()} av ${t.stats.validRows||0} valgt`);const n=document.getElementById("wizardSelectAllCheckbox");n&&t&&t.preview&&(n.checked=areAllRowsSelected(t.preview.slice(0,10)));const a=document.querySelector(".wizard-footer .wizard-btn-primary");if(a){const e=getSelectedValidRowCount();a.disabled=0===e,a.innerHTML=`<i class="fas fa-file-import"></i> Importer ${e} kunder`}document.querySelectorAll(".wizard-preview-table tbody tr").forEach(e=>{const t=parseInt(e.dataset.rowIndex),n=wizardImportState.selectedRows.has(t),a=e.querySelector('input[type="checkbox"]');a&&(a.checked=n),e.classList.toggle("row-excluded",!n)})}function wizardStartCellEdit(e,t){const n=document.querySelector(`td[data-row="${e}"][data-field="${t}"]`);if(!n)return;const a=n.dataset.original||"",s=wizardImportState.editedRows[e]?.[t]??a,o=document.createElement("input");o.type="text",o.className="cell-edit-input",o.value=s,n.innerHTML="",n.appendChild(o),n.classList.add("cell-editing"),o.focus(),o.select(),o.addEventListener("blur",()=>{wizardSaveCellEdit(e,t,o.value,a)}),o.addEventListener("keydown",n=>{"Enter"===n.key?(n.preventDefault(),o.blur()):"Escape"===n.key?(n.preventDefault(),wizardCancelCellEdit(e,t,a)):"Tab"===n.key&&o.blur()}),wizardImportState.editingCell={row:e,field:t}}function wizardSaveCellEdit(e,t,n,a){const s=document.querySelector(`td[data-row="${e}"][data-field="${t}"]`);if(!s)return;n!==a?(wizardImportState.editedRows[e]||(wizardImportState.editedRows[e]={}),wizardImportState.editedRows[e][t]=n):wizardImportState.editedRows[e]&&(delete wizardImportState.editedRows[e][t],0===Object.keys(wizardImportState.editedRows[e]).length&&delete wizardImportState.editedRows[e]);const o=n!==a;s.innerHTML=escapeHtml(n||"-"),s.classList.remove("cell-editing"),s.classList.toggle("cell-edited",o),s.title=o?`Redigert (original: ${a})`:"Dobbeltklikk for å redigere",wizardImportState.editingCell=null}function wizardCancelCellEdit(e,t,n){const a=document.querySelector(`td[data-row="${e}"][data-field="${t}"]`);if(!a)return;const s=wizardImportState.editedRows[e]?.[t]??n,o=s!==n;a.innerHTML=escapeHtml(s||"-"),a.classList.remove("cell-editing"),a.classList.toggle("cell-edited",o),wizardImportState.editingCell=null}function updateWizardMapping(e,t){""===t?delete wizardImportState.columnMapping[e]:wizardImportState.columnMapping[e]=parseInt(t,10)}function updateWizardCategoryMapping(e,t){""===t||"__skip__"===t?delete wizardImportState.categoryMapping[e]:wizardImportState.categoryMapping[e]="__new__"===t?{createNew:!0,name:e}:t}function validateWizardMapping(){const e=wizardImportState.requiredMappings,t=[];return e.navn&&""!==e.navn&&"-- Velg kolonne --"!==e.navn||t.push("Kundenavn er påkrevd - velg kolonne for navn"),e.adresse&&""!==e.adresse&&"-- Velg kolonne --"!==e.adresse||t.push("Adresse er påkrevd - velg kolonne for adresse"),t}function wizardImportBack(){wizardImportState.currentImportStep>1&&(wizardImportState.currentImportStep--,wizardImportState.error=null,updateWizardImportContent())}async function wizardImportNext(){const e=wizardImportState.currentImportStep;if(3===e){const e=validateWizardMapping();if(e.length>0)return void showMessage(e.join(". "),"error");await wizardFetchPreview()}else e<5&&(wizardImportState.currentImportStep++,updateWizardImportContent())}function skipWizardImport(){resetWizardImportState(),nextWizardStep()}function wizardImportComplete(){resetWizardImportState(),nextWizardStep()}function wizardImportRetry(){wizardImportState.error=null,wizardImportState.isLoading=!1,wizardImportState.currentImportStep>1&&(wizardImportState.currentImportStep=1),updateWizardImportContent()}function updateWizardImportContent(){const e=document.getElementById("wizardImportContent");e&&(e.innerHTML=renderWizardImportSubStep(wizardImportState.currentImportStep),attachWizardImportListeners());const t=document.querySelectorAll(".import-step-indicator"),n=document.querySelectorAll(".import-step-connector");t.forEach((e,t)=>{const n=t+1;e.classList.toggle("active",n<=wizardImportState.currentImportStep)}),n.forEach((e,t)=>{const n=t+2;e.classList.toggle("active",n<=wizardImportState.currentImportStep)})}function attachWizardImportListeners(){const e=document.getElementById("wizardImportDropzone"),t=document.getElementById("wizardImportFileInput");e&&t&&(e.addEventListener("click",()=>t.click()),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click())}),e.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),e.classList.add("dragover")}),e.addEventListener("dragleave",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("dragover")}),e.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),e.classList.remove("dragover");const n=t.dataTransfer.files;n.length>0&&wizardHandleFileSelect(n[0])}),t.addEventListener("change",e=>{e.target.files.length>0&&wizardHandleFileSelect(e.target.files[0])}))}async function wizardHandleFileSelect(e){const t=e.name.toLowerCase().substring(e.name.lastIndexOf("."));if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv","application/csv"].includes(e.type)&&![".xlsx",".xls",".csv"].includes(t))return void showMessage("Ugyldig filtype. Bruk .xlsx, .xls eller .csv","error");if(e.size>10485760)return void showMessage("Filen er for stor. Maks størrelse er 10MB","error");let n,a;wizardImportState.isLoading=!0,wizardImportState.loadingPhase="uploading",updateWizardImportContent();try{const t=new FormData;t.append("file",e),n=setTimeout(()=>{wizardImportState.isLoading&&(wizardImportState.loadingPhase="parsing",updateWizardImportContent())},500),a=setTimeout(()=>{wizardImportState.isLoading&&(wizardImportState.loadingPhase="ai-mapping",updateWizardImportContent())},1200);const s={},o=getCsrfToken();o&&(s["X-CSRF-Token"]=o);const r=await fetch("/api/import/upload",{method:"POST",headers:s,credentials:"include",body:t}),i=await r.json();if(!r.ok||!i.success){const e=i.error?.message||("string"==typeof i.error?i.error:null)||"Kunne ikke behandle filen";throw new Error(e)}if(wizardImportState.batchId=i.data.batchId,wizardImportState.previewData=i.data,wizardImportState.originalPreview=i.data.originalPreview,wizardImportState.cleanedPreview=i.data.cleanedPreview||i.data.originalPreview,wizardImportState.cleaningReport=i.data.cleaningReport||null,i.data.cleaningReport&&i.data.cleaningReport.rules){const e={};i.data.cleaningReport.rules.forEach(t=>{e[t.ruleId]=t.enabled}),wizardImportState.enabledCleaningRules=e}const l=i.data.suggestedMapping||{},d=i.data.headers||[];let c=null,u=null;for(const[e,t]of Object.entries(l))"navn"===t&&(c=e),"adresse"===t&&(u=e);wizardImportState.requiredMappings={navn:c||d[0]||null,adresse:u||d[1]||null},console.log("[DEBUG] Required mappings initialized:",wizardImportState.requiredMappings);const m=l;wizardImportState.columnMapping=convertBackendToFrontendMapping(m,d),wizardImportState.validCategories=i.data.validCategories||[],wizardImportState.isLoading=!1,clearTimeout(n),clearTimeout(a),i.data.categoryMatches&&i.data.categoryMatches.forEach(e=>{e.suggested&&(wizardImportState.categoryMapping[e.original]=e.suggested.id)}),wizardImportState.currentImportStep=2,updateWizardImportContent()}catch(e){console.error("Wizard import error:",e),wizardImportState.isLoading=!1,clearTimeout(n),clearTimeout(a),wizardImportState.error=e.message||"En feil oppstod under behandling av filen",updateWizardImportContent()}}async function wizardFetchPreview(){const e=wizardImportState.previewData;if(!e||!e.preview)return wizardImportState.error="Ingen data å vise",void updateWizardImportContent();const{navn:t,adresse:n}=wizardImportState.requiredMappings;if(!t||!n)return void showMessage("Du må velge kolonner for navn og adresse","warning");const a=e.headers||[],s={};for(const[e,t]of Object.entries(wizardImportState.columnMapping))void 0!==t&&a[t]&&(s[e]=a[t]);if(s.navn=t,s.adresse=n,wizardImportState.fieldToHeaderMapping={...s},wizardImportState.batchId)try{wizardImportState.isLoading=!0,wizardImportState.loadingPhase="validating",updateWizardImportContent();const t=getCsrfToken(),n={"Content-Type":"application/json"};t&&(n["X-CSRF-Token"]=t);const a=[];for(const[e,t]of Object.entries(s))a.push({sourceColumn:t,targetField:e,targetFieldType:IMPORT_FIELD_TYPE_MAP[e]||"string",required:"navn"===e||"adresse"===e});const o={version:"1.0",mappings:a,options:{skipHeaderRows:1,skipEmptyRows:!0,trimWhitespace:!0,duplicateDetection:"name_address",duplicateAction:"skip",stopOnFirstError:!1,maxErrors:0,dateFormat:"DD.MM.YYYY",fallbackDateFormats:["YYYY-MM-DD","DD/MM/YYYY","MM/DD/YYYY"],autoCreateCategories:!1}},r=await fetch(`/api/import/batches/${wizardImportState.batchId}/mapping`,{method:"POST",headers:n,credentials:"include",body:JSON.stringify({mappingConfig:o})}),i=await r.json();if(!r.ok||!i.success)throw new Error(i.error||"Mapping feilet");const l=await fetch(`/api/import/batches/${wizardImportState.batchId}/validate`,{method:"POST",headers:n,credentials:"include"}),d=await l.json();if(!l.ok||!d.success)throw new Error(d.error||"Validering feilet");const c=await fetch(`/api/import/batches/${wizardImportState.batchId}/preview?showErrors=true&limit=200`,{method:"GET",headers:n,credentials:"include"}),u=await c.json();if(!c.ok||!u.success)throw new Error(u.error||"Forhåndsvisning feilet");const m=u.data,p=d.data,g=m.previewRows.map((e,t)=>{const n="invalid"===e.validationStatus,a="warning"===e.validationStatus,s=(e.errors||[]).map(e=>e.message).join("; "),o=e.values||{},r=e.mappedValues||o;return{...o,_rowIndex:t,_stagingRowId:e.stagingRowId||e.rowNumber,_selected:!n,_rawValues:o,_mappedValues:r,hasError:n,hasWarning:a,errorMessage:s,validationErrors:e.errors||[],...r}});return wizardImportState.previewData={...e,preview:g,stats:{totalRows:m.totalRows,validRows:p.validCount,warnings:p.warningCount,errors:p.errorCount}},wizardImportState.isLoading=!1,wizardImportState.currentImportStep=4,initializeRowSelection(),void updateWizardImportContent()}catch(e){console.error("Staging API preview error:",e),wizardImportState.isLoading=!1}let o=0,r=0;const i=e.preview.map((e,a)=>{const i={...e},l=String(e[t]||"").trim(),d=String(e[n]||"").trim();let c=!1,u="";l?d||(c=!0,u="Mangler adresse"):(c=!0,u="Mangler navn"),c?r++:o++;const m={};for(const[t,n]of Object.entries(s))m[t]=String(e[n]||"").trim();return{...i,_rowIndex:a,_selected:!c,_rawValues:{...e},_mappedValues:{...m},hasError:c,errorMessage:u,...m}});wizardImportState.previewData={...e,preview:i,stats:{totalRows:e.totalRows,validRows:o,warnings:0,errors:r}},wizardImportState.isLoading=!1,wizardImportState.currentImportStep=4,initializeRowSelection(),updateWizardImportContent()}async function wizardStartImport(e=!1,t=!1){const{navn:n,adresse:a}=wizardImportState.requiredMappings;if(!n||""===n||"-- Velg kolonne --"===n)return void showMessage("Du må velge hvilken kolonne som inneholder kundenavn","error");if(!a||""===a||"-- Velg kolonne --"===a)return void showMessage("Du må velge hvilken kolonne som inneholder adresse","error");if(n===a)return void showMessage("Kundenavn og adresse kan ikke bruke samme kolonne. Velg forskjellige kolonner.","error");const s=wizardImportState.previewData,o=(s?.preview||[]).filter((e,t)=>wizardImportState.selectedRows.has(t)).map(e=>{const t=void 0!==e._rowIndex?e._rowIndex:0,n=wizardImportState.editedRows[t]||{};return{...e,...n}}),r={navn:n,adresse:a},i=s?.headers||[];for(const[e,t]of Object.entries(wizardImportState.columnMapping))void 0!==t&&i[t]&&(r[e]=i[t]);console.log("Starting import with:",{selectedCount:o.length,columnMapping:r}),wizardImportState.isLoading=!0,wizardImportState.loadingPhase="importing",wizardImportState.loadingProgress=0,wizardImportState.importedSoFar=0,wizardImportState.totalToImport=o.length,updateWizardImportContent();try{const e={"Content-Type":"application/json"},t=getCsrfToken();if(t&&(e["X-CSRF-Token"]=t),wizardImportState.batchId){const t=wizardImportState.batchId;wizardImportState.loadingPhase="mapping",updateWizardImportContent();const n=wizardImportState.previewData?.headers||[],a=[];for(const[e,t]of Object.entries(wizardImportState.requiredMappings))if(t){const s=n.indexOf(t);a.push({sourceColumn:t,sourceColumnIndex:s>=0?s:void 0,targetField:e,targetFieldType:IMPORT_FIELD_TYPE_MAP[e]||"string",required:!0,humanConfirmed:!0})}for(const[e,t]of Object.entries(wizardImportState.columnMapping)){if("navn"===e||"adresse"===e)continue;if(void 0===t||""===t)continue;const s=n[t];s&&a.push({sourceColumn:s,sourceColumnIndex:parseInt(t,10),targetField:e,targetFieldType:IMPORT_FIELD_TYPE_MAP[e]||"string",required:!1,humanConfirmed:!0})}const s={version:"1.0",mappings:a,options:{skipHeaderRows:1,skipEmptyRows:!0,trimWhitespace:!0,duplicateDetection:"name_address",duplicateAction:"skip",stopOnFirstError:!1,maxErrors:0,dateFormat:"DD.MM.YYYY",fallbackDateFormats:["YYYY-MM-DD","DD/MM/YYYY","MM/DD/YYYY"],autoCreateCategories:!1}};console.log("[Import] Applying mapping config:",s);const o=await fetch(`/api/import/batches/${t}/mapping`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({mappingConfig:s})}),r=await o.json();if(!o.ok||!r.success){const e=r.error?.message||r.message||"Mapping feilet";throw new Error(e)}console.log("[Import] Mapping applied:",r.data),wizardImportState.loadingPhase="validating",wizardImportState.loadingProgress=30,updateWizardImportContent();const i=await fetch(`/api/import/batches/${t}/validate`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({})}),l=await i.json();if(!i.ok||!l.success){const e=l.error?.message||l.message||"Validering feilet";throw new Error(e)}console.log("[Import] Validation result:",l.data),wizardImportState.loadingPhase="importing",wizardImportState.loadingProgress=60,updateWizardImportContent();const d=wizardImportState.previewData?.preview||[],c=[];d.forEach((e,t)=>{wizardImportState.selectedRows.has(t)||e._stagingRowId&&c.push(e._stagingRowId)});const u={};for(const[e,t]of Object.entries(wizardImportState.editedRows)){const n=d[parseInt(e)];n&&n._stagingRowId&&(u[n._stagingRowId]=t)}const m=await fetch(`/api/import/batches/${t}/commit`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({dryRun:!1,excludedRowIds:c,rowEdits:u})}),p=await m.json();if(!m.ok||!p.success){const e="string"==typeof p.error?p.error:p.error?.message||p.message||"Import feilet";throw new Error(e)}wizardImportState.importResults={success:!0,importedCount:p.data.created+p.data.updated,createdCount:p.data.created,updatedCount:p.data.updated,skippedCount:p.data.skipped,errorCount:p.data.failed,errors:p.data.errors||[],batchId:wizardImportState.batchId,durationMs:p.data.durationMs},wizardImportState.isLoading=!1,wizardImportState.currentImportStep=5,updateWizardImportContent(),(p.data.created>0||p.data.updated>0)&&refreshCustomerData()}else{const t=await fetch("/api/kunder/import/execute",{method:"POST",headers:e,credentials:"include",body:JSON.stringify({rows:o,columnMapping:r})}),n=await t.json();if(!t.ok||!n.success){const e="string"==typeof n.error?n.error:n.error?.message||n.message||"Import feilet";throw new Error(e)}wizardImportState.importResults={success:!0,importedCount:n.data.created,createdCount:n.data.created,updatedCount:0,skippedCount:0,errorCount:n.data.failed,errors:n.data.errors||[]},wizardImportState.isLoading=!1,wizardImportState.currentImportStep=5,updateWizardImportContent(),n.data.created>0&&refreshCustomerData()}}catch(e){console.error("Wizard import execute error:",e),wizardImportState.isLoading=!1;let t="En feil oppstod under import";"string"==typeof e?t=e:e&&"string"==typeof e.message?t=e.message:e&&"string"==typeof e.error&&(t=e.error),wizardImportState.error=t,updateWizardImportContent()}}async function wizardRollbackImport(){const e=wizardImportState.importResults;if(!e||!e.batchId)return void showMessage("Ingen import å angre","error");if(await showConfirm("Er du sikker på at du vil angre hele importen? Alle opprettede kunder vil bli slettet.","Angre import"))try{const t={"Content-Type":"application/json"},n=getCsrfToken();n&&(t["X-CSRF-Token"]=n);const a=await fetch(`/api/import/batches/${e.batchId}/rollback`,{method:"POST",headers:t,credentials:"include",body:JSON.stringify({reason:"Bruker angret importen"})}),s=await a.json();if(!a.ok||!s.success)throw new Error(s.error?.message||("string"==typeof s.error?s.error:null)||"Kunne ikke angre importen");showMessage(`Import angret: ${s.data.recordsDeleted} kunder slettet`,"success"),resetWizardImportState(),updateWizardImportContent(),refreshCustomerData()}catch(e){console.error("Rollback error:",e),showMessage(e.message||"Kunne ikke angre importen","error")}}async function refreshCustomerData(){try{"function"==typeof loadCustomers&&await loadCustomers()}catch(e){console.error("Error refreshing customer data:",e)}}function renderErrorGrouping(e){if(!e||!Array.isArray(e))return"";const t={};for(const n of e)if(n.fieldErrors)for(const[e,a]of Object.entries(n.fieldErrors)){const s=`${e}:${a}`;t[s]||(t[s]={field:e,message:a,count:0,rows:[]}),t[s].count++,t[s].rows.push(n)}const n=Object.values(t).sort((e,t)=>t.count-e.count);return 0===n.length?"":`\n    <div class="wizard-error-groups">\n      <h4><i class="fas fa-layer-group"></i> Feilsammendrag</h4>\n      <div class="error-group-list">\n        ${n.slice(0,8).map(e=>`\n          <div class="error-group-item">\n            <div class="error-group-info">\n              <span class="error-group-field">${escapeHtml(e.field)}</span>\n              <span class="error-group-message">${escapeHtml(e.message)}</span>\n              <span class="error-group-count">${e.count} rader</span>\n            </div>\n            ${"epost"===e.field&&e.message.includes("skrivefeil")?`\n              <button class="wizard-btn wizard-btn-small" onclick="wizardFixAllSimilar('${escapeHtml(e.field)}', '${escapeHtml(e.message)}')">\n                <i class="fas fa-magic"></i> Fiks alle\n              </button>\n            `:`\n              <button class="wizard-btn wizard-btn-small wizard-btn-secondary" onclick="wizardDeselectErrorRows('${escapeHtml(e.field)}', '${escapeHtml(e.message)}')">\n                <i class="fas fa-minus-circle"></i> Fjern fra import\n              </button>\n            `}\n          </div>\n        `).join("")}\n      </div>\n    </div>\n  `}function renderQualityReport(e){if(!e)return"";return`\n    <div class="wizard-quality-report">\n      <h4><i class="fas fa-chart-bar"></i> Kvalitetsrapport</h4>\n      <div class="quality-score-bar">\n        <div class="quality-score-fill ${e.overallScore>=80?"success":e.overallScore>=60?"warning":"error"}" style="width: ${e.overallScore}%"></div>\n        <span class="quality-score-label">${e.overallScore}%</span>\n      </div>\n      ${e.suggestions&&e.suggestions.length>0?`\n        <ul class="quality-suggestions">\n          ${e.suggestions.map(e=>`<li><i class="fas fa-lightbulb"></i> ${escapeHtml(e)}</li>`).join("")}\n        </ul>\n      `:""}\n    </div>\n  `}function wizardFixAllSimilar(e,t){const n=wizardImportState.previewData?.preview;if(!n)return;let a=0;for(let s=0;s<n.length;s++){const o=n[s];o.fieldErrors&&o.fieldErrors[e]===t&&o.suggestion&&o.suggestion[e]&&(wizardImportState.editedRows[s]||(wizardImportState.editedRows[s]={}),wizardImportState.editedRows[s][e]=o.suggestion[e],a++)}a>0&&(showMessage(`${a} felt korrigert automatisk`,"success"),updateWizardImportContent())}function wizardDeselectErrorRows(e,t){const n=wizardImportState.previewData?.preview;if(!n)return;let a=0;for(let s=0;s<n.length;s++)n[s].fieldErrors&&n[s].fieldErrors[e]===t&&(wizardImportState.selectedRows.delete(s),a++);a>0&&(showMessage(`${a} rader fjernet fra import`,"info"),updateWizardImportContent())}async function wizardDownloadErrorReport(){const e=wizardImportState.batchId;if(e)try{const t=await fetch(`/api/import/batches/${e}/error-report`,{credentials:"include"});if(!t.ok)throw new Error("Kunne ikke laste ned feilrapport");const n=await t.blob(),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download=`feilrapport-batch-${e}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}catch(e){console.error("Download error:",e),showMessage(e.message||"Kunne ikke laste ned feilrapport","error")}else showMessage("Ingen batch tilgjengelig for feilrapport","error")}async function wizardReimportFailed(){const e=wizardImportState.importResults;e&&e.batchId?(showMessage("Setter opp reimport av feilede rader...","info"),wizardImportState.currentImportStep=4,wizardImportState.importResults=null,updateWizardImportContent()):showMessage("Ingen import å reimportere","error")}function attachStepListeners(e){switch(e){case"company":attachCompanyListeners();break;case"import":attachWizardImportListeners();break;case"map":attachMapListeners()}}window.wizardCleaningTablePage=wizardCleaningTablePage,window.handleUnmappedColumn=handleUnmappedColumn,window.wizardToggleRow=wizardToggleRow,window.wizardToggleAllRows=wizardToggleAllRows,window.wizardSelectAllRows=wizardSelectAllRows,window.wizardDeselectAllRows=wizardDeselectAllRows,window.wizardStartCellEdit=wizardStartCellEdit;let wizardRouteMap=null,wizardRouteMarker=null;function attachCompanyListeners(){setTimeout(()=>{if(document.getElementById("wizardRouteMap")&&!wizardRouteMap){const e=onboardingWizard.data.company,t=e.route_start_lat||59.9139,n=e.route_start_lng||10.7522;wizardRouteMap=L.map("wizardRouteMap").setView([t,n],10),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(wizardRouteMap),e.route_start_lat&&(wizardRouteMarker=L.marker([t,n]).addTo(wizardRouteMap)),wizardRouteMap.on("click",e=>{wizardRouteMarker&&wizardRouteMap.removeLayer(wizardRouteMarker),wizardRouteMarker=L.marker(e.latlng).addTo(wizardRouteMap),onboardingWizard.data.company.route_start_lat=e.latlng.lat,onboardingWizard.data.company.route_start_lng=e.latlng.lng,document.getElementById("routeCoordinates").innerHTML=`<span>Valgt: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}</span>`})}},100);const e=document.getElementById("companyPoststed");e&&e.addEventListener("input",e=>{onboardingWizard.data.company.poststed=e.target.value}),setupWizardAddressAutocomplete(),setupWizardPostnummerLookup()}let wizardAddressSuggestions=[],wizardSelectedIndex=-1;function setupWizardAddressAutocomplete(){const e=document.getElementById("companyAddress"),t=document.getElementById("wizardAddressSuggestions");if(!e||!t)return;const n=debounce(async e=>{if(e.length<3)return t.classList.remove("visible"),void(wizardAddressSuggestions=[]);wizardAddressSuggestions=await searchAddresses(e),wizardSelectedIndex=-1,renderWizardAddressSuggestions(wizardAddressSuggestions)},300);e.addEventListener("input",e=>{onboardingWizard.data.company.address=e.target.value,n(e.target.value)}),e.addEventListener("keydown",e=>{wizardAddressSuggestions.length&&("ArrowDown"===e.key?(e.preventDefault(),wizardSelectedIndex=Math.min(wizardSelectedIndex+1,wizardAddressSuggestions.length-1),updateWizardSuggestionSelection()):"ArrowUp"===e.key?(e.preventDefault(),wizardSelectedIndex=Math.max(wizardSelectedIndex-1,0),updateWizardSuggestionSelection()):"Enter"===e.key&&wizardSelectedIndex>=0?(e.preventDefault(),selectWizardAddressSuggestion(wizardAddressSuggestions[wizardSelectedIndex])):"Escape"===e.key&&(t.classList.remove("visible"),wizardAddressSuggestions=[]))}),document.addEventListener("click",n=>{e.contains(n.target)||t.contains(n.target)||t.classList.remove("visible")})}function renderWizardAddressSuggestions(e){const t=document.getElementById("wizardAddressSuggestions");if(t){if(!e||0===e.length)return t.innerHTML="",void t.classList.remove("visible");t.innerHTML=e.map((e,t)=>`\n    <div class="wizard-address-suggestion" data-index="${t}">\n      <i class="fas fa-map-marker-alt"></i>\n      <div class="wizard-address-text">\n        <div class="wizard-address-main">${escapeHtml(e.adresse)}</div>\n        <div class="wizard-address-detail">${escapeHtml(e.postnummer)} ${escapeHtml(e.poststed)}${e.kommune?`, ${escapeHtml(e.kommune)}`:""}</div>\n      </div>\n    </div>\n  `).join(""),t.classList.add("visible"),t.querySelectorAll(".wizard-address-suggestion").forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.index);selectWizardAddressSuggestion(wizardAddressSuggestions[t])})})}}function updateWizardSuggestionSelection(){document.querySelectorAll(".wizard-address-suggestion").forEach((e,t)=>{e.classList.toggle("selected",t===wizardSelectedIndex)})}function selectWizardAddressSuggestion(e){const t=document.getElementById("companyAddress"),n=document.getElementById("companyPostnummer"),a=document.getElementById("companyPoststed"),s=document.getElementById("wizardAddressSuggestions");t&&(t.value=e.adresse),n&&(n.value=e.postnummer),a&&(a.value=e.poststed,a.classList.add("auto-filled")),onboardingWizard.data.company.address=e.adresse,onboardingWizard.data.company.postnummer=e.postnummer,onboardingWizard.data.company.poststed=e.poststed,onboardingWizard.data.company.route_start_lat=e.lat,onboardingWizard.data.company.route_start_lng=e.lng,wizardRouteMap&&(wizardRouteMarker&&wizardRouteMap.removeLayer(wizardRouteMarker),wizardRouteMarker=L.marker([e.lat,e.lng]).addTo(wizardRouteMap),wizardRouteMap.setView([e.lat,e.lng],14));const o=document.getElementById("routeCoordinates");o&&(o.innerHTML=`<span>Valgt: ${e.lat.toFixed(5)}, ${e.lng.toFixed(5)}</span>`),updateWizardPostnummerStatus("valid"),s&&(s.classList.remove("visible"),wizardAddressSuggestions=[])}function setupWizardPostnummerLookup(){const e=document.getElementById("companyPostnummer"),t=document.getElementById("companyPoststed");e&&e.addEventListener("input",async e=>{const n=e.target.value;if(onboardingWizard.data.company.postnummer=n,4===n.length&&/^\d{4}$/.test(n)){updateWizardPostnummerStatus("loading");const e=await lookupPostnummer(n);e?(t&&(t.value=e,t.classList.add("auto-filled")),onboardingWizard.data.company.poststed=e,updateWizardPostnummerStatus("valid")):updateWizardPostnummerStatus("invalid")}else n.length<4&&updateWizardPostnummerStatus("")})}function updateWizardPostnummerStatus(e){const t=document.getElementById("wizardPostnummerStatus");if(t)switch(t.className="wizard-postnummer-status",e){case"valid":t.innerHTML='<i class="fas fa-check"></i>',t.classList.add("valid");break;case"invalid":t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("invalid");break;case"loading":t.innerHTML='<i class="fas fa-spinner fa-spin"></i>',t.classList.add("loading");break;default:t.innerHTML=""}}let wizardMainMap=null;function attachMapListeners(){setTimeout(()=>{if(document.getElementById("wizardMainMap")&&!wizardMainMap){const e=onboardingWizard.data.map,t=onboardingWizard.data.company,n=e.center_lat||t.route_start_lat||59.9139,a=e.center_lng||t.route_start_lng||10.7522,s=e.zoom||10;wizardMainMap=L.map("wizardMainMap").setView([n,a],s),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(wizardMainMap),wizardMainMap.on("moveend",()=>{const e=wizardMainMap.getCenter();onboardingWizard.data.map.center_lat=e.lat,onboardingWizard.data.map.center_lng=e.lng,onboardingWizard.data.map.zoom=wizardMainMap.getZoom(),document.getElementById("defaultZoom").value=wizardMainMap.getZoom(),document.getElementById("zoomValue").textContent=wizardMainMap.getZoom()})}},100);const e=document.getElementById("defaultZoom");e&&e.addEventListener("input",e=>{const t=parseInt(e.target.value);document.getElementById("zoomValue").textContent=t,onboardingWizard.data.map.zoom=t,wizardMainMap&&wizardMainMap.setZoom(t)})}async function useAddressAsRouteStart(){const e=onboardingWizard.data.company.address,t=onboardingWizard.data.company.postnummer,n=onboardingWizard.data.company.poststed;if(!e||!t||!n)return void showMessage("Fyll ut firmaadresse først","warning");const a=`${e}, ${t} ${n}, Norge`;try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}`),t=await e.json();if(t&&t.length>0){const e=parseFloat(t[0].lat),n=parseFloat(t[0].lon);onboardingWizard.data.company.route_start_lat=e,onboardingWizard.data.company.route_start_lng=n,wizardRouteMap&&(wizardRouteMarker&&wizardRouteMap.removeLayer(wizardRouteMarker),wizardRouteMarker=L.marker([e,n]).addTo(wizardRouteMap),wizardRouteMap.setView([e,n],14)),document.getElementById("routeCoordinates").innerHTML=`<span>Valgt: ${e.toFixed(5)}, ${n.toFixed(5)}</span>`}else showMessage("Kunne ikke finne adressen. Prøv å klikke på kartet manuelt.","warning")}catch(e){console.error("Geocoding error:",e),showMessage("Feil ved søk etter adresse","error")}}async function nextWizardStep(){try{console.log("nextWizardStep called, current step:",onboardingWizard.currentStep);const e=onboardingWizard.steps[onboardingWizard.currentStep].id;if(console.log("Current step ID:",e),"company"===e){const e=onboardingWizard.data.company;console.log("Saving company data:",e);const t=await updateOnboardingStep("company_info",{company_address:e.address,company_postnummer:e.postnummer,company_poststed:e.poststed,route_start_lat:e.route_start_lat,route_start_lng:e.route_start_lng});console.log("Company step save result:",t)}else if("map"===e){const e=onboardingWizard.data.map;console.log("Saving map data:",e);const t=await updateOnboardingStep("map_settings",{map_center_lat:e.center_lat,map_center_lng:e.center_lng,map_zoom:e.zoom});console.log("Map step save result:",t)}cleanupWizardMaps(),onboardingWizard.currentStep++,console.log("Moving to step:",onboardingWizard.currentStep),await renderWizardStep()}catch(e){console.error("Error in nextWizardStep:",e),showMessage("Det oppstod en feil. Prøv igjen.","error")}}async function prevWizardStep(){onboardingWizard.currentStep>0&&(cleanupWizardMaps(),onboardingWizard.currentStep--,await renderWizardStep())}function cleanupWizardMaps(){wizardRouteMap&&(wizardRouteMap.remove(),wizardRouteMap=null,wizardRouteMarker=null),wizardMainMap&&(wizardMainMap.remove(),wizardMainMap=null)}async function completeOnboardingWizard(){await updateOnboardingStep("completed",{}),cleanupWizardMaps();const e=onboardingWizard.overlay;e.classList.remove("visible"),setTimeout(()=>{e.remove(),onboardingWizard.overlay=null,showContextTips(),onboardingWizard.resolve&&onboardingWizard.resolve()},400)}async function handleSkipOnboarding(){if(await showConfirm("Er du sikker på at du vil hoppe over oppsettet? Du kan alltid endre innstillinger senere.","Hopp over oppsett")){await skipOnboarding(),cleanupWizardMaps();const e=onboardingWizard.overlay;e.classList.remove("visible"),setTimeout(()=>{e.remove(),onboardingWizard.overlay=null,onboardingWizard.resolve&&onboardingWizard.resolve()},400)}}function wizardPreviewTablePage(e){wizardImportState.previewTablePage=Math.max(0,e),updateWizardImportContent()}function wizardToggleBeforeAfter(e){wizardImportState.previewShowBeforeAfter=e,updateWizardImportContent()}function getFieldTypeName(e){return{text:"Tekst",select:"Rullegardin",number:"Tall",date:"Dato"}[e]||e}function renderAdminFields(){const e=document.getElementById("fieldsList"),t=document.getElementById("fieldsEmpty");if(e){if(0===organizationFields.length)return e.style.display="none",void(t&&(t.style.display="block"));e.style.display="flex",t&&(t.style.display="none"),e.innerHTML=organizationFields.map((e,t)=>`\n    <div class="sortable-item" data-id="${e.id}" data-index="${t}" draggable="true">\n      <div class="drag-handle">\n        <i class="fas fa-grip-vertical"></i>\n      </div>\n      <div class="item-info">\n        <span class="item-name">${escapeHtml(e.display_name)}</span>\n        <span class="item-meta">\n          ${escapeHtml(e.field_name)} | ${getFieldTypeName(e.field_type)}\n          ${e.is_filterable?'<span class="badge">Filter</span>':""}\n          ${e.is_required?'<span class="badge warning">Obligatorisk</span>':""}\n          ${e.is_visible?"":'<span class="badge muted">Skjult</span>'}\n        </span>\n      </div>\n      <div class="item-actions">\n        <button class="btn-icon" onclick="openFieldModal(${e.id})" title="Rediger">\n          <i class="fas fa-edit"></i>\n        </button>\n        <button class="btn-icon danger" onclick="confirmDeleteField(${e.id})" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </div>\n    </div>\n  `).join(""),initSortable(e,"fields")}}function openFieldModal(e=null){const t=document.getElementById("fieldModal"),n=document.getElementById("fieldModalTitle"),a=document.getElementById("deleteFieldBtn"),s=document.getElementById("fieldName");if(document.getElementById("fieldForm").reset(),document.getElementById("fieldId").value="",document.getElementById("fieldVisible").checked=!0,document.getElementById("fieldOptionsSection").style.display="none",document.getElementById("fieldOptionsList").innerHTML="",e){const t=organizationFields.find(t=>t.id===e);if(!t)return;n.textContent="Rediger felt",document.getElementById("fieldId").value=t.id,document.getElementById("fieldDisplayName").value=t.display_name,s.value=t.field_name,s.disabled=!0,document.getElementById("fieldType").value=t.field_type,document.getElementById("fieldFilterable").checked=1===t.is_filterable||!0===t.is_filterable,document.getElementById("fieldRequired").checked=1===t.is_required||!0===t.is_required,document.getElementById("fieldVisible").checked=1===t.is_visible||!0===t.is_visible,"select"===t.field_type&&(document.getElementById("fieldOptionsSection").style.display="block",renderFieldOptions(t.options||[])),a.style.display="inline-block"}else n.textContent="Nytt felt",s.disabled=!1,a.style.display="none";t.classList.remove("hidden")}function renderFieldOptions(e){document.getElementById("fieldOptionsList").innerHTML=e.map((e,t)=>`\n    <div class="option-item" data-index="${t}" data-id="${e.id||""}">\n      <input type="text" class="option-value" value="${escapeHtml(e.value||"")}" placeholder="Verdi">\n      <input type="text" class="option-display" value="${escapeHtml(e.display_name||"")}" placeholder="Visningsnavn">\n      <button type="button" class="btn-icon danger" onclick="removeFieldOption(this)" title="Fjern">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `).join("")}function addFieldOption(){const e=document.getElementById("fieldOptionsList"),t=`\n    <div class="option-item" data-index="${e.children.length}" data-id="">\n      <input type="text" class="option-value" placeholder="Verdi">\n      <input type="text" class="option-display" placeholder="Visningsnavn">\n      <button type="button" class="btn-icon danger" onclick="removeFieldOption(this)" title="Fjern">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `;e.insertAdjacentHTML("beforeend",t)}function removeFieldOption(e){const t=e.closest(".option-item");t&&t.remove()}async function saveField(e){e.preventDefault();const t=document.getElementById("fieldId").value,n={field_name:document.getElementById("fieldName").value,display_name:document.getElementById("fieldDisplayName").value,field_type:document.getElementById("fieldType").value,is_filterable:document.getElementById("fieldFilterable").checked?1:0,is_required:document.getElementById("fieldRequired").checked?1:0,is_visible:document.getElementById("fieldVisible").checked?1:0};try{const e=t?`/api/fields/${t}`:"/api/fields",a=t?"PUT":"POST",s=await apiFetch(e,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok){const e=await s.json();throw new Error(e.error||"Kunne ikke lagre felt")}const o=await s.json();"select"===n.field_type&&await saveFieldOptions(o.id||t),await loadOrganizationFields(),renderAdminFields(),document.getElementById("fieldModal").classList.add("hidden"),showToast("Felt lagret","success")}catch(e){showToast(e.message,"error")}}async function saveFieldOptions(e){const t=document.querySelectorAll("#fieldOptionsList .option-item"),n=organizationFields.find(t=>t.id===parseInt(e)),a=n?.options||[],s=[];t.forEach((e,t)=>{const n=e.querySelector(".option-value").value.trim(),a=e.querySelector(".option-display").value.trim(),o=e.dataset.id;n&&s.push({id:o?parseInt(o):null,value:n,display_name:a||n,sort_order:t})});for(const t of a){if(!s.some(e=>e.id===t.id))try{await apiFetch(`/api/fields/${e}/options/${t.id}`,{method:"DELETE"})}catch(e){Logger.warn("Could not delete option:",e)}}for(const t of s)if(!t.id)try{await apiFetch(`/api/fields/${e}/options`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}catch(e){Logger.warn("Could not add option:",e)}}async function confirmDeleteField(e){if(await showConfirm("Er du sikker på at du vil slette dette feltet? Data i kunderegistreringer vil bli beholdt, men ikke lenger vises.","Slette felt"))try{if(!(await apiFetch(`/api/fields/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette felt");await loadOrganizationFields(),renderAdminFields(),renderDynamicFieldFilters(),showToast("Felt slettet","success")}catch(e){showToast(e.message,"error")}}function openCategoryListModal(){renderCategoryListItems(),document.getElementById("categoryListModal").classList.remove("hidden")}function renderCategoryListItems(){const e=document.getElementById("categoryListItems");e&&(0!==organizationCategories.length?e.innerHTML=organizationCategories.map(e=>`\n    <div class="category-list-item">\n      <div class="category-list-info">\n        <i class="fas ${escapeHtml(e.icon||"fa-tag")}" style="color: ${escapeHtml(e.color||"#6B7280")}; margin-right: 8px;"></i>\n        <span>${escapeHtml(e.name)}</span>\n        <span class="category-list-meta">${e.default_interval_months||12} mnd</span>\n      </div>\n      <div class="category-list-actions">\n        <button class="btn-icon" onclick="document.getElementById('categoryListModal').classList.add('hidden'); openCategoryModal(${e.id});" title="Rediger">\n          <i class="fas fa-edit"></i>\n        </button>\n        <button class="btn-icon danger" onclick="confirmDeleteCategory(${e.id})" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </div>\n    </div>\n  `).join(""):e.innerHTML='<p style="text-align: center; color: var(--color-text-muted); padding: 16px 0;">Ingen kategorier enda.</p>')}function renderAdminCategories(){const e=document.getElementById("categoriesList"),t=document.getElementById("categoriesEmpty");if(e){if(0===organizationCategories.length)return e.style.display="none",void(t&&(t.style.display="block"));e.style.display="flex",t&&(t.style.display="none"),e.innerHTML=organizationCategories.map((e,t)=>`\n    <div class="sortable-item" data-id="${e.id}" data-index="${t}" draggable="true">\n      <div class="drag-handle">\n        <i class="fas fa-grip-vertical"></i>\n      </div>\n      <div class="item-info">\n        <span class="item-name">\n          <i class="fas ${escapeHtml(e.icon||"fa-tag")}" style="color: ${escapeHtml(e.color||"#6B7280")}; margin-right: 8px;"></i>\n          ${escapeHtml(e.name)}\n        </span>\n        <span class="item-meta">\n          ${escapeHtml(e.slug)} | ${e.default_interval_months||12} mnd intervall\n        </span>\n      </div>\n      <div class="item-actions">\n        <button class="btn-icon" onclick="openCategoryModal(${e.id})" title="Rediger">\n          <i class="fas fa-edit"></i>\n        </button>\n        <button class="btn-icon danger" onclick="confirmDeleteCategory(${e.id})" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </div>\n    </div>\n  `).join(""),initSortable(e,"categories")}}window.nextWizardStep=nextWizardStep,window.prevWizardStep=prevWizardStep,window.handleSkipOnboarding=handleSkipOnboarding,window.useAddressAsRouteStart=useAddressAsRouteStart,window.completeOnboardingWizard=completeOnboardingWizard,window.skipWizardImport=skipWizardImport,window.wizardImportBack=wizardImportBack,window.wizardImportNext=wizardImportNext,window.wizardStartImport=wizardStartImport,window.wizardRollbackImport=wizardRollbackImport,window.wizardReimportFailed=wizardReimportFailed,window.wizardDownloadErrorReport=wizardDownloadErrorReport,window.wizardFixAllSimilar=wizardFixAllSimilar,window.wizardDeselectErrorRows=wizardDeselectErrorRows,window.wizardImportComplete=wizardImportComplete,window.wizardImportRetry=wizardImportRetry,window.updateWizardMapping=updateWizardMapping,window.updateWizardCategoryMapping=updateWizardCategoryMapping,window.wizardPreviewTablePage=wizardPreviewTablePage,window.wizardToggleBeforeAfter=wizardToggleBeforeAfter;const CATEGORY_ICONS=["fa-wrench","fa-bolt","fa-fire","fa-fan","fa-faucet","fa-shield-alt","fa-thermometer-half","fa-building","fa-solar-panel","fa-tools","fa-hard-hat","fa-plug","fa-tractor","fa-home","fa-cog","fa-check-circle"];function renderCategoryIconPicker(e){const t=document.getElementById("categoryIconPicker");t&&(t.innerHTML=CATEGORY_ICONS.map(t=>`\n    <button type="button" class="icon-btn ${t===e?"selected":""}"\n            data-icon="${escapeHtml(t)}" title="${escapeHtml(t.replace("fa-",""))}"\n            onclick="selectCategoryIcon(this, '${escapeHtml(t)}')">\n      <i class="fas ${escapeHtml(t)}"></i>\n    </button>\n  `).join(""))}function selectCategoryIcon(e,t){document.querySelectorAll("#categoryIconPicker .icon-btn").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),document.getElementById("categoryIcon").value=t,console.log("[Category] Icon selected:",t)}function updateCategoryColorPreview(e){const t=document.getElementById("categoryColorPreview");t&&(t.style.background=e)}function openCategoryModal(e=null){const t=document.getElementById("categoryModal"),n=document.getElementById("categoryModalTitle"),a=document.getElementById("deleteCategoryBtn"),s=document.getElementById("categorySourceGroup");if(document.getElementById("categoryForm").reset(),document.getElementById("categoryId").value="",document.getElementById("categorySlug").value="",document.getElementById("categoryColor").value="#5E81AC",document.getElementById("categoryInterval").value="12",document.getElementById("categoryIcon").value="fa-wrench",document.getElementById("categoryDescription").value="",s.style.display="none",updateCategoryColorPreview("#5E81AC"),renderCategoryIconPicker("fa-wrench"),e){const t=organizationCategories.find(t=>t.id===e);if(!t)return;if(n.textContent="Rediger kategori",document.getElementById("categoryId").value=t.id,document.getElementById("categoryName").value=t.name,document.getElementById("categorySlug").value=t.slug,document.getElementById("categoryIcon").value=t.icon||"fa-wrench",document.getElementById("categoryColor").value=t.color||"#5E81AC",document.getElementById("categoryInterval").value=String(t.default_interval_months||12),document.getElementById("categoryDescription").value=t.description||"",updateCategoryColorPreview(t.color||"#5E81AC"),renderCategoryIconPicker(t.icon||"fa-wrench"),t.source){s.style.display="block";const e=document.getElementById("categorySourceBadge"),n={template:"Bransjemal",tripletex:"Tripletex",manual:"Manuell"};e.textContent=n[t.source]||"Manuell",e.className="source-badge "+(t.source||"manual")}a.style.display="inline-block"}else n.textContent="Ny kategori",a.style.display="none";t.classList.remove("hidden")}async function saveCategory(e){e.preventDefault();const t=document.getElementById("categoryId").value,n=document.getElementById("categoryName").value.trim();if(!n)return;let a=document.getElementById("categorySlug").value;a||(a=n.toLowerCase().replace(/[æ]/g,"ae").replace(/[ø]/g,"o").replace(/[å]/g,"a").replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,""));const s=document.getElementById("categoryDescription").value.trim(),o=document.getElementById("categoryIcon").value,r=document.getElementById("categoryColor").value,i={name:n,slug:a,icon:o,color:r,default_interval_months:parseInt(document.getElementById("categoryInterval").value)||12,description:s||void 0};let l=null;if(t){const e=organizationCategories.find(e=>e.id===parseInt(t));e&&e.name!==n&&(l=e.name)}console.log("[Category] Saving:",i,l?`(renaming from "${l}")`:"");try{const e=t?`/api/service-types/${t}`:"/api/service-types",a=t?"PUT":"POST",s=await apiFetch(e,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!s.ok){const e=await s.json();throw new Error(e.error?.message||e.error||"Kunne ikke lagre kategori")}l&&customers.forEach(e=>{e.kategori===l&&(e.kategori=n)}),await loadOrganizationCategories(),renderAdminCategories(),renderFilterPanelCategories(),renderCategoryListItems(),renderMarkers(customers.filter(e=>e.lat&&e.lng)),updateCategoryFilterCounts(),document.getElementById("categoryModal").classList.add("hidden"),showToast("Kategori lagret","success")}catch(e){showToast(e.message,"error")}}async function confirmDeleteCategory(e){if(await showConfirm("Er du sikker på at du vil slette denne kategorien?","Slette kategori"))try{if(!(await apiFetch(`/api/service-types/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette kategori");await loadOrganizationCategories(),renderAdminCategories(),renderFilterPanelCategories(),renderCategoryListItems(),renderMarkers(customers.filter(e=>e.lat&&e.lng)),updateCategoryFilterCounts(),showToast("Kategori slettet","success")}catch(e){showToast(e.message,"error")}}async function renderAdminSubcategories(){const e=document.getElementById("subcategoriesAdminContent"),t=document.getElementById("subcategoriesAdminEmpty");if(!e)return;const n=allSubcategoryGroups||[];e.style.display="block",t&&(t.style.display=0===n.length?"block":"none"),e.innerHTML=n.map(e=>`\n    <div class="subcat-group" data-group-id="${e.id}" style="margin-bottom: 10px; border-left: 2px solid var(--color-border, #444); padding-left: 10px;">\n      <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">\n        <i class="fas fa-folder" style="color: var(--color-text-muted, #888); font-size: 11px;"></i>\n        <span style="color: var(--color-text, #fff); font-size: 13px; font-weight: 500;">${escapeHtml(e.navn)}</span>\n        <span style="color: var(--color-text-muted, #888); font-size: 11px;">(${(e.subcategories||[]).length})</span>\n        <button class="btn-icon" style="padding: 2px 4px;" onclick="editSubcatGroup(${e.id}, '${escapeHtml(e.navn).replace(/'/g,"\\'")}')" title="Gi nytt navn">\n          <i class="fas fa-pen" style="font-size: 10px;"></i>\n        </button>\n        <button class="btn-icon danger" style="padding: 2px 4px;" onclick="deleteSubcatGroup(${e.id}, '${escapeHtml(e.navn).replace(/'/g,"\\'")}')" title="Slett gruppe">\n          <i class="fas fa-trash" style="font-size: 10px;"></i>\n        </button>\n      </div>\n\n      ${(e.subcategories||[]).map(e=>`\n        <div style="display: flex; align-items: center; gap: 6px; margin-left: 16px; padding: 2px 0;">\n          <span style="width: 5px; height: 5px; border-radius: 50%; background: var(--color-text-muted, #888); flex-shrink: 0;"></span>\n          <span style="color: var(--color-text-secondary, #ccc); font-size: 13px;">${escapeHtml(e.navn)}</span>\n          <button class="btn-icon" style="padding: 2px 4px; opacity: 0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5" onclick="editSubcatItem(${e.id}, '${escapeHtml(e.navn).replace(/'/g,"\\'")}')" title="Gi nytt navn">\n            <i class="fas fa-pen" style="font-size: 10px;"></i>\n          </button>\n          <button class="btn-icon danger" style="padding: 2px 4px; opacity: 0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5" onclick="deleteSubcatItem(${e.id}, '${escapeHtml(e.navn).replace(/'/g,"\\'")}')" title="Slett">\n            <i class="fas fa-trash" style="font-size: 10px;"></i>\n          </button>\n        </div>\n      `).join("")}\n\n      <div style="display: flex; gap: 6px; margin-left: 16px; margin-top: 4px;">\n        <input type="text" class="form-control" placeholder="Ny underkategori..." maxlength="100"\n          style="flex: 1; font-size: 12px; padding: 4px 8px; height: 28px;"\n          data-add-subcat-for-group="${e.id}"\n          onkeydown="if(event.key==='Enter'){addSubcatItem(${e.id}, this); event.preventDefault();}">\n        <button class="btn btn-primary btn-small" style="font-size: 11px; padding: 4px 8px; height: 28px;" onclick="addSubcatItem(${e.id}, this.previousElementSibling)">\n          <i class="fas fa-plus"></i>\n        </button>\n      </div>\n    </div>\n  `).join("")+'\n    <div style="display: flex; gap: 6px; margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--color-border, #333);">\n      <input type="text" class="form-control" placeholder="Ny gruppe..." maxlength="100"\n        style="flex: 1; font-size: 12px; padding: 4px 8px; height: 28px;"\n        id="adminAddGroupInput"\n        onkeydown="if(event.key===\'Enter\'){addSubcatGroup(this); event.preventDefault();}">\n      <button class="btn btn-secondary btn-small" style="font-size: 11px; padding: 4px 8px; height: 28px;" onclick="addSubcatGroup(document.getElementById(\'adminAddGroupInput\'))">\n        <i class="fas fa-plus" style="margin-right: 4px;"></i> Gruppe\n      </button>\n    </div>\n  '}async function addSubcatGroup(e){const t=e.value.trim();if(t)try{const e=await apiFetch("/api/subcategories/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:t})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Kunne ikke opprette gruppe")}subcatRegistryAddGroup((await e.json()).data||{id:Date.now(),navn:t}),showToast("Gruppe opprettet","success"),renderAdminSubcategories(),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}else e.focus()}async function addSubcatItem(e,t){const n=t.value.trim();if(n)try{const t=await apiFetch("/api/subcategories/items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group_id:e,navn:n})});if(!t.ok){const e=await t.json();throw new Error(e.error?.message||"Kunne ikke opprette underkategori")}subcatRegistryAddItem(e,(await t.json()).data||{id:Date.now(),navn:n}),showToast("Underkategori opprettet","success"),renderAdminSubcategories(),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}else t.focus()}async function editSubcatGroup(e,t){const n=prompt("Nytt navn for gruppen:",t);if(n&&n.trim()!==t)try{if(!(await apiFetch(`/api/subcategories/groups/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:n.trim()})})).ok)throw new Error("Kunne ikke oppdatere gruppe");subcatRegistryEditGroup(e,n.trim()),showToast("Gruppe oppdatert","success"),renderAdminSubcategories(),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}}async function deleteSubcatGroup(e,t){if(await showConfirm(`Slett gruppen "${t}"? Alle underkategorier i gruppen slettes også.`,"Slette gruppe"))try{if(!(await apiFetch(`/api/subcategories/groups/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette gruppe");subcatRegistryDeleteGroup(e),showToast("Gruppe slettet","success"),renderAdminSubcategories(),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}}async function editSubcatItem(e,t){const n=prompt("Nytt navn:",t);if(n&&n.trim()!==t)try{if(!(await apiFetch(`/api/subcategories/items/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:n.trim()})})).ok)throw new Error("Kunne ikke oppdatere underkategori");subcatRegistryEditItem(e,n.trim()),showToast("Underkategori oppdatert","success"),renderAdminSubcategories(),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}}async function deleteSubcatItem(e,t){if(await showConfirm(`Slett underkategorien "${t}"?`,"Slette underkategori"))try{if(!(await apiFetch(`/api/subcategories/items/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette underkategori");subcatRegistryDeleteItem(e),showToast("Underkategori slettet","success"),renderAdminSubcategories(),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}}function initSortable(e,t){if(!e)return;if("true"===e.dataset.sortableInitialized)return;e.dataset.sortableInitialized="true";let n=null;e.addEventListener("dragstart",e=>{const t=e.target.closest(".sortable-item");t&&(n=t,n.classList.add("dragging"),e.dataTransfer.effectAllowed="move")}),e.addEventListener("dragend",()=>{n&&(n.classList.remove("dragging"),updateSortOrder(e,t),n=null)}),e.addEventListener("dragover",t=>{if(t.preventDefault(),!n)return;const a=getDragAfterElement(e,t.clientY);null==a?e.appendChild(n):e.insertBefore(n,a)})}function getDragAfterElement(e,t){return[...e.querySelectorAll(".sortable-item:not(.dragging)")].reduce((e,n)=>{const a=n.getBoundingClientRect(),s=t-a.top-a.height/2;return s<0&&s>e.offset?{offset:s,element:n}:e},{offset:Number.NEGATIVE_INFINITY}).element}async function updateSortOrder(e,t){const n=e.querySelectorAll(".sortable-item"),a=[];n.forEach((e,t)=>{a.push({id:parseInt(e.dataset.id),sort_order:t})});try{for(const e of a){const n="fields"===t?`/api/fields/${e.id}`:`/api/service-types/${e.id}`;await apiFetch(n,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({sort_order:e.sort_order})})}"fields"===t?await loadOrganizationFields():await loadOrganizationCategories()}catch(e){Logger.error("Failed to update sort order:",e),showToast("Kunne ikke oppdatere rekkefølge","error")}}let loginLogOffset=0;const LOGIN_LOG_LIMIT=20;async function loadAdminData(){initTeamMembersUI(),initFieldsManagementUI(),await loadTeamMembers(),await loadLoginStats(),loginLogOffset=0,await loadLoginLog(!1),renderAdminFields(),renderAdminCategories(),renderAdminSubcategories(),await checkSuperAdminStatus(),document.getElementById("loadMoreLogins")?.addEventListener("click",()=>loadLoginLog(!0))}async function loadTeamMembers(){try{const e=await apiFetch("/api/team-members");if(!e.ok)return void console.error("Failed to load team members");const t=await e.json(),n=document.getElementById("teamMembersList"),a=document.getElementById("teamMembersEmpty"),s=document.getElementById("teamQuotaBadge");if(!n)return;if(s&&t.data?.limits){const{current_count:e,max_brukere:n}=t.data.limits;s.textContent=`${e} / ${n}`,s.classList.remove("near-limit","at-limit"),e>=n?s.classList.add("at-limit"):e>=n-1&&s.classList.add("near-limit")}n.innerHTML="";const o=t.data?.members||[];teamMembersData=o,o.length>0?(a&&(a.style.display="none"),n.style.display="flex",n.innerHTML=o.map(e=>{const t=getInitials(e.navn),n=e.sist_innlogget?formatRelativeTime(e.sist_innlogget):"Aldri innlogget";return`\n          <div class="team-member-item" data-action="editTeamMember" data-member-id="${e.id}">\n            <div class="team-member-status ${e.aktiv?"":"inactive"}"></div>\n            <div class="team-member-avatar">${t}</div>\n            <div class="team-member-info">\n              <div class="team-member-name">${escapeHtml(e.navn)}</div>\n              <div class="team-member-email">${escapeHtml(e.epost)}</div>\n              <div class="team-member-meta">\n                <span class="team-member-role">${escapeHtml(e.rolle||"medlem")}</span>\n                <span class="team-member-last-login">Sist: ${n}</span>\n              </div>\n            </div>\n            <div class="team-member-actions">\n              <button class="btn-icon" data-action="editTeamMember" data-member-id="${e.id}" title="Rediger"><i class="fas fa-pen"></i></button>\n              <button class="btn-icon delete" data-action="deleteTeamMember" data-member-id="${e.id}" title="Slett"><i class="fas fa-trash"></i></button>\n            </div>\n          </div>\n        `}).join("")):(n.style.display="none",a&&(a.style.display="block"))}catch(e){console.error("Error loading team members:",e)}}function openTeamMemberModal(e=null){const t=document.getElementById("teamMemberModal"),n=document.getElementById("teamMemberModalTitle"),a=document.getElementById("teamMemberForm"),s=document.getElementById("deleteTeamMemberBtn"),o=document.getElementById("memberPassord");t&&a&&(a.reset(),document.getElementById("teamMemberId").value="",e?(n.textContent="Rediger teammedlem",document.getElementById("teamMemberId").value=e.id,document.getElementById("memberNavn").value=e.navn||"",document.getElementById("memberEpost").value=e.epost||"",document.getElementById("memberTelefon").value=e.telefon||"",document.getElementById("memberRolle").value=e.rolle||"medlem",o.required=!1,o.placeholder="La stå tom for å beholde",s.style.display="inline-flex"):(n.textContent="Nytt teammedlem",o.required=!0,o.placeholder="Minst 8 tegn",s.style.display="none"),t.classList.remove("hidden"))}function closeTeamMemberModal(){const e=document.getElementById("teamMemberModal");e&&e.classList.add("hidden")}async function saveTeamMember(e){e.preventDefault();const t=document.getElementById("teamMemberId").value,n=!!t,a={navn:document.getElementById("memberNavn").value.trim(),epost:document.getElementById("memberEpost").value.trim(),telefon:document.getElementById("memberTelefon").value.trim()||null,rolle:document.getElementById("memberRolle").value},s=document.getElementById("memberPassord").value;if(s)a.passord=s;else if(!n)return void showToast("Passord er påkrevd","error");try{const e=n?`/api/team-members/${t}`:"/api/team-members",s=n?"PUT":"POST",o={"Content-Type":"application/json"},r=getCsrfToken();r&&(o["X-CSRF-Token"]=r);const i=await fetch(e,{method:s,headers:o,credentials:"include",body:JSON.stringify(a)}),l=await i.json();if(!i.ok)return void showToast(l.error?.message||"Kunne ikke lagre bruker","error");showToast(n?"Bruker oppdatert":"Bruker opprettet","success"),closeTeamMemberModal(),await loadTeamMembers()}catch(e){console.error("Error saving team member:",e),showToast("En feil oppstod","error")}}async function deleteTeamMember(e){if(await showConfirm(`Er du sikker på at du vil slette ${e.navn}?`,"Slette teammedlem"))try{const t={},n=getCsrfToken();n&&(t["X-CSRF-Token"]=n);const a=await fetch(`/api/team-members/${e.id}`,{method:"DELETE",headers:t,credentials:"include"});if(!a.ok){const e=await a.json();return void showToast(e.error?.message||"Kunne ikke slette bruker","error")}showToast("Bruker slettet","success"),closeTeamMemberModal(),await loadTeamMembers()}catch(e){console.error("Error deleting team member:",e),showToast("En feil oppstod","error")}}function initTeamMembersUI(){document.getElementById("addTeamMemberBtn")?.addEventListener("click",()=>openTeamMemberModal()),document.getElementById("addFirstMemberBtn")?.addEventListener("click",()=>openTeamMemberModal()),document.getElementById("closeTeamMemberModal")?.addEventListener("click",closeTeamMemberModal),document.getElementById("cancelTeamMember")?.addEventListener("click",closeTeamMemberModal),document.getElementById("teamMemberForm")?.addEventListener("submit",saveTeamMember),document.getElementById("deleteTeamMemberBtn")?.addEventListener("click",()=>{const e=document.getElementById("teamMemberId").value;if(e){deleteTeamMember({id:e,navn:document.getElementById("memberNavn").value})}})}function initFieldsManagementUI(){document.getElementById("addFieldBtn")?.addEventListener("click",()=>openFieldModal()),document.getElementById("addFirstFieldBtn")?.addEventListener("click",()=>openFieldModal()),document.getElementById("closeFieldModal")?.addEventListener("click",()=>{document.getElementById("fieldModal").classList.add("hidden")}),document.getElementById("cancelField")?.addEventListener("click",()=>{document.getElementById("fieldModal").classList.add("hidden")}),document.getElementById("fieldForm")?.addEventListener("submit",saveField),document.getElementById("deleteFieldBtn")?.addEventListener("click",()=>{const e=document.getElementById("fieldId").value;e&&confirmDeleteField(parseInt(e))}),document.getElementById("fieldType")?.addEventListener("change",e=>{const t=document.getElementById("fieldOptionsSection");t&&(t.style.display="select"===e.target.value?"block":"none")}),document.getElementById("addFieldOptionBtn")?.addEventListener("click",addFieldOption),document.getElementById("fieldDisplayName")?.addEventListener("input",e=>{const t=document.getElementById("fieldName");t&&!t.disabled&&(t.value=e.target.value.toLowerCase().replace(/[æ]/g,"ae").replace(/[ø]/g,"o").replace(/[å]/g,"a").replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,""))}),document.getElementById("addCategoryBtn")?.addEventListener("click",()=>openCategoryModal()),document.getElementById("addFirstCategoryBtn")?.addEventListener("click",()=>openCategoryModal()),document.getElementById("manageCategoriesBtn")?.addEventListener("click",e=>{e.stopPropagation(),openCategoryListModal()}),document.getElementById("closeCategoryModal")?.addEventListener("click",()=>{document.getElementById("categoryModal").classList.add("hidden")}),document.getElementById("cancelCategory")?.addEventListener("click",()=>{document.getElementById("categoryModal").classList.add("hidden")}),document.getElementById("categoryForm")?.addEventListener("submit",saveCategory),document.getElementById("deleteCategoryBtn")?.addEventListener("click",()=>{const e=document.getElementById("categoryId").value;e&&confirmDeleteCategory(parseInt(e))}),document.getElementById("categoryName")?.addEventListener("input",e=>{const t=document.getElementById("categorySlug"),n=document.getElementById("categoryId");t&&!n?.value&&(t.value=e.target.value.toLowerCase().replace(/[æ]/g,"ae").replace(/[ø]/g,"o").replace(/[å]/g,"a").replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,""))}),document.getElementById("categoryIconPicker")?.addEventListener("click",e=>{const t=e.target.closest(".icon-btn");t&&(document.querySelectorAll("#categoryIconPicker .icon-btn").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),document.getElementById("categoryIcon").value=t.dataset.icon)}),document.getElementById("categoryColor")?.addEventListener("input",e=>{updateCategoryColorPreview(e.target.value)})}function getInitials(e){if(!e)return"?";const t=e.trim().split(/\s+/);return 1===t.length?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function formatRelativeTime(e){if(!e)return"Ukjent";let t=e;t.endsWith("Z")||t.includes("+")||(t=t.replace(" ","T")+"Z");const n=new Date,a=new Date(t),s=n-a,o=Math.floor(s/6e4),r=Math.floor(s/36e5),i=Math.floor(s/864e5);return o<1?"Nå":o<60?`${o} min siden`:r<24?`${r} t siden`:i<7?`${i} d siden`:a.toLocaleDateString("nb-NO",{day:"2-digit",month:"2-digit",year:"numeric"})}async function loadLoginStats(){try{const e=await fetch("/api/login-logg/stats",{credentials:"include"});if(!e.ok)return void console.error("Failed to load login stats");const t=await e.json();document.getElementById("statTotalLogins").textContent=t.total||0,document.getElementById("statSuccessLogins").textContent=t.vellykket||0,document.getElementById("statFailedLogins").textContent=t.feilet||0,document.getElementById("statLast24h").textContent=t.siste24t||0}catch(e){console.error("Error loading login stats:",e)}}async function loadLoginLog(e=!1){try{e||(loginLogOffset=0);const t=await fetch(`/api/login-logg?limit=20&offset=${loginLogOffset}`,{credentials:"include"});if(!t.ok)return void console.error("Failed to load login log");const n=await t.json(),a=document.getElementById("loginLogBody");if(e||(a.innerHTML=""),n.logg&&n.logg.length>0){n.logg.forEach(e=>{const t=document.createElement("tr");let n=e.tidspunkt;!n||n.endsWith("Z")||n.includes("+")||(n=n.replace(" ","T")+"Z");const s=new Date(n).toLocaleString("nb-NO",{timeZone:"Europe/Oslo",day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),o="vellykket"===e.status?"success":"failed",r="vellykket"===e.status?"OK":"Feilet",i="vellykket"===e.status?"fa-check":"fa-times",l=e.user_agent||"";let d="Ukjent";l.includes("iPhone")?d="iPhone":l.includes("iPad")?d="iPad":l.includes("Android")?d="Android":l.includes("Windows")?d="Windows":l.includes("Mac")?d="Mac":l.includes("Linux")&&(d="Linux"),t.innerHTML=`\n          <td>${s}</td>\n          <td>${escapeHtml(e.bruker_navn||"-")}</td>\n          <td>${escapeHtml(e.epost)}</td>\n          <td><span class="status-badge ${o}"><i class="fas ${i}"></i> ${r}</span></td>\n          <td class="ip-address">${escapeHtml(e.ip_adresse||"-")}</td>\n          <td class="user-agent" title="${escapeHtml(l)}">${d}</td>\n        `,a.appendChild(t)}),loginLogOffset+=n.logg.length;const e=document.getElementById("loadMoreLogins");e&&(e.style.display=n.logg.length<20?"none":"block")}else e||(a.innerHTML='<tr><td colspan="6" style="text-align: center; color: var(--color-text-tertiary);">Ingen innlogginger registrert</td></tr>')}catch(e){console.error("Error loading login log:",e)}}function renderSeasonChart(){const e=new Array(12).fill(0);customers.forEach(t=>{if(t.neste_el_kontroll){const n=new Date(t.neste_el_kontroll);Number.isNaN(n.getTime())||e[n.getMonth()]++}if(t.neste_brann_kontroll){const n=new Date(t.neste_brann_kontroll);Number.isNaN(n.getTime())||e[n.getMonth()]++}});const t=Math.max(...e,1),n=document.getElementById("seasonChart");n&&(n.innerHTML=["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Des"].map((n,a)=>{const s=e[a];return`\n      <div class="season-bar">\n        <span class="season-bar-value">${s}</span>\n        <div class="season-bar-fill combined" style="height: ${s/t*100}%"></div>\n        <span class="season-bar-label">${n}</span>\n      </div>\n    `}).join(""))}function renderBarStats(e,t,n={}){const a=document.getElementById(e);if(!a)return;const s=Object.entries(t).sort((e,t)=>t[1]-e[1]);if(n.limit&&s.splice(n.limit),0===s.length)return void(a.innerHTML='<p style="color: var(--color-text-muted); font-size: 13px;">Ingen data</p>');const o=n.total||Object.values(t).reduce((e,t)=>e+t,0)||1,r=n.useMaxAsBase?s[0]?.[1]||1:o;a.innerHTML=s.map(([e,t])=>{const a=t/r*100,s=n.getBarClass?n.getBarClass(e):n.barClass||"default";return`\n      <div class="stat-bar-item">\n        <div class="stat-bar-header">\n          <span class="stat-bar-label">${e}</span>\n          <span class="stat-bar-value">${!1===n.showPercent?`${t}`:`${t} (${a.toFixed(0)}%)`}</span>\n        </div>\n        <div class="stat-bar-track">\n          <div class="stat-bar-fill ${s}" style="width: ${a}%"></div>\n        </div>\n      </div>\n    `}).join("")}function renderCategoryStats(){const e={};customers.forEach(t=>{const n=t.kategori||"Ukjent";e[n]=(e[n]||0)+1}),renderBarStats("categoryStats",e,{total:customers.length,getBarClass:e=>serviceTypeRegistry.getCategoryClass(e)})}function renderAreaStats(){const e={};customers.forEach(t=>{const n=t.poststed||"Ukjent";e[n]=(e[n]||0)+1}),renderBarStats("areaStats",e,{limit:10,useMaxAsBase:!0,showPercent:!1,barClass:"area"})}function renderEltypeStats(){const e={};customers.forEach(t=>{t.el_type&&(e[t.el_type]=(e[t.el_type]||0)+1)}),renderBarStats("eltypeStats",e,{barClass:"eltype"})}function renderBrannsystemStats(){const e={};customers.forEach(t=>{t.brann_system&&(e[t.brann_system]=(e[t.brann_system]||0)+1)}),renderBarStats("brannsystemStats",e,{barClass:"brannsystem"})}let isSuperAdmin=!1,superAdminOrganizations=[],selectedOrgId=null,selectedOrgData=null;async function checkSuperAdminStatus(){const e=sessionStorage.getItem("isSuperAdmin")||localStorage.getItem("isSuperAdmin");if(isSuperAdmin="true"===e,isSuperAdmin){const e=document.getElementById("superAdminSection");e&&(e.style.display="block",await loadSuperAdminData())}}async function loadSuperAdminData(){if(isSuperAdmin)try{await loadGlobalStatistics(),await loadOrganizations(),initSuperAdminUI()}catch(e){console.error("Error loading super admin data:",e)}}async function loadGlobalStatistics(){try{const e=await fetch("/api/super-admin/statistics",{credentials:"include"});if(!e.ok)return void console.error("Failed to load global statistics");const t=await e.json();if(t.success&&t.data){const e=t.data;updateElement("statTotalOrgs",e.totalOrganizations||0),updateElement("statGlobalKunder",e.totalKunder||0),updateElement("statGlobalBrukere",e.totalBrukere||0),updateElement("statActiveOrgs",e.activeOrganizations||0)}}catch(e){console.error("Error loading global statistics:",e)}}function updateElement(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}async function loadOrganizations(){try{const e=await fetch("/api/super-admin/organizations",{credentials:"include"});if(!e.ok)return void console.error("Failed to load organizations");const t=await e.json();if(t.success){const e=t.data;superAdminOrganizations=Array.isArray(e)?e:e.organizations||[],renderOrganizationList()}}catch(e){console.error("Error loading organizations:",e)}}function renderOrganizationList(e=""){const t=document.getElementById("orgListBody");if(!t)return;const n=e?superAdminOrganizations.filter(t=>t.navn.toLowerCase().includes(e.toLowerCase())||t.slug.toLowerCase().includes(e.toLowerCase())):superAdminOrganizations;0!==n.length?t.innerHTML=n.map(e=>{const t=getPlanBadge(e.plan_type),n=getSubscriptionStatusBadge(e.subscription_status),a=e.opprettet?new Date(e.opprettet).toLocaleDateString("nb-NO"):"-";return`\n      <tr data-org-id="${e.id}">\n        <td><strong>${escapeHtml(e.navn)}</strong><br><small style="color: var(--text-tertiary);">${escapeHtml(e.slug)}</small></td>\n        <td>${t}</td>\n        <td>${n}</td>\n        <td>${e.kunde_count||0}</td>\n        <td>${e.bruker_count||0}</td>\n        <td>${a}</td>\n        <td>\n          <button class="btn btn-small btn-secondary" data-action="selectOrganization" data-org-id="${e.id}">\n            <i class="fas fa-eye"></i>\n          </button>\n        </td>\n      </tr>\n    `}).join(""):t.innerHTML=`\n      <tr>\n        <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n          ${e?"Ingen organisasjoner funnet":"Ingen organisasjoner registrert"}\n        </td>\n      </tr>\n    `}function getPlanBadge(e){const t={free:'<span class="badge badge-secondary">Gratis</span>',standard:'<span class="badge badge-primary">Standard</span>',premium:'<span class="badge badge-success">Premium</span>',enterprise:'<span class="badge badge-warning">Enterprise</span>'};return t[e]||t.free}function getSubscriptionStatusBadge(e){return{active:'<span class="badge badge-success">Aktiv</span>',trialing:'<span class="badge badge-info">Prøveperiode</span>',past_due:'<span class="badge badge-warning">Forfalt</span>',canceled:'<span class="badge badge-danger">Kansellert</span>',incomplete:'<span class="badge badge-secondary">Ufullstendig</span>'}[e]||'<span class="badge badge-secondary">Ukjent</span>'}async function selectOrganization(e){selectedOrgId=e;try{const t=await fetch(`/api/super-admin/organizations/${e}`,{credentials:"include"});if(!t.ok)return void showNotification("Kunne ikke laste organisasjonsdetaljer","error");const n=await t.json();if(n.success){selectedOrgData=n.data,renderSelectedOrganization();const t=document.getElementById("selectedOrgSection");t&&(t.style.display="block",t.scrollIntoView({behavior:"smooth"})),await loadOrgCustomers(e),await loadOrgUsers(e)}}catch(e){console.error("Error loading organization:",e),showNotification("Feil ved lasting av organisasjon","error")}}function renderSelectedOrganization(){selectedOrgData&&(updateElement("selectedOrgName",selectedOrgData.navn),updateElement("orgInfoSlug",selectedOrgData.slug),updateElement("orgInfoPlan",selectedOrgData.plan_type||"free"),updateElement("orgInfoSubscription",selectedOrgData.subscription_status||"ukjent"),updateElement("orgInfoIndustry",selectedOrgData.industry_template_id?`ID: ${selectedOrgData.industry_template_id}`:"Ingen"))}async function loadOrgCustomers(e){try{const t=await fetch(`/api/super-admin/organizations/${e}/kunder`,{credentials:"include"});if(!t.ok)return void console.error("Failed to load org customers");const n=await t.json();if(n.success){const e=n.data?.data||[];renderOrgCustomers(e),updateElement("orgCustomerCount",e.length)}}catch(e){console.error("Error loading org customers:",e)}}function renderOrgCustomers(e){const t=document.getElementById("orgCustomersBody");t&&(0!==e.length?t.innerHTML=e.map(e=>`\n    <tr data-kunde-id="${e.id}">\n      <td><strong>${escapeHtml(e.navn)}</strong></td>\n      <td>${escapeHtml(e.adresse||"-")}</td>\n      <td>${escapeHtml(e.telefon||"-")}</td>\n      <td>${escapeHtml(e.epost||"-")}</td>\n      <td>\n        <button class="btn-icon" data-action="editOrgCustomer" data-kunde-id="${e.id}" title="Rediger">\n          <i class="fas fa-pen"></i>\n        </button>\n        <button class="btn-icon delete" data-action="deleteOrgCustomer" data-kunde-id="${e.id}" title="Slett">\n          <i class="fas fa-trash"></i>\n        </button>\n      </td>\n    </tr>\n  `).join(""):t.innerHTML='\n      <tr>\n        <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n          Ingen kunder registrert\n        </td>\n      </tr>\n    ')}async function loadOrgUsers(e){try{const t=await fetch(`/api/super-admin/organizations/${e}/brukere`,{credentials:"include"});if(!t.ok)return void console.error("Failed to load org users");const n=await t.json();n.success&&(renderOrgUsers(n.data||[]),updateElement("orgUserCount",(n.data||[]).length))}catch(e){console.error("Error loading org users:",e)}}function renderOrgUsers(e){const t=document.getElementById("orgUsersBody");t&&(0!==e.length?t.innerHTML=e.map(e=>{const t=e.sist_innlogget?formatRelativeTime(e.sist_innlogget):"Aldri",n=e.opprettet?new Date(e.opprettet).toLocaleDateString("nb-NO"):"-";return`\n      <tr>\n        <td><strong>${escapeHtml(e.navn)}</strong></td>\n        <td>${escapeHtml(e.epost)}</td>\n        <td>${t}</td>\n        <td>${n}</td>\n      </tr>\n    `}).join(""):t.innerHTML='\n      <tr>\n        <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">\n          Ingen brukere registrert\n        </td>\n      </tr>\n    ')}function closeOrgDetails(){selectedOrgId=null,selectedOrgData=null;const e=document.getElementById("selectedOrgSection");e&&(e.style.display="none")}async function addOrgCustomer(){selectedOrgId&&openCustomerModal(null,selectedOrgId)}async function editOrgCustomer(e){if(selectedOrgId)try{const t=await fetch(`/api/super-admin/organizations/${selectedOrgId}/kunder`,{credentials:"include"});if(!t.ok)return;const n=await t.json(),a=(n.data?.data||[]).find(t=>t.id===e);a&&openCustomerModal(a,selectedOrgId)}catch(e){console.error("Error fetching customer:",e)}}async function deleteOrgCustomer(e){if(!selectedOrgId)return;if(await showConfirm("Er du sikker på at du vil slette denne kunden?","Slett"))try{const t={},n=getCsrfToken();n&&(t["X-CSRF-Token"]=n);const a=await fetch(`/api/super-admin/organizations/${selectedOrgId}/kunder/${e}`,{method:"DELETE",headers:t,credentials:"include"});if(a.ok)showNotification("Kunde slettet"),await loadOrgCustomers(selectedOrgId),await loadGlobalStatistics();else{const e=await a.json();showNotification(e.error?.message||"Kunne ikke slette kunden","error")}}catch(e){console.error("Error deleting customer:",e),showNotification("Feil ved sletting av kunde","error")}}function openCustomerModal(e=null,t=null){const n=document.getElementById("superAdminCustomerModal");n&&n.remove();const a=document.createElement("div");a.id="superAdminCustomerModal",a.className="modal",a.innerHTML=`\n    <div class="modal-content" style="max-width: 500px;">\n      <div class="modal-header">\n        <h2>${e?"Rediger kunde":"Ny kunde"}</h2>\n        <button class="modal-close" id="saCloseModalBtn">&times;</button>\n      </div>\n      <form id="superAdminCustomerForm">\n        <input type="hidden" id="saKundeId" value="${e?.id||""}">\n        <input type="hidden" id="saKundeOrgId" value="${t||""}">\n\n        <div class="form-group">\n          <label for="saKundeNavn">Navn *</label>\n          <input type="text" id="saKundeNavn" value="${escapeHtml(e?.navn||"")}" required>\n        </div>\n\n        <div class="form-group">\n          <label for="saKundeAdresse">Adresse *</label>\n          <input type="text" id="saKundeAdresse" value="${escapeHtml(e?.adresse||"")}" required>\n        </div>\n\n        <div class="form-row">\n          <div class="form-group">\n            <label for="saKundePostnummer">Postnummer</label>\n            <input type="text" id="saKundePostnummer" value="${escapeHtml(e?.postnummer||"")}">\n          </div>\n          <div class="form-group">\n            <label for="saKundePoststed">Poststed</label>\n            <input type="text" id="saKundePoststed" value="${escapeHtml(e?.poststed||"")}">\n          </div>\n        </div>\n\n        <div class="form-row">\n          <div class="form-group">\n            <label for="saKundeTelefon">Telefon</label>\n            <input type="text" id="saKundeTelefon" value="${escapeHtml(e?.telefon||"")}">\n          </div>\n          <div class="form-group">\n            <label for="saKundeEpost">E-post</label>\n            <input type="email" id="saKundeEpost" value="${escapeHtml(e?.epost||"")}">\n          </div>\n        </div>\n\n        <div class="form-group">\n          <label for="saKundeKontaktperson">Kontaktperson</label>\n          <input type="text" id="saKundeKontaktperson" value="${escapeHtml(e?.kontaktperson||"")}">\n        </div>\n\n        <div class="form-group">\n          <label for="saKundeNotater">Notater</label>\n          <textarea id="saKundeNotater" rows="3">${escapeHtml(e?.notater||"")}</textarea>\n        </div>\n\n        <div class="modal-actions">\n          <button type="button" class="btn btn-secondary" id="saCancelModalBtn">Avbryt</button>\n          <button type="submit" class="btn btn-primary">${e?"Lagre":"Opprett"}</button>\n        </div>\n      </form>\n    </div>\n  `,document.body.appendChild(a),document.getElementById("saCloseModalBtn").addEventListener("click",closeSuperAdminCustomerModal),document.getElementById("saCancelModalBtn").addEventListener("click",closeSuperAdminCustomerModal),document.getElementById("superAdminCustomerForm").addEventListener("submit",saveSuperAdminCustomer)}function closeSuperAdminCustomerModal(){const e=document.getElementById("superAdminCustomerModal");e&&e.remove()}async function saveSuperAdminCustomer(e){e.preventDefault();const t=document.getElementById("saKundeId").value,n=document.getElementById("saKundeOrgId").value,a={navn:document.getElementById("saKundeNavn").value,adresse:document.getElementById("saKundeAdresse").value,postnummer:document.getElementById("saKundePostnummer").value,poststed:document.getElementById("saKundePoststed").value,telefon:document.getElementById("saKundeTelefon").value,epost:document.getElementById("saKundeEpost").value,kontaktperson:document.getElementById("saKundeKontaktperson").value,notater:document.getElementById("saKundeNotater").value};try{let e=`/api/super-admin/organizations/${n}/kunder`,s="POST";t&&(e+=`/${t}`,s="PUT");const o={"Content-Type":"application/json"},r=getCsrfToken();r&&(o["X-CSRF-Token"]=r);const i=await fetch(e,{method:s,headers:o,credentials:"include",body:JSON.stringify(a)});if(i.ok)showNotification(t?"Kunde oppdatert":"Kunde opprettet"),closeSuperAdminCustomerModal(),await loadOrgCustomers(n),await loadGlobalStatistics();else{const e=await i.json();showNotification(e.error?.message||"Kunne ikke lagre kunden","error")}}catch(e){console.error("Error saving customer:",e),showNotification("Feil ved lagring av kunde","error")}}function initSuperAdminUI(){const e=document.getElementById("orgSearchInput");e&&e.addEventListener("input",debounce(e=>{renderOrganizationList(e.target.value)},300));const t=document.getElementById("closeOrgDetailsBtn");t&&t.addEventListener("click",closeOrgDetails);const n=document.getElementById("addOrgCustomerBtn");n&&n.addEventListener("click",addOrgCustomer);const a=document.querySelectorAll(".org-tab-btn");a.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;a.forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById("orgCustomersTab").style.display="customers"===t?"block":"none",document.getElementById("orgUsersTab").style.display="users"===t?"block":"none"})});const s=document.getElementById("superAdminSection");s&&s.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;switch(t.dataset.action){case"selectOrganization":{const e=Number(t.dataset.orgId);e&&selectOrganization(e);break}case"editOrgCustomer":{const e=Number(t.dataset.kundeId);e&&editOrgCustomer(e);break}case"deleteOrgCustomer":{const e=Number(t.dataset.kundeId);e&&deleteOrgCustomer(e);break}}})}let isMobile=window.innerWidth<=768,contentPanelMode="closed",touchStartY=0,sidebarOpen=!1,mobileFilterSheetExpanded=!1,moreMenuOpen=!1,activeBottomTab="map";function initMobileUI(){isMobile=window.innerWidth<=768,isMobile&&initBottomTabBar(),window.addEventListener("resize",debounce(()=>{const e=isMobile;isMobile=window.innerWidth<=768,isMobile&&!e?initBottomTabBar():!isMobile&&e&&removeBottomTabBar()},250))}const PATCH_NOTES_STORAGE_KEY="skyplanner_lastSeenPatchNote";async function checkForNewPatchNotes(){try{const e=parseInt(localStorage.getItem(PATCH_NOTES_STORAGE_KEY)||"0",10),t=getCsrfToken(),n={};t&&(n["X-CSRF-Token"]=t);const a=await fetch("/api/patch-notes/latest-id",{credentials:"include",headers:n});if(!a.ok)return;const s=await a.json();s.data&&s.data.latestId>e&&(showPatchNotesBadge(),await loadAndShowPatchNotes(e))}catch(e){console.warn("Could not check patch notes:",e)}}async function loadAndShowPatchNotes(e){try{const t=getCsrfToken(),n={};t&&(n["X-CSRF-Token"]=t);const a=e>0?`/api/patch-notes?since=${e}`:"/api/patch-notes",s=await fetch(a,{credentials:"include",headers:n});if(!s.ok)return;const o=(await s.json()).data||[];if(0===o.length)return void showPatchNotesEmptyState();showPatchNotesModal(o);const r=Math.max(...o.map(e=>e.id));localStorage.setItem(PATCH_NOTES_STORAGE_KEY,String(r)),hidePatchNotesBadge()}catch(e){console.warn("Could not load patch notes:",e)}}function showPatchNotesEmptyState(){const e=document.getElementById("patchNotesModal");e&&e.remove();const t=document.createElement("div");t.id="patchNotesModal",t.className="patch-notes-overlay",t.innerHTML='<div class="patch-notes-modal">\n    <div class="patch-notes-modal-header">\n      <h2><i class="fas fa-bullhorn"></i> Nyheter</h2>\n      <button class="patch-notes-close" id="closePatchNotesBtn" aria-label="Lukk">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n    <div class="patch-notes-modal-body" style="display:flex;align-items:center;justify-content:center;text-align:center;min-height:200px;">\n      <div>\n        <i class="fas fa-newspaper" style="font-size:48px;color:var(--color-text-muted, #999);margin-bottom:16px;display:block;"></i>\n        <p style="font-size:16px;color:var(--color-text-secondary, #666);margin:0 0 8px;">Ingen nyheter ennå</p>\n        <p style="font-size:13px;color:var(--color-text-muted, #999);margin:0;">Nye funksjoner og oppdateringer vil vises her.</p>\n      </div>\n    </div>\n    <div class="patch-notes-modal-footer">\n      <button class="patch-notes-close-btn" id="closePatchNotesFooterBtn">Lukk</button>\n    </div>\n  </div>',document.body.appendChild(t);const n=()=>t.remove();t.querySelector("#closePatchNotesBtn").addEventListener("click",n),t.querySelector("#closePatchNotesFooterBtn").addEventListener("click",n),t.addEventListener("click",e=>{e.target===t&&n()})}function showPatchNotesModal(e){const t=document.getElementById("patchNotesModal");t&&t.remove();const n={nytt:"Nytt",forbedring:"Forbedring",fiks:"Fiks"},a={nytt:"#10b981",forbedring:"#3b82f6",fiks:"#f59e0b"};let s="";for(const t of e){const e=new Date(t.published_at).toLocaleDateString("nb-NO",{year:"numeric",month:"long",day:"numeric"}),o=(t.items||[]).map(e=>{const t=n[e.type]||e.type,s=a[e.type]||"#666",o="full"===e.visibility?'<span class="patch-note-pro-badge">Pro</span>':"",r=e.tab?`<button class="patch-note-tab-link" data-patch-tab="${escapeHtml(e.tab)}">Vis <i class="fas fa-arrow-right"></i></button>`:"",i=e.description?`<span class="patch-note-description">${escapeHtml(e.description)}</span>`:"";return`<li class="patch-note-item">\n        <span class="patch-note-type" style="background: ${s};">${escapeHtml(t)}</span>\n        <div class="patch-note-item-content">\n          <span class="patch-note-text">${escapeHtml(e.text)}${o}${r}</span>\n          ${i}\n        </div>\n      </li>`}).join("");s+=`<div class="patch-note-release">\n      <div class="patch-note-release-header">\n        <span class="patch-note-version">${escapeHtml(t.version)}</span>\n        <span class="patch-note-date">${escapeHtml(e)}</span>\n      </div>\n      <h3 class="patch-note-title">${escapeHtml(t.title)}</h3>\n      ${t.summary?`<p class="patch-note-summary">${escapeHtml(t.summary)}</p>`:""}\n      <ul class="patch-note-items">${o}</ul>\n    </div>`}const o=document.createElement("div");o.id="patchNotesModal",o.className="patch-notes-overlay",o.innerHTML=`<div class="patch-notes-modal">\n    <div class="patch-notes-modal-header">\n      <h2><i class="fas fa-bullhorn"></i> Nyheter</h2>\n      <button class="patch-notes-close" id="closePatchNotesBtn" aria-label="Lukk">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n    <div class="patch-notes-modal-body">${s}</div>\n    <div class="patch-notes-modal-footer">\n      <button class="patch-notes-close-btn" id="closePatchNotesFooterBtn">Lukk</button>\n    </div>\n  </div>`,document.body.appendChild(o);const r=()=>o.remove();o.querySelector("#closePatchNotesBtn").addEventListener("click",r),o.querySelector("#closePatchNotesFooterBtn").addEventListener("click",r),o.addEventListener("click",e=>{e.target===o&&r()}),o.querySelectorAll(".patch-note-tab-link").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.patchTab;r(),switchToTab(t)})})}function showPatchNotesBadge(){const e=document.getElementById("patchNotesBadge");e&&(e.style.display="")}function hidePatchNotesBadge(){const e=document.getElementById("patchNotesBadge");e&&(e.style.display="none")}function initBottomTabBar(){if(document.getElementById("bottomTabBar"))return;document.body.classList.add("has-bottom-tab-bar");const e=[{id:"map",icon:"fa-map-marker-alt",label:"Kart",action:"showMap"},{id:"work",icon:"fa-briefcase",label:"Arbeid",action:hasFeature("todays_work")?"todays-work":"weekly-plan"},{id:"calendar",icon:"fa-calendar-alt",label:"Kalender",action:"calendar"},{id:"more",icon:"fa-ellipsis-h",label:"Mer",action:"showMore"}],t=document.createElement("nav");t.id="bottomTabBar",t.className="bottom-tab-bar",t.setAttribute("role","tablist"),e.forEach(e=>{const n=document.createElement("button");n.className="bottom-tab-item"+("map"===e.id?" active":""),n.dataset.bottomTab=e.id,n.dataset.action=e.action,n.setAttribute("role","tab"),n.setAttribute("aria-label",e.label),n.innerHTML=`<i class="fas ${e.icon}"></i><span>${e.label}</span>`,n.addEventListener("click",()=>handleBottomTabClick(e)),t.appendChild(n)}),document.body.appendChild(t),createMoreMenuOverlay(),createMobileSearchFab(),createMobileSelectionFab(),document.body.style.overflow="hidden",setTimeout(syncBottomBarBadges,500)}function removeBottomTabBar(){document.body.classList.remove("has-bottom-tab-bar");const e=document.getElementById("bottomTabBar");e&&e.remove();const t=document.getElementById("moreMenuOverlay");t&&t.remove(),restoreFilterPanel();const n=document.getElementById("mobileFilterSheet");n&&n.remove();const a=document.getElementById("mobileSearchFab");a&&a.remove();const s=document.getElementById("mobileSelectionFab");s&&s.remove(),document.body.style.overflow="",moreMenuOpen=!1,mobileFilterSheetExpanded=!1;const o=document.querySelector(".sidebar");o&&(o.style.display="",o.classList.remove("mobile-open"))}function handleBottomTabClick(e){document.querySelectorAll(".bottom-tab-item").forEach(t=>t.classList.toggle("active",t.dataset.bottomTab===e.id)),activeBottomTab=e.id;const t=document.getElementById("mobileSearchFab");"showMap"===e.action?(closeContentPanelMobile(),closeMoreMenu(),hideMobileFilterSheet(),t&&t.classList.remove("hidden")):"showMore"===e.action?(closeContentPanelMobile(),hideMobileFilterSheet(),t&&t.classList.add("hidden"),toggleMoreMenu()):(closeMoreMenu(),hideMobileFilterSheet(),t&&t.classList.add("hidden"),switchToTab(e.action))}function closeContentPanelMobile(){const e=document.getElementById("contentPanel");e&&(e.classList.add("closed"),e.classList.remove("open","half-height","full-height"),contentPanelMode="closed");const t=document.getElementById("contentPanelOverlay");t&&t.classList.remove("visible")}function createMoreMenuOverlay(){if(document.getElementById("moreMenuOverlay"))return;const e=document.createElement("div");e.id="moreMenuOverlay",e.className="more-menu-overlay";const t=localStorage.getItem("userRole")||"",n=[{tab:"dashboard",icon:"fa-th-large",label:"Dashboard"},{tab:"customers",icon:"fa-users",label:"Kunder"},{tab:"overdue",icon:"fa-exclamation-triangle",label:"Forfalte",badgeId:"overdueBadge"},{tab:"warnings",icon:"fa-bell",label:"Kommende",badgeId:"upcomingBadge"},{tab:"planner",icon:"fa-route",label:"Planlegger"},{tab:"statistikk",icon:"fa-chart-line",label:"Statistikk"},{tab:"missingdata",icon:"fa-exclamation-circle",label:"Mangler data",badgeId:"missingDataBadge"}];("bruker"===(localStorage.getItem("userType")||"")||"admin"===t)&&n.push({tab:"admin",icon:"fa-shield-alt",label:"Admin"});if(!hasFeature("todays_work")){const e=document.getElementById("todaysWorkTab");e&&"none"!==e.style.display&&n.splice(2,0,{tab:"todays-work",icon:"fa-briefcase",label:"Dagens arbeid",badgeId:"todaysWorkBadge"})}e.innerHTML=`\n    <div class="more-menu-header">\n      <h3>Alle funksjoner</h3>\n      <button class="more-menu-close" id="moreMenuCloseBtn" aria-label="Lukk">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n    <div class="more-menu-grid">\n      ${n.map(e=>`\n        <button class="more-menu-item" data-more-tab="${escapeHtml(e.tab)}">\n          <i class="fas ${escapeHtml(e.icon)}"></i>\n          <span>${escapeHtml(e.label)}</span>\n          ${e.badgeId?`<span class="more-menu-badge" data-mirror-badge="${escapeHtml(e.badgeId)}" style="display:none;"></span>`:""}\n        </button>\n      `).join("")}\n      <button class="more-menu-item" id="moreMenuPatchNotes">\n        <i class="fas fa-bullhorn"></i>\n        <span>Nyheter</span>\n      </button>\n    </div>\n  `,document.body.appendChild(e),document.getElementById("moreMenuCloseBtn").addEventListener("click",closeMoreMenu),e.querySelectorAll(".more-menu-item[data-more-tab]").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.moreTab;closeMoreMenu(),document.querySelectorAll(".bottom-tab-item").forEach(e=>e.classList.toggle("active","more"===e.dataset.bottomTab)),activeBottomTab="more",hideMobileFilterSheet(),switchToTab(t)})}),document.getElementById("moreMenuPatchNotes")?.addEventListener("click",()=>{closeMoreMenu(),loadAndShowPatchNotes(0)})}function toggleMoreMenu(){const e=document.getElementById("moreMenuOverlay");e&&(moreMenuOpen=!moreMenuOpen,e.classList.toggle("open",moreMenuOpen),moreMenuOpen&&syncMoreMenuBadges())}function closeMoreMenu(){const e=document.getElementById("moreMenuOverlay");e&&(moreMenuOpen=!1,e.classList.remove("open"))}function createMobileFilterSheet(){if(document.getElementById("mobileFilterSheet"))return;const e=document.createElement("div");e.id="mobileFilterSheet",e.className="mobile-filter-sheet",e.innerHTML='\n    <div class="filter-sheet-handle" id="filterSheetHandle">\n      <div class="filter-sheet-search-peek">\n        <i class="fas fa-search"></i>\n        <span>Søk og filtrer kunder</span>\n        <span class="filter-sheet-count" id="filterSheetCount">0</span>\n        <button class="filter-sheet-close" id="filterSheetClose" aria-label="Lukk">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n    </div>\n    <div class="filter-sheet-content" id="filterSheetContent"></div>\n  ',document.body.appendChild(e);const t=document.getElementById("filterSheetClose");t&&t.addEventListener("click",e=>{e.stopPropagation(),hideMobileFilterSheet()});const n=document.getElementById("filterSheetHandle");if(n){let e=0;n.addEventListener("touchstart",t=>{e=t.touches[0].clientY},{passive:!0}),n.addEventListener("touchmove",t=>{if(!e)return;e-t.touches[0].clientY<-40&&(t.preventDefault(),hideMobileFilterSheet(),e=0)},{passive:!1}),n.addEventListener("touchend",()=>{e=0},{passive:!0})}}function moveFilterPanelToSheet(){const e=document.querySelector(".filter-panel"),t=document.getElementById("filterSheetContent");e&&t&&!t.contains(e)&&(e.dataset.originalParent=e.parentElement?.id||"map-container",t.appendChild(e),e.classList.remove("collapsed")),updateFilterSheetCount()}function restoreFilterPanel(){const e=document.querySelector(".filter-panel");if(!e||!e.dataset.originalParent)return;const t=document.getElementById(e.dataset.originalParent)||document.querySelector(".map-container");t&&(t.appendChild(e),delete e.dataset.originalParent)}function showMobileFilterSheet(){let e=document.getElementById("mobileFilterSheet");e||(createMobileFilterSheet(),moveFilterPanelToSheet(),e=document.getElementById("mobileFilterSheet")),e&&(e.style.setProperty("display","block","important"),mobileFilterSheetExpanded=!0,updateFilterSheetCount());const t=document.getElementById("mobileSearchFab");t&&t.classList.add("hidden")}function hideMobileFilterSheet(){const e=document.getElementById("mobileFilterSheet");if(e&&(e.style.setProperty("display","none","important"),mobileFilterSheetExpanded=!1),"map"===activeBottomTab){const e=document.getElementById("mobileSearchFab");e&&e.classList.remove("hidden")}}function updateFilterSheetCount(){const e=document.getElementById("filterSheetCount");e&&void 0!==customers&&(e.textContent=customers.length)}function createMobileSearchFab(){if(document.getElementById("mobileSearchFab"))return;const e=document.createElement("button");e.id="mobileSearchFab",e.className="mobile-search-fab",e.setAttribute("aria-label","Søk og filtrer kunder"),e.innerHTML='<i class="fas fa-search"></i>',e.addEventListener("click",()=>{showMobileFilterSheet()}),document.body.appendChild(e)}function createMobileSelectionFab(){if(document.getElementById("mobileSelectionFab"))return;const e=document.createElement("button");e.id="mobileSelectionFab",e.className="mobile-selection-fab",e.innerHTML='<i class="fas fa-check-circle"></i> <span id="mobileSelectionCount">0</span> valgt',e.addEventListener("click",()=>{switchToTab("planner"),document.getElementById("bottomTabBar")&&(document.querySelectorAll(".bottom-tab-item").forEach(e=>e.classList.toggle("active","planner"===e.dataset.bottomTab)),activeBottomTab="planner")}),document.body.appendChild(e)}function updateMobileSelectionFab(){const e=document.getElementById("mobileSelectionFab"),t=document.getElementById("mobileSelectionCount");e&&t&&(selectedCustomers.size>0?(t.textContent=selectedCustomers.size,e.classList.add("visible")):e.classList.remove("visible"))}function syncBottomBarBadges(){if(!document.getElementById("bottomTabBar"))return;const e=document.querySelector('.bottom-tab-item[data-bottom-tab="work"]');if(e){const t=document.getElementById("todaysWorkBadge");let n=e.querySelector(".bottom-tab-badge");t&&"none"!==t.style.display&&t.textContent.trim()?(n||(n=document.createElement("span"),n.className="bottom-tab-badge",e.appendChild(n)),n.textContent=t.textContent,n.style.display=""):n&&(n.style.display="none")}syncMoreMenuBadges(),updateFilterSheetCount()}function syncMoreMenuBadges(){document.querySelectorAll("[data-mirror-badge]").forEach(e=>{const t=document.getElementById(e.dataset.mirrorBadge);t&&"none"!==t.style.display&&t.textContent.trim()?(e.textContent=t.textContent,e.style.display=""):e.style.display="none"})}const badgeIds=["overdueBadge","upcomingBadge","todaysWorkBadge","missingDataBadge"];function setupBadgeObserver(){badgeIds.forEach(e=>{const t=document.getElementById(e);if(!t)return;new MutationObserver(()=>{syncBottomBarBadges()}).observe(t,{childList:!0,attributes:!0,attributeFilter:["style"]})})}function setupMobileInteractions(){const e=document.querySelector(".sidebar"),t=document.querySelector(".sidebar-header"),n=document.querySelector(".filter-panel"),a=document.querySelector("#tab-customers");if(!e)return;e.classList.remove("collapsed"),n&&a&&!a.contains(n)&&(n.dataset.originalParent="map-container",a.appendChild(n),n.classList.remove("collapsed")),t&&(t.addEventListener("touchstart",handleTouchStart,{passive:!0}),t.addEventListener("touchmove",handleTouchMove,{passive:!1}),t.addEventListener("touchend",handleTouchEnd,{passive:!0}),t.addEventListener("click",e=>{e.target.closest("button")||toggleMobileSidebar()}));const s=document.querySelector(".map-container");s&&s.addEventListener("click",()=>{sidebarOpen&&closeMobileSidebar()}),addMobileMenuButton(),document.body.style.overflow="hidden"}function removeMobileInteractions(){const e=document.querySelector(".sidebar");e&&e.classList.remove("mobile-open");const t=document.querySelector(".filter-panel"),n=document.querySelector(".map-container");t&&n&&"map-container"===t.dataset.originalParent&&(n.appendChild(t),delete t.dataset.originalParent);const a=document.querySelector(".mobile-menu-toggle");a&&a.remove(),document.body.style.overflow=""}function addMobileMenuButton(){if(document.querySelector(".mobile-menu-toggle"))return;const e=document.createElement("button");e.className="mobile-menu-toggle",e.innerHTML='<i class="fas fa-bars"></i>',e.setAttribute("aria-label","Åpne meny"),e.addEventListener("click",()=>{toggleMobileSidebar(),e.classList.toggle("active",sidebarOpen),e.innerHTML=sidebarOpen?'<i class="fas fa-times"></i>':'<i class="fas fa-bars"></i>'}),document.body.appendChild(e)}function toggleMobileSidebar(){const e=document.querySelector(".sidebar");if(!e)return;sidebarOpen=!sidebarOpen,e.classList.toggle("mobile-open",sidebarOpen);const t=document.querySelector(".mobile-menu-toggle");t&&(t.classList.toggle("active",sidebarOpen),t.innerHTML=sidebarOpen?'<i class="fas fa-times"></i>':'<i class="fas fa-bars"></i>')}function closeMobileSidebar(){const e=document.querySelector(".sidebar");if(!e)return;sidebarOpen=!1,e.classList.remove("mobile-open");const t=document.querySelector(".mobile-menu-toggle");t&&(t.classList.remove("active"),t.innerHTML='<i class="fas fa-bars"></i>')}function openMobileSidebar(){const e=document.querySelector(".sidebar");if(!e)return;sidebarOpen=!0,e.classList.add("mobile-open");const t=document.querySelector(".mobile-menu-toggle");t&&(t.classList.add("active"),t.innerHTML='<i class="fas fa-times"></i>')}function handleTouchStart(e){touchStartY=e.touches[0].clientY}function handleTouchMove(e){if(!touchStartY)return;const t=e.touches[0].clientY,n=touchStartY-t;n>50&&!sidebarOpen?(e.preventDefault(),openMobileSidebar(),touchStartY=0):n<-50&&sidebarOpen&&(e.preventDefault(),closeMobileSidebar(),touchStartY=0)}function handleTouchEnd(){touchStartY=0}function setViewportHeight(){const e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`)}setTimeout(setupBadgeObserver,2e3),document.addEventListener("DOMContentLoaded",()=>{setTimeout(initMobileUI,100)}),setViewportHeight(),window.addEventListener("resize",setViewportHeight),window.toggleMobileSidebar=toggleMobileSidebar,window.closeMobileSidebar=closeMobileSidebar,window.openMobileSidebar=openMobileSidebar,window.closeMoreMenu=closeMoreMenu,window.syncBottomBarBadges=syncBottomBarBadges;const contextTips={tips:[{id:"map-intro",target:"#map",title:"Interaktivt kart",message:"Her ser du alle kundene dine på kartet. Klikk på en markør for å se detaljer.",position:"top",icon:"fa-map-marked-alt"},{id:"add-customer",target:".customer-add-btn, .add-client-btn, #addClientBtn",title:"Legg til kunder",message:"Klikk her for å legge til din første kunde.",position:"bottom",icon:"fa-user-plus"},{id:"route-planning",target:'.route-btn, #routeBtn, [data-action="route"]',title:"Ruteplanlegging",message:"Planlegg effektive ruter mellom kundene dine.",position:"bottom",icon:"fa-route"},{id:"calendar",target:'.calendar-btn, #calendarBtn, [data-view="calendar"]',title:"Kalender",message:"Hold oversikt over avtaler og oppgaver i kalenderen.",position:"bottom",icon:"fa-calendar-alt"}],shownTips:[],currentTipIndex:0,tipOverlay:null};function initContextTips(){const e=localStorage.getItem("shownContextTips");if(e)try{contextTips.shownTips=JSON.parse(e)}catch(e){contextTips.shownTips=[]}}function showContextTips(){initContextTips();const e=contextTips.tips.filter(e=>!contextTips.shownTips.includes(e.id));0!==e.length&&setTimeout(()=>{showTip(e[0])},1e3)}function showTip(e){const t=document.querySelector(e.target);if(!t)return markTipAsShown(e.id),void showNextTip();const n=document.createElement("div");n.className="context-tip-overlay",n.innerHTML=`\n    <div class="context-tip-backdrop" onclick="dismissCurrentTip()"></div>\n    <div class="context-tip" id="contextTip-${e.id}">\n      <div class="context-tip-arrow"></div>\n      <div class="context-tip-icon">\n        <i class="fas ${e.icon}"></i>\n      </div>\n      <div class="context-tip-content">\n        <h4>${escapeHtml(e.title)}</h4>\n        <p>${escapeHtml(e.message)}</p>\n      </div>\n      <div class="context-tip-actions">\n        <button class="context-tip-btn context-tip-btn-skip" onclick="skipAllTips()">\n          Hopp over alle\n        </button>\n        <button class="context-tip-btn context-tip-btn-next" onclick="dismissCurrentTip()">\n          Forstått <i class="fas fa-check"></i>\n        </button>\n      </div>\n      <div class="context-tip-progress">\n        ${contextTips.currentTipIndex+1} av ${contextTips.tips.length-contextTips.shownTips.length}\n      </div>\n    </div>\n  `,document.body.appendChild(n),contextTips.tipOverlay=n,positionTip(n.querySelector(".context-tip"),t,e.position),t.classList.add("context-tip-highlight"),requestAnimationFrame(()=>{n.classList.add("visible")})}function positionTip(e,t,n){const a=t.getBoundingClientRect(),s=e.getBoundingClientRect();let o,r;switch(n){case"top":o=a.top-s.height-12,r=a.left+a.width/2-s.width/2,e.classList.add("position-top");break;case"bottom":o=a.bottom+12,r=a.left+a.width/2-s.width/2,e.classList.add("position-bottom");break;case"left":o=a.top+a.height/2-s.height/2,r=a.left-s.width-12,e.classList.add("position-left");break;case"right":o=a.top+a.height/2-s.height/2,r=a.right+12,e.classList.add("position-right");break;default:o=a.bottom+12,r=a.left}r=Math.max(16,Math.min(r,window.innerWidth-s.width-16)),o=Math.max(16,Math.min(o,window.innerHeight-s.height-16)),e.style.position="fixed",e.style.top=`${o}px`,e.style.left=`${r}px`}function markTipAsShown(e){contextTips.shownTips.includes(e)||(contextTips.shownTips.push(e),localStorage.setItem("shownContextTips",JSON.stringify(contextTips.shownTips)))}function dismissCurrentTip(){const e=contextTips.tips.filter(e=>!contextTips.shownTips.includes(e.id));e.length>0&&markTipAsShown(e[0].id),document.querySelectorAll(".context-tip-highlight").forEach(e=>{e.classList.remove("context-tip-highlight")}),contextTips.tipOverlay&&(contextTips.tipOverlay.classList.remove("visible"),setTimeout(()=>{contextTips.tipOverlay.remove(),contextTips.tipOverlay=null,showNextTip()},300))}function showNextTip(){contextTips.currentTipIndex++;const e=contextTips.tips.filter(e=>!contextTips.shownTips.includes(e.id));e.length>0&&setTimeout(()=>showTip(e[0]),500)}function skipAllTips(){contextTips.tips.forEach(e=>{markTipAsShown(e.id)}),document.querySelectorAll(".context-tip-highlight").forEach(e=>{e.classList.remove("context-tip-highlight")}),contextTips.tipOverlay&&(contextTips.tipOverlay.classList.remove("visible"),setTimeout(()=>{contextTips.tipOverlay.remove(),contextTips.tipOverlay=null},300))}function resetContextTips(){contextTips.shownTips=[],contextTips.currentTipIndex=0,localStorage.removeItem("shownContextTips")}let renderMarkersRetryCount=0;const MAX_RENDER_RETRIES=10;function renderMarkers(e){if("login"===currentView)return Logger.log("renderMarkers skipped - still on login view"),void(renderMarkersRetryCount=0);if(!markerClusterGroup)return renderMarkersRetryCount>=MAX_RENDER_RETRIES?(console.error("renderMarkers failed after max retries - markerClusterGroup never initialized"),void(renderMarkersRetryCount=0)):(renderMarkersRetryCount++,console.error(`renderMarkers called but markerClusterGroup is null - retry ${renderMarkersRetryCount}/${MAX_RENDER_RETRIES}`),void setTimeout(()=>renderMarkers(e),100));renderMarkersRetryCount=0;try{markerClusterGroup.clearLayers()}catch(e){console.warn("clearLayers failed, recreating cluster group:",e.message),map.removeLayer(markerClusterGroup),markerClusterGroup=L.markerClusterGroup({maxClusterRadius:appConfig.mapClusterRadius||60,iconCreateFunction:createClusterIcon,disableClusteringAtZoom:14,spiderfyOnMaxZoom:!0,spiderfyOnEveryZoom:!1,spiderfyDistanceMultiplier:2.5,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,animate:!0,animateAddingMarkers:!1,singleMarkerMode:!1}),map.addLayer(markerClusterGroup)}markers={};const t={};e.forEach(e=>{const n=e.kategori||"null";t[n]=(t[n]||0)+1}),Logger.log("renderMarkers:",e.length,"kunder",t);const n=[];e.forEach(e=>{if(e.lat&&e.lng){const t=selectedCustomers.has(e.id),a=getControlStatus(e),s=e.navn.length>20?e.navn.substring(0,18)+"...":e.navn,o="forfalt"===a.status||"denne-uke"===a.status||"snart"===a.status,r=o?'<span class="marker-warning-badge">!</span>':"";let i,l;const d=serviceTypeRegistry.getAll();if(e.kategori&&d.length>0)i=serviceTypeRegistry.getIconForCategory(e.kategori),l=serviceTypeRegistry.getCategoryClass(e.kategori);else if(d.length>0){const e=serviceTypeRegistry.getDefaultServiceType();i=serviceTypeRegistry.getIconForCategory(e.name),l=serviceTypeRegistry.getCategoryClass(e.name)}else i=`<span class="marker-svg-icon">${svgIcons.service}</span>`,l="service";const c=L.divIcon({className:`custom-marker-with-label ${t?"selected":""} ${a.class}`,html:`\n          <div class="marker-icon ${l} ${a.class}" data-status="${a.status}">\n            ${i}\n            ${r}\n          </div>\n          <div class="marker-label">\n            <span class="marker-name">${escapeHtml(s)}</span>\n          </div>\n        `,iconSize:[42,42],iconAnchor:[21,35]}),u=L.marker([e.lat,e.lng],{icon:c,customerData:{id:e.id,poststed:e.poststed,hasWarning:o}}).bindPopup(()=>generatePopupContent(e),{maxWidth:350});u.on("click",()=>{u.openPopup()}),u.on("contextmenu",t=>{L.DomEvent.stopPropagation(t),L.DomEvent.preventDefault(t),showMarkerContextMenu(e,t.originalEvent.clientX,t.originalEvent.clientY)}),u.on("add",()=>{const t=u.getElement();t&&!t.dataset.ctxInit&&(t.dataset.ctxInit="true",t.addEventListener("contextmenu",t=>{t.preventDefault(),t.stopPropagation(),showMarkerContextMenu(e,t.clientX,t.clientY)}))});let m=null;u.on("touchstart",t=>{m=setTimeout(()=>{m=null;const n=t.originalEvent.touches[0];n&&showMarkerContextMenu(e,n.clientX,n.clientY)},500)}),u.on("touchend touchmove",()=>{m&&(clearTimeout(m),m=null)}),u.on("remove",()=>{m&&(clearTimeout(m),m=null)}),hasFeature("hover_tooltip")&&(u.on("mouseover",t=>{window.innerWidth>768&&!u.isPopupOpen()&&showMarkerTooltip(e,t.target._icon,t.originalEvent)}),u.on("mouseout",()=>{hideMarkerTooltip()}),u.on("popupopen",()=>{hideMarkerTooltip()})),u.on("add",()=>{const t=u.getElement();if(t&&!t.dataset.dragInit){t.dataset.dragInit="true",t.dataset.customerId=String(e.id);let n=null;t.addEventListener("mousedown",t=>{if(0!==t.button)return;const a=t.clientX,s=t.clientY;let o=!1;n=setTimeout(()=>{o=!0,map.dragging.disable(),startMarkerDrag(e.id,a,s)},300);const r=e=>{if(!o){return void(Math.abs(e.clientX-a)+Math.abs(e.clientY-s)>10&&(clearTimeout(n),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i)))}updateMarkerDrag(e.clientX,e.clientY)},i=()=>{clearTimeout(n),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i),o&&(endMarkerDrag(e.id),map.dragging.enable())};document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)})}}),n.push({marker:u,customerId:e.id}),markers[e.id]=u}}),n.length>0&&(n.forEach(e=>{markerClusterGroup.addLayer(e.marker)}),Logger.log("renderMarkers: Added",n.length,"markers to cluster group"),presenceClaims.size>0&&setTimeout(updatePresenceBadges,200))}function focusOnCustomer(e){const t=customers.find(t=>t.id===e);if(t){if(isMobile&&document.getElementById("bottomTabBar")){closeContentPanelMobile(),hideMobileFilterSheet(),document.querySelectorAll(".bottom-tab-item").forEach(e=>e.classList.toggle("active","map"===e.dataset.bottomTab)),activeBottomTab="map";const e=document.getElementById("mobileSearchFab");e&&e.classList.remove("hidden")}if(t.lat&&t.lng){setTimeout(()=>{map.invalidateSize(),map.setView([t.lat,t.lng],14),markers[e]&&markers[e].openPopup()},isMobile?150:0)}else showNotification(`${t.navn} mangler koordinater - bruk geokoding`)}}function toggleCustomerSelection(e){selectedCustomers.has(e)?selectedCustomers.delete(e):selectedCustomers.add(e),updateSelectionUI()}function updateSelectionUI(){selectedCount&&(selectedCount.textContent=selectedCustomers.size),planRouteBtn&&(planRouteBtn.disabled=selectedCustomers.size<2),clearSelectionBtn&&(clearSelectionBtn.disabled=0===selectedCustomers.size);const e=document.getElementById("mobileRouteBtn"),t=document.getElementById("mobileRouteCount");e&&t&&(selectedCustomers.size>=2?(e.classList.remove("hidden"),t.textContent=selectedCustomers.size):e.classList.add("hidden")),updateMobileSelectionFab(),document.querySelectorAll(".customer-item").forEach(e=>{const t=Number.parseInt(e.dataset.id);e.classList.toggle("selected",selectedCustomers.has(t))}),updateMarkerSelectionStyles()}function updateMarkerSelectionStyles(){for(const[e,t]of Object.entries(markers)){const n=t.getElement();if(!n)continue;const a=Number.parseInt(e),s=selectedCustomers.has(a);n.classList.toggle("selected",s);const o=n.querySelector(".marker-icon");o&&o.classList.toggle("selected",s)}}function updateRouteSelection(){updateSelectionUI()}function clearSelection(){selectedCustomers.clear(),updateSelectionUI(),clearRoute()}async function quickMarkVisited(e){const t=customers.find(t=>t.id===e),n=serviceTypeRegistry.getAll(),a=(new Date).toISOString().split("T")[0],s=n.map(e=>`\n    <label style="display:flex;align-items:center;gap:8px;padding:8px 0;font-size:15px;color:var(--color-text-primary,#fff);cursor:pointer;">\n      <input type="checkbox" class="qmv-kontroll-cb" data-slug="${escapeHtml(e.slug)}" checked\n        style="width:20px;height:20px;accent-color:${escapeHtml(e.color||"#5E81AC")};">\n      <i class="fas ${escapeHtml(e.icon||"fa-clipboard-check")}" style="color:${escapeHtml(e.color||"#5E81AC")};"></i>\n      ${escapeHtml(e.name)}\n    </label>\n  `).join(""),o=document.createElement("div");o.className="qmv-overlay",o.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100001;display:flex;justify-content:center;align-items:center;padding:20px;",o.innerHTML=`\n    <div style="background:var(--color-bg-secondary,#1a1a1a);border-radius:16px;max-width:400px;width:100%;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,0.5);border:1px solid var(--color-border,#333);">\n      <h3 style="margin:0 0 16px;font-size:18px;color:var(--color-text-primary,#fff);">\n        Marker besøkt: ${escapeHtml(t?.navn||"Kunde")}\n      </h3>\n      <div style="margin-bottom:16px;">\n        <label style="display:block;font-size:13px;color:var(--color-text-secondary,#a0a0a0);margin-bottom:6px;">Dato for besøk</label>\n        <input type="${"month_year"===appConfig.datoModus?"month":"date"}" id="qmvDate" value="${"month_year"===appConfig.datoModus?a.substring(0,7):a}" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--color-border,#333);background:var(--color-bg-tertiary,#252525);color:var(--color-text-primary,#fff);font-size:15px;">\n      </div>\n      ${n.length>0?`\n        <div style="margin-bottom:20px;">\n          <label style="display:block;font-size:13px;color:var(--color-text-secondary,#a0a0a0);margin-bottom:6px;">Oppdater kontrolldatoer</label>\n          ${s}\n        </div>\n      `:""}\n      <div style="display:flex;gap:12px;justify-content:flex-end;">\n        <button id="qmvCancel" style="padding:12px 24px;font-size:15px;font-weight:600;border-radius:10px;border:1px solid var(--color-border,#333);background:var(--color-bg-tertiary,#252525);color:var(--color-text-primary,#fff);cursor:pointer;">Avbryt</button>\n        <button id="qmvConfirm" style="padding:12px 24px;font-size:15px;font-weight:600;border-radius:10px;border:none;background:var(--color-accent,#5E81AC);color:#fff;cursor:pointer;">Marker besøkt</button>\n      </div>\n    </div>\n  `,document.body.appendChild(o);const r=e=>{"Escape"===e.key&&i()},i=()=>{document.removeEventListener("keydown",r),o.remove()};o.addEventListener("click",e=>{e.target===o&&i()}),document.addEventListener("keydown",r),o.querySelector("#qmvCancel").addEventListener("click",i),o.querySelector("#qmvConfirm").addEventListener("click",async()=>{const n=o.querySelector("#qmvConfirm");if(n.disabled)return;n.disabled=!0,n.textContent="Oppdaterer...";const a=normalizeDateValue(document.getElementById("qmvDate").value),s=Array.from(o.querySelectorAll(".qmv-kontroll-cb:checked")).map(e=>e.dataset.slug);i();try{const n=await apiFetch("/api/kunder/mark-visited",{method:"POST",body:JSON.stringify({kunde_ids:[e],visited_date:a,service_type_slugs:s})}),o=await n.json();if(n.ok&&o.success){showNotification(s.length>0?`${escapeHtml(t?.navn||"Kunde")} markert som besøkt (kontrolldatoer oppdatert)`:`${escapeHtml(t?.navn||"Kunde")} markert som besøkt`),await loadCustomers()}else showNotification("string"==typeof o.error?o.error:"Kunne ikke markere som besøkt","error")}catch(e){console.error("Feil ved rask avhuking:",e),showNotification("Feil ved oppdatering","error")}})}async function bulkMarkVisited(e){const t=serviceTypeRegistry.getAll(),n=(new Date).toISOString().split("T")[0],a=e.length,s=t.map(e=>`\n    <label style="display:flex;align-items:center;gap:8px;padding:8px 0;font-size:15px;color:var(--color-text-primary,#fff);cursor:pointer;">\n      <input type="checkbox" class="bmv-kontroll-cb" data-slug="${escapeHtml(e.slug)}" checked\n        style="width:20px;height:20px;accent-color:${escapeHtml(e.color||"#5E81AC")};">\n      <i class="fas ${escapeHtml(e.icon||"fa-clipboard-check")}" style="color:${escapeHtml(e.color||"#5E81AC")};"></i>\n      ${escapeHtml(e.name)}\n    </label>\n  `).join(""),o=document.createElement("div");o.className="qmv-overlay",o.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100001;display:flex;justify-content:center;align-items:center;padding:20px;",o.innerHTML=`\n    <div style="background:var(--color-bg-secondary,#1a1a1a);border-radius:16px;max-width:400px;width:100%;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,0.5);border:1px solid var(--color-border,#333);">\n      <h3 style="margin:0 0 16px;font-size:18px;color:var(--color-text-primary,#fff);">\n        Marker ${a} kunder som besøkt\n      </h3>\n      <div style="margin-bottom:16px;">\n        <label style="display:block;font-size:13px;color:var(--color-text-secondary,#a0a0a0);margin-bottom:6px;">Dato for besøk</label>\n        <input type="${"month_year"===appConfig.datoModus?"month":"date"}" id="bmvDate" value="${"month_year"===appConfig.datoModus?n.substring(0,7):n}" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--color-border,#333);background:var(--color-bg-tertiary,#252525);color:var(--color-text-primary,#fff);font-size:15px;">\n      </div>\n      ${t.length>0?`\n        <div style="margin-bottom:20px;">\n          <label style="display:block;font-size:13px;color:var(--color-text-secondary,#a0a0a0);margin-bottom:6px;">Oppdater kontrolldatoer</label>\n          ${s}\n        </div>\n      `:""}\n      <div style="display:flex;gap:12px;justify-content:flex-end;">\n        <button id="bmvCancel" style="padding:12px 24px;font-size:15px;font-weight:600;border-radius:10px;border:1px solid var(--color-border,#333);background:var(--color-bg-tertiary,#252525);color:var(--color-text-primary,#fff);cursor:pointer;">Avbryt</button>\n        <button id="bmvConfirm" style="padding:12px 24px;font-size:15px;font-weight:600;border-radius:10px;border:none;background:var(--color-accent,#5E81AC);color:#fff;cursor:pointer;">Marker besøkt</button>\n      </div>\n    </div>\n  `,document.body.appendChild(o);const r=e=>{"Escape"===e.key&&i()},i=()=>{document.removeEventListener("keydown",r),o.remove()};o.addEventListener("click",e=>{e.target===o&&i()}),document.addEventListener("keydown",r),o.querySelector("#bmvCancel").addEventListener("click",i),o.querySelector("#bmvConfirm").addEventListener("click",async()=>{const t=o.querySelector("#bmvConfirm");if(t.disabled)return;t.disabled=!0,t.textContent="Oppdaterer...";const n=normalizeDateValue(document.getElementById("bmvDate").value),a=Array.from(o.querySelectorAll(".bmv-kontroll-cb:checked")).map(e=>e.dataset.slug);i();try{const t=await apiFetch("/api/kunder/mark-visited",{method:"POST",body:JSON.stringify({kunde_ids:e,visited_date:n,service_type_slugs:a})}),s=await t.json();t.ok&&s.success?(showNotification(`${s.data.updated} kunder markert som besøkt`),await loadCustomers()):showNotification("string"==typeof s.error?s.error:"Kunne ikke markere som besøkt","error")}catch(e){console.error("Feil ved bulk avhuking:",e),showNotification("Feil ved oppdatering","error")}})}function filterCustomers(){applyFilters()}async function geocodeAddress(e,t,n){const a=`${e}, ${t||""} ${n||""}`.trim();try{const e=await fetch(`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(a)}&fuzzy=true&treffPerSide=1`);if(e.ok){const t=await e.json();if(t.adresser&&t.adresser.length>0){const e=t.adresser[0];return{lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon,formatted:`${e.adressetekst}, ${e.postnummer} ${e.poststed}`}}}const t=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(a)}&format=json&countrycodes=no&limit=1`);if(t.ok){const e=await t.json();if(e.length>0)return{lat:Number.parseFloat(e[0].lat),lng:Number.parseFloat(e[0].lon),formatted:e[0].display_name}}return null}catch(e){return console.error("Geocoding feil:",e),null}}function debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}window.quickMarkVisited=quickMarkVisited,window.bulkMarkVisited=bulkMarkVisited;let addressSearchController=null;async function searchAddresses(e){if(!e||e.length<3)return[];addressSearchController&&addressSearchController.abort(),addressSearchController=new AbortController;try{const t=`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(e)}&fuzzy=true&treffPerSide=5`,n=await fetch(t,{signal:addressSearchController.signal}),a=await n.json();return a.adresser&&a.adresser.length>0?a.adresser.map(e=>({adresse:e.adressetekst,postnummer:e.postnummer,poststed:e.poststed,lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon,kommune:e.kommunenavn||""})):[]}catch(e){return"AbortError"===e.name||console.error("Adressesøk feilet:",e),[]}}async function lookupPostnummer(e){if(!/^\d{4}$/.test(e))return null;try{const t=`https://api.bring.com/shippingguide/api/postalCode.json?clientUrl=elkontroll&country=NO&pnr=${e}`,n=await fetch(t),a=await n.json();return a.valid?a.result:null}catch(e){return console.error("Postnummer-oppslag feilet:",e),null}}function renderAddressSuggestions(e){const t=document.getElementById("addressSuggestions");if(!t)return;const n=document.getElementById("adresse");if(!e||0===e.length)return t.innerHTML="",t.classList.remove("visible"),void(n&&n.setAttribute("aria-expanded","false"));t.setAttribute("role","listbox"),t.setAttribute("id","addressSuggestionsList"),t.innerHTML=e.map((e,t)=>`\n    <div class="address-suggestion-item" role="option" data-index="${t}">\n      <i class="fas fa-map-marker-alt"></i>\n      <div class="address-suggestion-text">\n        <div class="address-suggestion-main">${escapeHtml(e.adresse)}</div>\n        <div class="address-suggestion-detail">${escapeHtml(e.postnummer)} ${escapeHtml(e.poststed)}${e.kommune?`, ${escapeHtml(e.kommune)}`:""}</div>\n      </div>\n    </div>\n  `).join(""),t.classList.add("visible"),n&&n.setAttribute("aria-expanded","true")}function selectAddressSuggestion(e){const t=document.getElementById("adresse"),n=document.getElementById("postnummer"),a=document.getElementById("poststed"),s=document.getElementById("lat"),o=document.getElementById("lng"),r=document.getElementById("addressSuggestions");t&&(t.value=e.adresse),n&&(n.value=e.postnummer),a&&(a.value=e.poststed,a.classList.add("auto-filled")),s&&(s.value=e.lat.toFixed(6)),o&&(o.value=e.lng.toFixed(6)),updateGeocodeQualityBadge("exact"),r&&r.classList.remove("visible"),t&&t.setAttribute("aria-expanded","false"),updatePostnummerStatus("valid"),showNotification(`Adresse valgt: ${e.adresse}, ${e.postnummer} ${e.poststed}`)}function updatePostnummerStatus(e){const t=document.getElementById("postnummerStatus");if(t)switch(t.className="postnummer-status",e){case"valid":t.innerHTML='<i class="fas fa-check"></i>',t.classList.add("valid");break;case"invalid":t.innerHTML='<i class="fas fa-times"></i>',t.classList.add("invalid");break;case"loading":t.innerHTML='<i class="fas fa-spinner fa-spin"></i>',t.classList.add("loading");break;default:t.innerHTML=""}}let addressSuggestions=[],selectedSuggestionIndex=-1;function resetAddressAutocomplete(){addressSuggestions=[],selectedSuggestionIndex=-1,addressSearchController&&(addressSearchController.abort(),addressSearchController=null);const e=document.getElementById("addressSuggestions");e&&(e.innerHTML="",e.classList.remove("visible"));const t=document.getElementById("adresse");t&&t.setAttribute("aria-expanded","false")}function setupAddressAutocomplete(){const e=document.getElementById("adresse"),t=document.getElementById("postnummer"),n=document.getElementById("poststed"),a=document.getElementById("addressSuggestions");if(!e||!a)return;e.setAttribute("role","combobox"),e.setAttribute("aria-autocomplete","list"),e.setAttribute("aria-expanded","false"),e.setAttribute("aria-controls","addressSuggestionsList");const s=debounce(async t=>{if(t.length<3)return a.classList.remove("visible"),void e.setAttribute("aria-expanded","false");addressSuggestions=await searchAddresses(t),selectedSuggestionIndex=-1,renderAddressSuggestions(addressSuggestions)},300);e.addEventListener("input",e=>{s(e.target.value)}),e.addEventListener("keydown",t=>{if(!a.classList.contains("visible"))return;const n=a.querySelectorAll(".address-suggestion-item");switch(t.key){case"ArrowDown":t.preventDefault(),selectedSuggestionIndex=Math.min(selectedSuggestionIndex+1,n.length-1),updateSelectedSuggestion(n);break;case"ArrowUp":t.preventDefault(),selectedSuggestionIndex=Math.max(selectedSuggestionIndex-1,-1),updateSelectedSuggestion(n);break;case"Enter":selectedSuggestionIndex>=0&&addressSuggestions[selectedSuggestionIndex]&&(t.preventDefault(),selectAddressSuggestion(addressSuggestions[selectedSuggestionIndex]));break;case"Escape":a.classList.remove("visible"),e.setAttribute("aria-expanded","false"),selectedSuggestionIndex=-1}}),a.addEventListener("click",e=>{const t=e.target.closest(".address-suggestion-item");if(t){const e=parseInt(t.dataset.index,10);addressSuggestions[e]&&selectAddressSuggestion(addressSuggestions[e])}}),document.addEventListener("click",t=>{t.target.closest(".address-autocomplete-wrapper")||(a.classList.remove("visible"),e.setAttribute("aria-expanded","false"))}),t&&n&&t.addEventListener("input",async e=>{const a=e.target.value.replace(/\D/g,"").slice(0,4);if(e.target.value=a,n.classList.remove("auto-filled"),updatePostnummerStatus(""),4===a.length){const e=a;updatePostnummerStatus("loading");const s=await lookupPostnummer(a);t.value===e&&s?(n.value&&!n.classList.contains("auto-filled")||(n.value=s,n.classList.add("auto-filled")),updatePostnummerStatus("valid")):t.value!==e||s||updatePostnummerStatus("invalid")}})}function updateSelectedSuggestion(e){e.forEach((e,t)=>{t===selectedSuggestionIndex?(e.classList.add("selected"),e.scrollIntoView({block:"nearest"})):e.classList.remove("selected")})}async function planRoute(){if(!appConfig.orsApiKeyConfigured)return void showMessage("Ruteplanlegging er ikke konfigurert. Kontakt administrator.","warning");const e=customers.filter(e=>selectedCustomers.has(e.id)&&e.lat&&e.lng);if(e.length<1)return void showMessage("Velg minst 1 kunde med gyldige koordinater","warning");planRouteBtn.classList.add("loading"),planRouteBtn.disabled=!0;const t=[appConfig.routeStartLng||17.65274,appConfig.routeStartLat||69.06888];try{const n={"Content-Type":"application/json"},a=getCsrfToken();a&&(n["X-CSRF-Token"]=a);const s=await fetch("/api/routes/optimize",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({jobs:e.map((e,t)=>({id:t+1,location:[e.lng,e.lat],service:1800})),vehicles:[{id:1,profile:"driving-car",start:t,end:t}]})});if(!s.ok)return showMessage("Ruteoptimering ikke tilgjengelig, bruker enkel rute","info"),void await planSimpleRoute(e);const o=await s.json();if(o.routes&&o.routes.length>0){const t=o.routes[0],n=t.steps.filter(e=>"job"===e.type).map(t=>e[t.job-1]);await drawRoute(n);const a=Math.floor(t.duration/3600),s=Math.floor(t.duration%3600/60),r=(t.distance/1e3).toFixed(1),i=a>0?`${a}t ${s}min`:`${s} min`;showNotification(`Rute beregnet: ${n.length} stopp, ${r} km, ~${i}`)}}catch(e){console.error("Ruteplanlegging feil:",e),await planSimpleRoute(customers.filter(e=>selectedCustomers.has(e.id)&&e.lat&&e.lng))}finally{planRouteBtn.classList.remove("loading"),planRouteBtn.disabled=!1}}async function planSimpleRoute(e){try{const t=[appConfig.routeStartLng||17.65274,appConfig.routeStartLat||69.06888],n=[appConfig.routeStartLat||69.06888,appConfig.routeStartLng||17.65274],a=[t,...e.map(e=>[e.lng,e.lat]),t],s={"Content-Type":"application/json"},o=getCsrfToken();o&&(s["X-CSRF-Token"]=o);const r=await fetch("/api/routes/directions",{method:"POST",headers:s,credentials:"include",body:JSON.stringify({coordinates:a})}),i=await r.json();if(!r.ok){if(i.error&&i.error.message){if(i.error.message.includes("Could not find routable point"))throw new Error("En eller flere kunder har koordinater som ikke er nær en vei. Velg andre kunder eller oppdater koordinatene.");throw new Error(i.error.message)}throw new Error("Kunne ikke beregne rute")}const l=i.data||i;if(l.features&&l.features.length>0){const t=l.features[0];drawRouteFromGeoJSON(t);const a=L.divIcon({className:"route-marker route-start",html:'<i class="fas fa-home"></i>',iconSize:[30,30],iconAnchor:[15,15]}),s=L.marker(n,{icon:a}).addTo(map);s.bindPopup(`<strong>Start:</strong><br>${appConfig.routeStartAddress||"Brøstadveien 343"}`),routeMarkers.push(s),e.forEach((e,t)=>{const n=L.divIcon({className:"route-marker",html:`${t+1}`,iconSize:[30,30],iconAnchor:[15,15]}),a=L.marker([e.lat,e.lng],{icon:n}).addTo(map);routeMarkers.push(a)});const o=[n,...e.map(e=>[e.lat,e.lng])],r=L.latLngBounds(o);map.fitBounds(r,{padding:[50,50]});let i=t.properties?.summary?.duration||0,d=t.properties?.summary?.distance||0;if(0===i&&t.properties?.segments?.length>0)for(const e of t.properties.segments)i+=e.duration||0,d+=e.distance||0;const c=Math.floor(i/3600),u=Math.floor(i%3600/60),m=(d/1e3).toFixed(1),p=c>0?`${c}t ${u}min`:`${u} min`;showNotification(`Rute beregnet: ${e.length} stopp, ${m} km, ~${p}`)}}catch(e){console.error("Enkel rute feil:",e),showMessage(e.message||"Kunne ikke beregne rute.","error")}}async function drawRoute(e){clearRoute();const t=[appConfig.routeStartLng||17.65274,appConfig.routeStartLat||69.06888],n=[appConfig.routeStartLat||69.06888,appConfig.routeStartLng||17.65274],a=[t,...e.map(e=>[e.lng,e.lat]),t];try{const e={"Content-Type":"application/json"},t=getCsrfToken();t&&(e["X-CSRF-Token"]=t);const n=await fetch("/api/routes/directions",{method:"POST",headers:e,credentials:"include",body:JSON.stringify({coordinates:a})}),s=await n.json(),o=s.data||s;o.features&&o.features.length>0&&drawRouteFromGeoJSON(o.features[0])}catch(e){console.error("Tegning av rute feil:",e)}const s=L.divIcon({className:"route-marker route-start",html:'<i class="fas fa-home"></i>',iconSize:[30,30],iconAnchor:[15,15]}),o=L.marker(n,{icon:s}).addTo(map);o.bindPopup(`<strong>Start:</strong><br>${appConfig.routeStartAddress||"Brøstadveien 343"}`),routeMarkers.push(o),e.forEach((e,t)=>{const n=L.divIcon({className:"route-marker",html:`${t+1}`,iconSize:[30,30],iconAnchor:[15,15]}),a=L.marker([e.lat,e.lng],{icon:n}).addTo(map);routeMarkers.push(a)});const r=[n,...e.map(e=>[e.lat,e.lng])],i=L.latLngBounds(r);map.fitBounds(i,{padding:[50,50]})}function drawRouteFromGeoJSON(e){if(clearRoute(),e&&e.geometry&&e.geometry.coordinates){const t=e.geometry.coordinates.map(e=>[e[1],e[0]]);routeLayer=L.polyline(t,{color:"#2563eb",weight:6,opacity:.9,lineCap:"round",lineJoin:"round"}).addTo(map),routeLayer.bringToFront()}}function clearRoute(){routeLayer&&(map.removeLayer(routeLayer),routeLayer=null),routeMarkers.forEach(e=>map.removeLayer(e)),routeMarkers=[]}let currentRouteData=null;function navigateToCustomer(e,t,n){const a=/iPad|iPhone|iPod/.test(navigator.userAgent),s=appConfig.routeStartLat||69.06888,o=appConfig.routeStartLng||17.65274;if(a){const n=`https://maps.apple.com/?saddr=${s},${o}&daddr=${e},${t}&dirflg=d`;window.open(n,"_blank")}else{const n=`https://www.google.com/maps/dir/?api=1&origin=${s},${o}&destination=${e},${t}&travelmode=driving`;window.open(n,"_blank")}map.closePopup()}let emailDialogState={kundeId:null,templates:[],selectedTemplateId:null};async function openEmailDialog(e){const t=customers.find(t=>t.id===e);if(t)if(t.epost){emailDialogState.kundeId=e;try{const e=await apiFetch("/api/customer-emails/templates");emailDialogState.templates=e.data||[]}catch{return void showNotification("Kunne ikke hente e-postmaler","error")}renderEmailDialog(t)}else showNotification("Kunden har ingen e-postadresse","error");else showNotification("Kunde ikke funnet","error")}function renderEmailDialog(e){const t=document.querySelector(".email-dialog-overlay");t&&t.remove();const n=emailDialogState.templates,a=n[0];emailDialogState.selectedTemplateId=a?.id||null;const s=document.createElement("div");s.className="email-dialog-overlay",s.innerHTML=`\n    <div class="email-dialog">\n      <div class="email-dialog-header">\n        <h3><i class="fas fa-envelope"></i> Send e-post</h3>\n        <button class="email-dialog-close" onclick="closeEmailDialog()"><i class="fas fa-times"></i></button>\n      </div>\n      <div class="email-dialog-body">\n        <div class="email-dialog-recipient">\n          <label>Til:</label>\n          <span>${escapeHtml(e.navn)} &lt;${escapeHtml(e.epost)}&gt;</span>\n        </div>\n\n        <div class="email-dialog-field">\n          <label for="emailTemplateSelect">Velg mal:</label>\n          <select id="emailTemplateSelect" class="email-dialog-select" onchange="onEmailTemplateChange()">\n            ${n.map(e=>`<option value="${e.id}">${escapeHtml(e.name)} (${escapeHtml(e.category)})</option>`).join("")}\n          </select>\n        </div>\n\n        <div id="emailCustomFields" class="email-dialog-custom-fields" style="display:none">\n          <div class="email-dialog-field">\n            <label for="emailCustomSubject">Emne:</label>\n            <input id="emailCustomSubject" type="text" class="email-dialog-input" placeholder="Skriv emne...">\n          </div>\n          <div class="email-dialog-field">\n            <label for="emailCustomMessage">Melding:</label>\n            <textarea id="emailCustomMessage" class="email-dialog-textarea" rows="4" placeholder="Skriv melding..."></textarea>\n          </div>\n        </div>\n\n        <div class="email-dialog-preview-section">\n          <button class="email-dialog-preview-btn" onclick="previewEmail()">\n            <i class="fas fa-eye"></i> Forhåndsvis\n          </button>\n          <div id="emailPreviewContainer" class="email-preview-container" style="display:none">\n            <div class="email-preview-subject" id="emailPreviewSubject"></div>\n            <iframe id="emailPreviewFrame" class="email-preview-frame"></iframe>\n          </div>\n        </div>\n      </div>\n      <div class="email-dialog-footer">\n        <button class="btn btn-secondary" onclick="closeEmailDialog()">Avbryt</button>\n        <button class="btn btn-primary email-send-btn" onclick="sendEmailFromDialog()">\n          <i class="fas fa-paper-plane"></i> Send e-post\n        </button>\n      </div>\n    </div>\n  `,document.body.appendChild(s),s.addEventListener("click",e=>{e.target===s&&closeEmailDialog()}),onEmailTemplateChange()}function onEmailTemplateChange(){const e=document.getElementById("emailTemplateSelect");if(!e)return;emailDialogState.selectedTemplateId=Number(e.value);const t=emailDialogState.templates.find(e=>e.id===emailDialogState.selectedTemplateId),n=document.getElementById("emailCustomFields");n&&(n.style.display="generell"===t?.category?"block":"none");const a=document.getElementById("emailPreviewContainer");a&&(a.style.display="none")}async function previewEmail(){if(!emailDialogState.selectedTemplateId||!emailDialogState.kundeId)return;const e={},t=emailDialogState.templates.find(e=>e.id===emailDialogState.selectedTemplateId);if("generell"===t?.category){const t=document.getElementById("emailCustomSubject"),n=document.getElementById("emailCustomMessage");t&&(e.emne=t.value),n&&(e.melding=n.value)}try{const t=await apiFetch("/api/customer-emails/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:emailDialogState.selectedTemplateId,kunde_id:emailDialogState.kundeId,custom_variables:e})}),n=document.getElementById("emailPreviewContainer"),a=document.getElementById("emailPreviewSubject"),s=document.getElementById("emailPreviewFrame");if(n&&a&&s){n.style.display="block",a.textContent=`Emne: ${t.data.subject}`;const e=s.contentDocument||s.contentWindow.document;e.open(),e.write(t.data.html),e.close()}}catch{showNotification("Kunne ikke generere forhåndsvisning","error")}}async function sendEmailFromDialog(){if(!emailDialogState.selectedTemplateId||!emailDialogState.kundeId)return;const e=document.querySelector(".email-send-btn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sender...');const t={},n=emailDialogState.templates.find(e=>e.id===emailDialogState.selectedTemplateId);if("generell"===n?.category){const n=document.getElementById("emailCustomSubject"),a=document.getElementById("emailCustomMessage");if(n&&(t.emne=n.value),a&&(t.melding=a.value),!t.emne||!t.melding)return showNotification("Fyll inn emne og melding","error"),void(e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-paper-plane"></i> Send e-post'))}try{await apiFetch("/api/customer-emails/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:emailDialogState.selectedTemplateId,kunde_id:emailDialogState.kundeId,custom_variables:t})}),showNotification("E-post sendt!","success"),closeEmailDialog(),await loadCustomers()}catch(t){showNotification(t.message||"Kunne ikke sende e-post","error"),e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-paper-plane"></i> Send e-post')}}function closeEmailDialog(){const e=document.querySelector(".email-dialog-overlay");e&&e.remove(),emailDialogState={kundeId:null,templates:[],selectedTemplateId:null}}function renderOverdue(){const e=document.getElementById("overdueContainer"),t=document.getElementById("overdueCountHeader"),n=document.getElementById("overdueSortSelect"),a=n?.value||"proximity",s=new Date;s.setHours(0,0,0,0);const o=12*s.getFullYear()+s.getMonth();let r=customers.filter(e=>{const t=getNextControlDate(e);if(!t)return!1;return 12*t.getFullYear()+t.getMonth()<o});r=r.map(e=>{const t=getNextControlDate(e),n=Math.ceil((s-t)/864e5);return{...e,daysOverdue:n,_controlDate:t}}),"days"===a?r.sort((e,t)=>e.daysOverdue-t.daysOverdue):"days-desc"===a?r.sort((e,t)=>t.daysOverdue-e.daysOverdue):"name"===a?sortByNavn(r):"category"===a?r.sort((e,t)=>{const n=e.kategori||"Annen",a=t.kategori||"Annen";return n!==a?compareNorwegian(n,a):e.daysOverdue-t.daysOverdue}):"area"===a&&r.sort((e,t)=>{const n=e.poststed||"Ukjent",a=t.poststed||"Ukjent";return n!==a?compareNorwegian(n,a):e.daysOverdue-t.daysOverdue}),updateBadge("overdueBadge",r.length),t&&(t.textContent=r.length>0?`(${r.length} stk)`:"");let i="";if(0===r.length)i='\n      <div class="overdue-empty">\n        <i class="fas fa-check-circle"></i>\n        <p>Ingen forfalte kontroller</p>\n        <span>Bra jobba!</span>\n      </div>\n    ';else{const e=r.filter(e=>e.daysOverdue>60),t=r.filter(e=>e.daysOverdue>30&&e.daysOverdue<=60),n=r.filter(e=>e.daysOverdue<=30),s=(e,t,n)=>0===t.length?"":`\n        <div class="overdue-section overdue-${n}">\n          <div class="overdue-section-header">\n            <span class="overdue-severity-dot ${n}"></span>\n            ${e} (${t.length})\n          </div>\n          ${t.map(e=>`\n            <div class="overdue-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n              <div class="overdue-customer-info">\n                <div class="overdue-customer-main">\n                  <h4>${escapeHtml(e.navn)}</h4>\n                  <span class="overdue-category">${escapeHtml(e.kategori||"Ukjent")}</span>\n                </div>\n                <p class="overdue-address">${escapeHtml(e.adresse)}, ${escapeHtml(e.poststed||"")}</p>\n                ${e.telefon?`<a href="tel:${e.telefon}" class="overdue-phone" onclick="event.stopPropagation();"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</a>`:""}\n              </div>\n              <div class="overdue-status">\n                <span class="overdue-days">${e.daysOverdue} dager</span>\n                <span class="overdue-date">${formatDate(e._controlDate)}</span>\n                <button class="btn-remind" data-action="sendReminder" data-customer-id="${e.id}" title="Send påminnelse">\n                  <i class="fas fa-envelope"></i>\n                </button>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      `,o=e=>e.map(e=>{const t=e.kategori||"",n=t?`<span class="overdue-kat-badge ${t.includes("El")?"kat-el":t.includes("Brann")?"kat-brann":"kat-other"}">${escapeHtml(t)}</span>`:"";return`\n        <div class="overdue-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n          <div class="overdue-customer-info">\n            <div class="overdue-customer-main">\n              <h4>${escapeHtml(e.navn)}</h4>\n              ${n}\n              <span class="overdue-days-inline ${e.daysOverdue>60?"critical":e.daysOverdue>30?"warning":"mild"}">${e.daysOverdue}d forfalt</span>\n            </div>\n            <p class="overdue-address">${escapeHtml(e.adresse)}, ${escapeHtml(e.poststed||"")}</p>\n            ${e.telefon?`<a href="tel:${e.telefon}" class="overdue-phone" onclick="event.stopPropagation();"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</a>`:""}\n          </div>\n          <div class="overdue-status">\n            <span class="overdue-date">${formatDate(e._controlDate)}</span>\n            <button class="btn-remind" data-action="sendReminder" data-customer-id="${e.id}" title="Send påminnelse">\n              <i class="fas fa-envelope"></i>\n            </button>\n            <button class="btn-wp-single" data-action="addGroupToWeekPlan" data-customer-ids="${e.id}" title="Legg til i ukeplan">\n              <i class="fas fa-calendar-plus"></i>\n            </button>\n          </div>\n        </div>\n      `}).join(""),l=e=>{const t={};return e.forEach(e=>{const n=e.kategori||"Annen";t[n]=(t[n]||0)+1}),Object.entries(t).map(([e,t])=>`<span class="overdue-kat-badge ${e.includes("El")?"kat-el":e.includes("Brann")?"kat-brann":"kat-other"}">${t} ${escapeHtml(e)}</span>`).join("")};if("category"===a){const e={};r.forEach(t=>{const n=t.kategori||"Annen";e[n]||(e[n]=[]),e[n].push(t)}),Object.keys(e).sort((e,t)=>e.localeCompare(t,"no")).forEach(t=>{const n=e[t].map(e=>e.id).join(",");i+=`\n          <div class="overdue-section">\n            <div class="overdue-section-header">\n              <i class="fas fa-folder"></i>\n              ${escapeHtml(t)} (${e[t].length})\n              <button class="btn-group-route" data-action="createRouteFromGroup" data-customer-ids="${n}" title="Lag rute for denne gruppen">\n                <i class="fas fa-route"></i>\n              </button>\n              <button class="btn-group-weekplan" data-action="addGroupToWeekPlan" data-customer-ids="${n}" title="Legg til i ukeplan">\n                <i class="fas fa-calendar-plus"></i>\n              </button>\n            </div>\n            ${o(e[t])}\n          </div>\n        `})}else if("area"===a){const e={};r.forEach(t=>{const n=t.poststed||"Ukjent område";e[n]||(e[n]=[]),e[n].push(t)}),Object.keys(e).sort(compareNorwegian).forEach(t=>{const n=e[t].map(e=>e.id).join(",");i+=`\n          <div class="overdue-section overdue-area-section">\n            <div class="overdue-section-header">\n              <i class="fas fa-map-marker-alt"></i>\n              ${escapeHtml(t)} (${e[t].length})\n              <button class="btn-group-route" data-action="createRouteFromGroup" data-customer-ids="${n}" title="Lag rute for ${escapeHtml(t)}">\n                <i class="fas fa-route"></i>\n              </button>\n              <button class="btn-group-map" data-action="showGroupOnMap" data-customer-ids="${n}" title="Vis på kart">\n                <i class="fas fa-map"></i>\n              </button>\n              <button class="btn-group-weekplan" data-action="addGroupToWeekPlan" data-customer-ids="${n}" title="Legg til i ukeplan">\n                <i class="fas fa-calendar-plus"></i>\n              </button>\n            </div>\n            <div class="overdue-type-summary">${l(e[t])}</div>\n            ${o(e[t])}\n          </div>\n        `})}else if("proximity"===a){const{clusters:e,noise:t,summary:n}=clusterCustomersByProximity(r),a=1===r.length?"kunde":"kunder",s=[];if(n.clusterCount>0&&s.push(`${n.clusterCount} ${1===n.clusterCount?"område":"områder"}`),n.noiseCount>0&&s.push(`${n.noiseCount} ${1===n.noiseCount?"spredt":"spredte"}`),i+=`\n        <div class="proximity-summary">\n          <i class="fas fa-layer-group"></i>\n          <span>${r.length} ${a} fordelt på ${s.join(" + ")}</span>\n        </div>\n      `,e.forEach((e,t)=>{e.customers.sort((e,t)=>t.daysOverdue-e.daysOverdue);const n=e.customers.map(e=>e.id).join(","),a=1===e.customers.length?"kunde":"kunder",s=e.radiusKm<1?`~${Math.round(1e3*e.radiusKm)}m`:`~${e.radiusKm.toFixed(1)} km`,r=e.customers.filter(e=>e.daysOverdue>60).length,d=e.customers.filter(e=>e.daysOverdue>30&&e.daysOverdue<=60).length,c=e.customers.filter(e=>e.daysOverdue<=30).length;let u="";r>0&&(u+=`<span class="proximity-severity critical">${r} kritisk</span>`),d>0&&(u+=`<span class="proximity-severity warning">${d} advarsel</span>`),c>0&&(u+=`<span class="proximity-severity mild">${c} ny</span>`);i+=`\n          <div class="overdue-section overdue-proximity-section ${r>0?"severity-critical":d>0?"severity-warning":"severity-mild"}">\n            <div class="overdue-section-header">\n              <span class="proximity-number">${t+1}</span>\n              <i class="fas fa-map-pin"></i>\n              ${escapeHtml(e.areaName)}\n              <span class="proximity-meta">${e.customers.length} ${a}, ${s}</span>\n              ${u}\n              <button class="btn-group-route" data-action="createRouteFromGroup" data-customer-ids="${n}" title="Lag rute for denne klyngen">\n                <i class="fas fa-route"></i>\n              </button>\n              <button class="btn-group-map" data-action="showGroupOnMap" data-customer-ids="${n}" title="Vis på kart">\n                <i class="fas fa-map"></i>\n              </button>\n              <button class="btn-group-weekplan" data-action="addGroupToWeekPlan" data-customer-ids="${n}" title="Legg til i ukeplan">\n                <i class="fas fa-calendar-plus"></i>\n              </button>\n            </div>\n            <div class="overdue-type-summary">${l(e.customers)}</div>\n            ${o(e.customers)}\n          </div>\n        `}),t.length>0){t.sort((e,t)=>(t.daysOverdue||0)-(e.daysOverdue||0));const e=t.filter(e=>e.id).map(e=>e.id).join(","),n=1===t.length?"kunde":"kunder";i+=`\n          <div class="overdue-section overdue-noise-section">\n            <div class="overdue-section-header">\n              <i class="fas fa-map-marker-alt"></i>\n              Spredte ${n} (${t.length})\n              ${e?`<button class="btn-group-map" data-action="showGroupOnMap" data-customer-ids="${e}" title="Vis på kart"><i class="fas fa-map"></i></button>`:""}\n              ${e?`<button class="btn-group-weekplan" data-action="addGroupToWeekPlan" data-customer-ids="${e}" title="Legg til i ukeplan"><i class="fas fa-calendar-plus"></i></button>`:""}\n            </div>\n            ${o(t)}\n          </div>\n        `}}else"days"===a?(i+=s("Nylig forfalt (1-30 dager)",n,"mild"),i+=s("Advarsel (31-60 dager)",t,"warning"),i+=s("Kritisk (over 60 dager)",e,"critical")):(i+=s("Kritisk (over 60 dager)",e,"critical"),i+=s("Advarsel (31-60 dager)",t,"warning"),i+=s("Nylig forfalt (1-30 dager)",n,"mild"))}e.innerHTML=i;const l=document.getElementById("overdueProximitySettings");l&&(l.style.display="proximity"===a?"":"none")}function updateOverdueBadge(){const e=new Date;e.setHours(0,0,0,0);const t=12*e.getFullYear()+e.getMonth();updateBadge("overdueBadge",customers.filter(e=>{const n=getNextControlDate(e);if(!n)return!1;return 12*n.getFullYear()+n.getMonth()<t}).length),updateUpcomingBadge()}function updateUpcomingBadge(){const e=new Date;e.setHours(0,0,0,0);const t=12*e.getFullYear()+e.getMonth(),n=new Date(e);n.setDate(n.getDate()+30);updateBadge("upcomingBadge",customers.filter(e=>{const a=getNextControlDate(e);if(!a)return!1;return 12*a.getFullYear()+a.getMonth()>=t&&a<=n}).length)}function renderWarnings(){const e=document.getElementById("warningsContainer"),t=document.getElementById("warningSortSelect"),n=t?.value||"proximity",a=new Date;a.setHours(0,0,0,0);const s=new Date(a);s.setDate(s.getDate()+30);const o=12*a.getFullYear()+a.getMonth(),r=customers.filter(e=>{const t=getNextControlDate(e);if(!t)return!1;return 12*t.getFullYear()+t.getMonth()>=o&&t<=s}).map(e=>({...e,_nextDate:getNextControlDate(e)})),i=e=>{const t=getControlStatus(e),n=Math.ceil((e._nextDate-a)/864e5),s=e._nextDate.toISOString().split("T")[0],o=e.kategori||"",r=o?`<span class="overdue-kat-badge ${o.includes("El")?"kat-el":o.includes("Brann")?"kat-brann":"kat-other"}">${escapeHtml(o)}</span>`:"";return`\n      <div class="warning-item" data-action="focusOnCustomer" data-customer-id="${e.id}">\n        <div class="warning-customer">\n          <h4>${escapeHtml(e.navn)} ${r}</h4>\n          <p>${escapeHtml(e.adresse)} (${escapeHtml(e.postnummer)})</p>\n        </div>\n        <div class="warning-date">\n          <span class="control-status ${t.class}">${n<0?Math.abs(n)+" dager over":n+" dager"}</span>\n          <p style="font-size: 10px; color: #666; margin: 2px 0 0 0;">${escapeHtml(s)}</p>\n          <button class="btn-wp-single" data-action="addGroupToWeekPlan" data-customer-ids="${e.id}" title="Legg til i ukeplan">\n            <i class="fas fa-calendar-plus"></i>\n          </button>\n        </div>\n      </div>\n    `};let l="";if(0===r.length)l='<p style="padding: 20px; text-align: center; color: #666;">Ingen kommende kontroller</p>';else if("proximity"===n){const{clusters:e,noise:t,summary:n}=clusterCustomersByProximity(r),a=1===r.length?"kunde":"kunder",s=[];if(n.clusterCount>0&&s.push(`${n.clusterCount} ${1===n.clusterCount?"område":"områder"}`),n.noiseCount>0&&s.push(`${n.noiseCount} ${1===n.noiseCount?"spredt":"spredte"}`),l+=`\n      <div class="proximity-summary">\n        <i class="fas fa-layer-group"></i>\n        <span>${r.length} ${a} fordelt på ${s.join(" + ")}</span>\n      </div>\n    `,e.forEach((e,t)=>{e.customers.sort((e,t)=>e._nextDate-t._nextDate);const n=e.customers.map(e=>e.id).join(","),a=1===e.customers.length?"kunde":"kunder",s=e.radiusKm<1?`~${Math.round(1e3*e.radiusKm)}m`:`~${e.radiusKm.toFixed(1)} km`;l+=`<div class="warning-section overdue-proximity-section">\n        <div class="warning-header proximity-header">\n          <span class="proximity-number">${t+1}</span>\n          <i class="fas fa-map-pin"></i>\n          ${escapeHtml(e.areaName)}\n          <span class="proximity-meta">${e.customers.length} ${a}, ${s}</span>\n          <button class="btn-group-route" data-action="createRouteFromGroup" data-customer-ids="${n}" title="Lag rute for denne klyngen">\n            <i class="fas fa-route"></i>\n          </button>\n          <button class="btn-group-map" data-action="showGroupOnMap" data-customer-ids="${n}" title="Vis på kart">\n            <i class="fas fa-map"></i>\n          </button>\n          <button class="btn-group-weekplan" data-action="addGroupToWeekPlan" data-customer-ids="${n}" title="Legg til i ukeplan">\n            <i class="fas fa-calendar-plus"></i>\n          </button>\n        </div>\n        <div class="overdue-type-summary">${(e=>{const t={};return e.forEach(e=>{const n=e.kategori||"Annen";t[n]=(t[n]||0)+1}),Object.entries(t).map(([e,t])=>`<span class="overdue-kat-badge ${e.includes("El")?"kat-el":e.includes("Brann")?"kat-brann":"kat-other"}">${t} ${escapeHtml(e)}</span>`).join("")})(e.customers)}</div>\n        ${e.customers.map(i).join("")}\n      </div>`}),t.length>0){t.sort((e,t)=>(e._nextDate||0)-(t._nextDate||0));const e=t.filter(e=>e.id).map(e=>e.id).join(","),n=1===t.length?"kunde":"kunder";l+=`<div class="warning-section overdue-noise-section">\n        <div class="warning-header proximity-header">\n          <i class="fas fa-map-marker-alt"></i>\n          Spredte ${n} (${t.length})\n          ${e?`<button class="btn-group-map" data-action="showGroupOnMap" data-customer-ids="${e}" title="Vis på kart"><i class="fas fa-map"></i></button>`:""}\n          ${e?`<button class="btn-group-weekplan" data-action="addGroupToWeekPlan" data-customer-ids="${e}" title="Legg til i ukeplan"><i class="fas fa-calendar-plus"></i></button>`:""}\n        </div>\n        ${t.map(i).join("")}\n      </div>`}}else{const e={};r.forEach(t=>{const n=t.kategori||"Annen";e[n]||(e[n]=[]),e[n].push(t)}),Object.values(e).forEach(sortByNavn);const t=serviceTypeRegistry.getAll().map(e=>e.name);Object.keys(e).sort((e,n)=>{const a=t.indexOf(e),s=t.indexOf(n);return(-1===a?999:a)-(-1===s?999:s)}).forEach(t=>{l+=`<div class="warning-section">\n        <div class="warning-header">${escapeHtml(t)} (${e[t].length})</div>\n        ${e[t].map(i).join("")}\n      </div>`})}e.innerHTML=l;const d=document.getElementById("warningProximitySettings");d&&(d.style.display="proximity"===n?"":"none")}function formatDateISO(e){const t=e instanceof Date?e:new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function getNextMonday(e){const t=new Date(e),n=t.getDay(),a=0===n?1:8-n;return t.setDate(t.getDate()+a),t}function addDaysToDate(e,t){const n=new Date(e);return n.setDate(n.getDate()+t),n}function getCreatorDisplay(e,t=!1){if(!e||"admin"===e||!e.trim())return"";const n=e.trim().split(/\s+/);return t?n.map(e=>e[0].toUpperCase()).join(""):n.length>1?n[0]+" "+n[1][0].toUpperCase()+".":n[0]}function getUniqueAreas(e){const t=new Map;return e.forEach(e=>{const n=e.kunder?.poststed||e.poststed||null;if(!n)return;t.has(n)||t.set(n,{count:0,customers:[]});const a=t.get(n);a.count++,a.customers.push(e.kunder?.navn||e.kunde_navn||"Ukjent")}),t}function getAreaTooltip(e){const t=getUniqueAreas(e);return Array.from(t.entries()).sort((e,t)=>t[1].count-e[1].count).map(([e,t])=>`${e}: ${t.count}`).join(", ")}function renderAreaBadges(e){const t=getUniqueAreas(e);if(0===t.size)return"";return`\n    <div class="week-day-areas">\n      ${Array.from(t.entries()).sort((e,t)=>t[1].count-e[1].count).map(([e,t])=>`\n        <span class="area-badge" title="${escapeHtml(t.customers.join(", "))}">\n          <i class="fas fa-map-marker-alt"></i> ${escapeHtml(e)} (${t.count})\n        </span>\n      `).join("")}\n    </div>\n  `}const weekDayKeys=["mandag","tirsdag","onsdag","torsdag","fredag"],weekDayLabels=["Mandag","Tirsdag","Onsdag","Torsdag","Fredag"],monthNamesShort=["jan","feb","mar","apr","mai","jun","jul","aug","sep","okt","nov","des"];function formatMinutes(e){if(!e||e<=0)return"";const t=Math.floor(e/60),n=e%60;return 0===t?`${n} min`:n>0?`${t}t ${n}min`:`${t}t`}function formatTimeOfDay(e,t=8,n=0){const a=60*t+n+e,s=Math.floor(a/60),o=a%60;return`${String(s).padStart(2,"0")}:${String(o).padStart(2,"0")}`}function getDayEstimatedTotal(e){const t=weekPlanState.days[e];return t?t.planned.reduce((e,t)=>e+(t.estimertTid||30),0):0}const TEAM_COLORS=["#2563eb","#dc2626","#16a34a","#9333ea","#ea580c","#0891b2","#c026d3","#ca8a04"];let wpFocusedTeamMember=null,wpFocusedMemberIds=null,wpRouteActive=!1,wpRouteStopIds=null;function getWeekTeamMembers(){if(!weekPlanState.days)return[];const e=new Set(weekDayKeys.map(e=>weekPlanState.days[e]?.date).filter(Boolean)),t=new Map,n=localStorage.getItem("userName")||"",a=weekPlanState.globalAssignedTo||n;for(const e of weekDayKeys){const s=weekPlanState.days[e];if(!s||0===s.planned.length)continue;const o=a||n;if(o)for(const e of s.planned){t.has(o)||t.set(o,{initials:getCreatorDisplay(o,!0),count:0,kundeIds:new Set});const n=t.get(o);n.count++,n.kundeIds.add(e.id)}}for(const n of avtaler){if(!e.has(n.dato)||!n.kunde_id)continue;const a=n.opprettet_av&&"admin"!==n.opprettet_av?n.opprettet_av:"";if(!a)continue;t.has(a)||t.set(a,{initials:getCreatorDisplay(a,!0),count:0,kundeIds:new Set});const s=t.get(a);s.kundeIds.has(n.kunde_id)||(s.count++,s.kundeIds.add(n.kunde_id))}const s=Array.from(t.entries()).map(([e,t])=>({name:e,initials:t.initials,count:t.count,kundeIds:t.kundeIds,color:""})).sort((e,t)=>t.count-e.count);return s.forEach((e,t)=>{e.color=TEAM_COLORS[t%TEAM_COLORS.length]}),s}function focusTeamMemberOnMap(e){if(wpFocusedTeamMember===e)return wpFocusedTeamMember=null,wpFocusedMemberIds=null,applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters(),void renderWeeklyPlan();wpFocusedTeamMember=e;const t=getWeekTeamMembers().find(t=>t.name===e);if(!t)return;wpFocusedMemberIds=new Set([...t.kundeIds].map(e=>Number(e)));const n=[];for(const e of wpFocusedMemberIds){const t=markers[e];if(t){const e=t.getLatLng();e&&e.lat&&e.lng&&n.push(e)}}if(n.length>0){const e=L.latLngBounds(n);map.fitBounds(e.pad(.5),{maxZoom:11,padding:[40,40]})}setTimeout(()=>{applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters()},400),renderWeeklyPlan()}function refreshTeamFocus(){if(!wpFocusedTeamMember)return;const e=getWeekTeamMembers().find(e=>e.name===wpFocusedTeamMember);e&&0!==e.kundeIds.size?wpFocusedMemberIds=new Set([...e.kundeIds].map(e=>Number(e))):(wpFocusedTeamMember=null,wpFocusedMemberIds=null),applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters()}function applyTeamFocusToMarkers(){for(const e of Object.keys(markers)){const t=markers[e]?.getElement?.();if(!t)continue;const n=Number(e);wpRouteActive?wpRouteStopIds&&wpRouteStopIds.has(n)?(t.style.opacity="1",t.style.filter="",t.style.pointerEvents=""):(t.style.opacity="0.3",t.style.filter="grayscale(0.8)",t.style.pointerEvents="none"):wpFocusedMemberIds?wpFocusedMemberIds.has(n)?(t.style.opacity="1",t.style.filter="",t.style.pointerEvents=""):(t.style.opacity="0.15",t.style.filter="grayscale(1)",t.style.pointerEvents="none"):(t.style.opacity="",t.style.filter="",t.style.pointerEvents="")}}let weekPlanState={weekStart:null,activeDay:null,days:{},globalAssignedTo:""};function initWeekPlanState(e){const t=new Date(e);t.setHours(0,0,0,0);const n=t.getDay();1!==n&&t.setDate(t.getDate()-(n+6)%7),weekPlanState.weekStart=new Date(t),weekPlanState.days={};for(let e=0;e<5;e++){const n=new Date(t);n.setDate(t.getDate()+e),weekPlanState.days[weekDayKeys[e]]={date:formatDateISO(n),planned:[],assignedTo:""}}}function getWeekPlanTotalPlanned(){let e=0;for(const t of weekDayKeys)e+=weekPlanState.days[t]?.planned?.length||0;return e}let wpTeamMembers=null;async function loadWpTeamMembers(){if(wpTeamMembers)return wpTeamMembers;try{const e=await apiFetch("/api/team-members"),t=await e.json();t.success&&t.data&&(wpTeamMembers=t.data.filter(e=>e.aktiv))}catch(e){}return wpTeamMembers||[]}async function renderWeeklyPlan(){const e=document.getElementById("weeklyPlanContainer");if(!e)return;weekPlanState.weekStart||initWeekPlanState(new Date),0===avtaler.length&&await loadAvtaler();const t=await loadWpTeamMembers(),n=getISOWeekNumber(weekPlanState.weekStart),a=getWeekPlanTotalPlanned(),s=formatDateISO(new Date);let o='<div class="wp-container">';o+=`\n    <div class="wp-header">\n      <button class="btn btn-small btn-secondary" data-action="weekPlanPrev" aria-label="Forrige uke"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>\n      <span class="wp-week-title">Uke ${n}</span>\n      <button class="btn btn-small btn-secondary" data-action="weekPlanNext" aria-label="Neste uke"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>\n    </div>\n  `;if(("admin"===localStorage.getItem("userRole")||"bruker"===localStorage.getItem("userType"))&&t.length>0){const e=weekPlanState.globalAssignedTo||"";o+=`<div class="wp-dispatch-bar">\n      <i class="fas fa-user-hard-hat"></i>\n      <span>Planlegg for:</span>\n      <select class="wp-dispatch-select" id="wpDispatchSelect">\n        <option value="">Meg selv</option>\n        ${t.map(t=>`<option value="${escapeHtml(t.navn)}" ${e===t.navn?"selected":""}>${escapeHtml(t.navn)}</option>`).join("")}\n      </select>\n    </div>`}if(o+='<div class="wp-search-container">\n    <div class="wp-search-wrapper">\n      <i class="fas fa-search wp-search-icon"></i>\n      <input type="text" class="wp-search-input" id="wpCustomerSearch"\n        placeholder="Søk kunde (navn, adresse, sted)..." autocomplete="off">\n    </div>\n    <div class="wp-search-results" id="wpSearchResults"></div>\n  </div>',weekPlanState.activeDay){const e=weekPlanState.globalAssignedTo||"",t=e?` for ${e}`:"";o+=`<div class="wp-status"><i class="fas fa-crosshairs"></i> Dra over kunder på kartet for <strong>${weekDayLabels[weekDayKeys.indexOf(weekPlanState.activeDay)]}</strong>${t}</div>`}else 0===a&&(o+='<div class="wp-status muted"><i class="fas fa-hand-pointer"></i> Velg en dag for å starte</div>');const r=getWeekTeamMembers();if(r.length>0){o+='<div class="wp-team-bar">',o+='<span class="wp-team-label"><i class="fas fa-users"></i></span>';for(const e of r){o+=`<span class="wp-team-chip ${wpFocusedTeamMember===e.name?"active":""}" style="background:${e.color}" data-action="focusTeamMember" data-member-name="${escapeHtml(e.name)}" title="Vis ${escapeHtml(e.name)} på kartet" role="button" tabindex="0">${escapeHtml(e.initials)} <span class="chip-count">${e.count}</span></span>`}wpFocusedTeamMember&&(o+=`<span class="wp-team-chip" style="background:var(--bg-tertiary, #666);font-size:11px;" data-action="focusTeamMember" data-member-name="${escapeHtml(wpFocusedTeamMember)}" title="Vis alle" role="button" tabindex="0"><i class="fas fa-times" aria-hidden="true"></i></span>`),o+="</div>"}const i=new Map(r.map(e=>[e.name,e.color])),l=localStorage.getItem("userName")||"",d=i.get(l)||TEAM_COLORS[0];o+='<div class="wp-days">';for(let e=0;e<5;e++){const t=weekDayKeys[e],n=weekPlanState.days[t],a=n.date,r=new Date(a+"T00:00:00"),c=weekPlanState.activeDay===t,u=s===a,m=avtaler.filter(e=>e.dato===a),p=n.planned.length,g=m.length,f=p>0||g>0;o+=`<div class="wp-day ${c?"active":""} ${u?"today":""}" data-day="${t}" data-action="setActiveDay" role="button" tabindex="0">`;const v=getDayEstimatedTotal(t);if(o+='<div class="wp-day-bar">',o+=`<span class="wp-day-label">${weekDayLabels[e].substring(0,3)}</span>`,o+=`<span class="wp-day-date">${r.getDate()}. ${monthNamesShort[r.getMonth()]}</span>`,p>0&&(o+=`<span class="wp-badge new">${p} ny${p>1?"e":""}</span>`),g>0&&(o+=`<span class="wp-badge existing">${g}</span>`),v>0&&(o+=`<span class="wp-time-badge">~${formatMinutes(v)}</span>`),c&&(o+='<i class="fas fa-crosshairs wp-active-icon"></i>'),o+="</div>",f||c){if(o+='<div class="wp-day-content">',f){const e=getDayEstimatedTotal(t),n=480;o+=`<div class="wp-progress-container">\n          <div class="wp-progress-bar ${e>n?"overloaded":""}" style="width:${Math.min(100,Math.round(e/n*100))}%"></div>\n          <span class="wp-progress-label">${formatMinutes(e)} / 8t</span>\n        </div>`}let e=0,a=1;for(const s of n.planned){const n=[s.adresse,s.postnummer,s.poststed].filter(Boolean).join(", "),r=formatTimeOfDay(e);e+=s.estimertTid||30;const c=formatTimeOfDay(e),u=s.addedBy||l,m=u?getCreatorDisplay(u,!0):"",p=i.get(u)||d;o+=`\n          <div class="wp-item new wp-timeline-item" style="border-left:3px solid ${p}">\n            <span class="wp-stop-badge"><span class="wp-stop-num" style="background:${p}">${a}</span>${m?`<span class="wp-stop-initials" style="background:${p}">${escapeHtml(m)}</span>`:""}</span>\n            <div class="wp-item-main">\n              <span class="wp-item-name">${escapeHtml(s.navn)}</span>\n              ${n?`<span class="wp-item-addr" title="${escapeHtml(n)}">${escapeHtml(n)}</span>`:""}\n              ${s.telefon?`<span class="wp-item-phone"><i class="fas fa-phone" style="font-size:8px;margin-right:3px;"></i>${escapeHtml(s.telefon)}</span>`:""}\n              <span class="wp-item-timerange"><i class="fas fa-clock" style="font-size:8px;margin-right:2px;"></i>${r} - ${c}</span>\n            </div>\n            <div class="wp-item-meta">\n              <input type="number" class="wp-time-input" value="${s.estimertTid||30}" min="5" step="5"\n                data-action="setEstimatedTime" data-day="${t}" data-customer-id="${s.id}">\n              <span>min</span>\n              <button class="wp-remove" data-action="removeFromPlan" data-day="${t}" data-customer-id="${s.id}" title="Fjern" aria-label="Fjern">&times;</button>\n            </div>\n          </div>`,a++}for(const t of m){const n=t.kunder?.navn||t.kunde_navn||"Ukjent",s=[t.kunder?.adresse,t.kunder?.postnummer,t.kunder?.poststed].filter(Boolean).join(", "),r=t.kunder?.telefon||t.telefon||"",l=t.opprettet_av&&"admin"!==t.opprettet_av?t.opprettet_av:"",d=l?i.get(l)||"#999":"",c=formatTimeOfDay(e);e+=t.varighet||30;const u=formatTimeOfDay(e);o+=`\n          <div class="wp-item existing wp-timeline-item" data-avtale-id="${t.id}" data-avtale-name="${escapeHtml(n)}" style="${d?"border-left:3px solid "+d:""}" title="${l?"Opprettet av "+escapeHtml(l):""}">\n            <span class="wp-stop-badge"><span class="wp-stop-num" style="background:${d||"var(--bg-tertiary, #666)"}">${a}</span>${l?`<span class="wp-stop-initials" style="background:${d||"var(--bg-tertiary, #666)"}">${escapeHtml(getCreatorDisplay(l,!0))}</span>`:""}</span>\n            <div class="wp-item-main">\n              <span class="wp-item-name">${escapeHtml(n)}</span>\n              ${s?`<span class="wp-item-addr">${escapeHtml(s)}</span>`:""}\n              ${r?`<span class="wp-item-phone"><i class="fas fa-phone" style="font-size:8px;margin-right:3px;"></i>${escapeHtml(r)}</span>`:""}\n              <span class="wp-item-timerange"><i class="fas fa-clock" style="font-size:8px;margin-right:2px;"></i>${c} - ${u}</span>\n            </div>\n            <button class="wp-remove" data-action="deleteAvtale" data-avtale-id="${t.id}" data-avtale-name="${escapeHtml(n)}" title="Slett avtale" aria-label="Fjern">&times;</button>\n          </div>`,a++}if(!f&&c&&(o+='<div class="wp-empty-hint"><i class="fas fa-crosshairs"></i> Dra over kunder på kartet eller søk etter kunde</div>'),o+="</div>",f){const e=getDayEstimatedTotal(t),a=p+g,s=n.planned.some(e=>e.lat&&e.lng)||m.some(e=>{const t=customers.find(t=>t.id===e.kunde_id);return t?.lat&&t?.lng});o+='<div class="wp-day-footer">',o+='<div class="wp-day-stats">',o+=`<span class="wp-day-summary">${a} stopp${e>0?` · ~${formatMinutes(e)}`:""}</span>`,o+="</div>",o+='<div class="wp-day-actions">',s&&a>=3&&(o+=`<button class="btn btn-small btn-secondary wp-opt-btn" data-action="wpOptimizeOrder" data-day="${t}" title="Optimaliser rekkefølge" aria-label="Optimaliser rekkefølge"><i class="fas fa-sort-amount-down" aria-hidden="true"></i></button>`),s&&(o+=`<button class="btn btn-small btn-secondary wp-nav-btn" data-action="wpNavigateDay" data-day="${t}"><i class="fas fa-directions" aria-hidden="true"></i> Naviger</button>`),o+="</div>",o+="</div>"}}o+="</div>"}o+="</div>",a>0&&(o+=`\n      <div class="wp-actions">\n        <button class="btn btn-primary wp-save-btn" data-action="saveWeeklyPlan"><i class="fas fa-check" aria-hidden="true"></i> Opprett ${a} avtale${a>1?"r":""}</button>\n        <button class="btn btn-secondary wp-clear-btn" data-action="clearWeekPlan" aria-label="Tøm plan"><i class="fas fa-trash" aria-hidden="true"></i></button>\n      </div>`),o+="</div>",e.innerHTML=o;const c=document.getElementById("wpCustomerSearch");c&&c.addEventListener("input",debounce(function(){const e=this.value.toLowerCase().trim(),t=document.getElementById("wpSearchResults");if(!t)return;if(e.length<1)return t.innerHTML="",void(t.style.display="none");const n=weekPlanState.activeDay;if(!n||!weekPlanState.days[n])return t.innerHTML='<div class="wp-search-item wp-search-no-results">Velg en dag først</div>',void(t.style.display="block");const a=weekPlanState.days[n],s=a.date,o=new Set(avtaler.filter(e=>e.dato===s).map(e=>e.kunde_id)),r=new Set(a.planned.map(e=>e.id)),i=sortByNavn(customers.filter(t=>t.navn&&t.navn.toLowerCase().includes(e)||t.poststed&&t.poststed.toLowerCase().includes(e)||t.adresse&&t.adresse.toLowerCase().includes(e))).slice(0,8);if(0===i.length)return t.innerHTML='<div class="wp-search-item wp-search-no-results">Ingen kunder funnet</div>',void(t.style.display="block");t.innerHTML=i.map(e=>{const t=o.has(e.id)||r.has(e.id),n=[e.adresse,e.poststed].filter(Boolean).join(", ");return`<div class="wp-search-item ${t?"disabled":""}"\n          data-action="wpAddSearchResult" data-customer-id="${e.id}"\n          ${t?'title="Allerede lagt til"':""} role="button" tabindex="0">\n          <span class="wp-search-name">${escapeHtml(e.navn)}</span>\n          <span class="wp-search-addr">${escapeHtml(n)}</span>\n          ${t?'<i class="fas fa-check" style="color:var(--color-success, #10b981);"></i>':'<i class="fas fa-plus"></i>'}\n        </div>`}).join(""),t.style.display="block"},200)),e.addEventListener("contextmenu",e=>{const t=e.target.closest(".wp-item.existing[data-avtale-id]");if(!t)return;e.preventDefault();showWpContextMenu(t.dataset.avtaleId,t.dataset.avtaleName,e.clientX,e.clientY)}),updateWeekPlanBadges()}function showWeekPlanDayPicker(e,t){weekPlanState.weekStart||initWeekPlanState(new Date),closeWeekPlanDayPicker();const n=document.createElement("div");n.id="wpDayPickerPopup",n.className="wp-day-picker-popup";let a='<div class="wp-day-picker-header">Velg dag i ukeplan</div><div class="wp-day-picker-days">';weekDayKeys.forEach((t,n)=>{const s=weekPlanState.days[t];if(!s)return;const o=new Date(s.date+"T00:00:00"),r=o.getDate(),i=monthNamesShort[o.getMonth()],l=weekDayLabels[n],d=s.planned?.length||0,c=d>0?` <span class="wp-dp-badge">${d}</span>`:"";a+=`<button class="wp-dp-day-btn" data-wp-day="${t}" data-customer-ids="${escapeHtml(e)}">\n      <span class="wp-dp-day-name">${l}</span>\n      <span class="wp-dp-day-date">${r}. ${i}${c}</span>\n    </button>`}),a+="</div>",n.innerHTML=a,document.body.appendChild(n);const s=t.getBoundingClientRect(),o=n.getBoundingClientRect();let r=s.bottom+4,i=s.left;r+o.height>window.innerHeight&&(r=s.top-o.height-4),i+o.width>window.innerWidth&&(i=window.innerWidth-o.width-8),n.style.top=`${r}px`,n.style.left=`${i}px`,n.querySelectorAll(".wp-dp-day-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.dataset.wpDay,a=e.dataset.customerIds.split(",").map(e=>Number.parseInt(e)).map(e=>customers.find(t=>t.id===e)).filter(Boolean),s=weekPlanState.activeDay;weekPlanState.activeDay=n,addCustomersToWeekPlan(a),weekPlanState.activeDay=s,closeWeekPlanDayPicker()})}),setTimeout(()=>{document.addEventListener("click",e=>{n.contains(e.target)||closeWeekPlanDayPicker()},{once:!0})},0);const l=e=>{"Escape"===e.key&&(closeWeekPlanDayPicker(),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l)}function closeWeekPlanDayPicker(){document.getElementById("wpDayPickerPopup")?.remove()}function addCustomersToWeekPlan(e){if(!weekPlanState.activeDay)return;const t=weekPlanState.activeDay,n=weekPlanState.days[t],a=n.date,s=new Set(avtaler.filter(e=>e.dato===a).map(e=>e.kunde_id));let o=0,r=0,i=0;for(const t of e)s.has(t.id)?r++:n.planned.some(e=>e.id===t.id)?i++:(n.planned.push({id:t.id,navn:t.navn,adresse:t.adresse||"",postnummer:t.postnummer||"",poststed:t.poststed||"",telefon:t.telefon||"",kategori:t.kategori||null,lat:t.lat||null,lng:t.lng||null,estimertTid:30,addedBy:weekPlanState.globalAssignedTo||localStorage.getItem("userName")||"admin"}),o++);let l=`${o} kunder lagt til ${weekDayLabels[weekDayKeys.indexOf(t)]}`;r>0&&(l+=` (${r} har allerede avtale)`),i>0&&(l+=` (${i} allerede lagt til)`),showToast(l,o>0?"success":"info"),renderWeeklyPlan()}async function saveWeeklyPlan(){const e=getWeekPlanTotalPlanned();if(0===e)return;if(!await showConfirm(`Opprett ${e} avtaler for uke ${getISOWeekNumber(weekPlanState.weekStart)}?`,"Bekreft oppretting"))return;let t=0,n=0,a="";const s=localStorage.getItem("userName")||"admin",o=[];for(const e of weekDayKeys){const t=weekPlanState.days[e];for(const e of t.planned){const n=e.addedBy||weekPlanState.globalAssignedTo||s;o.push({customer:e,date:t.date,opprettetAv:n})}}const r=showToast(`Oppretter avtaler... 0/${o.length}`,"info",0);for(let e=0;e<o.length;e+=5){const s=o.slice(e,e+5),i=await Promise.allSettled(s.map(async({customer:e,date:t,opprettetAv:n})=>{const a={kunde_id:e.id,dato:t,beskrivelse:e.kategori||"Planlagt oppdrag",opprettet_av:n},s=await apiFetch("/api/avtaler",{method:"POST",body:JSON.stringify(a)});if(!s.ok){const t=await s.json().catch(()=>({})),n=t.error?.message||t.error||t.message||s.statusText;throw new Error(`${e.navn}: ${n}`)}return e.navn}));for(const e of i)"fulfilled"===e.status?t++:(n++,a=e.reason?.message||"Ukjent feil",console.error("Avtale-feil:",e.reason));if(r){const t=Math.min(e+5,o.length),n=r.querySelector("span");n&&(n.textContent=`Oppretter avtaler... ${t}/${o.length}`)}}r&&r.remove(),t>0&&showToast(`${t} avtaler opprettet!`,"success"),n>0&&showToast(`${n} avtaler feilet: ${a}`,"error");for(const e of weekDayKeys)weekPlanState.days[e].planned=[];weekPlanState.activeDay=null,areaSelectMode&&toggleAreaSelect(),await loadAvtaler(),refreshTeamFocus(),renderWeeklyPlan()}function showWpContextMenu(e,t,n,a){closeWpContextMenu();const s=document.createElement("div");s.className="marker-context-menu",s.setAttribute("role","menu"),s.innerHTML=`\n    <div class="context-menu-header">${escapeHtml(t)}</div>\n    <div class="context-menu-item" role="menuitem" data-wp-action="delete" data-id="${escapeHtml(e)}">\n      <i class="fas fa-trash" aria-hidden="true"></i> Slett avtale\n    </div>\n  `,s.style.left=`${n}px`,s.style.top=`${a}px`,document.body.appendChild(s),requestAnimationFrame(()=>{const e=s.getBoundingClientRect();e.right>window.innerWidth&&(s.style.left=n-e.width+"px"),e.bottom>window.innerHeight&&(s.style.top=a-e.height+"px")}),s.addEventListener("click",async e=>{const t=e.target.closest("[data-wp-action]");if(!t)return;const n=t.dataset.wpAction,a=t.dataset.id;if("delete"===n){closeWpContextMenu();try{const e=await apiFetch(`/api/avtaler/${a}`,{method:"DELETE"});if(e.ok)showToast("Avtale slettet","success"),await loadAvtaler(),refreshTeamFocus(),renderWeeklyPlan(),applyFilters();else{const t=await e.json().catch(()=>({}));showToast(t.error?.message||"Kunne ikke slette avtale","error")}}catch(e){showToast("Feil ved sletting: "+e.message,"error")}}}),setTimeout(()=>{document.addEventListener("click",closeWpContextMenu,{once:!0})},10),activeWpContextMenu=s}let activeWpContextMenu=null;function closeWpContextMenu(){activeWpContextMenu&&(activeWpContextMenu.remove(),activeWpContextMenu=null)}function clearWeekPlan(){for(const e of weekDayKeys)weekPlanState.days[e].planned=[];weekPlanState.activeDay=null,areaSelectMode&&toggleAreaSelect(),refreshTeamFocus(),renderWeeklyPlan(),showToast("Plan tømt","info")}async function wpOptimizeOrder(e){const t=weekPlanState.days[e];if(!t)return;const n=t.planned.filter(e=>e.lat&&e.lng);if(n.length<3)return void showToast("Trenger minst 3 stopp for optimalisering","info");const a=appConfig.routeStartLat||69.06888,s=appConfig.routeStartLng||17.65274,o=showToast("Optimaliserer rekkefølge...","info",0);try{const e={jobs:n.map((e,t)=>({id:t+1,location:[e.lng,e.lat],service:60*(e.estimertTid||30)})),vehicles:[{id:1,profile:"driving-car",start:[s,a],end:[s,a]}]},r={"Content-Type":"application/json"},i=getCsrfToken();i&&(r["X-CSRF-Token"]=i);const l=await fetch("/api/routes/optimize",{method:"POST",headers:r,credentials:"include",body:JSON.stringify(e)});if(o&&o.remove(),!l.ok)return void showToast("Kunne ikke optimalisere rute","error");const d=await l.json(),c=d.data||d;if(c.routes?.[0]?.steps){const e=c.routes[0].steps.filter(e=>"job"===e.type).map(e=>n[e.job-1]).filter(Boolean);if(e.length===n.length){const n=[];for(const a of e){const e=t.planned.find(e=>e.id===a.id);e&&n.push(e)}for(const e of t.planned)n.some(t=>t.id===e.id)||n.push(e);t.planned=n,renderWeeklyPlan(),showToast("Rekkefølge optimalisert","success")}}}catch(e){o&&o.remove(),console.warn("[wpOptimizeOrder] Failed:",e),showToast("Feil ved optimalisering","error")}}async function wpNavigateDay(e){const t=weekPlanState.days[e];if(!t)return;const n=t.date,a=[];for(const e of t.planned)e.lat&&e.lng&&a.push({id:e.id,lat:e.lat,lng:e.lng,navn:e.navn,adresse:e.adresse||"",estimertTid:e.estimertTid||30});const s=avtaler.filter(e=>e.dato===n);for(const e of s){const t=customers.find(t=>t.id===e.kunde_id);t?.lat&&t?.lng&&(a.some(e=>e.lat===t.lat&&e.lng===t.lng)||a.push({id:t.id,lat:t.lat,lng:t.lng,navn:t.navn,adresse:t.adresse||"",estimertTid:30}))}if(0===a.length)return void showToast("Ingen kunder med koordinater for denne dagen","info");const o=appConfig.routeStartLat||69.06888,r=appConfig.routeStartLng||17.65274,i=[o,r],l=showToast("Optimaliserer rute...","info",0);if(a.length>=3)try{const e={jobs:a.map((e,t)=>({id:t+1,location:[e.lng,e.lat],service:60*(e.estimertTid||30)})),vehicles:[{id:1,profile:"driving-car",start:[r,o],end:[r,o]}]},n={"Content-Type":"application/json"},s=getCsrfToken();s&&(n["X-CSRF-Token"]=s);const i=await fetch("/api/routes/optimize",{method:"POST",headers:n,credentials:"include",body:JSON.stringify(e)});if(i.ok){const e=await i.json(),n=e.data||e;if(n.routes?.[0]?.steps){const e=n.routes[0].steps.filter(e=>"job"===e.type).map(e=>a[e.job-1]).filter(Boolean);if(e.length===a.length){a.length=0,a.push(...e);const n=[];for(const a of e){const e=t.planned.find(e=>e.id===a.id);e&&n.push(e)}for(const e of t.planned)n.some(t=>t.id===e.id)||n.push(e);t.planned=n,renderWeeklyPlan()}}}}catch(e){console.warn("[wpNavigateDay] Optimization failed, using original order:",e)}l&&(l.textContent="Beregner rute...");const d=[[r,o],...a.map(e=>[e.lng,e.lat]),[r,o]];try{const t={"Content-Type":"application/json"},n=getCsrfToken();n&&(t["X-CSRF-Token"]=n);const s=await fetch("/api/routes/directions",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({coordinates:d})});if(l&&l.remove(),!s.ok){const e=await s.json().catch(()=>({}));return console.error("[wpNavigateDay] API error:",s.status,e),void showToast(`Kunne ikke beregne rute (${s.status})`,"error")}const o=await s.json(),r=o.data||o,c=r.features?.[0];let u=0,m=0;if(c?.properties?.summary&&(u=c.properties.summary.duration||0,m=c.properties.summary.distance||0),0===u&&c?.properties?.segments?.length>0)for(const e of c.properties.segments)u+=e.duration||0,m+=e.distance||0;clearRoute(),wpRouteActive=!0,wpRouteStopIds=new Set(a.map(e=>Number(e.id))),applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters();const p=[i,...a.map(e=>[e.lat,e.lng]),i];let g=!1;if(c?.geometry?.coordinates?.length>2)try{let e;e="MultiLineString"===c.geometry.type?c.geometry.coordinates.flat().map(e=>[e[1],e[0]]):c.geometry.coordinates.map(e=>[e[1],e[0]]),e.length>2&&!isNaN(e[0][0])&&!isNaN(e[0][1])&&(routeLayer=L.polyline(e,{color:"#2563eb",weight:5,opacity:.85,lineCap:"round",lineJoin:"round"}).addTo(map),g=!0)}catch(e){console.warn("[wpNavigateDay] ORS geometry failed:",e)}g||(routeLayer=L.polyline(p,{color:"#2563eb",weight:4,opacity:.7,dashArray:"10, 8",lineCap:"round",lineJoin:"round"}).addTo(map));const f=[i,...a.map(e=>[e.lat,e.lng])];map.fitBounds(L.latLngBounds(f),{padding:[50,50]}),currentRouteData={customers:a,duration:u,distance:m},showWpRouteSummary(e,a,u,m)}catch(e){l&&l.remove(),console.error("Ruteberegning feilet:",e),showToast("Feil ved ruteberegning","error"),wpRouteActive=!1,wpRouteStopIds=null,applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters()}}function showWpRouteSummary(e,t,n,a){const s=document.getElementById("wpRouteSummary");s&&s.remove();const o=Math.round(n/60),r=t.reduce((e,t)=>e+(t.estimertTid||30),0),i=o+r,l=(a/1e3).toFixed(1),d=weekDayLabels[weekDayKeys.indexOf(e)],c=document.createElement("div");c.id="wpRouteSummary",c.className="wp-route-summary",c.innerHTML=`\n    <div class="wp-route-header">\n      <strong>${escapeHtml(d)} — ${t.length} stopp</strong>\n      <button class="wp-route-close" data-action="closeWpRoute" aria-label="Fjern">&times;</button>\n    </div>\n    <div class="wp-route-stats">\n      <div class="wp-route-stat">\n        <i class="fas fa-car" aria-hidden="true"></i>\n        <span>Kjøretid: ~${formatMinutes(o)}</span>\n      </div>\n      <div class="wp-route-stat">\n        <i class="fas fa-user-clock" aria-hidden="true"></i>\n        <span>Hos kunder: ~${formatMinutes(r)}</span>\n      </div>\n      <div class="wp-route-stat total">\n        <i class="fas fa-clock" aria-hidden="true"></i>\n        <span>Totalt: ~${formatMinutes(i)}</span>\n      </div>\n      <div class="wp-route-stat">\n        <i class="fas fa-road" aria-hidden="true"></i>\n        <span>${l} km</span>\n      </div>\n    </div>\n    <div class="wp-route-actions">\n      <button class="btn btn-small btn-primary" data-action="wpExportMaps" data-day="${e}">\n        <i class="fas fa-external-link-alt" aria-hidden="true"></i> Åpne i Maps\n      </button>\n      <button class="btn btn-small btn-secondary" data-action="closeWpRoute">\n        <i class="fas fa-times" aria-hidden="true"></i> Lukk rute\n      </button>\n    </div>\n  `,document.body.appendChild(c)}function closeWpRouteSummary(){const e=document.getElementById("wpRouteSummary");e&&e.remove(),clearRoute(),wpRouteActive=!1,wpRouteStopIds=null,applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters()}function wpExportToMaps(){if(!currentRouteData||!currentRouteData.customers.length)return;const e=currentRouteData.customers,t=`${appConfig.routeStartLat||69.06888},${appConfig.routeStartLng||17.65274}`;if(/iPad|iPhone|iPod/.test(navigator.userAgent)){const n=e.map(e=>`${e.lat},${e.lng}`).join("+to:")+`+to:${t}`;window.open(`https://maps.apple.com/?saddr=${t}&daddr=${n}&dirflg=d`,"_blank")}else{const n=e.map(e=>`${e.lat},${e.lng}`).join("|");let a=`https://www.google.com/maps/dir/?api=1&origin=${t}&destination=${t}`;a+=`&waypoints=${encodeURIComponent(n)}&travelmode=driving`,window.open(a,"_blank")}}function closeCalendarQuickMenu(){document.getElementById("quickCalendarMenu")?.remove(),document.removeEventListener("click",handleQuickMenuOutsideClick)}function handleQuickMenuOutsideClick(e){const t=document.getElementById("quickCalendarMenu");t&&!t.contains(e.target)&&closeCalendarQuickMenu()}function showCalendarQuickMenu(e,t,n){closeCalendarQuickMenu();const a=new Date,s=addDaysToDate(a,1),o=getNextMonday(a),r=document.createElement("div");if(r.id="quickCalendarMenu",r.className="quick-calendar-menu",r.innerHTML=`\n    <div class="quick-menu-header">${escapeHtml(t)}</div>\n    <div class="quick-menu-item" data-action="quickAddAvtale" data-customer-id="${e}" data-customer-name="${escapeHtml(t)}" data-quick-date="${formatDateISO(a)}" role="button" tabindex="0">\n      <i class="fas fa-calendar-day" aria-hidden="true"></i> I dag (${a.getDate()}.${a.getMonth()+1})\n    </div>\n    <div class="quick-menu-item" data-action="quickAddAvtale" data-customer-id="${e}" data-customer-name="${escapeHtml(t)}" data-quick-date="${formatDateISO(s)}" role="button" tabindex="0">\n      <i class="fas fa-calendar-day" aria-hidden="true"></i> I morgen (${s.getDate()}.${s.getMonth()+1})\n    </div>\n    <div class="quick-menu-item" data-action="quickAddAvtale" data-customer-id="${e}" data-customer-name="${escapeHtml(t)}" data-quick-date="${formatDateISO(o)}" role="button" tabindex="0">\n      <i class="fas fa-calendar-week" aria-hidden="true"></i> Neste mandag (${o.getDate()}.${o.getMonth()+1})\n    </div>\n    <div class="quick-menu-item" data-action="addCustomerToCalendar" data-customer-id="${e}" data-customer-name="${escapeHtml(t)}" role="button" tabindex="0">\n      <i class="fas fa-calendar-alt" aria-hidden="true"></i> Velg dato...\n    </div>\n  `,document.body.appendChild(r),n){const e=n.getBoundingClientRect();r.style.left=Math.min(e.left,window.innerWidth-200)+"px",r.style.top=e.bottom+4+"px"}else r.style.left="50%",r.style.top="50%",r.style.transform="translate(-50%, -50%)";requestAnimationFrame(()=>{const e=r.getBoundingClientRect();e.bottom>window.innerHeight&&(r.style.top=window.innerHeight-e.height-10+"px"),e.right>window.innerWidth&&(r.style.left=window.innerWidth-e.width-10+"px")}),setTimeout(()=>{document.addEventListener("click",handleQuickMenuOutsideClick)},10)}async function quickAddAvtaleForDate(e,t,n){const a=customers.find(t=>t.id===e),s=a?.kategori||"Kontroll",o=a?.estimert_tid||void 0;try{const a=await apiFetch("/api/avtaler",{method:"POST",body:JSON.stringify({kunde_id:e,dato:n,type:s,beskrivelse:s,varighet:o,opprettet_av:localStorage.getItem("userName")||"admin"})});if(a.ok)showToast(`${t} lagt til ${n}`,"success"),await loadAvtaler(),renderCalendar(),splitViewOpen&&renderSplitWeekContent();else{showToast("Kunne ikke opprette avtale: "+((await a.json().catch(()=>({}))).error||"ukjent feil"),"error")}}catch(e){console.error("Error quick-adding avtale:",e),showToast("Kunne ikke opprette avtale","error")}}function getAvtaleServiceColor(e){const t=customers.find(t=>t.id===e.kunde_id),n=t?.kategori||e.type||"";if(!n)return null;const a=serviceTypeRegistry.getAll();for(const e of a)if(n===e.name||n.includes(e.name))return e.color;return null}function getAvtaleServiceIcon(e){const t=customers.find(t=>t.id===e.kunde_id),n=t?.kategori||e.type||"";return n?serviceTypeRegistry.getIconForCategory(n):""}async function loadAvtaler(){try{const e=await apiFetch("/api/avtaler");if(e.ok){const t=await e.json();avtaler=t.data||t,weekPlanState.weekStart&&updateWeekPlanBadges()}}catch(e){console.error("Error loading avtaler:",e)}}async function renderCalendar(){const e=document.getElementById("calendarContainer");if(!e)return;0===avtaler.length&&await loadAvtaler();const t=new Date;t.setHours(0,0,0,0);const n=avtaler.filter(e=>{const t=new Date(e.dato);return t.getMonth()===currentCalendarMonth&&t.getFullYear()===currentCalendarYear}),a=new Date(currentCalendarYear,currentCalendarMonth+1,0).getDate(),s=new Date(currentCalendarYear,currentCalendarMonth,1).getDay(),o=["Januar","Februar","Mars","April","Mai","Juni","Juli","August","September","Oktober","November","Desember"];let r=`\n    <div class="calendar-header">\n      <button class="calendar-nav" id="prevMonth" aria-label="Forrige måned"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>\n      <h3>${o[currentCalendarMonth]} ${currentCalendarYear}</h3>\n      <button class="calendar-nav" id="nextMonth" aria-label="Neste måned"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>\n      <div style="margin-left:auto;display:flex;gap:4px;">\n        <button class="btn btn-small ${"week"===calendarViewMode?"btn-primary":"btn-secondary"}" id="toggleWeekView">\n          <i class="fas fa-calendar-week" aria-hidden="true"></i> Uke\n        </button>\n        <button class="btn btn-small btn-primary" id="openCalendarSplit" title="Åpne fullskjerm kalender" aria-label="Åpne fullskjerm kalender">\n          <i class="fas fa-expand" aria-hidden="true"></i>\n        </button>\n        <button class="btn btn-primary calendar-add-btn" id="addAvtaleBtn">\n          <i class="fas fa-plus" aria-hidden="true"></i> Ny avtale\n        </button>\n      </div>\n    </div>\n    <div class="calendar-grid">\n      <div class="calendar-day-header">Man</div>\n      <div class="calendar-day-header">Tir</div>\n      <div class="calendar-day-header">Ons</div>\n      <div class="calendar-day-header">Tor</div>\n      <div class="calendar-day-header">Fre</div>\n      <div class="calendar-day-header">Lør</div>\n      <div class="calendar-day-header">Søn</div>\n  `;const i=0===s?6:s-1;for(let e=0;e<i;e++)r+='<div class="calendar-day empty"></div>';for(let e=1;e<=a;e++){const a=`${currentCalendarYear}-${String(currentCalendarMonth+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,s=n.filter(e=>e.dato===a),o=new Date(currentCalendarYear,currentCalendarMonth,e),i=o.getTime()===t.getTime(),l=o<t,d=s.length>0,c=s.length>0?getAreaTooltip(s):"",u=s.length>0?getUniqueAreas(s).size:0;r+=`\n      <div class="calendar-day ${i?"today":""} ${l?"past":""} ${d?"has-content":""}"\n           data-date="${a}" data-action="openDayDetail" role="button" tabindex="0">\n        <span class="day-number">${e}</span>\n        ${u>0?`<span class="day-area-hint" title="${escapeHtml(c)}">${u} omr.</span>`:""}\n        <div class="calendar-events">\n          ${s.map(e=>{const t=getAvtaleServiceColor(e),n=getAvtaleServiceIcon(e),a=e.kunder?.poststed||"";return`\n            <div class="calendar-avtale ${"fullført"===e.status?"completed":""}"\n                 data-avtale-id="${e.id}"${t?` style="border-left-color:${t}"`:""}>\n              <div class="avtale-content" data-avtale-id="${e.id}" data-action="editAvtale" role="button" tabindex="0">\n                ${n?`<span class="avtale-service-icon">${n}</span>`:""}${e.rute_id?'<i class="fas fa-route" style="font-size:0.6em;margin-right:2px;color:var(--primary)" title="Fra rute"></i>':""}${e.er_gjentakelse||e.original_avtale_id?'<i class="fas fa-sync-alt" style="font-size:0.6em;margin-right:2px" title="Gjentakende"></i>':""}\n                ${e.klokkeslett?`<span class="avtale-time">${e.klokkeslett.substring(0,5)}</span>`:""}\n                <span class="avtale-kunde">${escapeHtml(e.kunder?.navn||e.kunde_navn||"Ukjent")}</span>\n                ${a?`<span class="avtale-poststed">${escapeHtml(a)}</span>`:""}\n                ${e.opprettet_av&&"admin"!==e.opprettet_av?`<span class="avtale-creator" title="Opprettet av ${escapeHtml(e.opprettet_av)}">${escapeHtml(getCreatorDisplay(e.opprettet_av,!0))}</span>`:""}\n              </div>\n              <button class="avtale-quick-delete" data-action="quickDeleteAvtale" data-avtale-id="${e.id}" title="Slett avtale" aria-label="Slett avtale"><i class="fas fa-times" aria-hidden="true"></i></button>\n            </div>\n          `}).join("")}\n        </div>\n      </div>\n    `}if(r+="</div>","week"===calendarViewMode&&currentWeekStart){const t=["Mandag","Tirsdag","Onsdag","Torsdag","Fredag","Lørdag","Søndag"];r=`\n      <div class="calendar-header">\n        <button class="calendar-nav" id="prevWeek" aria-label="Forrige uke"><i class="fas fa-chevron-left" aria-hidden="true"></i></button>\n        <h3>Uke ${getISOWeekNumber(currentWeekStart)} - ${currentWeekStart.getFullYear()}</h3>\n        <button class="calendar-nav" id="nextWeek" aria-label="Neste uke"><i class="fas fa-chevron-right" aria-hidden="true"></i></button>\n        <div style="margin-left:auto;display:flex;gap:4px;">\n          <button class="btn btn-small btn-primary" id="openCalendarSplit" title="Åpne fullskjerm kalender" aria-label="Åpne fullskjerm kalender">\n            <i class="fas fa-expand" aria-hidden="true"></i>\n          </button>\n          <button class="btn btn-small btn-secondary" id="toggleWeekView">\n            <i class="fas fa-calendar-alt" aria-hidden="true"></i> Måned\n          </button>\n          <button class="btn btn-primary calendar-add-btn" id="addAvtaleBtn">\n            <i class="fas fa-plus" aria-hidden="true"></i> Ny avtale\n          </button>\n        </div>\n      </div>\n      <div class="week-view">\n    `;let n=0;for(let e=0;e<7;e++){const a=new Date(currentWeekStart);a.setDate(currentWeekStart.getDate()+e);const s=formatDateISO(a),o=new Date;o.setHours(0,0,0,0);const i=a.getTime()===o.getTime(),l=avtaler.filter(e=>e.dato===s);let d=0;l.forEach(e=>{const t=customers.find(t=>t.id===e.kunde_id);t?.estimert_tid&&(d+=t.estimert_tid)}),n+=d,r+=`\n        <div class="week-day ${i?"today":""}" data-date="${s}">\n          <div class="week-day-header">\n            <span class="week-day-name">${t[e].substring(0,3)}</span>\n            <span class="week-day-date">${a.getDate()}</span>\n            ${d>0?`<span class="week-day-time">${Math.floor(d/60)}t ${d%60}m</span>`:""}\n          </div>\n          ${renderAreaBadges(l)}\n          <div class="week-day-content">\n            ${l.map(e=>{const t=e.kunder?.navn||e.kunde_navn||"Ukjent",n=[e.kunder?.adresse||"",e.kunder?.postnummer||"",e.kunder?.poststed||""].filter(Boolean).join(", "),a=e.kunder?.telefon||e.telefon||"",s=e.opprettet_av&&"admin"!==e.opprettet_av?e.opprettet_av:"",o=s?getCreatorDisplay(s,!0):"",r=getAvtaleServiceColor(e),i=getAvtaleServiceIcon(e),l=customers.find(t=>t.id===e.kunde_id),d=e.varighet||l?.estimert_tid||0;return`\n                <div class="week-avtale-card ${"fullført"===e.status?"completed":""}" data-avtale-id="${e.id}" data-action="editAvtale" role="button" tabindex="0"${r?` style="border-left-color:${r}"`:""}>\n                  <div class="week-card-header">\n                    ${i?`<span class="avtale-service-icon">${i}</span>`:""}\n                    ${o?`<span class="week-card-initials" title="${escapeHtml(s)}">${escapeHtml(o)}</span>`:""}\n                    <span class="week-card-name">${escapeHtml(t)}</span>\n                    ${d?`<span class="avtale-duration">${d}m</span>`:""}\n                    <button class="week-card-delete" data-action="quickDeleteAvtale" data-avtale-id="${e.id}" title="Slett avtale" aria-label="Slett avtale"><i class="fas fa-times" aria-hidden="true"></i></button>\n                  </div>\n                  ${n?`<div class="week-card-addr">${escapeHtml(n)}</div>`:""}\n                  ${a?`<div class="week-card-phone"><i class="fas fa-phone" aria-hidden="true"></i>${escapeHtml(a)}</div>`:""}\n                  ${e.klokkeslett?`<div class="week-card-time"><i class="fas fa-clock" aria-hidden="true"></i>${e.klokkeslett.substring(0,5)}${e.varighet?` (${e.varighet}m)`:""}</div>`:""}\n                </div>\n              `}).join("")}\n            ${0===l.length?'<div class="week-empty">Ingen avtaler</div>':""}\n          </div>\n          <div class="week-day-add" data-date="${s}" data-action="openDayDetail" role="button" tabindex="0">\n            <i class="fas fa-plus" aria-hidden="true"></i> Legg til\n          </div>\n        </div>\n      `}r+="</div>",r+=`<div class="week-summary"><strong>Total estimert tid denne uken:</strong> ${Math.floor(n/60)}t ${n%60}m</div>`,e.innerHTML=r,runTabCleanup("calendar")}if("week"!==calendarViewMode){const n=avtaler.filter(e=>new Date(e.dato)>=t&&"fullført"!==e.status).sort((e,t)=>{const n=new Date(e.dato)-new Date(t.dato);return 0!==n?n:(e.klokkeslett||"").localeCompare(t.klokkeslett||"")}).slice(0,8);n.length>0&&(r+=`\n      <div class="upcoming-section">\n        <h4><i class="fas fa-calendar-check"></i> Kommende avtaler</h4>\n        <div class="upcoming-list">\n          ${n.map(e=>`\n            <div class="upcoming-item" data-avtale-id="${e.id}" data-action="editAvtale" role="button" tabindex="0">\n              <div class="upcoming-date">\n                <span class="upcoming-day">${new Date(e.dato).getDate()}</span>\n                <span class="upcoming-month">${o[new Date(e.dato).getMonth()].substring(0,3)}</span>\n              </div>\n              <div class="upcoming-info">\n                <strong>${e.er_gjentakelse||e.original_avtale_id?'<i class="fas fa-sync-alt" style="font-size:0.7em;margin-right:3px" title="Gjentakende"></i>':""}${escapeHtml(e.kunder?.navn||e.kunde_navn||"Ukjent")}</strong>\n                <span>${e.klokkeslett?e.klokkeslett.substring(0,5):""} ${e.type||""}</span>\n                ${e.opprettet_av&&"admin"!==e.opprettet_av?`<span class="upcoming-creator">Av: ${escapeHtml(getCreatorDisplay(e.opprettet_av))}</span>`:""}\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      </div>\n    `),e.innerHTML=r,runTabCleanup("calendar")}const l=document.getElementById("prevMonth"),d=document.getElementById("nextMonth"),c=document.getElementById("addAvtaleBtn"),u=()=>{currentCalendarMonth--,currentCalendarMonth<0&&(currentCalendarMonth=11,currentCalendarYear--),renderCalendar()},m=()=>{currentCalendarMonth++,currentCalendarMonth>11&&(currentCalendarMonth=0,currentCalendarYear++),renderCalendar()},p=()=>openAvtaleModal(),g=document.getElementById("toggleWeekView"),f=()=>{if("month"===calendarViewMode){calendarViewMode="week";const e=new Date,t=e.getDay(),n=new Date(e);n.setDate(e.getDate()-(0===t?6:t-1)),n.setHours(0,0,0,0),currentWeekStart=n}else calendarViewMode="month";renderCalendar()};l?.addEventListener("click",u),d?.addEventListener("click",m),c?.addEventListener("click",p),g?.addEventListener("click",f);const v=document.getElementById("prevWeek"),y=document.getElementById("nextWeek"),h=()=>{currentWeekStart.setDate(currentWeekStart.getDate()-7),renderCalendar()},k=()=>{currentWeekStart.setDate(currentWeekStart.getDate()+7),renderCalendar()};v?.addEventListener("click",h),y?.addEventListener("click",k);const b=document.getElementById("openCalendarSplit"),w=()=>openCalendarSplitView();b?.addEventListener("click",w),tabCleanupFunctions.calendar=()=>{l?.removeEventListener("click",u),d?.removeEventListener("click",m),c?.removeEventListener("click",p),g?.removeEventListener("click",f),v?.removeEventListener("click",h),y?.removeEventListener("click",k),b?.removeEventListener("click",w),closeCalendarSplitView()}}let splitViewOpen=!1,splitWeekStart=null,splitDividerCleanup=null,splitViewState={activeDay:null};function openCalendarSplitView(){if(splitViewOpen)return;const e=document.getElementById("calendarSplitOverlay");if(!e)return;if(currentWeekStart)splitWeekStart=new Date(currentWeekStart);else{const e=new Date,t=e.getDay();splitWeekStart=new Date(e),splitWeekStart.setDate(e.getDate()-(0===t?6:t-1)),splitWeekStart.setHours(0,0,0,0)}e.classList.remove("hidden"),splitViewOpen=!0,renderSplitWeekContent();const t=document.getElementById("splitPrevWeek"),n=document.getElementById("splitNextWeek"),a=document.getElementById("closeSplitView"),s=document.getElementById("addAvtaleSplit"),o=()=>{splitWeekStart.setDate(splitWeekStart.getDate()-7),renderSplitWeekContent()},r=()=>{splitWeekStart.setDate(splitWeekStart.getDate()+7),renderSplitWeekContent()},i=()=>closeCalendarSplitView(),l=()=>openAvtaleModal();t?.addEventListener("click",o),n?.addEventListener("click",r),a?.addEventListener("click",i),s?.addEventListener("click",l);const d=e=>{"Escape"===e.key&&closeCalendarSplitView()};document.addEventListener("keydown",d),setupSplitDivider();const c=document.getElementById("calendarSplitContent"),u=async e=>{const t=e.target.closest("[data-action]");if(!t)return;const n=t.dataset.action;if("editAvtale"===n){const e=t.dataset.avtaleId,n=avtaler.find(t=>String(t.id)===String(e));n&&openAvtaleModal(n)}else if("quickDeleteAvtale"===n){e.stopPropagation();const n=Number.parseInt(t.dataset.avtaleId),a=avtaler.find(e=>e.id===n),s=a?.kunder?.navn||a?.kunde_navn||"denne avtalen";if(!await showConfirm(`Slett avtale for ${s}?`,"Bekreft sletting"))return;try{(await apiFetch(`/api/avtaler/${n}`,{method:"DELETE"})).ok?(showToast("Avtale slettet","success"),await loadAvtaler(),renderCalendar()):showToast("Kunne ikke slette avtalen","error")}catch(e){console.error("Error deleting avtale from split view:",e),showToast("Kunne ikke slette avtalen","error")}}else if("openDayDetail"===n){const e=t.dataset.date;e&&openAvtaleModal(null,e)}else if("setSplitActiveDay"===n){e.stopPropagation();const n=t.dataset.date;if(splitViewState.activeDay===n)splitViewState.activeDay=null,areaSelectMode&&toggleAreaSelect();else{splitViewState.activeDay=n,areaSelectMode||toggleAreaSelect();showToast(`${new Date(n+"T00:00:00").toLocaleDateString("nb-NO",{weekday:"long",day:"numeric",month:"short"})} valgt — dra over kunder på kartet`,"info")}renderSplitWeekContent()}else if("confirmDay"===n){e.stopPropagation();const n=t.dataset.date;n&&showConfirmDayPanel(n)}else if("toggleUpcomingAreas"===n){const e=document.getElementById("splitUpcomingBody");e&&e.classList.toggle("collapsed");const n=t.querySelector(".split-upcoming-chevron")||t.closest("[data-action]").querySelector(".split-upcoming-chevron");n&&n.classList.toggle("rotated")}};c?.addEventListener("click",u),splitDividerCleanup=()=>{t?.removeEventListener("click",o),n?.removeEventListener("click",r),a?.removeEventListener("click",i),s?.removeEventListener("click",l),document.removeEventListener("keydown",d),c?.removeEventListener("click",u)},setTimeout(()=>{window.map&&window.map.invalidateSize()},100)}function closeCalendarSplitView(){const e=document.getElementById("calendarSplitOverlay");if(!e)return;e.classList.add("hidden"),splitViewOpen=!1,splitViewState.activeDay=null,areaSelectMode&&toggleAreaSelect(),splitDividerCleanup&&(splitDividerCleanup(),splitDividerCleanup=null);const t=document.getElementById("calendarSplitPanel");t&&(t.style.width=""),setTimeout(()=>{window.map&&window.map.invalidateSize()},100)}function renderSplitWeekContent(){const e=document.getElementById("calendarSplitContent"),t=document.getElementById("calendarSplitTitle");if(!e||!splitWeekStart)return;const n=getISOWeekNumber(splitWeekStart);t&&(t.textContent=`Uke ${n} — ${splitWeekStart.getFullYear()}`);const a=["Mandag","Tirsdag","Onsdag","Torsdag","Fredag","Lørdag","Søndag"],s=new Date;s.setHours(0,0,0,0);let o=renderUpcomingAreas(splitWeekStart);o+='<div class="split-week-grid">';for(let e=0;e<7;e++){const t=new Date(splitWeekStart);t.setDate(splitWeekStart.getDate()+e);const n=formatDateISO(t),r=t.getTime()===s.getTime(),i=splitViewState.activeDay===n,l=avtaler.filter(e=>e.dato===n);let d=0;l.forEach(e=>{if(d+=e.varighet||0,!e.varighet){const t=customers.find(t=>t.id===e.kunde_id);t?.estimert_tid&&(d+=t.estimert_tid)}}),o+=`\n      <div class="split-week-day ${r?"today":""} ${i?"active":""}" data-date="${n}">\n        <div class="split-week-day-header" data-action="setSplitActiveDay" data-date="${n}" title="${i?"Klikk for å deaktivere dag":"Klikk for å velge dag — dra over kartet for å legge til kunder"}" role="button" tabindex="0">\n          <span class="split-day-name">${a[e].substring(0,3)}</span>\n          <span class="split-day-date">${t.getDate()}</span>\n          ${i?'<i class="fas fa-crosshairs split-active-icon" aria-hidden="true"></i>':""}\n          ${d>0?`<span class="split-day-time">${Math.floor(d/60)}t ${d%60}m</span>`:""}\n          ${l.length>0?`<span class="split-day-count">${l.length} avtale${1!==l.length?"r":""}</span>`:""}\n        </div>\n        ${l.length>0?renderAreaBadges(l):""}\n        <div class="split-day-content">\n    `,0===l.length&&(o+='<div class="split-day-empty">Ingen avtaler</div>'),l.forEach(e=>{const t=e.kunder?.navn||e.kunde_navn||"Ukjent",n=[e.kunder?.adresse||"",e.kunder?.postnummer||"",e.kunder?.poststed||""].filter(Boolean).join(", "),a=e.kunder?.telefon||e.telefon||"",s=e.opprettet_av&&"admin"!==e.opprettet_av?e.opprettet_av:"",r=s?getCreatorDisplay(s,!0):"",i=getAvtaleServiceColor(e),l=getAvtaleServiceIcon(e),d=customers.find(t=>t.id===e.kunde_id),c=e.varighet||d?.estimert_tid||0;o+=`\n        <div class="split-avtale-card ${"fullført"===e.status?"completed":""}" data-avtale-id="${e.id}" data-action="editAvtale" role="button" tabindex="0"${i?` style="border-left-color:${i}"`:""}>\n          <div class="split-card-header">\n            ${l?`<span class="avtale-service-icon">${l}</span>`:""}\n            ${r?`<span class="split-card-initials" title="${escapeHtml(s)}">${escapeHtml(r)}</span>`:""}\n            <span class="split-card-name">${escapeHtml(t)}</span>\n            ${c?`<span class="avtale-duration">${c}m</span>`:""}\n            <button class="split-card-delete" data-action="quickDeleteAvtale" data-avtale-id="${e.id}" title="Slett avtale" aria-label="Slett avtale"><i class="fas fa-times" aria-hidden="true"></i></button>\n          </div>\n          ${n?`<div class="split-card-addr"><i class="fas fa-map-marker-alt" style="font-size:8px;margin-right:3px;" aria-hidden="true"></i>${escapeHtml(n)}</div>`:""}\n          ${a?`<div class="split-card-phone"><i class="fas fa-phone" aria-hidden="true"></i>${escapeHtml(a)}</div>`:""}\n          ${e.klokkeslett?`<div class="split-card-time"><i class="fas fa-clock" aria-hidden="true"></i>${e.klokkeslett.substring(0,5)}${e.varighet?` (${e.varighet}m)`:""}</div>`:""}\n        </div>\n      `});const c=l.filter(e=>"fullført"!==e.status);o+=`\n        </div>\n        <div class="split-day-footer">\n          <div class="split-day-add" data-date="${n}" data-action="openDayDetail" role="button" tabindex="0">\n            <i class="fas fa-plus" aria-hidden="true"></i> Legg til\n          </div>\n          ${c.length>0?`\n          <div class="split-day-confirm" data-date="${n}" data-action="confirmDay" role="button" tabindex="0">\n            <i class="fas fa-check-double" aria-hidden="true"></i> Bekreft dag\n          </div>\n          `:""}\n        </div>\n      </div>\n    `}o+="</div>",e.innerHTML=o}function renderUpcomingAreas(e){const t=new Date(e);t.setDate(t.getDate()+28);const n=formatDateISO(e),a=formatDateISO(t),s=avtaler.filter(e=>e.dato>=n&&e.dato<=a);if(0===s.length)return"";const o=new Map;if(s.forEach(e=>{const t=e.kunder?.poststed||e.poststed||null;if(!t)return;o.has(t)||o.set(t,{count:0,dates:new Set,customers:[],types:{}});const n=o.get(t);n.count++,n.dates.add(e.dato);const a=e.kunder?.navn||e.kunde_navn||"Ukjent";n.customers.includes(a)||n.customers.push(a);const s=customers.find(t=>t.id===e.kunde_id),r=s?.kategori||e.type||"";r&&(n.types[r]=(n.types[r]||0)+1)}),0===o.size)return"";const r=Array.from(o.entries()).sort((e,t)=>t[1].count-e[1].count);return`\n    <div class="split-upcoming-areas">\n      <div class="split-upcoming-header" data-action="toggleUpcomingAreas" role="button" tabindex="0">\n        <i class="fas fa-map-marked-alt" aria-hidden="true"></i>\n        <span>Kommende områder (${r.length})</span>\n        <i class="fas fa-chevron-down split-upcoming-chevron" aria-hidden="true"></i>\n      </div>\n      <div class="split-upcoming-body" id="splitUpcomingBody">\n        ${r.slice(0,10).map(([e,t])=>{const n=Object.entries(t.types).map(([e,t])=>`<span class="overdue-kat-badge ${e.includes("El")?"kat-el":e.includes("Brann")?"kat-brann":"kat-other"}">${t} ${escapeHtml(e)}</span>`).join("");return`\n          <div class="split-upcoming-item" title="${escapeHtml(t.customers.join(", "))}">\n            <div class="split-upcoming-item-top">\n              <span class="split-upcoming-area"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> ${escapeHtml(e)}</span>\n              <span class="split-upcoming-count">${t.count} avtale${1!==t.count?"r":""}</span>\n              <span class="split-upcoming-days">${t.dates.size} dag${1!==t.dates.size?"er":""}</span>\n            </div>\n            ${n?`<div class="split-upcoming-types">${n}</div>`:""}\n          </div>`}).join("")}\n      </div>\n    </div>\n  `}function showConfirmDayPanel(e){const t=avtaler.filter(t=>t.dato===e&&"fullført"!==t.status);if(0===t.length)return void showToast("Ingen ventende avtaler på denne dagen","info");const n=new Date(e+"T00:00:00").toLocaleDateString("nb-NO",{weekday:"long",day:"numeric",month:"long"});document.getElementById("confirmDayPanel")?.remove();const a=document.createElement("div");a.id="confirmDayPanel",a.className="confirm-day-panel",a.innerHTML=`\n    <div class="confirm-day-header">\n      <div>\n        <strong>Bekreft kontroll — ${escapeHtml(n)}</strong>\n        <div style="font-size:11px;color:var(--color-text-secondary);">${t.length} kunde${1!==t.length?"r":""}</div>\n      </div>\n      <button class="area-select-close" id="closeConfirmDay" aria-label="Lukk">&times;</button>\n    </div>\n    <div class="confirm-day-list">\n      ${t.map(e=>{const t=e.kunder?.navn||e.kunde_navn||"Ukjent",n=e.kunder?.poststed||e.poststed||"",a=customers.find(t=>t.id===e.kunde_id),s=a?.kontroll_intervall_mnd||null;return`\n          <div class="confirm-day-item">\n            <div class="confirm-day-item-info">\n              <span class="confirm-day-item-name">${escapeHtml(t)}</span>\n              ${n?`<span class="confirm-day-item-area">${escapeHtml(n)}</span>`:""}\n            </div>\n            ${s?`<span class="confirm-day-item-interval" title="Intervall fra kategori">${s} mnd</span>`:""}\n          </div>`}).join("")}\n    </div>\n    <div class="confirm-day-interval">\n      <label style="font-size:12px;font-weight:600;">Kontrollintervall</label>\n      <div style="font-size:10px;color:var(--color-text-secondary);margin-bottom:4px;">Kunder med eksisterende intervall beholder sitt. Øvrige får verdien under.</div>\n      <select id="confirmDayIntervalSelect" style="width:100%;padding:6px;border-radius:4px;border:1px solid var(--color-border);background:var(--bg-primary);color:var(--color-text-primary);">\n        <option value="6">6 måneder</option>\n        <option value="12" selected>12 måneder (1 år)</option>\n        <option value="24">24 måneder (2 år)</option>\n        <option value="36">36 måneder (3 år)</option>\n        <option value="48">48 måneder (4 år)</option>\n        <option value="60">60 måneder (5 år)</option>\n      </select>\n    </div>\n    <div class="confirm-day-actions">\n      <button class="btn btn-small btn-secondary" id="confirmDayCancel" style="flex:1;">Avbryt</button>\n      <button class="btn btn-small btn-success" id="confirmDaySubmit" style="flex:2;">\n        <i class="fas fa-check-double" aria-hidden="true"></i> Bekreft ${t.length} kunder\n      </button>\n    </div>\n  `,document.body.appendChild(a),document.getElementById("closeConfirmDay").addEventListener("click",()=>a.remove()),document.getElementById("confirmDayCancel").addEventListener("click",()=>a.remove()),document.getElementById("confirmDaySubmit").addEventListener("click",async()=>{const n=document.getElementById("confirmDaySubmit");n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Bekrefter...';const s=Number.parseInt(document.getElementById("confirmDayIntervalSelect").value)||12;let o=0;for(const e of t)try{(await apiFetch("/api/avtaler/"+e.id+"/complete",{method:"POST"})).ok&&o++}catch(e){console.error("Error completing avtale:",e)}const r=[...new Set(t.map(e=>e.kunde_id).filter(Boolean))];if(r.length>0){const n=[...new Set(t.map(e=>e.type).filter(Boolean))].map(e=>e.toLowerCase().replace(/\s+/g,"-"));try{await apiFetch("/api/kunder/mark-visited",{method:"POST",body:JSON.stringify({kunde_ids:r,visited_date:e,service_type_slugs:n})})}catch(e){console.error("Error marking visited:",e)}for(const e of r){const t=customers.find(t=>t.id===e);if(t&&!t.kontroll_intervall_mnd)try{await apiFetch("/api/kunder/"+e,{method:"PUT",body:JSON.stringify({kontroll_intervall_mnd:s})})}catch(e){console.error("Error updating interval:",e)}}}a.remove(),showToast(`${o} avtale${1!==o?"r":""} fullført — neste kontroll beregnet`,"success"),await loadAvtaler(),await loadCustomers(),renderCalendar(),splitViewOpen&&renderSplitWeekContent()})}function setupSplitDivider(){const e=document.getElementById("calendarSplitDivider"),t=document.getElementById("calendarSplitPanel"),n=document.getElementById("calendarSplitOverlay");if(!e||!t||!n)return;let a=!1;const s=t=>{a=!0,e.classList.add("dragging"),document.body.style.cursor="col-resize",document.body.style.userSelect="none",t.preventDefault()},o=e=>{if(!a)return;const s=n.getBoundingClientRect(),o=e.clientX-s.left,r=s.width-200;t.style.width=Math.max(400,Math.min(r,o))+"px"},r=()=>{a&&(a=!1,e.classList.remove("dragging"),document.body.style.cursor="",document.body.style.userSelect="",setTimeout(()=>{window.map&&window.map.invalidateSize()},50))};e.addEventListener("mousedown",s),document.addEventListener("mousemove",o),document.addEventListener("mouseup",r),e.addEventListener("touchstart",t=>{a=!0,e.classList.add("dragging"),t.preventDefault()},{passive:!1}),document.addEventListener("touchmove",e=>{if(!a)return;const s=e.touches[0],o=n.getBoundingClientRect(),r=s.clientX-o.left,i=o.width-200;t.style.width=Math.max(400,Math.min(i,r))+"px"},{passive:!0}),document.addEventListener("touchend",r);const i=splitDividerCleanup;splitDividerCleanup=()=>{i&&i(),e.removeEventListener("mousedown",s),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r),document.removeEventListener("touchend",r)}}const _origLoadAvtaler=loadAvtaler;function openAvtaleModal(e=null,t=null){const n=document.getElementById("avtaleModal"),a=document.getElementById("avtaleForm"),s=document.getElementById("avtaleModalTitle"),o=document.getElementById("deleteAvtaleBtn"),r=document.getElementById("deleteAvtaleSeriesBtn"),i=document.getElementById("avtaleKundeSearch"),l=document.getElementById("avtaleKunde"),d=document.getElementById("avtaleKundeResults"),c=document.getElementById("avtaleType"),u=document.getElementById("avtaleGjentakelse"),m=document.getElementById("avtaleGjentakelseSluttGroup"),p=document.getElementById("avtaleGjentakelseGroup");if(c&&(c.innerHTML=serviceTypeRegistry.renderCategoryOptions("")),i.value="",l.value="",d.innerHTML="",d.classList.remove("active"),u.onchange=function(){m.classList.toggle("hidden",!this.value)},e){s.textContent="Rediger avtale",document.getElementById("avtaleId").value=e.id,l.value=e.kunde_id;const t=customers.find(t=>t.id===e.kunde_id);t&&(i.value=`${t.navn} (${t.poststed||"Ukjent"})`),document.getElementById("avtaleDato").value=e.dato,document.getElementById("avtaleKlokkeslett").value=e.klokkeslett||"",document.getElementById("avtaleType").value=e.type||serviceTypeRegistry.getDefaultServiceType().name,document.getElementById("avtaleBeskrivelse").value=e.beskrivelse||"",u.value=e.gjentakelse_regel||"",document.getElementById("avtaleGjentakelseSlutt").value=e.gjentakelse_slutt||"",m.classList.toggle("hidden",!e.gjentakelse_regel),p.style.display="none",m.style.display="none",o.style.display="inline-block";const n=e.er_gjentakelse||e.original_avtale_id;r.style.display=n?"inline-block":"none"}else s.textContent="Ny avtale",a.reset(),document.getElementById("avtaleId").value="",i.value="",l.value="",u.value="",document.getElementById("avtaleGjentakelseSlutt").value="",m.classList.add("hidden"),p.style.display="",t&&(document.getElementById("avtaleDato").value=t),o.style.display="none",r.style.display="none";n.classList.remove("hidden"),setTimeout(()=>i.focus(),100)}function setupAvtaleKundeSearch(){const e=document.getElementById("avtaleKundeSearch"),t=document.getElementById("avtaleKunde"),n=document.getElementById("avtaleKundeResults");e&&(e.addEventListener("input",function(){const e=this.value.toLowerCase().trim();if(e.length<1)return n.innerHTML="",void n.classList.remove("active");const t=sortByNavn(customers.filter(t=>t.navn.toLowerCase().includes(e)||t.poststed&&t.poststed.toLowerCase().includes(e)||t.adresse&&t.adresse.toLowerCase().includes(e))).slice(0,10);if(0===t.length)return n.innerHTML='<div class="kunde-search-item no-results">Ingen kunder funnet</div>',void n.classList.add("active");n.innerHTML=t.map(e=>`\n      <div class="kunde-search-item" data-id="${e.id}" data-name="${escapeHtml(e.navn)} (${e.poststed||"Ukjent"})">\n        <span class="kunde-name">${escapeHtml(e.navn)}</span>\n        <span class="kunde-location">${e.poststed||"Ukjent"}</span>\n      </div>\n    `).join(""),n.classList.add("active")}),n.addEventListener("click",function(a){const s=a.target.closest(".kunde-search-item");s&&!s.classList.contains("no-results")&&(t.value=s.dataset.id,e.value=s.dataset.name,n.innerHTML="",n.classList.remove("active"))}),document.addEventListener("click",function(e){e.target.closest(".kunde-search-wrapper")||n.classList.remove("active")}),e.addEventListener("keydown",function(a){const s=n.querySelectorAll(".kunde-search-item:not(.no-results)"),o=n.querySelector(".kunde-search-item.active");if("ArrowDown"===a.key)a.preventDefault(),!o&&s.length>0?s[0].classList.add("active"):o&&o.nextElementSibling&&(o.classList.remove("active"),o.nextElementSibling.classList.add("active"));else if("ArrowUp"===a.key)a.preventDefault(),o&&o.previousElementSibling&&(o.classList.remove("active"),o.previousElementSibling.classList.add("active"));else if("Enter"===a.key){a.preventDefault();const r=o||s[0];r&&!r.classList.contains("no-results")&&(t.value=r.dataset.id,e.value=r.dataset.name,n.innerHTML="",n.classList.remove("active"))}}))}function closeAvtaleModal(){document.getElementById("avtaleModal").classList.add("hidden")}async function saveAvtale(e){e.preventDefault();const t=document.getElementById("avtaleId").value,n=document.getElementById("avtaleGjentakelse").value,a={kunde_id:Number.parseInt(document.getElementById("avtaleKunde").value),dato:document.getElementById("avtaleDato").value,klokkeslett:document.getElementById("avtaleKlokkeslett").value||null,type:document.getElementById("avtaleType").value,beskrivelse:document.getElementById("avtaleBeskrivelse").value||null,opprettet_av:localStorage.getItem("userName")||"admin",...n&&!t?{gjentakelse_regel:n,gjentakelse_slutt:document.getElementById("avtaleGjentakelseSlutt").value||void 0}:{}};try{let e;if(e=t?await apiFetch(`/api/avtaler/${t}`,{method:"PUT",body:JSON.stringify(a)}):await apiFetch("/api/avtaler",{method:"POST",body:JSON.stringify(a)}),e.ok)await loadAvtaler(),renderCalendar(),applyFilters(),closeAvtaleModal();else{showMessage("Kunne ikke lagre: "+((await e.json()).error||"Ukjent feil"),"error")}}catch(e){console.error("Error saving avtale:",e),showMessage("Kunne ikke lagre avtalen. Prøv igjen.","error")}}async function deleteAvtale(){const e=document.getElementById("avtaleId").value;if(!e)return;if(await showConfirm("Er du sikker på at du vil slette denne avtalen?","Slette avtale"))try{(await apiFetch(`/api/avtaler/${e}`,{method:"DELETE"})).ok&&(await loadAvtaler(),renderCalendar(),applyFilters(),closeAvtaleModal())}catch(e){console.error("Error deleting avtale:",e),showMessage("Kunne ikke slette avtalen. Prøv igjen.","error")}}async function deleteAvtaleSeries(){const e=document.getElementById("avtaleId").value;if(!e)return;if(await showConfirm("Er du sikker på at du vil slette hele serien? Alle gjentakende avtaler i denne serien vil bli slettet.","Slette avtaleserie"))try{const t=await apiFetch(`/api/avtaler/${e}/series`,{method:"DELETE"});if(t.ok){showMessage(`${(await t.json()).data.deletedCount} avtaler slettet`,"success"),await loadAvtaler(),renderCalendar(),applyFilters(),closeAvtaleModal()}}catch(e){console.error("Error deleting avtale series:",e),showMessage("Kunne ikke slette avtaleserien. Prøv igjen.","error")}}function renderPlanner(){initSmartRouteSettingsListeners(),renderSmartRecommendations()}function createRouteForAreaYear(e,t){(new Date).setHours(0,0,0,0);const n=customers.filter(n=>{if(!n.neste_kontroll)return!1;return new Date(n.neste_kontroll).getFullYear()===Number.parseInt(t)&&n.poststed===e});if(0===n.length)return void showMessage(`Ingen kunder i ${e} for ${t}`,"info");selectedCustomers.clear(),n.forEach(e=>{e.lat&&e.lng&&selectedCustomers.add(e.id)}),updateSelectionUI(),showNotification(`${n.filter(e=>e.lat&&e.lng).length} kunder valgt for ${e} - ${t}. Bruk "Planlegg rute" for å beregne rute.`);const a=n.filter(e=>e.lat&&e.lng);if(a.length>0){const e=L.latLngBounds(a.map(e=>[e.lat,e.lng]));map.fitBounds(e,{padding:[50,50]})}}async function selectCustomersNeedingControl(){try{const e=await apiFetch("/api/kunder/kontroll-varsler?dager=30"),t=await e.json(),n=t.data||t;if(selectedCustomers.clear(),n.forEach(e=>{e.lat&&e.lng&&selectedCustomers.add(e.id)}),updateSelectionUI(),selectedCustomers.size>0){const e=customers.filter(e=>selectedCustomers.has(e.id)&&e.lat&&e.lng);if(e.length>0){const t=L.latLngBounds(e.map(e=>[e.lat,e.lng]));map.fitBounds(t,{padding:[50,50]})}}}catch(e){console.error("Feil ved henting av varsler:",e)}}function checkLoginStatus(){const e=!1===appConfig.requireAuth||"false"===appConfig.requireAuth;if(Logger.log("checkLoginStatus: requireAuth =",appConfig.requireAuth,"-> authDisabled =",e),e){Logger.log("Auth disabled - bypassing login");const e=document.getElementById("userBar");return e&&(e.style.display="none"),!0}const t=localStorage.getItem("userName"),n=localStorage.getItem("userRole"),a=document.getElementById("userBar"),s=document.getElementById("userNameDisplay");if(!t)return showLoginView(),!1;reloadConfigWithAuth(),a&&(a.style.display="flex",s&&(s.textContent=t||"Bruker"));const o=document.querySelector('.tab-item[data-tab="email"]');return o&&!(n&&"admin"===n)&&(o.style.display="none"),!0}function logoutUser(e=!1){stopTokenRefresh();const t={"Content-Type":"application/json"},n=getCsrfToken();n&&(t["X-CSRF-Token"]=n),fetch("/api/klient/logout",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({logoutAll:e})}).catch(()=>{setTimeout(()=>{fetch("/api/klient/logout",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({logoutAll:e})}).catch(e=>console.error("Logout retry failed:",e))},1e3)}),localStorage.removeItem("userName"),localStorage.removeItem("userEmail"),localStorage.removeItem("userRole"),localStorage.removeItem("userType"),localStorage.removeItem("isSuperAdmin"),localStorage.removeItem("isImpersonating"),localStorage.removeItem("impersonatingOrgName"),localStorage.removeItem("organizationId"),localStorage.removeItem("organizationSlug"),localStorage.removeItem("organizationName"),localStorage.removeItem("appMode"),localStorage.removeItem("industrySlug"),localStorage.removeItem("industryName"),authToken=null,stopInactivityTracking(),showLoginView()}loadAvtaler=async function(){await _origLoadAvtaler(),splitViewOpen&&renderSplitWeekContent()};const INACTIVITY_TIMEOUT_MS=9e5,INACTIVITY_WARNING_MS=78e4;let inactivityTimer=null,inactivityWarningTimer=null,inactivityWarningVisible=!1;function resetInactivityTimers(){inactivityWarningVisible||(clearTimeout(inactivityTimer),clearTimeout(inactivityWarningTimer),(authToken||document.cookie.includes("skyplanner_session"))&&(inactivityWarningTimer=setTimeout(showInactivityWarning,78e4),inactivityTimer=setTimeout(()=>{dismissInactivityWarning(),logoutUser()},9e5)))}function showInactivityWarning(){if(inactivityWarningVisible)return;inactivityWarningVisible=!0;const e=document.getElementById("inactivityWarningModal");e&&e.remove();const t=document.createElement("div");t.id="inactivityWarningModal",t.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;";let n=120;t.innerHTML=`\n    <div style="background:var(--card-bg, #1a1a2e);border-radius:12px;padding:32px;max-width:420px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.4);">\n      <div style="width:64px;height:64px;margin:0 auto 20px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:50%;display:flex;align-items:center;justify-content:center;">\n        <i class="fas fa-clock" style="font-size:28px;color:white;"></i>\n      </div>\n      <h2 style="color:var(--text-primary, #fff);margin:0 0 12px;font-size:20px;">Inaktivitet oppdaget</h2>\n      <p style="color:var(--text-secondary, #a0a0a0);margin:0 0 8px;font-size:15px;">Du logges ut om <strong id="inactivityCountdown">${n}</strong> sekunder på grunn av inaktivitet.</p>\n      <p style="color:var(--text-muted, #666);margin:0 0 24px;font-size:13px;">Klikk knappen under for å forbli innlogget.</p>\n      <button id="extendSessionBtn" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;padding:12px 32px;border-radius:8px;font-size:15px;cursor:pointer;font-weight:600;">Fortsett sesjonen</button>\n    </div>\n  `,document.body.appendChild(t);const a=document.getElementById("inactivityCountdown"),s=setInterval(()=>{n--,a&&(a.textContent=n),n<=0&&clearInterval(s)},1e3);document.getElementById("extendSessionBtn").addEventListener("click",()=>{clearInterval(s),dismissInactivityWarning(),resetInactivityTimers()}),t._countdownInterval=s}function dismissInactivityWarning(){inactivityWarningVisible=!1;const e=document.getElementById("inactivityWarningModal");e&&(e._countdownInterval&&clearInterval(e._countdownInterval),e.remove())}function startInactivityTracking(){["mousedown","keydown","scroll","touchstart"].forEach(e=>{document.addEventListener(e,resetInactivityTimers,{passive:!0})}),resetInactivityTimers()}function stopInactivityTracking(){clearTimeout(inactivityTimer),clearTimeout(inactivityWarningTimer),dismissInactivityWarning()}function sendManualReminder(e){const t=customers.find(t=>t.id===e);if(!t)return;if(!t.epost)return void showMessage(`${t.navn} har ingen e-postadresse registrert.`,"warning");const n=t.kategori||"El-kontroll",a=appConfig.companyName||"Sky Planner",s=encodeURIComponent(`${n} - Avtale tid for kontroll`),o=encodeURIComponent(`Hei!\n\nVi ønsker å avtale tid for ${n.toLowerCase()} hos ${t.navn}.\n\nAdresse: ${t.adresse||""}, ${t.postnummer||""} ${t.poststed||""}\n\nVennligst gi beskjed om når det passer for deg.\n\nMed vennlig hilsen\n${a}`);window.location.href=`mailto:${t.epost}?subject=${s}&body=${o}`}function getOverdueCustomers(){const e=new Date;e.setHours(0,0,0,0);const t=12*e.getFullYear()+e.getMonth();return customers.filter(e=>{if(!e.neste_kontroll)return!1;const n=new Date(e.neste_kontroll);return 12*n.getFullYear()+n.getMonth()<t})}function showOverdueOnMap(){const e=getOverdueCustomers();if(0===e.length)return void showMessage("Ingen forfalte kontroller å vise på kartet.","info");selectedCustomers.clear(),e.forEach(e=>selectedCustomers.add(e.id)),renderMarkers(customers);const t=L.latLngBounds(e.filter(e=>e.lat&&e.lng).map(e=>[e.lat,e.lng]));t.isValid()&&map.fitBounds(t,{padding:[50,50]});const n=document.createElement("div");n.className="map-notification",n.innerHTML=`<i class="fas fa-map-marker-alt"></i> Viser ${e.length} forfalte kunder på kartet`,document.querySelector(".map-container")?.appendChild(n),setTimeout(()=>n.remove(),3e3)}function showCustomersOnMap(e){const t=customers.filter(t=>e.includes(t.id));if(0===t.length)return;selectedCustomers.clear(),t.forEach(e=>selectedCustomers.add(e.id)),renderMarkers(customers);const n=L.latLngBounds(t.filter(e=>e.lat&&e.lng).map(e=>[e.lat,e.lng]));n.isValid()&&map.fitBounds(n,{padding:[50,50]})}async function createOverdueRoute(){const e=getOverdueCustomers();if(0!==e.length){if(e.length>25){if(!await showConfirm(`Du har ${e.length} forfalte kontroller. OpenRouteService har en grense på 25 stopp per rute. Vil du velge de 25 mest kritiske?`,"For mange kontroller"))return;const t=new Date;t.setHours(0,0,0,0),e.sort((e,n)=>{const a=Math.ceil((t-new Date(e.neste_kontroll))/864e5);return Math.ceil((t-new Date(n.neste_kontroll))/864e5)-a}),e.length=25}createRouteFromCustomerIds(e.map(e=>e.id))}else showMessage("Ingen forfalte kontroller å lage rute for.","info")}function createRouteFromCustomerIds(e){const t=customers.filter(t=>e.includes(t.id)&&t.lat&&t.lng);0!==t.length?t.length>25?showMessage("Maks 25 stopp per rute. Velg færre kunder.","warning"):(selectedCustomers.clear(),t.forEach(e=>selectedCustomers.add(e.id)),updateSelectionUI()):showMessage("Ingen kunder med gyldige koordinater.","warning")}async function loadEmailData(){await Promise.all([loadEmailStats(),loadEmailUpcoming(),loadEmailStatus(),loadEmailHistory()])}async function loadEmailStats(){try{const e=await apiFetch("/api/email/stats");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();document.getElementById("statPending").textContent=t.pending||0,document.getElementById("statSent").textContent=t.sent||0,document.getElementById("statFailed").textContent=t.failed||0}catch(e){console.error("Feil ved lasting av e-post-statistikk:",e)}}async function loadEmailUpcoming(){try{const e=await apiFetch("/api/email/upcoming");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json(),n=document.getElementById("emailUpcomingContent"),a=document.getElementById("upcomingCount");if(!n)return;if(a&&(a.textContent=t.length),0===t.length)return void(n.innerHTML='<div class="upcoming-empty">Ingen kommende varsler de neste 30 dagene</div>');n.innerHTML=t.map(e=>{const t=e.days_until;let n="normal",a=`${t} dager`;t<=0?(n="urgent",a=0===t?"I dag":`${Math.abs(t)} dager siden`):t<=10?n="urgent":t<=30&&(n="soon");const s=e.epost&&""!==e.epost.trim();return`\n        <div class="upcoming-item" data-customer-id="${e.id}">\n          <div class="upcoming-info">\n            <span class="upcoming-name">${escapeHtml(e.navn)}</span>\n            <span class="upcoming-email">${escapeHtml(e.epost||"Mangler e-post")}</span>\n          </div>\n          <div class="upcoming-actions">\n            <button class="upcoming-email-btn ${s?"":"disabled"}"\n                    data-action="sendEmail"\n                    data-customer-id="${e.id}"\n                    title="${s?"Send e-post":"Ingen e-post registrert"}">\n              <i class="fas fa-envelope"></i>\n            </button>\n            <span class="upcoming-days ${n}">${a}</span>\n          </div>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av kommende varsler:",e)}}async function loadEmailStatus(){try{const e=await apiFetch("/api/email/status");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json(),n=document.getElementById("emailStatusContent");if(!n)return;n.innerHTML=`\n      <div class="config-item">\n        <span class="config-label">E-postvarsling</span>\n        <span class="config-value ${t.enabled?"enabled":"disabled"}">\n          ${t.enabled?"Aktivert":"Deaktivert"}\n        </span>\n      </div>\n      <div class="config-item">\n        <span class="config-label">E-post server</span>\n        <span class="config-value ${t.emailConfigured?"enabled":"disabled"}">\n          ${t.emailConfigured?"Konfigurert":"Ikke konfigurert"}\n        </span>\n      </div>\n      <div class="config-item">\n        <span class="config-label">Første varsel</span>\n        <span class="config-value">${t.firstReminderDays} dager før</span>\n      </div>\n      <div class="config-item">\n        <span class="config-label">Påminnelse</span>\n        <span class="config-value">${t.reminderAfterDays} dager etter første</span>\n      </div>\n    `}catch(e){console.error("Feil ved lasting av e-post-status:",e)}}async function loadEmailHistory(e="all"){try{const t=await apiFetch("/api/email/historikk?limit=50");if(!t.ok)throw new Error(`HTTP ${t.status}`);let n=await t.json();"all"!==e&&(n=n.filter(t=>t.status===e));const a=document.getElementById("emailHistoryContent");if(!a)return;if(0===n.length)return void(a.innerHTML='<div class="email-history-empty">Ingen varsler å vise</div>');a.innerHTML=n.map(e=>{const t={sent:"Sendt",failed:"Feilet",pending:"Venter"}[e.status]||e.status;return`\n        <div class="email-history-item">\n          <div class="history-header">\n            <span class="history-customer">${escapeHtml(e.kunde_navn||"Test")}</span>\n            <span class="history-status ${escapeHtml(e.status)}">${escapeHtml(t)}</span>\n          </div>\n          <div class="history-subject">${escapeHtml(e.emne||"")}</div>\n          <div class="history-message">${escapeHtml(e.melding.substring(0,80))}${e.melding.length>80?"...":""}</div>\n          <div class="history-date">${new Date(e.opprettet).toLocaleString("nb-NO",{timeZone:"Europe/Oslo"})}</div>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av e-post-historikk:",e)}}async function sendTestEmail(){const e=document.getElementById("testEmailAddress")?.value,t=document.getElementById("testEmailMessage")?.value;if(!e)return void showMessage("Skriv inn en e-postadresse","warning");const n=document.getElementById("sendTestEmailBtn");n&&(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sender...');try{const n=await apiFetch("/api/email/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({epost:e,melding:t})}),a=await n.json();a.success?(showMessage("Test e-post sendt!","success"),loadEmailHistory()):showMessage("Feil ved sending: "+(a.error?.message||("string"==typeof a.error?a.error:null)||"Ukjent feil"),"error")}catch(e){console.error("Feil ved sending av test e-post:",e),showMessage("Kunne ikke sende e-post. Prøv igjen.","error")}finally{n&&(n.disabled=!1,n.innerHTML='<i class="fas fa-paper-plane"></i> Send Test')}}async function triggerEmailCheck(){const e=document.getElementById("triggerEmailCheckBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sender...');try{const e=await apiFetch("/api/email/send-varsler",{method:"POST"}),t=await e.json();showMessage(`Varselsjekk fullført! Sendt: ${t.sent}, Hoppet over: ${t.skipped}, Feil: ${t.errors}`,"success","Varsler sendt"),loadEmailData()}catch(e){console.error("Feil ved varselsjekk:",e),showMessage("Kunne ikke kjøre varselsjekk","error")}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-paper-plane"></i><span>Send varsler nå</span>')}}async function loadCustomerEmailSettings(e){try{const t=await apiFetch(`/api/email/innstillinger/${e}`),n=await t.json(),a=document.getElementById("emailAktiv"),s=document.getElementById("forsteVarsel"),o=document.getElementById("paaminnelseEtter"),r=document.getElementById("emailOptions");a&&(a.checked=1===n.email_aktiv),s&&(s.value=n.forste_varsel_dager),o&&(o.value=n.paaminnelse_etter_dager),r&&r.classList.toggle("hidden",!a?.checked)}catch(e){console.error("Feil ved lasting av e-post-innstillinger:",e)}}async function saveCustomerEmailSettings(e){const t=document.getElementById("emailAktiv")?.checked,n=document.getElementById("forsteVarsel")?.value,a=document.getElementById("paaminnelseEtter")?.value;try{await apiFetch(`/api/email/innstillinger/${e}`,{method:"PUT",body:JSON.stringify({email_aktiv:t,forste_varsel_dager:Number.parseInt(n)||30,paaminnelse_etter_dager:Number.parseInt(a)||7})})}catch(e){console.error("Feil ved lagring av e-post-innstillinger:",e),showMessage("Kunne ikke lagre e-post-innstillinger. Prøv igjen.","error")}}let currentKontaktloggKundeId=null;async function loadAllSubcategoryAssignments(){try{const e=await apiFetch("/api/subcategories/kunde-assignments");if(e.ok){const t=(await e.json()).data||[];kundeSubcatMap={},t.forEach(e=>{kundeSubcatMap[e.kunde_id]||(kundeSubcatMap[e.kunde_id]=[]),kundeSubcatMap[e.kunde_id].push({group_id:e.group_id,subcategory_id:e.subcategory_id})})}}catch(e){console.error("Error loading subcategory assignments:",e)}renderSubcategoryFilter()}async function loadKundeSubcategories(e){try{const t=await apiFetch(`/api/subcategories/kunde/${e}`);if(!t.ok)return;const n=(await t.json()).data||[];kundeSubcatMap[e]=n.map(e=>({group_id:e.group_id,subcategory_id:e.subcategory_id}));renderSubcategoryDropdowns(customers.find(t=>t.id===e)||{id:e})}catch(e){console.error("Error loading kunde subcategories:",e)}}function openSubcategoryManager(){const e=document.getElementById("subcatManagerModal");e&&e.remove();const t=document.createElement("div");t.id="subcatManagerModal",t.className="modal",t.innerHTML='\n    <div class="modal-content" style="max-width:560px">\n      <div class="modal-header">\n        <h2>Administrer underkategorier</h2>\n        <button class="modal-close" id="closeSubcatManager">&times;</button>\n      </div>\n      <div id="subcatManagerBody" style="max-height:60vh;overflow-y:auto;padding:12px;"></div>\n    </div>\n  ',document.body.appendChild(t),renderSubcatManagerBody(),document.getElementById("closeSubcatManager").addEventListener("click",()=>t.remove()),t.addEventListener("click",e=>{e.target===t&&t.remove()})}async function renderSubcatManagerBody(){const e=document.getElementById("subcatManagerBody");if(!e)return;const t=allSubcategoryGroups||[];let n="";0===t.length&&(n+='<p style="padding:8px 0;color:var(--color-text-muted);font-size:13px;">\n      Ingen underkategori-grupper opprettet enda.\n    </p>');for(const e of t){const t=e.subcategories||[];n+=`\n      <div class="subcat-group-item" data-group-id="${e.id}" style="margin-bottom:12px;border:1px solid var(--color-border);border-radius:6px;padding:10px;">\n        <div style="display:flex;align-items:center;gap:6px;padding:4px 0;">\n          <i class="fas fa-folder" style="color:var(--color-text-muted);font-size:12px;"></i>\n          <strong style="font-size:13px;">${escapeHtml(e.navn)}</strong>\n          <span style="font-size:11px;color:var(--color-text-muted)">(${t.length})</span>\n          <button class="btn-icon-tiny btn-icon-danger" data-action="deleteGroup" data-group-id="${e.id}" title="Slett gruppe">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n        <div style="margin-left:12px;">\n          ${t.map(e=>`\n            <div style="display:flex;align-items:center;gap:4px;padding:2px 0;font-size:13px;">\n              <span>${escapeHtml(e.navn)}</span>\n              <button class="btn-icon-tiny btn-icon-danger" data-action="deleteSubcat" data-subcat-id="${e.id}" title="Slett">\n                <i class="fas fa-trash"></i>\n              </button>\n            </div>\n          `).join("")}\n          <div style="display:flex;gap:4px;margin-top:4px;">\n            <input type="text" class="subcat-inline-input" placeholder="Ny underkategori..." maxlength="100" data-group-id="${e.id}" style="flex:1;padding:4px 8px;font-size:12px;border:1px solid var(--color-border);border-radius:4px;">\n            <button class="btn btn-small btn-primary subcat-inline-add" data-group-id="${e.id}" style="padding:4px 8px;">\n              <i class="fas fa-plus"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n    `}n+='\n    <div style="margin-top:8px;">\n      <div style="display:flex;gap:4px;">\n        <input type="text" class="new-group-input" placeholder="Ny gruppe..." maxlength="100" style="flex:1;padding:4px 8px;font-size:12px;border:1px solid var(--color-border);border-radius:4px;">\n        <button class="btn btn-small btn-secondary new-group-add" style="padding:4px 8px;">\n          <i class="fas fa-plus"></i> Gruppe\n        </button>\n      </div>\n    </div>\n  ',e.innerHTML=n,attachSubcatManagerHandlers()}function attachSubcatManagerHandlers(){const e=document.getElementById("subcatManagerBody");e&&(e.querySelectorAll('[data-action="deleteGroup"]').forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.groupId;if(!confirm("Slett denne gruppen og alle underkategorier?"))return;(await apiFetch(`/api/subcategories/groups/${t}`,{method:"DELETE"})).ok&&(await reloadServiceTypesAndRefresh(),renderSubcatManagerBody())})}),e.querySelectorAll('[data-action="deleteSubcat"]').forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.subcatId;(await apiFetch(`/api/subcategories/items/${t}`,{method:"DELETE"})).ok&&(await reloadServiceTypesAndRefresh(),renderSubcatManagerBody())})}),e.querySelectorAll(".subcat-inline-add").forEach(e=>{e.addEventListener("click",()=>addSubcategoryInline(Number(e.dataset.groupId)))}),e.querySelectorAll(".subcat-inline-input").forEach(e=>{e.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),addSubcategoryInline(Number(e.dataset.groupId)))})}),e.querySelectorAll(".new-group-add").forEach(e=>{e.addEventListener("click",()=>addGroupInline())}),e.querySelectorAll(".new-group-input").forEach(e=>{e.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),addGroupInline())})}))}async function addSubcategoryInline(e){const t=document.querySelector(`.subcat-inline-input[data-group-id="${e}"]`),n=t?.value?.trim();if(n)try{const a=await apiFetch("/api/subcategories/items",{method:"POST",body:JSON.stringify({group_id:e,navn:n})});if(a.ok)t.value="",await reloadServiceTypesAndRefresh(),renderSubcatManagerBody();else{const e=await a.json();showMessage(e.error?.message||"Kunne ikke opprette underkategori","error")}}catch(e){console.error("Error creating subcategory:",e)}}async function addGroupInline(){const e=document.querySelector(".new-group-input"),t=e?.value?.trim();if(t)try{const n=await apiFetch("/api/subcategories/groups",{method:"POST",body:JSON.stringify({navn:t})});if(n.ok)e.value="",await reloadServiceTypesAndRefresh(),renderSubcatManagerBody();else{const e=await n.json();showMessage(e.error?.message||"Kunne ikke opprette gruppe","error")}}catch(e){console.error("Error creating group:",e)}}async function reloadServiceTypesAndRefresh(){try{const e=await apiFetch("/api/config");if(e.ok){const t=await e.json();serviceTypeRegistry.loadFromConfig(t.data),allSubcategoryGroups=t.data.subcategoryGroups||[]}}catch(e){console.error("Error reloading service types:",e)}}async function loadKontaktlogg(e){currentKontaktloggKundeId=e;const t=document.getElementById("kontaktloggList");try{const n=await apiFetch(`/api/kunder/${e}/kontaktlogg`);if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json();if(0===a.length)return void(t.innerHTML='<div class="kontaktlogg-empty">Ingen registrerte kontakter</div>');t.innerHTML=a.map(e=>{const t=new Date(e.dato).toLocaleDateString("nb-NO",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return`\n        <div class="kontaktlogg-item" data-id="${e.id}">\n          <div class="kontaktlogg-info">\n            <div class="kontaktlogg-header">\n              <span class="kontaktlogg-type">${escapeHtml(e.type)}</span>\n              <span class="kontaktlogg-date">${t}</span>\n            </div>\n            ${e.notat?`<div class="kontaktlogg-notat">${escapeHtml(e.notat)}</div>`:""}\n          </div>\n          <button type="button" class="kontaktlogg-delete" data-action="deleteKontakt" data-id="${e.id}" title="Slett">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av kontaktlogg:",e),t.innerHTML='<div class="kontaktlogg-empty">Feil ved lasting</div>'}}async function addKontaktlogg(){if(!currentKontaktloggKundeId)return;const e=document.getElementById("kontaktType"),t=document.getElementById("kontaktNotat"),n=e.value,a=t.value.trim();if(!a)return showMessage("Vennligst skriv et notat","warning"),void t.focus();try{await apiFetch(`/api/kunder/${currentKontaktloggKundeId}/kontaktlogg`,{method:"POST",body:JSON.stringify({type:n,notat:a,opprettet_av:localStorage.getItem("userName")||"Ukjent"})}),t.value="",await loadKontaktlogg(currentKontaktloggKundeId)}catch(e){console.error("Feil ved lagring av kontakt:",e),showMessage("Feil ved lagring av kontakt","error")}}async function deleteKontaktlogg(e){if(await showConfirm("Slette denne kontaktregistreringen?","Slette kontakt"))try{await apiFetch(`/api/kontaktlogg/${e}`,{method:"DELETE"}),await loadKontaktlogg(currentKontaktloggKundeId)}catch(e){console.error("Feil ved sletting av kontakt:",e)}}let currentKontaktpersonerKundeId=null;async function loadKontaktpersoner(e){currentKontaktpersonerKundeId=e;const t=document.getElementById("kontaktpersonerList");document.getElementById("kontaktpersonerSection").style.display="block";try{const n=await apiFetch(`/api/kunder/${e}/kontaktpersoner`);if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=(await n.json()).data||[];if(0===a.length)return void(t.innerHTML='<div class="kontaktpersoner-empty">Ingen registrerte kontaktpersoner</div>');const s={teknisk:"Teknisk",faktura:"Faktura",daglig:"Daglig leder",annet:"Annet"};t.innerHTML=a.map(e=>{const t=e.rolle?`<span class="kontaktperson-rolle">${escapeHtml(s[e.rolle]||e.rolle)}</span>`:"",n=e.er_primaer?'<span class="kontaktperson-primaer-badge"><i class="fas fa-star"></i> Primær</span>':"";return`\n        <div class="kontaktperson-item" data-id="${e.id}">\n          <div class="kontaktperson-info">\n            <div class="kontaktperson-header">\n              <span class="kontaktperson-navn">${escapeHtml(e.navn)}</span>\n              ${t}\n              ${n}\n            </div>\n            <div class="kontaktperson-details">\n              ${e.telefon?`<span class="kontaktperson-detail"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</span>`:""}\n              ${e.epost?`<span class="kontaktperson-detail"><i class="fas fa-envelope"></i> ${escapeHtml(e.epost)}</span>`:""}\n            </div>\n          </div>\n          <button type="button" class="kontaktperson-delete" data-action="deleteKontaktperson" data-id="${e.id}" title="Slett">\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      `}).join("")}catch(e){console.error("Feil ved lasting av kontaktpersoner:",e),t.innerHTML='<div class="kontaktpersoner-empty">Feil ved lasting</div>'}}async function addKontaktperson(){if(!currentKontaktpersonerKundeId)return;const e=document.getElementById("kontaktpersonNavn"),t=document.getElementById("kontaktpersonRolle"),n=document.getElementById("kontaktpersonTelefon"),a=document.getElementById("kontaktpersonEpost"),s=document.getElementById("kontaktpersonPrimaer"),o=e.value.trim();if(!o)return showMessage("Vennligst fyll inn navn","warning"),void e.focus();try{await apiFetch(`/api/kunder/${currentKontaktpersonerKundeId}/kontaktpersoner`,{method:"POST",body:JSON.stringify({navn:o,rolle:t.value||void 0,telefon:n.value.trim()||void 0,epost:a.value.trim()||void 0,er_primaer:s.checked})}),e.value="",t.value="",n.value="",a.value="",s.checked=!1,await loadKontaktpersoner(currentKontaktpersonerKundeId)}catch(e){console.error("Feil ved lagring av kontaktperson:",e),showMessage("Feil ved lagring av kontaktperson","error")}}async function deleteKontaktperson(e){if(await showConfirm("Slette denne kontaktpersonen?","Slette kontaktperson"))try{await apiFetch(`/api/kontaktpersoner/${e}`,{method:"DELETE"}),await loadKontaktpersoner(currentKontaktpersonerKundeId)}catch(e){console.error("Feil ved sletting av kontaktperson:",e)}}function renderMissingData(){const e=customers.filter(e=>!e.telefon||""===e.telefon.trim()),t=customers.filter(e=>!e.epost||""===e.epost.trim()),n=customers.filter(e=>null===e.lat||null===e.lng),a=customers.filter(e=>!e.neste_kontroll&&!e.neste_el_kontroll&&!e.neste_brann_kontroll);document.getElementById("missingPhoneCount").textContent=e.length,document.getElementById("missingEmailCount").textContent=t.length,document.getElementById("missingCoordsCount").textContent=n.length,document.getElementById("missingControlCount").textContent=a.length;updateBadge("missingDataBadge",e.length+t.length+n.length+a.length),renderMissingList("missingPhoneList",e,"telefon"),renderMissingList("missingEmailList",t,"e-post"),renderMissingList("missingCoordsList",n,"koordinater"),renderMissingList("missingControlList",a,"neste kontroll")}function renderMissingList(e,t,n){const a=document.getElementById(e);a&&(0!==t.length?a.innerHTML=t.map(e=>`\n    <div class="missing-item" data-action="editCustomer" data-customer-id="${e.id}">\n      <div class="missing-item-name">${escapeHtml(e.navn)}</div>\n      <div class="missing-item-address">${escapeHtml(e.adresse||"")}${e.poststed?", "+escapeHtml(e.poststed):""}</div>\n    </div>\n  `).join(""):a.innerHTML=`<div class="missing-empty">Ingen kunder mangler ${escapeHtml(n)}</div>`)}function renderStatistikk(){let e=0,t=0,n=0;customers.forEach(a=>{const s=getControlStatus(a);"forfalt"===s.status?e++:"snart"===s.status?t++:"ok"!==s.status&&"god"!==s.status||n++}),document.getElementById("statTotalKunder").textContent=customers.length,document.getElementById("statForfalte").textContent=e,document.getElementById("statSnart").textContent=t,document.getElementById("statOk").textContent=n,renderSeasonChart(),renderCategoryStats(),renderAreaStats(),renderEltypeStats(),renderBrannsystemStats()}function addClusterToRoute(e){e.forEach(e=>{selectedCustomers.has(e)||selectedCustomers.add(e)}),updateSelectionUI(),map.closePopup();showNotification(`${e.length} kunder lagt til ruten`)}function zoomToCluster(e,t){map.closePopup(),map.setView([e,t],map.getZoom()+2)}function showNotification(e,t="success"){const n=document.querySelector(".notification-toast");n&&n.remove();const a={success:"fa-check-circle",error:"fa-exclamation-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"},s=document.createElement("div");s.className=`notification-toast notification-${t}`,s.innerHTML=`<i class="fas ${a[t]||a.success}"></i> ${escapeHtml(e)}`,document.body.appendChild(s),setTimeout(()=>{s.classList.add("fade-out"),setTimeout(()=>s.remove(),300)},2500)}function getNextControlDate(e){if(e.services&&Array.isArray(e.services)&&e.services.length>0){let t=null;for(const n of e.services){let e=null;n.neste_kontroll?e=new Date(n.neste_kontroll):n.siste_kontroll&&(e=new Date(n.siste_kontroll),e.setMonth(e.getMonth()+(n.intervall_months||12))),e&&(!t||e<t)&&(t=e)}if(t)return t}const t=e.kategori||"";if(t.includes("El-Kontroll")){if(e.neste_el_kontroll)return new Date(e.neste_el_kontroll);if(e.siste_el_kontroll){const t=new Date(e.siste_el_kontroll);return t.setMonth(t.getMonth()+(e.el_kontroll_intervall||36)),t}}if("Brannvarsling"===t){if(e.neste_brann_kontroll)return new Date(e.neste_brann_kontroll);if(e.siste_brann_kontroll){const t=new Date(e.siste_brann_kontroll);return t.setMonth(t.getMonth()+(e.brann_kontroll_intervall||12)),t}}if(e.neste_kontroll)return new Date(e.neste_kontroll);if(e.siste_kontroll){const t=new Date(e.siste_kontroll);return t.setMonth(t.getMonth()+(e.kontroll_intervall_mnd||12)),t}return null}function getCustomerServiceDates(e){const t=[];if(e.services&&Array.isArray(e.services))for(const n of e.services){let e=null;n.neste_kontroll?e=new Date(n.neste_kontroll):n.siste_kontroll&&(e=new Date(n.siste_kontroll),e.setMonth(e.getMonth()+(n.intervall_months||12))),e&&t.push({service_type_name:n.service_type_name,service_type_slug:n.service_type_slug,service_type_icon:n.service_type_icon,service_type_color:n.service_type_color,neste_kontroll:e,siste_kontroll:n.siste_kontroll?new Date(n.siste_kontroll):null,intervall_months:n.intervall_months})}return t}function getISOWeekNumber(e){const t=new Date(e);t.setHours(0,0,0,0),t.setDate(t.getDate()+3-(t.getDay()+6)%7);const n=new Date(t.getFullYear(),0,4);return Math.round(((t-n)/864e5+1)/7)}function formatDate(e){if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":"month_year"===appConfig.datoModus?t.toLocaleDateString("nb-NO",{month:"long",year:"numeric"}):t.toLocaleDateString("nb-NO")}function formatDateShort(e){if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":"month_year"===appConfig.datoModus?t.toLocaleDateString("nb-NO",{month:"short",year:"numeric"}):t.toLocaleDateString("nb-NO",{day:"2-digit",month:"short"})}function formatDateInline(e){return e?isNaN(e.getTime())?"":"month_year"===appConfig.datoModus?e.toLocaleDateString("nb-NO",{month:"long",year:"numeric"}):e.toLocaleDateString("nb-NO",{day:"2-digit",month:"short",year:"numeric"}):""}function normalizeDateValue(e){return e?/^\d{4}-\d{2}$/.test(e)?e+"-01":e:null}function applyDateModeToInputs(){"month_year"===appConfig.datoModus&&document.querySelectorAll('input[type="date"]').forEach(e=>{e.type="month",e.value&&10===e.value.length&&(e.value=e.value.substring(0,7))})}function saveApiKey(){const e=document.getElementById("apiKey").value.trim();e&&(localStorage.setItem("ors_api_key",e),apiKeyModal.classList.add("hidden"),planRoute())}function renderFilterPanelCategories(){const e=document.getElementById("categoryFilterButtons");if(!e)return;const t=serviceTypeRegistry.getAll();let n=`\n    <button class="category-btn ${"all"===selectedCategory?"active":""}" data-category="all">\n      <i class="fas fa-list"></i> Alle\n    </button>\n  `;if(t.forEach(e=>{const t=selectedCategory===e.name||selectedCategory===e.slug;n+=`\n      <button class="category-btn ${t?"active":""}" data-category="${e.name}">\n        <i class="fas ${e.icon}" style="color: ${e.color}"></i> ${e.name}\n      </button>\n    `}),t.length>=2){const e=t.map(e=>e.name).join(" + "),a=t.map(e=>`<i class="fas ${e.icon}" style="color: ${e.color}"></i>`).join("");n+=`\n      <button class="category-btn ${selectedCategory===e?"active":""}" data-category="${e}">\n        ${a} ${t.length>2?"Alle":"Begge"}\n      </button>\n    `}e.innerHTML=n,attachCategoryFilterHandlers(),attachCategoryDropHandlers()}function attachCategoryDropHandlers(){}document.addEventListener("click",function(e){const t=e.target.closest(".missing-header");if(t){const e=t.dataset.toggle,n="missing"+e.replace("missing-","").charAt(0).toUpperCase()+e.replace("missing-","").slice(1)+"List",a=document.getElementById(n);a&&(a.classList.toggle("collapsed"),t.querySelector(".toggle-icon").classList.toggle("rotated"))}}),window.editCustomer=editCustomer,window.toggleCustomerSelection=toggleCustomerSelection,window.focusOnCustomer=focusOnCustomer,window.createRouteForArea=createRouteForArea,window.addClusterToRoute=addClusterToRoute,window.zoomToCluster=zoomToCluster,window.closeContentPanelMobile=closeContentPanelMobile;let dragGhost=null,dragHoveredBtn=null;function startMarkerDrag(e,t,n){const a=customers.find(t=>t.id===e);a&&(dragGhost=document.createElement("div"),dragGhost.className="drag-ghost",dragGhost.innerHTML=`<i class="fas fa-map-marker-alt"></i> ${escapeHtml(a.navn)}`,dragGhost.style.left=t+"px",dragGhost.style.top=n+"px",document.body.appendChild(dragGhost),document.body.classList.add("marker-dragging"))}function updateMarkerDrag(e,t){if(!dragGhost)return;dragGhost.style.left=e+"px",dragGhost.style.top=t+"px";const n=document.elementFromPoint(e,t),a=n?.closest(".category-btn");dragHoveredBtn&&dragHoveredBtn!==a&&dragHoveredBtn.classList.remove("drop-hover"),a&&a.dataset.category&&"all"!==a.dataset.category?(a.classList.add("drop-hover"),dragHoveredBtn=a):dragHoveredBtn=null}function endMarkerDrag(e){const t=dragHoveredBtn?.dataset?.category;dragGhost&&(dragGhost.remove(),dragGhost=null),dragHoveredBtn&&(dragHoveredBtn.classList.remove("drop-hover"),dragHoveredBtn=null),document.body.classList.remove("marker-dragging"),t&&"all"!==t&&assignCustomerCategory(e,t)}async function assignCustomerCategory(e,t){const n=customers.find(t=>t.id===e);if(n)if(n.kategori!==t)try{const a=await apiFetch(`/api/kunder/${e}`,{method:"PUT",body:JSON.stringify({navn:n.navn,adresse:n.adresse,postnummer:n.postnummer,poststed:n.poststed,telefon:n.telefon,epost:n.epost,lat:n.lat,lng:n.lng,kategori:t})});if(!a.ok){const e=await a.json();throw new Error(e.error||"Kunne ikke oppdatere kategori")}n.kategori=t,renderMarkers(customers.filter(e=>e.lat&&e.lng)),updateCategoryFilterCounts(),showToast(`${escapeHtml(n.navn)} flyttet til ${escapeHtml(t)}`,"success")}catch(e){showToast(e.message,"error")}else showToast("Kunden har allerede denne kategorien","info")}function attachCategoryFilterHandlers(){const e=document.getElementById("categoryFilterButtons");e&&e.querySelectorAll(".category-btn").forEach(t=>{t.addEventListener("click",()=>{e.querySelectorAll(".category-btn").forEach(e=>e.classList.remove("active")),t.classList.add("active"),selectedCategory=t.dataset.category,applyFilters()})})}let subcatAdminMode=!1,collapsedSubcatGroups={};function renderSubcategoryFilter(){const e=document.getElementById("subcategoryFilterContent"),t=document.getElementById("subcategoryFilter");if(!e||!t)return;const n=allSubcategoryGroups||[];if(0===n.length)return t.style.display="block",e.innerHTML='<div class="subcat-add-row subcat-add-group-row">\n      <input type="text" class="subcat-add-input" placeholder="Ny gruppe..." maxlength="100" data-add-group-input>\n      <button class="subcat-add-btn subcat-add-group-btn" data-action="addGroup" title="Legg til gruppe"><i class="fas fa-plus"></i> Gruppe</button>\n    </div>',void attachSubcategoryHandlers();t.style.display="block";const a=document.getElementById("subcatAdminToggle");a&&a.classList.toggle("active",subcatAdminMode);const s={};Object.values(kundeSubcatMap).forEach(e=>{e.forEach(e=>{const t=`${e.group_id}_${e.subcategory_id}`;s[t]=(s[t]||0)+1})});let o="";n.forEach(e=>{const t=e.subcategories||[],n=selectedSubcategories[e.id],a=collapsedSubcatGroups[e.id],r=n?t.find(e=>e.id===n):null;o+=`<div class="subcat-group ${a?"subcat-group-collapsed":""}">\n      <div class="subcat-group-header">\n        <span class="subcat-group-name" data-toggle-group="${e.id}">\n          <i class="fas fa-chevron-${a?"right":"down"} subcat-chevron"></i>\n          ${escapeHtml(e.navn)}\n          ${a&&r?`<span class="subcat-active-indicator">${escapeHtml(r.navn)}</span>`:""}\n        </span>\n        <span class="subcat-admin-only">\n          <button class="category-manage-btn" data-action="editGroup" data-group-id="${e.id}" data-group-navn="${escapeHtml(e.navn)}" title="Rediger"><i class="fas fa-pen"></i></button>\n          <button class="category-manage-btn subcat-delete-btn" data-action="deleteGroup" data-group-id="${e.id}" data-group-navn="${escapeHtml(e.navn)}" title="Slett"><i class="fas fa-trash"></i></button>\n        </span>\n      </div>`,o+='<div class="subcat-group-body">',t.length>0&&(o+='<div class="category-filter-buttons subcat-filter-buttons">',o+=`<button class="category-btn subcat-btn ${n?"":"active"}" data-group-id="${e.id}" data-subcat-id="all">Alle</button>`,t.forEach(t=>{const a=s[`${e.id}_${t.id}`]||0,r=n===t.id;o+=`<span class="subcat-btn-wrapper">\n          <button class="category-btn subcat-btn ${r?"active":""}" data-group-id="${e.id}" data-subcat-id="${t.id}">\n            ${escapeHtml(t.navn)} <span class="subcat-count">${a}</span>\n          </button>\n          <span class="subcat-admin-only subcat-item-actions">\n            <button class="category-manage-btn" data-action="editSubcat" data-subcat-id="${t.id}" data-subcat-navn="${escapeHtml(t.navn)}" title="Rediger"><i class="fas fa-pen"></i></button>\n            <button class="category-manage-btn subcat-delete-btn" data-action="deleteSubcat" data-subcat-id="${t.id}" data-subcat-navn="${escapeHtml(t.navn)}" title="Slett"><i class="fas fa-trash"></i></button>\n          </span>\n        </span>`}),o+="</div>"),o+=`<div class="subcat-add-row subcat-admin-only">\n      <input type="text" class="subcat-add-input" placeholder="Ny underkategori..." maxlength="100" data-add-subcat-input data-group-id="${e.id}">\n      <button class="subcat-add-btn" data-action="addSubcat" data-group-id="${e.id}" title="Legg til"><i class="fas fa-plus"></i></button>\n    </div>`,o+="</div>",o+="</div>"}),o+='<div class="subcat-add-row subcat-add-group-row subcat-admin-only">\n    <input type="text" class="subcat-add-input" placeholder="Ny gruppe..." maxlength="100" data-add-group-input>\n    <button class="subcat-add-btn subcat-add-group-btn" data-action="addGroup" title="Legg til gruppe"><i class="fas fa-plus"></i> Gruppe</button>\n  </div>',e.innerHTML=o,e.classList.toggle("subcat-admin-active",subcatAdminMode),attachSubcategoryHandlers()}function attachSubcategoryHandlers(){const e=document.getElementById("subcategoryFilterContent");if(!e)return;const t=document.getElementById("subcatAdminToggle");t&&!t.dataset.handlerAttached&&(t.dataset.handlerAttached="true",t.addEventListener("click",()=>{subcatAdminMode=!subcatAdminMode,t.classList.toggle("active",subcatAdminMode),e.classList.toggle("subcat-admin-active",subcatAdminMode)})),e.dataset.subcatHandlersAttached||(e.dataset.subcatHandlersAttached="true",e.addEventListener("click",async t=>{const n=t.target.closest("[data-toggle-group]");if(n){const e=parseInt(n.dataset.toggleGroup,10);return collapsedSubcatGroups[e]=!collapsedSubcatGroups[e],void renderSubcategoryFilter()}const a=t.target.closest(".subcat-btn");if(a){const e=parseInt(a.dataset.groupId,10),t=a.dataset.subcatId;return"all"===t?delete selectedSubcategories[e]:selectedSubcategories[e]=parseInt(t,10),renderSubcategoryFilter(),void applyFilters()}const s=t.target.closest("[data-action]");if(!s)return;const o=s.dataset.action;if("addGroup"===o){const t=e.querySelector("input[data-add-group-input]"),n=t?.value?.trim();if(!n)return void t?.focus();s.disabled=!0;try{const e=await apiFetch("/api/subcategories/groups",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:n})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Feil")}subcatRegistryAddGroup((await e.json()).data||{id:Date.now(),navn:n}),showToast("Gruppe opprettet","success"),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}finally{s.disabled=!1}}else if("addSubcat"===o){const t=parseInt(s.dataset.groupId,10),n=e.querySelector(`input[data-add-subcat-input][data-group-id="${t}"]`),a=n?.value?.trim();if(!a)return void n?.focus();s.disabled=!0;try{const e=await apiFetch("/api/subcategories/items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group_id:t,navn:a})});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||"Feil")}subcatRegistryAddItem(t,(await e.json()).data||{id:Date.now(),navn:a}),showToast("Underkategori opprettet","success"),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}finally{s.disabled=!1}}else if("editGroup"===o){const e=parseInt(s.dataset.groupId,10),t=s.dataset.groupNavn,n=prompt("Nytt navn for gruppen:",t);if(!n||n.trim()===t)return;try{if(!(await apiFetch(`/api/subcategories/groups/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:n.trim()})})).ok)throw new Error("Kunne ikke oppdatere");subcatRegistryEditGroup(e,n.trim()),showToast("Gruppe oppdatert","success"),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}}else if("deleteGroup"===o){const e=parseInt(s.dataset.groupId,10),t=s.dataset.groupNavn;if(!await showConfirm(`Slett gruppen "${t}"? Alle underkategorier slettes også.`,"Slette gruppe"))return;try{if(!(await apiFetch(`/api/subcategories/groups/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette");subcatRegistryDeleteGroup(e),delete selectedSubcategories[e],showToast("Gruppe slettet","success"),renderSubcategoryFilter(),applyFilters()}catch(e){showToast(e.message,"error")}}else if("editSubcat"===o){const e=parseInt(s.dataset.subcatId,10),t=s.dataset.subcatNavn,n=prompt("Nytt navn:",t);if(!n||n.trim()===t)return;try{if(!(await apiFetch(`/api/subcategories/items/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({navn:n.trim()})})).ok)throw new Error("Kunne ikke oppdatere");subcatRegistryEditItem(e,n.trim()),showToast("Underkategori oppdatert","success"),renderSubcategoryFilter()}catch(e){showToast(e.message,"error")}}else if("deleteSubcat"===o){const e=parseInt(s.dataset.subcatId,10),t=s.dataset.subcatNavn;if(!await showConfirm(`Slett "${t}"?`,"Slette underkategori"))return;try{if(!(await apiFetch(`/api/subcategories/items/${e}`,{method:"DELETE"})).ok)throw new Error("Kunne ikke slette");subcatRegistryDeleteItem(e),showToast("Underkategori slettet","success"),renderSubcategoryFilter(),applyFilters()}catch(e){showToast(e.message,"error")}}}),e.addEventListener("keydown",t=>{if("Enter"!==t.key)return;const n=t.target;if(void 0!==n.dataset.addGroupInput)e.querySelector('button[data-action="addGroup"]')?.click(),t.preventDefault();else if(void 0!==n.dataset.addSubcatInput){const a=n.dataset.groupId;e.querySelector(`button[data-action="addSubcat"][data-group-id="${a}"]`)?.click(),t.preventDefault()}}))}function subcatRegistryAddGroup(e){allSubcategoryGroups.push({id:e.id,navn:e.navn,subcategories:[]})}function subcatRegistryAddItem(e,t){const n=allSubcategoryGroups.find(t=>t.id===e);n&&(n.subcategories||(n.subcategories=[]),n.subcategories.push({id:t.id,navn:t.navn}))}function subcatRegistryEditGroup(e,t){const n=allSubcategoryGroups.find(t=>t.id===e);n&&(n.navn=t)}function subcatRegistryDeleteGroup(e){const t=allSubcategoryGroups.findIndex(t=>t.id===e);-1!==t&&allSubcategoryGroups.splice(t,1)}function subcatRegistryEditItem(e,t){for(const n of allSubcategoryGroups){const a=(n.subcategories||[]).find(t=>t.id===e);if(a)return void(a.navn=t)}}function subcatRegistryDeleteItem(e){for(const t of allSubcategoryGroups){if(!t.subcategories)continue;const n=t.subcategories.findIndex(t=>t.id===e);if(-1!==n)return void t.subcategories.splice(n,1)}}function renderDynamicFieldFilters(){const e=document.getElementById("dynamicFieldFilters");if(!e)return;const t=organizationFields.filter(e=>1===e.is_filterable||!0===e.is_filterable);if(0===t.length)return void(e.innerHTML="");const n=t.map(e=>{const t="true"===localStorage.getItem(`fieldFilterExpanded-${e.field_name}`);return`\n      <div class="category-filter dynamic-field-filter" data-field="${escapeHtml(e.field_name)}">\n        <div class="category-filter-title clickable-header" data-toggle="field-${escapeHtml(e.field_name)}">\n          <span>${escapeHtml(e.display_name)}</span>\n          <i class="fas fa-chevron-${t?"down":"right"} toggle-icon"></i>\n        </div>\n        <div class="dynamic-filter-content" id="fieldFilter-${escapeHtml(e.field_name)}" style="display: ${t?"block":"none"};">\n          ${renderFieldFilterInput(e)}\n        </div>\n      </div>\n    `}).join("");e.innerHTML=n,attachDynamicFilterHandlers()}function renderFieldFilterInput(e){const t=dynamicFieldFilters[e.field_name];switch(e.field_type){case"select":return renderSelectFilterButtons(e,t);case"text":default:return renderTextFilterInput(e,t);case"number":return renderNumberRangeFilter(e,t);case"date":return renderDateRangeFilter(e,t)}}function renderSelectFilterButtons(e,t){const n=e.options||[];let a=`<div class="category-filter-buttons">\n    <button class="category-btn dynamic-field-btn ${t&&"all"!==t?"":"active"}"\n            data-field="${escapeHtml(e.field_name)}" data-value="all">\n      <i class="fas fa-list"></i> Alle\n    </button>`;return n.forEach(n=>{const s=t===n.value;a+=`\n      <button class="category-btn dynamic-field-btn ${s?"active":""}"\n              data-field="${escapeHtml(e.field_name)}" data-value="${escapeHtml(n.value)}">\n        ${escapeHtml(n.display_name||n.value)}\n      </button>`}),a+="</div>",a}function renderTextFilterInput(e,t){return`\n    <div class="filter-input-wrapper">\n      <input type="text"\n             class="dynamic-filter-input"\n             data-field="${escapeHtml(e.field_name)}"\n             placeholder="Filtrer på ${escapeHtml(e.display_name)}..."\n             value="${escapeHtml(t||"")}">\n    </div>`}function renderNumberRangeFilter(e,t){const n=t?.min||"",a=t?.max||"";return`\n    <div class="filter-range-wrapper">\n      <input type="number" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="min" placeholder="Min" value="${n}">\n      <span class="range-separator">-</span>\n      <input type="number" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="max" placeholder="Maks" value="${a}">\n    </div>`}function renderDateRangeFilter(e,t){const n=t?.from||"",a=t?.to||"",s="month_year"===appConfig.datoModus?"month":"date";return`\n    <div class="filter-range-wrapper">\n      <input type="${s}" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="from" value="${n}">\n      <span class="range-separator">til</span>\n      <input type="${s}" class="dynamic-filter-range" data-field="${escapeHtml(e.field_name)}" data-range="to" value="${a}">\n    </div>`}function attachDynamicFilterHandlers(){const e=document.getElementById("dynamicFieldFilters");if(!e)return;let t;e.querySelectorAll(".clickable-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.toggle.replace("field-",""),n=document.getElementById(`fieldFilter-${t}`),a=e.querySelector(".toggle-icon");"none"===n.style.display?(n.style.display="block",a.classList.replace("fa-chevron-right","fa-chevron-down"),localStorage.setItem(`fieldFilterExpanded-${t}`,"true")):(n.style.display="none",a.classList.replace("fa-chevron-down","fa-chevron-right"),localStorage.setItem(`fieldFilterExpanded-${t}`,"false"))})}),e.querySelectorAll(".dynamic-field-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.field,n=e.dataset.value;e.parentElement.querySelectorAll(".dynamic-field-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),"all"===n?delete dynamicFieldFilters[t]:dynamicFieldFilters[t]=n,applyFilters()})}),e.querySelectorAll(".dynamic-filter-input").forEach(e=>{e.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{const t=e.dataset.field,n=e.value.trim();n?dynamicFieldFilters[t]=n:delete dynamicFieldFilters[t],applyFilters()},300)})}),e.querySelectorAll(".dynamic-filter-range").forEach(e=>{e.addEventListener("change",()=>{const t=e.dataset.field,n=e.dataset.range,a=e.value;dynamicFieldFilters[t]&&"object"==typeof dynamicFieldFilters[t]||(dynamicFieldFilters[t]={}),a?dynamicFieldFilters[t][n]=a:(delete dynamicFieldFilters[t][n],0===Object.keys(dynamicFieldFilters[t]).length&&delete dynamicFieldFilters[t]),applyFilters()})})}function updateDashboard(){if(!customers||0===customers.length)return;const e=new Date;e.setHours(0,0,0,0);let t=0,n=0,a=0;const s={};customers.forEach(o=>{const r=getNextControlDate(o);if(r){const s=Math.ceil((r-e)/864e5);s<0?t++:s<=30?n++:a++}const i=o.kategori||"Ukjent";s[i]=(s[i]||0)+1});const o=document.getElementById("dashTotalKunder"),r=document.getElementById("dashForfalte"),i=document.getElementById("dashKommende"),l=document.getElementById("dashFullfort"),d=document.getElementById("dashOverdueCount");o&&(o.textContent=customers.length),r&&(r.textContent=t),i&&(i.textContent=n),l&&(l.textContent=a),d&&(d.textContent=t);const c=document.getElementById("quickStatKunder"),u=document.getElementById("quickStatForfalte"),m=document.getElementById("quickStatKommende"),p=document.getElementById("quickStatOk");c&&(c.textContent=customers.length),u&&(u.textContent=t),m&&(m.textContent=n),p&&(p.textContent=a),renderDashboardCategories(s),renderDashboardAreas()}function renderDashboardCategories(e){const t=document.getElementById("dashCategoryOverview");if(!t)return;const n=serviceTypeRegistry.getAll();let a="";n.forEach(t=>{const n=e[t.name]||0;a+=`\n      <div class="category-stat">\n        <i class="fas ${t.icon}" style="color: ${t.color}"></i>\n        <span class="cat-name">${t.name}</span>\n        <span class="cat-count">${n}</span>\n      </div>\n    `});const s=n.map(e=>e.name).join(" + "),o=e[s]||0;if(o>0){const e=n.map(e=>`<i class="fas ${e.icon}" style="color: ${e.color}"></i>`).join("");a+=`\n      <div class="category-stat">\n        ${e}\n        <span class="cat-name">${n.length>2?"Alle":"Begge"}</span>\n        <span class="cat-count">${o}</span>\n      </div>\n    `}t.innerHTML=a}function renderDashboardAreas(){const e=document.getElementById("dashAreaList");if(!e)return;const t={};customers.forEach(e=>{const n=e.poststed||"Ukjent";t[n]=(t[n]||0)+1});const n=Object.entries(t).sort((e,t)=>t[1]-e[1]).slice(0,10);let a="";n.forEach(([e,t])=>{a+=`\n      <div class="area-chip" data-area="${escapeHtml(e)}">\n        ${escapeHtml(e)}\n        <span class="area-count">${t}</span>\n      </div>\n    `}),e.innerHTML=a,e.querySelectorAll(".area-chip").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.area;switchToTab("customers");const n=document.getElementById("omradeFilter");n&&(n.value=t,applyFilters())})})}function getMapboxToken(){return appConfig.mapboxAccessToken?appConfig.mapboxAccessToken:(Logger.error("Mapbox token mangler - sett MAPBOX_ACCESS_TOKEN i server-miljøvariabler"),"")}function getMapTileUrl(){return`https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token=${getMapboxToken()}`}function getMapAttribution(){return'&copy; <a href="https://mapbox.com/">Mapbox</a> &copy; <a href="https://openstreetmap.org/">OpenStreetMap</a>'}let currentTileLayer=null;function refreshMapTiles(){if(!map||!currentTileLayer)return;const e=getMapboxToken();e&&(currentTileLayer._url&&currentTileLayer._url.includes(e)||(Logger.log("Refreshing map tiles with updated Mapbox token"),map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(getMapTileUrl(),{minZoom:3,maxZoom:19,tileSize:512,zoomOffset:-1,attribution:getMapAttribution()}).addTo(map)))}let mapMode="satellite";function toggleNightMode(){if(!map||!currentTileLayer)return;const e=document.getElementById("nightmodeBtn"),t=e?.querySelector("i"),n=document.getElementById("map");e&&(e.disabled=!0),n.style.transition="opacity 0.4s ease-out",n.style.opacity="0",setTimeout(()=>{"dark"===mapMode?(map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token=${getMapboxToken()}`,{minZoom:3,maxZoom:19,tileSize:512,zoomOffset:-1,attribution:"&copy; Mapbox"}).addTo(map),mapMode="satellite",e?.classList.add("satellite-active"),t&&(t.className="fas fa-sun"),e?.setAttribute("title","Bytt til mørkt kart")):(map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/navigation-night-v1/tiles/{z}/{x}/{y}?access_token=${getMapboxToken()}`,{minZoom:3,maxZoom:19,tileSize:512,zoomOffset:-1,attribution:"&copy; Mapbox"}).addTo(map),mapMode="dark",e?.classList.remove("satellite-active"),t&&(t.className="fas fa-moon"),e?.setAttribute("title","Bytt til satellittkart")),setTimeout(()=>{n.style.opacity="1",e&&(e.disabled=!1)},100)},400)}let customerList,searchInput,addCustomerBtn,planRouteBtn,clearSelectionBtn,selectedCount,customerModal,customerForm,apiKeyModal,routeInfo,officeMarker=null;function initSharedMap(){if(document.getElementById("map")&&!map){map=L.map("map",{zoomControl:!1,attributionControl:!1,minZoom:3,dragging:!1,scrollWheelZoom:!1,doubleClickZoom:!1,touchZoom:!1,keyboard:!1}).setView([69.06888,17.65274],11);const e=getMapTileUrl();Logger.log("Map tile URL:",e),currentTileLayer=L.tileLayer(e,{minZoom:3,maxZoom:19,tileSize:512,zoomOffset:-1,attribution:getMapAttribution()}).addTo(map);const t=L.divIcon({className:"office-marker-glow",html:'\n        <div class="office-marker-container">\n          <div class="office-glow-ring"></div>\n          <div class="office-icon">\n            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>\n              <polyline points="9 22 9 12 15 12 15 22"/>\n            </svg>\n          </div>\n        </div>\n      ',iconSize:[60,60],iconAnchor:[30,30]});officeMarker=L.marker([69.06888,17.65274],{icon:t,interactive:!1,keyboard:!1}).addTo(map);const n=officeMarker.getElement();n&&(n.setAttribute("aria-hidden","true"),n.removeAttribute("tabindex"),n.removeAttribute("role"))}}function initLoginView(){const e=document.getElementById("spaLoginForm");e&&e.addEventListener("submit",handleSpaLogin)}function initDOMElements(){customerList=document.getElementById("customerList"),searchInput=document.getElementById("searchInput"),addCustomerBtn=document.getElementById("addCustomerBtn"),planRouteBtn=document.getElementById("planRouteBtn"),clearSelectionBtn=document.getElementById("clearSelectionBtn"),selectedCount=document.getElementById("selectedCount"),customerModal=document.getElementById("customerModal"),customerForm=document.getElementById("customerForm"),apiKeyModal=document.getElementById("apiKeyModal"),routeInfo=document.getElementById("routeInfo")}let mapInitialized=!1;function initMap(){if(mapInitialized)return;if(mapInitialized=!0,Logger.log("initMap() starting, map exists:",!!map),!map)return mapInitialized=!1,void console.error("Map not initialized - call initSharedMap() first");addNorwayBorder(),L.control.scale({metric:!0,imperial:!1,position:"bottomleft"}).addTo(map);(new(L.Control.extend({options:{position:"topleft"},onAdd:function(){const e=L.DomUtil.create("div","leaflet-bar leaflet-control");e.innerHTML='<a href="#" title="Min posisjon" role="button" aria-label="Min posisjon" style="display:flex;align-items:center;justify-content:center;width:34px;height:34px;font-size:16px;"><i class="fas fa-location-crosshairs"></i></a>';let t=null;return L.DomEvent.on(e,"click",function(e){L.DomEvent.preventDefault(e),L.DomEvent.stopPropagation(e),map.locate({setView:!0,maxZoom:15})}),map.on("locationfound",function(e){t&&map.removeLayer(t),t=L.circleMarker(e.latlng,{radius:8,fillColor:"#4285F4",fillOpacity:1,color:"#fff",weight:2}).addTo(map).bindPopup("Du er her")}),map.on("locationerror",function(){showNotification("Kunne ikke finne posisjonen din","error")}),e}}))).addTo(map);const e=appConfig.mapClusterRadius||60;markerClusterGroup=L.markerClusterGroup({maxClusterRadius:e,iconCreateFunction:createClusterIcon,disableClusteringAtZoom:14,spiderfyOnMaxZoom:!0,spiderfyOnEveryZoom:!1,spiderfyDistanceMultiplier:2.5,showCoverageOnHover:!1,zoomToBoundsOnClick:!1,animate:!0,animateAddingMarkers:!1,singleMarkerMode:!1}),map.addLayer(markerClusterGroup),markerClusterGroup.on("spiderfied",e=>{e.markers.forEach(e=>{e._icon&&e._icon.classList.add("spiderfied-marker")})}),markerClusterGroup.on("unspiderfied",e=>{e.markers.forEach(e=>{e._icon&&e._icon.classList.remove("spiderfied-marker")})}),map.on("moveend",()=>{requestAnimationFrame(()=>{reapplyPlanBadges(),(wpFocusedMemberIds||wpRouteActive)&&applyTeamFocusToMarkers()})}),markerClusterGroup.on("animationend",()=>{reapplyPlanBadges(),(wpFocusedMemberIds||wpRouteActive)&&applyTeamFocusToMarkers()}),Logger.log("initMap() markerClusterGroup created and added to map"),markerClusterGroup.on("clusterclick",function(e){const t=e.layer.getAllChildMarkers(),n=[],a=[];t.forEach(e=>{for(const[t,s]of Object.entries(markers))if(s===e){n.push(Number.parseInt(t));const e=customers.find(e=>e.id===Number.parseInt(t));e&&a.push(e.navn);break}});const s=new Set,o={};n.forEach(e=>{const t=customers.find(t=>t.id===e);if(t){t.poststed&&s.add(t.poststed);const n=kundeSubcatMap[e]||[];for(const e of n)for(const t of allSubcategoryGroups){if(t.id!==e.group_id)continue;const n=(t.subcategories||[]).find(t=>t.id===e.subcategory_id);if(n){const e=`${t.navn}|${n.navn}`;o[e]=(o[e]||0)+1}}}});let r="";const i={};for(const[e,t]of Object.entries(o)){const[n,a]=e.split("|");i[n]||(i[n]=[]),i[n].push([a,t])}const l=Object.entries(i);if(l.length>0){r='<div class="cluster-categories">';for(const[e,t]of l)t.sort((e,t)=>t[1]-e[1]),r+=`<div class="cluster-category-group"><strong>${escapeHtml(e)}:</strong> `,r+=t.map(([e,t])=>`<span class="cluster-tag">${escapeHtml(e)} (${t})</span>`).join(" "),r+="</div>";r+="</div>"}const d=`\n      <div class="cluster-popup">\n        <h3>${escapeHtml(Array.from(s).slice(0,2).join(" / ")||"Område")}</h3>\n        <p><strong>${n.length}</strong> kunder i dette området</p>\n        ${r}\n        <div class="cluster-popup-actions">\n          <button class="btn btn-primary btn-small" data-action="addClusterToRoute" data-customer-ids="${n.join(",")}">\n            <i class="fas fa-route"></i> Legg til rute\n          </button>\n          <button class="btn btn-secondary btn-small" data-action="zoomToCluster" data-lat="${e.latlng.lat}" data-lng="${e.latlng.lng}">\n            <i class="fas fa-search-plus"></i> Zoom inn\n          </button>\n        </div>\n        <div class="cluster-customer-list">\n          ${a.slice(0,5).map(e=>`<span class="cluster-customer-name">${escapeHtml(e)}</span>`).join("")}\n          ${a.length>5?`<span class="cluster-more">+${a.length-5} flere...</span>`:""}\n        </div>\n      </div>\n    `;L.popup().setLatLng(e.latlng).setContent(d).openOn(map)}),map.on("zoomend",updateMarkerLabelsVisibility),initAreaSelect()}function updateMarkerLabelsVisibility(){const e=map.getZoom(),t=document.getElementById("map");e<10?t.classList.add("hide-marker-labels"):t.classList.remove("hide-marker-labels")}function addNorwayBorder(){L.polyline([[69.06,20.55],[68.95,20.1],[68.45,18.1],[68.15,17.9],[67.95,17.15],[67.5,16.4],[66.6,15.5],[66.15,14.6],[65.1,14.25],[64.15,13.95],[63.7,12.7],[62.65,12.3],[61.8,12.1],[61,12.15],[59.8,11.8],[59.1,11.45],[58.95,11.15]],{color:"#ef4444",weight:2,opacity:.7,dashArray:"8, 4"}).addTo(map),L.marker([68.5,19.5],{icon:L.divIcon({className:"country-label",html:"<span>SVERIGE</span>",iconSize:[100,20]})}).addTo(map),L.polygon([[71.5,20.5],[71.5,32],[58,32],[58,11],[59,11.5],[61,12.2],[63.5,12.5],[66,14.5],[68,17.5],[69,20],[71.5,20.5]],{color:"transparent",fillColor:"#000",fillOpacity:.25,interactive:!1}).addTo(map)}function createClusterIcon(e){const t=e.getAllChildMarkers(),n=new Set;let a=0;const s=new Map;let o=0,r=0,i=0;t.forEach(e=>{const t=e.options.customerData;if(t){if(t.poststed&&n.add(t.poststed),t.hasWarning&&a++,t.planned){o++;const e=t.plannedInitials||"?";s.set(e,(s.get(e)||0)+1)}wpFocusedMemberIds&&null!=t.id&&wpFocusedMemberIds.has(Number(t.id))&&r++,wpRouteStopIds&&null!=t.id&&wpRouteStopIds.has(Number(t.id))&&i++}});const l=t.length,d=a>0?`<div class="cluster-warning">${a}</div>`:"";let c,u="";if(o>0){u=`<div class="cluster-plan-badge">${Array.from(s.entries()).map(([e,t])=>`${e} ${t}`).join(" · ")}</div>`}c=l>=100?"Region Nord":Array.from(n).slice(0,2).join(" / ");let m="cluster-small";l>=50?m="cluster-xlarge":l>=20?m="cluster-large":l>=8&&(m="cluster-medium");let p="";return wpRouteActive&&wpRouteStopIds?p=0===i?"opacity:0.3;filter:grayscale(0.8);pointer-events:none;":"":wpFocusedMemberIds&&(p=0===r?"opacity:0.15;filter:grayscale(1);pointer-events:none;":""),L.divIcon({html:`\n      <div class="cluster-icon ${m}" style="${p}">\n        <div class="cluster-count">${wpFocusedMemberIds&&r>0?r:l}</div>\n        <div class="cluster-area">${c}</div>\n        ${d}\n        ${u}\n      </div>\n    `,className:"custom-cluster",iconSize:[70,70],iconAnchor:[35,35]})}function renderPopupSubcategories(e){const t=kundeSubcatMap[e.id];if(!t||0===t.length)return"";const n=[];for(const e of t)for(const t of allSubcategoryGroups){if(t.id!==e.group_id)continue;const a=(t.subcategories||[]).find(t=>t.id===e.subcategory_id);a&&n.push(`<strong>${escapeHtml(t.navn)}:</strong> ${escapeHtml(a.navn)}`)}return 0===n.length?"":n.map(e=>`<p>${e}</p>`).join("")}function generatePopupContent(e){const t=selectedCustomers.has(e.id),n=getControlStatus(e),a=e.epost&&""!==e.epost.trim(),s=serviceTypeRegistry.renderPopupControlInfo(e,n),o=renderPopupCustomFields(e);let r="";const i=e.org_nummer||e.notater&&e.notater.match(/\[ORGNR:(\d{9})\]/)?.[1];i&&(r+=`<p><strong>Org.nr:</strong> ${escapeHtml(i)}</p>`),e.kundenummer&&(r+=`<p><strong>Kundenr:</strong> ${escapeHtml(e.kundenummer)}</p>`),e.prosjektnummer&&(r+=`<p><strong>Prosjektnr:</strong> ${escapeHtml(e.prosjektnummer)}</p>`),e.estimert_tid&&(r+=`<p><strong>Est. tid:</strong> ${e.estimert_tid} min</p>`);let l="";if(e.notater){const t=e.notater.replace(/\[TRIPLETEX:[^\]]*\]\s*/g,"").replace(/\[ORGNR:[^\]]*\]\s*/g,"").replace(/^\s*\|\s*/,"").trim();t&&(l=`<p class="popup-notater"><strong>Notater:</strong> ${escapeHtml(t)}</p>`)}const d=presenceClaims.get(e.id),c=d&&d.userId!==myUserId?`<div class="presence-warning-banner" style="background:${escapeHtml(getPresenceColor(d.userId))}18;border-left:3px solid ${escapeHtml(getPresenceColor(d.userId))};padding:6px 10px;margin-bottom:8px;border-radius:4px;font-size:13px;">\n        <strong>${escapeHtml(d.initials)}</strong> ${escapeHtml(d.userName)} jobber med denne kunden\n      </div>`:"",u=renderPopupSubcategories(e);return`\n    ${c}\n    <h3>${escapeHtml(e.navn)}</h3>\n    ${e.kategori?`<p><strong>Kategori:</strong> ${escapeHtml(e.kategori)}</p>`:""}\n    ${u}\n    ${r}\n    ${o}\n    <p>${escapeHtml(e.adresse)}</p>\n    <p>${escapeHtml(e.postnummer||"")} ${escapeHtml(e.poststed||"")}</p>\n    ${e.telefon?`<p>Tlf: ${escapeHtml(e.telefon)}</p>`:""}\n    ${e.epost?`<p>E-post: ${escapeHtml(e.epost)}</p>`:""}\n    ${s}\n    ${l}\n    <div class="popup-actions">\n      <button class="btn btn-small btn-navigate" data-action="navigateToCustomer" data-lat="${e.lat}" data-lng="${e.lng}" data-name="${escapeHtml(e.navn)}">\n        <i class="fas fa-directions"></i> Naviger\n      </button>\n      <button class="btn btn-small btn-primary" data-action="toggleCustomerSelection" data-customer-id="${e.id}">\n        ${t?"Fjern fra rute":"Legg til rute"}\n      </button>\n      <div class="popup-btn-group">\n        <button class="btn btn-small btn-calendar" data-action="quickAddToday" data-customer-id="${e.id}" data-customer-name="${escapeHtml(e.navn)}">\n          <i class="fas fa-calendar-plus"></i> I dag\n        </button>\n        <button class="btn btn-small btn-calendar" data-action="showCalendarQuickMenu" data-customer-id="${e.id}" data-customer-name="${escapeHtml(e.navn)}">\n          <i class="fas fa-chevron-down" style="font-size:9px"></i>\n        </button>\n      </div>\n      ${splitViewOpen&&splitViewState.activeDay?`\n      <button class="btn btn-small btn-calendar" data-action="quickAddToSplitDay" data-customer-id="${e.id}" data-customer-name="${escapeHtml(e.navn)}" style="background:var(--color-primary);color:#fff;width:100%;">\n        <i class="fas fa-calendar-plus"></i> Legg til ${new Date(splitViewState.activeDay+"T00:00:00").toLocaleDateString("nb-NO",{weekday:"short",day:"numeric",month:"short"})}\n      </button>\n      `:""}\n      <button class="btn btn-small btn-success" data-action="quickMarkVisited" data-customer-id="${e.id}">\n        <i class="fas fa-check"></i> Marker besøkt\n      </button>\n      <button class="btn btn-small btn-secondary" data-action="editCustomer" data-customer-id="${e.id}">\n        Rediger\n      </button>\n      <button class="btn btn-small ${a?"btn-email":"btn-disabled"}"\n              data-action="sendEmail"\n              data-customer-id="${e.id}"\n              ${a?"":"disabled"}>\n        <i class="fas fa-envelope"></i> E-post\n      </button>\n    </div>\n  `}async function handleSpaLogin(e){e.preventDefault();const t=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value,a=document.getElementById("loginRememberMe").checked,s=document.getElementById("spaLoginBtn"),o=document.getElementById("loginErrorMessage"),r=document.getElementById("loginErrorText");s.disabled=!0,s.innerHTML='<div class="login-spinner"></div><span>Logger inn...</span>',o.classList.remove("show");try{const i={"Content-Type":"application/json"},l=getCsrfToken();l&&(i["X-CSRF-Token"]=l);const d=await fetch("/api/klient/login",{method:"POST",headers:i,credentials:"include",body:JSON.stringify({epost:t,passord:n,rememberMe:a})}),c=await d.json(),u=c.success&&c.data?c.data:c;if(d.ok&&(u.accessToken||u.token)){authToken=u.accessToken||u.token,u.expiresAt&&(accessTokenExpiresAt=u.expiresAt),localStorage.setItem("userName",u.klient?.navn||u.bruker?.navn||"Bruker"),localStorage.setItem("userEmail",t||u.klient?.epost||u.bruker?.epost||""),localStorage.setItem("userRole",u.klient?.rolle||u.bruker?.rolle||"leser"),localStorage.setItem("userType",u.klient?.type||"klient"),applyRoleUI(),u.klient?.organizationId&&(localStorage.setItem("organizationId",u.klient.organizationId),localStorage.setItem("organizationSlug",u.klient.organizationSlug||""),localStorage.setItem("organizationName",u.klient.organizationName||"")),u.organization&&(appConfig.primaryColor=u.organization.primaryColor||appConfig.primaryColor,appConfig.secondaryColor=u.organization.secondaryColor||appConfig.secondaryColor,appConfig.logoUrl=u.organization.logoUrl||appConfig.logoUrl,appConfig.companyName=u.organization.navn||appConfig.companyName,appConfig.appName=u.organization.brandTitle||appConfig.appName,appConfig.companySubtitle=u.organization.brandSubtitle||appConfig.companySubtitle,appConfig.appMode=u.organization.appMode||"mvp",localStorage.setItem("appMode",appConfig.appMode),subscriptionInfo={status:u.organization.subscriptionStatus,trialEndsAt:u.organization.trialEndsAt,planType:u.organization.planType},applyBranding(),applyMvpModeUI());const n="bruker"===u.klient?.type||"admin"===u.klient?.rolle,a=document.getElementById("adminTab");if(a&&(a.style.display=n?"flex":"none"),s.innerHTML='\n        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>\n        </svg>\n        <span>Velkommen!</span>\n      ',s.style.background="#4CAF50","bruker"===u.klient?.type)try{const e=await fetch("/api/klient/verify",{credentials:"include"}),t=await e.json();if(t.data?.user?.isSuperAdmin)return localStorage.setItem("isSuperAdmin","true"),void setTimeout(()=>{window.location.href="/admin"},500)}catch(e){}const o=u.organization&&!u.organization.onboardingCompleted;setTimeout(async()=>{o&&await showOnboardingWizard(),transitionToAppView()},300)}else{const e=u.error?.message||u.error||c.error?.message||"Feil e-post eller passord";r.textContent=e,o.classList.add("show"),resetLoginButton()}}catch(e){console.error("Login error:",e),"TypeError"===e.name&&e.message.includes("Failed to fetch")?r.textContent="Kunne ikke koble til server - sjekk internettforbindelsen":"SyntaxError"===e.name||e.message.includes("JSON")?r.textContent="Ugyldig respons fra server":"AbortError"===e.name?r.textContent="Forespørselen ble avbrutt":r.textContent=e.message||"Ukjent feil ved innlogging",o.classList.add("show"),resetLoginButton()}}function resetLoginButton(){const e=document.getElementById("spaLoginBtn");e&&(e.disabled=!1,e.style.background="",e.innerHTML='\n      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>\n      </svg>\n      <span>Logg inn</span>\n    ')}function showUserBar(){const e=document.getElementById("userBar"),t=document.getElementById("userNameDisplay"),n=localStorage.getItem("userName")||localStorage.getItem("klientNavn")||"Bruker",a=localStorage.getItem("userRole")||"",s=localStorage.getItem("userType")||"";e&&(e.style.display="flex",t&&(t.textContent=n));const o="bruker"===s||"admin"===a,r=document.getElementById("adminTab");r&&(r.style.display=o?"flex":"none"),initSubscriptionTimer()}function hideUserBar(){const e=document.getElementById("userBar");e&&(e.style.display="none"),hideSubscriptionTimer()}function transitionToAppView(){const e=document.getElementById("loginOverlay"),t=document.getElementById("appView"),n=document.getElementById("sidebar"),a=document.getElementById("filterPanel"),s=document.querySelector(".login-side"),o=document.querySelector(".login-brand-content"),r=document.querySelector(".login-map-overlay");showUserBar(),setupTokenRefresh(),t.classList.remove("hidden"),n&&(n.style.transform="translateX(-100%)",n.style.opacity="0"),a&&(a.style.transform="translateX(100%)",a.style.opacity="0");const i=document.getElementById("contentPanel");"true"===localStorage.getItem("contentPanelOpen")&&i&&(i.style.transform="translateX(-100%)",i.style.opacity="0",i.classList.remove("closed"),i.classList.add("open")),currentView="app",s&&(s.style.transition="transform 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease-out",s.style.transform="translateX(-100%)",s.style.opacity="0"),setTimeout(()=>{o&&(o.style.transition="opacity 0.5s ease-out, transform 0.5s ease-out",o.style.opacity="0",o.style.transform="translateY(-30px)"),r&&(r.style.transition="opacity 0.6s ease-out",r.style.opacity="0")},200),setTimeout(()=>{map&&map.flyTo([67.5,15],6,{duration:1.8,easeLinearity:.1})},400),setTimeout(()=>{e.classList.add("hidden")},900),setTimeout(()=>{map&&(map.dragging.enable(),map.scrollWheelZoom.enable(),map.doubleClickZoom.enable(),map.touchZoom.enable(),map.keyboard.enable(),map._zoomControl||(map._zoomControl=L.control.zoom({position:"topright"}).addTo(map)),map.getContainer().addEventListener("contextmenu",e=>{e.preventDefault()}))},1e3),setTimeout(()=>{appInitialized?loadCustomers():(initializeApp(),appInitialized=!0)},2300),setTimeout(()=>{n&&(n.style.transition="transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease-out",n.style.transform="translateX(0)",n.style.opacity="1");const e=document.querySelector(".tab-navigation");e&&(e.style.transition="opacity 0.4s ease-out",e.style.opacity="1",e.style.pointerEvents="auto");const t=document.getElementById("sidebarToggle");t&&(t.style.transition="opacity 0.4s ease-out",t.style.opacity="1",t.style.pointerEvents="auto")},1100),setTimeout(()=>{a&&(a.style.transition="transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease-out",a.style.transform="translateX(0)",a.style.opacity="1");const e=document.getElementById("contentPanel");"true"===localStorage.getItem("contentPanelOpen")&&e&&(e.style.transition="transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease-out",e.style.transform="translateX(0)",e.style.opacity="1")},1250),setTimeout(()=>{n&&(n.style.transition="",n.style.transform="",n.style.opacity=""),a&&(a.style.transition="",a.style.transform="",a.style.opacity="");const e=document.getElementById("contentPanel");e&&(e.style.transition="",e.style.transform="",e.style.opacity=""),s&&(s.style.transition="",s.style.transform="",s.style.opacity=""),o&&(o.style.transition="",o.style.opacity="",o.style.transform=""),r&&(r.style.transition="",r.style.opacity="")},2e3)}function showLoginView(){const e=document.getElementById("loginOverlay"),t=document.getElementById("appView"),n=document.getElementById("sidebar"),a=document.getElementById("filterPanel"),s=document.querySelector(".login-side"),o=document.querySelector(".login-brand-content"),r=document.querySelector(".login-map-overlay");hideUserBar();const i=document.getElementById("spaLoginForm");i&&i.reset(),resetLoginButton();const l=document.getElementById("loginErrorMessage");l&&l.classList.remove("show"),s&&(s.style.transition="none",s.style.transform="translateX(-30px)",s.style.opacity="0"),o&&(o.style.transition="none",o.style.transform="scale(0.9)",o.style.opacity="0"),r&&(r.style.transition="none",r.style.opacity="0");const d=window.innerWidth<=768;n&&(n.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-out",n.style.transform=d?"translateY(100%)":"translateX(-100%)",n.style.opacity="0",n.classList.remove("mobile-open")),a&&(a.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-out",a.style.transform=d?"translateY(100%)":"translateX(100%)",a.style.opacity="0");const c=document.getElementById("contentPanel");c&&!c.classList.contains("closed")&&(c.style.transition="transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-out",c.style.transform="translateX(-100%)",c.style.opacity="0");const u=document.querySelector(".bulk-action-bar");u&&u.classList.remove("visible");const m=document.getElementById("mobileRouteBtn");m&&m.classList.add("hidden");const p=document.querySelector(".tab-navigation");p&&(p.style.transition="opacity 0.3s ease-out",p.style.opacity="0",p.style.pointerEvents="none");const g=document.getElementById("sidebarToggle");if(g&&(g.style.transition="opacity 0.3s ease-out",g.style.opacity="0",g.style.pointerEvents="none"),markerClusterGroup){const e=document.querySelector(".leaflet-marker-pane");e&&(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0"),setTimeout(()=>{markerClusterGroup.clearLayers(),e&&(e.style.transition="",e.style.opacity="")},500)}routeLayer&&(map.removeLayer(routeLayer),routeLayer=null),setTimeout(()=>{e.classList.remove("hidden"),setTimeout(()=>{r&&(r.style.transition="opacity 0.8s ease-out",r.style.opacity="1"),s&&(s.style.transition="transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.5s ease-out",s.style.transform="translateX(0)",s.style.opacity="1"),setTimeout(()=>{o&&(o.style.transition="transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-out",o.style.transform="scale(1)",o.style.opacity="1")},150)},50)},300),map&&(map.dragging.disable(),map.scrollWheelZoom.disable(),map.doubleClickZoom.disable(),map.touchZoom.disable(),map.keyboard.disable(),map._zoomControl&&(map.removeControl(map._zoomControl),map._zoomControl=null),map.flyTo([69.06888,17.65274],11,{duration:1.8,easeLinearity:.15})),setTimeout(()=>{t.classList.add("hidden"),n&&(n.style.transition="",n.style.transform="",n.style.opacity=""),a&&(a.style.transition="",a.style.transform="",a.style.opacity="");const e=document.getElementById("contentPanel");e&&(e.style.transition="",e.style.transform="",e.style.opacity="",e.classList.add("closed"),e.classList.remove("open")),s&&(s.style.transition=""),o&&(o.style.transition=""),r&&(r.style.transition="")},1e3),currentView="login"}function applyIndustryChanges(){Logger.log("Applying industry changes..."),renderLoginFeatures();const e=document.getElementById("kategoriTabs");if(e&&(e.innerHTML=serviceTypeRegistry.renderCategoryTabs(selectedCategory),attachKategoriTabHandlers()),renderFilterPanelCategories(),applyMvpModeUI(),updateServiceTypeDropdowns(),updateMapLegend(),applyIndustryColors(),customers&&customers.length>0){renderMarkers(customers),renderCustomerAdmin();const e=customers.filter(e=>e.kategori&&!serviceTypeRegistry.isKnownCategory(e.kategori)).length;e>0&&showUnknownCategoryNotification(e)}applyBranding(),Logger.log("Industry changes applied")}function showUnknownCategoryNotification(e){const t=document.getElementById("unknownCategoryNotification");t&&t.remove();const n=document.createElement("div");n.id="unknownCategoryNotification",n.className="unknown-category-notification",n.innerHTML=`\n    <div class="notification-content">\n      <i class="fas fa-exclamation-triangle"></i>\n      <span><strong>${e}</strong> kunde${e>1?"r":""} har kategorier fra tidligere bransje og m&aring; oppdateres.</span>\n      <button class="btn-close-notification" onclick="this.parentElement.parentElement.remove()">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `;const a=document.querySelector(".content")||document.querySelector("main")||document.body;a.insertBefore(n,a.firstChild),setTimeout(()=>{n.parentElement&&(n.classList.add("fade-out"),setTimeout(()=>n.remove(),300))},1e4)}function attachKategoriTabHandlers(){const e=document.querySelectorAll("#kategoriTabs .category-tab");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),selectedCategory=t.dataset.category||"all",applyFilters()})})}function updateServiceTypeDropdowns(){const e=document.getElementById("kategoriCheckboxes");if(e){const t=serviceTypeRegistry.getSelectedCategories();e.innerHTML=serviceTypeRegistry.renderCategoryCheckboxes(t)}}function applyIndustryColors(){const e=serviceTypeRegistry.getAll(),t=document.documentElement;if(e.forEach(e=>{t.style.setProperty(`--service-color-${e.slug}`,e.color)}),e.length>=2){const n=`linear-gradient(135deg, ${e[0].color} 50%, ${e[1].color} 50%)`;t.style.setProperty("--service-color-combined",n)}injectDynamicMarkerStyles()}function darkenColor(e,t){e=e.replace("#","");let n=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),s=parseInt(e.substring(4,6),16);return n=Math.max(0,Math.floor(n*(1-t/100))),a=Math.max(0,Math.floor(a*(1-t/100))),s=Math.max(0,Math.floor(s*(1-t/100))),`#${n.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}function injectDynamicMarkerStyles(){const e=document.getElementById("dynamic-marker-styles");e&&e.remove();const t=serviceTypeRegistry.getAll();if(0===t.length)return;const n=document.createElement("style");n.id="dynamic-marker-styles";let a="";if(t.forEach(e=>{const t=industryPalettes[e.slug]||{light:e.color,primary:e.color,dark:darkenColor(e.color,20)};a+=`\n      /* Premium marker style for ${e.name} */\n      .custom-marker-with-label .marker-icon.${e.slug} {\n        background: linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%);\n        box-shadow:\n          0 2px 8px rgba(0, 0, 0, 0.4),\n          0 0 0 1px rgba(0, 0, 0, 0.1),\n          inset 0 1px 0 rgba(255, 255, 255, 0.25);\n      }\n\n      .custom-marker-with-label .marker-icon.${e.slug}[data-status="forfalt"] {\n        background: linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%) !important;\n      }\n\n      .custom-marker-with-label .marker-icon.${e.slug}[data-status="snart"] {\n        background: linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%) !important;\n      }\n    `}),t.length>=2){const e=industryPalettes[t[0].slug]||{primary:t[0].color},n=industryPalettes[t[1].slug]||{primary:t[1].color},s=e.primary,o=n.primary;a+=`\n      /* Premium combined marker style */\n      .custom-marker-with-label .marker-icon.combined {\n        width: 48px;\n        height: 48px;\n        min-width: 48px;\n        min-height: 48px;\n        background: linear-gradient(135deg, ${s} 0%, ${s} 48%, ${o} 52%, ${o} 100%);\n        font-size: 15px;\n        box-shadow:\n          0 2px 8px rgba(0, 0, 0, 0.4),\n          0 0 0 1px rgba(0, 0, 0, 0.1),\n          inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      }\n\n      .custom-marker-with-label .marker-icon.combined[data-status="forfalt"] {\n        background: linear-gradient(135deg, ${s} 0%, ${s} 48%, ${o} 52%, ${o} 100%) !important;\n      }\n\n      .custom-marker-with-label .marker-icon.combined[data-status="snart"] {\n        background: linear-gradient(135deg, ${s} 0%, ${s} 48%, ${o} 52%, ${o} 100%) !important;\n      }\n    `}n.textContent=a,document.head.appendChild(n),Logger.log("Premium marker styles injected for",t.length,"service types")}function updateMapLegend(){const e=document.getElementById("legendItems");if(!e)return;const t=serviceTypeRegistry.getAll();if(0!==t.length){if(e.innerHTML=t.map(e=>{const t=industryPalettes[e.slug]||{light:e.color,primary:e.color,dark:e.color};return`\n      <div class="legend-item">\n        <span class="legend-color" style="background: ${`linear-gradient(135deg, ${t.light} 0%, ${t.primary} 40%, ${t.dark} 100%)`}"></span>\n        <span>${e.name}</span>\n      </div>\n    `}).join(""),t.length>=2){const n=industryPalettes[t[0].slug]||{primary:t[0].color},a=industryPalettes[t[1].slug]||{primary:t[1].color},s=`linear-gradient(135deg, ${n.primary} 48%, ${a.primary} 52%)`,o=t.map(e=>escapeHtml(e.name)).join(" + ");e.innerHTML+=`\n      <div class="legend-item">\n        <span class="legend-color" style="background: ${s}"></span>\n        <span>${o}</span>\n      </div>\n    `}}else e.innerHTML='<div class="legend-item"><span class="legend-color" style="background: linear-gradient(135deg, #FBBF24, #D97706)"></span> Kunde</div>'}function applyBranding(){const e=document.getElementById("loginLogo"),t=document.getElementById("loginBrandTitle"),n=document.getElementById("loginBrandSubtitle"),a=document.getElementById("loginContact"),s=document.getElementById("loginAddress"),o=document.getElementById("loginContactLinks"),r=document.getElementById("loginFooterCopyright"),i=document.getElementById("headerLogo"),l=document.getElementById("headerCompanyName"),d=document.getElementById("headerAppName"),c=document.getElementById("headerYear");appConfig.logoUrl&&(e&&(e.src=appConfig.logoUrl,e.style.display="block"),i&&(i.src=appConfig.logoUrl,i.style.display="block")),d&&(d.textContent=appConfig.companyName||appConfig.appName||"Sky Planner");const u=appConfig.industry?.name;u?l&&(l.textContent=u,l.style.display=""):l&&(l.style.display="none"),appConfig.companyName&&t&&(t.textContent=appConfig.companyName);const m=appConfig.appYear||(new Date).getFullYear();if(c&&(c.textContent=m),r){const e=appConfig.developerName||"Efffekt AS";r.innerHTML=`&copy; ${m} ${escapeHtml(e)}. All rights reserved.`}if(n&&appConfig.companySubtitle&&(n.textContent=appConfig.companySubtitle),a&&(appConfig.contactAddress||appConfig.contactPhone||appConfig.contactEmail)&&(a.style.display="block",s&&appConfig.contactAddress&&(s.textContent=appConfig.contactAddress),o)){let e=[];if(appConfig.contactPhone){const t=appConfig.contactPhone.replace(/[^\d\s\+\-\(\)]/g,""),n=t.replace(/\s/g,"");e.push(`<a href="tel:${escapeHtml(n)}">${escapeHtml(t)}</a>`)}appConfig.contactEmail&&e.push(`<a href="mailto:${escapeHtml(appConfig.contactEmail)}">${escapeHtml(appConfig.contactEmail)}</a>`),o.innerHTML=e.join('<span class="login-contact-divider">·</span>')}applyTenantColors(),appConfig.appName&&(document.title=appConfig.appName),updateCategoryTabs(),renderLoginFeatures(),Logger.log("Branding applied from config")}function renderLoginFeatures(){const e=document.getElementById("loginFeatures");if(!e)return;let t=[];try{t=serviceTypeRegistry.getAll()||[]}catch(e){}const n=[...t.length>0?t.slice(0,3).map(e=>{let t=e.icon||"fa-check-circle";return t.startsWith("fas ")||t.startsWith("far ")||t.startsWith("fab ")||(t="fas "+t),{icon:t,name:e.name,description:e.description||"Periodisk kontroll"}}):[{icon:"fas fa-clipboard-check",name:"Kontroll",description:"Periodisk oppfølging av kunder"},{icon:"fas fa-route",name:"Ruteplanlegging",description:"Planlegg og optimaliser ruter"}],{icon:"fas fa-route",name:"Ruteplanlegging",description:"Effektive serviceruter"},{icon:"fas fa-bell",name:"Varsler",description:"Automatiske påminnelser"}];e.innerHTML=n.map(e=>`\n    <div class="login-feature">\n      <div class="login-feature-icon">\n        <i class="${e.icon}"></i>\n      </div>\n      <div class="login-feature-text">\n        <h4>${e.name}</h4>\n        <p>${e.description}</p>\n      </div>\n    </div>\n  `).join("")}function applyTenantColors(){const e=document.documentElement;appConfig.secondaryColor&&e.style.setProperty("--color-sidebar-bg",appConfig.secondaryColor),Logger.log("Tenant colors applied (Polarnatt theme active)")}function adjustColor(e,t){if(!e)return e;e=e.replace("#","");let n=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),s=parseInt(e.substring(4,6),16);return n=Math.min(255,Math.max(0,n+Math.round(n*t/100))),a=Math.min(255,Math.max(0,a+Math.round(a*t/100))),s=Math.min(255,Math.max(0,s+Math.round(s*t/100))),`#${n.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}async function reloadConfigWithAuth(){try{const e=await fetch("/api/config",{credentials:"include"});if(e.ok){const t=await e.json();if(appConfig=t.data||t,appConfig.serviceTypes&&appConfig.serviceTypes.length>0)serviceTypeRegistry.loadFromConfig(appConfig),Logger.log("Service types loaded from org config:",appConfig.serviceTypes.length);else{const e=appConfig.industry;if(e&&e.slug)localStorage.setItem("industrySlug",e.slug),localStorage.setItem("industryName",e.name||e.slug),await serviceTypeRegistry.loadFromIndustry(e.slug),Logger.log("Industry loaded from server:",e.slug);else{const e=localStorage.getItem("industrySlug");e?await serviceTypeRegistry.loadFromIndustry(e):serviceTypeRegistry.loadFromConfig(appConfig)}}updateControlSectionHeaders(),renderFilterPanelCategories(),applyMvpModeUI(),applyBranding(),applyDateModeToInputs(),refreshMapTiles(),Logger.log("Tenant-specific config loaded:",appConfig.organizationSlug)}}catch(e){Logger.warn("Could not reload tenant config:",e)}}function toggleMapLegend(){const e=document.getElementById("mapLegend");e&&e.classList.toggle("expanded")}function initMiscEventListeners(){initExcelImport();const e=document.getElementById("legendToggle");e&&e.addEventListener("click",toggleMapLegend)}function initExcelImport(){const e={sessionId:null,previewData:null,columnMapping:{},categoryMapping:{},currentPage:0,rowsPerPage:50,validCategories:[]},t=document.getElementById("importDropzone"),n=document.getElementById("importFileInput"),a={step1:document.getElementById("importStep1"),step2:document.getElementById("importStep2"),step3:document.getElementById("importStep3"),step4:document.getElementById("importStep4")};function s(e){Object.values(a).forEach(e=>{e&&e.classList.add("hidden")});const t=a[`step${e}`];t&&t.classList.remove("hidden"),document.querySelectorAll(".step-item").forEach(t=>{const n=parseInt(t.dataset.step);t.classList.remove("active","completed"),n<e&&t.classList.add("completed"),n===e&&t.classList.add("active")})}async function o(n){const a=n.name.toLowerCase().slice(n.name.lastIndexOf("."));if([".xlsx",".xls",".csv"].includes(a)){t.innerHTML=`\n      <i class="fas fa-spinner fa-spin"></i>\n      <p>Analyserer fil...</p>\n      <span class="import-formats">${n.name}</span>\n    `;try{const t=new FormData;t.append("file",n);const a=await apiFetch("/api/kunder/import-excel/preview",{method:"POST",body:t}),o=await a.json();if(!a.ok)throw new Error(o.error||"Kunne ikke analysere filen");e.sessionId=o.sessionId,e.previewData=o,e.validCategories=o.validCategories||[],e.columnMapping={},o.columns.detected.forEach(t=>{t.suggestedMapping&&(e.columnMapping[t.excelHeader]=t.suggestedMapping)}),function(t){const n=document.getElementById("columnMappingContainer");if(!n)return;const a=[{value:"",label:"-- Ignorer --"},{value:"navn",label:"Navn *",required:!0},{value:"adresse",label:"Adresse *",required:!0},{value:"postnummer",label:"Postnummer"},{value:"poststed",label:"Poststed"},{value:"telefon",label:"Telefon"},{value:"epost",label:"E-post"},{value:"kategori",label:"Kategori"},{value:"el_type",label:"El-type"},{value:"brann_system",label:"Brannsystem"},{value:"brann_driftstype",label:"Driftstype"},{value:"notater",label:"Notater"},{value:"lat",label:"Breddegrad"},{value:"lng",label:"Lengdegrad"}];n.innerHTML=t.columns.detected.map(e=>`\n      <div class="mapping-row">\n        <div class="mapping-excel">\n          <strong>${escapeHtml(e.excelHeader)}</strong>\n          <span class="sample-values">${e.sampleValues.map(e=>escapeHtml(e)).join(", ")||"Ingen verdier"}</span>\n        </div>\n        <i class="fas fa-arrow-right mapping-arrow"></i>\n        <div class="mapping-db">\n          <select class="column-select" data-excel="${escapeHtml(e.excelHeader)}">\n            ${a.map(t=>`\n              <option value="${t.value}" ${e.suggestedMapping===t.value?"selected":""}>\n                ${t.label}\n              </option>\n            `).join("")}\n          </select>\n          ${e.confidence<1&&e.suggestedMapping?`<span class="confidence-badge">${Math.round(100*e.confidence)}%</span>`:""}\n        </div>\n      </div>\n    `).join(""),n.querySelectorAll(".column-select").forEach(t=>{t.addEventListener("change",t=>{const n=t.target.dataset.excel;e.columnMapping[n]=t.target.value})})}(o),s(2)}catch(e){showNotification(e.message,"error"),r()}}else showNotification("Ugyldig filtype. Kun Excel (.xlsx, .xls) og CSV (.csv) er tillatt.","error")}function r(){t.innerHTML='\n      <i class="fas fa-cloud-upload-alt"></i>\n      <p>Dra og slipp fil her, eller klikk for å velge</p>\n      <span class="import-formats">Støttede formater: .xlsx, .xls, .csv (maks 10MB)</span>\n    ',n.value=""}function i(){e.sessionId=null,e.previewData=null,e.columnMapping={},e.categoryMapping={},e.currentPage=0,r(),s(1)}function l(t){const n=t.analysis;document.getElementById("newCount").textContent=n.toCreate||0,document.getElementById("updateCount").textContent=n.toUpdate||0,document.getElementById("warningCount").textContent=n.warningRows||0,document.getElementById("errorCount").textContent=n.errorRows||0;const a=(n.toCreate||0)+(n.toUpdate||0);document.getElementById("importCountLabel").textContent=a,function(t){const n=document.getElementById("categoryMappingSection"),a=document.getElementById("categoryMappingList");if(!t||0===t.unknown.length)return void n.classList.add("hidden");n.classList.remove("hidden"),a.innerHTML=t.unknown.map(t=>`\n      <div class="category-mapping-row">\n        <span class="original-value">"${escapeHtml(t.value)}"</span>\n        <span class="occurrence-count">(${t.count} forekomster)</span>\n        <select class="category-select" data-original="${escapeHtml(t.value)}">\n          <option value="">-- Velg kategori --</option>\n          ${e.validCategories.map(e=>`\n            <option value="${e}">${e}</option>\n          `).join("")}\n        </select>\n      </div>\n    `).join(""),a.querySelectorAll(".category-select").forEach(t=>{t.addEventListener("change",t=>{const n=t.target.dataset.original;e.categoryMapping[n]=t.target.value})})}(t.categoryAnalysis),function(t){const n=document.getElementById("dynamicSchemaSection"),a=document.getElementById("newCategoriesSection"),s=document.getElementById("newFieldsSection"),o=document.getElementById("newFieldValuesSection");if(!n||!t)return void(n&&n.classList.add("hidden"));const r=t.newCategories&&t.newCategories.length>0,i=t.newFields&&t.newFields.length>0,l=t.newFieldValues&&Object.keys(t.newFieldValues).length>0;if(!r&&!i&&!l)return void n.classList.add("hidden");if(n.classList.remove("hidden"),e.dynamicSchema={selectedCategories:{},selectedFields:{},selectedFieldValues:{}},r){a.classList.remove("hidden");const n=document.getElementById("newCategoriesList");n.innerHTML=t.newCategories.map((e,t)=>`\n        <div class="schema-item">\n          <input type="checkbox" class="schema-item-checkbox" id="newCat_${t}" data-category="${escapeHtml(e.name)}" checked>\n          <div class="schema-item-color" style="background-color: ${e.color}"></div>\n          <div class="schema-item-icon">\n            <i class="fas ${e.icon}"></i>\n          </div>\n          <div class="schema-item-info">\n            <label for="newCat_${t}" class="schema-item-name">${escapeHtml(e.name)}</label>\n            <div class="schema-item-meta">Intervall: ${e.default_interval_months||12} mnd</div>\n          </div>\n        </div>\n      `).join(""),n.querySelectorAll(".schema-item-checkbox").forEach(t=>{const n=t.dataset.category;e.dynamicSchema.selectedCategories[n]=t.checked,t.addEventListener("change",t=>{e.dynamicSchema.selectedCategories[n]=t.target.checked})})}else a.classList.add("hidden");if(i){s.classList.remove("hidden");const n=document.getElementById("newFieldsList");n.innerHTML=t.newFields.map((e,t)=>`\n        <div class="schema-item">\n          <input type="checkbox" class="schema-item-checkbox" id="newField_${t}" data-field="${escapeHtml(e.field_name)}" checked>\n          <div class="schema-item-info">\n            <label for="newField_${t}" class="schema-item-name">${escapeHtml(e.display_name)}</label>\n            <div class="schema-item-meta">\n              <span class="schema-field-type">${e.field_type}</span>\n              ${e.is_filterable?'<span class="schema-field-type" style="background: #10B981;">Filtrerbart</span>':""}\n            </div>\n            ${e.options&&e.options.length>0?`\n              <div class="schema-item-preview">\n                ${e.options.slice(0,5).map(e=>`\n                  <span class="schema-item-preview-tag">${escapeHtml(e.value||e)}</span>\n                `).join("")}\n                ${e.options.length>5?`<span class="schema-item-preview-tag">+${e.options.length-5} mer</span>`:""}\n              </div>\n            `:""}\n          </div>\n        </div>\n      `).join(""),n.querySelectorAll(".schema-item-checkbox").forEach(t=>{const n=t.dataset.field;e.dynamicSchema.selectedFields[n]=t.checked,t.addEventListener("change",t=>{e.dynamicSchema.selectedFields[n]=t.target.checked})})}else s.classList.add("hidden");if(l){o.classList.remove("hidden");const n=document.getElementById("newFieldValuesList"),a=Object.entries(t.newFieldValues);n.innerHTML=a.map(([e,t],n)=>`\n        <div class="schema-item">\n          <input type="checkbox" class="schema-item-checkbox" id="newValues_${n}" data-field="${escapeHtml(e)}" checked>\n          <div class="schema-item-info">\n            <label for="newValues_${n}" class="schema-item-name">${escapeHtml(e)}</label>\n            <div class="schema-item-preview">\n              ${t.slice(0,5).map(e=>`\n                <span class="schema-item-preview-tag">${escapeHtml(e)}</span>\n              `).join("")}\n              ${t.length>5?`<span class="schema-item-preview-tag">+${t.length-5} mer</span>`:""}\n            </div>\n          </div>\n        </div>\n      `).join(""),n.querySelectorAll(".schema-item-checkbox").forEach(t=>{const n=t.dataset.field;e.dynamicSchema.selectedFieldValues[n]=t.checked,t.addEventListener("change",t=>{e.dynamicSchema.selectedFieldValues[n]=t.target.checked})})}else o.classList.add("hidden")}(t.dynamicSchema),d(t.previewData)}function d(t){const n=document.getElementById("previewTableHead"),a=document.getElementById("previewTableBody");if(!t||0===t.length)return n.innerHTML="",void(a.innerHTML='<tr><td colspan="5">Ingen data</td></tr>');n.innerHTML="\n      <tr>\n        <th>Rad</th>\n        <th>Status</th>\n        <th>Navn</th>\n        <th>Adresse</th>\n        <th>Info</th>\n      </tr>\n    ";const s=e.currentPage*e.rowsPerPage,o=t.slice(s,s+e.rowsPerPage);a.innerHTML=o.map(e=>{const t={valid:"status-new",warning:"status-warning",error:"status-error",duplicate:"status-update"}[e.status]||"",n={valid:'<i class="fas fa-plus-circle"></i>',warning:'<i class="fas fa-exclamation-triangle"></i>',error:'<i class="fas fa-times-circle"></i>',duplicate:'<i class="fas fa-sync-alt"></i>'}[e.status]||"",a={valid:"Ny",warning:"Advarsel",error:"Feil",duplicate:"Oppdateres"}[e.status]||e.status;return`\n        <tr class="${t}">\n          <td>${e.rowNumber}</td>\n          <td><span class="status-badge ${t}">${n} ${a}</span></td>\n          <td>${escapeHtml(e.normalizedData?.navn||"-")}</td>\n          <td>${escapeHtml(e.normalizedData?.adresse||"-")}</td>\n          <td class="info-cell">\n            ${e.issues.length>0?`<span class="issues-tooltip" title="${e.issues.map(e=>escapeHtml(e)).join("\n")}">\n                <i class="fas fa-info-circle"></i> ${e.issues.length} melding${e.issues.length>1?"er":""}\n              </span>`:"-"}\n          </td>\n        </tr>\n      `}).join(""),function(t){const n=Math.ceil(t/e.rowsPerPage),a=e.currentPage+1;document.getElementById("pageInfo").textContent=`Side ${a} av ${n}`,document.getElementById("prevPageBtn").disabled=0===e.currentPage,document.getElementById("nextPageBtn").disabled=a>=n}(t.length)}function c(e,t){const n=document.getElementById("resultIcon"),a=document.getElementById("importResultTitle");if(e){n.innerHTML='<i class="fas fa-check-circle"></i>',n.className="result-icon success",a.textContent="Import fullført!",document.getElementById("resultCreated").textContent=t.created||0,document.getElementById("resultUpdated").textContent=t.updated||0,document.getElementById("resultSkipped").textContent=t.skipped||0;const e=document.getElementById("resultErrors"),s=document.getElementById("errorList");t.errors&&t.errors.length>0?(e.classList.remove("hidden"),s.innerHTML=t.errors.slice(0,10).map(e=>`<li>Rad ${e.row}: ${escapeHtml(e.navn||"")} - ${escapeHtml(e.error)}</li>`).join(""),t.errors.length>10&&(s.innerHTML+=`<li>... og ${t.errors.length-10} flere</li>`)):e.classList.add("hidden");const o=document.getElementById("resultNote");t.geocodingNote?(o.textContent=t.geocodingNote,o.classList.remove("hidden")):o.classList.add("hidden")}else{n.innerHTML='<i class="fas fa-times-circle"></i>',n.className="result-icon error",a.textContent="Import feilet",document.getElementById("resultCreated").textContent="0",document.getElementById("resultUpdated").textContent="0",document.getElementById("resultSkipped").textContent="0";const e=document.getElementById("resultNote");e.textContent=t.error||"En ukjent feil oppstod.",e.classList.remove("hidden")}}t&&n&&(t.setAttribute("role","button"),t.setAttribute("tabindex","0"),t.setAttribute("aria-label","Last opp fil. Dra og slipp, eller trykk for å velge fil."),t.addEventListener("click",()=>n.click()),t.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n.click())}),t.addEventListener("dragover",e=>{e.preventDefault(),t.classList.add("dragover")}),t.addEventListener("dragleave",()=>{t.classList.remove("dragover")}),t.addEventListener("drop",e=>{e.preventDefault(),t.classList.remove("dragover"),e.dataTransfer.files.length>0&&o(e.dataTransfer.files[0])}),n.addEventListener("change",()=>{n.files.length>0&&o(n.files[0])}),document.getElementById("prevPageBtn")?.addEventListener("click",()=>{e.currentPage>0&&(e.currentPage--,d(e.previewData.previewData))}),document.getElementById("nextPageBtn")?.addEventListener("click",()=>{const t=Math.ceil(e.previewData.previewData.length/e.rowsPerPage);e.currentPage<t-1&&(e.currentPage++,d(e.previewData.previewData))}),document.getElementById("backToStep1Btn")?.addEventListener("click",i),document.getElementById("proceedToStep3Btn")?.addEventListener("click",()=>{const t=Object.values(e.columnMapping).includes("navn"),n=Object.values(e.columnMapping).includes("adresse");t&&n?(l(e.previewData),s(3)):showNotification('Du må mappe minst "Navn" og "Adresse" kolonnene.',"error")}),document.getElementById("backToStep2Btn")?.addEventListener("click",()=>{s(2)}),document.getElementById("startImportBtn")?.addEventListener("click",async()=>{const t=document.getElementById("startImportBtn");t.disabled=!0,s(4),document.getElementById("importProgress").classList.remove("hidden"),document.getElementById("importResult").classList.add("hidden");const n=document.getElementById("importProgressFill"),a=document.getElementById("importProgressText");n.style.width="5%",a.textContent="Oppretter nye kategorier og felt...";try{if(e.dynamicSchema){const t=e.previewData?.dynamicSchema,s=t?.newCategories?.filter(t=>e.dynamicSchema.selectedCategories[t.name])||[];if(s.length>0){a.textContent=`Oppretter ${s.length} nye kategorier...`;for(const e of s)try{await apiFetch("/api/service-types",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e.name,icon:e.icon||"fa-wrench",color:e.color||"#5E81AC",default_interval_months:e.default_interval_months||12})})}catch(t){console.warn(`Could not create category ${e.name}:`,t)}await loadOrganizationCategories(),renderFilterPanelCategories()}n.style.width="10%";const o=t?.newFields?.filter(t=>e.dynamicSchema.selectedFields[t.field_name])||[];if(o.length>0){a.textContent=`Oppretter ${o.length} nye felt...`;try{await apiFetch("/api/fields/bulk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fields:o})})}catch(e){console.warn("Could not create fields:",e)}}n.style.width="15%"}n.style.width="20%",a.textContent="Starter kundeimport...";const t=await apiFetch("/api/kunder/import-excel/execute",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e.sessionId,categoryMapping:e.categoryMapping,geocodeAfterImport:document.getElementById("geocodeAfterImport")?.checked||!1})});n.style.width="90%",a.textContent="Fullfører...";const s=await t.json();n.style.width="100%",setTimeout(()=>{document.getElementById("importProgress").classList.add("hidden"),document.getElementById("importResult").classList.remove("hidden"),c(t.ok&&s.success,s),t.ok&&s.success&&loadCustomers()},500)}catch(e){document.getElementById("importProgress").classList.add("hidden"),document.getElementById("importResult").classList.remove("hidden"),c(!1,{error:e.message})}t.disabled=!1}),document.getElementById("closeImportResultBtn")?.addEventListener("click",i))}function updateWeekPlanBadges(){if(!markers)return;const e=getWeekTeamMembers(),t=new Map;e.forEach(e=>t.set(e.name,e.color));const n=new Map,a=localStorage.getItem("userName")||"",s=getCreatorDisplay(a,!0);if(weekPlanState.days)for(const e of weekDayKeys){const o=weekPlanState.days[e];if(o)for(const r of o.planned)n.set(r.id,{initials:s,day:weekDayLabels[weekDayKeys.indexOf(e)].substring(0,3),color:t.get(a)||TEAM_COLORS[0],creator:a})}if(weekPlanState.days){const e=new Set(weekDayKeys.map(e=>weekPlanState.days[e]?.date).filter(Boolean));for(const a of avtaler){if(!e.has(a.dato)||!a.kunde_id)continue;if(n.has(a.kunde_id))continue;const s=a.opprettet_av&&"admin"!==a.opprettet_av?a.opprettet_av:"";if(!s)continue;const o=getCreatorDisplay(s,!0),r=(new Date(a.dato+"T00:00:00").getDay()+6)%7;n.set(a.kunde_id,{initials:o,day:r<5?weekDayLabels[r].substring(0,3):"",color:t.get(s)||TEAM_COLORS[1],creator:s})}}for(const e of Object.keys(markers)){const t=markers[e].getElement();if(!t)continue;const a=t.querySelector(".wp-plan-badge");a&&a.remove();const s=n.get(Number(e));if(s){const e=document.createElement("div");e.className="wp-plan-badge",e.style.backgroundColor=s.color,e.textContent=s.initials,e.title=`${s.day} - ${s.initials}`,t.appendChild(e)}}if(markerClusterGroup){for(const[e,t]of n)markers[e]&&(markers[e].options.customerData={...markers[e].options.customerData,planned:!0,plannedInitials:t.initials,plannedColor:t.color});for(const e of Object.keys(markers))!n.has(Number(e))&&markers[e].options.customerData&&(delete markers[e].options.customerData.planned,delete markers[e].options.customerData.plannedInitials,delete markers[e].options.customerData.plannedColor);markerClusterGroup.refreshClusters()}}function reapplyPlanBadges(){if(markers)for(const e of Object.keys(markers)){const t=markers[e],n=t.getElement();if(!n)continue;if(n.querySelector(".wp-plan-badge"))continue;const a=t.options.customerData;if(a&&a.planned&&a.plannedInitials){const e=document.createElement("div");e.className="wp-plan-badge",e.style.backgroundColor=a.plannedColor||TEAM_COLORS[0],e.textContent=a.plannedInitials,n.appendChild(e)}}}function updateDayCounters(){const e=document.querySelector(".tab-item.active")?.dataset.tab;"customers"===e?renderCustomerAdmin():"overdue"===e?renderOverdue():"warnings"===e?renderWarnings():"planner"===e&&renderPlanner(),updateOverdueBadge(),renderMissingData(),applyFilters()}function scheduleNextMidnightUpdate(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1),t.setHours(0,0,1,0);const n=t.getTime()-e.getTime();setTimeout(()=>{Logger.log("Midnight update - refreshing day counters"),updateDayCounters(),scheduleNextMidnightUpdate()},n),Logger.log(`Next midnight update scheduled in ${Math.round(n/1e3/60)} minutes`)}function updateCategoryTabs(){if(!serviceTypeRegistry.initialized)return;const e=document.getElementById("kategoriTabs");e&&(e.innerHTML=serviceTypeRegistry.renderCategoryTabs(customerAdminKategori),Logger.log("Category tabs updated from service registry"))}function updateBadge(e,t){const n=document.getElementById(e);n&&(t>0?(n.textContent=t,n.style.display="inline-flex"):n.style.display="none")}function getNearestControlDate(e){const t=[e.neste_el_kontroll,e.neste_brann_kontroll,e.neste_kontroll].filter(Boolean).map(e=>{const[t,n,a]=e.split("-").map(Number);return new Date(t,n-1,a)});return 0===t.length?null:new Date(Math.min(...t))}async function loadConfig(){try{const e=await fetch("/api/config",{credentials:"include"});if(!e.ok)throw new Error(`Config load failed: ${e.status}`);const t=await e.json();appConfig=t.data||t,serviceTypeRegistry.loadFromConfig(appConfig),allSubcategoryGroups=appConfig.subcategoryGroups||[];const n=localStorage.getItem("industrySlug");if(n)try{await serviceTypeRegistry.loadFromIndustry(n),Logger.log("Loaded saved industry from localStorage:",n)}catch(e){Logger.warn("Could not load saved industry:",e)}updateControlSectionHeaders(),renderFilterPanelCategories(),applyMvpModeUI(),Logger.log("Application configuration loaded:",appConfig),Logger.log("Route planning configured:",appConfig.orsApiKeyConfigured)}catch(e){Logger.warn("Could not load configuration from server:",e),appConfig={appName:"Sky Planner",companyName:"",companySubtitle:"Kontroll. Oversikt. Alltid.",logoUrl:"/skyplanner-logo.svg",contactAddress:"",contactPhone:"",contactEmail:"",appYear:"2026",mapCenterLat:65.5,mapCenterLng:12,mapZoom:5,mapClusterRadius:80,enableRoutePlanning:!0,showUpcomingWidget:!0,upcomingControlDays:30,defaultControlInterval:12,controlIntervals:[6,12,24,36],requireAuth:!0}}}async function loadCustomers(){Logger.log("loadCustomers() called, markerClusterGroup:",!!markerClusterGroup);try{const e=await apiFetch("/api/kunder");if(!e.ok)throw new Error(`HTTP ${e.status}: Kunne ikke laste kunder`);const t=await e.json();customers=t.data||t,Logger.log("loadCustomers() fetched",customers.length,"customers"),applyFilters(),renderMarkers(customers),renderCustomerAdmin(),updateOverdueBadge(),renderMissingData(),updateDashboard(),updateGettingStartedBanner(),weekPlanState.weekStart||initWeekPlanState(new Date),await Promise.all([loadAvtaler(),loadAllSubcategoryAssignments()])}catch(e){console.error("Feil ved lasting av kunder:",e)}}function updateGettingStartedBanner(){const e=document.getElementById("gettingStartedBanner");if(customers.length>0)return void(e&&e.remove());if("true"===localStorage.getItem("gettingStartedDismissed"))return;if(e)return;const t=document.createElement("div");t.id="gettingStartedBanner",t.className="getting-started-banner",t.innerHTML=renderGettingStartedBanner();const n=document.getElementById("sharedMapContainer");n&&n.appendChild(t),t.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const n=t.dataset.action;"dismiss-getting-started"===n?dismissGettingStartedBanner():"open-integrations"===n?window.open(t.dataset.url,"_blank"):"contact-import"===n?window.location.href=t.dataset.url:"add-customer-manual"===n&&(dismissGettingStartedBanner(),addCustomer())})}function renderGettingStartedBanner(){return`\n    <div class="getting-started-header">\n      <div>\n        <h2>Velkommen til Sky Planner!</h2>\n        <p>Legg til dine kunder for å komme i gang.</p>\n      </div>\n      <button class="getting-started-close" data-action="dismiss-getting-started" title="Lukk">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n    <div class="getting-started-cards">\n      <div class="getting-started-card" data-action="open-integrations" data-url="${escapeHtml(appConfig.webUrl||"")}/dashboard/innstillinger/integrasjoner">\n        <div class="getting-started-card-icon">\n          <i class="fas fa-plug"></i>\n        </div>\n        <h3>Koble til regnskapssystem</h3>\n        <p>Synkroniser kunder fra Tripletex, Fiken eller PowerOffice.</p>\n      </div>\n      <div class="getting-started-card" data-action="contact-import" data-url="mailto:support@skyplanner.no?subject=Hjelp med dataimport">\n        <div class="getting-started-card-icon">\n          <i class="fas fa-file-import"></i>\n        </div>\n        <h3>Importer eksisterende data</h3>\n        <p>Har du data i Excel eller annet format? Kontakt oss, s&aring; hjelper vi deg.</p>\n      </div>\n      <div class="getting-started-card" data-action="add-customer-manual">\n        <div class="getting-started-card-icon">\n          <i class="fas fa-plus-circle"></i>\n        </div>\n        <h3>Legg til manuelt</h3>\n        <p>Opprett kunder en og en direkte i systemet.</p>\n      </div>\n    </div>\n  `}function dismissGettingStartedBanner(){localStorage.setItem("gettingStartedDismissed","true");const e=document.getElementById("gettingStartedBanner");e&&(e.style.opacity="0",e.style.transform="translateY(-20px)",setTimeout(()=>e.remove(),300))}async function loadOmrader(){try{const e=await apiFetch("/api/omrader");if(!e.ok)throw new Error(`HTTP ${e.status}: Kunne ikke laste områder`);const t=await e.json();omrader=t.data||t,renderOmradeFilter()}catch(e){console.error("Feil ved lasting av områder:",e)}}function renderOmradeFilter(){const e=document.getElementById("omradeFilter");if(!e)return;e.innerHTML=`\n    <div style="display:flex;gap:4px;align-items:center;">\n      <select id="omradeSelect" style="flex:1;">\n        <option value="alle">Alle områder</option>\n        <option value="varsler">Trenger kontroll</option>\n        ${omrader.map(e=>`<option value="${escapeHtml(e.poststed)}">${escapeHtml(e.poststed)} (${e.antall})</option>`).join("")}\n      </select>\n      <button id="showOverdueInAreaBtn" class="btn btn-small btn-warning" style="display:none;white-space:nowrap;" title="Vis forfalte i området på kartet">\n        <i class="fas fa-exclamation-triangle"></i>\n      </button>\n    </div>\n  `;const t=document.getElementById("omradeSelect"),n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.addEventListener("change",e=>{currentFilter=e.target.value,showOnlyWarnings="varsler"===currentFilter,applyFilters();const t=document.getElementById("showOverdueInAreaBtn");t&&(t.style.display="alle"!==currentFilter&&"varsler"!==currentFilter?"inline-flex":"none")});const a=document.getElementById("showOverdueInAreaBtn");a&&a.addEventListener("click",()=>{const e=12*(new Date).getFullYear()+(new Date).getMonth(),t=customers.filter(t=>{if(t.poststed!==currentFilter)return!1;const n=getNextControlDate(t);if(!n)return!1;return 12*n.getFullYear()+n.getMonth()<e});if(0===t.length)return void showToast("Ingen forfalte kontroller i dette området","info");const n=t.map(e=>e.id);showCustomersOnMap(n),highlightCustomersOnMap(n),showToast(`${t.length} forfalte kontroller i ${currentFilter}`,"warning")})}async function applyFilters(){filterAbortController&&filterAbortController.abort(),filterAbortController=new AbortController;let e=[...customers];const t=searchInput?.value?.toLowerCase()||"";if("all"!==selectedCategory){const t=e.length,n=selectedCategory.split(" + ").map(e=>e.trim());e=e.filter(e=>{if(!e.kategori)return!1;const t=e.kategori.split(" + ").map(e=>e.trim());return n.every(e=>t.includes(e))}),Logger.log(`applyFilters: "${selectedCategory}" - ${t} -> ${e.length} kunder`)}const n=Object.entries(selectedSubcategories).filter(([e,t])=>t);if(n.length>0&&(e=e.filter(e=>{const t=kundeSubcatMap[e.id]||[];return n.every(([e,n])=>t.some(t=>t.group_id===Number(e)&&t.subcategory_id===Number(n)))})),Object.keys(dynamicFieldFilters).length>0&&(e=e.filter(e=>{let t=e.custom_data;if("string"==typeof t)try{t=JSON.parse(t)}catch{t={}}return t=t||{},Object.entries(dynamicFieldFilters).every(([e,n])=>{const a=t[e],s=organizationFields.find(t=>t.field_name===e);if(!s)return!0;switch(s.field_type){case"select":return a===n;case"text":default:return a&&String(a).toLowerCase().includes(String(n).toLowerCase());case"number":if(!a&&0!==a)return!1;const e=parseFloat(a);return!isNaN(e)&&(!(n.min&&e<parseFloat(n.min))&&!(n.max&&e>parseFloat(n.max)));case"date":if(!a)return!1;const t=new Date(a);return!isNaN(t.getTime())&&(!(n.from&&t<new Date(n.from))&&!(n.to&&t>new Date(n.to)))}})})),showOnlyWarnings)try{const t=await apiFetch("/api/kunder/kontroll-varsler?dager=30",{signal:filterAbortController.signal});if(!t.ok)throw new Error(`HTTP ${t.status}: Kunne ikke laste varsler`);const n=await t.json(),a=n.data||n,s=new Set(a.map(e=>e.id));e=e.filter(e=>s.has(e.id))}catch(e){if("AbortError"===e.name)return;console.error("Feil ved henting av varsler:",e),showNotification("Kunne ikke laste varsler. Prøv igjen senere.","error")}else"alle"!==currentFilter&&(e=e.filter(e=>e.poststed===currentFilter));t&&(e=e.filter(e=>e.navn.toLowerCase().includes(t)||e.adresse.toLowerCase().includes(t)||e.poststed&&e.poststed.toLowerCase().includes(t)||e.postnummer&&e.postnummer.includes(t))),renderCustomerList(e),renderMarkers(e),updateCategoryFilterCounts();const a=searchInput?.value?.trim();a&&e.length>0&&e.length<50?highlightCustomersOnMap(e.map(e=>e.id)):clearMapHighlights();const s=document.getElementById("filterResultCount");s&&(e.length!==customers.length?(s.textContent=`Viser ${e.length} av ${customers.length} kunder`,s.style.display="block"):s.style.display="none")}function updateCategoryFilterCounts(){const e=serviceTypeRegistry.getAll(),t=document.querySelector('[data-category="all"]');t&&(t.innerHTML=`<i class="fas fa-list"></i> Alle (${customers.length})`);const n=document.querySelector('[data-kategori="alle"]');if(n&&(n.innerHTML=`Alle (${customers.length})`),e.forEach(e=>{const t=customers.filter(t=>!!t.kategori&&t.kategori.split(" + ").map(e=>e.trim()).includes(e.name)).length,n=serviceTypeRegistry.getIcon(e),a=document.querySelector(`[data-category="${e.name}"]`);a&&(a.innerHTML=`${n} ${escapeHtml(e.name)} (${t})`);const s=document.querySelector(`[data-kategori="${e.name}"]`);s&&(s.innerHTML=`${n} ${escapeHtml(e.name)} (${t})`)}),e.length>=2){const t=e.map(e=>e.name).join(" + "),n=customers.filter(t=>{if(!t.kategori)return!1;const n=t.kategori.split(" + ").map(e=>e.trim());return e.every(e=>n.includes(e.name))}).length,a=e.map(e=>serviceTypeRegistry.getIcon(e)).join(""),s=e.length>2?"Alle":"Begge",o=document.querySelector(`[data-category="${t}"]`);o&&(o.innerHTML=`${a} ${s} (${n})`);const r=document.querySelector(`[data-kategori="${t}"]`);r&&(r.innerHTML=`${a} ${s} (${n})`)}}function getControlStatus(e){const t=new Date;if(t.setHours(0,0,0,0),hasFeature("lifecycle_colors")){if(e.last_visit_date){const n=new Date(e.last_visit_date),a=Math.ceil((t-n)/864e5);if(a<=14)return{status:"besøkt",label:`Besøkt ${a}d siden`,class:"status-visited",date:formatDateInline(n),daysUntil:null}}if(e.inquiry_sent_date){const n=new Date(e.inquiry_sent_date),a=Math.ceil((t-n)/864e5);if(a<=30)return{status:"forespørsel",label:`Forespørsel sendt ${a}d siden`,class:"status-inquiry",date:formatDateInline(n),daysUntil:null}}if(e.job_confirmed_type){return{status:"bekreftet",label:`Bekreftet: ${{a:"Type A",b:"Type B",begge:"Begge"}[e.job_confirmed_type]||e.job_confirmed_type}`,class:"begge"===e.job_confirmed_type?"status-confirmed-both":"b"===e.job_confirmed_type?"status-confirmed-b":"status-confirmed-a",date:null,daysUntil:null}}}const n=getNextControlDate(e);if(!n)return{status:"ukjent",label:"Ikke registrert",class:"status-unknown",date:null,daysUntil:null};const a=Math.ceil((n-t)/864e5),s=formatDateInline(n);return 12*n.getFullYear()+n.getMonth()<12*t.getFullYear()+t.getMonth()?{status:"forfalt",label:`${Math.abs(a)} dager over`,class:"status-overdue",date:s,daysUntil:a}:a<0?{status:"forfaller",label:`${Math.abs(a)} dager over`,class:"status-this-week",date:s,daysUntil:a}:a<=7?{status:"denne-uke",label:`${a} dager`,class:"status-this-week",date:s,daysUntil:a}:a<=30?{status:"snart",label:`${a} dager`,class:"status-soon",date:s,daysUntil:a}:a<=60?{status:"neste-mnd",label:`${a} dager`,class:"status-next-month",date:s,daysUntil:a}:a<=90?{status:"ok",label:`${a} dager`,class:"status-ok",date:s,daysUntil:a}:{status:"god",label:formatDate(n),class:"status-good",date:s,daysUntil:a}}function renderCustomerList(e){const t={};e.forEach(e=>{const n=e.poststed||"Ukjent område";t[n]||(t[n]=[]),t[n].push(e)});const n=Object.keys(t).sort((e,n)=>{const a=t[e][0],s=t[n][0],o=a?.postnummer||"9999",r=s?.postnummer||"9999";return o!==r?o.localeCompare(r):e.localeCompare(n)});n.forEach(e=>{sortByNavn(t[e])});if(0===e.length){if(customerList){const e=customers.length>0;customerList.innerHTML=`\n        <div style="text-align:center;padding:40px 20px;color:var(--color-text-secondary,#a0a0a0);">\n          <i class="fas ${e?"fa-filter":"fa-users"}" style="font-size:32px;margin-bottom:12px;display:block;opacity:0.5;"></i>\n          <p style="font-size:15px;margin:0 0 8px;">${e?"Ingen kunder matcher filteret":"Ingen kunder lagt til ennå"}</p>\n          <p style="font-size:13px;margin:0;opacity:0.7;">${e?"Prøv å endre søk eller filter":"Klikk + for å legge til din første kunde"}</p>\n        </div>\n      `}return}let a="";n.forEach(e=>{const n=t[e],s=n[0]?.postnummer||"",o="true"===localStorage.getItem(`areaExpanded-${e}`),r=(e=>{let t=0,n=0;return e.forEach(e=>{const a=getControlStatus(e);"overdue"===a.class?t++:"warning"===a.class&&n++}),{urgent:t,warning:n}})(n);let i="";r.urgent>0&&(i+=`<span class="area-badge urgent">${r.urgent}</span>`),r.warning>0&&(i+=`<span class="area-badge warning">${r.warning}</span>`),a+=`\n      <div class="customer-section">\n        <button class="section-header" data-area="${escapeHtml(e)}" data-action="toggleSection">\n          <span class="section-toggle-icon">\n            <i class="fas fa-chevron-${o?"down":"right"}"></i>\n          </span>\n          <span class="section-title">\n            <span class="section-postnr">${s}</span>\n            <span class="section-name">${escapeHtml(e)}</span>\n          </span>\n          <span class="section-meta">\n            ${i}\n            <span class="section-count">${n.length}</span>\n          </span>\n        </button>\n        <div class="section-content ${o?"":"collapsed"}">\n          ${n.map(e=>{const t=getControlStatus(e),n=e.neste_kontroll?formatDateInline(new Date(e.neste_kontroll)):"Ikke satt",a=e.neste_kontroll?Math.ceil((new Date(e.neste_kontroll)-new Date)/864e5):null;let s="";null!==a&&(s=a<0?`${Math.abs(a)}d over`:0===a?"I dag":`${a}d`);const o=e.epost&&""!==e.epost.trim();return`\n              <div class="customer-item ${selectedCustomers.has(e.id)?"selected":""} ${t.class}"\n                   data-id="${e.id}" data-action="selectCustomer" data-customer-id="${e.id}">\n                <div class="customer-status-indicator ${t.class}"></div>\n                <div class="customer-info">\n                  <h3>${escapeHtml(e.navn)}</h3>\n                  <p>${escapeHtml(e.adresse)}</p>\n                </div>\n                <div class="customer-actions">\n                  <button class="customer-email-btn ${o?"":"disabled"}"\n                          data-action="sendEmail"\n                          data-customer-id="${e.id}"\n                          title="${o?"Send e-post":"Ingen e-post registrert"}">\n                    <i class="fas fa-envelope"></i>\n                  </button>\n                </div>\n                <div class="customer-control-info">\n                  <span class="control-date ${t.class}">${escapeHtml(n)}</span>\n                  ${s?`<span class="control-days ${t.class}">${escapeHtml(s)}</span>`:""}\n                </div>\n              </div>\n            `}).join("")}\n        </div>\n      </div>\n    `}),customerList.innerHTML=a}let activeContextMenu=null,contextMenuCustomerId=null;function showMarkerContextMenu(e,t,n){closeContextMenu(),contextMenuCustomerId=e.id;const a=document.createElement("div");a.className="marker-context-menu",a.setAttribute("role","menu");const s=selectedCustomers.has(e.id),o=e.epost&&""!==e.epost.trim();let r=`\n    <div class="context-menu-header">${escapeHtml(e.navn)}</div>\n    <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-details" data-id="${e.id}">\n      <i class="fas fa-info-circle"></i> Se detaljer\n    </div>\n    <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-navigate" data-lat="${e.lat}" data-lng="${e.lng}">\n      <i class="fas fa-directions"></i> Naviger hit\n    </div>\n    <div class="context-menu-divider"></div>\n    <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-add-route" data-id="${e.id}">\n      <i class="fas fa-route"></i> ${s?"Fjern fra rute":"Legg til i rute"}\n    </div>\n    <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-mark-visited" data-id="${e.id}">\n      <i class="fas fa-check"></i> Marker besøkt\n    </div>`;if(o&&(r+=`\n    <div class="context-menu-divider"></div>\n    <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-email" data-id="${e.id}">\n      <i class="fas fa-envelope"></i> Send e-post\n    </div>`),hasFeature("tripletex_projects")&&!1!==appConfig.integrations?.tripletex?.active){r+=`\n    <div class="context-menu-divider"></div>\n    <div class="context-menu-item context-menu-parent" role="menuitem" tabindex="-1">\n      <span><i class="fas fa-folder-plus"></i> Opprett prosjekt</span>\n      <i class="fas fa-chevron-right context-menu-arrow"></i>\n      <div class="context-menu-submenu" role="menu">\n        ${(getFeatureConfig("tripletex_projects")?.project_categories||[{key:"elkontroll",label:"01 - Elkontroll"},{key:"arskontroll",label:"02 - Årskontroll"},{key:"begge",label:"03 - Begge"}]).map(t=>`\n          <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-create-project" data-id="${e.id}" data-type="${escapeHtml(t.key)}">\n            ${escapeHtml(t.label)}\n          </div>\n        `).join("")}\n      </div>\n    </div>`}if(!1!==appConfig.integrations?.tripletex?.active){const t="tripletex"===e.external_source&&e.external_id;r+=`\n    <div class="context-menu-divider"></div>\n    <div class="context-menu-item" role="menuitem" tabindex="-1" data-action="ctx-push-tripletex" data-id="${e.id}">\n      <i class="fas ${t?"fa-sync":"fa-cloud-upload-alt"}"></i> ${t?"Oppdater i Tripletex":"Opprett i Tripletex"}\n    </div>`}a.innerHTML=r,document.body.appendChild(a);const i=a.getBoundingClientRect(),l=window.innerWidth,d=window.innerHeight;t+i.width>l&&(t=l-i.width-8),n+i.height>d&&(n=d-i.height-8),t<8&&(t=8),n<8&&(n=8),a.style.left=`${t}px`,a.style.top=`${n}px`,activeContextMenu=a,a.addEventListener("click",handleContextMenuClick),requestAnimationFrame(()=>{document.addEventListener("click",closeContextMenu,{once:!0}),document.addEventListener("contextmenu",closeContextMenu,{once:!0})});const c=e=>{if(!activeContextMenu)return void document.removeEventListener("keydown",c);const t=Array.from(activeContextMenu.querySelectorAll(':scope > [role="menuitem"]')),n=t.indexOf(document.activeElement);switch(e.key){case"ArrowDown":e.preventDefault();t[n<t.length-1?n+1:0].focus();break;case"ArrowUp":e.preventDefault();t[n>0?n-1:t.length-1].focus();break;case"Enter":case" ":e.preventDefault(),document.activeElement&&document.activeElement.closest(".marker-context-menu")&&document.activeElement.click();break;case"Escape":return e.preventDefault(),closeContextMenu(),void document.removeEventListener("keydown",c)}};document.addEventListener("keydown",c);const u=a.querySelector('[role="menuitem"]');u&&u.focus()}function closeContextMenu(){activeContextMenu&&(activeContextMenu.remove(),activeContextMenu=null,contextMenuCustomerId=null)}function handleContextMenuClick(e){const t=e.target.closest("[data-action]");if(!t)return;const n=t.dataset.action,a=Number(t.dataset.id);switch(closeContextMenu(),n){case"ctx-details":editCustomer(a);break;case"ctx-navigate":navigateToCustomer(Number(t.dataset.lat),Number(t.dataset.lng));break;case"ctx-add-route":toggleCustomerSelection(a);break;case"ctx-mark-visited":quickMarkVisited(a);break;case"ctx-email":"function"==typeof openEmailDialog?openEmailDialog(a):editCustomer(a);break;case"ctx-create-project":createTripletexProjectFromMenu(a,t.dataset.type);break;case"ctx-push-tripletex":pushCustomerToTripletex(a)}}async function createTripletexProjectFromMenu(e,t){try{showNotification("Oppretter prosjekt i Tripletex...","info");const n=getFeatureConfig("tripletex_projects"),a=(n?.project_categories||[]).find(e=>e.key===t),s=await apiFetch("/api/integrations/tripletex/create-project",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kunde_id:e,category_id:a?.tripletex_category_id||null,description:a?.label||t})}),o=await s.json();if(o.success){showNotification(`Prosjekt ${o.data.projectNumber} opprettet i Tripletex`,"success");const t=customers.find(t=>t.id===e);if(t){const e=t.prosjektnummer?t.prosjektnummer.split(", "):[];e.push(o.data.projectNumber),t.prosjektnummer=e.join(", ")}}else showNotification(o.error||"Kunne ikke opprette prosjekt","error")}catch(e){console.error("Tripletex project creation failed:",e),showNotification("Feil ved opprettelse av prosjekt i Tripletex","error")}}async function pushCustomerToTripletex(e){try{const t=customers.find(t=>t.id===e);showNotification("tripletex"===t?.external_source&&t?.external_id?"Oppdaterer kunde i Tripletex...":"Oppretter kunde i Tripletex...","info");const n=await apiFetch("/api/integrations/tripletex/push-customer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kunde_id:e})}),a=await n.json();a.success?(showNotification(a.message,"success"),t&&"created"===a.data.action&&(t.external_source="tripletex",t.external_id=String(a.data.tripletexId),a.data.customerNumber&&(t.kundenummer=String(a.data.customerNumber)))):showNotification(a.error||"Kunne ikke sende kunde til Tripletex","error")}catch(e){console.error("Tripletex customer push failed:",e),showNotification("Feil ved sending av kunde til Tripletex","error")}}let activeTooltipEl=null;function showMarkerTooltip(e,t,n){hideMarkerTooltip();const a=getControlStatus(e);let s="Ikke spesifisert";e.services&&e.services.length>0?s=e.services.map(e=>e.service_type_name).filter(Boolean).join(", "):e.kategori&&(s=e.kategori);const o=document.createElement("div");o.className="marker-hover-tooltip",o.innerHTML=`\n    <div class="tooltip-header">${escapeHtml(e.navn)}</div>\n    <div class="tooltip-body">\n      <div class="tooltip-row"><i class="fas fa-map-marker-alt"></i> ${escapeHtml(e.adresse||"")}</div>\n      ${e.telefon?`<div class="tooltip-row"><i class="fas fa-phone"></i> ${escapeHtml(e.telefon)}</div>`:""}\n      <div class="tooltip-service"><i class="fas fa-tools"></i> ${escapeHtml(s)}</div>\n      <div class="tooltip-status ${a.class}">${escapeHtml(a.label)}</div>\n    </div>\n  `,document.body.appendChild(o);const r=o.getBoundingClientRect();let i,l;if(n)i=n.clientX+12,l=n.clientY-10;else if(t){const e=t.getBoundingClientRect();i=e.left+e.width/2+12,l=e.top-4}else i=100,l=100;i+r.width>window.innerWidth&&(i=(n?n.clientX:i)-r.width-12),l+r.height>window.innerHeight&&(l=window.innerHeight-r.height-8),i<4&&(i=4),l<4&&(l=4),o.style.left=`${i}px`,o.style.top=`${l}px`,activeTooltipEl=o}function hideMarkerTooltip(){activeTooltipEl&&(activeTooltipEl.remove(),activeTooltipEl=null)}let areaSelectMode=!1,areaSelectRect=null,areaSelectStart=null;function initAreaSelect(){if(!map)return;const e=document.getElementById("sharedMapContainer");if(!e)return;const t=document.getElementById("areaSelectToggle");t&&t.remove();const n=document.createElement("button");n.id="areaSelectToggle",n.className="area-select-toggle-btn",n.title="Velg område",n.innerHTML='<i class="fas fa-expand"></i>',n.addEventListener("click",()=>toggleAreaSelect()),e.appendChild(n),map.on("mousedown",onAreaSelectStart),map.on("mousemove",onAreaSelectMove),map.on("mouseup",onAreaSelectEnd)}function toggleAreaSelect(){areaSelectMode=!areaSelectMode;const e=document.getElementById("areaSelectToggle"),t=document.getElementById("map");areaSelectMode?(e?.classList.add("active"),t.style.cursor="crosshair",map.dragging.disable(),showToast("Dra over kunder for å velge dem","info")):(e?.classList.remove("active"),t.style.cursor="",map.dragging.enable(),areaSelectRect&&(map.removeLayer(areaSelectRect),areaSelectRect=null))}function onAreaSelectStart(e){areaSelectMode&&(areaSelectStart=e.latlng,areaSelectRect&&map.removeLayer(areaSelectRect),areaSelectRect=L.rectangle([e.latlng,e.latlng],{color:"#3b82f6",weight:2,fillOpacity:.15,dashArray:"6, 4"}).addTo(map))}function onAreaSelectMove(e){areaSelectMode&&areaSelectStart&&areaSelectRect&&areaSelectRect.setBounds(L.latLngBounds(areaSelectStart,e.latlng))}function onAreaSelectEnd(e){if(!areaSelectMode||!areaSelectStart||!areaSelectRect)return;const t=areaSelectRect.getBounds();areaSelectStart=null;const n=customers.filter(e=>e.lat&&e.lng&&t.contains(L.latLng(e.lat,e.lng)));if(0===n.length)return map.removeLayer(areaSelectRect),areaSelectRect=null,void showToast("Ingen kunder i valgt område","info");showAreaSelectMenu(n,t.getCenter())}function showAreaSelectMenu(e,t){document.getElementById("areaSelectMenu")?.remove(),weekPlanState.weekStart||initWeekPlanState(new Date);const n=weekPlanState.activeDay,a=n?weekDayLabels[weekDayKeys.indexOf(n)]:"";let s="";n||(s=`\n      <div class="asm-day-picker" id="asmDayPicker" style="display:none;">\n        ${weekDayKeys.map((e,t)=>{const n=weekPlanState.days[e];if(!n)return"";const a=new Date(n.date);return`<button class="asm-day-option" data-wp-day="${e}">${weekDayLabels[t]} ${a.getDate()}.</button>`}).join("")}\n      </div>`);const o=[...new Set(e.map(e=>e.poststed).filter(Boolean))],r=o.length>0?o.slice(0,2).join(", "):"",i=document.createElement("div");i.id="areaSelectMenu",i.className="area-select-menu",i.innerHTML=`\n    <div class="area-select-menu-header">\n      <div class="asm-title">\n        <strong>${e.length} kunder valgt</strong>\n        ${r?`<span class="asm-area">${escapeHtml(r)}</span>`:""}\n      </div>\n      <button class="area-select-close" id="closeAreaMenu">&times;</button>\n    </div>\n    <div class="area-select-menu-actions">\n      \n        <button class="btn btn-small asm-btn asm-btn-weekplan" id="areaAddToWeekPlan">\n          <i class="fas fa-clipboard-list"></i> ${n?`Legg til ${escapeHtml(a)}`:"Legg til ukeplan"}\n        </button>\n        ${s}\n      \n      ${splitViewOpen&&splitViewState.activeDay?`\n        <button class="btn btn-small asm-btn asm-btn-calendar" id="areaAddToSplitDay" style="background:var(--color-primary);color:#fff;">\n          <i class="fas fa-calendar-plus"></i> Legg til ${new Date(splitViewState.activeDay+"T00:00:00").toLocaleDateString("nb-NO",{weekday:"short",day:"numeric",month:"short"})}\n        </button>\n      `:""}\n      <button class="btn btn-small asm-btn asm-btn-route" id="areaAddToRoute">\n        <i class="fas fa-route"></i> Legg til rute\n      </button>\n      <button class="btn btn-small asm-btn asm-btn-calendar" id="areaAddToCalendar">\n        <i class="fas fa-calendar-plus"></i> Legg i kalender\n      </button>\n      <button class="btn btn-small asm-btn asm-btn-check" id="areaMarkVisited">\n        <i class="fas fa-check-circle"></i> Marker besøkt\n      </button>\n    </div>\n  `,document.body.appendChild(i);const l=document.getElementById("areaAddToWeekPlan");if(l){l.addEventListener("click",()=>{if(n)addCustomersToWeekPlan(e),closeAreaSelectMenu(),renderWeeklyPlan();else{const e=document.getElementById("asmDayPicker");e&&(e.style.display="none"===e.style.display?"flex":"none")}});const t=document.getElementById("asmDayPicker");t&&t.querySelectorAll(".asm-day-option").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.wpDay;weekPlanState.activeDay=n,addCustomersToWeekPlan(e),closeAreaSelectMenu(),renderWeeklyPlan()})})}const d=document.getElementById("areaAddToSplitDay");d&&d.addEventListener("click",()=>{const n=splitViewState.activeDay,a=new Date(n+"T00:00:00").toLocaleDateString("nb-NO",{weekday:"long",day:"numeric",month:"short"}),s=i.querySelector(".area-select-menu-actions");s.innerHTML=`\n        <div class="asm-duration-step" style="grid-column:1/-1;">\n          <div style="font-size:12px;font-weight:600;margin-bottom:6px;">Tidsbruk per kunde — ${escapeHtml(a)}</div>\n          <div class="asm-duration-list" style="max-height:240px;overflow-y:auto;">\n            ${e.map((e,t)=>{const n=e.estimert_tid||30;return`\n                <div class="asm-duration-row" style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--color-border);">\n                  <span style="flex:1;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(e.adresse||"")}">${escapeHtml(e.navn)}</span>\n                  <input type="number" class="asm-duration-input" data-index="${t}" value="${n}" min="5" max="480" step="5"\n                    style="width:60px;padding:3px 4px;border-radius:4px;border:1px solid var(--color-border);text-align:center;font-size:12px;background:var(--bg-primary);color:var(--color-text-primary);">\n                  <span style="font-size:11px;color:var(--color-text-secondary);">min</span>\n                </div>`}).join("")}\n          </div>\n          <div style="display:flex;gap:6px;margin-top:8px;">\n            <button class="btn btn-small btn-secondary" id="asmDurationBack" style="flex:1;">\n              <i class="fas fa-arrow-left"></i> Tilbake\n            </button>\n            <button class="btn btn-small btn-primary" id="asmDurationConfirm" style="flex:2;">\n              <i class="fas fa-calendar-plus"></i> Opprett ${e.length} avtaler\n            </button>\n          </div>\n        </div>\n      `,document.getElementById("asmDurationBack").addEventListener("click",()=>{showAreaSelectMenu(e,t)}),document.getElementById("asmDurationConfirm").addEventListener("click",async()=>{const t=document.getElementById("asmDurationConfirm");t.disabled=!0,t.textContent="Oppretter...";const o=s.querySelectorAll(".asm-duration-input");let r=0;for(let t=0;t<e.length;t++){const a=e[t],s=o[t]&&Number.parseInt(o[t].value)||30;try{const e=a.kategori||"Kontroll";(await apiFetch("/api/avtaler",{method:"POST",body:JSON.stringify({kunde_id:a.id,dato:n,type:e,beskrivelse:e,varighet:s,opprettet_av:localStorage.getItem("userName")||"admin"})})).ok&&r++}catch(e){console.error("Error creating avtale from area select:",e)}}r>0&&showToast(`${r} avtale${1!==r?"r":""} opprettet for ${a}`,"success"),closeAreaSelectMenu(),await loadAvtaler(),renderCalendar(),splitViewOpen&&renderSplitWeekContent()})}),document.getElementById("areaAddToRoute").addEventListener("click",()=>{e.forEach(e=>selectedCustomers.add(e.id)),updateSelectionUI(),closeAreaSelectMenu(),showToast(`${e.length} kunder lagt til rute`,"success")}),document.getElementById("areaAddToCalendar").addEventListener("click",()=>{i.querySelector(".area-select-menu-actions").innerHTML=`\n      <div style="padding:4px 0;">\n        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Dato</label>\n        <input type="date" id="areaCalDate" value="${(new Date).toISOString().split("T")[0]}"\n          style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;box-sizing:border-box;">\n      </div>\n      <div style="padding:4px 0;">\n        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Type</label>\n        <select id="areaCalType" style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;box-sizing:border-box;">\n          ${serviceTypeRegistry?serviceTypeRegistry.renderCategoryOptions("Kontroll"):"<option>Kontroll</option>"}\n        </select>\n      </div>\n      <div style="display:flex;gap:8px;padding-top:4px;">\n        <button class="btn btn-small btn-secondary" id="areaCalBack" style="flex:1;">\n          <i class="fas fa-arrow-left"></i> Tilbake\n        </button>\n        <button class="btn btn-small btn-primary" id="areaCalConfirm" style="flex:2;">\n          Opprett ${e.length} avtaler\n        </button>\n      </div>\n    `,document.getElementById("areaCalBack").addEventListener("click",()=>{showAreaSelectMenu(e,t)}),document.getElementById("areaCalConfirm").addEventListener("click",async()=>{const t=document.getElementById("areaCalDate").value,n=document.getElementById("areaCalType").value||"Kontroll";if(!t)return void showToast("Velg en dato","error");const a=document.getElementById("areaCalConfirm");a.disabled=!0,a.textContent="Oppretter...";let s=0,o="";for(const a of e)try{const e=a.kategori||n||void 0,r=await apiFetch("/api/avtaler",{method:"POST",body:JSON.stringify({kunde_id:a.id,dato:t,type:e,beskrivelse:e||"Kontroll",opprettet_av:localStorage.getItem("userName")||"admin"})});if(r.ok)s++;else{const e=await r.json().catch(()=>({}));o=e.error?.message||e.error||r.statusText,console.error(`Avtale-feil for ${a.navn} (${r.status}):`,e)}}catch(e){console.error("Feil ved opprettelse av avtale:",e),o=e.message}s>0?showToast(`${s} avtaler opprettet for ${t}`,"success"):showToast(`Kunne ikke opprette avtaler: ${o}`,"error"),closeAreaSelectMenu(),await loadAvtaler(),renderCalendar()})}),document.getElementById("areaMarkVisited").addEventListener("click",()=>{const t=e.map(e=>e.id);closeAreaSelectMenu(),bulkMarkVisited(t)}),document.getElementById("closeAreaMenu").addEventListener("click",closeAreaSelectMenu)}function closeAreaSelectMenu(){document.getElementById("areaSelectMenu")?.remove(),areaSelectRect&&(map.removeLayer(areaSelectRect),areaSelectRect=null),areaSelectMode&&toggleAreaSelect()}function renderSubcategoryDropdowns(e=null){const t=document.getElementById("subcategorySection"),n=document.getElementById("subcategoryDropdowns");if(!t||!n)return;const a=allSubcategoryGroups||[];if(0===a.length)return void(n.innerHTML="");const s=e?.id,o=s&&kundeSubcatMap[s]||[];let r="";a.forEach(e=>{if(!e.subcategories||0===e.subcategories.length)return;const t=o.find(t=>t.group_id===e.id),n=t?.subcategory_id||"";r+=`\n      <div class="form-group">\n        <label for="subcat_group_${e.id}">${escapeHtml(e.navn)}</label>\n        <select id="subcat_group_${e.id}" data-group-id="${e.id}" class="subcat-dropdown">\n          <option value="">Ikke valgt</option>\n          ${e.subcategories.map(e=>`<option value="${e.id}" ${e.id===n?"selected":""}>${escapeHtml(e.navn)}</option>`).join("")}\n        </select>\n      </div>\n    `}),n.innerHTML=r}function collectSubcategoryAssignments(){const e=[];return document.querySelectorAll(".subcat-dropdown").forEach(t=>{const n=parseInt(t.dataset.groupId,10),a=parseInt(t.value,10);n&&a&&e.push({group_id:n,subcategory_id:a})}),e}function populateDynamicDropdowns(e=null){const t=document.getElementById("kategoriCheckboxes");t&&(t.innerHTML=serviceTypeRegistry.renderCategoryCheckboxes(e?.kategori||""),t.querySelectorAll('input[name="kategori"]').forEach(t=>{t.addEventListener("change",()=>{updateControlSectionsVisibility(serviceTypeRegistry.getSelectedCategories()),renderSubcategoryDropdowns(e)})})),renderSubcategoryDropdowns(e);const n=document.getElementById("el_kontroll_intervall");n&&(n.innerHTML=serviceTypeRegistry.renderIntervalOptions(e?.el_kontroll_intervall||36));const a=document.getElementById("brann_kontroll_intervall");a&&(a.innerHTML=serviceTypeRegistry.renderIntervalOptions(e?.brann_kontroll_intervall||12))}function editCustomer(e){const t=customers.find(t=>t.id===e);if(!t)return;_editingCustomer=t,claimCustomer(e),resetAddressAutocomplete(),populateDynamicDropdowns(t),document.getElementById("modalTitle").textContent="Rediger kunde";const n=document.getElementById("presenceWarningBanner");n&&n.remove();const a=presenceClaims.get(e);if(a&&a.userId!==myUserId){const e=document.createElement("div");e.id="presenceWarningBanner",e.style.cssText=`background:${getPresenceColor(a.userId)}18;border-left:3px solid ${getPresenceColor(a.userId)};padding:8px 12px;margin-bottom:12px;border-radius:4px;font-size:13px;color:#333;`,e.innerHTML=`<strong>${escapeHtml(a.initials)}</strong> ${escapeHtml(a.userName)} jobber med denne kunden`;const t=document.getElementById("modalTitle");t.parentNode.insertBefore(e,t.nextSibling)}document.getElementById("customerId").value=t.id,document.getElementById("navn").value=t.navn||"",document.getElementById("adresse").value=t.adresse||"",document.getElementById("postnummer").value=t.postnummer||"",document.getElementById("poststed").value=t.poststed||"";const s=t.org_nummer||t.notater&&t.notater.match(/\[ORGNR:(\d{9})\]/)?.[1]||"";document.getElementById("org_nummer").value=s,document.getElementById("estimert_tid").value=t.estimert_tid||"",document.getElementById("telefon").value=t.telefon||"",document.getElementById("epost").value=t.epost||"";const o=e=>"month_year"===appConfig.datoModus&&e&&e.length>=7?e.substring(0,7):e||"";document.getElementById("siste_kontroll").value=o(t.siste_kontroll),document.getElementById("neste_kontroll").value=o(t.neste_kontroll),document.getElementById("kontroll_intervall").value=t.kontroll_intervall_mnd||12,document.getElementById("notater").value=(t.notater||"").replace(/\[ORGNR:\d{9}\]\s*/g,"").replace(/^\s*\|\s*/,"").trim(),document.getElementById("lat").value=t.lat||"",document.getElementById("lng").value=t.lng||"",updateGeocodeQualityBadge(t.geocode_quality||(t.lat?"exact":null)),document.getElementById("siste_el_kontroll").value=o(t.siste_el_kontroll),document.getElementById("neste_el_kontroll").value=o(t.neste_el_kontroll),document.getElementById("siste_brann_kontroll").value=o(t.siste_brann_kontroll),document.getElementById("neste_brann_kontroll").value=o(t.neste_brann_kontroll),updateControlSectionsVisibility(t.kategori),loadCustomerEmailSettings(t.id),populateCustomFields(t.custom_data),document.getElementById("kontaktloggSection").style.display="block",loadKontaktlogg(t.id),loadKundeSubcategories(t.id),loadKontaktpersoner(t.id),document.getElementById("deleteCustomerBtn").classList.remove("hidden"),openModal(customerModal),highlightMissingFields(t);const r=document.getElementById("integrationActionsSection"),i=document.getElementById("pushToTripletexBtn"),l=document.getElementById("createEkkReportBtn");let d=!1;if(i&&!1!==appConfig.integrations?.tripletex?.active){const e="tripletex"===t.external_source&&t.external_id;document.getElementById("tripletexBtnLabel").textContent=e?"Oppdater i Tripletex":"Opprett i Tripletex",i.classList.remove("hidden"),d=!0}else i&&i.classList.add("hidden");l&&hasFeature("ekk_integration")?(l.classList.remove("hidden"),d=!0):l&&l.classList.add("hidden"),r&&r.classList.toggle("hidden",!d)}function highlightMissingFields(e){document.querySelectorAll(".missing-field").forEach(e=>{e.classList.remove("missing-field"),e.removeAttribute("aria-invalid")});[{id:"telefon",value:e.telefon},{id:"epost",value:e.epost},{id:"neste_el_kontroll",value:e.neste_el_kontroll,condition:e.kategori?.includes("El-Kontroll")},{id:"neste_brann_kontroll",value:e.neste_brann_kontroll,condition:e.kategori?.includes("Brann")}].forEach(e=>{if(!1===e.condition)return;const t=document.getElementById(e.id);!t||e.value&&""!==e.value.trim()||(t.classList.add("missing-field"),t.setAttribute("aria-invalid","true"))})}async function loadOrganizationFields(){try{const e=await apiFetch("/api/fields");e.ok&&(organizationFields=await e.json(),renderCustomFieldsInForm(),renderDynamicFieldFilters(),Logger.log("Loaded organization fields:",organizationFields.length))}catch(e){Logger.warn("Could not load organization fields:",e),organizationFields=[]}}async function loadOrganizationCategories(){try{const e=await apiFetch("/api/service-types");if(e.ok){const t=await e.json();organizationCategories=t.data||t,appConfig&&(appConfig.serviceTypes=organizationCategories.map(e=>({id:e.id,name:e.name,slug:e.slug,icon:e.icon,color:e.color,defaultInterval:e.default_interval_months})),serviceTypeRegistry.loadFromConfig(appConfig)),renderFilterPanelCategories(),renderSubcategoryFilter(),updateMapLegend(),Logger.log("Loaded organization categories:",organizationCategories.length)}}catch(e){Logger.warn("Could not load organization categories:",e),organizationCategories=[]}}function renderPopupCustomFields(e){const t=organizationFields.filter(e=>e.is_visible&&0!==e.is_visible);if(0===t.length)return"";let n=e.custom_data;if("string"==typeof n)try{n=JSON.parse(n)}catch{n={}}n=n||{};let a="";for(const e of t){const t=n[e.field_name];if(null!=t&&""!==t){let n=t;if("date"===e.field_type)try{n=formatDate(t)}catch{n=t}else if("select"===e.field_type&&e.options){const a=e.options.find(e=>e.value===t);n=a?.display_name||t}a+=`<p><strong>${escapeHtml(e.display_name)}:</strong> ${escapeHtml(String(n))}</p>`}}return a}function renderCustomFieldsInForm(){const e=document.getElementById("customFieldsSection"),t=document.getElementById("customFieldsContainer");if(!e||!t)return;const n=organizationFields.filter(e=>e.is_visible);0!==n.length?(e.classList.remove("hidden"),t.innerHTML=n.map(e=>{const t=`custom_${e.field_name}`,n=e.is_required?"required":"",a=e.is_required?" *":"";let s="";switch(e.field_type){case"select":s=`\n          <select id="${t}" ${n}>\n            <option value="">-- Velg --</option>\n            ${(e.options||[]).map(e=>`<option value="${escapeHtml(e.value)}">${escapeHtml(e.display_name||e.value)}</option>`).join("")}\n          </select>\n        `;break;case"date":s=`<input type="date" id="${t}" ${n}>`;break;case"number":s=`<input type="number" id="${t}" ${n}>`;break;default:s=`<input type="text" id="${t}" ${n}>`}return`\n      <div class="form-group">\n        <label for="${t}">${escapeHtml(e.display_name)}${a}</label>\n        ${s}\n      </div>\n    `}).join("")):e.classList.add("hidden")}function populateCustomFields(e){if(!e)return;let t=e;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){t={}}for(const e of organizationFields){const n=document.getElementById(`custom_${e.field_name}`);n&&void 0!==t[e.field_name]&&(n.value=t[e.field_name])}}function clearCustomFields(){for(const e of organizationFields){const t=document.getElementById(`custom_${e.field_name}`);t&&(t.value="")}}function collectCustomFieldValues(){const e={};for(const t of organizationFields){const n=document.getElementById(`custom_${t.field_name}`);n&&n.value&&(e[t.field_name]=n.value)}return e}async function addCustomer(){_editingCustomer=null,populateDynamicDropdowns(null),resetAddressAutocomplete(),document.getElementById("modalTitle").textContent="Ny kunde",customerForm.reset(),document.getElementById("customerId").value="",document.getElementById("kontroll_intervall").value=12,document.getElementById("lat").value="",document.getElementById("lng").value="",updateGeocodeQualityBadge(null),clearCustomFields(),document.getElementById("siste_el_kontroll").value="",document.getElementById("neste_el_kontroll").value="",document.getElementById("el_kontroll_intervall").value=36,document.getElementById("siste_brann_kontroll").value="",document.getElementById("neste_brann_kontroll").value="",document.getElementById("brann_kontroll_intervall").value=12;const e=document.getElementById("dynamicServiceSections");e&&(e.innerHTML="");updateControlSectionsVisibility(serviceTypeRegistry.getSelectedCategories()||(isMvpMode()?"":serviceTypeRegistry.getDefaultServiceType().name));const t=document.getElementById("emailAktiv"),n=document.getElementById("forsteVarsel"),a=document.getElementById("paaminnelseEtter"),s=document.getElementById("emailOptions");t&&(t.checked=!0),n&&(n.value=30),a&&(a.value=7),s&&s.classList.remove("hidden"),document.getElementById("kontaktloggSection").style.display="none",document.getElementById("kontaktloggList").innerHTML="",document.getElementById("kontaktpersonerSection").style.display="none",document.getElementById("kontaktpersonerList").innerHTML="",renderSubcategoryDropdowns(null),document.getElementById("deleteCustomerBtn").classList.add("hidden"),openModal(customerModal)}let _editingCustomer=null;function renderDynamicServiceSections(e=null){const t=document.getElementById("dynamicServiceSections");if(!t)return;const n=serviceTypeRegistry.getSelectedCategories(),a=n?n.split(" + ").map(e=>e.trim()).filter(Boolean):[];if(0===a.length)return void(t.innerHTML="");const s={};t.querySelectorAll(".service-section").forEach(e=>{const t=e.dataset.serviceSlug;if(!t)return;const n=document.getElementById(`service_${t}_siste`),a=document.getElementById(`service_${t}_neste`),o=document.getElementById(`service_${t}_intervall`),r=document.getElementById(`service_${t}_subtype`),i=document.getElementById(`service_${t}_equipment`);s[t]={siste:n?.value||"",neste:a?.value||"",intervall:o?.value||"",subtype:r?.value||"",equipment:i?.value||""}});const o=e||_editingCustomer||{};t.innerHTML=serviceTypeRegistry.renderServiceSections(o,a),Object.entries(s).forEach(([e,t])=>{const n=document.getElementById(`service_${e}_siste`),a=document.getElementById(`service_${e}_neste`),s=document.getElementById(`service_${e}_intervall`),o=document.getElementById(`service_${e}_subtype`),r=document.getElementById(`service_${e}_equipment`);n&&t.siste&&(n.value=t.siste),a&&t.neste&&(a.value=t.neste),s&&t.intervall&&(s.value=t.intervall),o&&t.subtype&&(o.value=t.subtype),r&&t.equipment&&(r.value=t.equipment)})}function updateControlSectionsVisibility(e){const t=document.getElementById("elKontrollSection"),n=document.getElementById("brannvarslingSection"),a=document.getElementById("mvpKontrollSection"),s=document.getElementById("driftskategori")?.closest(".form-group");t&&(t.style.display="none"),n&&(n.style.display="none"),a&&(a.style.display="none"),s&&isMvpMode()&&(s.style.display="none"),renderDynamicServiceSections()}async function geocodeAddressAuto(e,t,n){const a=`${e}, ${t} ${n}, Norway`;try{const e=`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(a)}&fuzzy=true&treffPerSide=1`,t=await fetch(e),n=await t.json();if(n.adresser&&n.adresser.length>0){const e=n.adresser[0];if(e.representasjonspunkt)return{lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon}}}catch(e){Logger.log("Kartverket geocode failed:",e)}try{const e=`${t} ${n}`,a=`https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(e)}&fuzzy=true&treffPerSide=1`,s=await fetch(a),o=await s.json();if(o.adresser&&o.adresser.length>0){const e=o.adresser[0];if(e.representasjonspunkt)return{lat:e.representasjonspunkt.lat,lng:e.representasjonspunkt.lon}}}catch(e){Logger.log("Kartverket poststed geocode failed:",e)}try{const e=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`,t=await fetch(e),n=await t.json();if(n&&n.length>0)return{lat:Number.parseFloat(n[0].lat),lng:Number.parseFloat(n[0].lon)}}catch(e){Logger.log("Nominatim geocode failed:",e)}return null}async function saveCustomer(e){e.preventDefault();const t=document.getElementById("customerId").value;let n=Number.parseFloat(document.getElementById("lat").value)||null,a=Number.parseFloat(document.getElementById("lng").value)||null;const s=document.getElementById("adresse").value,o=document.getElementById("postnummer").value,r=document.getElementById("poststed").value;if(!n||!a){showNotification("Geokoder adresse...");const e=await geocodeAddressAuto(s,o,r);e&&(n=e.lat,a=e.lng,document.getElementById("lat").value=n,document.getElementById("lng").value=a)}let i=serviceTypeRegistry.getSelectedCategories()||null;const l=(i||"").split(" + ").map(e=>e.trim()).filter(Boolean),d=serviceTypeRegistry.getAll(),c=l.map(e=>{const t=d.find(t=>t.name===e);return t?.slug}).filter(Boolean),u=c.includes("el-kontroll"),m=c.includes("brannvarsling"),p={navn:document.getElementById("navn").value,adresse:s,postnummer:o,poststed:r,telefon:document.getElementById("telefon").value,epost:document.getElementById("epost").value,org_nummer:document.getElementById("org_nummer").value||null,estimert_tid:Number.parseInt(document.getElementById("estimert_tid").value)||null,lat:n,lng:a,siste_kontroll:normalizeDateValue(document.getElementById("siste_kontroll").value)||null,neste_kontroll:normalizeDateValue(document.getElementById("neste_kontroll").value)||null,kontroll_intervall_mnd:Number.parseInt(document.getElementById("kontroll_intervall").value)||12,kategori:i,notater:(document.getElementById("notater").value||"").replace(/\[ORGNR:\d{9}\]\s*/g,"").trim(),siste_el_kontroll:u&&normalizeDateValue(document.getElementById("siste_el_kontroll").value)||null,neste_el_kontroll:u&&normalizeDateValue(document.getElementById("neste_el_kontroll").value)||null,el_kontroll_intervall:u?Number.parseInt(document.getElementById("el_kontroll_intervall").value)||36:null,siste_brann_kontroll:m&&normalizeDateValue(document.getElementById("siste_brann_kontroll").value)||null,neste_brann_kontroll:m&&normalizeDateValue(document.getElementById("neste_brann_kontroll").value)||null,brann_kontroll_intervall:m?Number.parseInt(document.getElementById("brann_kontroll_intervall").value)||12:null,services:serviceTypeRegistry.parseServiceFormData(),custom_data:JSON.stringify(collectCustomFieldValues())};try{const e=t?`/api/kunder/${t}`:"/api/kunder",n=t?"PUT":"POST";Logger.log("Saving customer:",{url:e,method:n,data:p});const a=await apiFetch(e,{method:n,body:JSON.stringify(p)}),s=await a.json();if(Logger.log("Server response:",a.status,s),!a.ok){const e=s.error?.details?.errors,t=Array.isArray(e)?e.map(e=>e.message).join(", "):s.error?.message||("string"==typeof s.error?s.error:null)||"Ukjent feil";return void showMessage("Kunne ikke lagre: "+t,"error")}const o=t||s.id;if(o){const e=collectSubcategoryAssignments();try{await apiFetch(`/api/subcategories/kunde/${o}`,{method:"PUT",body:JSON.stringify({assignments:e})})}catch(e){console.error("Error saving subcategory assignments:",e)}}o&&await saveCustomerEmailSettings(o),releaseCustomer(currentClaimedKundeId),customerModal.classList.add("hidden"),currentFilter="alle",showOnlyWarnings=!1;const r=document.getElementById("omradeSelect");r&&(r.value="alle"),await loadCustomers(),await loadOmrader(),showNotification("Kunde lagret!")}catch(e){console.error("Lagring feilet:",e),showMessage("Kunne ikke lagre kunden: "+e.message,"error")}}async function deleteCustomer(){const e=document.getElementById("customerId").value;if(!e)return;const t=document.getElementById("navn").value||"denne kunden";if(await showConfirm(`Er du sikker på at du vil slette "${t}"? Dette kan ikke angres.`,"Slette kunde"))try{await apiFetch(`/api/kunder/${e}`,{method:"DELETE"}),releaseCustomer(currentClaimedKundeId),customerModal.classList.add("hidden"),selectedCustomers.delete(Number.parseInt(e)),await loadCustomers(),await loadOmrader(),updateSelectionUI()}catch(e){console.error("Sletting feilet:",e),showMessage("Kunne ikke slette kunden. Prøv igjen senere.","error")}}async function handleGeocode(){const e=document.getElementById("adresse").value,t=document.getElementById("postnummer").value,n=document.getElementById("poststed").value;if(!e)return void showMessage("Skriv inn en adresse først","warning");const a=document.getElementById("geocodeBtn");a.classList.add("loading"),a.disabled=!0;const s=await geocodeAddress(e,t,n);a.classList.remove("loading"),a.disabled=!1,s?(document.getElementById("lat").value=s.lat,document.getElementById("lng").value=s.lng,updateGeocodeQualityBadge("exact"),showNotification("Koordinater funnet!","success")):showMessage("Kunne ikke finne koordinater for adressen. Sjekk at adressen er riktig.","warning")}let isPickingCoordinates=!1,pickingIndicator=null;function enableCoordinatePicking(){if(isPickingCoordinates)return void disableCoordinatePicking();isPickingCoordinates=!0;document.getElementById("customerModal").classList.add("hidden");document.getElementById("sharedMapContainer").classList.add("map-picking-mode"),pickingIndicator=document.createElement("div"),pickingIndicator.className="picking-mode-indicator",pickingIndicator.innerHTML='<i class="fas fa-crosshairs"></i> Klikk på kartet for å velge posisjon',document.body.appendChild(pickingIndicator),map.once("click",handleMapPick),document.addEventListener("keydown",handlePickingEscape)}function handleMapPick(e){const t=e.latlng.lat,n=e.latlng.lng;document.getElementById("lat").value=t.toFixed(6),document.getElementById("lng").value=n.toFixed(6),updateGeocodeQualityBadge("manual"),showNotification(`Koordinater valgt: ${t.toFixed(4)}, ${n.toFixed(4)}`,"success"),disableCoordinatePicking();openModal(document.getElementById("customerModal"))}function handlePickingEscape(e){if("Escape"===e.key&&isPickingCoordinates){disableCoordinatePicking();openModal(document.getElementById("customerModal")),showNotification("Avbrutt","info")}}function disableCoordinatePicking(){isPickingCoordinates=!1;document.getElementById("sharedMapContainer").classList.remove("map-picking-mode"),pickingIndicator&&(pickingIndicator.remove(),pickingIndicator=null),map.off("click",handleMapPick),document.removeEventListener("keydown",handlePickingEscape)}function updateGeocodeQualityBadge(e){const t=document.getElementById("geocodeQualityBadge"),n=document.getElementById("geocodeWarning");if(t)switch(t.className="geocode-quality-badge",e){case"exact":t.textContent="Eksakt",t.classList.add("quality-exact"),n&&(n.style.display="none");break;case"street":t.textContent="Gate-nivå",t.classList.add("quality-street"),n&&(n.style.display="none");break;case"area":t.textContent="Område-nivå",t.classList.add("quality-area"),n&&(n.style.display="flex");break;case"manual":t.textContent="Manuelt valgt",t.classList.add("quality-manual"),n&&(n.style.display="none");break;default:t.textContent="",n&&(n.style.display="none")}}let map,customerAdminKategori="alle",customerAdminSearch="";function renderCustomerAdmin(){const e=document.getElementById("customerAdminList"),t=document.getElementById("customerCountDisplay");if(!e)return;e.dataset.delegationSetup||(e.dataset.delegationSetup="true",e.addEventListener("click",e=>{const t=e.target.closest(".btn-map-focus");if(t){e.stopPropagation();return void focusOnCustomer(Number.parseInt(t.dataset.customerId))}const n=e.target.closest(".customer-admin-item");if(!n)return;editCustomer(Number.parseInt(n.dataset.id))}));let n=[...customers];if("alle"!==customerAdminKategori){const e=n.length;n=n.filter(e=>serviceTypeRegistry.matchesCategory(e,customerAdminKategori)),Logger.log(`Filter: "${customerAdminKategori}" - ${e} -> ${n.length} kunder`)}if(customerAdminSearch){const e=customerAdminSearch.toLowerCase();n=n.filter(t=>t.navn.toLowerCase().includes(e)||t.adresse&&t.adresse.toLowerCase().includes(e)||t.poststed&&t.poststed.toLowerCase().includes(e))}sortByNavn(n),t&&(t.textContent=`${n.length} av ${customers.length} kunder`),0!==n.length?e.innerHTML=n.map(e=>{const t=e.lat&&e.lng;let n="";const a=new Date;a.setHours(0,0,0,0);if(serviceTypeRegistry.getAll().forEach(t=>{const s=(e.services||[]).find(e=>e.service_type_slug===t.slug||e.service_type_id===t.id);let o=s?.neste_kontroll;if(o||"el-kontroll"!==t.slug||(o=e.neste_el_kontroll),o||"brannvarsling"!==t.slug||(o=e.neste_brann_kontroll),o){const e=new Date(o),s=Math.ceil((e-a)/864e5),r=s<0?"overdue":s<=30?"warning":"ok",i=t.name.length>10?t.name.substring(0,8)+"..":t.name;n+=`<span class="control-badge ${r}">${escapeHtml(i)}: ${escapeHtml(formatDateShort(o))}</span>`}}),!n&&e.neste_kontroll){const t=new Date(e.neste_kontroll),s=Math.ceil((t-a)/864e5);n=`<span class="control-badge ${s<0?"overdue":s<=30?"warning":"ok"}">${escapeHtml(formatDateShort(e.neste_kontroll))}</span>`}let s="";const o=kundeSubcatMap[e.id]||[];if(o.length>0)for(const e of o)for(const t of allSubcategoryGroups){if(t.id!==e.group_id)continue;const n=(t.subcategories||[]).find(t=>t.id===e.subcategory_id);n&&(s+=`<span class="service-badge">${escapeHtml(n.navn)}</span>`)}return`\n      <div class="customer-admin-item ${t?"":"no-coords"}" data-id="${e.id}">\n        <div class="customer-info">\n          <span class="customer-name">${escapeHtml(e.navn)}</span>\n          <span class="customer-location">${escapeHtml(e.poststed||"")}</span>\n          ${s}\n          ${n}\n        </div>\n        ${t?`<button class="btn-map-focus" data-customer-id="${e.id}" title="Vis på kart"><i class="fas fa-map-marker-alt"></i></button>`:""}\n      </div>\n    `}).join(""):e.innerHTML='<div style="padding: 20px; text-align: center; color: var(--color-text-muted);">Ingen kunder funnet</div>'}async function deleteCustomerAdmin(e){const t=customers.find(t=>t.id===e);if(!t)return;if(await showConfirm(`Er du sikker på at du vil slette "${t.navn}"? Dette kan ikke angres.`,"Slette kunde"))try{(await apiFetch(`/api/kunder/${e}`,{method:"DELETE"})).ok&&(await loadCustomers(),await loadOmrader(),showNotification("Kunde slettet"))}catch(e){console.error("Feil ved sletting:",e),showMessage("Kunne ikke slette kunden. Prøv igjen senere.","error")}}function getProximityRadius(){return Number(localStorage.getItem("proximity_radiusKm"))||15}function clusterCustomersByProximity(e){const t=getProximityRadius(),n=e.filter(e=>Number.isFinite(e.lat)&&Number.isFinite(e.lng)),a=e.filter(e=>!Number.isFinite(e.lat)||!Number.isFinite(e.lng));if(0===n.length)return{clusters:[],noise:a,summary:{totalCustomers:a.length,clusterCount:0,noiseCount:a.length}};let s;try{s=SmartRouteEngine.dbscanClustering(n,t,2)}catch(e){console.error("DBSCAN clustering failed, falling back to poststed grouping:",e),s=null}if(!s||!Array.isArray(s)){const t={};n.forEach(e=>{const n=e.poststed||"Ukjent";t[n]||(t[n]=[]),t[n].push(e)});const s=Object.entries(t).map(([e,t])=>({customers:t,centroid:SmartRouteEngine.getCentroid(t),radiusKm:0,areaName:e}));return s.sort((e,t)=>t.customers.length-e.customers.length),{clusters:s,noise:a,summary:{totalCustomers:e.length,clusterCount:s.length,noiseCount:a.length}}}const o=new Set;s.forEach(e=>{e.forEach(e=>o.add(e))});const r=[...a,...n.filter(e=>!o.has(e))];if(0===s.length&&n.length>0){const t=SmartRouteEngine.getCentroid(n),s={};n.forEach(e=>{s[e.poststed||"Ukjent"]=(s[e.poststed||"Ukjent"]||0)+1});return{clusters:[{customers:n,centroid:t,radiusKm:0,areaName:Object.entries(s).sort((e,t)=>t[1]-e[1])[0][0]}],noise:a,summary:{totalCustomers:e.length,clusterCount:1,noiseCount:a.length}}}const i=s.map(e=>{const t=SmartRouteEngine.getCentroid(e);let n=0;e.forEach(e=>{const a=SmartRouteEngine.haversineDistance(t.lat,t.lng,e.lat,e.lng);a>n&&(n=a)});const a={};e.forEach(e=>{const t=e.poststed||"Ukjent";a[t]=(a[t]||0)+1});const s=Object.entries(a).sort((e,t)=>t[1]-e[1]);let o;return o=1===s.length?s[0][0]:2===s.length?`${s[0][0]} / ${s[1][0]}`:`${s[0][0]}-området (${s.length} steder)`,{customers:e,centroid:t,radiusKm:n,areaName:o}});return i.sort((e,t)=>t.customers.length-e.customers.length),{clusters:i,noise:r,summary:{totalCustomers:e.length,clusterCount:i.length,noiseCount:r.length}}}window.deleteCustomerAdmin=deleteCustomerAdmin;let markers={},markerClusterGroup=null,selectedCustomers=new Set,customers=[],routeLayer=null,routeMarkers=[],avtaler=[],omrader=[],currentFilter="alle",showOnlyWarnings=!1,selectedCategory="all",selectedSubcategories={},kundeSubcatMap={},allSubcategoryGroups=[],currentCalendarMonth=(new Date).getMonth(),currentCalendarYear=(new Date).getFullYear(),calendarViewMode="month",currentWeekStart=null,filterAbortController=null,organizationFields=[],organizationCategories=[],dynamicFieldFilters={},teamMembersData=[],currentView="login",appInitialized=!1,currentTheme=localStorage.getItem("theme")||"dark",appConfig={},authToken=null,subscriptionInfo=null,accessTokenExpiresAt=null;function openModal(e){if(e&&(e.classList.remove("hidden"),void 0!==FocusTrap)){const t=e.querySelector(".modal-content")||e;FocusTrap.activate(t)}}function closeModal(e){if(e&&(e.classList.add("hidden"),void 0!==FocusTrap)){const t=e.querySelector(".modal-content")||e;FocusTrap.deactivate(t)}}const tabCleanupFunctions={calendar:null,overdue:null,warnings:null,planner:null,customers:null,statistikk:null,missingdata:null,admin:null};function runTabCleanup(e){e&&tabCleanupFunctions[e]&&(tabCleanupFunctions[e](),tabCleanupFunctions[e]=null)}async function initializeApp(){Logger.log("initializeApp() starting..."),initDOMElements(),initMap(),Logger.log("initializeApp() after initMap, markerClusterGroup:",!!markerClusterGroup);try{await Promise.all([loadOrganizationCategories(),loadOrganizationFields()])}catch(e){console.error("Error loading org config:",e)}Promise.all([loadCustomers(),loadOmrader()]).then(()=>{Logger.log("initializeApp() all data loaded")}).catch(e=>{console.error("Error loading initial data:",e)}),initWebSocket(),setupEventListeners(),initMiscEventListeners(),updateMapLegend(),applyMvpModeUI(),initTodaysWork(),initChat(),initChatEventListeners(),Logger.log("initializeApp() complete")}function setupEventListeners(){checkForNewPatchNotes(),document.getElementById("patchNotesLink")?.addEventListener("click",()=>{loadAndShowPatchNotes(0)}),document.getElementById("logoutBtnMain")?.addEventListener("click",handleLogout),document.getElementById("nightmodeBtn")?.addEventListener("click",toggleNightMode),document.getElementById("themeToggleBtn")?.addEventListener("click",toggleTheme),document.querySelectorAll(".dashboard-actions .action-card").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.action;"showOverdueTab"===t?switchToTab("overdue"):"showRoutesTab"===t?switchToTab("routes"):"showCalendarTab"===t&&switchToTab("calendar")})}),searchInput?.addEventListener("input",debounce(()=>filterCustomers(),200)),addCustomerBtn?.addEventListener("click",addCustomer),planRouteBtn?.addEventListener("click",planRoute),clearSelectionBtn?.addEventListener("click",clearSelection),document.getElementById("mobileRouteFabBtn")?.addEventListener("click",planRoute),customerForm?.addEventListener("submit",saveCustomer),document.getElementById("cancelBtn")?.addEventListener("click",()=>{releaseCustomer(currentClaimedKundeId),closeModal(customerModal)}),document.getElementById("deleteCustomerBtn")?.addEventListener("click",deleteCustomer),document.getElementById("geocodeBtn")?.addEventListener("click",handleGeocode),document.getElementById("pickFromMapBtn")?.addEventListener("click",enableCoordinatePicking),setupAddressAutocomplete(),document.getElementById("saveApiKey")?.addEventListener("click",saveApiKey),document.getElementById("selectWarningsBtn")?.addEventListener("click",selectCustomersNeedingControl),document.getElementById("addCustomerBtnTab")?.addEventListener("click",addCustomer),document.getElementById("importCustomersBtn")?.addEventListener("click",showImportModal);const e=document.getElementById("exportCustomersBtn"),t=document.getElementById("exportDropdown");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("hidden")}),t.querySelectorAll(".export-option").forEach(e=>{e.addEventListener("click",async()=>{const n=e.dataset.format;t.classList.add("hidden");try{const e={},t=getCsrfToken();t&&(e["X-CSRF-Token"]=t);const a=await fetch(`/api/export/kunder?format=${n}`,{headers:e,credentials:"include"});if(!a.ok)throw new Error("Eksport feilet");const s=await a.blob(),o=(a.headers.get("Content-Disposition")||"").match(/filename="?([^"]+)"?/),r=o?o[1]:`kunder.${n}`,i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=r,i.click(),URL.revokeObjectURL(i.href),showNotification(`Eksportert ${n.toUpperCase()} med suksess`,"success")}catch(e){showNotification("Eksport feilet: "+e.message,"error")}})}),document.addEventListener("click",()=>t.classList.add("hidden"))),document.getElementById("pushToTripletexBtn")?.addEventListener("click",()=>{const e=Number(document.getElementById("customerId").value);e&&pushCustomerToTripletex(e)}),document.getElementById("createEkkReportBtn")?.addEventListener("click",async()=>{const e=Number(document.getElementById("customerId").value);if(e)try{const t=await apiFetch("/api/ekk/reports",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kunde_id:e,report_type:"elkontroll"})}),n=await t.json();n.success?showNotification("EKK-rapport opprettet som utkast","success"):showNotification(n.error?.message||"Kunne ikke opprette rapport","error")}catch(e){showNotification("Feil ved oppretting av EKK-rapport","error")}}),document.getElementById("closeImportModal")?.addEventListener("click",closeImportModal),document.getElementById("customerSearchInput")?.addEventListener("input",e=>{customerAdminSearch=e.target.value,renderCustomerAdmin()}),document.getElementById("kategoriTabs")?.addEventListener("click",async e=>{const t=e.target.closest(".kategori-tab");t&&(document.querySelectorAll(".kategori-tab").forEach(e=>e.classList.remove("active")),t.classList.add("active"),customerAdminKategori=t.dataset.kategori,selectedCategory="alle"===customerAdminKategori?"all":customerAdminKategori,renderCustomerAdmin(),await applyFilters())});const n=document.getElementById("toggleCustomerList"),a=document.getElementById("customerAdminList");n&&a&&(n.addEventListener("click",()=>{a.classList.toggle("collapsed"),n.classList.toggle("collapsed"),localStorage.setItem("customerListCollapsed",a.classList.contains("collapsed"))}),"true"===localStorage.getItem("customerListCollapsed")&&(a.classList.add("collapsed"),n.classList.add("collapsed")));const s=document.getElementById("sidebarToggle"),o=document.getElementById("sidebar");if(s&&o){s.addEventListener("click",()=>{if(window.innerWidth<=768)return;o.classList.toggle("collapsed");const e=o.classList.contains("collapsed");localStorage.setItem("sidebarCollapsed",e)});"true"===localStorage.getItem("sidebarCollapsed")&&window.innerWidth>768&&o.classList.add("collapsed")}const r=document.getElementById("customerListToggle"),i=document.getElementById("customerListContainer");if(r&&i){r.addEventListener("click",()=>{i.classList.toggle("hidden"),r.classList.toggle("collapsed"),localStorage.setItem("customerListHidden",i.classList.contains("hidden"))});"true"===localStorage.getItem("customerListHidden")&&(i.classList.add("hidden"),r.classList.add("collapsed"))}document.addEventListener("keydown",e=>{"Escape"===e.key&&(releaseCustomer(currentClaimedKundeId),closeModal(customerModal),closeModal(apiKeyModal))}),document.getElementById("closeCustomerModal")?.addEventListener("click",()=>{releaseCustomer(currentClaimedKundeId),closeModal(customerModal)}),document.getElementById("closeApiKeyModal")?.addEventListener("click",()=>{closeModal(apiKeyModal)}),customerModal.addEventListener("click",e=>{e.target===customerModal&&(releaseCustomer(currentClaimedKundeId),closeModal(customerModal))}),apiKeyModal.addEventListener("click",e=>{e.target===apiKeyModal&&closeModal(apiKeyModal)}),document.getElementById("closeAvtaleModal")?.addEventListener("click",closeAvtaleModal),document.getElementById("cancelAvtale")?.addEventListener("click",closeAvtaleModal),document.getElementById("avtaleForm")?.addEventListener("submit",saveAvtale),document.getElementById("deleteAvtaleBtn")?.addEventListener("click",deleteAvtale),document.getElementById("deleteAvtaleSeriesBtn")?.addEventListener("click",deleteAvtaleSeries),document.getElementById("avtaleModal")?.addEventListener("click",e=>{"avtaleModal"===e.target.id&&closeAvtaleModal()}),setupAvtaleKundeSearch(),document.getElementById("addKontaktBtn")?.addEventListener("click",addKontaktlogg),document.getElementById("kontaktNotat")?.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),addKontaktlogg())}),document.getElementById("kontaktloggList")?.addEventListener("click",e=>{const t=e.target.closest('[data-action="deleteKontakt"]');t&&deleteKontaktlogg(t.dataset.id)}),document.getElementById("addKontaktpersonBtn")?.addEventListener("click",addKontaktperson),document.getElementById("kontaktpersonNavn")?.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),addKontaktperson())}),document.getElementById("kontaktpersonerList")?.addEventListener("click",e=>{const t=e.target.closest('[data-action="deleteKontaktperson"]');t&&deleteKontaktperson(t.dataset.id)}),document.getElementById("manageSubcategoriesBtn")?.addEventListener("click",openSubcategoryManager);const l=document.querySelectorAll(".tab-item"),d=document.querySelectorAll(".tab-pane"),c=document.getElementById("contentPanel"),u=document.getElementById("contentPanelOverlay"),m=document.getElementById("panelTitle"),p=document.getElementById("contentPanelClose"),g={dashboard:"Dashboard",customers:"Kunder",overdue:"Forfalte",warnings:"Kommende kontroller",calendar:"Kalender","weekly-plan":"Planlagte oppdrag",planner:"Planlegger",statistikk:"Statistikk",missingdata:"Mangler data",chat:"Meldinger",admin:"Admin"};function f(){c&&(c.classList.remove("closed"),c.classList.add("open"),localStorage.setItem("contentPanelOpen","true"),isMobile&&document.getElementById("bottomTabBar")&&(c.classList.add("half-height"),c.classList.remove("full-height"),contentPanelMode="half")),u&&window.innerWidth<=768&&"full"===contentPanelMode&&u.classList.add("visible")}function v(){c&&(c.classList.add("closed"),c.classList.remove("open","half-height","full-height"),localStorage.setItem("contentPanelOpen","false"),contentPanelMode="closed"),u&&u.classList.remove("visible")}if(p&&p.addEventListener("click",()=>{if(v(),isMobile&&document.getElementById("bottomTabBar")){document.querySelectorAll(".bottom-tab-item").forEach(e=>e.classList.toggle("active","map"===e.dataset.bottomTab)),activeBottomTab="map";const e=document.getElementById("mobileSearchFab");e&&e.classList.remove("hidden")}}),u&&u.addEventListener("click",()=>{if(v(),isMobile&&document.getElementById("bottomTabBar")){document.querySelectorAll(".bottom-tab-item").forEach(e=>e.classList.toggle("active","map"===e.dataset.bottomTab)),activeBottomTab="map";const e=document.getElementById("mobileSearchFab");e&&e.classList.remove("hidden")}}),c){const e=c.querySelector(".content-panel-header");if(e){let t=0;e.addEventListener("touchstart",e=>{t=e.touches[0].clientY},{passive:!0}),e.addEventListener("touchend",e=>{if(!isMobile||!t)return;const n=t-e.changedTouches[0].clientY;if(t=0,n>50&&"half"===contentPanelMode)c.classList.remove("half-height"),c.classList.add("full-height"),contentPanelMode="full",u&&u.classList.add("visible");else if(n<-50&&"full"===contentPanelMode)c.classList.remove("full-height"),c.classList.add("half-height"),contentPanelMode="half",u&&u.classList.remove("visible");else if(n<-50&&"half"===contentPanelMode&&(v(),document.getElementById("bottomTabBar"))){document.querySelectorAll(".bottom-tab-item").forEach(e=>e.classList.toggle("active","map"===e.dataset.bottomTab)),activeBottomTab="map";const e=document.getElementById("mobileSearchFab");e&&e.classList.remove("hidden")}},{passive:!0})}}const y=document.getElementById("contentPanelResize");if(y&&c){let e=!1;const t=localStorage.getItem("contentPanelWidth");t&&window.innerWidth>768&&(c.style.width=t+"px");const n=t=>{window.innerWidth<=768||(t.preventDefault(),e=!0,y.classList.add("dragging"),c.classList.add("resizing"),document.body.style.cursor="col-resize",document.body.style.userSelect="none")},a=t=>{if(!e)return;const n=(t.touches?t.touches[0].clientX:t.clientX)-c.getBoundingClientRect().left,a=Math.max(280,Math.min(700,n));c.style.width=a+"px"},s=()=>{if(!e)return;e=!1,y.classList.remove("dragging"),c.classList.remove("resizing"),document.body.style.cursor="",document.body.style.userSelect="";const t=parseInt(c.style.width);t&&localStorage.setItem("contentPanelWidth",t)};y.addEventListener("mousedown",n),y.addEventListener("touchstart",n,{passive:!1}),document.addEventListener("mousemove",a),document.addEventListener("touchmove",a,{passive:!1}),document.addEventListener("mouseup",s),document.addEventListener("touchend",s),y.addEventListener("dblclick",()=>{c.style.width="",localStorage.removeItem("contentPanelWidth")})}l.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.getAttribute("data-tab"),a=document.querySelector(".tab-item.active")?.dataset.tab;a&&runTabCleanup(a),"weekly-plan"===a&&(weekPlanState.activeDay&&(weekPlanState.activeDay=null,areaSelectMode&&toggleAreaSelect()),wpFocusedTeamMember&&(wpFocusedTeamMember=null,wpFocusedMemberIds=null,applyTeamFocusToMarkers(),markerClusterGroup&&markerClusterGroup.refreshClusters()),closeWpRouteSummary()),l.forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")}),d.forEach(e=>e.classList.remove("active")),e.classList.add("active"),e.setAttribute("aria-selected","true");const s=document.getElementById(`tab-${n}`);if(s){s.classList.add("active"),c.classList.remove("compact-mode"),m&&(m.textContent=g[n]||n),f(),syncMapToTab(n),localStorage.setItem("activeTab",n);window.innerWidth<=768&&"function"==typeof closeMobileSidebar&&closeMobileSidebar(),"overdue"===n?renderOverdue():"warnings"===n?renderWarnings():"calendar"===n?(renderCalendar(),openCalendarSplitView()):"weekly-plan"===n?renderWeeklyPlan():"planner"===n?renderPlanner():"email"===n?loadEmailData():"statistikk"===n?renderStatistikk():"missingdata"===n?renderMissingData():"customers"===n?renderCustomerAdmin():"admin"===n?loadAdminData():"todays-work"===n?loadTodaysWork():"chat"===n&&onChatTabOpened()}})});const h=localStorage.getItem("activeTab"),k=localStorage.getItem("contentPanelOpen");window.innerWidth>768&&"false"!==k&&f();if(!(window.innerWidth<=768))if(h){const e=document.querySelector(`.tab-item[data-tab="${h}"]`);e&&setTimeout(()=>{e.click()},100)}else{const e=document.querySelector('.tab-item[data-tab="dashboard"]');e&&setTimeout(()=>e.click(),100)}document.getElementById("sendTestEmailBtn")?.addEventListener("click",sendTestEmail),document.getElementById("triggerEmailCheckBtn")?.addEventListener("click",triggerEmailCheck),document.getElementById("openTestEmailBtn")?.addEventListener("click",()=>{document.getElementById("emailTestPanel")?.classList.remove("hidden")}),document.getElementById("closeTestPanel")?.addEventListener("click",()=>{document.getElementById("emailTestPanel")?.classList.add("hidden")}),document.getElementById("toggleEmailConfig")?.addEventListener("click",()=>{document.getElementById("emailConfigCard")?.classList.toggle("collapsed")}),document.getElementById("overdueSortSelect")?.addEventListener("change",()=>{renderOverdue()}),document.getElementById("warningSortSelect")?.addEventListener("change",()=>{renderWarnings()});const b=getProximityRadius(),w=(e,t,n)=>{const a=document.getElementById(e),s=document.getElementById(t);a&&(a.value=b,s&&(s.textContent=`${b} km`),a.addEventListener("input",()=>{const e=Number(a.value);s&&(s.textContent=`${e} km`),localStorage.setItem("proximity_radiusKm",e),document.querySelectorAll('.proximity-settings input[type="range"]').forEach(t=>{t!==a&&(t.value=e)}),document.querySelectorAll(".proximity-radius-value").forEach(t=>{t.textContent=`${e} km`}),n()}))};w("overdueProximityRadius","overdueProximityRadiusValue",renderOverdue),w("warningProximityRadius","warningProximityRadiusValue",renderWarnings),document.getElementById("showOverdueOnMapBtn")?.addEventListener("click",showOverdueOnMap),document.getElementById("createOverdueRouteBtn")?.addEventListener("click",createOverdueRoute),document.getElementById("historyFilter")?.addEventListener("change",e=>{loadEmailHistory(e.target.value)}),document.getElementById("emailAktiv")?.addEventListener("change",e=>{const t=document.getElementById("emailOptions");t&&t.classList.toggle("hidden",!e.target.checked)});const S=document.getElementById("filterPanelToggle"),I=document.getElementById("filterPanel");if(S&&I){"true"===localStorage.getItem("filterPanelCollapsed")&&I.classList.add("collapsed"),S.addEventListener("click",()=>{I.classList.toggle("collapsed");const e=I.classList.contains("collapsed");localStorage.setItem("filterPanelCollapsed",e)})}document.querySelectorAll(".category-btn[data-category]").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".category-btn[data-category]").forEach(e=>e.classList.remove("active")),e.classList.add("active"),selectedCategory=e.dataset.category,applyFilters()})}),setTimeout(function(){const e=document.getElementById("totalCustomerCount");e&&(e.textContent=customers.length)},500),initWebSocket(),setInterval(()=>{updateDayCounters()},6e4),scheduleNextMidnightUpdate();const E=[{siste:"siste_kontroll",neste:"neste_kontroll",intervall:"kontroll_intervall"},{siste:"siste_el_kontroll",neste:"neste_el_kontroll",intervall:"el_kontroll_intervall"},{siste:"siste_brann_kontroll",neste:"neste_brann_kontroll",intervall:"brann_kontroll_intervall"}];document.addEventListener("change",e=>{const t=e.target.id;for(const e of E)if(t===e.siste||t===e.intervall){const n=document.getElementById(e.siste),a=document.getElementById(e.neste),s=document.getElementById(e.intervall);if(!n?.value||!s?.value)break;if(t===e.siste&&a?.value)break;const o=new Date(n.value);if(isNaN(o.getTime()))break;const r=parseInt(s.value),i=new Date(o);r<0?i.setDate(i.getDate()+Math.abs(r)):i.setMonth(i.getMonth()+r),a&&(a.value="month_year"===appConfig?.datoModus?i.toISOString().substring(0,7):i.toISOString().substring(0,10));break}}),document.addEventListener("change",e=>{e.target.classList.contains("wp-dispatch-select")&&(weekPlanState.globalAssignedTo=e.target.value,renderWeeklyPlan())}),document.addEventListener("change",e=>{if(e.target.classList.contains("wp-time-input")){const t=e.target,n=t.dataset.day,a=Number.parseInt(t.dataset.customerId),s=Math.max(5,parseInt(t.value)||30);t.value=s;const o=weekPlanState.days[n]?.planned.find(e=>e.id===a);if(o){o.estimertTid=s;const e=t.closest(".wp-day"),a=e?.querySelector(".wp-day-summary"),r=e?.querySelector(".wp-time-badge"),i=getDayEstimatedTotal(n),l=weekPlanState.days[n].planned.length,d=avtaler.filter(e=>e.dato===weekPlanState.days[n].date).length;a&&(a.textContent=`${l+d} kunder · ~${formatMinutes(i)}`),r&&(r.textContent=`~${formatMinutes(i)}`)}}}),document.addEventListener("click",async e=>{const t=e.target.closest("[data-action]");if(!t)return;switch(t.dataset.action){case"focusOnCustomer":focusOnCustomer(Number.parseInt(t.dataset.customerId));break;case"toggleCustomerSelection":toggleCustomerSelection(Number.parseInt(t.dataset.customerId));break;case"setActiveDay":e.stopPropagation();const n=t.dataset.day;weekPlanState.activeDay===n?(weekPlanState.activeDay=null,areaSelectMode&&toggleAreaSelect(),renderWeeklyPlan()):(weekPlanState.activeDay=n,areaSelectMode||toggleAreaSelect(),showToast(`Dra over kunder på kartet for ${weekDayLabels[weekDayKeys.indexOf(n)]}`,"info"),renderWeeklyPlan());break;case"removeFromPlan":e.stopPropagation();const a=t.dataset.day,s=Number.parseInt(t.dataset.customerId);weekPlanState.days[a]&&(weekPlanState.days[a].planned=weekPlanState.days[a].planned.filter(e=>e.id!==s),refreshTeamFocus(),renderWeeklyPlan());break;case"deleteAvtale":e.stopPropagation();{const e=t.dataset.avtaleId,n=t.dataset.avtaleName||"denne avtalen";if(await showConfirm(`Slett avtale for ${n}?`,"Slett"))try{const t=await apiFetch(`/api/avtaler/${e}`,{method:"DELETE"});if(t.ok)showToast("Avtale slettet","success"),await loadAvtaler(),refreshTeamFocus(),renderWeeklyPlan();else{const e=await t.json().catch(()=>({}));showToast(e.error?.message||"Kunne ikke slette avtale","error")}}catch(e){showToast("Feil ved sletting","error")}}break;case"wpAddSearchResult":if(e.stopPropagation(),t.classList.contains("disabled"))break;{const e=Number.parseInt(t.dataset.customerId),n=customers.find(t=>t.id===e);if(n){weekPlanState.activeDay||(weekPlanState.activeDay=weekDayKeys[0]),addCustomersToWeekPlan([n]);const e=document.getElementById("wpCustomerSearch");e&&(e.value="");const t=document.getElementById("wpSearchResults");t&&(t.style.display="none")}}break;case"saveWeeklyPlan":e.stopPropagation(),await saveWeeklyPlan();break;case"clearWeekPlan":e.stopPropagation(),clearWeekPlan();break;case"weekPlanPrev":if(e.stopPropagation(),getWeekPlanTotalPlanned()>0){if(!await showConfirm("Du har ulagrede endringer. Vil du bytte uke?","Bytt uke"))break}closeWpRouteSummary(),initWeekPlanState(addDaysToDate(weekPlanState.weekStart,-7)),renderWeeklyPlan();break;case"weekPlanNext":if(e.stopPropagation(),getWeekPlanTotalPlanned()>0){if(!await showConfirm("Du har ulagrede endringer. Vil du bytte uke?","Bytt uke"))break}closeWpRouteSummary(),initWeekPlanState(addDaysToDate(weekPlanState.weekStart,7)),renderWeeklyPlan();break;case"setEstimatedTime":e.stopPropagation();{const e=t.dataset.day,n=Number.parseInt(t.dataset.customerId),a=Math.max(5,parseInt(t.value)||30),s=weekPlanState.days[e]?.planned.find(e=>e.id===n);if(s){s.estimertTid=a;const n=t.closest(".wp-day")?.querySelector(".wp-day-summary"),o=t.closest(".wp-day")?.querySelector(".wp-time-badge"),r=getDayEstimatedTotal(e),i=weekPlanState.days[e].planned.length,l=avtaler.filter(t=>t.dato===weekPlanState.days[e].date).length;n&&(n.textContent=`${i+l} kunder · ~${formatMinutes(r)}`),o&&(o.textContent=`~${formatMinutes(r)}`)}}break;case"wpOptimizeOrder":e.stopPropagation(),await wpOptimizeOrder(t.dataset.day);break;case"wpNavigateDay":e.stopPropagation(),await wpNavigateDay(t.dataset.day);break;case"closeWpRoute":e.stopPropagation(),closeWpRouteSummary();break;case"wpExportMaps":e.stopPropagation(),wpExportToMaps();break;case"focusTeamMember":e.stopPropagation(),focusTeamMemberOnMap(t.dataset.memberName);break;case"quickAddToday":e.stopPropagation();const o=Number.parseInt(t.dataset.customerId),r=t.dataset.customerName;await quickAddAvtaleForDate(o,r,formatDateISO(new Date)),closeCalendarQuickMenu();break;case"quickAddToSplitDay":if(e.stopPropagation(),splitViewOpen&&splitViewState.activeDay){const e=Number.parseInt(t.dataset.customerId),n=t.dataset.customerName;await quickAddAvtaleForDate(e,n,splitViewState.activeDay)}break;case"showCalendarQuickMenu":e.stopPropagation(),showCalendarQuickMenu(Number.parseInt(t.dataset.customerId),t.dataset.customerName,t);break;case"quickAddAvtale":e.stopPropagation();const i=Number.parseInt(t.dataset.customerId),l=t.dataset.customerName,d=t.dataset.quickDate;await quickAddAvtaleForDate(i,l,d),closeCalendarQuickMenu();break;case"addCustomerToCalendar":closeCalendarQuickMenu();const c=Number.parseInt(t.dataset.customerId),u=t.dataset.customerName;openAvtaleModal(null,null),setTimeout(()=>{const e=document.getElementById("avtaleKundeSearch"),t=document.getElementById("avtaleKunde");e&&(e.value=u),t&&(t.value=c)},100);break;case"editCustomer":editCustomer(Number.parseInt(t.dataset.customerId));break;case"navigateToCustomer":navigateToCustomer(Number.parseFloat(t.dataset.lat),Number.parseFloat(t.dataset.lng),t.dataset.name);break;case"createRouteForArea":createRouteForAreaYear(t.dataset.area,Number.parseInt(t.dataset.year));break;case"addClusterToRoute":addClusterToRoute(t.dataset.customerIds.split(",").map(e=>Number.parseInt(e)));break;case"zoomToCluster":zoomToCluster(Number.parseFloat(t.dataset.lat),Number.parseFloat(t.dataset.lng));break;case"sendReminder":case"sendEmail":e.stopPropagation(),sendManualReminder(Number.parseInt(t.dataset.customerId));break;case"createRouteFromGroup":e.stopPropagation();createRouteFromCustomerIds(t.dataset.customerIds.split(",").map(e=>Number.parseInt(e)));break;case"showGroupOnMap":e.stopPropagation();const m=t.dataset.customerIds.split(",").map(e=>Number.parseInt(e));showCustomersOnMap(m),highlightCustomersOnMap(m);break;case"addGroupToWeekPlan":e.stopPropagation(),showWeekPlanDayPicker(t.dataset.customerIds,t);break;case"showClusterOnMap":SmartRouteEngine.showClusterOnMap(Number.parseInt(t.dataset.clusterId));break;case"createRouteFromCluster":SmartRouteEngine.createRouteFromCluster(Number.parseInt(t.dataset.clusterId));break;case"toggleShowAllRecommendations":toggleShowAllRecommendations();break;case"editAvtale":e.stopPropagation();const p=Number.parseInt(t.dataset.avtaleId),g=avtaler.find(e=>e.id===p);g&&openAvtaleModal(g);break;case"quickDeleteAvtale":e.stopPropagation();const f=Number.parseInt(t.dataset.avtaleId),v=avtaler.find(e=>e.id===f),y=v?.kunder?.navn||v?.kunde_navn||"denne avtalen";if(!await showConfirm(`Slett avtale for ${y}?`,"Bekreft sletting"))break;try{(await apiFetch(`/api/avtaler/${f}`,{method:"DELETE"})).ok?(showToast("Avtale slettet","success"),await loadAvtaler(),renderCalendar()):showToast("Kunne ikke slette avtalen","error")}catch(e){console.error("Error quick-deleting avtale:",e),showToast("Kunne ikke slette avtalen","error")}break;case"quickMarkVisited":e.stopPropagation(),quickMarkVisited(Number.parseInt(t.dataset.customerId));break;case"openDayDetail":openAvtaleModal(null,t.dataset.date);break;case"toggleSection":e.preventDefault();const h=t.dataset.area,k=t.nextElementSibling,b=t.querySelector(".section-toggle-icon i");if(k&&b){k.classList.contains("collapsed")?(k.classList.remove("collapsed"),b.classList.remove("fa-chevron-right"),b.classList.add("fa-chevron-down"),localStorage.setItem(`areaExpanded-${h}`,"true")):(k.classList.add("collapsed"),b.classList.remove("fa-chevron-down"),b.classList.add("fa-chevron-right"),localStorage.setItem(`areaExpanded-${h}`,"false"))}break;case"selectCustomer":if(e.target.closest('[data-action="sendEmail"]'))return;const w=Number.parseInt(t.dataset.customerId);focusOnCustomer(w),toggleCustomerSelection(w);break;case"editTeamMember":e.stopPropagation();const S=Number.parseInt(t.dataset.memberId),I=teamMembersData.find(e=>e.id===S);I&&openTeamMemberModal(I);break;case"deleteTeamMember":e.stopPropagation();const E=Number.parseInt(t.dataset.memberId),C=teamMembersData.find(e=>e.id===E);C&&deleteTeamMember(C)}}),document.addEventListener("keydown",e=>{if("Enter"!==e.key&&" "!==e.key)return;const t=e.target.closest("[data-action]");t&&(["BUTTON","A","INPUT","SELECT","TEXTAREA"].includes(t.tagName)||(e.preventDefault(),t.click()))});const C=document.querySelector('[role="tablist"]');C&&C.addEventListener("keydown",e=>{if(!["ArrowUp","ArrowDown","Home","End"].includes(e.key))return;const t=[...C.querySelectorAll('[role="tab"]:not([style*="display: none"])')],n=t.indexOf(document.activeElement);if(-1===n)return;let a;e.preventDefault(),"ArrowDown"===e.key?a=(n+1)%t.length:"ArrowUp"===e.key?a=(n-1+t.length)%t.length:"Home"===e.key?a=0:"End"===e.key&&(a=t.length-1),t[a].focus(),t[a].click()})}document.addEventListener("DOMContentLoaded",async()=>{startInactivityTracking();const e=document.getElementById("stopImpersonationBtn");e&&e.addEventListener("click",()=>stopImpersonation());const t=document.getElementById("smartDaysAhead");t&&t.addEventListener("input",function(){document.getElementById("smartDaysAheadValue").textContent=this.value+" dager"});const n=document.getElementById("smartMaxCustomers");n&&n.addEventListener("input",function(){document.getElementById("smartMaxCustomersValue").textContent=this.value+" kunder"});const a=document.getElementById("smartClusterRadius");a&&a.addEventListener("input",function(){document.getElementById("smartClusterRadiusValue").textContent=this.value+" km"});const s=document.getElementById("refreshSmartRecommendationsBtn");s&&s.addEventListener("click",()=>renderSmartRecommendations()),initializeTheme(),await loadConfig(),applyBranding(),initSharedMap(),initLoginView();if(await checkExistingAuth()){const e="true"===localStorage.getItem("isImpersonating");if("true"===localStorage.getItem("isSuperAdmin")&&!e)return void(window.location.href="/admin");if(e){const e=document.getElementById("impersonationBanner"),t=localStorage.getItem("impersonatingOrgName")||"Ukjent bedrift";e&&(document.getElementById("impersonatingOrgName").textContent=t,e.style.display="flex",document.body.classList.add("is-impersonating"))}const t=document.getElementById("loginOverlay"),n=document.getElementById("appView");t&&t.classList.add("hidden"),n&&n.classList.remove("hidden"),currentView="app",appInitialized=!0,map&&(map.dragging.enable(),map.scrollWheelZoom.enable(),map.doubleClickZoom.enable(),map.touchZoom.enable(),map.keyboard.enable(),L.control.zoom({position:"topright"}).addTo(map),map.setView([67.5,15],6,{animate:!1})),initDOMElements(),initMap(),await loadOrganizationCategories(),await loadOrganizationFields(),loadCustomers(),loadOmrader(),initWebSocket(),showUserBar(),setupEventListeners(),initChat(),initChatEventListeners()}else{currentView="login";const e=document.querySelector(".tab-navigation");e&&(e.style.opacity="0",e.style.pointerEvents="none");const t=document.getElementById("sidebarToggle");t&&(t.style.opacity="0",t.style.pointerEvents="none")}});