---
/**
 * PasswordStrengthIndicator
 * Visual indicator of password strength with real-time feedback
 *
 * Usage:
 * <PasswordStrengthIndicator inputId="password-field" />
 */

interface Props {
  inputId: string;
  minLength?: number;
}

const { inputId, minLength = 10 } = Astro.props;
---

<div class="password-strength-container" data-input-id={inputId} data-min-length={minLength}>
  <div class="strength-bar-container">
    <div class="strength-bar" data-strength="0"></div>
  </div>
  <div class="strength-text"></div>
  <ul class="requirements-list">
    <li data-requirement="length" class="requirement">
      <span class="icon"></span>
      <span>Minst {minLength} tegn</span>
    </li>
    <li data-requirement="uppercase" class="requirement">
      <span class="icon"></span>
      <span>Minst en stor bokstav</span>
    </li>
    <li data-requirement="lowercase" class="requirement">
      <span class="icon"></span>
      <span>Minst en liten bokstav</span>
    </li>
    <li data-requirement="number" class="requirement">
      <span class="icon"></span>
      <span>Minst ett tall</span>
    </li>
    <li data-requirement="special" class="requirement">
      <span class="icon"></span>
      <span>Minst ett spesialtegn (!@#$%^&*)</span>
    </li>
  </ul>
</div>

<style>
  .password-strength-container {
    margin-top: 0.5rem;
  }

  .strength-bar-container {
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .strength-bar {
    height: 100%;
    width: 0%;
    transition: width 0.3s ease, background-color 0.3s ease;
    border-radius: 2px;
  }

  .strength-bar[data-strength="0"] {
    width: 0%;
    background: #e5e7eb;
  }

  .strength-bar[data-strength="1"] {
    width: 20%;
    background: #ef4444;
  }

  .strength-bar[data-strength="2"] {
    width: 40%;
    background: #f97316;
  }

  .strength-bar[data-strength="3"] {
    width: 60%;
    background: #eab308;
  }

  .strength-bar[data-strength="4"] {
    width: 80%;
    background: #84cc16;
  }

  .strength-bar[data-strength="5"] {
    width: 100%;
    background: #22c55e;
  }

  .strength-text {
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
    min-height: 1rem;
  }

  .strength-text[data-level="weak"] {
    color: #ef4444;
  }

  .strength-text[data-level="fair"] {
    color: #f97316;
  }

  .strength-text[data-level="good"] {
    color: #eab308;
  }

  .strength-text[data-level="strong"] {
    color: #84cc16;
  }

  .strength-text[data-level="very-strong"] {
    color: #22c55e;
  }

  .requirements-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.75rem;
    color: #6b7280;
  }

  .requirement {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.125rem 0;
    transition: color 0.2s ease;
  }

  .requirement .icon {
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
  }

  .requirement .icon::before {
    content: "\2715"; /* X mark */
    color: #9ca3af;
  }

  .requirement.met {
    color: #22c55e;
  }

  .requirement.met .icon::before {
    content: "\2713"; /* Check mark */
    color: #22c55e;
  }
</style>

<script>
  // Password strength checker
  function checkPasswordStrength(password: string, minLength: number) {
    const requirements = {
      length: password.length >= minLength,
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
    };

    const metCount = Object.values(requirements).filter(Boolean).length;

    let level: string;
    let text: string;

    if (password.length === 0) {
      level = '';
      text = '';
    } else if (metCount <= 1) {
      level = 'weak';
      text = 'Svakt passord';
    } else if (metCount === 2) {
      level = 'fair';
      text = 'Middels passord';
    } else if (metCount === 3) {
      level = 'good';
      text = 'Greit passord';
    } else if (metCount === 4) {
      level = 'strong';
      text = 'Sterkt passord';
    } else {
      level = 'very-strong';
      text = 'Veldig sterkt passord';
    }

    return {
      requirements,
      strength: password.length === 0 ? 0 : metCount,
      level,
      text,
    };
  }

  // Initialize all password strength indicators on the page
  function initPasswordStrengthIndicators() {
    const containers = document.querySelectorAll('.password-strength-container');

    containers.forEach((container) => {
      const inputId = container.getAttribute('data-input-id');
      const minLength = parseInt(container.getAttribute('data-min-length') || '10', 10);

      if (!inputId) return;

      const input = document.getElementById(inputId) as HTMLInputElement;
      if (!input) return;

      const strengthBar = container.querySelector('.strength-bar') as HTMLElement;
      const strengthText = container.querySelector('.strength-text') as HTMLElement;
      const requirementItems = container.querySelectorAll('.requirement');

      function updateStrengthIndicator() {
        const result = checkPasswordStrength(input.value, minLength);

        // Update strength bar
        if (strengthBar) {
          strengthBar.setAttribute('data-strength', String(result.strength));
        }

        // Update strength text
        if (strengthText) {
          strengthText.textContent = result.text;
          strengthText.setAttribute('data-level', result.level);
        }

        // Update requirement indicators
        requirementItems.forEach((item) => {
          const requirement = item.getAttribute('data-requirement') as keyof typeof result.requirements;
          if (requirement && result.requirements[requirement]) {
            item.classList.add('met');
          } else {
            item.classList.remove('met');
          }
        });
      }

      // Listen for input events
      input.addEventListener('input', updateStrengthIndicator);
      input.addEventListener('change', updateStrengthIndicator);

      // Initial check
      updateStrengthIndicator();
    });
  }

  // Run on page load and after view transitions
  document.addEventListener('astro:page-load', initPasswordStrengthIndicators);

  // Fallback for non-Astro pages
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordStrengthIndicators);
  } else {
    initPasswordStrengthIndicators();
  }
</script>
