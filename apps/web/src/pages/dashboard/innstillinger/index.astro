---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { requireAuth, isAuthError } from '../../../middleware/auth';
import * as db from '@skyplanner/database';
import { createClient } from '@supabase/supabase-js';

// Initialize Supabase client
db.getSupabaseClient({
  supabaseUrl: import.meta.env.SUPABASE_URL,
  supabaseKey: import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.SUPABASE_ANON_KEY,
});

// Auth check
const authResult = await requireAuth(Astro);
if (isAuthError(authResult)) return authResult;

const { user, organization, payload } = authResult;

// Check if organization is in full mode (TRE Allservice features)
const isFullMode = (organization as any).app_mode === 'full';

// Determine admin status
let isCurrentUserAdmin = false;
if (payload.type === 'bruker') {
  isCurrentUserAdmin = true;
} else {
  const currentKlient = await db.getKlientById(user.id);
  isCurrentUserAdmin = currentKlient?.rolle === 'admin';
}

// Get current industry info
const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.SUPABASE_ANON_KEY
);

let currentIndustry = null;
if ((organization as any).industry_template_id) {
  const { data } = await supabase
    .from('industry_templates')
    .select('id, name, slug, icon, color, description')
    .eq('id', (organization as any).industry_template_id)
    .single();
  currentIndustry = data;
}
---

<DashboardLayout
  title="Innstillinger"
  user={user}
  organization={organization}
  currentPath="/dashboard/innstillinger"
>
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-white mb-2">Innstillinger</h1>
    <p class="text-dark-400">Administrer organisasjonsinnstillinger og branding.</p>
  </div>

  <!-- Settings Navigation -->
  <div class="mb-8 flex flex-wrap gap-2">
    <a href="/dashboard/innstillinger" class="px-4 py-2 rounded-xl bg-primary-500/10 text-primary-400 border border-primary-500/20 font-medium text-sm" aria-current="page">
      Generelt
    </a>
    <a href="/dashboard/innstillinger/tjenester" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Tjenestekategorier
    </a>
    <a href="/dashboard/innstillinger/kategorier" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Kategorier
    </a>
    <a href="/dashboard/innstillinger/integrasjoner" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Integrasjoner
    </a>
    <a href="/dashboard/innstillinger/api-nokler" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      API-nøkler
    </a>
    <a href="/dashboard/innstillinger/webhooks" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Webhooks
    </a>
    <a href="/dashboard/innstillinger/sikkerhet" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Sikkerhet
    </a>
    <a href="/dashboard/innstillinger/personvern" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Personvern
    </a>
  </div>

  <!-- Organization Settings Form -->
  <form id="settings-form" class="space-y-8">
    <!-- General Settings -->
    <div class="glass-card p-6">
      <h2 class="text-lg font-semibold text-white mb-6">Generelt</h2>

      <div class="space-y-6">
        <div>
          <label class="input-label" for="org-navn">Organisasjonsnavn *</label>
          <input
            type="text"
            id="org-navn"
            name="navn"
            value={organization.navn}
            class="input max-w-md"
            required
            maxlength="100"
            disabled={!isCurrentUserAdmin}
          />
          <p class="text-xs text-dark-400 mt-1">Dette vises i appen og på fakturaer.</p>
        </div>

        <div>
          <label class="input-label">URL-slug</label>
          <div class="flex items-center gap-2 max-w-md">
            <span class="text-dark-400">skyplanner.no/</span>
            <input
              type="text"
              value={organization.slug}
              class="input flex-1 bg-dark-700/30"
              disabled
            />
          </div>
          <p class="text-xs text-dark-400 mt-1">URL-slug kan ikke endres.</p>
        </div>
      </div>
    </div>

    <!-- Company Address Settings -->
    <div class="glass-card p-6">
      <h2 class="text-lg font-semibold text-white mb-6">Kontoradresse</h2>
      <p class="text-dark-400 text-sm mb-4">Adressen brukes som hjemikon på kartet og startpunkt for ruteplanlegging.</p>

      <div class="space-y-4">
        <div style="position:relative;">
          <label class="input-label" for="company-address">Adresse</label>
          <input
            type="text"
            id="company-address"
            name="company_address"
            value={(organization as any).company_address || ''}
            class="input max-w-md"
            maxlength="200"
            placeholder="Begynn å skrive for å søke..."
            disabled={!isCurrentUserAdmin}
            autocomplete="off"
          />
          <div id="address-suggestions" style="position:absolute; top:100%; left:0; z-index:9999; display:none; width:100%; max-width:28rem; background:#1e1e2e; border:1px solid #3b3b5c; border-radius:0.75rem; box-shadow:0 8px 32px rgba(0,0,0,0.6); overflow:hidden; margin-top:4px;"></div>
        </div>

        <div class="grid grid-cols-2 gap-4 max-w-md">
          <div>
            <label class="input-label" for="company-postnummer">Postnummer</label>
            <input
              type="text"
              id="company-postnummer"
              name="company_postnummer"
              value={(organization as any).company_postnummer || ''}
              class="input"
              maxlength="10"
              placeholder="0001"
              disabled={!isCurrentUserAdmin}
            />
          </div>
          <div>
            <label class="input-label" for="company-poststed">Poststed</label>
            <input
              type="text"
              id="company-poststed"
              name="company_poststed"
              value={(organization as any).company_poststed || ''}
              class="input"
              maxlength="100"
              placeholder="Oslo"
              disabled={!isCurrentUserAdmin}
            />
          </div>
        </div>

        <div>
          <div class="flex items-center gap-3 mb-2">
            <label class="input-label mb-0">Koordinater</label>
            {isCurrentUserAdmin && (
              <button
                type="button"
                id="geocode-btn"
                class="text-primary-400 hover:text-primary-300 text-xs font-medium"
              >
                <i class="fas fa-search-location mr-1"></i> Sl&aring; opp fra adresse
              </button>
            )}
          </div>
          <div class="grid grid-cols-2 gap-4 max-w-md">
            <div>
              <label class="text-xs text-dark-500" for="route-start-lat">Breddegrad (lat)</label>
              <input
                type="number"
                id="route-start-lat"
                name="route_start_lat"
                value={(organization as any).route_start_lat || ''}
                class="input"
                step="any"
                min="-90"
                max="90"
                placeholder="59.9139"
                disabled={!isCurrentUserAdmin}
              />
            </div>
            <div>
              <label class="text-xs text-dark-500" for="route-start-lng">Lengdegrad (lng)</label>
              <input
                type="number"
                id="route-start-lng"
                name="route_start_lng"
                value={(organization as any).route_start_lng || ''}
                class="input"
                step="any"
                min="-180"
                max="180"
                placeholder="10.7522"
                disabled={!isCurrentUserAdmin}
              />
            </div>
          </div>
          <p class="text-xs text-dark-400 mt-1" id="geocode-status"></p>
        </div>
      </div>
    </div>

    <!-- Industry Settings -->
    <div class="glass-card p-6">
      <h2 class="text-lg font-semibold text-white mb-6">Bransje</h2>

      <div class="space-y-4">
        {currentIndustry ? (
          <div class="flex items-center gap-4 p-4 rounded-xl border border-dark-600 bg-dark-800/50">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center text-lg" style={`background: ${currentIndustry.color}20; color: ${currentIndustry.color}`}>
              <i class={`fas ${currentIndustry.icon}`}></i>
            </div>
            <div class="flex-1">
              <p class="font-medium text-white">{currentIndustry.name}</p>
              {currentIndustry.description && <p class="text-sm text-dark-400">{currentIndustry.description}</p>}
            </div>
            {isCurrentUserAdmin && (
              <button
                type="button"
                id="change-industry-btn"
                class="text-primary-400 hover:text-primary-300 text-sm font-medium"
              >
                Endre bransje
              </button>
            )}
          </div>
        ) : (
          <div class="text-dark-400">Ingen bransje valgt</div>
        )}

        <div id="industry-selector" class="hidden">
          <p class="text-sm text-amber-400 mb-3">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            Endring av bransje vil oppdatere tilgjengelige tjenesttyper og ikoner i appen.
          </p>
          <div id="industry-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 max-h-72 overflow-y-auto pr-1">
            <div class="col-span-full text-center text-dark-400 py-4">Laster bransjer...</div>
          </div>
          <input type="hidden" id="industry-id" name="industry_template_id" value={currentIndustry?.id || ''} />
          <div class="flex items-center gap-3 mt-4">
            <button
              type="button"
              id="save-industry-btn"
              class="btn-primary"
              disabled
            >
              Lagre bransje
            </button>
            <button
              type="button"
              id="cancel-industry-btn"
              class="btn-secondary"
            >
              Avbryt
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Date Format Settings -->
    <div class="glass-card p-6">
      <h2 class="text-lg font-semibold text-white mb-6">Datoformat</h2>
      <p class="text-dark-400 text-sm mb-4">Velg hvordan kontrolldatoer vises i appen.</p>
      <div class="space-y-3">
        <label class="flex items-center gap-3 cursor-pointer">
          <input
            type="radio"
            name="dato_modus"
            value="full_date"
            checked={(organization as any).dato_modus !== 'month_year'}
            class="text-primary-500"
            disabled={!isCurrentUserAdmin}
          />
          <div>
            <span class="text-white font-medium">Full dato</span>
            <span class="text-dark-400 text-sm block">Viser "1. mars 2025"</span>
          </div>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input
            type="radio"
            name="dato_modus"
            value="month_year"
            checked={(organization as any).dato_modus === 'month_year'}
            class="text-primary-500"
            disabled={!isCurrentUserAdmin}
          />
          <div>
            <span class="text-white font-medium">Kun m&aring;ned og &aring;r</span>
            <span class="text-dark-400 text-sm block">Viser "mars 2025" (uten dagsnummer)</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Branding Settings -->
    <div class="glass-card p-6">
      <h2 class="text-lg font-semibold text-white mb-6">Branding</h2>

      <div class="space-y-6">
        <!-- Logo Upload -->
        <div>
          <label class="input-label">Logo</label>
          <div class="flex items-start gap-6">
            <!-- Current Logo Preview -->
            <div class="flex-shrink-0">
              <div id="logo-preview-wrapper" class="relative">
                {organization.logo_url ? (
                  <img
                    src={organization.logo_url}
                    alt="Logo"
                    class="w-24 h-24 rounded-xl object-cover bg-dark-700 border border-dark-600"
                    id="logo-preview"
                  />
                ) : (
                  <div class="w-24 h-24 rounded-xl bg-dark-700 border border-dark-600 flex items-center justify-center" id="logo-placeholder">
                    <svg class="w-10 h-10 text-dark-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                )}
                <img
                  src=""
                  alt="Logo forhåndsvisning"
                  class="w-24 h-24 rounded-xl object-cover bg-dark-700 border border-dark-600 hidden"
                  id="logo-preview-new"
                />
              </div>
            </div>

            <!-- Upload Controls -->
            {isCurrentUserAdmin ? (
              <div class="flex-1">
                <div class="flex flex-col gap-3">
                  <label class="btn-secondary cursor-pointer inline-flex items-center justify-center max-w-xs">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span id="upload-btn-text">Last opp logo</span>
                    <input
                      type="file"
                      id="logo-upload"
                      accept="image/png,image/jpeg,image/svg+xml,image/webp"
                      class="hidden"
                    />
                  </label>
                  {organization.logo_url && (
                    <button
                      type="button"
                      id="remove-logo-btn"
                      class="text-red-400 hover:text-red-300 text-sm font-medium text-left"
                    >
                      Fjern logo
                    </button>
                  )}
                </div>
                <p class="text-xs text-dark-400 mt-3">PNG, JPG, SVG eller WebP. Maks 2MB.</p>
                <p class="text-xs text-dark-400">Anbefalt størrelse: 200x200px eller større.</p>
                <div id="upload-status" class="mt-2 text-sm hidden" role="alert" aria-live="assertive">
                  <span class="text-green-400" id="upload-success">Logo lastet opp!</span>
                  <span class="text-red-400 hidden" id="upload-error">Feil ved opplasting</span>
                </div>
              </div>
            ) : (
              <div class="flex-1">
                <p class="text-dark-400 text-sm">Kun administratorer kan endre logo.</p>
              </div>
            )}
          </div>
          <!-- Hidden input to track logo URL for form submission -->
          <input type="hidden" id="logo-url" name="logo_url" value={organization.logo_url || ''} />
        </div>

      </div>
    </div>

    <!-- Plan Info (Read-only) - hidden for enterprise lifetime -->
    {!isFullMode && (
      <div class="glass-card p-6">
        <h2 class="text-lg font-semibold text-white mb-6">Abonnement</h2>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <div>
            <p class="text-sm text-dark-400 mb-1">Plan</p>
            <p class="text-white font-medium capitalize">{organization.plan_type}</p>
          </div>
          <div>
            <p class="text-sm text-dark-400 mb-1">Maks brukere</p>
            <p class="text-white font-medium">{organization.max_brukere}</p>
          </div>
          <div>
            <p class="text-sm text-dark-400 mb-1">Maks kunder</p>
            <p class="text-white font-medium">{organization.max_kunder}</p>
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-dark-700/50">
          <a href="/dashboard/abonnement" class="text-primary-400 hover:text-primary-300 text-sm font-medium">
            Administrer abonnement →
          </a>
        </div>
      </div>
    )}

    <!-- Form Actions -->
    {isCurrentUserAdmin ? (
      <div class="flex items-center gap-4">
        <button type="submit" class="btn-primary" id="save-btn">
          Lagre endringer
        </button>
        <div id="save-status" class="text-sm hidden" role="alert" aria-live="assertive">
          <span class="text-green-400" id="save-success">Endringer lagret!</span>
          <span class="text-red-400 hidden" id="save-error">Kunne ikke lagre endringer</span>
        </div>
      </div>
    ) : (
      <div class="glass-card p-4 border border-yellow-500/30">
        <p class="text-dark-400 text-sm">
          <i class="fas fa-lock mr-1 text-yellow-400"></i>
          Kun administratorer kan endre innstillinger. Kontakt en administrator for å gjøre endringer.
        </p>
      </div>
    )}
  </form>

  <!-- Danger Zone (admin only) -->
  {isCurrentUserAdmin && (
    <div class="mt-12">
      <h2 class="text-lg font-semibold text-red-400 mb-4">Faresone</h2>
      <div class="glass-card p-6 border-red-500/30">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h3 class="text-white font-medium">Slett organisasjon</h3>
            <p class="text-sm text-dark-400">
              Permanent sletting av organisasjonen og alle data. Denne handlingen kan ikke angres.
            </p>
          </div>
          <button
            type="button"
            id="delete-org-btn"
            class="px-4 py-2 bg-red-500/10 border border-red-500/30 text-red-400 rounded-xl
                   hover:bg-red-500/20 hover:border-red-500/50 transition-colors text-sm font-medium"
          >
            Slett organisasjon
          </button>
        </div>
      </div>
    </div>
  )}
</DashboardLayout>

<script>
  function getCsrfToken(cookieName = '__csrf') {
    const match = document.cookie.match(new RegExp('(?:^|;\\s*)' + cookieName + '=([^;]*)'));
    return match ? match[1] : '';
  }

  function csrfHeaders(): Record<string, string> {
    return { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() };
  }

  // Backend (proxied via /api/app/) uses a different CSRF cookie name
  function backendCsrfHeaders(): Record<string, string> {
    return { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken('csrf_token') };
  }

  // Ensure backend CSRF cookie is set (GET request triggers csrfTokenMiddleware)
  let backendCsrfReady = !!getCsrfToken('csrf_token');
  async function ensureBackendCsrf() {
    if (backendCsrfReady) return;
    try {
      await fetch('/api/app/config', { credentials: 'include' });
      backendCsrfReady = true;
    } catch { /* ignore */ }
  }

  const form = document.getElementById('settings-form') as HTMLFormElement;
  const saveBtn = document.getElementById('save-btn');
  const saveStatus = document.getElementById('save-status');
  const saveSuccess = document.getElementById('save-success');
  const saveError = document.getElementById('save-error');
  const logoUrlInput = document.getElementById('logo-url') as HTMLInputElement;
  const deleteOrgBtn = document.getElementById('delete-org-btn');

  // Industry elements
  const changeIndustryBtn = document.getElementById('change-industry-btn');
  const industrySelector = document.getElementById('industry-selector');
  const industryGrid = document.getElementById('industry-grid');
  const industryIdInput = document.getElementById('industry-id') as HTMLInputElement;
  const saveIndustryBtn = document.getElementById('save-industry-btn') as HTMLButtonElement;
  const cancelIndustryBtn = document.getElementById('cancel-industry-btn');

  let originalIndustryId = industryIdInput?.value || '';
  let industriesLoaded = false;

  // Fetch and render industries
  async function loadIndustries() {
    if (industriesLoaded) return;

    try {
      const response = await fetch('/api/industries');
      const data = await response.json();

      if (!response.ok || !data.industries) {
        throw new Error('Kunne ikke laste bransjer');
      }

      if (industryGrid) {
        industryGrid.innerHTML = data.industries.map((industry: any) => `
          <button
            type="button"
            class="industry-card p-3 rounded-xl border transition-all text-left ${industry.id.toString() === originalIndustryId ? 'border-primary-500 bg-primary-500/10' : 'border-dark-600 hover:border-dark-500'}"
            data-id="${industry.id}"
            data-slug="${industry.slug}"
          >
            <div class="flex items-center gap-2 mb-1">
              <span class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" style="background: ${industry.color}20; color: ${industry.color}">
                <i class="fas ${industry.icon}"></i>
              </span>
              <span class="font-medium text-white text-sm">${industry.name}</span>
            </div>
            ${industry.description ? `<p class="text-xs text-dark-400 line-clamp-2">${industry.description}</p>` : ''}
          </button>
        `).join('');

        // Add click handlers
        document.querySelectorAll('.industry-card').forEach(card => {
          card.addEventListener('click', () => {
            document.querySelectorAll('.industry-card').forEach(c => {
              c.classList.remove('border-primary-500', 'bg-primary-500/10');
              c.classList.add('border-dark-600');
            });
            card.classList.remove('border-dark-600');
            card.classList.add('border-primary-500', 'bg-primary-500/10');
            const cardEl = card as HTMLElement;
            industryIdInput.value = cardEl.dataset.id || '';
            // Enable save button only if different from original
            if (saveIndustryBtn) {
              saveIndustryBtn.disabled = industryIdInput.value === originalIndustryId;
            }
          });
        });

        industriesLoaded = true;
      }
    } catch (err) {
      if (industryGrid) {
        industryGrid.innerHTML = '<div class="col-span-full text-center text-red-400 py-4">Kunne ikke laste bransjer.</div>';
      }
    }
  }

  // Show industry selector
  changeIndustryBtn?.addEventListener('click', async () => {
    industrySelector?.classList.remove('hidden');
    changeIndustryBtn?.closest('.flex')?.classList.add('hidden');
    await loadIndustries();
  });

  // Cancel industry change
  cancelIndustryBtn?.addEventListener('click', () => {
    industrySelector?.classList.add('hidden');
    changeIndustryBtn?.closest('.flex')?.classList.remove('hidden');
    industryIdInput.value = originalIndustryId;
    // Reset selection visually
    document.querySelectorAll('.industry-card').forEach(card => {
      const cardEl = card as HTMLElement;
      if (cardEl.dataset.id === originalIndustryId) {
        card.classList.remove('border-dark-600');
        card.classList.add('border-primary-500', 'bg-primary-500/10');
      } else {
        card.classList.remove('border-primary-500', 'bg-primary-500/10');
        card.classList.add('border-dark-600');
      }
    });
  });

  // Save industry change
  saveIndustryBtn?.addEventListener('click', async () => {
    const newIndustryId = industryIdInput.value;
    if (!newIndustryId || newIndustryId === originalIndustryId) return;

    if (!confirm('Er du sikker på at du vil endre bransje? Dette vil oppdatere tilgjengelige tjenesttyper i appen.')) {
      return;
    }

    saveIndustryBtn.disabled = true;
    saveIndustryBtn.textContent = 'Lagrer...';

    try {
      const res = await fetch('/api/dashboard/organization', {
        method: 'PUT',
        headers: csrfHeaders(),
        body: JSON.stringify({ industry_template_id: parseInt(newIndustryId) }),
      });

      if (!res.ok) {
        const result = await res.json();
        throw new Error(result.error || 'Kunne ikke oppdatere bransje');
      }

      // Reload page to show updated industry
      window.location.reload();
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Kunne ikke oppdatere bransje');
      saveIndustryBtn.disabled = false;
      saveIndustryBtn.textContent = 'Lagre bransje';
    }
  });

  // Logo upload elements
  const logoUpload = document.getElementById('logo-upload') as HTMLInputElement;
  const logoPreview = document.getElementById('logo-preview') as HTMLImageElement;
  const logoPreviewNew = document.getElementById('logo-preview-new') as HTMLImageElement;
  const logoPlaceholder = document.getElementById('logo-placeholder');
  const removeLogoBtn = document.getElementById('remove-logo-btn');
  const uploadBtnText = document.getElementById('upload-btn-text');
  const uploadStatus = document.getElementById('upload-status');
  const uploadSuccess = document.getElementById('upload-success');
  const uploadError = document.getElementById('upload-error');

  // Logo upload handler
  logoUpload?.addEventListener('change', async () => {
    const file = logoUpload.files?.[0];
    if (!file) return;

    // Show preview immediately
    const reader = new FileReader();
    reader.onload = (e) => {
      logoPreviewNew.src = e.target?.result as string;
      logoPreviewNew.classList.remove('hidden');
      logoPreview?.classList.add('hidden');
      logoPlaceholder?.classList.add('hidden');
    };
    reader.readAsDataURL(file);

    // Upload to server
    if (uploadBtnText) uploadBtnText.textContent = 'Laster opp...';
    uploadStatus?.classList.add('hidden');
    uploadSuccess?.classList.add('hidden');
    uploadError?.classList.add('hidden');

    const formData = new FormData();
    formData.append('logo', file);

    try {
      const res = await fetch('/api/dashboard/organization/upload-logo', {
        method: 'POST',
        body: formData,
      });

      const result = await res.json();

      if (!res.ok) {
        throw new Error(result.error || 'Opplasting feilet');
      }

      // Update hidden input with new URL
      if (logoUrlInput) logoUrlInput.value = result.logo_url;

      uploadStatus?.classList.remove('hidden');
      uploadSuccess?.classList.remove('hidden');

      // Show remove button if it was hidden
      if (removeLogoBtn) {
        removeLogoBtn.classList.remove('hidden');
      }

      setTimeout(() => {
        uploadStatus?.classList.add('hidden');
      }, 3000);

      // Reload to show updated logo in sidebar
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (err) {
      uploadStatus?.classList.remove('hidden');
      if (uploadError) {
        uploadError.textContent = err instanceof Error ? err.message : 'Opplasting feilet';
        uploadError.classList.remove('hidden');
      }
      // Revert preview
      logoPreviewNew.classList.add('hidden');
      if (logoPreview?.src) {
        logoPreview.classList.remove('hidden');
      } else {
        logoPlaceholder?.classList.remove('hidden');
      }
    } finally {
      if (uploadBtnText) uploadBtnText.textContent = 'Last opp logo';
      logoUpload.value = '';
    }
  });

  // Remove logo handler
  removeLogoBtn?.addEventListener('click', async () => {
    if (!confirm('Er du sikker på at du vil fjerne logoen?')) return;

    try {
      const res = await fetch('/api/dashboard/organization/upload-logo', {
        method: 'DELETE',
      });

      if (!res.ok) {
        const result = await res.json();
        throw new Error(result.error || 'Kunne ikke fjerne logo');
      }

      // Reload to show changes
      window.location.reload();
    } catch (err) {
      alert(err instanceof Error ? err.message : 'Kunne ikke fjerne logo');
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    saveBtn?.setAttribute('disabled', 'true');
    saveBtn!.textContent = 'Lagrer...';
    saveStatus?.classList.add('hidden');
    saveSuccess?.classList.add('hidden');
    saveError?.classList.add('hidden');

    const formData = new FormData(form);
    const latVal = formData.get('route_start_lat') as string;
    const lngVal = formData.get('route_start_lng') as string;
    const data: Record<string, string | number | null> = {
      navn: formData.get('navn') as string,
      dato_modus: (formData.get('dato_modus') as string) || 'full_date',
      company_address: (formData.get('company_address') as string) || null,
      company_postnummer: (formData.get('company_postnummer') as string) || null,
      company_poststed: (formData.get('company_poststed') as string) || null,
      route_start_lat: latVal ? parseFloat(latVal) : null,
      route_start_lng: lngVal ? parseFloat(lngVal) : null,
    };

    try {
      const res = await fetch('/api/dashboard/organization', {
        method: 'PUT',
        headers: csrfHeaders(),
        body: JSON.stringify(data),
      });

      const result = await res.json();

      saveStatus?.classList.remove('hidden');

      if (!res.ok) {
        saveError!.textContent = result.error || 'Kunne ikke lagre endringer';
        saveError?.classList.remove('hidden');
        return;
      }

      saveSuccess?.classList.remove('hidden');

      // Hide success message after 3 seconds
      setTimeout(() => {
        saveStatus?.classList.add('hidden');
      }, 3000);
    } catch (err) {
      saveStatus?.classList.remove('hidden');
      saveError!.textContent = 'Nettverksfeil. Prøv igjen.';
      saveError?.classList.remove('hidden');
    } finally {
      saveBtn?.removeAttribute('disabled');
      saveBtn!.textContent = 'Lagre endringer';
    }
  });

  // Delete organization (placeholder - would need confirmation flow)
  deleteOrgBtn?.addEventListener('click', () => {
    alert('For å slette organisasjonen, vennligst kontakt support på support@skyplanner.no');
  });

  // Address autocomplete
  const addressInput = document.getElementById('company-address') as HTMLInputElement;
  const suggestionsContainer = document.getElementById('address-suggestions');
  const geocodeBtn = document.getElementById('geocode-btn');
  const geocodeStatus = document.getElementById('geocode-status');
  const routeStartLat = document.getElementById('route-start-lat') as HTMLInputElement;
  const routeStartLng = document.getElementById('route-start-lng') as HTMLInputElement;
  const postnummerInput = document.getElementById('company-postnummer') as HTMLInputElement;
  const poststedInput = document.getElementById('company-poststed') as HTMLInputElement;

  let debounceTimer: ReturnType<typeof setTimeout> | null = null;
  let abortController: AbortController | null = null;
  let activeSuggestionIndex = -1;

  function positionDropdown() {
    // No-op: dropdown uses position:absolute inside a relative wrapper,
    // so it automatically stays below the input field.
  }

  function hideSuggestions() {
    if (suggestionsContainer) {
      suggestionsContainer.style.display = 'none';
      suggestionsContainer.innerHTML = '';
    }
    activeSuggestionIndex = -1;
  }

  function selectSuggestion(s: { adresse: string; postnummer: string; poststed: string; lat: number; lng: number; kommune?: string }) {
    if (addressInput) addressInput.value = s.adresse;
    if (postnummerInput) postnummerInput.value = s.postnummer || '';
    if (poststedInput) poststedInput.value = s.poststed || '';
    if (routeStartLat) routeStartLat.value = s.lat.toFixed(7);
    if (routeStartLng) routeStartLng.value = s.lng.toFixed(7);
    if (geocodeStatus) {
      geocodeStatus.textContent = `Koordinater satt: ${s.lat.toFixed(5)}, ${s.lng.toFixed(5)}`;
      geocodeStatus.className = 'text-xs text-green-400 mt-1';
    }
    hideSuggestions();
  }

  function renderSuggestions(suggestions: Array<{ adresse: string; postnummer: string; poststed: string; lat: number; lng: number; kommune?: string }>) {
    if (!suggestionsContainer || suggestions.length === 0) {
      hideSuggestions();
      return;
    }
    activeSuggestionIndex = -1;
    suggestionsContainer.innerHTML = suggestions.map((s, i) => {
      const sub = [s.postnummer, s.poststed, s.kommune].filter(Boolean).join(', ');
      return `<button type="button" data-idx="${i}" style="display:block;width:100%;text-align:left;padding:10px 16px;border:none;background:none;cursor:pointer;border-bottom:1px solid #2d2d44;">
        <div style="font-size:14px;color:#e0e0e0;">${s.adresse}</div>
        ${sub ? `<div style="font-size:12px;color:#888;margin-top:2px;">${sub}</div>` : ''}
      </button>`;
    }).join('');

    positionDropdown();
    suggestionsContainer.style.display = 'block';

    // Bind click & hover handlers
    suggestionsContainer.querySelectorAll('button').forEach((btn, i) => {
      btn.addEventListener('click', () => selectSuggestion(suggestions[i]));
      btn.addEventListener('mouseenter', () => {
        btn.style.background = '#2a2a3e';
      });
      btn.addEventListener('mouseleave', () => {
        btn.style.background = 'none';
      });
    });
  }

  // Client-side cache for address search results
  const addressSearchCache = new Map<string, { results: Array<any>; ts: number }>();
  const ADDRESS_CACHE_MAX = 50;
  const ADDRESS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

  function getCachedAddressSearch(key: string) {
    const entry = addressSearchCache.get(key);
    if (!entry) return null;
    if (Date.now() - entry.ts > ADDRESS_CACHE_TTL) {
      addressSearchCache.delete(key);
      return null;
    }
    return entry.results;
  }

  function setCachedAddressSearch(key: string, results: any[]) {
    if (addressSearchCache.size >= ADDRESS_CACHE_MAX) {
      const firstKey = addressSearchCache.keys().next().value;
      if (firstKey) addressSearchCache.delete(firstKey);
    }
    addressSearchCache.set(key, { results, ts: Date.now() });
  }

  function parseKartverketResults(data: any): Array<{ adresse: string; postnummer: string; poststed: string; lat: number; lng: number; kommune: string }> {
    if (!data.adresser || data.adresser.length === 0) return [];
    return data.adresser
      .filter((addr: any) => addr.representasjonspunkt)
      .map((addr: any) => ({
        adresse: addr.adressetekst || '',
        postnummer: addr.postnummer || '',
        poststed: addr.poststed || '',
        lat: addr.representasjonspunkt.lat,
        lng: addr.representasjonspunkt.lon,
        kommune: addr.kommunenavn || ''
      }));
  }

  function showAddressSearchLoading() {
    if (!suggestionsContainer) return;
    suggestionsContainer.innerHTML = `<div style="padding:12px 16px;text-align:center;color:#888;font-size:13px;">
      <i class="fas fa-spinner fa-spin" style="margin-right:6px;"></i> Søker...
    </div>`;
    positionDropdown();
    suggestionsContainer.style.display = 'block';
  }

  async function searchAddress(query: string) {
    if (query.length < 2) {
      hideSuggestions();
      return;
    }

    // Check client-side cache first
    const cacheKey = query.trim().toLowerCase();
    const cached = getCachedAddressSearch(cacheKey);
    if (cached) {
      renderSuggestions(cached);
      (addressInput as any)._suggestions = cached;
      return;
    }

    // Cancel previous request
    if (abortController) abortController.abort();
    abortController = new AbortController();
    const signal = abortController.signal;

    const encoded = encodeURIComponent(query.trim());

    // Show loading indicator
    showAddressSearchLoading();

    // Try Kartverket exact search first (fast, public, no API key needed)
    try {
      const response = await fetch(
        `https://ws.geonorge.no/adresser/v1/sok?sok=${encoded}&treffPerSide=5`,
        { signal }
      );
      if (response.ok) {
        const results = parseKartverketResults(await response.json());
        if (results.length > 0) {
          setCachedAddressSearch(cacheKey, results);
          renderSuggestions(results);
          (addressInput as any)._suggestions = results;
          return;
        }
      }
    } catch (err: any) {
      if (err?.name === 'AbortError') return;
    }

    // Fallback: Kartverket fuzzy search (catches typos)
    try {
      const response = await fetch(
        `https://ws.geonorge.no/adresser/v1/sok?sok=${encoded}&fuzzy=true&treffPerSide=5`,
        { signal }
      );
      if (response.ok) {
        const results = parseKartverketResults(await response.json());
        if (results.length > 0) {
          setCachedAddressSearch(cacheKey, results);
          renderSuggestions(results);
          (addressInput as any)._suggestions = results;
          return;
        }
      }
    } catch (err: any) {
      if (err?.name === 'AbortError') return;
    }

    // Last resort: backend proxy (Mapbox)
    try {
      await ensureBackendCsrf();
      const res = await fetch('/api/app/geocode/forward', {
        method: 'POST',
        headers: backendCsrfHeaders(),
        credentials: 'include',
        body: JSON.stringify({ query, limit: 5 }),
        signal,
      });
      if (!res.ok) { hideSuggestions(); return; }
      const data = await res.json();
      const suggestions = data?.data?.suggestions || [];
      if (suggestions.length > 0) {
        setCachedAddressSearch(cacheKey, suggestions);
      }
      renderSuggestions(suggestions);
      (addressInput as any)._suggestions = suggestions;
    } catch (err: any) {
      if (err?.name !== 'AbortError') {
        hideSuggestions();
      }
    }
  }

  addressInput?.addEventListener('input', () => {
    const val = addressInput.value.trim();
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => searchAddress(val), 150);
  });

  addressInput?.addEventListener('keydown', (e) => {
    const items = suggestionsContainer?.querySelectorAll('button') || [];
    if (items.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeSuggestionIndex = Math.min(activeSuggestionIndex + 1, items.length - 1);
      items.forEach((el, i) => { (el as HTMLElement).style.background = i === activeSuggestionIndex ? '#2a2a3e' : 'none'; });
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeSuggestionIndex = Math.max(activeSuggestionIndex - 1, 0);
      items.forEach((el, i) => { (el as HTMLElement).style.background = i === activeSuggestionIndex ? '#2a2a3e' : 'none'; });
    } else if (e.key === 'Enter' && activeSuggestionIndex >= 0) {
      e.preventDefault();
      const suggestions = (addressInput as any)._suggestions || [];
      if (suggestions[activeSuggestionIndex]) {
        selectSuggestion(suggestions[activeSuggestionIndex]);
      }
    } else if (e.key === 'Escape') {
      hideSuggestions();
    }
  });

  // Close suggestions when clicking outside
  document.addEventListener('click', (e) => {
    if (!addressInput?.contains(e.target as Node) && !suggestionsContainer?.contains(e.target as Node)) {
      hideSuggestions();
    }
  });

  // Manual geocode button
  geocodeBtn?.addEventListener('click', async () => {
    const address = addressInput?.value?.trim() || '';
    const postnummer = postnummerInput?.value?.trim() || '';
    const poststed = poststedInput?.value?.trim() || '';

    const searchQuery = [address, postnummer, poststed].filter(Boolean).join(', ');

    if (!searchQuery) {
      if (geocodeStatus) geocodeStatus.textContent = 'Fyll inn adresse først.';
      return;
    }

    if (geocodeStatus) {
      geocodeStatus.textContent = 'Søker...';
      geocodeStatus.className = 'text-xs text-dark-400 mt-1';
    }

    // Try Kartverket directly first (fast)
    try {
      const url = `https://ws.geonorge.no/adresser/v1/sok?sok=${encodeURIComponent(searchQuery)}&fuzzy=true&treffPerSide=1`;
      const res = await fetch(url);
      if (res.ok) {
        const data = await res.json();
        const addr = data.adresser?.[0];
        if (addr?.representasjonspunkt) {
          routeStartLat.value = addr.representasjonspunkt.lat.toFixed(7);
          routeStartLng.value = addr.representasjonspunkt.lon.toFixed(7);
          if (geocodeStatus) {
            geocodeStatus.textContent = `Funnet: ${addr.adressetekst || searchQuery}`;
            geocodeStatus.className = 'text-xs text-green-400 mt-1';
          }
          return;
        }
      }
    } catch { /* fall through to backend */ }

    // Fallback to backend proxy (Mapbox)
    try {
      await ensureBackendCsrf();
      const res = await fetch('/api/app/geocode/forward', {
        method: 'POST',
        headers: backendCsrfHeaders(),
        credentials: 'include',
        body: JSON.stringify({ query: searchQuery, limit: 1 }),
      });

      if (!res.ok) throw new Error('Request failed');
      const data = await res.json();
      const suggestions = data?.data?.suggestions || [];

      if (suggestions.length > 0) {
        const s = suggestions[0];
        routeStartLat.value = s.lat.toFixed(7);
        routeStartLng.value = s.lng.toFixed(7);
        if (geocodeStatus) {
          geocodeStatus.textContent = `Funnet: ${s.adresse}, ${s.postnummer} ${s.poststed}`;
          geocodeStatus.className = 'text-xs text-green-400 mt-1';
        }
      } else {
        if (geocodeStatus) {
          geocodeStatus.textContent = 'Fant ingen resultater. Prøv en annen adresse eller fyll inn koordinater manuelt.';
          geocodeStatus.className = 'text-xs text-amber-400 mt-1';
        }
      }
    } catch {
      if (geocodeStatus) {
        geocodeStatus.textContent = 'Feil ved oppslag. Prøv igjen eller fyll inn koordinater manuelt.';
        geocodeStatus.className = 'text-xs text-red-400 mt-1';
      }
    }
  });
</script>
