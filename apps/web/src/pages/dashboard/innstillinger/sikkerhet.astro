---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { requireAuth, isAuthError } from '../../../middleware/auth';
import * as db from '@skyplanner/database';

// Initialize Supabase client
db.getSupabaseClient({
  supabaseUrl: import.meta.env.SUPABASE_URL,
  supabaseKey: import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.SUPABASE_ANON_KEY,
});

// Auth check
const authResult = await requireAuth(Astro);
if (isAuthError(authResult)) return authResult;

const { user, organization } = authResult;

const isFullMode = (organization as any).app_mode === 'full';
---

<DashboardLayout
  title="Sikkerhet"
  user={user}
  organization={organization}
  currentPath="/dashboard/innstillinger"
>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-white mb-2">Innstillinger</h1>
    <p class="text-dark-400">Administrer sikkerhet og tofaktorautentisering.</p>
  </div>

  <!-- Settings Navigation -->
  <div class="mb-8 flex flex-wrap gap-2">
    <a href="/dashboard/innstillinger" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Generelt
    </a>
    {isFullMode && (
      <>
        <a href="/dashboard/innstillinger/integrasjoner" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
          Integrasjoner
        </a>
        <a href="/dashboard/innstillinger/api-nokler" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
          API-nøkler
        </a>
        <a href="/dashboard/innstillinger/webhooks" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
          Webhooks
        </a>
      </>
    )}
    <a href="/dashboard/innstillinger/sikkerhet" class="px-4 py-2 rounded-xl bg-primary-500/10 text-primary-400 border border-primary-500/20 font-medium text-sm">
      Sikkerhet
    </a>
    <a href="/dashboard/innstillinger/personvern" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Personvern
    </a>
  </div>

  <!-- 2FA Section -->
  <div class="glass-card p-6 mb-6">
    <div class="flex items-start justify-between mb-6">
      <div>
        <h2 class="text-lg font-semibold text-white mb-1">Tofaktorautentisering (2FA)</h2>
        <p class="text-dark-400 text-sm">Legg til et ekstra sikkerhetslag med en autentiseringsapp.</p>
      </div>
      <div id="status-badge"></div>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="flex items-center gap-3 text-dark-400">
      <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      Henter status...
    </div>

    <!-- Disabled state -->
    <div id="disabled-state" class="hidden">
      <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-4 mb-6">
        <div class="flex gap-3">
          <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
          </svg>
          <div>
            <p class="text-amber-300 font-medium text-sm">2FA er ikke aktivert</p>
            <p class="text-amber-400/70 text-sm mt-1">Vi anbefaler sterkt at du aktiverer tofaktorautentisering for ekstra sikkerhet.</p>
          </div>
        </div>
      </div>
      <button id="btn-enable" class="btn-primary">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
        Aktiver 2FA
      </button>
    </div>

    <!-- Enabled state -->
    <div id="enabled-state" class="hidden">
      <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-4 mb-6">
        <div class="flex gap-3">
          <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
          <div>
            <p class="text-green-300 font-medium text-sm">2FA er aktivert</p>
            <p class="text-green-400/70 text-sm mt-1">
              Aktivert: <span id="enabled-date"></span>
              &bull; Reservekoder igjen: <span id="backup-count" class="font-medium"></span>
            </p>
          </div>
        </div>
      </div>
      <button id="btn-disable" class="px-4 py-2 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-colors font-medium text-sm">
        Deaktiver 2FA
      </button>
    </div>
  </div>

  <!-- Setup Modal -->
  <div id="setup-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="setup-overlay"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto">
        <button id="setup-close" class="absolute top-4 right-4 text-dark-400 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- Step 1: QR Code -->
        <div id="step-qr" class="hidden">
          <h3 class="text-lg font-semibold text-white mb-2">Skann QR-koden</h3>
          <p class="text-dark-400 text-sm mb-4">
            Bruk en autentiseringsapp (Google Authenticator, Authy, 1Password) for å skanne koden.
          </p>
          <div class="flex justify-center mb-4 bg-white rounded-xl p-4">
            <img id="qr-image" width="200" height="200" alt="QR-kode for 2FA" />
          </div>
          <details class="mb-4">
            <summary class="text-dark-400 text-sm cursor-pointer hover:text-dark-300">Kan du ikke skanne? Skriv inn manuelt</summary>
            <div class="mt-2 bg-dark-800/50 rounded-lg p-3">
              <code id="manual-secret" class="text-primary-400 text-sm break-all"></code>
            </div>
          </details>
          <button id="btn-next-backup" class="btn-primary w-full">Neste: Reservekoder</button>
        </div>

        <!-- Step 2: Backup Codes -->
        <div id="step-backup" class="hidden">
          <h3 class="text-lg font-semibold text-white mb-2">Lagre reservekodene</h3>
          <p class="text-dark-400 text-sm mb-4">
            Lagre disse kodene et trygt sted. Du kan bruke dem hvis du mister tilgang til autentiseringsappen.
          </p>
          <div class="bg-dark-800/50 rounded-xl p-4 mb-4">
            <div id="backup-codes-grid" class="grid grid-cols-2 gap-2 font-mono text-sm text-white"></div>
          </div>
          <button id="btn-copy-codes" class="w-full mb-3 px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
            Kopier alle koder
          </button>
          <button id="btn-next-verify" class="btn-primary w-full">Neste: Verifiser</button>
        </div>

        <!-- Step 3: Verify -->
        <div id="step-verify" class="hidden">
          <h3 class="text-lg font-semibold text-white mb-2">Verifiser oppsettet</h3>
          <p class="text-dark-400 text-sm mb-4">
            Skriv inn den 6-sifrede koden fra autentiseringsappen din.
          </p>
          <div class="mb-4">
            <input
              type="text"
              id="verify-code"
              class="input w-full text-center text-2xl tracking-[0.5em] font-mono"
              maxlength="6"
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="000000"
              autocomplete="one-time-code"
            />
            <p id="verify-error" class="text-red-400 text-sm mt-2 hidden"></p>
          </div>
          <button id="btn-verify" class="btn-primary w-full">Aktiver 2FA</button>
        </div>

        <!-- Step 4: Success -->
        <div id="step-success" class="hidden text-center">
          <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">2FA er aktivert!</h3>
          <p class="text-dark-400 text-sm mb-6">
            Kontoen din er nå beskyttet med tofaktorautentisering.
          </p>
          <button id="btn-done" class="btn-primary">Ferdig</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Disable Modal -->
  <div id="disable-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="disable-overlay"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-md p-6 relative">
        <h3 class="text-lg font-semibold text-white mb-2">Deaktiver 2FA</h3>
        <p class="text-dark-400 text-sm mb-4">
          Dette vil fjerne det ekstra sikkerhetslaget fra kontoen din. Skriv inn passordet ditt for å bekrefte.
        </p>
        <div class="mb-4">
          <label class="input-label" for="disable-password">Passord</label>
          <input type="password" id="disable-password" class="input w-full" placeholder="Ditt passord" />
          <p id="disable-error" class="text-red-400 text-sm mt-2 hidden"></p>
        </div>
        <div class="flex gap-3">
          <button id="btn-cancel-disable" class="flex-1 px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
            Avbryt
          </button>
          <button id="btn-confirm-disable" class="flex-1 px-4 py-2 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-colors font-medium text-sm">
            Deaktiver
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    (function() {
      // State
      let setupData = null;

      // Elements
      const loadingState = document.getElementById('loading-state');
      const disabledState = document.getElementById('disabled-state');
      const enabledState = document.getElementById('enabled-state');
      const statusBadge = document.getElementById('status-badge');
      const setupModal = document.getElementById('setup-modal');
      const disableModal = document.getElementById('disable-modal');

      // Fetch 2FA status
      async function fetchStatus() {
        try {
          const res = await fetch('/api/dashboard/2fa/status');
          const data = await res.json();
          loadingState.classList.add('hidden');

          if (data.success && data.data.enabled) {
            showEnabledState(data.data);
          } else {
            showDisabledState();
          }
        } catch (err) {
          loadingState.innerHTML = '<p class="text-red-400 text-sm">Kunne ikke hente status. Prøv å laste siden på nytt.</p>';
        }
      }

      function showDisabledState() {
        disabledState.classList.remove('hidden');
        enabledState.classList.add('hidden');
        statusBadge.innerHTML = '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-dark-800/50 text-dark-400 border border-dark-700"><span class="w-1.5 h-1.5 rounded-full bg-dark-500 mr-1.5"></span>Inaktiv</span>';
      }

      function showEnabledState(data) {
        disabledState.classList.add('hidden');
        enabledState.classList.remove('hidden');
        statusBadge.innerHTML = '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-500/10 text-green-400 border border-green-500/20"><span class="w-1.5 h-1.5 rounded-full bg-green-400 mr-1.5"></span>Aktiv</span>';

        if (data.enabledAt) {
          document.getElementById('enabled-date').textContent = new Date(data.enabledAt).toLocaleDateString('nb-NO');
        }
        if (data.backupCodesRemaining !== null) {
          document.getElementById('backup-count').textContent = data.backupCodesRemaining;
        }
      }

      // Setup flow
      function showStep(stepId) {
        ['step-qr', 'step-backup', 'step-verify', 'step-success'].forEach(function(id) {
          document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(stepId).classList.remove('hidden');
      }

      function openModal(modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closeModal(modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }

      // Enable 2FA button
      document.getElementById('btn-enable').addEventListener('click', async function() {
        openModal(setupModal);
        showStep('step-qr');

        try {
          const res = await fetch('/api/dashboard/2fa/setup', { method: 'POST' });
          const data = await res.json();

          if (!data.success) {
            alert(data.error || 'Noe gikk galt');
            closeModal(setupModal);
            return;
          }

          setupData = data.data;

          // Set QR code from server-generated data URL
          document.getElementById('qr-image').src = data.data.qrDataUrl;

          // Show manual secret
          document.getElementById('manual-secret').textContent = data.data.secret;

          // Populate backup codes
          var grid = document.getElementById('backup-codes-grid');
          grid.innerHTML = '';
          data.data.backupCodes.forEach(function(code) {
            var el = document.createElement('div');
            el.className = 'bg-dark-900/50 rounded px-3 py-2 text-center';
            el.textContent = code;
            grid.appendChild(el);
          });
        } catch (err) {
          alert('Kunne ikke starte 2FA-oppsett');
          closeModal(setupModal);
        }
      });

      // Navigation buttons
      document.getElementById('btn-next-backup').addEventListener('click', function() {
        showStep('step-backup');
      });

      document.getElementById('btn-copy-codes').addEventListener('click', function() {
        if (setupData && setupData.backupCodes) {
          navigator.clipboard.writeText(setupData.backupCodes.join('\n')).then(function() {
            var btn = document.getElementById('btn-copy-codes');
            btn.textContent = 'Kopiert!';
            setTimeout(function() { btn.textContent = 'Kopier alle koder'; }, 2000);
          });
        }
      });

      document.getElementById('btn-next-verify').addEventListener('click', function() {
        showStep('step-verify');
        document.getElementById('verify-code').focus();
      });

      // Verify code
      document.getElementById('btn-verify').addEventListener('click', async function() {
        var code = document.getElementById('verify-code').value.trim();
        var errorEl = document.getElementById('verify-error');
        errorEl.classList.add('hidden');

        if (code.length !== 6 || !/^\d{6}$/.test(code)) {
          errorEl.textContent = 'Koden må være 6 siffer';
          errorEl.classList.remove('hidden');
          return;
        }

        var btn = document.getElementById('btn-verify');
        btn.disabled = true;
        btn.textContent = 'Verifiserer...';

        try {
          var res = await fetch('/api/dashboard/2fa/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
          });
          var data = await res.json();

          if (data.success) {
            showStep('step-success');
          } else {
            errorEl.textContent = data.error || 'Feil kode. Prøv igjen.';
            errorEl.classList.remove('hidden');
          }
        } catch (err) {
          errorEl.textContent = 'Noe gikk galt. Prøv igjen.';
          errorEl.classList.remove('hidden');
        }

        btn.disabled = false;
        btn.textContent = 'Aktiver 2FA';
      });

      // Enter key in verify input
      document.getElementById('verify-code').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('btn-verify').click();
      });

      // Done button
      document.getElementById('btn-done').addEventListener('click', function() {
        closeModal(setupModal);
        fetchStatus();
      });

      // Close setup modal
      document.getElementById('setup-close').addEventListener('click', function() {
        closeModal(setupModal);
      });
      document.getElementById('setup-overlay').addEventListener('click', function() {
        closeModal(setupModal);
      });

      // Disable flow
      document.getElementById('btn-disable').addEventListener('click', function() {
        openModal(disableModal);
        document.getElementById('disable-password').value = '';
        document.getElementById('disable-error').classList.add('hidden');
        document.getElementById('disable-password').focus();
      });

      document.getElementById('btn-cancel-disable').addEventListener('click', function() {
        closeModal(disableModal);
      });
      document.getElementById('disable-overlay').addEventListener('click', function() {
        closeModal(disableModal);
      });

      document.getElementById('btn-confirm-disable').addEventListener('click', async function() {
        var password = document.getElementById('disable-password').value;
        var errorEl = document.getElementById('disable-error');
        errorEl.classList.add('hidden');

        if (!password) {
          errorEl.textContent = 'Passord er påkrevd';
          errorEl.classList.remove('hidden');
          return;
        }

        var btn = document.getElementById('btn-confirm-disable');
        btn.disabled = true;
        btn.textContent = 'Deaktiverer...';

        try {
          var res = await fetch('/api/dashboard/2fa/disable', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password }),
          });
          var data = await res.json();

          if (data.success) {
            closeModal(disableModal);
            fetchStatus();
          } else {
            errorEl.textContent = data.error || 'Deaktivering feilet';
            errorEl.classList.remove('hidden');
          }
        } catch (err) {
          errorEl.textContent = 'Noe gikk galt. Prøv igjen.';
          errorEl.classList.remove('hidden');
        }

        btn.disabled = false;
        btn.textContent = 'Deaktiver';
      });

      // Enter key in disable password input
      document.getElementById('disable-password').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('btn-confirm-disable').click();
      });

      // Init
      fetchStatus();
    })();
  </script>
</DashboardLayout>
