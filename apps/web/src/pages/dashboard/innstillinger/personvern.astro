---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { requireAuth, isAuthError } from '../../../middleware/auth';
import * as db from '@skyplanner/database';

// Initialize Supabase client
db.getSupabaseClient({
  supabaseUrl: import.meta.env.SUPABASE_URL,
  supabaseKey: import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.SUPABASE_ANON_KEY,
});

// Auth check
const authResult = await requireAuth(Astro);
if (isAuthError(authResult)) return authResult;

const { user, organization } = authResult;

const isFullMode = (organization as any).app_mode === 'full';
const appUrl = import.meta.env.APP_API_URL || (import.meta.env.PROD ? 'https://app.skyplanner.no' : 'http://localhost:3000');
---

<DashboardLayout
  title="Personvern"
  user={user}
  organization={organization}
  currentPath="/dashboard/innstillinger"
>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-white mb-2">Innstillinger</h1>
    <p class="text-dark-400">Personvern og databehandling.</p>
  </div>

  <!-- Settings Navigation -->
  <div class="mb-8 flex flex-wrap gap-2">
    <a href="/dashboard/innstillinger" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Generelt
    </a>
    {isFullMode && (
      <>
        <a href="/dashboard/innstillinger/integrasjoner" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
          Integrasjoner
        </a>
        <a href="/dashboard/innstillinger/api-nokler" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
          API-nøkler
        </a>
        <a href="/dashboard/innstillinger/webhooks" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
          Webhooks
        </a>
      </>
    )}
    <a href="/dashboard/innstillinger/sikkerhet" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Sikkerhet
    </a>
    <a href="/dashboard/innstillinger/personvern" class="px-4 py-2 rounded-xl bg-primary-500/10 text-primary-400 border border-primary-500/20 font-medium text-sm">
      Personvern
    </a>
  </div>

  <!-- Loading -->
  <div id="loading-state" class="glass-card p-8 text-center">
    <svg class="w-6 h-6 text-primary-400 animate-spin mx-auto mb-3" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
    </svg>
    <p class="text-dark-400 text-sm">Henter status...</p>
  </div>

  <!-- Pending Deletion Banner -->
  <div id="pending-banner" class="hidden mb-6">
    <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-5">
      <div class="flex gap-3">
        <svg class="w-6 h-6 text-red-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        <div class="flex-1">
          <p class="text-red-300 font-semibold">Kontosletting er planlagt</p>
          <p class="text-red-400/70 text-sm mt-1">
            Kontoen og alle data vil bli permanent slettet <span id="deletion-date" class="font-medium text-red-300"></span>.
            <span id="days-remaining" class="font-medium"></span>
          </p>
          <p class="text-red-400/70 text-sm mt-2">
            Du kan angre slettingen frem til denne datoen. Etter det er slettingen permanent.
          </p>
          <button id="btn-cancel-deletion" class="mt-4 px-4 py-2 rounded-xl bg-white/10 text-white border border-white/20 hover:bg-white/20 transition-colors font-medium text-sm">
            Angre sletting
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content (hidden during loading) -->
  <div id="main-content" class="hidden space-y-6">
    <!-- Data Export Section -->
    <div class="glass-card p-6">
      <div class="flex items-start gap-4">
        <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
        </div>
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-white mb-1">Eksporter data</h2>
          <p class="text-dark-400 text-sm mb-4">
            Last ned alle dine data i JSON-format. Eksporten inkluderer kunder, ruter, avtaler og kontaktlogger.
            Dette er i tråd med GDPR artikkel 20 (rett til dataportabilitet).
          </p>
          <a
            href={`${appUrl}/api/export/all`}
            target="_blank"
            class="inline-flex items-center px-4 py-2 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500/20 transition-colors font-medium text-sm"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
            Eksporter mine data
          </a>
        </div>
      </div>
    </div>

    <!-- Privacy Info -->
    <div class="glass-card p-6">
      <h2 class="text-lg font-semibold text-white mb-4">Dine rettigheter</h2>
      <div class="space-y-3 text-sm text-dark-300">
        <div class="flex gap-3">
          <svg class="w-4 h-4 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span><strong class="text-white">Innsyn:</strong> Du kan når som helst se all data vi har om deg gjennom dashboard og eksportfunksjonen.</span>
        </div>
        <div class="flex gap-3">
          <svg class="w-4 h-4 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span><strong class="text-white">Retting:</strong> Du kan oppdatere dine opplysninger under Generelt-innstillinger.</span>
        </div>
        <div class="flex gap-3">
          <svg class="w-4 h-4 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span><strong class="text-white">Portabilitet:</strong> Eksporter dine data i maskinlesbart format (JSON).</span>
        </div>
        <div class="flex gap-3">
          <svg class="w-4 h-4 text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span><strong class="text-white">Sletting:</strong> Be om sletting av kontoen din med 30 dagers angrefrist.</span>
        </div>
      </div>
      <p class="text-dark-500 text-xs mt-4">
        Les vår fullstendige <a href="/personvern" class="text-primary-400 hover:text-primary-300">personvernerklæring</a> for mer informasjon.
      </p>
    </div>

    <!-- Danger Zone -->
    <div id="danger-zone" class="glass-card p-6 border-red-500/20">
      <h2 class="text-lg font-semibold text-red-400 mb-1">Faresone</h2>
      <p class="text-dark-400 text-sm mb-4">
        Sletting av kontoen vil permanent fjerne alle data inkludert kunder, ruter, avtaler og brukere.
        Du har en 30-dagers angrefrist etter at forespørselen er sendt.
      </p>
      <button id="btn-delete" class="px-4 py-2 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-colors font-medium text-sm">
        Slett konto og alle data
      </button>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="delete-overlay"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-md p-6 relative">
        <h3 class="text-lg font-semibold text-white mb-2">Slett konto</h3>
        <p class="text-dark-400 text-sm mb-2">
          Er du sikker på at du vil slette kontoen din? Følgende skjer:
        </p>
        <ul class="text-dark-400 text-sm mb-4 space-y-1 list-disc list-inside">
          <li>Abonnementet kanselleres</li>
          <li>30-dagers angrefrist starter</li>
          <li>Etter 30 dager slettes <strong class="text-white">alle data permanent</strong></li>
        </ul>
        <p class="text-amber-400 text-xs mb-4">Vi anbefaler at du eksporterer dataene dine før du fortsetter.</p>

        <div class="space-y-3 mb-4">
          <div>
            <label class="input-label" for="delete-reason">Grunn (valgfritt)</label>
            <select id="delete-reason" class="input w-full">
              <option value="">Velg en grunn...</option>
              <option value="for_dyrt">For dyrt</option>
              <option value="mangler_funksjoner">Mangler funksjoner</option>
              <option value="bytter_system">Bytter til annet system</option>
              <option value="legger_ned">Legger ned virksomheten</option>
              <option value="annet">Annet</option>
            </select>
          </div>
          <div>
            <label class="input-label" for="delete-password">Passord *</label>
            <input type="password" id="delete-password" class="input w-full" placeholder="Bekreft med passordet ditt" />
          </div>
          <p id="delete-error" class="text-red-400 text-sm hidden"></p>
        </div>

        <div class="flex gap-3">
          <button id="btn-cancel-delete" class="flex-1 px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
            Avbryt
          </button>
          <button id="btn-confirm-delete" class="flex-1 px-4 py-2 rounded-xl bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-colors font-medium text-sm">
            Ja, slett kontoen min
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    (function() {
      var loadingState = document.getElementById('loading-state');
      var pendingBanner = document.getElementById('pending-banner');
      var mainContent = document.getElementById('main-content');
      var dangerZone = document.getElementById('danger-zone');
      var deleteModal = document.getElementById('delete-modal');

      function openModal(modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
      function closeModal(modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }

      // Fetch deletion status
      async function fetchStatus() {
        try {
          var res = await fetch('/api/dashboard/delete-account');
          var data = await res.json();

          loadingState.classList.add('hidden');
          mainContent.classList.remove('hidden');

          if (data.hasPendingDeletion) {
            showPendingState(data);
          }
        } catch (err) {
          loadingState.innerHTML = '<p class="text-red-400 text-sm">Kunne ikke hente status.</p>';
        }
      }

      function showPendingState(data) {
        pendingBanner.classList.remove('hidden');
        dangerZone.classList.add('hidden');

        var date = new Date(data.scheduledDeletionAt);
        document.getElementById('deletion-date').textContent = date.toLocaleDateString('nb-NO', { day: 'numeric', month: 'long', year: 'numeric' });
        document.getElementById('days-remaining').textContent = '(' + data.daysRemaining + ' dager igjen)';
      }

      // Cancel deletion
      document.getElementById('btn-cancel-deletion').addEventListener('click', async function() {
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Angrer...';

        try {
          var res = await fetch('/api/dashboard/delete-account', { method: 'DELETE' });
          var data = await res.json();

          if (data.success) {
            pendingBanner.classList.add('hidden');
            dangerZone.classList.remove('hidden');
          } else {
            alert(data.error || 'Noe gikk galt');
          }
        } catch (err) {
          alert('Noe gikk galt. Prøv igjen.');
        }

        btn.disabled = false;
        btn.textContent = 'Angre sletting';
      });

      // Delete account flow
      document.getElementById('btn-delete').addEventListener('click', function() {
        openModal(deleteModal);
        document.getElementById('delete-password').value = '';
        document.getElementById('delete-reason').value = '';
        document.getElementById('delete-error').classList.add('hidden');
      });

      document.getElementById('btn-cancel-delete').addEventListener('click', function() {
        closeModal(deleteModal);
      });
      document.getElementById('delete-overlay').addEventListener('click', function() {
        closeModal(deleteModal);
      });

      document.getElementById('btn-confirm-delete').addEventListener('click', async function() {
        var password = document.getElementById('delete-password').value;
        var reason = document.getElementById('delete-reason').value;
        var errorEl = document.getElementById('delete-error');
        errorEl.classList.add('hidden');

        if (!password) {
          errorEl.textContent = 'Passord er påkrevd';
          errorEl.classList.remove('hidden');
          return;
        }

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Sletter...';

        try {
          var res = await fetch('/api/dashboard/delete-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirmPassword: password, reason: reason }),
          });
          var data = await res.json();

          if (data.success) {
            closeModal(deleteModal);
            showPendingState({
              scheduledDeletionAt: data.scheduledDeletionAt,
              daysRemaining: data.gracePeriodDays,
            });
          } else {
            errorEl.textContent = data.error || 'Sletting feilet';
            errorEl.classList.remove('hidden');
          }
        } catch (err) {
          errorEl.textContent = 'Noe gikk galt. Prøv igjen.';
          errorEl.classList.remove('hidden');
        }

        btn.disabled = false;
        btn.textContent = 'Ja, slett kontoen min';
      });

      // Enter key in password input
      document.getElementById('delete-password').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('btn-confirm-delete').click();
      });

      // Init
      fetchStatus();
    })();
  </script>
</DashboardLayout>
