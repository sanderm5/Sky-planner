---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { requireAuth, isAuthError } from '../../../middleware/auth';
import * as db from '@skyplanner/database';

// Initialize Supabase client
db.getSupabaseClient({
  supabaseUrl: import.meta.env.SUPABASE_URL,
  supabaseKey: import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.SUPABASE_ANON_KEY,
});

// Auth check
const authResult = await requireAuth(Astro);
if (isAuthError(authResult)) return authResult;

const { user, organization, payload } = authResult;

// Determine admin status
let isAdmin = false;
if (payload.type === 'bruker') {
  isAdmin = true;
} else {
  const currentKlient = await db.getKlientById(user.id);
  isAdmin = currentKlient?.rolle === 'admin';
}

const apiBaseUrl = '';
---

<DashboardLayout
  title="Kategorier"
  user={user}
  organization={organization}
  currentPath="/dashboard/innstillinger"
>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-white mb-2">Innstillinger</h1>
    <p class="text-dark-400">Administrer underkategorier for dine tjenester.</p>
  </div>

  <!-- Settings Navigation -->
  <div class="mb-8 flex flex-wrap gap-2">
    <a href="/dashboard/innstillinger" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Generelt
    </a>
    <a href="/dashboard/innstillinger/tjenester" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Tjenestekategorier
    </a>
    <a href="/dashboard/innstillinger/kategorier" class="px-4 py-2 rounded-xl bg-primary-500/10 text-primary-400 border border-primary-500/20 font-medium text-sm" aria-current="page">
      Kategorier
    </a>
    <a href="/dashboard/innstillinger/integrasjoner" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Integrasjoner
    </a>
    <a href="/dashboard/innstillinger/api-nokler" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      API-nokler
    </a>
    <a href="/dashboard/innstillinger/webhooks" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Webhooks
    </a>
    <a href="/dashboard/innstillinger/sikkerhet" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Sikkerhet
    </a>
    <a href="/dashboard/innstillinger/personvern" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Personvern
    </a>
  </div>

  <!-- Loading state -->
  <div id="loading" class="text-center py-12">
    <div class="inline-block w-8 h-8 border-2 border-primary-500/30 border-t-primary-500 rounded-full animate-spin mb-3"></div>
    <p class="text-dark-400 text-sm">Laster underkategorier...</p>
  </div>

  <!-- Empty state: no groups -->
  <div id="empty" class="hidden">
    <div class="glass-card p-6 text-center py-12">
      <div class="w-16 h-16 rounded-full bg-dark-700/50 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-tags text-2xl text-dark-500"></i>
      </div>
      <h3 class="text-white font-medium mb-2">Ingen underkategori-grupper</h3>
      <p class="text-dark-400 text-sm mb-4">Opprett en gruppe for a komme i gang med underkategorier.</p>
    </div>
  </div>

  <!-- Main content -->
  <div id="content" class="hidden space-y-6">
    <div id="service-types-container"></div>
  </div>

  <!-- Error state -->
  <div id="error" class="hidden text-center py-8" role="alert" aria-live="assertive">
    <p class="text-red-400 text-sm mb-3" id="error-msg">Kunne ikke laste underkategorier.</p>
    <button id="btn-retry" class="btn btn-secondary text-sm">Prov igjen</button>
  </div>

  <!-- Info box -->
  <div class="glass-card p-6 border-l-4 border-l-blue-500/50 mt-6">
    <h3 class="text-white font-medium mb-2"><i class="fas fa-info-circle text-blue-400 mr-2"></i>Om underkategorier</h3>
    <ul class="text-dark-400 text-sm space-y-1.5">
      <li>Underkategorier lar deg gruppere og filtrere kunder.</li>
      <li>Eksempel: Gruppen "Bygningstype" med verdiene "Bolig", "Naering", "Landbruk".</li>
      <li>Underkategorier brukes til filtrering i appen og vises i kundeskjemaet.</li>
      <li>Hver kunde kan ha en verdi per gruppe.</li>
    </ul>
  </div>

<script define:vars={{ apiBaseUrl, isAdmin }}>
  const tokenKey = 'skyplanner_token';
  let groups = [];

  function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function getCsrfToken() {
    const match = document.cookie.match(/(?:^|;\s*)csrf_token=([^;]*)/);
    return match ? match[1] : '';
  }

  function getHeaders(includeCsrf = false) {
    const token = localStorage.getItem(tokenKey) || getCookie('skyplanner_session');
    return {
      'Content-Type': 'application/json',
      ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
      ...(includeCsrf ? { 'X-CSRF-Token': getCsrfToken() } : {}),
    };
  }

  function getCookie(name) {
    const match = document.cookie.match(new RegExp(`${name}=([^;]+)`));
    return match ? match[1] : null;
  }

  async function loadData() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('content').classList.add('hidden');
    document.getElementById('empty').classList.add('hidden');
    document.getElementById('error').classList.add('hidden');

    try {
      const res = await fetch(`${apiBaseUrl}/api/app/subcategories/groups`, {
        headers: getHeaders(),
        credentials: 'include',
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error?.message || data.error || 'Feil ved lasting');

      groups = data.data || [];

      if (groups.length === 0) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('empty').classList.remove('hidden');
        // Still show add-group form for admins
        if (isAdmin) {
          document.getElementById('content').classList.remove('hidden');
          renderAll();
        }
        return;
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
      renderAll();
    } catch (err) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-msg').textContent = err.message || 'Kunne ikke laste underkategorier.';
    }
  }

  function renderAll() {
    const container = document.getElementById('service-types-container');
    const subcatCount = groups.reduce((sum, g) => sum + (g.subcategories ? g.subcategories.length : 0), 0);

    let html = '';

    if (groups.length > 0) {
      html += `<div class="glass-card p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-white font-semibold">Underkategorier</h3>
            <p class="text-dark-400 text-xs">${groups.length} ${groups.length === 1 ? 'gruppe' : 'grupper'}, ${subcatCount} ${subcatCount === 1 ? 'underkategori' : 'underkategorier'}</p>
          </div>
        </div>`;

      html += groups.map(group => `
        <div class="ml-2 mb-4 border-l-2 border-dark-600 pl-4">
          <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-folder text-dark-500 text-xs"></i>
            <span class="text-white text-sm font-medium">${escapeHtml(group.navn)}</span>
            <span class="text-dark-500 text-xs">(${group.subcategories ? group.subcategories.length : 0})</span>
            ${isAdmin ? `<button class="text-dark-400 hover:text-white p-1 transition-colors" data-action="editGroup" data-group-id="${group.id}" data-group-navn="${escapeHtml(group.navn)}" title="Gi nytt navn">
              <i class="fas fa-pen text-xs"></i>
            </button>
            <button class="text-dark-400 hover:text-red-400 p-1 transition-colors" data-action="deleteGroup" data-group-id="${group.id}" data-group-navn="${escapeHtml(group.navn)}" title="Slett gruppe">
              <i class="fas fa-trash text-xs"></i>
            </button>` : ''}
          </div>

          ${group.subcategories && group.subcategories.length > 0 ? group.subcategories.map(sub => `
            <div class="flex items-center gap-2 ml-4 py-1 group">
              <span class="w-1.5 h-1.5 rounded-full bg-dark-500"></span>
              <span class="text-dark-300 text-sm">${escapeHtml(sub.navn)}</span>
              ${isAdmin ? `<button class="text-dark-400 hover:text-white p-1 transition-colors opacity-0 group-hover:opacity-100" data-action="editSubcat" data-subcat-id="${sub.id}" data-subcat-navn="${escapeHtml(sub.navn)}" title="Gi nytt navn">
                <i class="fas fa-pen text-xs"></i>
              </button>
              <button class="text-dark-400 hover:text-red-400 p-1 transition-colors opacity-0 group-hover:opacity-100" data-action="deleteSubcat" data-subcat-id="${sub.id}" data-subcat-navn="${escapeHtml(sub.navn)}" title="Slett">
                <i class="fas fa-trash text-xs"></i>
              </button>` : ''}
            </div>
          `).join('') : '<p class="ml-4 text-dark-500 text-xs italic py-1">Ingen underkategorier enna</p>'}

          ${isAdmin ? `<div class="flex gap-2 ml-4 mt-2">
            <input type="text" placeholder="Ny underkategori..." class="input text-sm flex-1 py-1.5 px-3" data-add-subcat-input data-group-id="${group.id}" maxlength="100">
            <button class="btn btn-primary text-xs py-1.5 px-3" data-action="addSubcat" data-group-id="${group.id}">
              <i class="fas fa-plus mr-1"></i> Legg til
            </button>
          </div>` : ''}
        </div>
      `).join('');

      // Add new group form
      if (isAdmin) {
        html += `<div class="mt-2 pt-4 border-t border-dark-700/50">
          <div class="flex gap-2">
            <input type="text" placeholder="Ny gruppe..." class="input text-sm flex-1 py-1.5 px-3" data-add-group-input maxlength="100">
            <button class="btn btn-secondary text-xs py-1.5 px-3" data-action="addGroup">
              <i class="fas fa-plus mr-1"></i> Ny gruppe
            </button>
          </div>
        </div>`;
      }

      html += `</div>`;
    } else if (isAdmin) {
      // No groups yet, but admin can create
      html += `<div class="glass-card p-6">
        <div class="flex gap-2">
          <input type="text" placeholder="Ny gruppe..." class="input text-sm flex-1 py-1.5 px-3" data-add-group-input maxlength="100">
          <button class="btn btn-secondary text-xs py-1.5 px-3" data-action="addGroup">
            <i class="fas fa-plus mr-1"></i> Ny gruppe
          </button>
        </div>
      </div>`;
    }

    container.innerHTML = html;
  }

  // Event delegation for all actions
  document.getElementById('service-types-container')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;

    if (action === 'addGroup') {
      const input = document.querySelector('input[data-add-group-input]');
      const navn = input?.value?.trim();
      if (!navn) { input?.focus(); return; }

      btn.disabled = true;
      try {
        const res = await fetch(`${apiBaseUrl}/api/app/subcategories/groups`, {
          method: 'POST',
          headers: getHeaders(true),
          credentials: 'include',
          body: JSON.stringify({ navn }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || data.error || 'Kunne ikke opprette gruppe');
        await loadData();
      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    else if (action === 'editGroup') {
      const groupId = parseInt(btn.dataset.groupId, 10);
      const currentName = btn.dataset.groupNavn;
      const newName = prompt('Nytt navn for gruppen:', currentName);
      if (!newName || newName.trim() === currentName) return;

      try {
        const res = await fetch(`${apiBaseUrl}/api/app/subcategories/groups/${groupId}`, {
          method: 'PUT',
          headers: getHeaders(true),
          credentials: 'include',
          body: JSON.stringify({ navn: newName.trim() }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || data.error || 'Kunne ikke oppdatere gruppe');
        await loadData();
      } catch (err) {
        alert(err.message);
      }
    }

    else if (action === 'deleteGroup') {
      const groupId = parseInt(btn.dataset.groupId, 10);
      const navn = btn.dataset.groupNavn;
      if (!confirm(`Slett gruppen "${navn}"? Alle underkategorier i gruppen slettes ogsa.`)) return;

      try {
        const res = await fetch(`${apiBaseUrl}/api/app/subcategories/groups/${groupId}`, {
          method: 'DELETE',
          headers: getHeaders(true),
          credentials: 'include',
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || data.error || 'Kunne ikke slette gruppe');
        await loadData();
      } catch (err) {
        alert(err.message);
      }
    }

    else if (action === 'addSubcat') {
      const groupId = parseInt(btn.dataset.groupId, 10);
      const input = document.querySelector(`input[data-add-subcat-input][data-group-id="${groupId}"]`);
      const navn = input?.value?.trim();
      if (!navn) { input?.focus(); return; }

      btn.disabled = true;
      try {
        const res = await fetch(`${apiBaseUrl}/api/app/subcategories/items`, {
          method: 'POST',
          headers: getHeaders(true),
          credentials: 'include',
          body: JSON.stringify({ group_id: groupId, navn }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || data.error || 'Kunne ikke opprette underkategori');
        await loadData();
      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    else if (action === 'editSubcat') {
      const subcatId = parseInt(btn.dataset.subcatId, 10);
      const currentName = btn.dataset.subcatNavn;
      const newName = prompt('Nytt navn:', currentName);
      if (!newName || newName.trim() === currentName) return;

      try {
        const res = await fetch(`${apiBaseUrl}/api/app/subcategories/items/${subcatId}`, {
          method: 'PUT',
          headers: getHeaders(true),
          credentials: 'include',
          body: JSON.stringify({ navn: newName.trim() }),
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || data.error || 'Kunne ikke oppdatere underkategori');
        await loadData();
      } catch (err) {
        alert(err.message);
      }
    }

    else if (action === 'deleteSubcat') {
      const subcatId = parseInt(btn.dataset.subcatId, 10);
      const navn = btn.dataset.subcatNavn;
      if (!confirm(`Slett underkategorien "${navn}"?`)) return;

      try {
        const res = await fetch(`${apiBaseUrl}/api/app/subcategories/items/${subcatId}`, {
          method: 'DELETE',
          headers: getHeaders(true),
          credentials: 'include',
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error?.message || data.error || 'Kunne ikke slette underkategori');
        await loadData();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  // Enter key to submit inline inputs
  document.getElementById('service-types-container')?.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    const input = e.target;
    if (input.dataset.addGroupInput !== undefined) {
      const btn = document.querySelector('button[data-action="addGroup"]');
      btn?.click();
    } else if (input.dataset.addSubcatInput !== undefined) {
      const groupId = input.dataset.groupId;
      const btn = document.querySelector(`button[data-action="addSubcat"][data-group-id="${groupId}"]`);
      btn?.click();
    }
  });

  // Retry button
  document.getElementById('btn-retry')?.addEventListener('click', loadData);

  // Initial load
  loadData();
</script>
</DashboardLayout>
