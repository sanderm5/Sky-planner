---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { requireAuth, isAuthError } from '../../../middleware/auth';
import * as db from '@skyplanner/database';

// Initialize Supabase client
db.getSupabaseClient({
  supabaseUrl: import.meta.env.SUPABASE_URL,
  supabaseKey: import.meta.env.SUPABASE_SERVICE_KEY || import.meta.env.SUPABASE_ANON_KEY,
});

// Auth check
const authResult = await requireAuth(Astro);
if (isAuthError(authResult)) return authResult;

const { user, organization, payload } = authResult;

// API-nøkler er kun tilgjengelig for full mode (TRE Allservice)
if ((organization as any).app_mode !== 'full') {
  return Astro.redirect('/dashboard/innstillinger');
}

// Check if user is admin (bruker type = admin, klient type = regular user)
const isAdmin = payload.type === 'bruker';

// API base URL - use proxy in dev to avoid CORS issues
const apiBaseUrl = import.meta.env.PROD ? (import.meta.env.APP_API_URL || 'https://app.skyplanner.no') : '';

// Available scopes
const scopes = [
  { id: 'customers:read', label: 'Kunder (les)', description: 'Hent kundeinformasjon' },
  { id: 'customers:write', label: 'Kunder (skriv)', description: 'Opprett, oppdater og slett kunder' },
  { id: 'routes:read', label: 'Ruter (les)', description: 'Hent ruteinformasjon' },
  { id: 'routes:write', label: 'Ruter (skriv)', description: 'Opprett og oppdater ruter' },
  { id: 'appointments:read', label: 'Avtaler (les)', description: 'Hent avtaleinformasjon' },
  { id: 'appointments:write', label: 'Avtaler (skriv)', description: 'Opprett og oppdater avtaler' },
  { id: 'webhooks:manage', label: 'Webhooks', description: 'Administrer webhook-endepunkter' },
];
---

<DashboardLayout
  title="API-nøkler"
  user={user}
  organization={organization}
  currentPath="/dashboard/innstillinger"
>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-white mb-2">Innstillinger</h1>
    <p class="text-dark-400">Administrer organisasjonsinnstillinger og integrasjoner.</p>
  </div>

  <!-- Settings Navigation -->
  <div class="mb-8 flex flex-wrap gap-2">
    <a href="/dashboard/innstillinger" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Generelt
    </a>
    <a href="/dashboard/innstillinger/integrasjoner" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Integrasjoner
    </a>
    <a href="/dashboard/innstillinger/api-nokler" class="px-4 py-2 rounded-xl bg-primary-500/10 text-primary-400 border border-primary-500/20 font-medium text-sm">
      API-nøkler
    </a>
    <a href="/dashboard/innstillinger/webhooks" class="px-4 py-2 rounded-xl bg-dark-800/50 text-dark-300 border border-dark-700 hover:bg-dark-700/50 hover:text-white transition-colors font-medium text-sm">
      Webhooks
    </a>
  </div>

  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-lg font-semibold text-white mb-1">API-nøkler</h2>
      <p class="text-dark-400 text-sm">Administrer API-nøkler for tredjeparts-integrasjoner.</p>
    </div>
    {isAdmin && (
      <button id="btn-create" class="btn-primary">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Ny API-nøkkel
      </button>
    )}
  </div>

  {!isAdmin && (
    <div class="glass-card p-6 border border-yellow-500/30 mb-6">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>
          <h3 class="font-semibold text-white mb-1">Kun for administratorer</h3>
          <p class="text-dark-400 text-sm">Bare administratorer kan opprette og administrere API-nøkler.</p>
        </div>
      </div>
    </div>
  )}

  <!-- API Keys List -->
  <div id="keys-container" class="space-y-4">
    <div class="glass-card p-8 text-center">
      <svg class="w-8 h-8 text-primary-400 animate-spin mx-auto mb-4" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-dark-400">Laster API-nøkler...</p>
    </div>
  </div>

  <!-- Create Modal -->
  <div id="modal-create" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="overlay-create"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto">
        <button id="close-create" class="absolute top-4 right-4 text-dark-400 hover:text-white transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <h2 class="text-xl font-bold text-white mb-6">Opprett ny API-nøkkel</h2>

        <form id="form-create" class="space-y-6">
          <div>
            <label class="input-label" for="key-name">Navn *</label>
            <input
              type="text"
              id="key-name"
              name="name"
              class="input w-full"
              placeholder="F.eks. Min integrasjon"
              required
            />
          </div>

          <div>
            <label class="input-label" for="key-description">Beskrivelse</label>
            <input
              type="text"
              id="key-description"
              name="description"
              class="input w-full"
              placeholder="Valgfri beskrivelse"
            />
          </div>

          <div>
            <label class="input-label">Tilganger *</label>
            <p class="text-xs text-dark-400 mb-3">Velg hvilke tilganger denne nøkkelen skal ha.</p>
            <div class="space-y-2">
              {scopes.map(scope => (
                <label class="flex items-start gap-3 p-3 rounded-lg bg-dark-800/50 hover:bg-dark-800 cursor-pointer transition-colors">
                  <input
                    type="checkbox"
                    name="scopes"
                    value={scope.id}
                    class="mt-1 rounded bg-dark-700 border-dark-600 text-primary-500 focus:ring-primary-500"
                  />
                  <div>
                    <div class="text-white text-sm font-medium">{scope.label}</div>
                    <div class="text-dark-400 text-xs">{scope.description}</div>
                  </div>
                </label>
              ))}
            </div>
          </div>

          <div id="create-error" class="text-red-400 text-sm hidden"></div>

          <div class="flex gap-3">
            <button type="button" id="cancel-create" class="btn-secondary flex-1">Avbryt</button>
            <button type="submit" id="submit-create" class="btn-primary flex-1">Opprett</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Key Created Modal -->
  <div id="modal-key-created" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-lg p-6 relative">
        <div class="text-center mb-6">
          <div class="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold text-white mb-2">API-nøkkel opprettet!</h2>
          <p class="text-dark-400 text-sm">Kopier nøkkelen nå - den vises kun én gang.</p>
        </div>

        <div class="bg-dark-800/50 rounded-lg p-4 mb-6">
          <label class="text-xs text-dark-400 block mb-2">Din API-nøkkel</label>
          <div class="flex items-center gap-2">
            <code id="new-key-value" class="flex-1 text-primary-400 font-mono text-sm break-all"></code>
            <button id="copy-key" class="btn-secondary p-2" title="Kopier">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div class="text-sm">
              <p class="text-yellow-400 font-medium">Viktig!</p>
              <p class="text-dark-300">Lagre denne nøkkelen et trygt sted. Du kan ikke se den igjen etter at du lukker dette vinduet.</p>
            </div>
          </div>
        </div>

        <button id="close-key-created" class="btn-primary w-full">Jeg har lagret nøkkelen</button>
      </div>
    </div>
  </div>
</DashboardLayout>

<script define:vars={{ apiBaseUrl, isAdmin }}>
  // State
  let apiKeys = [];

  // DOM elements
  const container = document.getElementById('keys-container');
  const createBtn = document.getElementById('btn-create');
  const createModal = document.getElementById('modal-create');
  const keyCreatedModal = document.getElementById('modal-key-created');

  // Modal helpers
  function showModal(modal) {
    modal?.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
  }

  function hideModal(modal) {
    modal?.classList.add('hidden');
    document.body.classList.remove('overflow-hidden');
  }

  // Setup modal handlers
  document.getElementById('close-create')?.addEventListener('click', () => hideModal(createModal));
  document.getElementById('cancel-create')?.addEventListener('click', () => hideModal(createModal));
  document.getElementById('overlay-create')?.addEventListener('click', () => hideModal(createModal));
  document.getElementById('close-key-created')?.addEventListener('click', () => {
    hideModal(keyCreatedModal);
    loadApiKeys();
  });

  createBtn?.addEventListener('click', () => showModal(createModal));

  // Copy key to clipboard
  document.getElementById('copy-key')?.addEventListener('click', async () => {
    const keyValue = document.getElementById('new-key-value')?.textContent;
    if (keyValue) {
      await navigator.clipboard.writeText(keyValue);
      const btn = document.getElementById('copy-key');
      btn.innerHTML = `<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
      setTimeout(() => {
        btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`;
      }, 2000);
    }
  });

  // Render API keys
  function renderApiKeys() {
    if (!container) return;

    if (apiKeys.length === 0) {
      container.innerHTML = `
        <div class="glass-card p-8 text-center">
          <div class="w-16 h-16 rounded-full bg-dark-700/50 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">Ingen API-nøkler</h3>
          <p class="text-dark-400 mb-4">Du har ikke opprettet noen API-nøkler ennå.</p>
          ${isAdmin ? '<button id="empty-create" class="btn-primary">Opprett første nøkkel</button>' : ''}
        </div>
      `;

      document.getElementById('empty-create')?.addEventListener('click', () => showModal(createModal));
      return;
    }

    container.innerHTML = apiKeys.map(key => `
      <div class="glass-card p-6">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <h3 class="text-lg font-semibold text-white">${key.name}</h3>
              ${key.is_active
                ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-500/10 text-green-400">Aktiv</span>'
                : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-500/10 text-red-400">Deaktivert</span>'
              }
            </div>
            ${key.description ? `<p class="text-dark-400 text-sm mb-3">${key.description}</p>` : ''}
            <div class="flex flex-wrap gap-2 mb-3">
              ${key.scopes.map(scope => `
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-dark-700/50 text-dark-300">
                  ${scope}
                </span>
              `).join('')}
            </div>
            <div class="flex items-center gap-4 text-xs text-dark-400">
              <span>Prefix: <code class="text-primary-400">${key.key_prefix}...</code></span>
              ${key.last_used_at ? `<span>Sist brukt: ${new Date(key.last_used_at).toLocaleDateString('nb-NO')}</span>` : ''}
              <span>Opprettet: ${new Date(key.created_at).toLocaleDateString('nb-NO')}</span>
            </div>
          </div>
          ${isAdmin && key.is_active ? `
            <button
              class="btn-ghost text-sm text-red-400 hover:text-red-300"
              data-action="revoke"
              data-id="${key.id}"
              data-name="${key.name}"
            >
              Deaktiver
            </button>
          ` : ''}
        </div>
      </div>
    `).join('');

    // Add event listeners
    container.querySelectorAll('[data-action="revoke"]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        const name = e.target.dataset.name;
        if (confirm(`Er du sikker på at du vil deaktivere "${name}"? Dette kan ikke angres.`)) {
          await revokeKey(id);
        }
      });
    });
  }

  // Load API keys
  async function loadApiKeys() {
    try {
      const res = await fetch(`${apiBaseUrl}/api/app/api-keys`, {
        credentials: 'include',
      });

      const data = await res.json();

      if (data.success) {
        apiKeys = data.data;
        renderApiKeys();
      }
    } catch (err) {
      container.innerHTML = `
        <div class="glass-card p-8 text-center border border-red-500/30">
          <h3 class="text-lg font-semibold text-white mb-2">Kunne ikke laste API-nøkler</h3>
          <p class="text-dark-400 mb-4">Prøv å laste siden på nytt.</p>
          <button onclick="window.location.reload()" class="btn-secondary">Last inn på nytt</button>
        </div>
      `;
    }
  }

  // Create API key
  document.getElementById('form-create')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const scopes = formData.getAll('scopes');

    if (scopes.length === 0) {
      document.getElementById('create-error').textContent = 'Velg minst en tilgang';
      document.getElementById('create-error').classList.remove('hidden');
      return;
    }

    const submitBtn = document.getElementById('submit-create');
    submitBtn?.setAttribute('disabled', 'true');

    try {
      const res = await fetch(`${apiBaseUrl}/api/app/api-keys`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          name: formData.get('name'),
          description: formData.get('description') || undefined,
          scopes,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error?.message || data.message || 'Kunne ikke opprette nøkkel');
      }

      // Hide create modal
      hideModal(createModal);
      form.reset();

      // Show the key
      document.getElementById('new-key-value').textContent = data.data.key;
      showModal(keyCreatedModal);

    } catch (err) {
      document.getElementById('create-error').textContent = err.message;
      document.getElementById('create-error').classList.remove('hidden');
    } finally {
      submitBtn?.removeAttribute('disabled');
    }
  });

  // Revoke API key
  async function revokeKey(id) {
    try {
      const res = await fetch(`${apiBaseUrl}/api/app/api-keys/${id}/revoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ reason: 'Manuelt deaktivert av bruker' }),
      });

      if (!res.ok) {
        throw new Error('Kunne ikke deaktivere nøkkel');
      }

      await loadApiKeys();
    } catch (err) {
      alert(err.message);
    }
  }

  // Initial load
  loadApiKeys();
</script>
