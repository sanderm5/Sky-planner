---
import AuthLayout from '../../layouts/AuthLayout.astro';
import GlassCard from '../../components/ui/GlassCard.astro';
---

<AuthLayout title="Tofaktorverifisering">
  <GlassCard>
    <div class="text-center mb-8">
      <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-primary-500/20 flex items-center justify-center">
        <svg class="w-8 h-8 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2">Tofaktorverifisering</h1>
      <p class="text-dark-400">Skriv inn koden fra autentiseringsappen din</p>
    </div>

    <div id="error-message" class="form-error hidden" role="alert" aria-live="assertive"></div>

    <!-- TOTP Code Form -->
    <form id="totp-form" class="space-y-6">
      <div>
        <label for="totp-code" class="input-label">Engangskode</label>
        <input
          id="totp-code"
          type="text"
          inputmode="numeric"
          pattern="[0-9]{6}"
          maxlength="6"
          required
          autocomplete="one-time-code"
          class="input text-center text-2xl tracking-[0.5em] font-mono"
          placeholder="000000"
        />
      </div>

      <button type="submit" class="btn-primary w-full">
        <span id="btn-text">Verifiser</span>
        <span id="btn-loading" class="hidden">Verifiserer...</span>
      </button>
    </form>

    <!-- Backup code toggle -->
    <div class="mt-6 text-center">
      <button id="toggle-backup" class="text-sm text-primary-400 hover:text-primary-300 font-medium">
        Bruk reservekode i stedet
      </button>
    </div>

    <!-- Backup Code Form (hidden by default) -->
    <form id="backup-form" class="space-y-6 hidden">
      <div>
        <label for="backup-code" class="input-label">Reservekode</label>
        <input
          id="backup-code"
          type="text"
          required
          class="input text-center text-lg tracking-wider font-mono"
          placeholder="XXXX-XXXX"
        />
        <p class="text-xs text-dark-500 mt-2">Skriv inn en av reservekodene du fikk da du aktiverte 2FA</p>
      </div>

      <button type="submit" class="btn-primary w-full">
        <span id="backup-btn-text">Verifiser reservekode</span>
        <span id="backup-btn-loading" class="hidden">Verifiserer...</span>
      </button>
    </form>

    <div class="mt-6 text-center">
      <a href="/auth/login" class="text-sm text-dark-400 hover:text-dark-300">
        &larr; Tilbake til innlogging
      </a>
    </div>
  </GlassCard>
</AuthLayout>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const sessionToken = urlParams.get('session');

  if (!sessionToken) {
    window.location.href = '/auth/login';
  }

  const errorDiv = document.getElementById('error-message');
  const totpForm = document.getElementById('totp-form') as HTMLFormElement;
  const backupForm = document.getElementById('backup-form') as HTMLFormElement;
  const toggleBtn = document.getElementById('toggle-backup');

  let showingBackup = false;

  toggleBtn?.addEventListener('click', () => {
    showingBackup = !showingBackup;
    if (showingBackup) {
      totpForm?.classList.add('hidden');
      backupForm?.classList.remove('hidden');
      toggleBtn!.textContent = 'Bruk engangskode i stedet';
      (document.getElementById('backup-code') as HTMLInputElement)?.focus();
    } else {
      totpForm?.classList.remove('hidden');
      backupForm?.classList.add('hidden');
      toggleBtn!.textContent = 'Bruk reservekode i stedet';
      (document.getElementById('totp-code') as HTMLInputElement)?.focus();
    }
    errorDiv?.classList.add('hidden');
  });

  async function verify(code: string, btn: HTMLElement | null, btnLoading: HTMLElement | null) {
    btn?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorDiv?.classList.add('hidden');

    try {
      const response = await fetch('/api/auth/verify-2fa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionToken, code }),
        credentials: 'include',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Verifisering feilet');
      }

      if (data.usedBackupCode) {
        // Brief notice before redirect
        if (errorDiv) {
          errorDiv.textContent = 'Reservekode brukt. Du har fÃ¦rre reservekoder igjen.';
          errorDiv.classList.remove('hidden');
          errorDiv.style.borderColor = 'rgb(234 179 8)';
          errorDiv.style.color = 'rgb(234 179 8)';
        }
        await new Promise(r => setTimeout(r, 1500));
      }

      // Redirect to app
      if (data.appUrl && data.redirectUrl) {
        window.location.href = data.appUrl + data.redirectUrl;
      } else if (data.redirectUrl) {
        window.location.href = data.redirectUrl;
      } else {
        window.location.href = '/dashboard';
      }
    } catch (err) {
      if (errorDiv) {
        errorDiv.textContent = err instanceof Error ? err.message : 'Noe gikk galt';
        errorDiv.classList.remove('hidden');
        errorDiv.style.borderColor = '';
        errorDiv.style.color = '';
      }
    } finally {
      btn?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  }

  totpForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const code = (document.getElementById('totp-code') as HTMLInputElement).value.trim();
    verify(code, document.getElementById('btn-text'), document.getElementById('btn-loading'));
  });

  backupForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const code = (document.getElementById('backup-code') as HTMLInputElement).value.trim();
    verify(code, document.getElementById('backup-btn-text'), document.getElementById('backup-btn-loading'));
  });

  // Auto-focus the TOTP input
  (document.getElementById('totp-code') as HTMLInputElement)?.focus();
</script>
