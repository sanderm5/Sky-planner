---
import AuthLayout from '../../layouts/AuthLayout.astro';
import GlassCard from '../../components/ui/GlassCard.astro';

const url = Astro.url;
const token = url.searchParams.get('token');
---

<AuthLayout title="Tilbakestill passord">
  <GlassCard>
    {!token ? (
      <div class="text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center">
          <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-white mb-2">Ugyldig lenke</h1>
        <p class="text-dark-400 mb-6">Denne lenken er ugyldig eller har utløpt.</p>
        <a href="/auth/glemt-passord" class="btn-primary inline-block">
          Be om ny tilbakestillingslenke
        </a>
      </div>
    ) : (
      <>
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-white mb-2">Opprett nytt passord</h1>
          <p class="text-dark-400">Skriv inn ditt nye passord nedenfor.</p>
        </div>

        <form id="reset-form" class="space-y-6">
          <div id="error-message" class="form-error hidden" role="alert" aria-live="assertive"></div>
          <div id="success-message" class="form-success hidden" role="status" aria-live="polite"></div>

          <input type="hidden" id="token" value={token} />

          <div>
            <label for="passord" class="input-label">Nytt passord</label>
            <input
              id="passord"
              type="password"
              required
              minlength="8"
              autocomplete="new-password"
              class="input"
              placeholder="Minst 8 tegn"
            />
            <p class="text-xs text-dark-400 mt-1">Minst 8 tegn, inkludert stor bokstav, liten bokstav og tall</p>
          </div>

          <div>
            <label for="bekreft-passord" class="input-label">Bekreft passord</label>
            <input
              id="bekreft-passord"
              type="password"
              required
              minlength="8"
              autocomplete="new-password"
              class="input"
              placeholder="Gjenta passordet"
            />
          </div>

          <button type="submit" class="btn-primary w-full">
            <span id="btn-text">Oppdater passord</span>
            <span id="btn-loading" class="hidden">Oppdaterer...</span>
          </button>
        </form>

        <div class="mt-6 text-center">
          <a href="/auth/login" class="text-sm text-primary-400 hover:text-primary-300">
            Tilbake til innlogging
          </a>
        </div>
      </>
    )}
  </GlassCard>
</AuthLayout>

<style>
  .form-success {
    padding: 0.75rem 1rem;
    background-color: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 0.5rem;
    color: #10b981;
    font-size: 0.875rem;
  }
</style>

<script>
  const form = document.getElementById('reset-form') as HTMLFormElement;
  const errorDiv = document.getElementById('error-message');
  const successDiv = document.getElementById('success-message');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const tokenInput = document.getElementById('token') as HTMLInputElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const passord = (document.getElementById('passord') as HTMLInputElement).value;
    const bekreftPassord = (document.getElementById('bekreft-passord') as HTMLInputElement).value;
    const token = tokenInput?.value;

    // Client-side validation
    if (passord !== bekreftPassord) {
      if (errorDiv) {
        errorDiv.textContent = 'Passordene stemmer ikke overens';
        errorDiv.classList.remove('hidden');
      }
      return;
    }

    if (passord.length < 8) {
      if (errorDiv) {
        errorDiv.textContent = 'Passord må være minst 8 tegn';
        errorDiv.classList.remove('hidden');
      }
      return;
    }

    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorDiv?.classList.add('hidden');
    successDiv?.classList.add('hidden');

    try {
      const response = await fetch('/api/auth/tilbakestill-passord', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, passord }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Noe gikk galt');
      }

      // Show success and redirect
      if (successDiv) {
        successDiv.textContent = 'Passordet ditt er oppdatert! Du blir nå sendt til innloggingssiden...';
        successDiv.classList.remove('hidden');
      }
      form.classList.add('hidden');

      // Redirect to login after 2 seconds
      setTimeout(() => {
        window.location.href = '/auth/login?message=password_reset';
      }, 2000);
    } catch (err) {
      if (errorDiv) {
        errorDiv.textContent = err instanceof Error ? err.message : 'Noe gikk galt';
        errorDiv.classList.remove('hidden');
      }
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });
</script>
