---
import AuthLayout from '../../layouts/AuthLayout.astro';
import GlassCard from '../../components/ui/GlassCard.astro';
---

<AuthLayout title="Logg inn">
  <GlassCard>
    <div class="text-center mb-8">
      <h1 class="text-2xl font-bold text-white mb-2">Logg inn</h1>
      <p class="text-dark-400">Velkommen tilbake</p>
    </div>

    <form id="login-form" class="space-y-6">
      <div id="error-message" class="form-error hidden" role="alert" aria-live="assertive"></div>

      <div>
        <label for="epost" class="input-label">E-postadresse</label>
        <input
          id="epost"
          type="email"
          required
          autocomplete="email"
          class="input"
          placeholder="din@epost.no"
        />
      </div>

      <div>
        <label for="passord" class="input-label">Passord</label>
        <input
          id="passord"
          type="password"
          required
          autocomplete="current-password"
          class="input"
          placeholder="Ditt passord"
        />
      </div>

      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <input
            id="remember"
            type="checkbox"
            class="h-4 w-4 rounded border-dark-600 bg-dark-800 text-primary-600 focus:ring-primary-500"
          />
          <label for="remember" class="ml-2 text-sm text-dark-400">
            Husk meg
          </label>
        </div>

        <a href="/auth/glemt-passord" class="text-sm text-primary-400 hover:text-primary-300">
          Glemt passord?
        </a>
      </div>

      <button type="submit" class="btn-primary w-full">
        <span id="btn-text">Logg inn</span>
        <span id="btn-loading" class="hidden">Logger inn...</span>
      </button>
    </form>

    <div class="mt-6 text-center">
      <p class="text-dark-400">
        Har du ikke en konto?{' '}
        <a href="/auth/registrer" class="text-primary-400 hover:text-primary-300 font-medium">
          Opprett konto
        </a>
      </p>
    </div>
  </GlassCard>
</AuthLayout>

<script>
  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorDiv = document.getElementById('error-message');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');

  // Get redirect from URL query param
  const urlParams = new URLSearchParams(window.location.search);
  const redirectParam = urlParams.get('redirect');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const epost = (document.getElementById('epost') as HTMLInputElement).value;
    const passord = (document.getElementById('passord') as HTMLInputElement).value;

    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorDiv?.classList.add('hidden');

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ epost, passord, redirect: redirectParam }),
        credentials: 'include',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Innlogging feilet');
      }

      // 2FA required â€” redirect to verification page
      if (data.requires2FA && data.sessionToken) {
        window.location.href = `/auth/verify-2fa?session=${encodeURIComponent(data.sessionToken)}`;
        return;
      }

      if (data.redirectUrl) {
        window.location.href = data.redirectUrl;
      }
    } catch (err) {
      if (errorDiv) {
        errorDiv.textContent = err instanceof Error ? err.message : 'Noe gikk galt';
        errorDiv.classList.remove('hidden');
      }
    } finally {
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });
</script>
