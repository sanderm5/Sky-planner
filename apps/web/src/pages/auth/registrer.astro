---
import AuthLayout from '../../layouts/AuthLayout.astro';
import GlassCard from '../../components/ui/GlassCard.astro';
import Badge from '../../components/ui/Badge.astro';

const url = Astro.url;
const plan = url.searchParams.get('plan') || 'standard';
---

<AuthLayout title="Opprett konto">
  <GlassCard>
    <div class="text-center mb-8">
      <Badge class="mb-4">14 dagers gratis prøveperiode</Badge>
      <h1 class="text-2xl font-bold text-white mb-2">Opprett konto</h1>
      <p class="text-dark-400">Kom i gang med Sky Planner</p>
    </div>

    <form id="register-form" class="space-y-6">
      <div id="error-message" class="form-error hidden"></div>

      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2 sm:col-span-1">
          <label for="navn" class="input-label">Ditt navn *</label>
          <input
            id="navn"
            type="text"
            required
            autocomplete="name"
            class="input"
            placeholder="Ola Nordmann"
          />
        </div>
        <div class="col-span-2 sm:col-span-1">
          <label for="firma" class="input-label">Bedriftsnavn *</label>
          <input
            id="firma"
            type="text"
            required
            autocomplete="organization"
            class="input"
            placeholder="Bedrift AS"
          />
        </div>
      </div>

      <div>
        <label for="epost" class="input-label">E-postadresse *</label>
        <input
          id="epost"
          type="email"
          required
          autocomplete="email"
          class="input"
          placeholder="din@epost.no"
        />
      </div>

      <div>
        <label for="passord" class="input-label">Passord *</label>
        <input
          id="passord"
          type="password"
          required
          minlength="8"
          autocomplete="new-password"
          class="input"
          placeholder="Minst 8 tegn"
        />
        <p class="text-xs text-dark-500 mt-1">Minimum 8 tegn</p>
      </div>

      <div>
        <label class="input-label">Velg plan</label>
        <div class="grid grid-cols-2 gap-4">
          <label class="relative cursor-pointer">
            <input
              type="radio"
              name="plan"
              value="standard"
              class="peer sr-only"
              checked={plan === 'standard'}
            />
            <div class="p-4 rounded-xl border border-dark-600 peer-checked:border-primary-500 peer-checked:bg-primary-500/10 transition-all">
              <div class="font-semibold text-white">Standard</div>
              <div class="text-sm text-dark-400">499 kr/mnd</div>
            </div>
          </label>
          <label class="relative cursor-pointer">
            <input
              type="radio"
              name="plan"
              value="premium"
              class="peer sr-only"
              checked={plan === 'premium'}
            />
            <div class="p-4 rounded-xl border border-dark-600 peer-checked:border-primary-500 peer-checked:bg-primary-500/10 transition-all">
              <div class="font-semibold text-white">Premium</div>
              <div class="text-sm text-dark-400">999 kr/mnd</div>
            </div>
          </label>
        </div>
      </div>

      <div class="flex items-start">
        <input
          id="vilkar"
          type="checkbox"
          required
          class="h-4 w-4 mt-1 rounded border-dark-600 bg-dark-800 text-primary-600 focus:ring-primary-500"
        />
        <label for="vilkar" class="ml-2 text-sm text-dark-400">
          Jeg godtar{' '}
          <a href="/vilkar" class="text-primary-400 hover:text-primary-300" target="_blank">
            brukervilkårene
          </a>{' '}
          og{' '}
          <a href="/personvern" class="text-primary-400 hover:text-primary-300" target="_blank">
            personvernerklæringen
          </a>
        </label>
      </div>

      <button type="submit" class="btn-primary w-full">
        <span id="btn-text">Opprett konto</span>
        <span id="btn-loading" class="hidden">Oppretter konto...</span>
      </button>

      <p class="text-xs text-dark-500 text-center">
        Etter registrering blir du videresendt til Stripe for å legge inn betalingsinformasjon.
        Du belastes ikke før prøveperioden er over.
      </p>
    </form>

    <div class="mt-6 text-center">
      <p class="text-dark-400">
        Har du allerede en konto?{' '}
        <a href="/auth/login" class="text-primary-400 hover:text-primary-300 font-medium">
          Logg inn
        </a>
      </p>
    </div>
  </GlassCard>
</AuthLayout>

<script>
  const form = document.getElementById('register-form') as HTMLFormElement;
  const errorDiv = document.getElementById('error-message');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const navn = (document.getElementById('navn') as HTMLInputElement).value;
    const firma = (document.getElementById('firma') as HTMLInputElement).value;
    const epost = (document.getElementById('epost') as HTMLInputElement).value;
    const passord = (document.getElementById('passord') as HTMLInputElement).value;
    const plan = (document.querySelector('input[name="plan"]:checked') as HTMLInputElement)?.value || 'standard';

    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    errorDiv?.classList.add('hidden');

    try {
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ navn, firma, epost, passord, plan }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Registrering feilet');
      }

      if (data.checkoutUrl) {
        window.location.href = data.checkoutUrl;
      }
    } catch (err) {
      if (errorDiv) {
        errorDiv.textContent = err instanceof Error ? err.message : 'Noe gikk galt';
        errorDiv.classList.remove('hidden');
      }
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });
</script>
